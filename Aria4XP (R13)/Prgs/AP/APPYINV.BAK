***********************************************************************
*:   Program file: APPYINV.PRG
*:  Program desc.: Accounts Payable Invoice
*:         System: Aria 4XP
*:      Developer: Ahmad Shoukry Mohammed (ASM)
*:           Date: 7/6/2004
*:      Reference: *N37760,1
*:************************************************************************
*: Passed Parameters  : lcVenCode,lcInvNo,lnReceipts
*!*************************************************************
*! Modifications :
*! B128365,1 ASM 06/06/2005 Get Ship number for Selected Receiving Session in case of Materail purchase Order
*! B128399,1 KHM 06/15/2005 Fix the bug of wrong discount applied.
*! B999999,1 ASM Fix error that showed when trying to select item/color for shipment 4545
*! B129328,1 WSH 08/15/2005 Fix thge bug of voiding invoives with wrong dates.
*! B128863,1 ASM 08/24/2005 Fix the Bug of Saving Fox Tables even when SQL Gives errors and RollBack
*! B129901,1 ASM 09/26/2005 Prevent edit Payable invoice lines when falls in locked period
*! B039743,1 ASM 09/26/2005 Invoice screen gives error messege When Choosing Lines with lcLots
*! B130111,1 ASM 11/01/2005 Allow the User to Edit an Invoice whose posted date is locked, but make entries on system date
*! B129626,1 ASM 04/24/2005 AP Invoice Error message if line with zero exists
*! B130111,2 ASM 05/01/2006 Allow the User to Edit an Invoice whose posted date is locked, but Prevent accessing Invoice Lines and Total Amount
*! B608045,1 MMT 04/16/2007 fix bug or wrong record in grid after selecting GL account[T20070322.0029]
*! B608100,1 WAM 05/28/2007 fix bug or wrong browse ticket items when adding invoice lines
*! B608159,1 WAM 07/12/2007 Rebuild lots popup after collecting operation lots
*! B608412,1 WAM 01/20/2008 Include cost 6 & 7 while add invoice lines
*! B608409,1 SSH 01/16/2008 Incorect Taxes in distribution line screen
*! B608428,1 AKA 02/11/2008 Fix bug varbaoble "cInvNo" no found while editing Tax code in invoice detail screen
*! E302496,1 MHM 02/27/2008 Add line notes to ap dist
*! C200957,1 MHM 03/02/2008 T20070920.0001  Add register No. for All UK customers.
*! B608489,1 WAM 03/23/2008 Fix bug of PO closing entries doesn't show up [T20080214.0009]
*! B608492,1 SSH 03/23/2008 Error message when selecting TAX Code on invoice lines screen in Payable Invoice
*! B608528,1 MHM 04/21/2008 Invoice Lines-cannot amend the GL account for General Expense Item
*! B608531,1 WAM 04/23/2008 Get all style/color lines in the contribution screen [T20080417.0001]
*! B608574,1 AKA 05/28/2008 Refresh the correct GL account when change the tax code on AP invoice lines [T20080516.0001]
*! B608599,1 WAM 07/01/2008 Fix updating invoice lines in the generate lines automatically function [T20080624.0001]
*! B608642,1 WAM 08/04/2008 Fix Error while updating bug while saving invoice with contributed lines [T200800408.0001]
*! B608651,1 WAM 08/11/2008 Accumulate cost in BOMCOST when link invoice line to PO shipment
*! B608685,1 WAM 09/10/2008 Compute equivalent cost when checking balance of APDIST while saving the invoice
*! B608697,1 MMT 09/29/2008 fix bug while editing ex. rate[T20080924.0002]
*! B608730,1 WAM 10/23/2008 Fix cost calculation when assign PO to invoice by Auto option [T20081020.0012]
*! C201079,1 MMT 12/02/2008 Add disribution button to Ap invoice screen[T20080829.0003]
*! B608763,1 WAM 12/15/2008 Fix error message while saving if currency code in the header chanegd [T20081208.0006]
*! B608804,1 WAM 02/17/2009 Fix updating APDIST when AP ditribution lines amount modified [T20090203.0010]
*! B608833,1 HES 04/01/2009 Add Standared Fields for POMLINE File[T20081001.0001]
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[T20090526.0002]
*! E302623,2 MMT 10/12/2009 Convert Payable invoice screen to use SQL tables[T20090526.0002]
*! E302623,3 MMT 01/03/2010 Convert Payable invoice screen to use SQL tables[T20090526.0002]
*! E302678,1 MMT 03/24/2010 Convert Payable invoice screen to use SQL tables[T20090526.0002]

*! B609219,1 MMT 04/22/2010 error while Update in Payable invoice screen if Same PO Line rec. to diff. loc. in Same session[T20100330.0009]
*!* B609356,1 SMA 07/22/2010 Fix bug of creating empty *.cdx files [T20091027.0093]
*! B609565,1 WAM 04/10/2011 Read posting date when void invoice [T20110321.0014]
*! B609614,1 MMT 06/13/2011 Fix bug of wrong AP invoice Due date[T20110602.0031]
*! B609627,1 MMT 06/22/2011 Fix bug of Error while opening Payable invoice screen  if there is no Color segment in Style code structure[T20110609.0042]

*! E303001,1 TMI 11/30/2011 change the value stored in APINVHDR.CFISFYEAR, CFSPPRDID to be the post date instead of invoice date [T20110818.0027 ]
*! B609775,1 MMT 12/15/2011 Error while browsing factors in Payable invoice screen[T20111206.0022]
*! E303029,1 MMT 12/26/2011 correct the calling of non-major programs within the SaaS environemnt[T20100922.0014]

*! E302678,3 TMI 07/21/2011 Fix problems while enabling the program to run in A4xp [ApCnvPrj]
*! B609857,1 SAB 03/11/2012 Solve Media reported Problems[T20120304.0004]
*! B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004]
*! B609915,1 SAB 05/13/2012 APDIST file is not updated and approve button is disabled [T20120508.0019]
*! E303111,1 HIA 04/22/2012 Add Next month day related field, to trems code [T20120301.0038]
*! B609918,1 MMT 05/16/2012 Payable invoice screen updates APDIST incorrectly[T20120514.0036]
*! B609956,1 HIA 06/10/2012 Can not add detail lines, to invoice [T20120515.0013]
*! B610111,1 MMT 10/11/2012 Modify Payable invoice screen to handle MFG order case[T20121005.0001]
*! B610120,1 HIA 10/17/2012 T20121005.0001 - Aria4xp - AP - Error message applying invoice to Material Manufacturing order
*! B610184,1 HIA 12/30/2012 T20121212.0018 AP Journal Discripancy
*! B610199,1 HIA 01/16/2013 Aria4xp-SM - Release to GL screen freezes once release is complete [T20121213.0012]
*! B610205,1 HIA 01/20/2013 Aria4xp - AP - AP Invoice error message + incorrect ncurrunit update[T20130114.0001]
*! B610221,1 HIA 01/29/2013 Aria4xp - AP - AP Invoice-Amend Details tab updates incorrect period [T20121217.0011]
*! B610236,1 HIA 02/11/2013 Aria4xp - AP - Payable Invoice - Auto screen GPS LTD Waiting Scheduling [T20130130.0018]
*************************************************************************
PARAMETERS LCVENCODE,LCINVNO,LNRECEIPTS
*N000682,1 MMT 11/22/2012 Globalization changes[Start]
#INCLUDE R:\ARIA4XP\PRGS\AP\APPYINV.h
*N000682,1 MMT 11/22/2012 Globalization changes[End]
PRIVATE LCALLVAR
LCALLVAR = 'laACstType,laAddrs,laBankObjs,laCodes,laCostType,'+;
  'laICstType,laLCstType,laMCstType,laMfgCode,laMfgRFld,'+;
  'laPayMethd,laRemitTo,laSetups,laTCstType,laTaxAry,laTaxCode,laTermAry,'+;
  'lc1099Amnt,lcAPInvTkt,lcAPvInvDt,lcAccount,lcAcctDes,lcActCstDt,'+;
  'lcActCstHd,lcActProg,lcApdGLAct,lcApplied,lcApprAdj,lcApprDis,lcApprPay,'+;
  'lcAprStat,lcAutoInv,lcBFactCol,lcBankCode,lcBrowStr,lcBrowsTtl,lcCheckAcc,'+;
  'lcCodeFilt,lcColorDis,lcColorInv,lcCompany,lcCondition,lcContTtl,lcCostTtl,'+;
  'lcCutTktNo,lcData23St,lcDataDir,lcDefFact,lcDelMesag,lcDisAcct,'+;
  'lcDistAcct,lcDistPrd,'+;
  'lcDistStat,lcDistYer,lcDivision,lcDumCol,lcEmptyCode,lcExSin1,lcExSin2,'+;
  'lcExSin3,lcExSin4,lcFactCol,lcFactStat,lcFileInUse,lcFisPrd,lcFisYer,'+;
  'lcForCond,lcGLAcount,lcHidObjNrm,lcInvNo,lcLabel,lcMfgGlAcnt,'+;
  'lcOldBank,lcOldCheck,lcOldComp,lcOldCurr,lcOldFact,lcOldGLAcc,lcOldInvNo,'+;
  'lcOldPayMth,lcOldPeriod,lcOldPhone,lcOldPrior,lcOldTaxCod,lcOldTmplt,lcOldVal,'+;
  'lcOldVenCr,lcOldVenInv,lcOldVend,lcOldYear,lcOprTtl,lcPayMethd,lcPhone,lcPuDiv,'+;
  'lcPuTerm,lcRecTtl,lcRemitStat,lcRemitTo,lcScDnStat,lcScFields,lcScUpStat,'+;
  'lcSchm7Dis,lcSchm7Enb,lcSequence,lcStyCol,lcTAASTtl,lcTApAcct,lcTAplCost,'+;
  'lcTAprAmnt,lcTAprov,lcTCashAcct,lcTCashPy,lcTCashTtl,lcTChldTitl,lcTCrdtCor,'+;
  'lcTDelCor,lcTDisc,lcTFactor,lcTFully,lcTInvAmnU,lcTInvAmnt,lcTInvAmont,'+;
  'lcTInvDate,lcTInvoice,lcTOperat,lcTPart,lcTPayAcct,lcTPayTtl,lcTSave,lcTTitle,'+;
  'lcTVenInv,lcTVenKey,lcTVendCode,lcTVendor,lcTVoid,lcTaxCode,lcTaxDes,lcTempSave,'+;
  'lcTermCode,lcTermsDisp,lcTmpAplCst,lcTmpApr,lcTmpDist,lcTmpDist2,lcTmpTkt,'+;
  'lcTmplate,lcVenCode,lcVenInvTypes,lcVendor,lcWindTitl,ldOldDatInv,ldOldData,'+;
  'ldOldInvDat,llAddVen,llAutoScr,llBrowse,llCanSav,llClosed,llConFirm,llDebitM,'+;
  'llDoLocal,llDocNSupp,llFirstShow,llFirstTime,llFrmScrl,llFromVend,llGLActSta,'+;
  'llInquiry,llInvByCr,llInvCan,llLocate,llLokPer,llNewStat,llOpCmp,llOpFld,'+;
  'llPaidByCrd,llSamVendor,llSave,llShipment,llUpdInvLn,llWareHous,llZoomInvD,'+;
  'lnApQtyObj,lnApdAmnt,lnAprRate,lnAprUnit,lnBrRecNo,lnDisDays,'+;
  'lnDistAmnt,lnDueDays,lnEomDay,lnFAAp,lnFreight,'+;
  'lnInvAdj,lnInvDisc,lnInvRecNo,lnLineNo,lnMfgOpr,lnOld1099,lnOldAmnt,lnOldDisc,'+;
  'lnOldDiscOf,lnOldInvAmt,lnOldRate,lnOldRemit,lnOldValue,lnPartial,lnPercent,'+;
  'lnPrice,lnQtyObj,lnReceipts,lnRemitLen,lnStartAdr,lnTAprAmt,lnTInvAmt,'+;
  'lnTax,lnTaxCode,lnTotAppPay,llVoidDate,ldVoidDate,llEnterScr, loClickCtrl, '+;
  'FABRIC, FABDYE, POSHDR, POSLN, CUTTKTH, CUTTKTL, POFHDR, POFLN, MMFGORDH,'+;
  'MMFGORDD, BOMCOST, BOMLINE, CTKTBOM, MFGOPRDT, SHPMTHDR, lnFabMajLen, '+;
  'lnFabClrStart, lnFabClrLen, lnStyMajLen, lnStyClrStart, lnStyClrLen'

LCALLVAR = LCALLVAR +',llDataNotOpened,llEditButton,llDeleteButton,loconnstring' &&ASM
*! E302623,3 MMT 01/03/2010 Convert Payable invoice screen to use SQL tables[Start]
LCALLVAR = LCALLVAR +',lcAprCurr'
*! E302623,3 MMT 01/03/2010 Convert Payable invoice screen to use SQL tables[End]
*! B609614,1 MMT 06/13/2011 Fix bug of wrong AP invoice Due date[Start]
LCALLVAR = LCALLVAR +',lcEom'
*! B609614,1 MMT 06/13/2011 Fix bug of wrong AP invoice Due date[End]

DIMENSION LAALLVAR[1,1]
STORE '' TO LAALLVAR
=GFSUBSTR(LCALLVAR,@LAALLVAR,',')

LOCAL LNI
FOR LNI = 1 TO ALEN(LAALLVAR,1)
  IF LOWER(LEFT(LAALLVAR[lnI,1],2)) <> 'la'
    PRIVATE &LAALLVAR[lnI,1].
  ENDIF
ENDFOR


PRIVATE LABANKOBJS


*B601526,1 Add this line and varible [Begin]
LNFAAP = 0     && Varible to hold the old valeu of laData[51] &&Old
*B601526,1 Add this line and varible [End]

LLINQUIRY = IIF(TYPE('lcVenCode') $ 'UL',.F.,.T.)

LNRECEIPTS = IIF(TYPE('lnReceipts') $ 'UL',0,LNRECEIPTS)

EXTERNAL ARRAY LADATA,LAKEYFIELD,LASCRMODE,LADEFPROC,LAFIELD_H,LACTRSTAT &&Old

DECLARE LAKEYFIELD [2,4],LAPAYMETHD[1,2],LAFILESTRU[1], LABANKOBJS[3,3],;
  LAADDRORD[3,2],LAREMITTO[3,2],LACOSTTYPE[1],LATERMARY[3,2],LATAXARY[1,2],;
  LAADDRS[3] &&Old
*B604310,1 ALB Fix the due date according to the payment method [Begin]
DECLARE LATERMARY[4,2]
*B604310,1 ALB Fix the due date according to the payment method [end]

DECLARE LAWNDOBJ[8,3]    && Have screen name & first & last obj. for each screen. &&Old

*B607416,1 ALB Fix bug when Saving the debit memo againest Return PO [BEGIN]
STORE .F. TO LLDEBITM
*B607416,1 ALB Fix bug when Saving the debit memo againest Return PO [END]

*Old: laDefProc[7]    = .F.    && Use the custom delete procedure. &&Old
*Old: laDefProc[9]    = .F.    && Use the custom save procedure. &&Old

LCDUMCOL        = SCHEME(1,1) &&Old
LCLOCLSHOW      = "lfDelShow"  &&Old

LAKEYFIELD[1,1] = 'laData[1]' &&Old
LAKEYFIELD[1,2] = .F.
LAKEYFIELD[1,3] = 'VENDINV'
LAKEYFIELD[1,4] = 1

LAKEYFIELD[2,1] = 'laData[2]' &&Old
LAKEYFIELD[2,2] = .T.
LAKEYFIELD[2,3] = 'VENDINV'
LAKEYFIELD[2,4] = 2

*B603484,1 SSE 03/20/2000 Define Flag to detect whether we are inside
*B603484,1                Automatic invoice screen [Begin]
*llAutoScr = Flag to detect if we are in the Automatic invoice screen
LLAUTOSCR = .F.
*B603484,1 SSE 03/20/2000 [End]
*B605967,1 RAE [Start]
STORE .F. TO LLCLOSED &&Old
STORE '' TO LCCUTTKTNO
*B605967,1 RAE [End]
*B605746,1 RAE [Start]
STORE .F. TO LLSAVE
*B605746,1 RAE [End]
*B601419,1 This line and Varible was added by HS [Begin]
LCLABEL = 'Template :'         && Varible to hold the Template Field Label
*B601419,1 This line and Varible was added by HS [End]

LAPAYMETHD = ''
LCPHONE    = SPACE(16)   && Variable to hold the phone no.
LCCOMPANY  = SPACE(30)   && Variable to hold the company name.

STORE ' '       TO LCTMPDIST  , LCTEMPSAVE , ;
  LCTPAYACCT , LCTCASHACCT, LCTPAYTTL  , LCTCASHTTL ,;
  LCTINVAMNT , LCTINVDATE , LCTVENDOR  , LCTINVOICE ,;
  LCTAPACCT  , LCTAPROV   , LCTCASHPY  , LCTDISC    ,;
  LCTINVAMONT, LCTCRDTCOR , LCTDELCOR  , LCTVENDCODE,;
  LCDEFFACT  , LCCODEFILT , LCDIVISION , LCTERMCODE ,;
  LCPAYMETHD , LCDISTACCT , LCTAXDES   , LCREMITTO  ,;
  LCTAXCODE  , LCDATA23ST , LCTAPRAMNT , LCTSAVE    ,;
  LCTVOID    , LCTFULLY   , LCTPART    , LCTCHLDTITL,;
  LCTFACTOR  , LCTINVAMNU , LCBROWSTTL , LCOLDPAYMTH,;
  LCOLDBANK  , LCOLDCHECK , LCOLDVENCR , LCOLDVENINV,;
  LCOLDGLACC , LCOLDVEND  , LCOLDINVNO , LCOLDPHONE ,;
  LCOLDCOMP  , LCOLDPRIOR , LCOLDFACT  , LCOLDTMPLT ,;
  LCBROWSTR  , LCTTITLE   , LCVENDOR   , LCEMPTYCODE,;
  LCBANKCODE , LCCHECKACC , LCGLACOUNT , LCACCTDES  ,;
  LCAPPRPAY  , LCAPPRDIS  , LC1099AMNT , LCAPPRADJ  ,;
  LCFISYER   , LCFISPRD   , LCPUDIV    , PUDIVISION ,;
  LCPUTERM   , PUTERMDES  , PUTAX      , PUTAXDES   ,;
  LCOLDYEAR  , LCOLDPERIOD, LCSEQUENCE , LCDISACCT  ,;
  LCOLDTAXCOD, LCTMPAPLCST, LCTAPLCOST , LCCOSTTTL  ,;
  LCCONTTTL  , LCFILEDIR  , LCTAASTTL  , LCFILEINUSE,;
  LCCONDITION, LCFORCOND  , LCTVENINV  , LCTVENKEY  ,;
  LCOLDVAL   , LAADDRS    , LCTOPERAT  , LCOLDCURR  ,;
  LCEXSIN1   , LCEXSIN2   , LCEXSIN3   , LCEXSIN4

*! E302623,3 MMT 01/03/2010 Convert Payable invoice screen to use SQL tables[Start]
STORE '' TO LCAPRCURR
*! E302623,3 MMT 01/03/2010 Convert Payable invoice screen to use SQL tables[End]
*ASM

* B605040,1 Create temp file from AP dist [Start]
STORE ' ' TO LCTMPDIST2
* B605040,1 Create temp file from AP dist [End]


*E300798,1 Intialize New variables
STORE ''  TO LCAPVINVDT   && Invoice lines temp. file name
STORE ''  TO LCAPINVTKT   && Invoice Applied lines temp. file name
STORE ''  TO LCAUTOINV    && Crtae Invoice lines automatically temp. file name
STORE ''  TO LCTMPAPR     && Crtae Multiple Approve temp. file name
STORE ''  TO LCAPPLIED
STORE ''  TO LCTMPTKT     && Create Ticket details Temp. file
STORE .F. TO LLZOOMINVD   && Zoom Invoice Detail Browse
STORE ''  TO LCMFGGLACNT  && Operation GL Account
DECLARE LAOPNFILES[1]     && Array holds names of files opened
DECLARE LASETUPS[3,2]     && Array holds system setups
DECLARE LACODES[2,10],LAMFGCODE[1,2],LATAXCODE[1,2]
DECLARE LAICSTTYPE[1],LAMCSTTYPE[1],LALCSTTYPE[1],LATCSTTYPE[1],LAMFGRFLD[1,2]
STORE '' TO LASETUPS
LCVENINVTYPES = ''        && Vendor Invoice Types
STORE ''  TO LACODES,LAMFGCODE,LATAXCODE
STORE 1   TO LNMFGOPR,LNTAXCODE

*B602238,1 Check if the invoice lines called
STORE .F. TO LLUPDINVLN
STORE 0   TO  LNTINVAMT,LNTAPRAMT
*E300798,1 (END)


STORE 0         TO LNPRICE    , LNFREIGHT  , LNTAX      , LNQUOTA    ,;
  LNTOTRECASS, LNOLDVALUE , LNBRRECNO  , LNCOUNT    ,;
  LNINVRECNO , PUMETHOD   , LNPARTIAL  , LNOLDAMNT  ,;
  LNOLDDISC  , LNINVDISC  , LNTOTAPPPAY, LNOLD1099  ,;
  LNLINENO   , LNDUEDAYS  , LNDISDAYS  , LNREMITLEN ,;
  LNOLDINVAMT, LNOLDDISCOF, LNDISTAMNT , LNINVADJ   ,;
  LNAPDAMNT  , LNOLDINVAMT, LNOLDDISCOF, LNDISTAMNT ,;
  LNINVADJ   , LNAPDAMNT  , LNOLDRATE  , LNAPRRATE  ,;
  LNAPRUNIT

*B602946,1 Add this line to add some new variables [Begin]

*-- lcActCstHd  Variable to hold random name for the "Actual Cost" temp.
*--             header file
*-- lcActCstDt  Variable to hold random name for the "Actual Cost" temp.
*--             detail file
STORE '' TO LCACTCSTHD , LCACTCSTDT

*B602946,1 Add this line to add some new variables [End]

*B602830,1 Add this line to add some new variables [Begin]
*-- lnQtyObj      Variable to hold the object number of the Invoice Quantity
*--               Get Field to be used.
*-- lnApQtyObj    Variable to hold the object number of the Approve Quantity
*--               Get Field to be used.

STORE 0         TO LNQTYOBJ , LNAPQTYOBJ
*B602830,1 Add this line to add some new variables [End]

STORE .F.       TO LLCONFIRM  , LLWAREHOUS , LLSHIPMENT , ;
  LLINVCAN   , LLBROWSE   , LLNEWSTAT  ,;
  LLGLACTSTA , LLSAMVENDOR, LLPAIDBYCRD, LLCANSAV   ,;
  LLLOCATE   , LLINVBYCR  , LLFIRSTSHOW, LLFROMVEND ,;
  LLFRMSCRL

*B602830,1 Add this line to add some new variables [Begin]
*-- llDocNSupp    Flag to know if some of the document types that already
*--               exist in the Invoice are not supplied by the vendor
*--               anymore.

STORE .F.       TO LLDOCNSUPP
*B602830,1 Add this line to add some new variables [End]

STORE ''        TO LCDISTYER , LCDISTPRD
STORE {}        TO LDOLDDATINV, LDOLDDATA  , LDOLDINVDAT

STORE 'DISABLE' TO LCFACTSTAT , LCREMITSTAT, LCTERMSDISP,;
  LCAPRSTAT  , LCDISTSTAT , LCTMPLATE,LCSCUPSTAT,LCSCDNSTAT &&Old

STORE 1         TO PUREMITTO  , LNOLDREMIT ,LNSTARTADR

*lcActProg  = IIF(lnReceipts = 0,'APINVPY',IIF(lnReceipts = 1,'APMATPO',IIF(lnReceipts = 2,'APSTYPO','APCUTTK')))
LCACTPROG   = 'APPYINV'


LCCOLORDIS = SUBSTR(SCHEME(1,1),ATC('/',SCHEME(1,1))+1) &&Old
LCCOLORDIS = LCCOLORDIS+'/'+STRTRAN(LCCOLORDIS,'*','+') &&Old
LCCOLORINV = SCHEME(1,1) &&Old

LCSCHM7DIS = SCHEME(7,10) &&Old
LCSCHM7ENB = SCHEME(7,9) &&Old

LCDELMESAG = "void"
*Old: lcBFactCol = lcHidObjNrm  &&Revise
*Old: lcFactCol  = lcHidObjNrm  &&Revise

LCRECTTL   = 'Receipts'
LCOPRTTL   = 'Operations Cost'
*Old: lcAAsAcc   = lcEmptyAcc  &&Revise

LCSTYCOL   = ''  && Variable to be add to the relation to have the ware house.

LNTIME     = _DBLCLICK + SECONDS()  && Variable to hold time to consider duble click. &&Old
LNPERCENT  = 0.00  && Variable to hold the old value of the discount percent.

LLDOLOCAL  = .T.   && Global variable to force the program to use the;
  SHOW FUNCTION OF THE PROGRAM. &&Old

*B801499,1 Add these line to add a new variable [Begin]
**Flag to know if the Posting date falls within a locked period
LLLOKPER = .F.
*B801499,1 Add these line to add a new variable [End]

*B605485,1 SSH 11/Feb/2002 [Start] Add Variable for adding new vendor preveli.
LLADDVEN = .T.
*B605485,1 SSH [END]

*B606949,1 MAN Define the variable
STORE 0 TO LNEOMDAY
*! B609614,1 MMT 06/13/2011 Fix bug of wrong AP invoice Due date[Start]
STORE '' TO LCEOM
*! B609614,1 MMT 06/13/2011 Fix bug of wrong AP invoice Due date[End]
*ASM, This part was taken from the Setup Code of the old APPYINV.SCX [Start]
*N000682,1 MMT 12/03/2012 Globalization changes[Start]
*LCTAPRAMNT  = 'Total approved'
*LCTSAVE     = 'Saving'
*LCTVOID     = 'Void'
*LCTCHLDTITL = 'Distribution lines'
*LCTFULLY    = 'fully'
*LCTPART     = 'partialy'
*LCBROWSTTL  = 'View Distribution'
*LCTPAYACCT  = 'non-check payment G/L'
*LCTCASHACCT = 'cash payment'
*LCTPAYTTL   = 'Approved for payment'
*LCTCASHTTL  = 'Approved for cash payment'
*LCTINVAMNT  = 'amount cannot be zero'
*LCTINVDATE  = 'date cannot be empty'
*LCTVENDOR   = 'vendor'
*LCTINVOICE  = 'invoice number'
*LCTAPACCT   = 'A/P account'
*LCTAPROV    = 'Approved for payment'
*LCTCASHPY   = 'Approved for cash payment'
*LCTDISC     = 'Discount'
*LCTRECEIPT  = 'PO Receipts'
*LCTOPERAT   = 'Invoice Manufacturing Operations'
*LCTFACTOR   = 'factor code'
*LCTINVAMONT = 'invoice amount'
*LCTINVDATE  = 'Invoice'
*LCTCRDTCOR  = 'Cannot pay this invoice by '
*LCTDELCOR   = 'Voiding this invoice will delete its installment record'
*LCTVENDCODE = 'Vendor code '
*LCTINVAMNU  = 'Invoice amount'
*LCTAPLCOST  = IIF(LNRECEIPTS = 2,'Apply cost to style PO receipts','Apply cost to cutting tickets')
*LCCOSTTTL   = 'Cost items'
*LCCONTTTL   = 'Contribution'
*N000682,1 MMT 11/22/2012 globalization Changes [Start]
lcAPPHFILE = ''
IF oAriaApplication.oActivelang.cLang_ID <> "EN"
  lcAPPHFILE = oAriaApplication.GetClassHeaderFile(ADDBS(UPPER(ALLTRIM(oAriaApplication.LangPath))) + "PRGS\AP\" + ALLTRIM("APPYINV")+"_"+"H" +".XML")
ENDIF
LCTAPRAMNT  = IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_TOTAPPROVED,oAriaApplication.GetHeaderText("LANG_APPYINV_TOTAPPROVED",lcAPPHFILE))
LCTSAVE     = IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_SAVE,oAriaApplication.GetHeaderText("LANG_APPYINV_SAVE",lcAPPHFILE))
LCTVOID     = IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_VOID,oAriaApplication.GetHeaderText("LANG_APPYINV_VOID",lcAPPHFILE)) 
LCTCHLDTITL = IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_DISTLINES,oAriaApplication.GetHeaderText("LANG_APPYINV_DISTLINES",lcAPPHFILE))
LCTFULLY    = IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_FULL,oAriaApplication.GetHeaderText("LANG_APPYINV_FULL",lcAPPHFILE))
LCTPART     = IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_PART,oAriaApplication.GetHeaderText("LANG_APPYINV_PART",lcAPPHFILE))
LCBROWSTTL  = IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_VIEWDIST,oAriaApplication.GetHeaderText("LANG_APPYINV_VIEWDIST",lcAPPHFILE))
LCTPAYACCT  = IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_NONCHECK,oAriaApplication.GetHeaderText("LANG_APPYINV_NONCHECK",lcAPPHFILE))
LCTCASHACCT = IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_CASHPAY,oAriaApplication.GetHeaderText("LANG_APPYINV_CASHPAY",lcAPPHFILE))
LCTPAYTTL   = IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_APPROVEDFORPAY,oAriaApplication.GetHeaderText("LANG_APPYINV_APPROVEDFORPAY",lcAPPHFILE))
LCTCASHTTL  = IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_APPROVEDFORCASH,oAriaApplication.GetHeaderText("LANG_APPYINV_APPROVEDFORCASH",lcAPPHFILE))
LCTINVAMNT  = IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_AMOUNTISZERO,oAriaApplication.GetHeaderText("LANG_APPYINV_AMOUNTISZERO",lcAPPHFILE))
LCTINVDATE  = IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_DATECANNOTEMPTY,oAriaApplication.GetHeaderText("LANG_APPYINV_DATECANNOTEMPTY",lcAPPHFILE))
LCTVENDOR   = IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_SVENDOR,oAriaApplication.GetHeaderText("LANG_APPYINV_SVENDOR",lcAPPHFILE))
LCTINVOICE  = IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_INVOICENUMBER,oAriaApplication.GetHeaderText("LANG_APPYINV_INVOICENUMBER",lcAPPHFILE))
LCTAPACCT   = IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_APACCOUNT,oAriaApplication.GetHeaderText("LANG_APPYINV_APACCOUNT",lcAPPHFILE))
LCTAPROV    = IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_APPROVEDFORPAY,oAriaApplication.GetHeaderText("LANG_APPYINV_APPROVEDFORPAY",lcAPPHFILE))
LCTCASHPY   = IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_APPROVEDFORCASH,oAriaApplication.GetHeaderText("LANG_APPYINV_APPROVEDFORCASH",lcAPPHFILE))
LCTDISC     = IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_DISCOUNT,oAriaApplication.GetHeaderText("LANG_APPYINV_DISCOUNT",lcAPPHFILE))
LCTRECEIPT  = IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_POREC,oAriaApplication.GetHeaderText("LANG_APPYINV_POREC",lcAPPHFILE))
LCTOPERAT   = IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_INVOICEMANF,oAriaApplication.GetHeaderText("LANG_APPYINV_INVOICEMANF",lcAPPHFILE))
LCTFACTOR   = IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_FACTORCODE,oAriaApplication.GetHeaderText("LANG_APPYINV_FACTORCODE",lcAPPHFILE))
LCTINVAMONT = IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_S_INVOICEAMOUNT,oAriaApplication.GetHeaderText("LANG_APPYINV_S_INVOICEAMOUNT",lcAPPHFILE))
LCTINVDATE  = IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_INVOICE,oAriaApplication.GetHeaderText("LANG_APPYINV_INVOICE",lcAPPHFILE))
LCTCRDTCOR  = IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_CANNOTPAY,oAriaApplication.GetHeaderText("LANG_APPYINV_CANNOTPAY",lcAPPHFILE))+' '
LCTDELCOR   = IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_VOIDING,oAriaApplication.GetHeaderText("LANG_APPYINV_VOIDING",lcAPPHFILE))
LCTVENDCODE = IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_VENDORCODE,oAriaApplication.GetHeaderText("LANG_APPYINV_VENDORCODE",lcAPPHFILE))+' '
LCTINVAMNU  = IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_INVOICEAMOUNT,oAriaApplication.GetHeaderText("LANG_APPYINV_INVOICEAMOUNT",lcAPPHFILE))
LCTAPLCOST  = IIF(LNRECEIPTS = 2,IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_APPLYCOSTTOPO,oAriaApplication.GetHeaderText("LANG_APPYINV_APPLYCOSTTOPO",lcAPPHFILE)),;
IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_APPLYCOSTTOCUT,oAriaApplication.GetHeaderText("LANG_APPYINV_APPLYCOSTTOCUT",lcAPPHFILE)))
LCCOSTTTL   = IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_COST_ITEMS,oAriaApplication.GetHeaderText("LANG_APPYINV_COST_ITEMS",lcAPPHFILE))
LCCONTTTL   = IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_CONTRIBUTION,oAriaApplication.GetHeaderText("LANG_APPYINV_CONTRIBUTION",lcAPPHFILE))
*N000682,1 MMT 12/03/2012 Globalization changes[end]
*ASM, This part was taken from the Setup Code of the old APPYINV.SCX [End]



*! E303029,1 MMT 12/26/2011 correct the calling of non-major programs within the SaaS environemnt[STart]
*DO FORM (OARIAAPPLICATION.SCREENHOME+"\AP\APPYINV.SCX")
*DO FORM (oAriaApplication.ScreenHome+"\AP\APPYINV.SCX")
=GFCALLFORM('APPYINV','AP')
*! E303029,1 MMT 12/26/2011 correct the calling of non-major programs within the SaaS environemnt[END]

RETURN
*--end of APPYINV.PRG

*!*************************************************************
*! Name      : lfFormInit
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 7/7/2004
*! Purpose   : Function called from the INIT event of the form
*!*************************************************************
*! Parameters: The FormSet whose init code calls the function
*!*************************************************************
*! Returns   : False  ----> If fails to open the files
*!             True   ----> otheriwse
*!*************************************************************
FUNCTION LFFORMINIT
LPARAMETERS LOFORMSET


LOCAL LCDIR, LNFILESTRU, LNLOOP, LNCOUNT, LNELEMENTS, LCTEMP
LOCAL ARRAY LAFILESTRU[1]

LOFORMSET.LCCALLPROG='AP\APPYINV.FXP'

=LFADDPRO(LOFORMSET)


*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
=GFOPENTABLE('apinvhdr','duedate','SH')
=GFOPENTABLE('apvendor','vencode','SH')
=GFOPENTABLE('apdist','invvend','SH')
=GFOPENTABLE('apsetup','APSETUP','SH')
=GFOPENTABLE('apdiv','division','SH')
=GFOPENTABLE('codes','CCODE_NO','SH')
=GFOPENTABLE('apinvahd','htypcod','SH')
=GFOPENTABLE('apinvtkt','lncont','SH')
=GFOPENTABLE('apvinvdt','item','SH')
=GFOPENTABLE('Style','Style','SH')
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

*!*	lcDir=oAriaApplication.DataDir
*!*
*!*	IF ! (gfOpenFile(lcDir+'APINVHDR',lcDir+'DUEDATE','SH') AND ;
*!*	      gfOpenFile(lcDir+'APVENDOR',lcDir+'VENCODE','SH') AND ;
*!*	      gfOpenFile(lcDir+'APDIST',lcDir+'INVVEND','SH') AND ;
*!*	      gfOpenFile(lcDir+'APSETUP','','SH') AND ;
*!*	      gfOpenFile(lcDir+'APDIV',lcDir+'DIVISION','SH') AND ;
*!*	      gfOpenFile(lcDir+'APINVAHD',lcDir+'HTYPCOD','SH') AND ;
*!*	      gfOpenFile(lcDir+'APINVTKT',lcDir+'LNCONT','SH') AND ;
*!*	      gfOpenFile(lcDir+'APVINVDT',lcDir+'ITEM','SH') )
*!*	      MESSAGEBOX('Error Opening One of the Data Files')
*!*	      loFormSet.llDataNotOpened = .T.
*!*	  RETURN .F.
*!*	ENDIF


*gfOpenFile(lcDir+'CODES',lcDir+'IDRLTFNAME','SH') AND ;

*1Q: Do we need to get previllage in Aria4 ?
*Revise: loFormSet.llAddVen = lfGetprev()


LOFORMSET.LLINQUIRY = IIF(TYPE('loFormSet.lcVenCode') $ 'UL',.F.,.T.)
IF LOFORMSET.LLINQUIRY
  *Old: loFormSet.lcLoclShow     = 'lpShow'
  LOFORMSET.ACTIVEMODE="V"
  LOFORMSET.FORMHASTOOLBAR='0000000'
  STORE .F. TO LOFORMSET.LLEDITBUTTON, LOFORMSET.LLDELETEBUTTON &&ASM

  *Old: laCtrStat[12]  = 'ENABLE'           && Enable close buttom in the control panel
  *Revise: cmdClose exist ?
  *!B609857,1 SAB 03/11/2012 Solve Media reported Problems[Start]
  *oAriaApplication.oToolBar.cmdClose.ENABLED = .T.
  *!B609857,1 SAB 03/11/2012 Solve Media reported Problems[End]
  *Old: loFormSet.lcModal        = 'MODAL'
  LOFORMSET.WINDOWTYPE= 1
ELSE
  *Old: loFormSet.lcModal        = ''
  LOFORMSET.WINDOWTYPE= 0
  LOFORMSET.FORMHASTOOLBAR='1101111'
  STORE .T. TO LOFORMSET.LLEDITBUTTON, LOFORMSET.LLDELETEBUTTON &&ASM
  =CURSORSETPROP("Buffering" ,5,'APINVHDR')
ENDIF


SELECT APINVHDR

*Old: loformset.llopcmp = lfsysopen('syccomp','ccomp_id','sh')
*Old: loformset.lcdatadir = alltrim(iif(seek(gcprnt_cmp, 'syccomp'),gfgetdatadir(allt(syccomp.ccom_ddir)), oAriaApplication.DataDir))
*Old: IF loFormSet.llOpCmp
*Old: =gfCloseFile('SYCCOMP')
*Old: ENDIF

LOFORMSET.LCAPDGLACT = LOFORMSET.ARIAFORM1.AP1.LCEMPTYACC
LOFORMSET.LCAPDGLACT  = LOFORMSET.ARIAFORM1.AP1.LCEMPTYACC

LOFORMSET.LCDATADIR=LOFORMSET.ARIAFORM1.AP1.LCDATADIR

*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*=gfOpenFile(loFormSet.lcDataDir+'FISHD','Compfyear','SH')
=GFOPENTABLE(LOFORMSET.LCDATADIR+'FISHD','Compfyear','SH')
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

LOFORMSET.LLLOCATE    = .T.
*Old: loformset.llopfld = lfsysopen('sydfield','','sh')
*!*B610199,1 HIA 01/16/2013 Aria4xp-SM - Release to GL screen freezes once release is complete [T20121213.0012][Start]
*=OARIAAPPLICATION.REMOTESYSTEMDATA.EXECUTE("SELECT * FROM sydField","", "sydField","",OARIAAPPLICATION.SYSTEMCONNECTIONSTRING,3 ,"",SET("Datasession"))
=OARIAAPPLICATION.REMOTESYSTEMDATA.EXECUTE("SELECT * FROM sydField","", "AydField","",OARIAAPPLICATION.SYSTEMCONNECTIONSTRING,3 ,"",SET("Datasession"))
*!*B610199,1 HIA 01/16/2013 Aria4xp-SM - Release to GL screen freezes once release is complete [T20121213.0012][END]
*N000682,1 MMT 11/21/2012 globalization Changes [Start]
IF oAriaApplication.oActivelang.cLang_ID <> "EN" and USED("AydField") AND TYPE('loformset.A27FIELD') = 'C' AND USED(loformset.A27FIELD)
  SELECT AydField
  LOCATE
  SCAN
    IF SEEK(ALLTRIM(AydField.cfld_name) ,loformset.A27FIELD,loformset.A27FIELD)
      REPLACE CFLD_HEAD WITH ALLTRIM(EVALUATE(loformset.A27FIELD+'.langtext'))
    ENDIF 
  ENDSCAN 
  TABLEUPDATE(.t.,.t.)
Endif
*N000682,1 MMT 11/21/2012 globalization Changes [eND]
*loFormSet.lcTVenKey   =  ALLTRIM(LOOKUP(SYDFIELD.cFld_Head, 'CVENDCODE',;
SYDFIELD.cFld_Name,'CFLD_NAME'))
*loFormSet.lcTVenInv   = loFormSet.lcTVenKey + '\' + ;
ALLTRIM(LOOKUP(SYDFIELD.cFld_Head, 'CINVNO',;
SYDFIELD.cFld_NAme,'CFLD_NAME')) + ' : '

*!*B610199,1 HIA 01/16/2013 Aria4xp-SM - Release to GL screen freezes once release is complete [T20121213.0012][Start]
*LOFORMSET.LCTVENKEY = ALLTRIM(LOOKUP(SYDFIELD.CFLD_HEAD, 'CVENDCODE',SYDFIELD.CFLD_NAME))
*LOFORMSET.LCTVENINV = LOFORMSET.LCTVENKEY + '\' + ;
  ALLTRIM(LOOKUP(SYDFIELD.CFLD_HEAD, 'CINVNO',SYDFIELD.CFLD_NAME)) + ' : '
LOFORMSET.LCTVENKEY = ALLTRIM(LOOKUP(AYDFIELD.CFLD_HEAD, 'CVENDCODE',AYDFIELD.CFLD_NAME))
LOFORMSET.LCTVENINV = LOFORMSET.LCTVENKEY + '\' + ;
  ALLTRIM(LOOKUP(AYDFIELD.CFLD_HEAD, 'CINVNO',AYDFIELD.CFLD_NAME)) + ' : '
*!*B610199,1 HIA 01/16/2013 Aria4xp-SM - Release to GL screen freezes once release is complete [T20121213.0012][END]

LOFORMSET.LCEMPTYCODE = GFCODDES(' ' , ' ')

LOFORMSET.LCDIVISION  = LOFORMSET.LCEMPTYCODE
LOFORMSET.LCPUDIV     = LOFORMSET.LCEMPTYCODE
LOFORMSET.LCTERMCODE  = LOFORMSET.LCEMPTYCODE
LOFORMSET.LCPUTERM    = LOFORMSET.LCEMPTYCODE

*2Q: how will this affect the cboTermCode control ?
LOFORMSET.LATERMARY[1,1] = 'NTERDISCR'
*loFormSet.laTermAry[1,2] = 'apinvhdr.nterdiscr'

*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*loFormSet.laTermAry[1,2] = '_SCREEN.ACTIVEFORM.txtTerDiscr.Value'
LOFORMSET.LATERMARY[1,2] = '_SCREEN.ACTIVEFORM.pgfpayInv.pgHead.txtTerDiscr.Value'
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

LOFORMSET.LATERMARY[2,1] = 'NTERDUED'
*loFormSet.laTermAry[2,2] = 'apinvhdr.nterdued'

*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*loFormSet.laTermAry[2,2] = '_SCREEN.ACTIVEFORM.txtterdued.Value'
LOFORMSET.LATERMARY[2,2] = '_SCREEN.ACTIVEFORM.pgfpayInv.pgHead.txtterdued.Value'
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

LOFORMSET.LATERMARY[3,1] = 'NTERDISCD'
*loFormSet.laTermAry[3,2] = 'apinvhdr.nterdiscd'

*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*loFormSet.laTermAry[3,2] = '_SCREEN.ACTIVEFORM.txtTerDiscd.Value'
LOFORMSET.LATERMARY[3,2] = '_SCREEN.ACTIVEFORM.pgfpayInv.pgHead.txtTerDiscd.Value'
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

LOFORMSET.LNEOMDAY = 0
LOFORMSET.LATERMARY[4,1] = 'EOMDAY'
LOFORMSET.LATERMARY[4,2] = '_SCREEN.ACTIVEFORM.Parent.lnEomDay'

*! B609614,1 MMT 06/13/2011 Fix bug of wrong AP invoice Due date[Start]
LOFORMSET.LCEOM = ""
DIMENSION LOFORMSET.LATERMARY[5,2]
LOFORMSET.LATERMARY[5,1] = 'EOM'
LOFORMSET.LATERMARY[5,2] = '_SCREEN.ACTIVEFORM.Parent.lcEom'
*! B609614,1 MMT 06/13/2011 Fix bug of wrong AP invoice Due date[End]

*3Q: how will this affect the cboTaxCode control ?
LOFORMSET.LATAXARY[1,1]  = 'CGLINPACCT'

*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*loFormSet.laTaxAry[1,2]  = '_SCREEN.ACTIVEFORM.glActCode.KeyTextBox.Value'
LOFORMSET.LATAXARY[1,2]  = '_SCREEN.ACTIVEFORM.pgfpayInv.pgdist.glActCode.KeyTextBox.Value'
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]


*4Q: how will this affect the kbBnkCode control and the Check Account control ?
LOFORMSET.LABANKOBJS  = ' '
LOFORMSET.LABANKOBJS[1,1] = 'ibBank'         && Bank code invisible button
LOFORMSET.LABANKOBJS[1,2] = 'apinvhdr.cbnkcode'     && Bank code
LOFORMSET.LABANKOBJS[2,1] = 'ibChecks'       && Checking account invisible button
LOFORMSET.LABANKOBJS[2,2] = 'apinvhdr.cchkacct'     && Checking account
LOFORMSET.LABANKOBJS[3,1] = 'ibGlAcc'        && G/L account invisible button
LOFORMSET.LABANKOBJS[3,2] = 'apinvhdr.cchkglacc'     && G/L account


LOCATE  && To Refresh the relation
*N000682,1 MMT 11/22/2012 Globalization changes[Start]
*LOFORMSET.LCWINDTITL='Payable Invoice' &&ASM
*N000682,1 11/20/2012 MMT Globlization changes[Start]
*LOFORMSET.LCWINDTITL=LANG_APPYINV_PAYABLEINVOICE &&ASM
LOFORMSET.LCWINDTITL=IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_PAYABLEINVOICE,loFormSet.GetHeaderText("LANG_APPYINV_PAYABLEINVOICE",loFormSet.HeaderAlias)) &&ASM
*N000682,1 11/20/2012 MMT Globlization changes[End]

*N000682,1 MMT 11/22/2012 Globalization changes[END]
IF LOFORMSET.LLINQUIRY
  LOFORMSET.LCTTITLE = LOFORMSET.LCWINDTITL
ELSE
  IF EMPTY(LOFORMSET.LCSEQUENCE)

    LOFORMSET.LCSEQUENCE = GFSEQUENCE('CAPSESSNO')

  ENDIF
  *loFormSet.lcTTitle = PADR(SPACE((75-LEN(loFormSet.lcWindTitl))/2)+loFormSet.lcWindTitl+SPACE((74-LEN(loFormSet.lcWindTitl))/2-20)+'Session : '+ALLTRIM(loFormSet.lcSequence),76)
  *N000682,1 MMT 12/09/2012 Globalization changes[Start]
  *LOFORMSET.LCTTITLE = LOFORMSET.LCWINDTITL+SPACE(5)+'Session : '+ALLTRIM(LOFORMSET.LCSEQUENCE)
  LOFORMSET.LCTTITLE = LOFORMSET.LCWINDTITL+SPACE(5)+IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_S_RECEIVINGSESSIONNUMBER,loFormSet.GetHeaderText("LANG_S_RECEIVINGSESSIONNUMBER",loFormSet.HeaderAlias))+ALLTRIM(LOFORMSET.LCSEQUENCE)
  *N000682,1 MMT 12/09/2012 Globalization changes[End]
ENDIF

LOFORMSET.ARIAFORM1.CAPTION=LOFORMSET.LCTTITLE &&ASM, Form's Caption Must be Updated

LOFORMSET.LLFIRSTTIME = .T.
*Old: SCATTER FIELDS &loFormSet.lcScFields MEMO TO laData BLANK

*5Q: how will this affect the cboInvRemit Control ?

*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*!*	DIMENSION laAry[ALEN(loFormSet.laRemitTo,1),2]
*!*	=ACOPY(loFormSet.laRemitTo,laAry)
*!*	loFormSet.lnRemitLen   = gfGetVld('cInvRemit',@laAry)
*!*	DIMENSION loFormSet.laRemitTo[ALEN(laAry,1),2]
*!*	=ACOPY(laAry,loFormSet.laRemitTo)
DIMENSION LAARRAY[ALEN(loFormSet.laRemitTo,1),2]
=ACOPY(LOFORMSET.LAREMITTO,LAARRAY)
LOFORMSET.LNREMITLEN   = GFGETVLD('cInvRemit',@LAARRAY)
DIMENSION LOFORMSET.LAREMITTO[ALEN(laArray,1),2]
=ACOPY(LAARRAY,LOFORMSET.LAREMITTO)
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

LOFORMSET.LCREMITTO    = LOFORMSET.LAREMITTO[1,1]
*6Q: how will this affect the cboVendPmeth Control ?

*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*!*	DIMENSION laAry[ALEN(loFormSet.laPayMethd,1),2]
*!*	=ACOPY(loFormSet.laPayMethd,laAry)
*!*	=gfGetVld('CVENPMETH',@laAry)
*!*	DIMENSION loFormSet.laPayMethd[ALEN(laAry,1),2]
*!*	=ACOPY(laAry,loFormSet.laPayMethd)
DIMENSION LAARRAY[ALEN(loFormSet.laPayMethd,1),2]
=ACOPY(LOFORMSET.LAPAYMETHD,LAARRAY)
=GFGETVLD('CVENPMETH',@LAARRAY)
DIMENSION LOFORMSET.LAPAYMETHD[ALEN(laArray,1),2]
=ACOPY(LAARRAY,LOFORMSET.LAPAYMETHD)
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

*!*	s=''
*!*	FOR c=1 TO ALEN(loFormSet.laPayMethd,1)
*!*	  s=s+loFormSet.laPayMethd[c,1]+' --> '+loFormSet.laPayMethd[c,2]+CHR(13)
*!*	NEXT
*!*	MESSAGEBOX(s)

*Old: IF loFormSet.llOpFld
*Old: =gfCloseFile('SYDFIELD')
*Old: ENDIF

LOFORMSET.LCTMPDIST   = GFTEMPNAME()   && Random name for the Distribution Temp. file.
LOFORMSET.LCTEMPSAVE  = GFTEMPNAME()   && Random name for the Temp. Cursor to use in save.
*Old: loFormSet.lcDisChld1  = gfTempName()   && Random name for the Dist. child screen no 1.
*Old: loFormSet.lcDisChld2  = gfTempName()   && Random name for the Dist. child screen no 2.
*Old: loFormSet.lcDisChld3  = gfTempName()   && Random name for the Dist. child screen no 3.
*Old: loFormSet.lcDisChld4  = gfTempName()   && Random name for the Dist. child screen no 4.
*Old: loFormSet.lcDisChld5  = gfTempName()   && Random name for the Dist. child screen no 5.
*Old: loFormSet.lcDisChld6  = gfTempName()   && Random name for the Dist. child screen no 6.

LOFORMSET.LCTMPDIST2   = GFTEMPNAME()   && Random name for the Distribution Temp. file.


SELECT APDIST
=AFIELDS(LAFILESTRU)

*create table &oAriaApplication.WorkDir.&loformset.lctempsave from array laFileStru
=GFCRTTMP(LOFORMSET.LCTEMPSAVE,@LAFILESTRU)

LNFILESTRU = ALEN(LAFILESTRU,1)
DIMENSION LAFILESTRU[lnFileStru+5,18]

LAFILESTRU[lnFileStru+1,1] = 'CDISCRIP'
LAFILESTRU[lnFileStru+1,2] = 'C'
LAFILESTRU[lnFileStru+1,3] = 60
LAFILESTRU[lnFileStru+1,4] = 0

LAFILESTRU[lnFileStru+2,1] = 'CSTATUS'
LAFILESTRU[lnFileStru+2,2] = 'C'
LAFILESTRU[lnFileStru+2,3] = 1
LAFILESTRU[lnFileStru+2,4] = 0

LAFILESTRU[lnFileStru+3,1] = 'CUPDSERNO'
LAFILESTRU[lnFileStru+3,2] = 'C'
LAFILESTRU[lnFileStru+3,3] = 1
LAFILESTRU[lnFileStru+3,4] = 0

LAFILESTRU[lnFileStru+4,1] = 'NRECNO'
LAFILESTRU[lnFileStru+4,2] = 'N'
LAFILESTRU[lnFileStru+4,3] = 10
LAFILESTRU[lnFileStru+4,4] = 0

LAFILESTRU[lnFileStru+5,1] = 'CTAXDES'
LAFILESTRU[lnFileStru+5,2] = 'C'
LAFILESTRU[lnFileStru+5,3] = 8
LAFILESTRU[lnFileStru+5,4] = 0

FOR LNLOOP = 1  TO 5
  STORE '' TO LAFILESTRU[lnFileStru+lnLoop ,7],LAFILESTRU[lnFileStru+lnLoop  ,8],;
    LAFILESTRU[lnFileStru+lnLoop ,9],LAFILESTRU[lnFileStru+lnLoop  ,10],;
    LAFILESTRU[lnFileStru+lnLoop ,11],LAFILESTRU[lnFileStru+lnLoop ,12],;
    LAFILESTRU[lnFileStru+lnLoop ,13],LAFILESTRU[lnFileStru+lnLoop ,14],;
    LAFILESTRU[lnFileStru+lnLoop ,15],LAFILESTRU[lnFileStru+lnLoop ,16]

  STORE 0 TO  LAFILESTRU[lnFileStru+lnLoop ,17],LAFILESTRU[lnFileStru+lnLoop ,18]
ENDFOR

*create table &oAriaApplication.WorkDir.&loformset.lctmpdist from array laFileStru
*INDEX ON cVendCode+cInvNo+STR(nApDLinNo,4) TAG (loFormSet.lcTmpDist)
=GFCRTTMP(LOFORMSET.LCTMPDIST,@LAFILESTRU,;
  'cVendCode+cInvNo+STR(nApDLinNo,4)',LOFORMSET.LCTMPDIST)


LOFORMSET.LAMFGRFLD[1,1] = 'GLACCOUNT'

*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*loFormSet.laMfgRFld[1,2] = '_Screen.ActiveForm.Parent.CallingForm.Parent.lcMfgGlAcnt'
LOFORMSET.LAMFGRFLD[1,2] = '_Screen.ActiveForm.Parent.lcMfgGlAcnt'
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

IF 'PO' $ UPPER(OARIAAPPLICATION.COMPANYINSTALLEDMODULES)
  *B608412,1 WAM 01/20/2008 Include cost 6 & 7 while add invoice lines
  *!*	  STORE '' TO M_CISLBL1,M_CISLBL2,M_CISLBL3,M_CISLBL4,M_CISLBL5,;
  *!*	              M_CITYPE1,M_CITYPE2,M_CITYPE3,M_CITYPE4,M_CITYPE5
  *!*	  =gfGetMemVar('M_CISLBL1,M_CISLBL2,M_CISLBL3,M_CISLBL4,M_CISLBL5,M_CITYPE1,M_CITYPE2,M_CITYPE3,M_CITYPE4,M_CITYPE5',oAriaApplication.ActiveCompanyID)
  *!*	  lnElements = 0
  *!*	  FOR lnCount = 1 TO 5

  STORE '' TO M_CISLBL1,M_CISLBL2,M_CISLBL3,M_CISLBL4,M_CISLBL5,M_CISLBL6,M_CISLBL7,;
    M_CITYPE1,M_CITYPE2,M_CITYPE3,M_CITYPE4,M_CITYPE5,M_CITYPE6,M_CITYPE7
  =GFGETMEMVAR('M_CISLBL1,M_CISLBL2,M_CISLBL3,M_CISLBL4,M_CISLBL5,M_CISLBL6,M_CISLBL7,M_CITYPE1,M_CITYPE2,M_CITYPE3,M_CITYPE4,M_CITYPE5,M_CITYPE6,M_CITYPE7',OARIAAPPLICATION.ACTIVECOMPANYID)
  LNELEMENTS = 0
  FOR LNCOUNT = 1 TO 7
    *B608412,1 WAM 01/20/2008 (End)

    IF !INLIST(EVAL('M_CITYPE'+STR(LNCOUNT,1)),'F','S','T')
      LNELEMENTS = LNELEMENTS + 1
      DIMENSION LOFORMSET.LAICSTTYPE[lnElements,3]
      LOFORMSET.LAICSTTYPE[lnElements,1] = EVAL('M_CISLBL'+STR(LNCOUNT,1))
      LOFORMSET.LAICSTTYPE[lnElements,2] = STR(LNCOUNT,1)
      LOFORMSET.LAICSTTYPE[lnElements,3] = EVAL('M_CITYPE'+STR(LNCOUNT,1))
    ENDIF
  ENDFOR
ENDIF
IF 'MF' $ UPPER(OARIAAPPLICATION.COMPANYINSTALLEDMODULES)
  DIMENSION LOFORMSET.LAACSTTYPE[1,3]
  LOFORMSET.LAACSTTYPE[1,1] = 'Adorment Cost'
  LOFORMSET.LAACSTTYPE[1,2] = '2'
  LOFORMSET.LAACSTTYPE[1,3] = 'A'
  *B608412,1 WAM 01/20/2008 Include cost 6 & 7 while add invoice lines
  *!*	  STORE '' TO M_CMSLBL1,M_CMSLBL2,M_CMSLBL3,M_CMSLBL4,M_CMSLBL5,;
  *!*	              M_CMTYPE1,M_CMTYPE2,M_CMTYPE3,M_CMTYPE4,M_CMTYPE5
  *!*	  =gfGetMemVar('M_CMSLBL1,M_CMSLBL2,M_CMSLBL3,M_CMSLBL4,M_CMSLBL5,M_CMTYPE1,M_CMTYPE2,M_CMTYPE3,M_CMTYPE4,M_CMTYPE5',oAriaApplication.ActiveCompanyID)
  *!*	  lnElements = 0
  *!*	  FOR lnCount = 1 TO 5

  STORE '' TO M_CMSLBL1,M_CMSLBL2,M_CMSLBL3,M_CMSLBL4,M_CMSLBL5,M_CMSLBL6,M_CMSLBL7,;
    M_CMTYPE1,M_CMTYPE2,M_CMTYPE3,M_CMTYPE4,M_CMTYPE5,M_CMTYPE6,M_CMTYPE7
  =GFGETMEMVAR('M_CMSLBL1,M_CMSLBL2,M_CMSLBL3,M_CMSLBL4,M_CMSLBL5,M_CMSLBL6,M_CMSLBL7,M_CMTYPE1,M_CMTYPE2,M_CMTYPE3,M_CMTYPE4,M_CMTYPE5,M_CMTYPE6,M_CMTYPE7',OARIAAPPLICATION.ACTIVECOMPANYID)
  LNELEMENTS = 0
  FOR LNCOUNT = 1 TO 7
    *B608412,1 WAM 01/20/2008 (End)

    IF !INLIST(EVAL('M_CMTYPE'+STR(LNCOUNT,1)),'F','S','T')
      LNELEMENTS = LNELEMENTS + 1
      DIMENSION LOFORMSET.LAMCSTTYPE[lnElements,3]
      LOFORMSET.LAMCSTTYPE[lnElements,1] = EVAL('M_CMSLBL'+STR(LNCOUNT,1))
      LOFORMSET.LAMCSTTYPE[lnElements,2] = STR(LNCOUNT,1)
      LOFORMSET.LAMCSTTYPE[lnElements,3] = EVAL('M_CMTYPE'+STR(LNCOUNT,1))
    ENDIF
  ENDFOR
ENDIF
IF 'MA' $ UPPER(OARIAAPPLICATION.COMPANYINSTALLEDMODULES)
  DIMENSION LOFORMSET.LALCSTTYPE[4,3]
  *N000682,1 MMT 11/22/2012 Globalization changes[Start]
  *LOFORMSET.LALCSTTYPE[1,1] = 'Purchase Price'
  *N000682,1 11/20/2012 MMT Globlization changes[Start]
*LOFORMSET.LALCSTTYPE[1,1] = LANG_APPYINV_PPRICE
LOFORMSET.LALCSTTYPE[1,1] = IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_PPRICE,loFormSet.GetHeaderText("LANG_APPYINV_PPRICE",loFormSet.HeaderAlias))
*N000682,1 11/20/2012 MMT Globlization changes[End]

  *N000682,1 MMT 11/22/2012 Globalization changes[END]
  LOFORMSET.LALCSTTYPE[1,2] = '1'
  LOFORMSET.LALCSTTYPE[1,3] = 'P'
  *N000682,1 MMT 11/22/2012 Globalization changes[Start]
  *LOFORMSET.LALCSTTYPE[2,1] = 'Freight'
  *N000682,1 11/20/2012 MMT Globlization changes[Start]
*LOFORMSET.LALCSTTYPE[2,1] = LANG_APPYINV_FREIGHT
LOFORMSET.LALCSTTYPE[2,1] = IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_FREIGHT,loFormSet.GetHeaderText("LANG_APPYINV_FREIGHT",loFormSet.HeaderAlias))
*N000682,1 11/20/2012 MMT Globlization changes[End]

  *N000682,1 MMT 11/22/2012 Globalization changes[END]
  LOFORMSET.LALCSTTYPE[2,2] = '2'
  LOFORMSET.LALCSTTYPE[2,3] = 'D'
  *N000682,1 MMT 11/22/2012 Globalization changes[Start]
  *LOFORMSET.LALCSTTYPE[3,1] = 'Tax'
  *N000682,1 11/20/2012 MMT Globlization changes[Start]
*LOFORMSET.LALCSTTYPE[3,1] = LANG_APPYINV_TAX
LOFORMSET.LALCSTTYPE[3,1] = IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_TAX,loFormSet.GetHeaderText("LANG_APPYINV_TAX",loFormSet.HeaderAlias))
*N000682,1 11/20/2012 MMT Globlization changes[End]

  *N000682,1 MMT 11/22/2012 Globalization changes[END]
  LOFORMSET.LALCSTTYPE[3,2] = '3'
  LOFORMSET.LALCSTTYPE[3,3] = 'D'
  *N000682,1 MMT 11/22/2012 Globalization changes[Start]
  *LOFORMSET.LALCSTTYPE[4,1] = 'Quota'
  *N000682,1 11/20/2012 MMT Globlization changes[Start]
*LOFORMSET.LALCSTTYPE[4,1] = LANG_APPYINV_QUOTA
LOFORMSET.LALCSTTYPE[4,1] = IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_QUOTA,loFormSet.GetHeaderText("LANG_APPYINV_QUOTA",loFormSet.HeaderAlias))
*N000682,1 11/20/2012 MMT Globlization changes[End]

  *N000682,1 MMT 11/22/2012 Globalization changes[END]
  LOFORMSET.LALCSTTYPE[4,2] = '4'
  LOFORMSET.LALCSTTYPE[4,3] = 'D'
  STORE '' TO M_CTSLBL1,M_CTSLBL2,M_CTSLBL3,M_CTSLBL4,;
    M_CTTYPE1,M_CTTYPE2,M_CTTYPE3,M_CTTYPE4


  =GFGETMEMVAR('M_CTSLBL1,M_CTSLBL2,M_CTSLBL3,M_CTSLBL4,;
                M_CTTYPE1,M_CTTYPE2,M_CTTYPE3,M_CTTYPE4',OARIAAPPLICATION.ACTIVECOMPANYID)
  LNELEMENTS = 0
  FOR LNCOUNT = 1 TO 4

    IF !INLIST(EVAL('M_CTTYPE'+STR(LNCOUNT,1)),'F','S','T','A','D') AND !EMPTY(EVAL('M_CTTYPE'+STR(LNCOUNT,1)))
      LNELEMENTS = LNELEMENTS + 1
      DIMENSION LOFORMSET.LATCSTTYPE[lnElements,3]
      LOFORMSET.LATCSTTYPE[lnElements,1] = EVAL('M_CTSLBL'+STR(LNCOUNT,1))
      LOFORMSET.LATCSTTYPE[lnElements,2] = STR(LNCOUNT,1)
      LOFORMSET.LATCSTTYPE[lnElements,3] = EVAL('M_CTTYPE'+STR(LNCOUNT,1))
    ENDIF
  ENDFOR
ENDIF

LOFORMSET.LASETUPS[1,1] = 'M_DYELOT'
LOFORMSET.LASETUPS[2,1] = 'M_MATDYE'
LOFORMSET.LASETUPS[3,1] = 'M_LINK_GL'
STORE '' TO M_DYELOT,M_MATDYE,M_LINK_GL
=GFGETMEMVAR('M_DYELOT,M_MATDYE,M_LINK_GL',OARIAAPPLICATION.ACTIVECOMPANYID)
LOFORMSET.LASETUPS[1,2] = M_DYELOT
LOFORMSET.LASETUPS[2,2] = M_MATDYE
LOFORMSET.LASETUPS[3,2] = M_LINK_GL

*Revise: This must update the Form's Controls [Start]

LOFORMSET.LACODES[1,1] = "MFGCODE"

*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*!*	loFormSet.laCodes[1,2] = "_Screen.ActiveForm.Parent.CallingForm.Parent.laMfgCode"
*!*	loFormSet.laCodes[1,3] = "_Screen.ActiveForm.Parent.CallingForm.Parent.lnMfgOpr"
LOFORMSET.LACODES[1,2] = "_Screen.ActiveForm.Parent.laMfgCode"
LOFORMSET.LACODES[1,3] = "_Screen.ActiveForm.Parent.lnMfgOpr"
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

LOFORMSET.LACODES[1,4] = ""
LOFORMSET.LACODES[1,5] = .F.
LOFORMSET.LACODES[1,6] = .F.
LOFORMSET.LACODES[1,9] = [cVendCode+cApInvNo+cAPVILNo]
LOFORMSET.LACODES[1,10] = "COPRCODE"

LOFORMSET.LACODES[2,1] = "CTAXCODE"

*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*!*	loFormSet.laCodes[2,2] = "_Screen.ActiveForm.Parent.CallingForm.Parent.laTaxCode"
*!*	loFormSet.laCodes[2,3] = "_Screen.ActiveForm.Parent.CallingForm.Parent.lnTaxCode"
LOFORMSET.LACODES[2,2] = "_Screen.ActiveForm.Parent.laTaxCode"
LOFORMSET.LACODES[2,3] = "_Screen.ActiveForm.Parent.lnTaxCode"
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

LOFORMSET.LACODES[2,4] = ""
LOFORMSET.LACODES[2,5] = .F.
LOFORMSET.LACODES[2,6] = .T.
LOFORMSET.LACODES[2,9] = [cVendCode+cApInvNo+cAPVILNo]
LOFORMSET.LACODES[2,10] = "CTAXCODE"

*Revise: This must update the Form's Controls [End]

LOFORMSET.LCAPVINVDT = GFTEMPNAME()   && Random name for Invoice lines temp. file
LOFORMSET.LCAPINVTKT = GFTEMPNAME()   && Random name for Invoice Applied lines temp. file
LOFORMSET.LCAUTOINV  = GFTEMPNAME()   && Random name for Invoice lines automatically temp. file name
LOFORMSET.LCTMPAPR   = GFTEMPNAME()   && Random name for multiple approve temp file.
LOFORMSET.LCAPPLIED  = GFTEMPNAME()
LOFORMSET.LCTMPTKT   = GFTEMPNAME()   && Random name for Ticket details file

LOFORMSET.LCACTCSTHD = GFTEMPNAME()   && Random name for the "Actual Cost" temp. header file
LOFORMSET.LCACTCSTDT = GFTEMPNAME()   && Random name for the "Actual Cost" temp. detail file


*create table (oAriaApplication.WorkDir+loformset.lcautoinv) ;
*(cSelect C(1), Item C(19),Color C(6),cWareCode C(6), cDyelot C(10),LineNo N(6),;
*cTktNo C(6),nTktQty1 N(6),nTktQty2 N(6),nTktQty3 N(6),nTktQty4 N(6),nTktQty5 N(6),;
*nTktQty6 N(6),nTktQty7 N(6),nTktQty8 N(6), nTktQty N(11,3),nTktCst N(13,3),;
*nTktAmnt N(14,2), nAplQty1 N(6),nAplQty2 N(6),nAplQty3 N(6),nAplQty4 N(6),;
*nAplQty5 N(6),nAplQty6 N(6),nAplQty7 N(6),nAplQty8 N(6),nAplQty N(11,3), nAplAmnt N(14,2),;
*nInvQty1 N(6),nInvQty2 N(6),nInvQty3 N(6),nInvQty4 N(6), nInvQty5 N(6),;
*nInvQty6 N(6),nInvQty7 N(6),nInvQty8 N(6), nInvQty N(11,3), nInvAmnt N(14,2),cRecvType C(1),cWIPAcct C(24) )
LFCRTTMP(LOFORMSET.LCAUTOINV, ;
  "cSelect C(1), Item C(19),Color C(6),cWareCode C(6), cDyelot C(10),LineNo N(6),"+;
  "cTktNo C(6),nTktQty1 N(6),nTktQty2 N(6),nTktQty3 N(6),nTktQty4 N(6),nTktQty5 N(6),"+;
  "nTktQty6 N(6),nTktQty7 N(6),nTktQty8 N(6), nTktQty N(11,3),nTktCst N(13,3),"+;
  "nTktAmnt N(14,2), nAplQty1 N(6),nAplQty2 N(6),nAplQty3 N(6),nAplQty4 N(6),"+;
  "nAplQty5 N(6),nAplQty6 N(6),nAplQty7 N(6),nAplQty8 N(6),nAplQty N(11,3), nAplAmnt N(14,2),"+;
  "nInvQty1 N(6),nInvQty2 N(6),nInvQty3 N(6),nInvQty4 N(6), nInvQty5 N(6),"+;
  "nInvQty6 N(6),nInvQty7 N(6),nInvQty8 N(6), nInvQty N(11,3), nInvAmnt N(14,2),cRecvType C(1),cWIPAcct C(24)" ,;
  'cSelect+Item+cWareCode+cDyelot','SELECT')
*INDEX ON cSelect+Item+cWareCode+cDyelot TAG 'SELECT'
SELECT (LOFORMSET.LCAUTOINV)
INDEX ON ITEM+CWARECODE+CDYELOT+CTKTNO TAG (LOFORMSET.LCAUTOINV) ADDITIVE

SELECT APVINVDT
=AFIELDS(LAFILESTRU)
LNFILESTRU = ALEN(LAFILESTRU,1)
DIMENSION LAFILESTRU[lnFileStru+2,18]
LAFILESTRU[lnFileStru+1,1] = 'cStatus'
LAFILESTRU[lnFileStru+1,2] = 'C'
LAFILESTRU[lnFileStru+1,3] = 1
LAFILESTRU[lnFileStru+1,4] = 0
LAFILESTRU[lnFileStru+2,1] = 'NRECNO'
LAFILESTRU[lnFileStru+2,2] = 'N'
LAFILESTRU[lnFileStru+2,3] = 5
LAFILESTRU[lnFileStru+2,4] = 0

FOR LNLOOP = 1  TO 2
  STORE '' TO LAFILESTRU[lnFileStru+lnLoop ,7],LAFILESTRU[lnFileStru+lnLoop  ,8],;
    LAFILESTRU[lnFileStru+lnLoop ,9],LAFILESTRU[lnFileStru+lnLoop  ,10],;
    LAFILESTRU[lnFileStru+lnLoop ,11],LAFILESTRU[lnFileStru+lnLoop ,12],;
    LAFILESTRU[lnFileStru+lnLoop ,13],LAFILESTRU[lnFileStru+lnLoop ,14],;
    LAFILESTRU[lnFileStru+lnLoop ,15],LAFILESTRU[lnFileStru+lnLoop ,16]

  STORE 0 TO  LAFILESTRU[lnFileStru+lnLoop ,17],LAFILESTRU[lnFileStru+lnLoop ,18]
ENDFOR

*create table &oAriaApplication.WorkDir.&loformset.lcapvinvdt from array laFileStru
*INDEX ON cIMTyp+cTktNo+cLotNo+STR(LineNo,6)+cBomType+cOprCode+Item+Color+cDyelot TAG ITEM
=GFCRTTMP(LOFORMSET.LCAPVINVDT,@LAFILESTRU,;
  'cIMTyp+cTktNo+cLotNo+STR(LineNo,6)+cBomType+cOprCode+Item+Color+cDyelot','ITEM')
SELECT (LOFORMSET.LCAPVINVDT)
INDEX ON CVENDCODE+CAPINVNO+CAPVILNO TAG (LOFORMSET.LCAPVINVDT) ADDITIVE
INDEX ON CAPDGLACT TAG ADJUST ADDITIVE


SELECT APINVTKT
=AFIELDS(LAFILESTRU)
LNFILESTRU = ALEN(LAFILESTRU,1)
DIMENSION LAFILESTRU[lnFileStru+2,18]
LAFILESTRU[lnFileStru+1,1] = 'cStatus'
LAFILESTRU[lnFileStru+1,2] = 'C'
LAFILESTRU[lnFileStru+1,3] = 1
LAFILESTRU[lnFileStru+1,4] = 0
LAFILESTRU[lnFileStru+2,1] = 'NRECNO'
LAFILESTRU[lnFileStru+2,2] = 'N'
LAFILESTRU[lnFileStru+2,3] = 5
LAFILESTRU[lnFileStru+2,4] = 0

FOR LNLOOP = 1  TO 2
  STORE '' TO LAFILESTRU[lnFileStru+lnLoop ,7],LAFILESTRU[lnFileStru+lnLoop  ,8],;
    LAFILESTRU[lnFileStru+lnLoop ,9],LAFILESTRU[lnFileStru+lnLoop  ,10],;
    LAFILESTRU[lnFileStru+lnLoop ,11],LAFILESTRU[lnFileStru+lnLoop ,12],;
    LAFILESTRU[lnFileStru+lnLoop ,13],LAFILESTRU[lnFileStru+lnLoop ,14],;
    LAFILESTRU[lnFileStru+lnLoop ,15],LAFILESTRU[lnFileStru+lnLoop ,16]

  STORE 0 TO  LAFILESTRU[lnFileStru+lnLoop ,17],LAFILESTRU[lnFileStru+lnLoop ,18]
ENDFOR

*create table &oAriaApplication.WorkDir.&loformset.lcapinvtkt from array laFileStru
*INDEX ON cIMTyp+cTktNo+STR(LineNo,6)+cRSession TAG Ticket
=GFCRTTMP(LOFORMSET.LCAPINVTKT,@LAFILESTRU,;
  'cIMTyp+cTktNo+STR(LineNo,6)+cRSession','Ticket')
SELECT (LOFORMSET.LCAPINVTKT)
INDEX ON CVENDCODE+CAPINVNO+CAPVILNO+CRSESSION TAG (LOFORMSET.LCAPINVTKT) ADDITIVE

*Old: IF _WINDOWS
IF EMPTY(APINVHDR.CTERMCODE)
  *Revise: This must update the Form's Controls
  LOFORMSET.LCPUTERM = LOFORMSET.LCEMPTYCODE
ENDIF


*Old: DEFINE POPUP puTermDes PROMPT field CODES.cdiscrep scroll;
FROM 10.83,2.25 TO 18.83,35.35 ;
MESSAGE gfObj_msg()

*Old: ON SELECTION POPUP puTermDes DO lfvTermCode
IF EMPTY(APINVHDR.CDIVISION)
  *Revise: This must update the Form's Controls
  LOFORMSET.LCPUDIV = LOFORMSET.LCEMPTYCODE
ENDIF

*Old: DEFINE POPUP puDivision PROMPT field CODES.cdiscrep scroll;
FROM 14.00,2.25 TO 22.00,37.00 ;
MESSAGE gfObj_msg()

*Old: ON SELECTION POPUP puDivision DO lfvDivision

*Revise: This must update the Form's Controls
*Old: puTax = CODES.cdiscrep

*Old: DEFINE POPUP puTaxDes PROMPT field CODES.cdiscrep scroll;
FROM 2.35,38.00 TO 9.35,69.30 ;
MESSAGE gfObj_msg()

*Old: ON SELECTION POPUP puTaxDes DO lfvTaxCode
*Old: ENDIF

SELECT CODES

*SET ORDER  TO TAG IDRLTFNAME
LCTEMP="'NN"+LOFORMSET.LCCODEFILT+"'"
*SET FILTER TO (CDEFCODE+CRLTFIELD+CFLD_NAME = &lcTemp) OR CDEFCODE+CRLTFIELD+CFLD_NAME = ' '+'N'+'N/A'
SELECT APINVHDR

*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*SET ORDER TO TAG VENDINV
GFSETORDER("VENDINV")
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

SET FILTER TO CINVSTAT <> 'V'

*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*!*	SET RELATION TO apinvhdr.cvendcode INTO APVENDOR ADDITIVE
*!*	SET RELATION TO APINVHDR.CINVNO+APINVHDR.CVENDCODE INTO APDIST ADDITIVE
*!*	SET RELATION TO apinvhdr.cdivision INTO APDIV ADDITIVE
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

SELECT APDIST
SCATTER MEMVAR MEMO

SELECT APINVHDR

IF LOFORMSET.LLLOCATE
  GO BOTTOM
  IF !EOF()
    SKIP
  ENDIF
  LOFORMSET.LLLOCATE = .F.
ENDIF


*Old: loFormSet.laWndObj [1,1] = gcBaseWind
*Old: loFormSet.laWndObj [1,2] = "IBVENDOR"
*Old: loFormSet.laWndObj [1,3] = "PBNOTE"

*Old: loFormSet.laWndObj [2,1] = loFormSet.lcDisChld1
*Old: loFormSet.laWndObj [2,2] = "apinvhdr.capacct"
*Old: loFormSet.laWndObj [2,3] = "PBCLOSE"

*Old: loFormSet.laWndObj [3,1] = loFormSet.lcDisChld3
*Old: loFormSet.laWndObj [3,2] = "apinvhdr.capacct"
*Old: loFormSet.laWndObj [3,3] = "PBCLOSE"

*Old: loFormSet.laWndObj [4,1] = loFormSet.lcDisChld4
*Old: loFormSet.laWndObj [4,2] = "apinvhdr.capacct"
*Old: loFormSet.laWndObj [4,3] = "PBCLOSE"

*Old: loFormSet.laWndObj [5,1] = loFormSet.lcDisChld5
*Old: loFormSet.laWndObj [5,2] = "apinvhdr.capacct"
*Old: loFormSet.laWndObj [5,3] = "PBCLOSE"

*Old: loFormSet.laWndObj [6,1] = loFormSet.lcDisChld6
*Old: loFormSet.laWndObj [6,2] = "apinvhdr.capacct"
*Old: loFormSet.laWndObj [6,3] = "PBCLOSE"

*Old: loFormSet.laWndObj [7,1] = "CWRAPDISTR"
*Old: loFormSet.laWndObj [7,2] = "apinvhdr.capacct"
*Old: loFormSet.laWndObj [7,3] = "PBCLOSE"

*Old: loFormSet.laWndObj [8,1] = "GWCCONTRL1"
*Old: loFormSet.laWndObj [8,2] = "PBTOP"
*Old: loFormSet.laWndObj [8,3] = "PBCLS"

*Old: PUSH KEY

*Old: ON KEY LABEL CTRL+W     loFormSet.lnDummy = 1
*Old: ON KEY LABEL Ctrl+Q     loFormSet.lnDummy = 1
*Old: ON KEY LABEL CTRL+HOME  loFormSet.lnDummy = 1
*Old: ON KEY LABEL CTRL+END   loFormSet.lnDummy = 1
*Old: ON KEY LABEL Ctrl+ENTER loFormSet.lnDummy = 1

=LOFORMSET.MOPTIONMENU()

*Old: DECLARE loFormSet.laPanelObj[1,3]
*Old: STORE '' TO loFormSet.laPanelObj
*Old: loFormSet.laPanelObj[1,1] = 'pbAPVInvDt'
*Old: loFormSet.laPanelObj[1,2] = gcBmpHome+'NOTES2.BMP'
*Old: loFormSet.laPanelObj[1,3] = [VALID lfvInvDt() MESSAGE 'Invoice Details' DISABLE]


*ASM, Here he was calling appyinv.spr

LOFORMSET.DATAENVIRONMENT.INITIALSELECTEDALIAS = 'APINVHDR'
WITH LOFORMSET.ARIAFORM1
  .KBVENDCODE.KEYTEXTBOX.CONTROLSOURCE = "apinvhdr.cvendcode"
  .KBVENDCOMPANY.KEYTEXTBOX.CONTROLSOURCE = "APVENDOR.cVenComp"
  .KBVENDPHONE.KEYTEXTBOX.CONTROLSOURCE = "APVENDOR.cPhoneNo"
  .KBVENDPHONE.KEYTEXTBOX.INPUTMASK = GFPHONETEM()
  .KBINVNO.KEYTEXTBOX.CONTROLSOURCE = "apinvhdr.cinvno"
  .DTPOSTDATE.CONTROLSOURCE = "apinvhdr.dpostdate"

  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *.DtInvDate.ControlSource = "apinvhdr.dinvdate"
  *.txtInvAmount.ControlSource = "apinvhdr.ninvamnt"
  *.txtInvDisof.ControlSource = "apinvhdr.ninvdisof"
  *.cboTermCode.ControlSource = "apinvhdr.ctermcode"
  *.cboDivision.ControlSource = "apinvhdr.cdivision"
  *.txtInvRef.ControlSource = "apinvhdr.cinvref"
  *.cboInvRemit.ControlSource = "apinvhdr.cinvremit"
  *.kbFacCode.keyTextBox.ControlSource = "apinvhdr.cfaccode"
  *!*	  .txtOutComp.ControlSource = "apinvhdr.coutcomp"
  *!*	  .txtOutAddr1.ControlSource = "apinvhdr.coutaddr1"
  *!*	  .txtOutAddr2.ControlSource = "apinvhdr.coutaddr2"
  *!*	  .txtOutAddr3.ControlSource = "apinvhdr.coutaddr3"
  *!*	.txtVendPrior.ControlSource = "apinvhdr.cvenprior"
  *!*	.kbCurrCode.keyTextBox.ControlSource = "apinvhdr.ccurrcode"
  *!*	.txtNexRate.ControlSource = "apinvhdr.nexrate"
  *!*	.cboVendPmeth.ControlSource = "apinvhdr.cvenpmeth"
  *!*	.txtterdued.ControlSource = "apinvhdr.nterdued"
  *!*	  .txtTerDiscd.ControlSource = "apinvhdr.nterdiscd"
  *!*	  .txtTerDiscr.ControlSource = "apinvhdr.nterdiscr"
  *!*	.dtInvDuDat.ControlSource = "apinvhdr.dinvdudat"
  *!*	.txtPaidAmount.ControlSource = "lfPaidAmount(0)"
  *!*	.txtDiscTaken.ControlSource = "apinvhdr.ninvdistk"
  *!*	.txtPaid1099.ControlSource = "apinvhdr.ninv1099a"
  *!*	.txttotApproved.ControlSource = "thisform.parent.lnTotAppPay"
  .PGFPAYINV.PGHEAD.DTINVDATE.CONTROLSOURCE = "apinvhdr.dinvdate"
  .PGFPAYINV.PGHEAD.TXTINVAMOUNT.CONTROLSOURCE = "apinvhdr.ninvamnt"
  .PGFPAYINV.PGHEAD.TXTINVDISOF.CONTROLSOURCE = "apinvhdr.ninvdisof"
  .PGFPAYINV.PGHEAD.CBOTERMCODE.CONTROLSOURCE = "apinvhdr.ctermcode"
  .PGFPAYINV.PGHEAD.CBODIVISION.CONTROLSOURCE = "apinvhdr.cdivision"
  .PGFPAYINV.PGHEAD.TXTINVREF.CONTROLSOURCE = "apinvhdr.cinvref"
  .PGFPAYINV.PGHEAD.CBOINVREMIT.CONTROLSOURCE = "apinvhdr.cinvremit"
  .PGFPAYINV.PGHEAD.KBFACCODE.KEYTEXTBOX.CONTROLSOURCE = "apinvhdr.cfaccode"
  .PGFPAYINV.PGHEAD.TXTOUTCOMP.CONTROLSOURCE = "apinvhdr.coutcomp"
  .PGFPAYINV.PGHEAD.TXTOUTADDR1.CONTROLSOURCE = "apinvhdr.coutaddr1"
  .PGFPAYINV.PGHEAD.TXTOUTADDR2.CONTROLSOURCE = "apinvhdr.coutaddr2"
  .PGFPAYINV.PGHEAD.TXTOUTADDR3.CONTROLSOURCE = "apinvhdr.coutaddr3"
  .PGFPAYINV.PGHEAD.TXTVENDPRIOR.CONTROLSOURCE = "apinvhdr.cvenprior"
  .PGFPAYINV.PGHEAD.KBCURRCODE.KEYTEXTBOX.CONTROLSOURCE = "apinvhdr.ccurrcode"
  .PGFPAYINV.PGHEAD.TXTNEXRATE.CONTROLSOURCE = "apinvhdr.nexrate"
  .PGFPAYINV.PGHEAD.CBOVENDPMETH.CONTROLSOURCE = "apinvhdr.cvenpmeth"
  .PGFPAYINV.PGHEAD.TXTTERDUED.CONTROLSOURCE = "apinvhdr.nterdued"
  .PGFPAYINV.PGHEAD.TXTTERDISCD.CONTROLSOURCE = "apinvhdr.nterdiscd"
  .PGFPAYINV.PGHEAD.TXTTERDISCR.CONTROLSOURCE = "apinvhdr.nterdiscr"
  .PGFPAYINV.PGHEAD.DTINVDUDAT.CONTROLSOURCE = "apinvhdr.dinvdudat"
  .PGFPAYINV.PGHEAD.TXTPAIDAMOUNT.CONTROLSOURCE = "lfPaidAmount(0)"
  .PGFPAYINV.PGHEAD.TXTDISCTAKEN.CONTROLSOURCE = "apinvhdr.ninvdistk"
  .PGFPAYINV.PGHEAD.TXTPAID1099.CONTROLSOURCE = "apinvhdr.ninv1099a"
  .PGFPAYINV.PGHEAD.TXTTOTAPPROVED.CONTROLSOURCE = "thisform.parent.lnTotAppPay"
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]



  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	  .txtVenOpnDr.ControlSource = "APVENDOR.NVENOPNDR"
  *!*	  .txtVenCrLim.ControlSource = "APVENDOR.NVENCRLIM"
  *!*	  .dtVenlPurd.ControlSource = "APVENDOR.DVENLPURD"
  *!*	  .txtVenBal.ControlSource = "APVENDOR.NVENBAL"
  *!*	  .txtAvlCrLim.ControlSource = "lfAvlCrLim(0)"
  *!*	  .dtVenlPayd.ControlSource = "APVENDOR.DVENLPAYD"
  *.kbAutmCode.keyTextBox.ControlSource = "apinvhdr.cautmcode"
  .PGFPAYINV.PGHEAD.KBAUTMCODE.KEYTEXTBOX.CONTROLSOURCE = "apinvhdr.cautmcode"
  .PGFPAYINV.PGHEAD.TXTVENOPNDR.CONTROLSOURCE = "APVENDOR.NVENOPNDR"
  .PGFPAYINV.PGHEAD.TXTVENCRLIM.CONTROLSOURCE = "APVENDOR.NVENCRLIM"
  .PGFPAYINV.PGHEAD.DTVENLPURD.CONTROLSOURCE = "APVENDOR.DVENLPURD"
  .PGFPAYINV.PGHEAD.TXTVENBAL.CONTROLSOURCE = "APVENDOR.NVENBAL"
  .PGFPAYINV.PGHEAD.TXTAVLCRLIM.CONTROLSOURCE = "lfAvlCrLim(0)"
  .PGFPAYINV.PGHEAD.DTVENLPAYD.CONTROLSOURCE = "APVENDOR.DVENLPAYD"
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

ENDWITH

*on error MESSAGEBOX(PADR(error(),10)+CHR(13)+program()+PADR(lineno(),10)+CHR(13)+message())
*on error MESSAGEBOX(_screen.ActiveForm.activecontrol.name)
*on ERROR wait wind RELATION(1)+' into '+TARGET(1)+' - '+RELATION(2)+' into '+TARGET(2)+' - '+;
RELATION(3)+' into '+TARGET(3)
*ON ERROR susp

LFGETITEMMASK(LOFORMSET,'0001')
LFGETITEMMASK(LOFORMSET,'0002')

RETURN .T.
*--end of lfFormInit


*!*************************************************************
*! Name      : lfAddPro
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 7/7/2004
*! Purpose   : function to Add properties to the FormSet.
*!*************************************************************
*! Parameters: The FomrSet
*!*************************************************************
*! Returns   : None
*!*************************************************************
FUNCTION LFADDPRO
LPARAMETERS LOFORMSET

LOCAL LNI, LNROW, LNCOL, LCACOPY
FOR LNI = 1 TO ALEN(LAALLVAR,1)
  IF LOWER(LEFT(LAALLVAR[lnI,1],2)) = 'la'
    IF TYPE(LAALLVAR[lnI,1])='U'
      LOFORMSET.ADDPROPERTY(LAALLVAR[lnI,1]+'[1]')
      LOOP
    ENDIF
    LNROW = ALEN(LAALLVAR[lnI,1],1)
    LNCOL = ALEN(LAALLVAR[lnI,1],2)
    IF LNCOL>0
      LOFORMSET.ADDPROPERTY(LAALLVAR[lnI,1]+'['+ALLTRIM(STR(LNROW))+;
        ','+ALLTRIM(STR(LNCOL))+']')
    ELSE
      LOFORMSET.ADDPROPERTY(LAALLVAR[lnI,1]+'['+ALLTRIM(STR(LNROW))+']')
    ENDIF
    LCACOPY = '=ACOPY(' + LAALLVAR[lnI,1] + ',loFormSet.' + LAALLVAR[lnI,1] + ')'
    &LCACOPY.
  ELSE
    LOFORMSET.ADDPROPERTY(LAALLVAR[lnI,1],IIF(TYPE(LAALLVAR[lnI,1])<>'U',EVALUATE(LAALLVAR[lnI,1]),.F.))
  ENDIF
ENDFOR
*--end of lfAddPro


*!*************************************************************
*! Name      : lfGetItemMask
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 7/7/2004
*! Purpose   : function to Calculate the Major Length, Color Start Position and Color Lenght
*!             for either the Style or Fabric and store them in the FormSet Properties
*!*************************************************************
*! Parameters: The FormSet, The InvType
*!*************************************************************
*! Returns   : None
*!*************************************************************
FUNCTION LFGETITEMMASK
LPARAMETERS LOFORMSET, LCINVTYPE
LOCAL OGETITEMMASK, LCMJRPCT, LNMATMAJLEN
*! B609627,1 MMT 06/22/2011 Fix bug of Error while opening Payable invoice screen  if there is no Color segment in Style code structure[START]
STORE 0 TO LNFBRCLRSTR,LNFBRCLRLEN
*! B609627,1 MMT 06/22/2011 Fix bug of Error while opening Payable invoice screen  if there is no Color segment in Style code structure[END]
OGETITEMMASK = CREATEOBJECT('GetItemMask')
LCMJRPCT     = OGETITEMMASK.DO('PM','',LCINVTYPE) &&Major picture
LNMATMAJLEN  = LEN(LCMJRPCT)                      &&Major Part lenth
IF LCINVTYPE='0001'
  LOFORMSET.LNSTYMAJLEN = LNMATMAJLEN
ELSE
  LOFORMSET.LNFABMAJLEN = LNMATMAJLEN
ENDIF

DIMENSION LASTYSEG[1,1]

*B608531,1 WAM 04/23/2008 Get the proper item type code structure
*=oGetItemMask.Do(@laStySeg,'','0002')
=OGETITEMMASK.DO(@LASTYSEG,'',LCINVTYPE)
*B608531,1 WAM 04/23/2008 (End)

FOR LNCNT = 1 TO ALEN(LASTYSEG,1)
  IF LASTYSEG[lnCnt , 1] = "C"
    LNFBRCLRSTR = LASTYSEG[lnCnt , 4]
    LNFBRCLRLEN = LEN(LASTYSEG[lnCnt , 3])
  ENDIF
ENDFOR
IF LCINVTYPE='0001'
  LOFORMSET.LNSTYCLRSTART = LNFBRCLRSTR
  LOFORMSET.LNSTYCLRLEN = LNFBRCLRLEN
ELSE
  LOFORMSET.LNFABCLRSTART = LNFBRCLRSTR
  LOFORMSET.LNFABCLRLEN = LNFBRCLRLEN
ENDIF

RETURN
*--end of lfGetItemMask


*!*************************************************************
*! Name      : lfPaidAmount
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 7/12/2004
*! Purpose   : Control Source value for the paid amount
*!*************************************************************
*! Parameters: Dummy Value
*!*************************************************************
*! Returns   : lnPaidAmount
*!*************************************************************
FUNCTION LFPAIDAMOUNT
LPARAMETERS LNDUMMY

LOCAL LNPAIDAMOUNT
LNPAIDAMOUNT = APINVHDR.NINVPAID + APINVHDR.NINVADJ
RETURN LNPAIDAMOUNT

*!*************************************************************
*! Name      : lfAvlCrLim
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 7/12/2004
*! Purpose   : Control Source value for the Current Credit Limit
*!*************************************************************
*! Parameters: Dummy Value
*!*************************************************************
*! Returns   : lnAvlCrLim
*!*************************************************************
FUNCTION LFAVLCRLIM
LPARAMETERS LNDUMMY

LOCAL LNAVLCRLIM
LNAVLCRLIM = APVENDOR.NVENCRLIM - ROUND(APVENDOR.NVENBAL,0)
RETURN LNAVLCRLIM


*!*************************************************************
*! Name      : lfUnDistAmnt
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 7/12/2004
*! Purpose   : Control Source For the Undistributed Amount in DistLines Screen
*!*************************************************************
*! Parameters: Dummy Value
*!*************************************************************
*! Returns   : lnAvlCrLim
*!*************************************************************
FUNCTION LFUNDISTAMNT
LPARAMETERS LNDUMMY

LOCAL LNUNDISTAMNT, LNDISTAMNT
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
IF TYPE('_SCREEN.ACTIVEFORM.PARENT.lnDistAmnt') = 'U'
  RETURN
ENDIF
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
LNDISTAMNT = _SCREEN.ACTIVEFORM.PARENT.LNDISTAMNT

LNUNDISTAMNT = IIF(APINVHDR.NINVAMNT< 0,APINVHDR.NINVAMNT+ABS(LNDISTAMNT),;
  APINVHDR.NINVAMNT-LNDISTAMNT)
RETURN LNUNDISTAMNT



*!*************************************************************
*! Name      : lfFormActivate
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 7/12/2004
*! Purpose   : Function called from the Activate event of the form
*!*************************************************************
*! Parameters: The FormSet whose Activate code calls the function
*!*************************************************************
*! Returns   : None
*!*************************************************************
FUNCTION LFFORMACTIVATE
LOCAL LOFORMSET

IF TYPE('_Screen.ActiveForm.Parent')<>'O' OR _SCREEN.ACTIVEFORM.PARENT.NAME<>'frmAPInvoice'
  RETURN
ENDIF
LOFORMSET = _SCREEN.ACTIVEFORM.PARENT

*ASM, code that was found in the Else part of IF !WEXIST Statement [Start]

IF LOFORMSET.LNINVRECNO < RECCOUNT() AND LOFORMSET.LNINVRECNO > 0
  GO LOFORMSET.LNINVRECNO
ENDIF

LOFORMSET.LLFIRSTSHOW= .T.

*Revise: cvenpmeth may represent a control value not a property
*IF apinvhdr.cvenpmeth = 'C' .and. loFormSet.ActiveMode="V"  &&BOHO

*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*!*	IF loFormSet.AriaForm1.cboVendPmeth.Value = 'C' .and. loFormSet.ActiveMode="V"
IF LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.CBOVENDPMETH.VALUE = 'C' .AND. LOFORMSET.ACTIVEMODE="V"
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  *ASM, Disabling Edit Button
  LOFORMSET.LLEDITBUTTON = .F.
  *laCtrStat[7]  = "DISABLE"                && Edit button
ENDIF
IF !EMPTY(APINVHDR.CVENPMETH) &&Revise
  *Old: loFormSet.lcPayMethd = loFormSet.laPayMethd[AT(apinvhdr.cvenpmeth,'PMNCH'),1]
  *puMethod   = AT(apinvhdr.cvenpmeth,'PMNCH') &&BOHO
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	    puMethod   = AT(loFormSet.AriaForm1.cboVendPmeth.Value,'PMNCH') &&Revise *7Q: Is this line necessary ?
  PUMETHOD   = AT(LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.CBOVENDPMETH.VALUE,'PMNCH') &&Revise *7Q: Is this line necessary ?
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
ENDIF

*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*IF SEEK(apinvhdr.cfisfyear,'FISHD')
IF GFSEEK(APINVHDR.CFISFYEAR,'FISHD')
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

  IF FISHD.CFISYSTAT <> 'H';
      .AND. APINVHDR.CVENPMETH <> 'C';
      .AND. APINVHDR.CINVSTAT <> 'A';
      .AND. LOFORMSET.ACTIVEMODE="V"
    *ASM, Enabling Edit Button
    LOFORMSET.LLEDITBUTTON = .T.
    *laCtrStat[7]  = "ENABLE"                && Edit button
    *ASM, Enabling Delete Button
    LOFORMSET.LLDELETEBUTTON = .T.
    *laCtrStat[8]  = "ENABLE"                && Delete button
  ELSE
    *ASM, Disabling Edit Button
    LOFORMSET.LLEDITBUTTON = .F.
    *laCtrStat[7]  = "DISABLE"               && Edit button
    *ASM, Disabling Delete Button
    LOFORMSET.LLDELETEBUTTON = .F.
    *laCtrStat[8]  = "DISABLE"               && Delete button
  ENDIF
ELSE
  *ASM, Disabling Edit Button
  LOFORMSET.LLEDITBUTTON = .F.
  *laCtrStat[7]  = "DISABLE"               && Edit button
  *ASM, Disabling Delete Button
  LOFORMSET.LLDELETEBUTTON = .F.
  *laCtrStat[8]  = "DISABLE"               && Delete button
ENDIF

*Revise: puremitto may represent a control value not a property
PUREMITTO  = LOFORMSET.LNOLDREMIT

*ASM, code that was found in the Else part of IF !WEXIST Statement [End]

*ASM, code that was in the lfActivate Function [Start]
SELECT APINVHDR

*Old: IF !WVISIBLE(WPARENT(WOUTPUT()))
*Old: SHOW WINDOW (WPARENT(WOUTPUT())) TOP
*Old: ENDIF
*Old: IF WPARENT(WOUTPUT()) = 'CWRAPDISTR'
IF !LOFORMSET.LLFROMVEND
  =LFTAXACT(LOFORMSET)
ENDIF
*Old: ON KEY LABEL ALT+C ACTIVATE WINDOW (lcBrowsTtl)
*Old: IF !WEXIST(lcBrowsTtl)
=LFBROWSE(LOFORMSET)
*Old: ELSE
*Old: SHOW WINDOW(lcBrowsTtl) REFRESH SAME
*Old: ENDIF

*8Q: What will I do with the trapping functions ?
*Old: IF WONTOP() = lcBrowsTtl
*Old: =lfSetTrap()
*Old: ELSE
*Old: =lfResetTrap()
*Old: =lfRelease() &&9Q: Why calling lfRelease here ? &&Revise
*Old: ENDIF
*Old: ELSE
*Old:   IF WEXIST(lcBrowsTtl)
*Old:     SHOW WINDOW (lcBrowsTtl) REFRESH SAME
*Old:   ENDIF
*Old:   =lfResetTrap()
*Old:   =lfRelease()
*Old: ENDIF

SELECT APINVHDR

*ASM, code that was in the lfActivate Function [End]

RETURN
*--end of lfFormActivate



*!*************************************************************
*! Name      : lfFormDeActivate
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 7/12/2004
*! Purpose   : Function called from the DeActivate event of the form
*!*************************************************************
*! Parameters: The FormSet whose DeActivate code calls the function
*!*************************************************************
*! Returns   : None
*!*************************************************************
FUNCTION LFFORMDEACTIVATE
LOCAL LOFORMSET

IF TYPE('_Screen.ActiveForm.Parent')<>'O' OR _SCREEN.ACTIVEFORM.PARENT.NAME<>'frmAPInvoice'
  RETURN
ENDIF
*ASM, code that was in the lfRelease Function [Start]

*Old: IF WONTOP() = lcBrowsTtl

*Old:  =lfSetTrap()
*Old: glFromBrow = .T. &&10Q: what does this variable mean ?
*Old: ELSE
*Old:  =lfResetTrap()
*Old: ENDIF

*Old: IF WONTOP() = lcBrowsTtl .OR. WPARENT(WOUTPUT()) <> 'CWRAPDISTR'
*Old: IF WEXIST(lcBrowsTtl)
*Old: SHOW WINDOW (lcBrowsTtl) REFRESH SAME
=LFDISPOBJCT()
*Old: ENDIF
*Old: RELEASE PAD _BROWSE OF _MSYSMENU
*ON KEY LABEL ALT+B
*Old: ON KEY LABEL ALT+C
*Old: RETURN .T.
*Old: ENDIF

*ASM, code that was in the lfRelease Function [End]

RELEASE PAD _INQUIRY OF (LOFORMSET.CHOSTFORMNAME) &&ASM
RELEASE POPUP _INQURYPOP

RELEASE PAD _BROWSE OF (LOFORMSET.CHOSTFORMNAME) &&ASM


RETURN
*--end of lfFormDeActivate


*!*******************************************************************
*! Name      : lfCrtTmp
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 7/11/2004
*! Purpose   : function to Create a Temprory Table, given its structure as a string.
*!*************************************************************
*! Passed Parameters  : File Name, File Structure, Index Tag Expression, Index Tag Name
*!*******************************************************************
*! Returns            :  True  ----> If passed file is opened successfully
*!                       False ----> If passed file is fails to open succesfully.
*!*******************************************************************
FUNCTION LFCRTTMP
LPARAMETERS LCFILE, LCSTRUC, LCTAGEXP, LCTAGNAME
LOCAL LCTEMP
LOCAL ARRAY LASTRU[1]

LCTEMP=GFTEMPNAME()
CREATE CURSOR &LCTEMP (&LCSTRUC)
SELECT (LCTEMP)
AFIELDS(LASTRU)
USE
=GFCRTTMP(LCFILE,@LASTRU,LCTAGEXP, LCTAGNAME)

RETURN
*--end of lfCrtTmp


*!*************************************************************
*! Name      : lfTaxAct
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 7/12/2004
*! Purpose   :
*!*************************************************************
*! Parameters: None
*!*************************************************************
*! Returns   : None
*!*************************************************************
FUNCTION LFTAXACT
LPARAMETER LOFORMSET


LCOBJSHOW = IIF(INLIST(LOFORMSET.ACTIVEMODE,"V","S") OR LOFORMSET.LLLOKPER , 'DISABLE' ,;
  'ENABLE')


IF APVENDOR.CTAXTYPE <> 'T'
  *Old: SHOW GET ibTaxCode &lcObjShow

  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *  loFormSet.DistLines.CboTaxCode.Enabled=(lcObjShow='ENABLE')
  LOFORMSET.ARIAFORM1.PGFPAYINV.PGDIST.CBOTAXCODE.ENABLED=(LCOBJSHOW='ENABLE')
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

  *Old: SHOW GET ibDumm1   DISABLE

  *Old: IF _WINDOWS

  *Old: SHOW GET puTax &lcObjShow
  *Old: ENDIF
  *Old: lcActWPos = IIF(WPARENT(WONTOP())='CWRAPDISTR','TOP','BOTTOM')
  *Old: lcWinTop  = IIF(lcActWPos = 'TOP','3','4')
  *Old: SHOW WINDOW (lcDisChld&lcWinTop) &lcActWPos IN WINDOW CWRAPDISTR
ELSE
  *Old: SHOW GET ibDumm1   &lcObjShow
  *Old: SHOW GET ibTaxCode DISABLE

  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *loFormSet.DistLines.CboTaxCode.Enabled=.F.
  LOFORMSET.ARIAFORM1.PGFPAYINV.PGDIST.CBOTAXCODE.ENABLED=.F.
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

  *Old: IF _WINDOWS
  *Old: SHOW GET puTax DISABLE
  *Old: ENDIF
  *Old: lcActWPos =IIF( WPARENT(WONTOP())='CWRAPDISTR','TOP','BOTT')
  *Old: lcWinTop  = IIF(lcActWPos = 'TOP','4','3')
  *Old: SHOW WINDOW (lcDisChld&lcWinTop) &lcActWPos IN WINDOW CWRAPDISTR
ENDIF

IF (INLIST(LOFORMSET.ACTIVEMODE,"E","A")) .AND. !LOFORMSET.LLLOKPER


  IF LOFORMSET.LNLINENO = 0
    *IF TYPE('loFormSet.DistLines.txtLineNo.Value = 0')='N' AND loFormSet.DistLines.txtLineNo.Value = 0
    *Old: SHOW GET lnApdAmnt  DISABLE

    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *!*	    loFormSet.DistLines.txtlnApdAmnt.Enabled=.F.
    *!*	    *Old: SHOW GET ibApGlAcc  DISABLE
    *!*	    *Old: SHOW GET lcApdGLAct DISABLE
    *!*	    loFormSet.DistLines.glActCode.Enabled=.F.
    *!*	    *Old: SHOW GET ibTaxCode  DISABLE
    *!*	    *Old: SHOW GET puTax      DISABLE
    *!*	    loFormSet.DistLines.CboTaxCode.Enabled=.F.
    *!*	    *Old: SHOW GET pbRemove   DISABLE
    *!*	    loFormSet.DistLines.cmdRemove.Enabled=.F.
    LOFORMSET.ARIAFORM1.PGFPAYINV.PGDIST.TXTLNAPDAMNT.ENABLED=.F.
    *Old: SHOW GET ibApGlAcc  DISABLE
    *Old: SHOW GET lcApdGLAct DISABLE
    LOFORMSET.ARIAFORM1.PGFPAYINV.PGDIST.GLACTCODE.ENABLED=.F.
    *Old: SHOW GET ibTaxCode  DISABLE
    *Old: SHOW GET puTax      DISABLE
    LOFORMSET.ARIAFORM1.PGFPAYINV.PGDIST.CBOTAXCODE.ENABLED=.F.
    *Old: SHOW GET pbRemove   DISABLE
    LOFORMSET.ARIAFORM1.PGFPAYINV.PGDIST.CMDREMOVE.ENABLED=.F.
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

  ENDIF
ELSE
  *Old: SHOW GET lnApdAmnt  DISABLE

  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	  loFormSet.DistLines.txtlnApdAmnt.Enabled=.F.
  *!*	  *Old: SHOW GET ibApGlAcc  DISABLE
  *!*	  *Old: SHOW GET lcApdGLAct DISABLE
  *!*	  loFormSet.DistLines.glActCode.Enabled=.F.
  *!*	  *Old: SHOW GET ibTaxCode  DISABLE
  *!*	  *Old: SHOW GET puTax      DISABLE
  *!*	  loFormSet.DistLines.CboTaxCode.Enabled=.F.
  *!*	  *Old: SHOW GET pbNew      DISABLE
  *!*	  loFormSet.DistLines.cmdNew.Enabled=.F.
  *!*	  *Old: SHOW GET pbRemove   DISABLE
  *!*	  loFormSet.DistLines.cmdRemove.Enabled=.F.
  *!*	  *Old: SHOW GET apinvhdr.capacct DISABLE
  *!*	  *Old: SHOW GET ibApAcc DISABLE
  *!*	  loFormSet.DistLines.glAPActCode.Enabled=.F.
  LOFORMSET.ARIAFORM1.PGFPAYINV.PGDIST.TXTLNAPDAMNT.ENABLED=.F.
  *Old: SHOW GET ibApGlAcc  DISABLE
  *Old: SHOW GET lcApdGLAct DISABLE
  LOFORMSET.ARIAFORM1.PGFPAYINV.PGDIST.GLACTCODE.ENABLED=.F.
  *Old: SHOW GET ibTaxCode  DISABLE
  *Old: SHOW GET puTax      DISABLE
  LOFORMSET.ARIAFORM1.PGFPAYINV.PGDIST.CBOTAXCODE.ENABLED=.F.
  *Old: SHOW GET pbNew      DISABLE
  LOFORMSET.ARIAFORM1.PGFPAYINV.PGDIST.CMDNEW.ENABLED=.F.
  *Old: SHOW GET pbRemove   DISABLE
  LOFORMSET.ARIAFORM1.PGFPAYINV.PGDIST.CMDREMOVE.ENABLED=.F.
  *Old: SHOW GET apinvhdr.capacct DISABLE
  *Old: SHOW GET ibApAcc DISABLE
  LOFORMSET.ARIAFORM1.PGFPAYINV.PGDIST.GLAPACTCODE.ENABLED=.F.
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

ENDIF

RETURN
*--end of lfTaxAct


*!*************************************************************
*! Name      : lfBrowse
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 7/13/2004
*! Purpose   :
*!*************************************************************
*! Parameters: None
*!*************************************************************
*! Returns   : None
*!*************************************************************
FUNCTION LFBROWSE
LPARAMETER LOFORMSET
PRIVATE LCCLRSCHM



*Old: lcClrSchm = IIF(_DOS," COLOR SCHEME 13","NOMENU")
IF INLIST(LOFORMSET.ACTIVEMODE,"E","A")
  SELECT(LOFORMSET.LCTMPDIST)
  *Revise: May be will change the form's capion
  LOFORMSET.LCBROWSTTL = IIF(LOFORMSET.LLLOKPER,'View distribution','Add / Edit distribution')
ELSE
  SELECT APDIST
  LOFORMSET.LCBROWSTTL = 'View distribution' &&Revise: May be will change the form's capion
ENDIF
IF APVENDOR.CTAXTYPE = 'T'
  *Old: lnDesWdth = 45 - lnApsAcLen
  *Revise: May be will effect the rowsource of the grid
  *Revise: loFormSet.lcBrowStr = "NAPDLINNO :4 :W=.F. :R :H='No.',"+;
  "CAPDGLACT :"+STR(lnApsAcLen,2)+" :H='Account' :P=lcApsAcMas :R ,"+;
  "CDESC=IIF(llApGlLink,ALLTRIM(LOOKUP(lcLinkChar.CACCNLDES,CAPDGLACT,lcLinkChar.CACCTCODE,'ACCTCODE')),' ') :"+STR(lnDesWdth,2)+" :R :H='Description' :R :W=.F.,"+;
  "NAPDAMNT :15 :H='Dist. amount' :R :W=.F."
  IF LOFORMSET.ACTIVEMODE="V" .OR. LOFORMSET.LLLOKPER
    *Old: SHOW GET ibDumm1   ENABLE
    *Old: SHOW GET ibTaxCode DISABLE
    *Old: SHOW GET puTax     DISABLE

    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *loFormSet.DistLines.CboTaxCode.Enabled=.F.
    LOFORMSET.ARIAFORM1.PGFPAYINV.PGDIST.CBOTAXCODE.ENABLED=.F.
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

    *Old:  SHOW WINDOW (loFormSet.lcDisChld4) TOP IN WINDOW CWRAPDISTR
  ENDIF
ELSE
  *Old: lnDesWdth = 36 - lnApsAcLen
  *Revise: loFormSet.lcBrowStr = "NAPDLINNO :4 :W=.F. :R :H='No.',"+;
  "CTAXDES=IIF(EMPTY(CTAXCODE),loFormSet.lcEmptyCode,LOOKUP(CODES.cdiscrep,'N'+'CTAXCODE  '+CTAXCODE,CODES.CCODE_NO,'CCODE_NO')) :8 :H='Tax Code' :R :W=.F.,"+;
  "CAPDGLACT :"+STR(lnApsAcLen,2)+" :H='Account' :P=lcApsAcMas :R :W=.F.,"+;
  "CDESC=IIF(llApGlLink,ALLTRIM(LOOKUP(lcLinkChar.CACCNLDES,CAPDGLACT,lcLinkChar.CACCTCODE,'ACCTCODE')),' ') :"+STR(lnDesWdth,2)+" :R :H='Description' :W=.F.,"+;
  "NAPDAMNT :15 :H='Dist. amount' :R :W=.F."
  IF LOFORMSET.ACTIVEMODE="V" .OR. LOFORMSET.LLLOKPER
    *Old: SHOW GET ibDumm1   DISABLE
    *Old: SHOW GET ibTaxCode DISABLE
    *Old: SHOW GET puTax     DISABLE

    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *loFormSet.DistLines.CboTaxCode.Enabled=.F.
    LOFORMSET.ARIAFORM1.PGFPAYINV.PGDIST.CBOTAXCODE.ENABLED=.F.
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

    *Old: SHOW WINDOW (loFormSet.lcDisChld3) TOP IN WINDOW CWRAPDISTR
  ENDIF
ENDIF
*Revise: May be will effect the rowsource of the grid
*Old: BROWSE FIELDS &loFormSet.lcBrowStr;
FOR cInvNo + cVendCode + cApdTrTyp = (PADR(laData[2] , 12)) +;
(laData[1]) .AND. cApdActId = 'D' .AND. cApdStat <> 'V';
WINDOW (lcDischld2) ;
WHEN lfwDisBrow();
VALID :F (WONTOP() = loFormSet.lcBrowsTtl .AND. lfvBrowse()) .OR. gfStopBrow() ;
IN WINDOW CWRAPDISTR;
LOCK 0;
NOAPPEND;
NOCLEAR;
NODELETE;
NOWAIT;
SAVE;
TITLE loFormSet.lcBrowsTtl;
NOEDIT &lcClrSchm
IF LOFORMSET.ACTIVEMODE="V"
  SELECT APINVHDR
  IF !EOF()
    GO RECNO()
  ENDIF
  SELECT APDIST
  LOCATE REST FOR CAPDSTAT <> 'V' .AND. CAPDACTID <> 'A'
  =LFDISPOBJCT(LOFORMSET)
ENDIF

RETURN
*--end of lfBrowse


*!*************************************************************
*! Name      : lfDispObjct
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 7/13/2004
*! Purpose   :
*!*************************************************************
*! Parameters: None
*!*************************************************************
*! Returns   : None
*!*************************************************************
FUNCTION LFDISPOBJCT
LPARAMETER LOFORMSET


SELECT IIF(LOFORMSET.ACTIVEMODE="V",'APDIST',LOFORMSET.LCTMPDIST)
LOFORMSET.LCAPDGLACT = IIF(!EMPTY(CAPDGLACT),CAPDGLACT,LOFORMSET.ARIAFORM1.AP1.LCEMPTYACC)
LOFORMSET.LNAPDAMNT  = NAPDAMNT

*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*loFormSet.DistLines.txtlnApdAmnt.Value = nApdAmnt &&ASM
LOFORMSET.ARIAFORM1.PGFPAYINV.PGDIST.TXTLNAPDAMNT.VALUE = NAPDAMNT &&ASM
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

LOFORMSET.LCTAXCODE  = CTAXCODE

*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*loFormSet.DistLines.CboTaxCode.Value = CTAXCODE &&ASM
LOFORMSET.ARIAFORM1.PGFPAYINV.PGDIST.CBOTAXCODE.VALUE = CTAXCODE &&ASM
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

IF !LOFORMSET.ACTIVEMODE="V" AND LOFORMSET.LNLINENO <= 0
  *IF !loFormSet.ActiveMode="V" AND loFormSet.DistLines.txtLineNo.Value <= 0
  LOFORMSET.LNAPDAMNT  = 0
  *loFormSet.DistLines.txtlnApdAmnt.Value = 0 &&ASM
  LOFORMSET.LCTAXCODE  = ''

  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *loFormSet.DistLines.CboTaxCode.Value = '' &&ASM
  LOFORMSET.ARIAFORM1.PGFPAYINV.PGDIST.CBOTAXCODE.VALUE = '' &&ASM
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

ENDIF

STORE GFCODDES(LOFORMSET.LCTAXCODE,'CTAXCODE') TO LOFORMSET.LCTAXDES, PUTAX
IF LOFORMSET.ACTIVEMODE="V" OR LOFORMSET.LLLOKPER OR !EMPTY(LOFORMSET.LCVENINVTYPES) OR LOFORMSET.LNLINENO = 0
  *IF loFormSet.ActiveMode="V" or loFormSet.llLokPer or !empty(loFormSet.lcVenInvTypes) or loFormSet.DistLines.txtLineNo.Value = 0
  *Old: SHOW GET ibApGlAcc  DISABLE
  *Old: SHOW GET loFormSet.lcApdGLAct DISABLE

  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	  loFormSet.DistLines.glActCode.Enabled=.F.
  *!*	  *Old: SHOW GET loFormSet.lnApdAmnt  DISABLE
  *!*	  loFormSet.DistLines.txtlnApdAmnt.Enabled=.F.
  *!*	  *Old: SHOW GET ibTaxCode  DISABLE
  *!*	  *Old: SHOW GET puTax      DISABLE
  *!*	  loFormSet.DistLines.CboTaxCode.Enabled=.F.
  LOFORMSET.ARIAFORM1.PGFPAYINV.PGDIST.GLACTCODE.ENABLED=.F.
  *Old: SHOW GET loFormSet.lnApdAmnt  DISABLE
  LOFORMSET.ARIAFORM1.PGFPAYINV.PGDIST.TXTLNAPDAMNT.ENABLED=.F.
  *Old: SHOW GET ibTaxCode  DISABLE
  *Old: SHOW GET puTax      DISABLE
  LOFORMSET.ARIAFORM1.PGFPAYINV.PGDIST.CBOTAXCODE.ENABLED=.F.
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

ELSE
  *Old: IF EMPTY(loFormSet.lcTaxCode)

  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	  IF EMPTY(loFormSet.DistLines.CboTaxCode.Value)
  *!*	    *Old: SHOW GET loFormSet.lcApdGLAct ENABLE
  *!*	    *Old: SHOW GET ibApGlAcc  ENABLE
  *!*	    loFormSet.DistLines.glActCode.Enabled=.T.
  *!*	  ELSE
  *!*	    *Old: SHOW GET ibApGlAcc  DISABLE
  *!*	    *Old: SHOW GET loFormSet.lcApdGLAct DISABLE
  *!*	    loFormSet.DistLines.glActCode.Enabled=.F.
  *!*	  ENDIF
  *!*	  *Old: SHOW GET loFormSet.lnApdAmnt ENABLE
  *!*	  loFormSet.DistLines.txtlnApdAmnt.Enabled=.T.
  *!*	  *Old: SHOW GET puTax     ENABLE
  *!*	  loFormSet.DistLines.CboTaxCode.Enabled=.T.
  IF EMPTY(LOFORMSET.ARIAFORM1.PGFPAYINV.PGDIST.CBOTAXCODE.VALUE)
    *Old: SHOW GET loFormSet.lcApdGLAct ENABLE
    *Old: SHOW GET ibApGlAcc  ENABLE
    LOFORMSET.ARIAFORM1.PGFPAYINV.PGDIST.GLACTCODE.ENABLED=.T.
  ELSE
    *Old: SHOW GET ibApGlAcc  DISABLE
    *Old: SHOW GET loFormSet.lcApdGLAct DISABLE
    LOFORMSET.ARIAFORM1.PGFPAYINV.PGDIST.GLACTCODE.ENABLED=.F.
  ENDIF
  *Old: SHOW GET loFormSet.lnApdAmnt ENABLE
  LOFORMSET.ARIAFORM1.PGFPAYINV.PGDIST.TXTLNAPDAMNT.ENABLED=.T.
  *Old: SHOW GET puTax     ENABLE
  LOFORMSET.ARIAFORM1.PGFPAYINV.PGDIST.CBOTAXCODE.ENABLED=.T.
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

ENDIF
LOFORMSET.LCTAXDES = GFCODDES(LOFORMSET.LCTAXCODE , 'CTAXCODE')
*Old: IF SUBSTR(gcBaseWind,4,LEN(gcBaseWind)) = loFormSet.lcActProg
*Old: =lfRefresh(loFormSet.lcDisChld1+','+loFormSet.lcDisChld3+','+loFormSet.lcDisChld4+','+loFormSet.lcDisChld5)
*Old: ENDIF

RETURN
*--end of lfDispObjct


*!*************************************************************
*! Name      : lfFormRefresh
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 7/7/2004
*! Purpose   : Procedure called from the ChangeMode Event of the form
*!*************************************************************
*! Parameters: The FormSet whose init code calls the function
*!*************************************************************
*! Returns   : None
*!*************************************************************
PROCEDURE LPFORMREFRESH
LPARAMETERS LOFORMSET
LOCAL LCOBJSHOW, LCDISTPRD, LCDISTYER, LLLOKPER, LCEXSIN2

*ASM [Start]
IF LOFORMSET.LLDATANOTOPENED
  RETURN
ENDIF

*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*loFormSet.AriaForm1.cmdVendor.Enabled = loFormSet.ActiveMode<>'S'
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

*ASM, Assign the Tag property of the postdate, invoice date and invoice amount
*To be able not to enter any other control until they are validated. Also Enable the
*PostDate and Invoice Date in case they were disabled in previous Edit Mode

*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*!*	STORE IIF(INLIST(loFormSet.ActiveMode,"A","E"),'x','') TO ;
*!*	  loFormSet.AriaForm1.dtPostDate.Tag, loFormSet.AriaForm1.dtInvDate.Tag, ;
*!*	  loFormSet.AriaForm1.txtInvAmount.Tag


*!*	STORE IIF(INLIST(loFormSet.ActiveMode,"A","E"),.T.,.F.) TO ;
*!*	  loFormSet.AriaForm1.dtPostDate.Enabled, loFormSet.AriaForm1.dtInvDate.Enabled
STORE IIF(INLIST(LOFORMSET.ACTIVEMODE,"A","E"),'x','') TO ;
  LOFORMSET.ARIAFORM1.DTPOSTDATE.TAG, LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.DTINVDATE.TAG, ;
  LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTINVAMOUNT.TAG


STORE IIF(INLIST(LOFORMSET.ACTIVEMODE,"A","E"),.T.,.F.) TO ;
  LOFORMSET.ARIAFORM1.DTPOSTDATE.ENABLED, LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.DTINVDATE.ENABLED
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
*ASM [End]

LOFORMSET.LLCLOSED = .F.
IF !EMPTY(LOFORMSET.LCVENINVTYPES)
  *11Q: is this code necessay ?
  LOFORMSET.LACODES[1,7] = IIF(LOFORMSET.ACTIVEMODE="V",'APVINVDT',LOFORMSET.LCAPVINVDT) &&Old laCodes
  LOFORMSET.LACODES[1,8] = IIF(LOFORMSET.ACTIVEMODE="V",'ORGVINV',LOFORMSET.LCAPVINVDT)

  *B608428,1 AKA 02/11/2008, Assign the correct file and index to TaxCode array [Start]
  *!*	  loFormSet.laCodes[2,7] = IIF(loFormSet.ActiveMode="V",'APDIST',loFormSet.lcTmpDist)
  *!*	  loFormSet.laCodes[2,8] = IIF(loFormSet.ActiveMode="V",'APDIST',loFormSet.lcTmpDist)
  LOFORMSET.LACODES[2,7] = IIF(LOFORMSET.ACTIVEMODE="V",'APDIST',LOFORMSET.LCAPVINVDT)
  LOFORMSET.LACODES[2,8] = IIF(LOFORMSET.ACTIVEMODE="V",'APDIST',LOFORMSET.LCAPVINVDT)
  *B608428,1 AKA 02/11/2008, Assign the correct file and index to TaxCode array [End]

ENDIF

*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*!*	IF loFormSet.ActiveMode="S" OR EMPTY(loFormSet.lcVenInvTypes) OR ;
*!*	   ('M'=loFormSet.lcVenInvTypes AND gfGetMemVar('LLMULCURR') AND PADR(loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value,3) <> PADR(oAriaApplication.BaseCurrency,3))
IF LOFORMSET.ACTIVEMODE="S" OR EMPTY(LOFORMSET.LCVENINVTYPES) OR ;
    ('M'=LOFORMSET.LCVENINVTYPES AND GFGETMEMVAR('LLMULCURR') AND PADR(LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.KEYTEXTBOX.VALUE,3) <> PADR(OARIAAPPLICATION.BASECURRENCY,3))
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

  *('M'=loFormSet.lcVenInvTypes AND gfGetMemVar('LLMULCURR') AND PADR(apinvhdr.ccurrcode,3) <> PADR(oAriaApplication.BaseCurrency,3))  &&BOHO
  *Old: SHOW GET pbAPVInvDt DISABLE &&Revise
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *loFormSet.AriaForm1.cmdInvLines.Enabled = .F.
  LOFORMSET.ARIAFORM1.PGFPAYINV.PGDET.ENABLED = .F.
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
ELSE
  *Old: SHOW GET pbAPVInvDt ENABLE &&Revise
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *loFormSet.AriaForm1.cmdInvLines.Enabled = .T.
  LOFORMSET.ARIAFORM1.PGFPAYINV.PGDET.ENABLED = .T.
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
ENDIF


IF LOFORMSET.ACTIVEMODE="E"
  *12Q: Where is lfVlDate Function Defined and is it valid in Aria4 to pass the variable gcPrnt_Cmp ?
  *=lfVlDate(gcPrnt_Cmp , @loFormSet.lcDistPrd , @loFormSet.lcDistYer , apinvhdr.dpostdate , @loFormSet.llLokPer)  &&BOHO
  *=lfVlDate(oAriaApplication.PrntCompanyID , @loFormSet.lcDistPrd , @loFormSet.lcDistYer , loFormSet.AriaForm1.DtPostDate.Text1.Value , @loFormSet.llLokPer)
  LCDISTPRD = LOFORMSET.LCDISTPRD
  LCDISTYER = LOFORMSET.LCDISTYER
  LLLOKPER = LOFORMSET.LLLOKPER
  =LFVLDATE(OARIAAPPLICATION.PRNTCOMPANYID , @LCDISTPRD , @LCDISTYER , LOFORMSET.ARIAFORM1.DTPOSTDATE.TEXT1.VALUE , @LLLOKPER)
  LOFORMSET.LCDISTPRD = LCDISTPRD
  LOFORMSET.LCDISTYER = LCDISTYER
  LOFORMSET.LLLOKPER = LLLOKPER
  *B129901,1 ASM 09/26/2005 Prevent edit Payable invoice lines when falls in locked period [Start]
  IF LOFORMSET.LLLOKPER
    *Message : " This Invoice is in a locked period any changes made will post to GL with today's date "
    *Buttons : "                    <    Ok    >                "
    *=gfModalGen("INM04205B00000","DIALOG")
    *! B130111,1 ASM 11/01/2005 Allow the User to Edit an Invoice whose posted date is locked, but make entries on system date [Start]
    *! B130111,2 ASM 05/01/2006 Allow the User to Edit an Invoice whose posted date is locked, but Prevent accessing Invoice Lines and Total Amount [Start]
    *=gfModalGen("INM04205B00000" , "DIALOG" , 'Invoice Data')
    *! B130111,2 ASM 05/01/2006 Allow the User to Edit an Invoice whose posted date is locked, but Prevent accessing Invoice Lines and Total Amount [End]
    *! B130111,1 ASM 11/01/2005 Allow the User to Edit an Invoice whose posted date is locked, but make entries on system date [End]
    *B129901,1 WSH 10/02/2005 Pass the parameter to not ask to lose changes or not. [Start]
    *oAriaApplication.oToolBar.cmdExit.Click()
    *! B130111,1 ASM 11/01/2005 Allow the User to Edit an Invoice whose posted date is locked, but make entries on system date [Start]
    *oAriaApplication.oToolBar.cmdExit.Click(.T.)
    *! B130111,1 ASM 11/01/2005 Allow the User to Edit an Invoice whose posted date is locked, but make entries on system date [End]
    *B129901,1 WSH 10/02/2005 [End]

    *RETURN
  ENDIF
  *B129901,1 ASM 09/26/2005 Prevent edit Payable invoice lines when falls in locked period [End]
ENDIF

IF LOFORMSET.ACTIVEMODE="S" .OR. LOFORMSET.ACTIVEMODE="A"
  LOFORMSET.LLLOKPER = .F.
ENDIF


IF LOFORMSET.LLINQUIRY
  *13Q: can we use seekrecord() here ?
  *apinvhdr.cvendcode      = loFormSet.lcVenCode  &&BOHO

  LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE      = LOFORMSET.LCVENCODE
  *apinvhdr.cinvno      = loFormSet.lcInvNo  &&BOHO
  LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE      = LOFORMSET.LCINVNO
  *=SEEK(apinvhdr.cvendcode+apinvhdr.cinvno,'APINVHDR')  &&BOHO
  =SEEK(LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE+LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE,'APINVHDR')
  *Old: SCATTER FIELDS &loFormSet.lcScFields MEMO TO laData
  *Old: SHOW GET pbDlt DISABLE
  LOFORMSET.LLDELETEBUTTON = .F.
  *Old: SHOW GET pbVendor DISABLE
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *loFormSet.AriaForm1.cmdVendor.Enabled=.F.
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
ENDIF


IF LOFORMSET.LLFIRSTSHOW
  LOFORMSET.LLFIRSTSHOW= .F.
  IF LOFORMSET.ACTIVEMODE="V" .OR. LOFORMSET.ACTIVEMODE="E"
    *Old: SHOW GET apinvhdr.ccurrcode DISABLE
    *Old: SHOW GET ibCurrency DISABLE
    *Old: SHOW GET apinvhdr.nexrate DISABLE
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    * loFormSet.AriaForm1.kbCurrCode.Enabled=.F.
    *!*	   loFormSet.AriaForm1.txtNexRate.Enabled=.F.
    LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.ENABLED=.F.
    LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTNEXRATE.ENABLED=.F.
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

  ENDIF

  =LFDELSHOW()
  IF LOFORMSET.LLFROMVEND
    LOFORMSET.LLFROMVEND = .F.
    KEYBOARD "{ENTER}" &&Revise
  ENDIF
  RETURN
ENDIF

*ASM, INITIALLY DISABLING THE KEY FIELDS CONTROL
STORE .F. TO LOFORMSET.ARIAFORM1.KBVENDCODE.ENABLED, LOFORMSET.ARIAFORM1.KBVENDCOMPANY.ENABLED, ;
  LOFORMSET.ARIAFORM1.KBVENDPHONE.ENABLED, LOFORMSET.ARIAFORM1.KBINVNO.ENABLED

DO CASE
CASE LOFORMSET.ACTIVEMODE="S"  && Select Mode
  LOFORMSET.LLUPDINVLN = .F.

  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  LOFORMSET.ARIAFORM1.PGFPAYINV.ACTIVEPAGE = 1
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

  LOFORMSET.LNSTARTADR=1
  *Old =lfShiftlaData(1) &&Revise: it was used to redisplay the lines of Address
  STORE  'DISABLE' TO LOFORMSET.LCSCUPSTAT, LOFORMSET.LCSCDNSTAT
  *Old: SHOW GET ibshiftup DISABLE &&Revise
  *Old: SHOW GET ibshiftDn DISABLE &&Revise

  STORE 'DISABLE' TO LOFORMSET.LCDATA23ST,LOFORMSET.LCFACTSTAT,LOFORMSET.LCAPRSTAT,LOFORMSET.LCDISTSTAT,;
    LOFORMSET.LCTERMSDISP,LOFORMSET.LCREMITSTAT

  SELECT(LOFORMSET.LCTMPDIST)
  ZAP

  *Old: IF WVISIBLE('CWRAPDISTR')
  *Old: =gfChClose('CWRAPDISTR')
  *Old: ENDIF

  SELECT APINVHDR

  IF LOFORMSET.LLSAMVENDOR
    *Old: apinvhdr.cvendcode   = ALLTRIM(loFormSet.lcVendor)
    LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE = ALLTRIM(LOFORMSET.LCVENDOR)
    *Old: SHOW GET apinvhdr.cvendcode
    LOFORMSET.ARIAFORM1.KBVENDCODE.REFRESH()
    *Old: _CUROBJ = OBJNUM(apinvhdr.cinvno)
    LOFORMSET.ARIAFORM1.KBINVNO.SETFOCUS()
    LOFORMSET.ARIAFORM1.KBVENDCODE.TAG='x'
    LOFORMSET.LLSAMVENDOR = .F.
  ELSE
    *Revise: Use the form's controls
    LOFORMSET.LCPHONE     = SPACE(16) && Variable to hold the phone no.
    *loFormSet.AriaForm1.kbVendPhone.KeyTextBox.Value = SPACE(16)
    LOFORMSET.LCCOMPANY   = SPACE(30) && Variable to hold the company name.
    *loFormSet.AriaForm1.kbVendCompany.KeyTextBox.Value = SPACE(30)
    LOCATE
  ENDIF
  
  LOFORMSET.LCREMITTO   = LOFORMSET.LAREMITTO[1,1] &&Revise: Use the form's controls

  *Revise: Use the form's controls [Start]
  *14Q: is this a process of assigning default values to the screen controls ?
  STORE ' '        TO LOFORMSET.LCPAYMETHD,LOFORMSET.LCOLDYEAR,LOFORMSET.LCOLDPERIOD

  *Old: STORE loFormSet.lcEmptyAcc TO loFormSet.lcDisAcct, loFormSet.lcApdGLAct,apinvhdr.cchkglacc, apinvhdr.capacct, loFormSet.lcAccount
  STORE LOFORMSET.ARIAFORM1.AP1.LCEMPTYACC TO ;
    LOFORMSET.LCDISACCT, LOFORMSET.LCAPDGLACT, LOFORMSET.LCACCOUNT


  STORE 0          TO LOFORMSET.LNTOTAPPPAY,LOFORMSET.LNOLDINVAMT,LOFORMSET.LNOLDDISCOF,LOFORMSET.LNDISTAMNT,LOFORMSET.LNINVADJ,;
    LOFORMSET.LNLINENO,PUMETHOD

  STORE 1          TO LOFORMSET.LNOLDREMIT,PUREMITTO

  STORE .F.        TO LOFORMSET.LLGLACTSTA,LOFORMSET.LLCANSAV,LOFORMSET.LLINVBYCR,LOFORMSET.LLPAIDBYCRD,LOFORMSET.LLINVCAN

  LOFORMSET.LDOLDDATINV = {}        && Variable to hold the old invoice date.
  *Revise: Use the form's controls [End]

  *Old: SHOW GET ibVendor  ENABLE
  *Old: SHOW GET ibPhone   ENABLE
  *Old: SHOW GET ibCompany ENABLE
  *Old: SHOW GET ibInvoice ENABLE
  STORE .T. TO LOFORMSET.ARIAFORM1.KBVENDCODE.ENABLED, LOFORMSET.ARIAFORM1.KBVENDCOMPANY.ENABLED, ;
    LOFORMSET.ARIAFORM1.KBVENDPHONE.ENABLED, LOFORMSET.ARIAFORM1.KBINVNO.ENABLED
  *Old: SHOW GET ibTaxCode DISABLE COLOR ,,,,,,,,&loFormSet.lcColorInv,&loFormSet.lcColorInv &&Revise
  *Old: SHOW GET puTax DISABLE

  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *loFormSet.DistLines.cboTaxCode.Enabled=.F.
  LOFORMSET.ARIAFORM1.PGFPAYINV.PGDIST.CBOTAXCODE.ENABLED=.F.
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

  *Old: SHOW GET pbApprove,1 PROMPT '\<Approve for payment...' &loFormSet.lcAprStat

  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	    loFormSet.AriaForm1.cmdApprove.Caption='\<Approve for payment...'
  *!*	    loFormSet.AriaForm1.cmdApprove.Enabled=(loFormSet.lcAprStat='ENABLE')
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

  STORE LOFORMSET.LCEMPTYCODE TO LOFORMSET.LCDIVISION,LOFORMSET.LCPUDIV,LOFORMSET.LCTERMCODE,LOFORMSET.LCPUTERM
  LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.SETFOCUS()

CASE LOFORMSET.ACTIVEMODE="V" .OR. LOFORMSET.ACTIVEMODE="E"

  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  * SET ORDER TO TAG VENCODE IN APVENDOR
  IF LOFORMSET.ACTIVEMODE="V"
    LOFORMSET.ARIAFORM1.PGFPAYINV.ACTIVEPAGE = 1
    *!B609918,1 MMT 05/16/2012 Payable invoice screen updates APDIST incorrectly[Start]
    *=GFSQLRUN("Select * From APDIST Where CINVNO='"+;
    LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE+"' AND CVENDCODE = '"+;
    LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE+"'",'APDIST')
    =gfSeek(PADR(loFormSet.AriaForm1.kbInvNo.keyTextBox.VALUE,12)+PADR(loFormSet.AriaForm1.kbVendCode.keyTextBox.VALUE,8),'APDIST','INVVEND')
    *!B609918,1 MMT 05/16/2012 Payable invoice screen updates APDIST incorrectly[END]
  ENDIF
  SELECT APVENDOR
  =GFSETORDER('VENCODE')
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

  *=SEEK(apinvhdr.cvendcode,'APVENDOR')  &&BOHO

  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *    =SEEK(loFormSet.AriaForm1.kbVendCode.keyTextBox.Value,'APVENDOR')
  =GFSEEK(LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE,'APVENDOR')
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

  LOFORMSET.LCVENINVTYPES = ALLTRIM(APVENDOR.CVENINVTYP)
  LOFORMSET.LCVENINVTYPES = LOFORMSET.LCVENINVTYPES + IIF(GFGETMEMVAR('M_BOMVAR') AND 'M' $ LOFORMSET.LCVENINVTYPES,'A','')
  LOFORMSET.LCVENINVTYPES = LOFORMSET.LCVENINVTYPES + IIF(!EMPTY(GFGETMEMVAR('M_DYEOPR')) AND 'M' $ LOFORMSET.LCVENINVTYPES,'D','')
  LNOLDALS = SELECT(0)
  SELECT APVINVDT
  LNOLDIND = ORDER()

  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  * SET ORDER TO Orgvinv
  =GFSETORDER('Orgvinv')
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

  =LOFORMSET.MOPTIONMENU()
  *IF SEEK(apinvhdr.cvendcode+apinvhdr.cinvno) &&Boho

  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	    IF SEEK(loFormSet.AriaForm1.kbVendCode.keyTextBox.Value+ ;
  *!*	                loFormSet.AriaForm1.kbInvNo.keyTextBox.Value)
  IF GFSEEK(LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE+ ;
      LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE)
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

    *LOCATE REST WHILE cvendcode+capinvno+capvilno = apinvhdr.cvendcode+apinvhdr.cinvno ;
    FOR   !(cimtyp $ loFormSet.lcVenInvTypes)  &&BOHO
    LOCATE REST WHILE CVENDCODE+CAPINVNO+CAPVILNO = LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE+;
      LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE ;
      FOR   !(CIMTYP $ LOFORMSET.LCVENINVTYPES)
    IF FOUND()
      =GFMODALGEN('TRM04196B00000','DIALOG')
      *Old: SHOW GET pbAPVInvDt DISABLE &&Revise

      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *!*	        loFormSet.AriaForm1.cmdInvLines.Enabled = .F.
      LOFORMSET.ARIAFORM1.PGFPAYINV.PGDET.ENABLED = .F.
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

      *Old: SHOW GET pbEdt DISABLE
      LOFORMSET.LLEDITBUTTON = .F.

      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *DEFINE BAR 2 OF _INQURYPOP PROMPT 'Invoice \<Lines' SKIP FOR .T.
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

      IF !EMPTY(LNOLDIND)
        SELECT APVINVDT

        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        *SET ORDER TO (lnOldInd)
        =GFSETORDER(LNOLDIND)
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

      ENDIF
      SELECT (LNOLDALS)
      RETURN
    ENDIF
  ENDIF
  IF !EMPTY(LNOLDIND)
    SELECT APVINVDT

    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *SET ORDER TO (lnOldInd)
    GFSETORDER(LNOLDIND)
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

  ENDIF
  SELECT (LNOLDALS)

  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *    loFormSet.lcDistAcct = IIF(!EMPTY(APVENDOR.CEXPACCT),APVENDOR.CEXPACCT,;
  IIF(SEEK(apinvhdr.cdivision,'APDIV') AND !EMPTY(APDIV.CEXPACCT),APDIV.CEXPACCT,APSETUP.CEXPACCT))
  LOFORMSET.LCDISTACCT = IIF(!EMPTY(APVENDOR.CEXPACCT),APVENDOR.CEXPACCT,;
    IIF(GFSEEK(APINVHDR.CDIVISION,'APDIV') AND !EMPTY(APDIV.CEXPACCT),APDIV.CEXPACCT,APSETUP.CEXPACCT))
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

  *IF TYPE('APINVHDR.DPOSTDATE') = 'D' .AND. EMPTY(apinvhdr.dpostdate)  &&BOHO
  IF TYPE('loFormSet.AriaForm1.DtPostDate.Value') = 'D' .AND. EMPTY(LOFORMSET.ARIAFORM1.DTPOSTDATE.VALUE)
    *apinvhdr.dpostdate = apinvhdr.dinvdate  &&BOHO

    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *loFormSet.AriaForm1.DtPostDate.Value = loFormSet.AriaForm1.DtInvDate.Value
    LOFORMSET.ARIAFORM1.DTPOSTDATE.VALUE = LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.DTINVDATE.VALUE
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

  ENDIF

  *IF apinvhdr.cvenpmeth = 'C' &&BOHO

  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *IF loFormSet.AriaForm1.cboVendPmeth.Value = 'C'  &&Revise
  IF LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.CBOVENDPMETH.VALUE = 'C'  &&Revise
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

    *Old: SHOW GET pbApprove,1 PROMPT 'Credit c\<ard payment...'

    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *loFormSet.AriaForm1.cmdApprove.Caption='Credit c\<ard payment...'
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

  ELSE
    *Old: SHOW GET pbApprove,1 PROMPT '\<Approve for payment...'

    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *loFormSet.AriaForm1.cmdApprove.Caption='\<Approve for payment...'
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

  ENDIF

  IF LOFORMSET.ACTIVEMODE="V"
    LOFORMSET.LNSTARTADR=1
    *Old =lfShiftlaData(1) &&Revise: it was used to redisplay the lines of Address
    LOFORMSET.LCSCUPSTAT='DISABLE'
    LOFORMSET.LCSCDNSTAT='ENABLE'
    *Old: SHOW GET ibShiftUp DISABLE &&Revise
    *Old: SHOW GET ibShiftDn ENABLE &&Revise

    *IF loFormSet.llInquiry .OR. apinvhdr.cvenpmeth = 'C'   &&BOHO

    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *IF loFormSet.llInquiry .OR. loFormSet.AriaForm1.cboVendPmeth.Value = 'C'   &&Revise
    IF LOFORMSET.LLINQUIRY .OR. LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.CBOVENDPMETH.VALUE = 'C'   &&Revise
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      *Old: SHOW GET pbEdt DISABLE
      LOFORMSET.LLEDITBUTTON = .F.
    ELSE
      *Old: SHOW GET pbEdt ENABLE
      LOFORMSET.LLEDITBUTTON = .T.
    ENDIF
    LOFORMSET.LCTERMSDISP= 'DISABLE'
    IF !LOFORMSET.LLINQUIRY
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      *IF SEEK(apinvhdr.cfisfyear,'FISHD')
      IF GFSEEK(APINVHDR.CFISFYEAR,'FISHD')
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
        IF FISHD.CFISYSTAT <> 'H' .AND. APINVHDR.CVENPMETH <> 'C' .AND. APINVHDR.CINVSTAT <> 'A'
          *Old: SHOW GET pbDlt ENABLE
          LOFORMSET.LLDELETEBUTTON = .T.
        ELSE
          *Old: SHOW GET pbEdt DISABLE
          LOFORMSET.LLEDITBUTTON = .F.
          *Old: SHOW GET pbDlt DISABLE
          LOFORMSET.LLDELETEBUTTON = .F.
        ENDIF
      ELSE
        *Old: SHOW GET pbEdt DISABLE
        LOFORMSET.LLEDITBUTTON = .F.
        *Old: SHOW GET pbDlt ENABLE
        LOFORMSET.LLDELETEBUTTON = .T.
      ENDIF
    ENDIF
    LOFORMSET.LCDATA23ST = 'DISABLE'
  ENDIF


  IF APINVHDR.CINVSTAT = 'A'
    LOFORMSET.LCAPRSTAT  = 'DISABLE'
    LOFORMSET.LCDISTSTAT = 'DISABLE'
    *Old: SHOW GET pbApprove &loFormSet.lcAprStat
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *loFormSet.AriaForm1.cmdApprove.Enabled=(loFormSet.lcAprStat='ENABLE')
    *loFormSet.AriaForm1.cmdDisLine.Enabled=(loFormSet.lcDistStat='ENABLE')
    *loFormSet.AriaForm1.cmdApprove.Enabled=(loFormSet.lcAprStat='ENABLE')
    *Old: SHOW GET pbDisLine &loFormSet.lcDistStat
    LOFORMSET.ARIAFORM1.PGFPAYINV.PGDIST.ENABLED=(LOFORMSET.LCDISTSTAT='ENABLE')
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

  ELSE
    LOFORMSET.LCAPRSTAT  = 'ENABLE'
    LOFORMSET.LCDISTSTAT = 'ENABLE'
    *Old: SHOW GET pbApprove &loFormSet.lcAprStat

    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *!*	      loFormSet.AriaForm1.cmdApprove.Enabled=(loFormSet.lcAprStat='ENABLE')
    *!*	      *Old: SHOW GET pbDisLine &loFormSet.lcDistStat
    *!*	      loFormSet.AriaForm1.cmdDisLine.Enabled=(loFormSet.lcDistStat='ENABLE')
    *loFormSet.AriaForm1.cmdApprove.Enabled=(loFormSet.lcAprStat='ENABLE')
    *Old: SHOW GET pbDisLine &loFormSet.lcDistStat
    LOFORMSET.ARIAFORM1.PGFPAYINV.PGDIST.ENABLED=(LOFORMSET.LCDISTSTAT='ENABLE')
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

  ENDIF

  LCOBJSHOW = IIF(LOFORMSET.ACTIVEMODE="V" .OR. LOFORMSET.LLLOKPER , 'DISABLE' , 'ENABLE')

  *Old: SHOW GET lcApdGlAct &lcObjShow
  *Old: SHOW GET ibApGlAcc  &lcObjShow

  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	    loFormSet.DistLines.glActCode.Enabled=(lcObjShow='ENABLE')
  *!*	    *Old: SHOW GET loFormSet.lnApdAmnt  &lcObjShow
  *!*	    loFormSet.DistLines.txtlnApdAmnt.Enabled=(lcObjShow='ENABLE')
  LOFORMSET.ARIAFORM1.PGFPAYINV.PGDIST.GLACTCODE.ENABLED=(LCOBJSHOW='ENABLE')
  *Old: SHOW GET loFormSet.lnApdAmnt  &lcObjShow
  LOFORMSET.ARIAFORM1.PGFPAYINV.PGDIST.TXTLNAPDAMNT.ENABLED=(LCOBJSHOW='ENABLE')
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  *loFormSet.lnTotAppPay = apinvhdr.ninvamtap + apinvhdr.ninvdisap + apinvhdr.ninvadjap  &&BOHO
  LOFORMSET.LNTOTAPPPAY = APINVHDR.NINVAMTAP + ;
    APINVHDR.NINVDISAP + ;
    APINVHDR.NINVADJAP

  *IF loFormSet.AriaForm1.cboVendPmeth.Value <> 'C'
  IF APINVHDR.CVENPMETH <> 'C' ;
      AND ((LOFORMSET.ACTIVEMODE="V" AND LOFORMSET.LNTOTAPPPAY = 0) ;
      OR (APINVHDR.NINVAMNT-APINVHDR.NINVPAID-APINVHDR.NINVDISTK = 0))
    *OR (apinvhdr.ninvamnt-apinvhdr.ninvamtap-apinvhdr.ninvdisap = 0))
    *OR (loFormSet.AriaForm1.txtInvAmount.Value-apinvhdr.ninvamtap-apinvhdr.ninvdisap = 0))
    LOFORMSET.LCAPRSTAT = 'DISABLE'
    *Old: SHOW GET pbApprove &loFormSet.lcAprStat
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *loFormSet.AriaForm1.cmdApprove.Enabled=(loFormSet.lcAprStat='ENABLE')
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  ELSE
    IF APINVHDR.CINVSTAT = 'A'
      LOFORMSET.LCAPRSTAT = 'DISABLE'
      *Old: SHOW GET pbApprove &loFormSet.lcAprStat
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *loFormSet.AriaForm1.cmdApprove.Enabled=(loFormSet.lcAprStat='ENABLE')
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    ELSE
      LOFORMSET.LCAPRSTAT = 'ENABLE'
      *Old: SHOW GET pbApprove &loFormSet.lcAprStat
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *loFormSet.AriaForm1.cmdApprove.Enabled=(loFormSet.lcAprStat='ENABLE')
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    ENDIF
  ENDIF


  *MESSAGEBOX('Fields: '+PADR(apinvhdr.ninvamtap + apinvhdr.ninvdisap + apinvhdr.ninvadjap,10)+;
  CHR(13)+'Controls: '+;
  PADR(apinvhdr.ninvamtap + ;
  apinvhdr.ninvdisap + ;
  apinvhdr.ninvadjap,10))


  LOFORMSET.LCPHONE     = APVENDOR.CPHONENO
  LOFORMSET.LCCOMPANY   = APVENDOR.CVENCOMP
  *loFormSet.lnDistAmnt  = apinvhdr.ninvamnt  &&BOHO

  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *loFormSet.lnDistAmnt  = loFormSet.AriaForm1.txtInvAmount.Value
  LOFORMSET.LNDISTAMNT  = LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTINVAMOUNT.VALUE
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

  *15Q: is this code necessary ?
  *lnElemNum   = lfGetArrElem(apinvhdr.cinvremit, 'loFormSet.laRemitTo')  &&BOHO

  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	    DIMENSION laAry[ALEN(loFormSet.laRemitTo,1),2]
  *!*	    =ACOPY(loFormSet.laRemitTo,laAry)
  *!*	    lnElemNum   = lfGetArrElem(loFormSet.AriaForm1.cboInvRemit.Value, @laAry)
  *!*	    DIMENSION loFormSet.laRemitTo[ALEN(laAry,1),2]
  *!*	    =ACOPY(laAry,loFormSet.laRemitTo)
  DIMENSION LAARRAY[ALEN(loFormSet.laRemitTo,1),2]
  =ACOPY(LOFORMSET.LAREMITTO,LAARRAY)
  LNELEMNUM   = LFGETARRELEM(LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.CBOINVREMIT.VALUE, @LAARRAY)
  DIMENSION LOFORMSET.LAREMITTO[ALEN(laArray,1),2]
  =ACOPY(LAARRAY,LOFORMSET.LAREMITTO)
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

  LOFORMSET.LCREMITTO   = IIF(LNELEMNUM > 0, LOFORMSET.LAREMITTO[lnElemNum, 1]," ")
  PUREMITTO   = LNELEMNUM

  DO CASE
    *CASE apinvhdr.cinvremit = 'F'  &&BOHO

    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *CASE loFormSet.AriaForm1.cboInvRemit.Value = 'F'
  CASE LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.CBOINVREMIT.VALUE = 'F'
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    LOFORMSET.LCFACTSTAT   = IIF(!LOFORMSET.ACTIVEMODE="V", 'ENABLE', 'DISABLE')
  OTHERWISE
    LOFORMSET.LCFACTSTAT   = 'DISABLE'
  ENDCASE
  *Old =lfShiftlaData(loFormSet.lnStartAdr) &&Revise: it was used to redisplay the lines of Address
  *Old: SHOW GET laData[6] &loFormSet.lcRemitStat
  *Old: SHOW GET loFormSet.laAddrs[1] &loFormSet.lcRemitStat
  *Old: SHOW GET loFormSet.laAddrs[2] &loFormSet.lcRemitStat
  *Old: SHOW GET loFormSet.laAddrs[3] &loFormSet.lcRemitStat

  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	    STORE (loFormSet.lcRemitStat='ENABLE') TO loFormSet.AriaForm1.txtOutComp.Enabled, ;
  *!*	           loFormSet.AriaForm1.txtOutAddr1.Enabled, loFormSet.AriaForm1.txtOutAddr2.Enabled, ;
  *!*	           loFormSet.AriaForm1.txtOutAddr3.Enabled
  STORE (LOFORMSET.LCREMITSTAT='ENABLE') TO LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTOUTCOMP.ENABLED, ;
    LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTOUTADDR1.ENABLED, LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTOUTADDR2.ENABLED, ;
    LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTOUTADDR3.ENABLED
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  *Old: SHOW GET apinvhdr.cfaccode &loFormSet.lcFactStat
  *Old: SHOW GET ibFactor   &loFormSet.lcFactStat

  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  * loFormSet.AriaForm1.kbFacCode.Enabled=(loFormSet.lcFactStat='ENABLE')
  LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBFACCODE.ENABLED=(LOFORMSET.LCFACTSTAT='ENABLE')
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

  IF LOFORMSET.ACTIVEMODE="E"
    IF EMPTY(APVENDOR.CVEN1099T)  && If the vendor 1099 amount is empty.
      LOFORMSET.LCDATA23ST = 'DISABLE'
    ELSE
      LOFORMSET.LCDATA23ST = 'ENABLE'
    ENDIF


    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *!*	      SELECT *,SPACE(60) AS 'CDISCRIP',;
    *!*	             'S' AS 'cStatus',;
    *!*	             SPACE(1) AS 'cUpdSerNo',;
    *!*	             RECNO() AS 'NRECNO';
    *!*	        FROM (oAriaApplication.DataDir+'APDIST') ;
    *!*	          WHERE CINVNO + CVENDCODE + cAPDTrTyp = ;
    *!*	                loFormSet.AriaForm1.kbInvNo.keyTextBox.Value + loFormSet.AriaForm1.kbVendCode.keyTextBox.Value + "I" ;
    *!*	                AND CAPDSTAT <> 'V';
    *!*	          INTO DBF (oAriaApplication.WorkDir+loFormSet.lcTmpDist)
    *!B609918,1 MMT 05/16/2012 Payable invoice screen updates APDIST incorrectly[Start]
    *=GFSQLRUN("Select * From APDIST Where CINVNO='"+;
    LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE+"' AND CVENDCODE = '"+;
    LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE+"' AND cAPDTrTyp = 'I' AND CAPDSTAT <> 'V'",'APDIST' ,.F.,'APDIST_TMP')
    *SELECT *,SPACE(60) AS 'CDISCRIP',;
    'S' AS 'cStatus',;
    SPACE(1) AS 'cUpdSerNo',;
    RECNO() AS 'NRECNO';
    FROM APDIST_TMP ;
    WHERE CINVNO + CVENDCODE + CAPDTRTYP = ;
    LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE + LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE + "I" ;
    AND CAPDSTAT <> 'V';
    INTO DBF (OARIAAPPLICATION.WORKDIR+LOFORMSET.LCTMPDIST)
    =gfSeek(PADR(loFormSet.AriaForm1.kbInvNo.keyTextBox.VALUE,12)+PADR(loFormSet.AriaForm1.kbVendCode.keyTextBox.VALUE,8),'APDIST','INVVEND')
    SELECT *,SPACE(60) AS 'CDISCRIP',;
      'S' AS 'cStatus',;
      SPACE(1) AS 'cUpdSerNo',;
      RECNO() AS 'NRECNO';
      FROM APDIST;
      WHERE CINVNO + CVENDCODE + cAPDTrTyp = ;
      PADR(loFormSet.AriaForm1.kbInvNo.keyTextBox.VALUE,12)+PADR(loFormSet.AriaForm1.kbVendCode.keyTextBox.VALUE,8)+ "I" ;
      AND CAPDSTAT <> 'V';
      INTO DBF (oAriaApplication.WorkDir+loFormSet.lcTmpDist)
    *!B609918,1 MMT 05/16/2012 Payable invoice screen updates APDIST incorrectly[END]
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]



    INDEX ON CVENDCODE+CINVNO+STR(NAPDLINNO,4) TAG (LOFORMSET.LCTMPDIST)

    SELECT(LOFORMSET.LCTMPDIST)

    LOFORMSET.LNLINENO = RECCOUNT() - 1

    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *loFormSet.DistLines.txtLineNo.Value = RECCOUNT() - 1
    LOFORMSET.ARIAFORM1.PGFPAYINV.PGDIST.TXTLINENO.VALUE = RECCOUNT() - 1
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

    *Old: RELEASE WINDOW (loFormSet.lcBrowsTtl)
    =LFBROWSE(LOFORMSET)
    =LFDISPOBJCT(LOFORMSET)
    *Old: =lfRefresh()

    LOFORMSET.LCTMPLATE = 'DISABLE'
    *Old: SHOW GET apinvhdr.cautmcode DISABLE
    *Old: SHOW GET ibTemplate DISABLE

    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *loFormSet.AriaForm1.kbAutmCode.Enabled=.F.
    LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBAUTMCODE.ENABLED=.F.
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

    *Old: SHOW GET pbDlt DISABLE
    LOFORMSET.LLDELETEBUTTON = .F.
  ELSE
    LOFORMSET.LCREMITSTAT = 'DISABLE'
    *Old: RELEASE WINDOW (loFormSet.lcBrowsTtl)
    SELECT APINVHDR
    IF !EOF()
      GO RECNO()
    ENDIF
    =LFBROWSE(LOFORMSET)
    =LFDISPOBJCT(LOFORMSET)
    *Old: =lfRefresh()
  ENDIF

  *IF apinvhdr.cvenpmeth = 'C'  &&BOHO

  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *IF loFormSet.AriaForm1.cboVendPmeth.Value = 'C'
  IF LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.CBOVENDPMETH.VALUE = 'C'
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    *Old: SHOW GET pbOk       DISABLE &&Revise
    *Old: SHOW GET pbDiscount DISABLE

    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *loFormSet.AriaForm1.cmdDiscount.Enabled=.F.
    LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.CMDDISCOUNT.ENABLED=.F.
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

    *Old: SHOW GET apinvhdr.ninvdisof DISABLE

    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *loFormSet.AriaForm1.txtInvDisof.Enabled=.F.
    LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTINVDISOF.ENABLED=.F.
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

  ELSE
    *Old: IF !EMPTY(apinvhdr.cvenccven) .AND. WVISIBLE('CWRAPDISTR')
    *Old: =gfChClose('CWRAPDISTR')
    *Old: ENDIF
    *Old: SHOW GET pbOk ENABLE &&Revise
  ENDIF

  IF !EMPTY(APVENDOR.CAPACCT)
    LOFORMSET.LCACCOUNT = APVENDOR.CAPACCT
  ELSE
    IF !EMPTY(APDIV.CAPACCT)
      LOFORMSET.LCACCOUNT = APDIV.CAPACCT
    ELSE
      LOFORMSET.LCACCOUNT = APSETUP.CAPACCT
    ENDIF
  ENDIF

  *Old: loFormSet.lcPayMethd = IIF(!INLIST(apinvhdr.cvenpmeth,'PMNCH'),'',loFormSet.laPayMethd[AT(apinvhdr.cvenpmeth,'PMNCH'),1])  &&Revise
  *puMethod   = AT(apinvhdr.cvenpmeth,'PMNCH')   &&BOHO

  LOFORMSET.LCCODEFILT = ''

  *16Q: is this code necessary ? [Start]
  *loFormSet.lcDivision = gfCodDes(apinvhdr.cdivision , 'CDIVISION')  &&BOHO
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *loFormSet.lcDivision = gfCodDes(loFormSet.AriaForm1.cboDivision.Value , 'CDIVISION')
  LOFORMSET.LCDIVISION = GFCODDES(LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.CBODIVISION.VALUE , 'CDIVISION')
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  
  LOFORMSET.LCPUDIV    = LOFORMSET.LCDIVISION


  *loFormSet.lcTermCode = gfCodDes(apinvhdr.ctermcode , 'CTERMCODE')  &&BOHO
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *    loFormSet.lcTermCode = gfCodDes(loFormSet.AriaForm1.cboTermCode.Value , 'CTERMCODE')
  LOFORMSET.LCTERMCODE = GFCODDES(LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.CBOTERMCODE.VALUE , 'CTERMCODE')
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

  LOFORMSET.LCPUTERM   = LOFORMSET.LCTERMCODE

  *17Q: is this code necessary ?

  IF EMPTY(LOFORMSET.LCTERMCODE) OR EMPTY(APINVHDR.CTERMCODE)  && If empty of the Terms popup or not applicable
    IF LOFORMSET.ACTIVEMODE="E"
      LOFORMSET.LCTERMSDISP= 'ENABLE'
    ELSE
      LOFORMSET.LCTERMSDISP= 'DISABLE'
    ENDIF
  ELSE
    LOFORMSET.LCTERMSDISP= 'DISABLE'

    IF LOFORMSET.ACTIVEMODE="A" &&18Q: How come he is checking for "A" while the case condition is "V" or "E"

      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *!*	        DIMENSION laAry[ALEN(loFormSet.laTermAry,1),ALEN(loFormSet.laTermAry,2)]
      *!*	        =ACOPY(loFormSet.laTermAry,laAry)
      *!*	        *=gfRltFld(apinvhdr.ctermcode , @loFormSet.laTermAry , 'CTERMCODE')  &&BOHO
      *!*	        =gfRltFld(loFormSet.AriaForm1.cboTermCode.Value , @laAry , 'CTERMCODE')
      *!*	        DIMENSION loFormSet.laTermAry[ALEN(laAry,1),ALEN(laAry,2)]
      *!*	        =ACOPY(laAry,loFormSet.laTermAry)
      *=gfRltFld(loFormSet.AriaForm1.cboTermCode.Value , @laArray, 'CTERMCODE')
      DIMENSION LAARRAY[ALEN(loFormSet.laTermAry,1),ALEN(loFormSet.laTermAry,2)]
      =ACOPY(LOFORMSET.LATERMARY,LAARRAY)
      =GFRLTFLD(LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.CBOTERMCODE.VALUE , @LAARRAY, 'CTERMCODE')
      DIMENSION LOFORMSET.LATERMARY[ALEN(laArray,1),ALEN(laArray,2)]
      =ACOPY(LAARRAY,LOFORMSET.LATERMARY)
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    ENDIF

  ENDIF

  *Old: SHOW GET apinvhdr.nterdued &loFormSet.lcTermsDisp
  *Old: SHOW GET apinvhdr.nterdiscd &loFormSet.lcTermsDisp
  *Old: SHOW GET apinvhdr.nterdiscr &loFormSet.lcTermsDisp

  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	    STORE (loFormSet.lcTermsDisp='ENABLE') TO loFormSet.AriaForm1.txtterdued.Enabled, ;
  *!*	          loFormSet.AriaForm1.txtTerDiscd.Enabled, loFormSet.AriaForm1.txtTerDiscr.Enabled
  STORE (LOFORMSET.LCTERMSDISP='ENABLE') TO LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTTERDUED.ENABLED, ;
    LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTTERDISCD.ENABLED, LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTTERDISCR.ENABLED
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

  IF LOFORMSET.ACTIVEMODE="E"
    *loFormSet.lnOldInvAmt = apinvhdr.ninvamnt && Variable to hold the old invoice amount.    &&BOHO

    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *loFormSet.lnOldInvAmt = loFormSet.AriaForm1.txtInvAmount.Value && Variable to hold the old invoice amount.
    LOFORMSET.LNOLDINVAMT = LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTINVAMOUNT.VALUE && Variable to hold the old invoice amount.
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

  ENDIF

  IF LOFORMSET.ACTIVEMODE="E" .AND. LOFORMSET.LNOLDDISCOF = 0
    *loFormSet.lnOldDiscOf= apinvhdr.ninvdisof  && Variable to hold the old discount offerd amount  &&BOHO

    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *      loFormSet.lnOldDiscOf= loFormSet.AriaForm1.txtInvDisof.Value  && Variable to hold the old discount offerd amount
    LOFORMSET.LNOLDDISCOF= LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTINVDISOF.VALUE  && Variable to hold the old discount offerd amount
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

  ENDIF

  IF LOFORMSET.ACTIVEMODE="E" .AND. EMPTY(LOFORMSET.LCOLDYEAR)
    LOFORMSET.LCOLDYEAR  = APINVHDR.CFISFYEAR  && Variable to hold the old fiscal year of the Inv. date
  ENDIF

  IF LOFORMSET.ACTIVEMODE="E" .AND. EMPTY(LOFORMSET.LCOLDPERIOD)
    LOFORMSET.LCOLDPERIOD= APINVHDR.CFSPPRDID  && Variable to hold the old fiscal period of the Inv. date
  ENDIF

  IF LOFORMSET.ACTIVEMODE="E" .AND. LOFORMSET.LDOLDDATINV = {}
    *IF TYPE('APINVHDR.DPOSTDATE') = 'D'  &&BOHO
    IF TYPE('loFormSet.AriaForm1.DtPostDate.Value') = 'D'
      *loFormSet.ldOldDatInv= apinvhdr.dpostdate  && Variable to hold the old posting invoice date.  &&BOHO
      LOFORMSET.LDOLDDATINV= LOFORMSET.ARIAFORM1.DTPOSTDATE.VALUE  && Variable to hold the old posting invoice date.
    ELSE
      *loFormSet.ldOldDatInv= apinvhdr.dinvdate  && Variable to hold the old invoice date  &&BOHO

      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *loFormSet.ldOldDatInv= loFormSet.AriaForm1.DtInvDate.Value  && Variable to hold the old invoice date
      LOFORMSET.LDOLDDATINV= LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.DTINVDATE.VALUE  && Variable to hold the old invoice date
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

    ENDIF
  ENDIF

  IF LOFORMSET.ACTIVEMODE="E" .AND. (APINVHDR.NINVAMTAP+APINVHDR.NINVDISAP+APINVHDR.NINVADJ) > 0
    IF TYPE('APINVHDR.DPOSTDATE') = 'D'

      *=lfVlDate(gcPrnt_Cmp , @loFormSet.lcDistPrd , @loFormSet.lcDistYer , apinvhdr.dpostdate)  &&BOHO
      *=lfVlDate(oAriaApplication.PrntCompanyID , @loFormSet.lcDistPrd , @loFormSet.lcDistYer , loFormSet.AriaForm1.DtPostDate.Text1.Value)
      LCDISTPRD = LOFORMSET.LCDISTPRD
      LCDISTYER = LOFORMSET.LCDISTYER
      LLLOKPER = LOFORMSET.LLLOKPER
      =LFVLDATE(OARIAAPPLICATION.PRNTCOMPANYID , @LCDISTPRD , @LCDISTYER , LOFORMSET.ARIAFORM1.DTPOSTDATE.TEXT1.VALUE , @LLLOKPER)
      LOFORMSET.LCDISTPRD = LCDISTPRD
      LOFORMSET.LCDISTYER = LCDISTYER
      LOFORMSET.LLLOKPER = LLLOKPER
      *Old: SHOW GET apinvhdr.dinvdate DISABLE

      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *loFormSet.AriaForm1.DtInvDate.Enabled=.F.
      LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.DTINVDATE.ENABLED=.F.
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

      *Old: SHOW GET apinvhdr.dpostdate DISABLE
      LOFORMSET.ARIAFORM1.DTPOSTDATE.ENABLED=.F.
    ELSE
      *Old: SHOW GET apinvhdr.dinvdate DISABLE

      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *loFormSet.AriaForm1.DtInvDate.Enabled=.F.
      LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.DTINVDATE.ENABLED=.F.
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

    ENDIF

    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *loFormSet.AriaForm1.txtInvAmount.SetFocus()
    LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTINVAMOUNT.SETFOCUS()
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  ENDIF

  IF EMPTY(APINVHDR.CCHKGLACC)
    *apinvhdr.cchkglacc = loFormSet.lcEmptyAcc  &&BOHO

    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *REPLACE apinvhdr.cchkglacc WITH loFormSet.AriaForm1.ap1.lcemptyacc IN apinvhdr
    SELECT APINVHDR
    GFREPLACE("cchkglacc WITH '"+LOFORMSET.ARIAFORM1.AP1.LCEMPTYACC+"'")
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  ENDIF

  IF EMPTY(APINVHDR.CAPACCT)
    *apinvhdr.capacct = loFormSet.lcEmptyAcc  &&BOHO

    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *loFormSet.DistLines.glAPActCode.KeyTextBox.Value = loFormSet.AriaForm1.ap1.lcemptyacc
    LOFORMSET.ARIAFORM1.PGFPAYINV.PGDIST.GLAPACTCODE.KEYTEXTBOX.VALUE = LOFORMSET.ARIAFORM1.AP1.LCEMPTYACC
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  ENDIF

  IF LOFORMSET.ACTIVEMODE="E"
    IF APINVHDR.CVENPMETH <> 'C' .AND. !EMPTY(APINVHDR.CVENCCVEN)
      LOFORMSET.LLPAIDBYCRD = IIF(LOFORMSET.LLPAIDBYCRD,LOFORMSET.LLPAIDBYCRD,.T.)
    ENDIF
  ELSE
    LOFORMSET.LLPAIDBYCRD = .F.
  ENDIF
  *Old: SHOW GET apinvhdr.ccurrcode DISABLE
  *Old: SHOW GET apinvhdr.nexrate DISABLE
  *Old: SHOW GEt ibCurrency DISABLE

  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *loFormSet.AriaForm1.kbCurrCode.Enabled=.F.
  *loFormSet.AriaForm1.txtNexRate.Enabled=.F.
  LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.ENABLED=.F.
  LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTNEXRATE.ENABLED=.F.
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]


  IF LOFORMSET.ACTIVEMODE="E"
    LOFORMSET.LCEXSIN2 = ''
    *loFormSet.lcExSin1 = gfGetExSin(@loFormSet.lcExSin2,apinvhdr.ccurrcode)  &&BOHO
    LCEXSIN2 = LOFORMSET.LCEXSIN2

    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *loFormSet.lcExSin1 = gfGetExSin(@lcExSin2,loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value)
    LOFORMSET.LCEXSIN1 = GFGETEXSIN(@LCEXSIN2,LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.KEYTEXTBOX.VALUE)
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

    LOFORMSET.LCEXSIN2 = LCEXSIN2

    *19Q: Should we change all the Into DBF commands to Into Cursor ?
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *E302678,3 TMI 07/26/2011 [Start] in case on FOX case, do not reopen the tables using sqlrun
    IF !LFISNATIVE('APINVTKT')
      *E302678,3 TMI 07/26/2011 [End  ]
      =GFSQLRUN("Select * from ApInvTkt Where cvendcode='"+;
        PADR(LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE,8)+;
        "' AND capinvno='"+PADR(LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE,12)+"'",'ApInvTkt' ,.F.,'ApInvTkt')
      *E302678,3 TMI 07/26/2011 [Start]
    ENDIF
    IF !LFISNATIVE('APVINVDT')
      *E302678,3 TMI 07/26/2011 [End  ]
      =GFSQLRUN("Select * from ApVInvDt Where cvendcode='"+;
        PADR(LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE,8)+;
        "' AND capinvno='"+PADR(LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE,12)+"'",'ApVInvDt')
      *E302678,3 TMI 07/26/2011 [Start]
    ENDIF
    *E302678,3 TMI 07/26/2011 [End  ]
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

    SELECT *, 'S' AS CSTATUS,RECNO() AS NRECNO FROM APVINVDT WHERE ;
      CVENDCODE+CAPINVNO+CAPVILNO = PADR(LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE,8)+PADR(LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE,12) ;
      INTO DBF (OARIAAPPLICATION.WORKDIR+LOFORMSET.LCAPVINVDT)
    INDEX ON CIMTYP+CTKTNO+CLOTNO+CBOMTYPE+COPRCODE+ITEM+COLOR+CDYELOT TAG ITEM
    INDEX ON CVENDCODE+CAPINVNO+CAPVILNO TAG (LOFORMSET.LCAPVINVDT) ADDITIVE
    INDEX ON CAPDGLACT TAG ADJUST ADDITIVE

    SELECT *, 'S' AS CSTATUS,RECNO() AS NRECNO FROM APINVTKT WHERE ;
      CVENDCODE+CAPINVNO+CAPVILNO = PADR(LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE,8)+PADR(LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE,12) ;
      INTO DBF (OARIAAPPLICATION.WORKDIR+LOFORMSET.LCAPINVTKT)
    INDEX ON CIMTYP+CTKTNO+STR(LINENO,6)+CRSESSION TAG TICKET
    INDEX ON CVENDCODE+CAPINVNO+CAPVILNO+CRSESSION TAG (LOFORMSET.LCAPINVTKT) ADDITIVE

    SELECT (LOFORMSET.LCAPINVTKT)
    REPLACE ALL NAPAPLAMNT WITH NAPAPLAMNT * -1,;
      NAPAPLPRIC WITH NAPAPLPRIC * -1 FOR (CIMTYP $ 'RF' AND (NAPAPLAMNT > 0 ))

    SELECT (LOFORMSET.LCAPVINVDT)
    REPLACE ALL NAPAPRAMNT WITH NAPAPRAMNT * -1,;
      NAPAPRPRIC WITH NAPAPRPRIC * -1,;
      NAPPRICE   WITH NAPPRICE   * -1,;
      NAPAMNT    WITH NAPAMNT    * -1 FOR (CIMTYP $ 'RF' AND (NAPAPRAMNT > 0 ))
  ENDIF


CASE LOFORMSET.ACTIVEMODE="A"
  *Old: IF ASCAN(laEvntTrig , PADR('APINVTYPE',10)) <> 0
  *Old: =lfvUsrFld()
  *Old: ENDIF
  SELECT (LOFORMSET.LCAPVINVDT)
  ZAP
  SELECT (LOFORMSET.LCAPINVTKT)
  ZAP

  LOFORMSET.LLSAMVENDOR = .T.
  LOFORMSET.LLPAIDBYCRD = .F.

  *apinvhdr.dinvdate  = oAriaApplication.SystemDate  &&BOHO

  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *loFormSet.AriaForm1.DtInvDate.Value  = oAriaApplication.SystemDate
  LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.DTINVDATE.VALUE  = OARIAAPPLICATION.SYSTEMDATE
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

  *IF TYPE('APINVHDR.DPOSTDATE') = 'D'  &&BOHO
  IF TYPE('loFormSet.AriaForm1.DtPostDate.Value') = 'D'
    *apinvhdr.dpostdate  = oAriaApplication.SystemDate  &&BOHO
    LOFORMSET.ARIAFORM1.DTPOSTDATE.VALUE  = OARIAAPPLICATION.SYSTEMDATE
  ENDIF

  IF EMPTY(APVENDOR.CVEN1099T) && If empty Vendor 1099 amount type
    LOFORMSET.LCDATA23ST = 'DISABLE'
  ELSE
    LOFORMSET.LCDATA23ST = 'ENABLE'
  ENDIF

  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *loFormSet.AriaForm1.cboInvRemit.Value = loFormSet.laRemitTo[1,2] && default remit to vendor
  LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.CBOINVREMIT.VALUE = LOFORMSET.LAREMITTO[1,2] && default remit to vendor
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

  LOFORMSET.LCREMITTO   = LOFORMSET.LAREMITTO[1,1]
  PUREMITTO   = 1
  *19Q: What does this do ?
  =LFVREMIT(LOFORMSET, .T.)

  *Old: SHOW GET apinvhdr.coutcomp  DISABLE
  *Old: SHOW GET apinvhdr.coutaddr1  DISABLE
  *Old: SHOW GET apinvhdr.coutaddr2  DISABLE
  *Old: SHOW GET apinvhdr.coutaddr3  DISABLE

  *Old: SHOW GET apinvhdr.coutaddr1  DISABLE
  *Old: SHOW GET apinvhdr.coutaddr2  DISABLE
  *Old: SHOW GET apinvhdr.coutaddr3  DISABLE
  *Old: SHOW GET apinvhdr.coutaddr4  DISABLE
  *Old: SHOW GET apinvhdr.coutaddr5  DISABLE

  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	    STORE .F. TO loFormSet.AriaForm1.txtOutComp.Enabled, ;
  *!*	           loFormSet.AriaForm1.txtOutAddr1.Enabled, loFormSet.AriaForm1.txtOutAddr2.Enabled, ;
  *!*	           loFormSet.AriaForm1.txtOutAddr3.Enabled
  STORE .F. TO LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTOUTCOMP.ENABLED, ;
    LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTOUTADDR1.ENABLED, LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTOUTADDR2.ENABLED, ;
    LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTOUTADDR3.ENABLED
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

  *Old: SHOW GET apinvhdr.cbnkcode ENABLE
  *Old: SHOW GET apinvhdr.cchkacct ENABLE
  *STORE .F. TO loFormSet.APAprov.KBBnkCode.Enabled, loFormSet.APAprov.kbChkAcct.Enabled

  *apinvhdr.cvenpmeth = APVENDOR.CVENPMETH   && Assign the payment meth from vendor  &&BOHO

  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *loFormSet.AriaForm1.cboVendPmeth.Value = APVENDOR.CVENPMETH   && Assign the payment meth from vendor
  LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.CBOVENDPMETH.VALUE = APVENDOR.CVENPMETH   && Assign the payment meth from vendor
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

  *apinvhdr.cdivision = APVENDOR.CDIVISION   && Assign the division from vendor  &&BOHO
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *loFormSet.AriaForm1.cboDivision.Value = APVENDOR.CDIVISION   && Assign the division from vendor
  LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.CBODIVISION.VALUE = APVENDOR.CDIVISION   && Assign the division from vendor
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  *apinvhdr.ctermcode = APVENDOR.CTERMCODE   && Assign the terms from vendor  &&BOHO

  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *loFormSet.AriaForm1.cboTermCode.Value = APVENDOR.CTERMCODE   && Assign the terms from vendor
  LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.CBOTERMCODE.VALUE = APVENDOR.CTERMCODE   && Assign the terms from vendor
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

  *apinvhdr.cvenprior = APVENDOR.CVENPRIOR  &&BOHO

  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *loFormSet.AriaForm1.txtVendPrior.Value = APVENDOR.CVENPRIOR
  LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTVENDPRIOR.VALUE = APVENDOR.CVENPRIOR
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

  *Old: loFormSet.lcPayMethd = loFormSet.laPayMethd[AT(apinvhdr.cvenpmeth,'PMNCH'),1]
  *puMethod   = AT(apinvhdr.cvenpmeth,'PMNCH') &&loFormSet.laPayMethd[AT(laData[3],'PMNCH'),1]

  *IF apinvhdr.cvenpmeth = 'C'  &&BOHO

  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *IF loFormSet.AriaForm1.cboVendPmeth.Value = 'C'
  IF LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.CBOVENDPMETH.VALUE = 'C'
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    *Old: SHOW GET pbApprove,1 PROMPT 'Credit c\<ard payment...'
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *loFormSet.AriaForm1.cmdApprove.Caption='Credit c\<ard payment...'
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    *Old: SHOW GET pbOk       DISABLE &&Revise
    *Old: SHOW GET pbDiscount DISABLE
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *loFormSet.AriaForm1.cmdDiscount.Enabled=.F.
    LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.CMDDISCOUNT.ENABLED=.F.
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    *Old: SHOW GET apinvhdr.ninvdisof DISABLE
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *loFormSet.AriaForm1.txtInvDisof.Enabled=.F.
    LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTINVDISOF.ENABLED=.F.
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  ELSE
    *Old: SHOW GET pbApprove,1 PROMPT '\<Approve for payment...'
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *loFormSet.AriaForm1.cmdApprove.Caption='\<Approve for payment...'
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    *Old: IF !EMPTY(apinvhdr.cvenccven) .AND. WVISIBLE('CWRAPDISTR')
    *Old: = gfChClose('CWRAPDISTR')
    *Old: ENDIF
  ENDIF

  IF EMPTY(LOFORMSET.LCPHONE)
    LOFORMSET.LCPHONE   = APVENDOR.CPHONENO
  ENDIF

  IF EMPTY(LOFORMSET.LCCOMPANY)
    LOFORMSET.LCCOMPANY = APVENDOR.CVENCOMP
  ENDIF

  LOFORMSET.LCCODEFILT = ''

  *loFormSet.lcDivision = gfCodDes(apinvhdr.cdivision , 'CDIVISION')  &&BOHO
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *loFormSet.lcDivision = gfCodDes(loFormSet.AriaForm1.cboDivision.Value , 'CDIVISION')
  LOFORMSET.LCDIVISION = GFCODDES(LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.CBODIVISION.VALUE , 'CDIVISION')
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

  LOFORMSET.LCPUDIV    = LOFORMSET.LCDIVISION


  *loFormSet.lcTermCode = gfCodDes(apinvhdr.ctermcode , 'CTERMCODE')  &&BOHO
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *loFormSet.lcTermCode = gfCodDes(loFormSet.AriaForm1.cboTermCode.Value , 'CTERMCODE')
  LOFORMSET.LCTERMCODE = GFCODDES(LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.CBOTERMCODE.VALUE , 'CTERMCODE')
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  LOFORMSET.LCPUTERM   = LOFORMSET.LCTERMCODE


  IF LOFORMSET.ACTIVEMODE="A"
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *!*	        DIMENSION laAry[ALEN(loFormSet.laTermAry,1),ALEN(loFormSet.laTermAry,2)]
    *!*	        =ACOPY(loFormSet.laTermAry,laAry)
    *!*	        *=gfRltFld(apinvhdr.ctermcode , @loFormSet.laTermAry , 'CTERMCODE')  &&BOHO
    *!*	        =gfRltFld(loFormSet.AriaForm1.cboTermCode.Value , @laAry , 'CTERMCODE')
    *!*	        DIMENSION loFormSet.laTermAry[ALEN(laAry,1),ALEN(laAry,2)]
    *!*	        =ACOPY(laAry,loFormSet.laTermAry)
    *=gfRltFld(loFormSet.AriaForm1.cboTermCode.Value , @laArray, 'CTERMCODE')
    DIMENSION LAARRAY[ALEN(loFormSet.laTermAry,1),ALEN(loFormSet.laTermAry,2)]
    =ACOPY(LOFORMSET.LATERMARY,LAARRAY)
    =GFRLTFLD(LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.CBOTERMCODE.VALUE , @LAARRAY, 'CTERMCODE')
    DIMENSION LOFORMSET.LATERMARY[ALEN(laArray,1),ALEN(laArray,2)]
    =ACOPY(LAARRAY,LOFORMSET.LATERMARY)
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

    *ASM, Disable Payment Controls if the Choosen Terms not empty [Start]
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *loFormSet.lcTermsDisp = IIF(EMPTY(loFormSet.AriaForm1.cboTermCode.Value),'ENABLE','DISABLE')  &&lower
    *!*	                STORE (loFormSet.lcTermsDisp='ENABLE') TO loFormSet.AriaForm1.txtTerDiscr.Enabled, ;
    *!*	          loFormSet.AriaForm1.txtterdued.Enabled, loFormSet.AriaForm1.txtTerDiscd.Enabled
    LOFORMSET.LCTERMSDISP = IIF(EMPTY(LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.CBOTERMCODE.VALUE),'ENABLE','DISABLE')  &&lower
    STORE (LOFORMSET.LCTERMSDISP='ENABLE') TO LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTTERDISCR.ENABLED, ;
      LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTTERDUED.ENABLED, LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTTERDISCD.ENABLED
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    *ASM, Disable Payment Controls if the Choosen Terms not empty [End]
    *ASM, Assign the Tag property of the postdate, invoice date and invoice amount
    *To be able not to enter any other control until they are validated
    *STORE 'x' TO loFormSet.AriaForm1.dtPostDate.Tag, loFormSet.AriaForm1.dtInvDate.Tag, ;
    loFormSet.AriaForm1.txtInvAmount.Tag

  ENDIF

  
  IF EMPTY(LOFORMSET.LCTERMCODE) .OR. EMPTY(APINVHDR.CTERMCODE)  && If empty of the Terms popup or not applicable
    LOFORMSET.LCTERMSDISP= 'ENABLE'
  ELSE
    *IF TYPE('apinvhdr.nterdiscr') = 'N'  &&BOHO
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *!*	      IF TYPE('loFormSet.AriaForm1.txtTerDiscr.Value') = 'N'
    IF TYPE('loFormSet.AriaForm1.pgfpayInv.pgHead.txtTerDiscr.Value') = 'N'
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      LOFORMSET.LCTERMSDISP= 'DISABLE'
    ELSE

      *apinvhdr.nterdiscr = 0 && Discount %  &&BOHO
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *!*	        loFormSet.AriaForm1.txtTerDiscr.Value = 0 && Discount %
      *!*	        *apinvhdr.nterdued  = 0 && Due days  &&BOHO
      *!*	        loFormSet.AriaForm1.txtterdued.Value  = 0 && Due days
      *!*	        *apinvhdr.nterdiscd = 0 && Dis. Days  &&BOHO
      *!*	        loFormSet.AriaForm1.txtTerDiscd.Value = 0 && Dis. Days
      LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTTERDISCR.VALUE = 0 && Discount %
      *apinvhdr.nterdued  = 0 && Due days  &&BOHO
      LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTTERDUED.VALUE  = 0 && Due days
      *apinvhdr.nterdiscd = 0 && Dis. Days  &&BOHO
      LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTTERDISCD.VALUE = 0 && Dis. Days
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      LOFORMSET.LCTERMSDISP= 'ENABLE'
    ENDIF
  ENDIF
    
  *Old: SHOW GET apinvhdr.nterdiscr &loFormSet.lcTermsDisp
  *Old: SHOW GET apinvhdr.nterdued &loFormSet.lcTermsDisp
  *Old: SHOW GET apinvhdr.nterdiscd &loFormSet.lcTermsDisp
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	    STORE (loFormSet.lcTermsDisp='ENABLE') TO loFormSet.AriaForm1.txtterdued.Enabled, ;
  *!*	          loFormSet.AriaForm1.txtTerDiscd.Enabled, loFormSet.AriaForm1.txtTerDiscr.Enabled
  STORE (LOFORMSET.LCTERMSDISP='ENABLE') TO LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTTERDUED.ENABLED, ;
    LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTTERDISCD.ENABLED, LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTTERDISCR.ENABLED
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  *Old: SHOW GET loFormSet.lcPhone
  *loFormSet.AriaForm1.kbVendPhone.Refresh()
  *Old: SHOW GET loFormSet.lcCompany
  *loFormSet.AriaForm1.kbVendCompany.Refresh()
  *Old: SHOW GET puMethod
  *loFormSet.AriaForm1.cboVendPmeth.Refresh()
  *Old: SHOW GET loFormSet.lcPuDiv
  *loFormSet.AriaForm1.cboDivision.Refresh()
  *Old: SHOW GET loFormSet.lcPuTerm
  *loFormSet.AriaForm1.cboTermCode.Refresh()

  *IF apinvhdr.ninvamnt = 0  &&BOHO
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *IF loFormSet.AriaForm1.txtInvAmount.Value = 0
  IF LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTINVAMOUNT.VALUE = 0
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

    LOFORMSET.LCDISTSTAT = 'DISABLE'
    *Old: SHOW GET pbDisLine DISABLE

    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *loFormSet.AriaForm1.cmdDisLine.Enabled=.F.
    LOFORMSET.ARIAFORM1.PGFPAYINV.PGDIST.ENABLED=.F.
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

  ELSE
    LOFORMSET.LCDISTSTAT = 'ENABLE'
    *Old: SHOW GET pbDisLine ENABLE

    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *loFormSet.AriaForm1.cmdDisLine.Enabled = .T.
    LOFORMSET.ARIAFORM1.PGFPAYINV.PGDIST.ENABLED=.T.
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

  ENDIF
ENDCASE

IF LOFORMSET.ACTIVEMODE="E"
  *IF TYPE('APINVHDR.DPOSTDATE') = 'D'  &&BOHO
  IF TYPE('loFormSet.AriaForm1.DtPostDate.Value') = 'D'
    *Old: _CUROBJ = OBJNUM(apinvhdr.dpostdate)
    LOFORMSET.ARIAFORM1.DTPOSTDATE.SETFOCUS()
  ELSE
    *Old: _CUROBJ = OBJNUM(apinvhdr.dinvdate)

    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *loFormSet.AriaForm1.DtInvDate.SetFocus()
    LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.DTINVDATE.SETFOCUS()
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

  ENDIF
ENDIF

*IF apinvhdr.ninvamnt <= 0  && If the invoice amount = 0  &&BOHO
*WAIT WINDOW loFormSet.AriaForm1.txtInvAmount.ControlSource+'x'

*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*IF TYPE('loFormSet.AriaForm1.txtInvAmount.Value')='N' AND loFormSet.AriaForm1.txtInvAmount.Value <= 0
IF TYPE('loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.Value')='N' AND LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTINVAMOUNT.VALUE <= 0
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  *Old: SHOW GET pbDiscount DISABLE

  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *loFormSet.AriaForm1.cmdDiscount.Enabled=.F.
  LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.CMDDISCOUNT.ENABLED=.F.
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

  *Old: SHOW GET apinvhdr.ninvdisof DISABLE
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *loFormSet.AriaForm1.txtInvDisof.Enabled=.F.
  LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTINVDISOF.ENABLED=.F.
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
ENDIF

*Old:=lfRefresh()    && refresh says filed on the screen

LCCOLOR1  = SCHEME(1,6)
LCCOLOR2  = SCHEME(1,2)

*loFormSet.lcBFactCol= IIF(apinvhdr.cinvremit = 'F', loFormSet.lcSchm7Dis, loFormSet.lcHidObjNrm)  &&BOHO

*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*loFormSet.lcBFactCol= IIF(loFormSet.AriaForm1.cboInvRemit.Value = 'F', loFormSet.lcSchm7Dis, loFormSet.lcHidObjNrm)
LOFORMSET.LCBFACTCOL= IIF(LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.CBOINVREMIT.VALUE = 'F', LOFORMSET.LCSCHM7DIS, LOFORMSET.LCHIDOBJNRM)
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
*loFormSet.lcFactCol = IIF(apinvhdr.cinvremit = 'F', lcDisCont, loFormSet.lcHidObjNrm)  &&BOHO
*ASM, the next line gives an error because lcDisCont is not defined
*loFormSet.lcFactCol = IIF(loFormSet.AriaForm1.cboInvRemit.Value = 'F', lcDisCont, loFormSet.lcHidObjNrm)

*Old: SHOW GET ibDivision  COLOR ,,,,,&lcSelCont,,,&lcEnbCont,&lcDisCont
*Old: SHOW GET ibTermCode  COLOR ,,,,,&lcSelCont,,,&lcEnbCont,&lcDisCont
*Old: SHOW GET ibPayMethod COLOR ,,,,,&lcSelCont,,,&lcEnbCont,&lcDisCont

*Old: SHOW GET apinvhdr.cfaccode &loFormSet.lcFactStat
*Old: SHOW GET ibFactor   &loFormSet.lcFactStat
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*loFormSet.AriaForm1.kbFacCode.Enabled=(loFormSet.lcFactStat='ENABLE')
LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBFACCODE.ENABLED=(LOFORMSET.LCFACTSTAT='ENABLE')
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

SELECT APINVHDR


IF LOFORMSET.ACTIVEMODE="A" .AND. EMPTY(LOFORMSET.LCVENINVTYPES)

  LOFORMSET.LCTMPLATE = 'ENABLE'
  *Old: SHOW GET apinvhdr.cautmcode &loFormSet.lcTmplate
  *Old: SHOW GET ibTemplate &loFormSet.lcTmplate

  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *loFormSet.AriaForm1.kbAutmCode.Enabled=(loFormSet.lcTmplate='ENABLE')
  LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBAUTMCODE.ENABLED=(LOFORMSET.LCTMPLATE='ENABLE')
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
ENDIF

IF APINVHDR.CAUTMTYPE = 'R'
  *Old: loFormSet.lcLabel = 'Recurring:' &&Revise: will assign the label caption
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *loFormSet.AriaForm1.lblAutmType.Caption = 'Recurring'
  *N000682,1 MMT 11/20/2012 Globalization Changes[Start]
  *LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.LBLAUTMTYPE.CAPTION = 'Recurring'
  *N000682,1 11/20/2012 MMT Globlization changes[Start]
*LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.LBLAUTMTYPE.CAPTION =LANG_APPYINV_RECURRING
LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.LBLAUTMTYPE.CAPTION =IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_RECURRING,loFormSet.GetHeaderText("LANG_APPYINV_RECURRING",loFormSet.HeaderAlias))
*N000682,1 11/20/2012 MMT Globlization changes[End]

  *N000682,1 MMT 11/20/2012 Globalization Changes[End]

  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
ELSE
  *Old: loFormSet.lcLabel = 'Template :' &&Revise: will assign the label caption
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *N000682,1 MMT 11/20/2012 Globalization Changes[Start]
  *  LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.LBLAUTMTYPE.CAPTION = 'Template'
  *N000682,1 11/20/2012 MMT Globlization changes[Start]
*LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.LBLAUTMTYPE.CAPTION =LANG_APPYINV_TEMPLATE
LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.LBLAUTMTYPE.CAPTION =IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_TEMPLATE,loFormSet.GetHeaderText("LANG_APPYINV_TEMPLATE",loFormSet.HeaderAlias))
*N000682,1 11/20/2012 MMT Globlization changes[End]

  *N000682,1 MMT 11/20/2012 Globalization Changes[End]


  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[ENd]
ENDIF

IF LOFORMSET.ACTIVEMODE="S" .OR. LOFORMSET.ACTIVEMODE="V"
  LOFORMSET.LCTMPLATE = 'DISABLE'
  *Old: SHOW GET apinvhdr.cautmcode &loFormSet.lcTmplate &&Revise
  *Old: SHOW GET ibTemplate &loFormSet.lcTmplate &&Revise
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *loFormSet.AriaForm1.kbAutmCode.Enabled=(loFormSet.lcTmplate='ENABLE')
  LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBAUTMCODE.ENABLED=(LOFORMSET.LCTMPLATE='ENABLE')
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
ENDIF

SET SKIP OF PAD _INQUIRY OF (LOFORMSET.CHOSTFORMNAME) LOFORMSET.ACTIVEMODE="S"

RETURN
*--end of lpFormRefresh


*!*************************************************************
*! Name      : lfGetArrElem
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 7/18/2004
*! Purpose   :
*!*************************************************************
*! Parameters: lcSrchCode, laSrchArr
*!*************************************************************
*! Returns   : IIF(BETWEEN(lnArrElem, 1, ALEN((laSrchArr), 1)),lnArrElem, 0)
*!*************************************************************
FUNCTION LFGETARRELEM
PARAMETERS LCSRCHCODE, LASRCHARR
PRIVATE LNARRELEM
LNARRELEM = 1
DO WHILE LCSRCHCODE <> LASRCHARR[lnArrElem, 2] .AND. ;
    LNARRELEM < ALEN(LASRCHARR,1)
  LNARRELEM = LNARRELEM + 1
ENDDO
RETURN IIF(BETWEEN(LNARRELEM, 1, ALEN(LASRCHARR, 1)),LNARRELEM, 0)
*--end of lfGetArrElem


*!**************************************************************************
*!
*!      Function: lfDelShow
*!
*!**************************************************************************
* Validation function of the ok push button of the discont screen.
*
FUNCTION LFDELSHOW
LCLOCLSHOW = "lpShow"
*E300789,4  AMM No need to SEEK because of the new structure
*IF SEEK(gcPrnt_cmp,'SYCCOMP')
*E300789,4  AMM end
*E300692,1 CHANGE FILE NAME FROM SYCFISHD TO FISHD
*IF SEEK(gcPrnt_cmp+laData[32],'SYCFISHD')
*IF SYCFISHD.CFISYSTAT <> 'H' .AND. laData[3] <> 'C' .AND. APINVHDR.CINVSTAT <> 'A'
*E300789,4  AMM Adjust to fit the new structure
*IF SEEK(gcPrnt_cmp+laData[32],'FISHD')

*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*IF SEEK(laData[32],'FISHD')
IF GFSEEK(LADATA[32],'FISHD')
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  *E300789,4  AMM end
  IF FISHD.CFISYSTAT <> 'H' .AND. LADATA[3] <> 'C' .AND. APINVHDR.CINVSTAT <> 'A'
    *E300692,1 end
    IF LASCRMODE[2]
      IF _DOS
        SHOW GET PBDLT,1 PROMPT '\<Void' ENABLE
      ELSE
        SHOW GET PBDLT ENABLE
      ENDIF
    ELSE
      IF _DOS
        SHOW GET PBDLT,1 PROMPT '\<Void' DISABLE
      ELSE
        SHOW GET PBDLT DISABLE
      ENDIF
    ENDIF
  ELSE
    IF _DOS
      SHOW GET PBDLT,1 PROMPT '\<Void' DISABLE
    ELSE
      SHOW GET PBDLT DISABLE
    ENDIF
  ENDIF
ELSE
  IF _DOS
    SHOW GET PBDLT,1 PROMPT '\<Void' DISABLE
  ELSE
    SHOW GET PBDLT DISABLE
  ENDIF
ENDIF
*E300789,4  AMM Start
*ENDIF
*E300789,4  AMM end
IF LADATA[3] = 'C'
  SHOW GET PBAPPROVE,1 PROMPT 'Credit c\<ard payment...' &LCAPRSTAT
ELSE
  SHOW GET PBAPPROVE,1 PROMPT '\<Approve for payment...' &LCAPRSTAT
ENDIF

SHOW GET LADATA[38] &LCTMPLATE
SHOW GET IBTEMPLATE &LCTMPLATE
SHOW GET PBDISLINE  &LCDISTSTAT


*!*************************************************************
*! Name      : lfvVendCode
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 7/25/2004
*! Purpose   : Function called from the Shared Validation of the Vendor Code
*!*************************************************************
*! Parameters: The FormSet
*!*************************************************************
*! Returns   : None
*!*************************************************************
FUNCTION LFVVENDCODE
LPARAMETERS LOFORMSET


SELECT APVENDOR
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
=GFSETORDER('VENCODE')
*! E302678,1 MMT 03/24/2010 Convert Payable invoice screen to use SQL tables[Start]
*=gfSeek('')
*! E302678,1 MMT 03/24/2010 Convert Payable invoice screen to use SQL tables[End]
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
LOFORMSET.LLBROWSE = LOFORMSET.ARIAFORM1.KBVENDCODE.SELECTEDFROMBROWSE
LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE = PADR(LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE,LEN(APVENDOR.CVENDCODE))
LOFORMSET.LCVENDOR  = LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE  &&lower



*IF loFormSet.llBrowse .OR. !EMPTY(loFormSet.AriaForm1.KBVendCode.KeyTextBox.Value) .AND. LASTKEY() = 13  &&lower
IF LOFORMSET.LLBROWSE .OR. !EMPTY(LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE)
  *! E302678,1 MMT 03/24/2010 Convert Payable invoice screen to use SQL tables[Start]
  *IF loFormSet.llBrowse .OR. !SEEK(loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE) .OR. ATC("?",loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE) > 0  &&lower
  IF LOFORMSET.LLBROWSE .OR. !GFSEEK(LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE) .OR. ATC("?",LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE) > 0  &&lower
    *! E302678,1 MMT 03/24/2010 Convert Payable invoice screen to use SQL tables[End]
    LNCLOSREC  = RECNO(0)

    IF LOFORMSET.LLBROWSE .OR. ATC("?",LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE) > 0  &&lower
      DIMENSION LATEMP[3]
      LATEMP = ''

      *lcSavBrFld = lcBrFields
      *lcSavTitle = lcFile_Ttl

      LCBRFIELDS = LFGETBRHD(LOFORMSET,'APVENDOR')

      LCFILE_TTL = "Vendor"
      IF BETWEEN(LNCLOSREC,1,RECCOUNT('APVENDOR'))
        GO LNCLOSREC
      ELSE
        GO TOP
      ENDIF
      *! E302623,2 MMT 10/11/2009 Convert Payable invoice screen to use SQL tables[Start]
      *=gfBrows(' ','CVENDCODE,CPHONENO,CVENCOMP','laTemp')
      *! E302623,2 MMT 01/03/2010 Convert Payable invoice screen to use SQL tables[Start]
      *=gfBrows(' ','CVENDCODE,CPHONENO,CVENCOMP','laTemp','Vendors')
      *! E302678,1 MMT 03/24/2010 Convert Payable invoice screen to use SQL tables[Start]
      =GFSEEK('')
      *! E302678,1 MMT 03/24/2010 Convert Payable invoice screen to use SQL tables[End]
      *N000682,1 MMT 11/22/2012 Globalization changes[Start]
      *=ARIABROW(' ', 'Vendors', .F., .F., .F., .F., .F., .T., ;
        'CVENDCODE,CPHONENO,CVENCOMP', 'laTemp', .F., .F., .F., ;
        .F., .F., .F., .F., .F., ;
        .F., .F.)
      =ARIABROW(' ', IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_VENDORS,loFormSet.GetHeaderText("LANG_APPYINV_VENDORS",loFormSet.HeaderAlias)), .F., .F., .F., .F., .F., .T., ;
        'CVENDCODE,CPHONENO,CVENCOMP', 'laTemp', .F., .F., .F., ;
        .F., .F., .F., .F., .F., ;
        .F., .F.)
      *N000682,1 MMT 11/22/2012 Globalization changes[END]
      *! E302623,2 MMT 01/03/2010 Convert Payable invoice screen to use SQL tables[End]
      *! E302623,2 MMT 10/11/2009 Convert Payable invoice screen to use SQL tables[eND]
      *lcBrFields = lcSavBrFld
      *lcFile_Ttl = lcSavTitle

      IF !EMPTY(LATEMP[1])
        LOFORMSET.LCVENDOR  = LATEMP[1]
        LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE = ALLTRIM(LATEMP[1])  &&lower
        LOFORMSET.LCPHONE   = LATEMP[2]
        LOFORMSET.ARIAFORM1.KBVENDPHONE.KEYTEXTBOX.VALUE = ALLTRIM(LATEMP[2])
        LOFORMSET.LCCOMPANY = LATEMP[3]
        LOFORMSET.ARIAFORM1.KBVENDCOMPANY.KEYTEXTBOX.VALUE = ALLTRIM(LATEMP[3])
        *_CUROBJ   = OBJNUM(loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value)  &&lower&&Old CurObj
        *loFormSet.AriaForm1.kbInvNo.KeyTextBox.SetFocus()
        *KEYBOARD REPLICATE('{TAB}',2)

      ELSE
        *Old: loFormSet.AriaForm1.KBVendCode.KeyTextBox.Value = loFormSet.lcOldVend  &&lower
        LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE = LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.OLDVALUE
      ENDIF
    ELSE
      IF LOFORMSET.LLADDVEN
        LNOPTION = GFMODALGEN('QRM00001B00001','Dialog',;
          LOFORMSET.LCTVENKEY + " : " +ALLTRIM(LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE))  &&lower
      ELSE
        LNOPTION = GFMODALGEN('QRM00001B00014','Dialog',;
          LOFORMSET.LCTVENKEY + " : " +ALLTRIM(LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE))  &&lower
        LNOPTION = IIF(LNOPTION=2,3,LNOPTION)
      ENDIF
      DO CASE
      CASE LNOPTION = 1

        DIMENSION LATEMP[3]

        LATEMP = ''
        *lcSavBrFld = lcBrFields
        *lcSavTitle = lcFile_Ttl
        *! E302678,1 MMT 03/24/2010 Convert Payable invoice screen to use SQL tables[Start]
        =GFSEEK('')
        *! E302678,1 MMT 03/24/2010 Convert Payable invoice screen to use SQL tables[End]

        LCBRFIELDS = LFGETBRHD(LOFORMSET,'APVENDOR')

        LCFILE_TTL = "Vendor"

        *! E302678,1 MMT 03/24/2010 Convert Payable invoice screen to use SQL tables[Start]
        *!*	            IF BETWEEN(lnClosRec,1,RECCOUNT('APVENDOR'))
        *!*	              GO lnClosRec
        *!*	            ELSE
        IF !SEEK(LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE)
          *! E302678,1 MMT 03/24/2010 Convert Payable invoice screen to use SQL tables[End]
          GO TOP
        ENDIF

        *! E302623,2 MMT 10/11/2009 Convert Payable invoice screen to use SQL tables[Start]
        *=gfBrows(' ','CVENDCODE,CPHONENO,CVENCOMP','laTemp')
        *! E302623,3 MMT 01/03/2010 Convert Payable invoice screen to use SQL tables[Start]
        *=gfBrows(' ','CVENDCODE,CPHONENO,CVENCOMP','laTemp','Vendors')
        *N000682,1 MMT 11/22/2012 Globalization changes[Start]
        *=ARIABROW(' ', 'Vendors', .F., .F., .F., .F., .F., .T., ;
         * 'CVENDCODE,CPHONENO,CVENCOMP', 'laTemp', .F., .F., .F., ;
          *.F., .F., .F., .F., .F., ;
          *.F., .F.)
        =ARIABROW(' ', IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_VENDORS,loFormSet.GetHeaderText("LANG_APPYINV_VENDORS",loFormSet.HeaderAlias)), .F., .F., .F., .F., .F., .T., ;
          'CVENDCODE,CPHONENO,CVENCOMP', 'laTemp', .F., .F., .F., ;
          .F., .F., .F., .F., .F., ;
          .F., .F.)
         *N000682,1 MMT 11/22/2012 Globalization changes[END]
        *! E302623,3 MMT 01/03/2010 Convert Payable invoice screen to use SQL tables[End]
        *! E302623,2 MMT 10/11/2009 Convert Payable invoice screen to use SQL tables[eND]

        *lcBrFields = lcSavBrFld
        *lcFile_Ttl = lcSavTitle

        IF !EMPTY(LATEMP[1])
          LOFORMSET.LCVENDOR  = LATEMP[1]
          LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE = ALLTRIM(LATEMP[1])  &&lower
          LOFORMSET.LCPHONE   = LATEMP[2]
          LOFORMSET.ARIAFORM1.KBVENDPHONE.KEYTEXTBOX.VALUE = ALLTRIM(LATEMP[2])
          LOFORMSET.LCCOMPANY = LATEMP[3]
          LOFORMSET.ARIAFORM1.KBVENDCOMPANY.KEYTEXTBOX.VALUE = ALLTRIM(LATEMP[3])
          *_CUROBJ   = OBJNUM(loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value)  &&lower&&Old CurObj
          *loFormSet.AriaForm1.kbInvNo.KeyTextBox.SetFocus()
          *KEYBOARD REPLICATE('{TAB}',2)
        ELSE
          *Old: loFormSet.AriaForm1.KBVendCode.KeyTextBox.Value = loFormSet.lcOldVend  &&lower
          LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE = LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.OLDVALUE
        ENDIF
        *Old: =lfRefresh()
        LOFORMSET.REFRESH()

      CASE LNOPTION = 2
        *loFormSet.AriaForm1.KBVendCode.KeyTextBox.Value = loFormSet.AriaForm1.KBVendCode.KeyTextBox.OldValue
        *RETURN .F.
        LOFORMSET.LLFROMVEND = .T.

        *=gfStatic()
        *Old: DO gpDoProg WITH 'AWRAPVENDR', .F., 'AP',"'" + loFormSet.lcVendor + "'"
        *DO FORM (oAriaApplication.ScreenHome+"APVENDR.SCX") WITH '"'+loFormSet.AriaForm1.KBVendCode.KeyTextBox.Value+'"' TO x

        *! E303029,1 MMT 12/26/2011 correct the calling of non-major programs within the SaaS environemnt[STart]
        IF FILE(OARIAAPPLICATION.CLIENTSCREENHOME+"APVENDR.SCX")
          DO FORM (OARIAAPPLICATION.CLIENTSCREENHOME+"APVENDR.SCX") WITH LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE NAME LOVENDFORM NOSHOW
        ELSE
          *! E303029,1 MMT 12/26/2011 correct the calling of non-major programs within the SaaS environemnt[END]

          DO FORM (OARIAAPPLICATION.SCREENHOME+"APVENDR.SCX") WITH LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE NAME LOVENDFORM NOSHOW
          *! E303029,1 MMT 12/26/2011 correct the calling of non-major programs within the SaaS environemnt[STart]
        ENDIF
        *! E303029,1 MMT 12/26/2011 correct the calling of non-major programs within the SaaS environemnt[END]
        *loVendForm.AddNew()
        *loVendForm.ariaForm1.kbVendor.KeyTextBox.Value=loFormSet.AriaForm1.KBVendCode.KeyTextBox.Value
        *KEYBOARD loFormSet.AriaForm1.KBVendCode.KeyTextBox.Value
        LOVENDFORM.SHOW(1)
        *=oAriaApplication.DoProgram('AWRAPVENDR','"'+loFormSet.AriaForm1.KBVendCode.KeyTextBox.Value+'"',.F.,'AP')
        RETURN .F.

      CASE LNOPTION = 3
        *Old: loFormSet.AriaForm1.KBVendCode.KeyTextBox.Value = loFormSet.lcOldVend  &&lower
        LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE = LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.OLDVALUE
        *Old: _CUROBJ   = _CUROBJ&&Old CurObj
        RETURN .F.
        *Old: =lfRefresh()
        *loFormSet.Refresh()
      ENDCASE
    ENDIF
  ELSE
    LOFORMSET.LCPHONE   = APVENDOR.CPHONENO
    LOFORMSET.ARIAFORM1.KBVENDPHONE.KEYTEXTBOX.VALUE = APVENDOR.CPHONENO
    LOFORMSET.LCCOMPANY = APVENDOR.CVENCOMP
    LOFORMSET.ARIAFORM1.KBVENDCOMPANY.KEYTEXTBOX.VALUE = APVENDOR.CVENCOMP
    *_CUROBJ   = OBJNUM(loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value)  &&lower&&Old CurObj
    *loFormSet.AriaForm1.kbInvNo.KeyTextBox.SetFocus()
    *KEYBOARD REPLICATE('{TAB}',2)
  ENDIF
ELSE
  *Old: loFormSet.AriaForm1.KBVendCode.KeyTextBox.Value = loFormSet.lcOldVend  &&lower
  LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE = LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.OLDVALUE
ENDIF

*Old: SHOW GET loFormSet.AriaForm1.KBVendCode.KeyTextBox.Value  &&lower &&Revise
*Old: SHOW GET ibVendor  ENABLE &&Revise
LOFORMSET.ARIAFORM1.KBVENDCODE.ENABLED = .T.
*Old: SHOW GET loFormSet.lcPhone   ENABLE &&Revise
*Old: SHOW GET ibPhone   ENABLE &&Revise
LOFORMSET.ARIAFORM1.KBVENDPHONE.ENABLED = .T.
*Old: SHOW GET loFormSet.lcCompany ENABLE &&Revise
*Old: SHOW GET ibCompany ENABLE &&Revise
LOFORMSET.ARIAFORM1.KBVENDCOMPANY.ENABLED = .T.
*Old: SHOW GET loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value  &&lower &&Revise
*Old: SHOW GET ibInvoice ENABLE &&Revise
LOFORMSET.ARIAFORM1.KBINVNO.ENABLED = .T.

LOFORMSET.LLBROWSE = .F.
LOFORMSET.LCVENINVTYPES = ALLTRIM(APVENDOR.CVENINVTYP)
LOFORMSET.LCVENINVTYPES = LOFORMSET.LCVENINVTYPES + IIF(GFGETMEMVAR('M_BOMVAR') AND 'M' $ LOFORMSET.LCVENINVTYPES,'A','')
LOFORMSET.LCVENINVTYPES = LOFORMSET.LCVENINVTYPES + IIF(!EMPTY(GFGETMEMVAR('M_DYEOPR')) AND 'M' $ LOFORMSET.LCVENINVTYPES,'D','')

*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*!*	loFormSet.DistLines.glAPActCode.KeyTextBox.Value = IIF(!EMPTY(APVENDOR.CAPACCT),APVENDOR.CAPACCT, ;
*!*	   IIF(SEEK(loFormSet.AriaForm1.cboDivision.Value,'APDIV') AND !EMPTY(APDIV.CAPACCT),APDIV.CAPACCT,APSETUP.CAPACCT))  &&lower
*!*	loFormSet.lcDistAcct = IIF(!EMPTY(APVENDOR.CEXPACCT),APVENDOR.CEXPACCT,;
*!*	  IIF(SEEK(loFormSet.AriaForm1.cboDivision.Value,'APDIV') AND !EMPTY(APDIV.CEXPACCT),APDIV.CEXPACCT,APSETUP.CEXPACCT))  &&lower
LOFORMSET.ARIAFORM1.PGFPAYINV.PGDIST.GLAPACTCODE.KEYTEXTBOX.VALUE = IIF(!EMPTY(APVENDOR.CAPACCT),APVENDOR.CAPACCT, ;
  IIF(GFSEEK(LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.CBODIVISION.VALUE,'APDIV') AND !EMPTY(APDIV.CAPACCT),APDIV.CAPACCT,APSETUP.CAPACCT))  &&lower
LOFORMSET.LCDISTACCT = IIF(!EMPTY(APVENDOR.CEXPACCT),APVENDOR.CEXPACCT,;
  IIF(GFSEEK(LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.CBODIVISION.VALUE,'APDIV') AND !EMPTY(APDIV.CEXPACCT),APDIV.CEXPACCT,APSETUP.CEXPACCT))  &&lower
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

SELECT APINVHDR
*--end of lfvVendCode


*!*************************************************************
*! Name      : lfvInvNo
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 7/25/2004
*! Purpose   : Function called from the Shared Validation of the Invoice No.
*!*************************************************************
*! Parameters: The FormSet
*!*************************************************************
*! Returns   : None
*!*************************************************************
FUNCTION LFVINVNO
LPARAMETERS LOFORMSET
LOCAL LCVENDCODE, LCINVNO

SELECT APINVHDR
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*! E302678,1 MMT 03/24/2010 Convert Payable invoice screen to use SQL tables[Start]
*=gfSeek('')
*! E302678,1 MMT 03/24/2010 Convert Payable invoice screen to use SQL tables[End]
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
LOFORMSET.LLBROWSE = LOFORMSET.ARIAFORM1.KBINVNO.SELECTEDFROMBROWSE
LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE = PADR(LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE,LEN(APVENDOR.CVENDCODE))
LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE = PADR(LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE,LEN(APINVHDR.CINVNO))

LCBRFIELDS = LOFORMSET.ARIABRFIELDS.EDTBROWSEFIELDS.VALUE

LCSAVEXACT = SET('EXACT')
SET EXACT ON

*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*IF !EMPTY(ALLTRIM(loFormSet.AriaForm1.KBVendCode.KeyTextBox.Value)) .AND. !SEEK(ALLTRIM(loFormSet.AriaForm1.KBVendCode.KeyTextBox.Value),'APVENDOR')  &&lower
IF !EMPTY(ALLTRIM(LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE)) .AND.;
    !GFSEEK(ALLTRIM(LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE),'APVENDOR')  &&lower
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

  *Old: _CUROBJ = OBJNUM(loFormSet.AriaForm1.KBVendCode.KeyTextBox.Value)  &&lower&&Old CurObj
  *loFormSet.AriaForm1.KBVendCode.KeyTextBox.SetFocus()
  *Old: SHOW GET loFormSet.AriaForm1.KBVendCode.KeyTextBox.Value  &&lower &&Revise
  LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.REFRESH()
  RETURN
ENDIF

*Old: loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value  = ;
IIF(EMPTY(loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value),;
loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value,;
ALLTRIM(loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value))  &&lower

LOFORMSET.LCCODEFILT = ''
*IF loFormSet.llBrowse .OR. !EMPTY(loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value) .AND. LASTKEY() = 13  &&lower
IF LOFORMSET.LLBROWSE .OR. !EMPTY(LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE)
  IF LOFORMSET.LLBROWSE .OR. ATC("?",LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE) > 0 .OR. EMPTY(LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE)  &&lower  &&lower
    DIMENSION LATEMP[2]
    LATEMP = ''

    IF EMPTY(LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE)  &&lower
      *! E302623,2 MMT 10/12/2009 Convert Payable invoice screen to use SQL tables[Start]
      *gfBrows(.F.,'CVENDCODE,CINVNO','laTemp')
      *! E302623,3 MMT 01/03/2010 Convert Payable invoice screen to use SQL tables[Start]
      *=gfBrows(.F.,'CVENDCODE,CINVNO','laTemp','Invoices')
      *! E302678,1 MMT 03/24/2010 Convert Payable invoice screen to use SQL tables[Start]
      =GFSEEK('')
      *! E302678,1 MMT 03/24/2010 Convert Payable invoice screen to use SQL tables[End]
	  *N000682,1 MMT 12/09/2012 Globalization changes[Start]
      *=ARIABROW(.F., 'Invoices', .F., .F., .F., .F., .F., .T., ;
        'CVENDCODE,CINVNO', 'laTemp', .F., .F., .F., ;
        .F., .F., .F., .F., .F., ;
        .F., .F.)
      =ARIABROW(.F., IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_INVOICESTITLE,LOFORMSET.GetHeaderText("LANG_APPYINV_INVOICESTITLE",LOFORMSET.HeaderAlias)), .F., .F., .F., .F., .F., .T., ;
        'CVENDCODE,CINVNO', 'laTemp', .F., .F., .F., ;
        .F., .F., .F., .F., .F., ;
        .F., .F.)
		*N000682,1 MMT 12/09/2012 Globalization changes[End]
      *! E302623,3 MMT 01/03/2010 Convert Payable invoice screen to use SQL tables[End]
      *! E302623,2 MMT 10/12/2009 Convert Payable invoice screen to use SQL tables[End]
    ELSE
      SET EXACT &LCSAVEXACT
      *! E302678,1 MMT 03/24/2010 Convert Payable invoice screen to use SQL tables[Start]
      *IF SEEK(loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE)  &&lower
      IF GFSEEK(LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE)
        *! E302678,1 MMT 03/24/2010 Convert Payable invoice screen to use SQL tables[End]
        *! E302623,2 MMT 10/12/2009 Convert Payable invoice screen to use SQL tables[Start]
        *=gfBrows('"'+loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE+'"','CVENDCODE,CINVNO','laTemp')
        *! E302623,3 MMT 01/03/2010 Convert Payable invoice screen to use SQL tables[Start]
        *=gfBrows('"'+loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE+'"','CVENDCODE,CINVNO','laTemp','Invoices')
		*N000682,1 MMT 12/09/2012 Globalization changes[Start]
        *=ARIABROW("'"+PADR(LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE,8)+"'", 'Invoices', .F., .F., .F., .F., .F., .T., ;
          'CVENDCODE,CINVNO', 'laTemp', .F., .F., .F., ;
          .F., .F., .F., .F., .F., ;
          .F., .F.)
        =ARIABROW("'"+PADR(LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE,8)+"'", IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_INVOICESTITLE,LOFORMSET.GetHeaderText("LANG_APPYINV_INVOICESTITLE",LOFORMSET.HeaderAlias)), .F., .F., .F., .F., .F., .T., ;
          'CVENDCODE,CINVNO', 'laTemp', .F., .F., .F., ;
          .F., .F., .F., .F., .F., ;
          .F., .F.)
        *N000682,1 MMT 12/09/2012 Globalization changes[End]
        *! E302623,3 MMT 01/03/2010 Convert Payable invoice screen to use SQL tables[End]
        *! E302623,2 MMT 10/12/2009 Convert Payable invoice screen to use SQL tables[End]
      ELSE
	    *N000682,1 MMT 12/09/2012 Globalization changes[Start]
		*=GFMODALGEN("TRM04042B00000","DIALOG","invoices|"+LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE)  &&lower
        =GFMODALGEN("TRM04042B00000","DIALOG",;
		IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_INVOICESTITLE,LOFORMSET.GetHeaderText("LANG_APPYINV_INVOICESTITLE",LOFORMSET.HeaderAlias))+"|"+LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE)  &&lower
		*N000682,1 MMT 12/09/2012 Globalization changes[End]
      ENDIF
    ENDIF

    IF !EMPTY(LATEMP[1])
      *Old: SCATTER FIELDS &loFormSet.lcScFields MEMO TO laData
      *Old: laScrMode    = .F.
      LOFORMSET.CHANGEMODE("V")
      SET EXACT &LCSAVEXACT
      *Old: SHOW GETS &&Revise
    ELSE
      *Old: loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value = loFormSet.lcOldInvNo  &&lower
      LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE = LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.OLDVALUE
      *Old: SHOW GET loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value  &&lower &&Revise
      *_CUROBJ = OBJNUM(loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value)  &&lower&&Old CurObj
      *loFormSet.AriaForm1.kbInvNo.KeyTextBox.SetFocus()
    ENDIF
  ELSE
    SET FILTER TO
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *!*	    IF SEEK(loFormSet.AriaForm1.KBVendCode.KeyTextBox.Value+;
    *!*	            loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value,'APINVHDR') .AND. APINVHDR.CINVSTAT <> 'V'  &&lower
    IF GFSEEK(LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE+;
        LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE,'APINVHDR') .AND. APINVHDR.CINVSTAT <> 'V'  &&lower
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

      SET FILTER TO CINVSTAT <> 'V'
      *Old: SCATTER FIELDS &loFormSet.lcScFields MEMO TO laData
      *Old: laScrMode    = .F.
      LOFORMSET.CHANGEMODE("V")
      SET EXACT &LCSAVEXACT
      *Old: SHOW GETS &&Revise
    ELSE
      IF APINVHDR.CINVSTAT = 'V'
        SET FILTER TO CINVSTAT <> 'V'
        =GFMODALGEN('QRM04146B00000','Dialog',ALLTRIM(LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE)+'|'+ALLTRIM(LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE))  &&lower  &&lower
        *loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value = loFormSet.lcOldInvNo  &&lower
        LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE = LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.OLDVALUE
        *Old: SHOW GET loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value  &&lower &&Revise
        *Old: _CUROBJ = OBJNUM(loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value)  &&lower&&Old CurObj
        *loFormSet.AriaForm1.kbInvNo.KeyTextBox.SetFocus()
      ELSE
        SET FILTER TO CINVSTAT <> 'V'
        LNOPTION = GFMODALGEN('QRM00001B00001','Dialog',;
          LOFORMSET.LCTVENINV + ALLTRIM(LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE)+' '+ALLTRIM(LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE))  &&lower  &&lower
        DO CASE
        CASE LNOPTION = 1             && Browse
          SET EXACT &LCSAVEXACT
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
          *IF SEEK(loFormSet.AriaForm1.KBVendCode.KeyTextBox.Value)  &&lower
          IF GFSEEK(LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE)  &&lower
            *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
            DIMENSION LATEMP[2]
            LATEMP = ''
            LCVENDCODE=LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE
            *=gfBrows([FOR CVENDCODE = lcVendCode],'CVENDCODE,CPHONENO,CVENCOMP','laTemp')
            *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
            *!*	              SELECT * from apinvhdr WHERE CVENDCODE+CINVNO=loFormSet.AriaForm1.KBVendCode.KeyTextBox.Value ;
            *!*	                 INTO CURSOR apinvhdr2
            *! E302623,3 MMT 01/03/2010 Convert Payable invoice screen to use SQL tables[Start]
            *gfSqlRun("SELECT * from apinvhdr WHERE CVENDCODE ='"+loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE+"'",'apinvhdr',.F.,'apinvhdr2')
            *! E302623,3 MMT 01/03/2010 Convert Payable invoice screen to use SQL tables[End]
            *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

            *! E302623,2 MMT 10/12/2009 Convert Payable invoice screen to use SQL tables[Start]
            *!*	                =gfBrows('FOR CVENDCODE = "'+loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE+'"' ;
            *!*	                  ,'CVENDCODE,CINVNO','laTemp')
            *! E302623,3 MMT 01/03/2010 Convert Payable invoice screen to use SQL tables[Start]
            *=gfBrows('FOR CVENDCODE = "'+loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE+'"' ;
            ,'CVENDCODE,CINVNO','laTemp','Invoices')
            SELECT APINVHDR
            *! E302678,1 MMT 03/24/2010 Convert Payable invoice screen to use SQL tables[Start]
            =GFSEEK(PADR(LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE,8))
            *! E302678,1 MMT 03/24/2010 Convert Payable invoice screen to use SQL tables[End]
			*N000682,1 MMT 12/09/2012 Globalization changes[Start]
			*=ARIABROW('"'+LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE+'"' , 'Invoices', .F., .F., .F., .F., .F., .T., ;
              'CVENDCODE,CINVNO', 'laTemp', .F., .F., .F., ;
              .F., .F., .F., .F., .F., ;
              .F., .F.)
            =ARIABROW('"'+LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE+'"' , IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_INVOICESTITLE,LOFORMSET.GetHeaderText("LANG_APPYINV_INVOICESTITLE",LOFORMSET.HeaderAlias)), .F., .F., .F., .F., .F., .T., ;
              'CVENDCODE,CINVNO', 'laTemp', .F., .F., .F., ;
              .F., .F., .F., .F., .F., ;
              .F., .F.)
            *N000682,1 MMT 12/09/2012 Globalization changes[End]
            *! E302623,3 MMT 01/03/2010 Convert Payable invoice screen to use SQL tables[End]
            *! E302623,2 MMT 10/12/2009 Convert Payable invoice screen to use SQL tables[End]
            SELECT APINVHDR
            IF !EMPTY(LATEMP[1])
              LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE = ALLTRIM(LATEMP[1])  &&lower
              LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE = ALLTRIM(LATEMP[2])  &&lower
              *Old: SCATTER FIELDS &loFormSet.lcScFields MEMO TO laData
              *Old: laScrMode = .F.
              LOFORMSET.CHANGEMODE("V")
              SET EXACT &LCSAVEXACT
              *Old: SHOW GETS &&Revise
            ELSE
              *Old: loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value = loFormSet.lcOldInvNo  &&lower
              LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE = LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.OLDVALUE
              *Old: SHOW GET loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value  &&lower &&Revise
              *Old: _CUROBJ = OBJNUM(loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value)  &&lower&&Old CurObj
              *loFormSet.AriaForm1.kbInvNo.KeyTextBox.SetFocus()
            ENDIF
          ELSE
		    *N000682,1 MMT 12/09/2012 Globalization changes[Start]
			*=GFMODALGEN("TRM04042B00000","DIALOG","invoices|"+LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE)  &&lower
            =GFMODALGEN("TRM04042B00000","DIALOG",;
			IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_INVOICESTITLE,LOFORMSET.GetHeaderText("LANG_APPYINV_INVOICESTITLE",LOFORMSET.HeaderAlias))+"|"+LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE)  &&lower
			*N000682,1 MMT 12/09/2012 Globalization changes[End]
            *Old: loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value = loFormSet.lcOldInvNo  &&lower
            LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE = LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.OLDVALUE
            *Old: SHOW GET loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value  &&lower &&Revise
            *Old: _CUROBJ = OBJNUM(loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value)  &&lower&&Old CurObj
            *loFormSet.AriaForm1.kbInvNo.KeyTextBox.SetFocus()
          ENDIF

        CASE LNOPTION = 2       && Add

          LCVENDCODE = LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE
          LCINVNO = LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE
          SELECT APINVHDR
          APPEND BLANK
          REPLACE CVENDCODE WITH LCVENDCODE, CINVNO WITH LCINVNO

          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
          =GFREPLACE("")
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

          LOFORMSET.LCVENINVTYPES = ALLTRIM(APVENDOR.CVENINVTYP)
          LOFORMSET.LCVENINVTYPES = LOFORMSET.LCVENINVTYPES + IIF(GFGETMEMVAR('M_BOMVAR') AND 'M' $ LOFORMSET.LCVENINVTYPES,'A','')
          LOFORMSET.LCVENINVTYPES = LOFORMSET.LCVENINVTYPES + IIF(!EMPTY(GFGETMEMVAR('M_DYEOPR')) AND 'M' $ LOFORMSET.LCVENINVTYPES,'D','')

          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
          *!*	            loFormSet.DistLines.glAPActCode.KeyTextBox.Value = IIF(!EMPTY(APVENDOR.CAPACCT),APVENDOR.CAPACCT, ;
          *!*	              IIF(SEEK(loFormSet.AriaForm1.cboDivision.Value,'APDIV') AND !EMPTY(APDIV.CAPACCT),APDIV.CAPACCT,APSETUP.CAPACCT))  &&lower
          *!*	            loFormSet.lcDistAcct = IIF(!EMPTY(APVENDOR.CEXPACCT),APVENDOR.CEXPACCT,;
          *!*	              IIF(SEEK(loFormSet.AriaForm1.cboDivision.Value,'APDIV') AND !EMPTY(APDIV.CEXPACCT),APDIV.CEXPACCT,APSETUP.CEXPACCT))  &&lower
          LOFORMSET.ARIAFORM1.PGFPAYINV.PGDIST.GLAPACTCODE.KEYTEXTBOX.VALUE = IIF(!EMPTY(APVENDOR.CAPACCT),APVENDOR.CAPACCT, ;
            IIF(GFSEEK(LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.CBODIVISION.VALUE,'APDIV') AND !EMPTY(APDIV.CAPACCT),APDIV.CAPACCT,APSETUP.CAPACCT))  &&lower
          LOFORMSET.LCDISTACCT = IIF(!EMPTY(APVENDOR.CEXPACCT),APVENDOR.CEXPACCT,;
            IIF(GFSEEK(LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.CBODIVISION.VALUE,'APDIV') AND !EMPTY(APDIV.CEXPACCT),APDIV.CEXPACCT,APSETUP.CEXPACCT))  &&lower
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
          *Old: laScrMode    = .F.

          LOFORMSET.CHANGEMODE("A")
          LOFORMSET.RAISERECORDCHANGE(5)

          *!*	            loFormSet.AddNew()
          *!*	            SELECT apinvhdr
          *!*	            IF loFormSet.ActiveMode = 'A'
          *!*	               REPLACE cvendcode WITH lcVendCode, cInvNo WITH lcInvNO
          *!*	            ENDIF
          *!*	            loFormSet.RefreshAll()
          *!*	            loFormSet.RaiseRecordChange(5)

          IF TYPE('loFormSet.AriaForm1.DtPostDate.Value') = 'D'
            *Old: _CUROBJ = OBJNUM(loFormSet.AriaForm1.DtPostDate.Value)  &&lower&&Old CurObj
            *loFormSet.AriaForm1.DtPostDate.SetFocus()
          ELSE
            *Old: _CUROBJ = OBJNUM(loFormSet.AriaForm1.DtInvDate.Value)  &&lower&&Old CurObj
            *loFormSet.AriaForm1.DtInvDate.SetFocus()
          ENDIF
          SET EXACT &LCSAVEXACT
          *Old: SHOW GETS &&Revise

        CASE LNOPTION = 3       && Reenter

          *Old: loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value = loFormSet.lcOldInvNo  &&lower
          LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE = LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.OLDVALUE
          *Old: SHOW GET loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value  &&lower &&Revise
          *Old: SHOW GET ibInvoice ENABLE &&Revise
          LOFORMSET.ARIAFORM1.KBINVNO.ENABLED = .T.
          *! E302623,3 MMT 01/03/2010 Convert Payable invoice screen to use SQL tables[Start]
          RETURN .F.
          *! E302623,3 MMT 01/03/2010 Convert Payable invoice screen to use SQL tables[End]
          *Old: _CUROBJ = OBJNUM(loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value)  &&lower&&Old CurObj
          *loFormSet.AriaForm1.kbInvNo.KeyTextBox.SetFocus()
        ENDCASE
      ENDIF
    ENDIF
  ENDIF
ENDIF

IF !EMPTY(LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE) .AND. !EMPTY(LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE)  &&lower  &&lower
  =LFTAXACT(LOFORMSET)
ENDIF

SET EXACT &LCSAVEXACT

IF !LOFORMSET.ACTIVEMODE="S"  &&lower
  LOFORMSET.LCDEFFACT = APVENDOR.CFACCODE
ENDIF

LOFORMSET.LLBROWSE = .F.

IF APINVHDR.CAUTMTYPE = 'R'  &&lower
  LOFORMSET.LCLABEL = 'Recurring:'
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *loFormSet.AriaForm1.lblAutmType.Caption = 'Recurring'
  *N000682,1 MMT 11/20/2012 Globalization Changes[Start]
  *LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.LBLAUTMTYPE.CAPTION = 'Recurring'
  *N000682,1 11/20/2012 MMT Globlization changes[Start]
*LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.LBLAUTMTYPE.CAPTION =LANG_APPYINV_RECURRING
LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.LBLAUTMTYPE.CAPTION =IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_RECURRING,loFormSet.GetHeaderText("LANG_APPYINV_RECURRING",loFormSet.HeaderAlias))
*N000682,1 11/20/2012 MMT Globlization changes[End]

  *N000682,1 MMT 11/20/2012 Globalization Changes[End]

  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
ELSE      && Else
  LOFORMSET.LCLABEL = 'Template :'
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *loFormSet.AriaForm1.lblAutmType.Caption = 'Template'
  *N000682,1 MMT 11/20/2012 Globalization Changes[Start]
  *  LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.LBLAUTMTYPE.CAPTION = 'Template'
  *N000682,1 11/20/2012 MMT Globlization changes[Start]
*LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.LBLAUTMTYPE.CAPTION =LANG_APPYINV_TEMPLATE
LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.LBLAUTMTYPE.CAPTION =IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_TEMPLATE,loFormSet.GetHeaderText("LANG_APPYINV_TEMPLATE",loFormSet.HeaderAlias))
*N000682,1 11/20/2012 MMT Globlization changes[End]

  *N000682,1 MMT 11/20/2012 Globalization Changes[End]

  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
ENDIF     && End of IF
*Old: =lfRefresh(gcBaseWind)
LOFORMSET.REFRESH()

SELECT APINVHDR
*--end of lfvInvNo


*!*************************************************************
*! Name      : lfvCompPhone
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 7/25/2004
*! Purpose   : Function called from Shared Validation of the Company and Phone
*!*************************************************************
*! Parameters: The FormSet
*!           : A Paremeter to indicate whether called from the Company or the Phone
*!*************************************************************
*! Returns   : None
*!*************************************************************
FUNCTION LFVCOMPPHONE
LPARAMETERS LOFORMSET, LCOBJNUM

SELECT APVENDOR
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*lcSavOrder = SET('ORDER')
LCSAVORDER = ORDER()
=GFSEEK('')
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

LOFORMSET.LLBROWSE = IIF(LCOBJNUM='1',LOFORMSET.ARIAFORM1.KBVENDPHONE.SELECTEDFROMBROWSE, ;
  LOFORMSET.ARIAFORM1.KBVENDCOMPANY.SELECTEDFROMBROWSE)

IF LCOBJNUM = '1'
  LOFORMSET.ARIAFORM1.KBVENDPHONE.KEYTEXTBOX.VALUE = PADR(LOFORMSET.ARIAFORM1.KBVENDPHONE.KEYTEXTBOX.VALUE,LEN(APVENDOR.CPHONENO))
  LCOBJNAME = ALLTRIM(LOFORMSET.ARIAFORM1.KBVENDPHONE.KEYTEXTBOX.VALUE)
ELSE
  LOFORMSET.ARIAFORM1.KBVENDCOMPANY.KEYTEXTBOX.VALUE = PADR(LOFORMSET.ARIAFORM1.KBVENDCOMPANY.KEYTEXTBOX.VALUE,LEN(APVENDOR.CVENCOMP))
  LCOBJNAME = ALLTRIM(LOFORMSET.ARIAFORM1.KBVENDCOMPANY.KEYTEXTBOX.VALUE)
ENDIF

*Old: IF lcObjNum = '1' .AND. loFormSet.lcOldPhone = loFormSet.lcPhone .AND. !loFormSet.llBrowse
IF LCOBJNUM = '1' .AND. LOFORMSET.ARIAFORM1.KBVENDPHONE.KEYTEXTBOX.OLDVALUE = ;
    LOFORMSET.ARIAFORM1.KBVENDPHONE.KEYTEXTBOX.VALUE .AND. !LOFORMSET.LLBROWSE
  RETURN
ENDIF

*Old: IF lcObjNum = '2' .AND. loFormSet.lcOldComp = loFormSet.lcCompany .AND. !loFormSet.llBrowse
IF LCOBJNUM = '2' .AND. LOFORMSET.ARIAFORM1.KBVENDCOMPANY.KEYTEXTBOX.OLDVALUE = ;
    LOFORMSET.ARIAFORM1.KBVENDCOMPANY.KEYTEXTBOX.VALUE .AND. !LOFORMSET.LLBROWSE
  RETURN
ENDIF

*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*SET ORDER TO TAG IIF(lcObjNum = '1','VENPHONE','VENCOMP')
GFSETORDER(IIF(LCOBJNUM = '1','VENPHONE','VENCOMP'))
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
*Old: lcObjName  = ALLTRIM(UPPER(EVALUATE(SYS(18))))

LCSAVEXACT = SET('EXACT')
SET EXACT ON

*IF loFormSet.llBrowse .OR. !EMPTY(lcObjName) .AND. LASTKEY() = 13
IF LOFORMSET.LLBROWSE .OR. !EMPTY(LCOBJNAME)
  IF LOFORMSET.LLBROWSE .OR. !SEEK(LCOBJNAME) .OR. ATC("?",LCOBJNAME) > 0
    LNCLOSREC  = RECNO(0)
    DIMENSION LATEMP[3]

    LATEMP = ''

    *lcSavBrFld = lcBrFields
    *lcSavTitle = lcFile_Ttl
    *N000682,1 MMT 11/22/2012 Globalization changes[Start]
   * LCBRFIELDS = "CVENDCODE :H= 'Vendor Code',;
                  CVENCOMP :H= 'Company',;
                  CPHONENO :H= 'Phone'"

    *LCFILE_TTL = "Vendor"
    LCBRFIELDS = "CVENDCODE :H= '"+IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_VENDORCODE,loFormSet.GetHeaderText("LANG_APPYINV_VENDORCODE",loFormSet.HeaderAlias))+"',;
                  CVENCOMP :H= '"+IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_COMPANY,loFormSet.GetHeaderText("LANG_APPYINV_COMPANY",loFormSet.HeaderAlias))+"',;
CPHONENO :H= '"+IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_PHONE,loFormSet.GetHeaderText("LANG_APPYINV_PHONE",loFormSet.HeaderAlias))+"'"
*N000682,1 11/20/2012 MMT Globlization changes[End]


    *N000682,1 11/20/2012 MMT Globlization changes[Start]
*LCFILE_TTL = LANG_APPYINV_VENDORS
LCFILE_TTL = IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_VENDORS,loFormSet.GetHeaderText("LANG_APPYINV_VENDORS",loFormSet.HeaderAlias))
*N000682,1 11/20/2012 MMT Globlization changes[End]

    *N000682,1 MMT 11/22/2012 Globalization changes[end]
    IF BETWEEN(LNCLOSREC,1,RECCOUNT('APVENDOR'))
      GO LNCLOSREC
    ELSE
      GO TOP
    ENDIF
    *! E302623,2 MMT 10/12/2009 Convert Payable invoice screen to use SQL tables[Start]
    *=gfBrows(' ','CVENDCODE,CPHONENO,CVENCOMP','laTemp')
    *! E302623,3 MMT 01/03/2010 Convert Payable invoice screen to use SQL tables[Start]
    * =gfBrows(' ','CVENDCODE,CPHONENO,CVENCOMP','laTemp',lcFile_Ttl )
    =ARIABROW(' ', LCFILE_TTL , .F., .F., .F., .F., .F., .T., ;
      'CVENDCODE,CPHONENO,CVENCOMP', 'laTemp', .F., .F., .F., ;
      .F., .F., .F., .F., .F., ;
      .F., .F.)
    *! E302623,3 MMT 01/03/2010 Convert Payable invoice screen to use SQL tables[End]
    *! E302623,2 MMT 10/12/2009 Convert Payable invoice screen to use SQL tables[End]
    *lcBrFields = lcSavBrFld
    *lcFile_Ttl = lcSavTitle

    IF !EMPTY(LATEMP[1])
      LOFORMSET.LCVENDOR  = LATEMP[1]
      LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE = ALLTRIM(LATEMP[1])  &&lower
      LOFORMSET.LCPHONE   = LATEMP[2]
      LOFORMSET.ARIAFORM1.KBVENDPHONE.KEYTEXTBOX.VALUE = ALLTRIM(LATEMP[2])
      LOFORMSET.LCCOMPANY = LATEMP[3]
      LOFORMSET.ARIAFORM1.KBVENDCOMPANY.KEYTEXTBOX.VALUE = ALLTRIM(LATEMP[3])
      *Old: _CUROBJ   = OBJNUM(loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value)  &&lower&&Old CurObj
      *loFormSet.AriaForm1.kbInvNo.KeyTextBox.SetFocus()
    ELSE
      IF LCOBJNUM = '1'
        LOFORMSET.LCPHONE   = LOFORMSET.LCOLDPHONE
        LOFORMSET.ARIAFORM1.KBVENDPHONE.KEYTEXTBOX.VALUE = LOFORMSET.ARIAFORM1.KBVENDPHONE.KEYTEXTBOX.OLDVALUE
      ELSE
        LOFORMSET.LCCOMPANY = LOFORMSET.LCOLDCOMP
        LOFORMSET.ARIAFORM1.KBVENDCOMPANY.KEYTEXTBOX.VALUE = LOFORMSET.ARIAFORM1.KBVENDCOMPANY.KEYTEXTBOX.OLDVALUE
      ENDIF
    ENDIF
  ELSE
    IF !EOF()
      SKIP 1
      LCNXTPHONE = APVENDOR.CPHONENO
      LCNXTCOMP  = UPPER(ALLTRIM(APVENDOR.CVENCOMP))
      IF LCOBJNAME = IIF(LCOBJNUM = '1',LCNXTPHONE,LCNXTCOMP)
        LNCLOSREC  = RECNO(0)
        SKIP - 1
        DIMENSION LATEMP[3]

        LATEMP = ''

        *lcSavBrFld = lcBrFields
        *lcSavTitle = lcFile_Ttl
       *N000682,1 MMT 11/22/2012 Globalization changes[START]
        *LCBRFIELDS = "CVENDCODE :H= 'Vendor Code',;
                      CVENCOMP :H= 'Company',;
                      CPHONENO :H= 'Phone'"

        *LCFILE_TTL = "Vendor"
        LCBRFIELDS = "CVENDCODE :H= '"+IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_VENDORCODE,loFormSet.GetHeaderText("LANG_APPYINV_VENDORCODE",loFormSet.HeaderAlias))+"',;
                  CVENCOMP :H= '"+IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_COMPANY,loFormSet.GetHeaderText("LANG_APPYINV_COMPANY",loFormSet.HeaderAlias))+"',;
CPHONENO :H= '"+IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_PHONE,loFormSet.GetHeaderText("LANG_APPYINV_PHONE",loFormSet.HeaderAlias))+"'"



        *N000682,1 11/20/2012 MMT Globlization changes[Start]
*LCFILE_TTL = LANG_APPYINV_VENDORS
LCFILE_TTL = IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_VENDORS,loFormSet.GetHeaderText("LANG_APPYINV_VENDORS",loFormSet.HeaderAlias))
*N000682,1 11/20/2012 MMT Globlization changes[End]

       *N000682,1 MMT 11/22/2012 Globalization changes[end]

        IF BETWEEN(LNCLOSREC,1,RECCOUNT('APVENDOR'))
          GO LNCLOSREC
        ELSE
          GO TOP
        ENDIF

        IF LCOBJNUM = '1'
          *! E302623,2 MMT 10/12/2009 Convert Payable invoice screen to use SQL tables[Start]
          *=gfBrows([FOR CPHONENO = lcObjName],'CVENDCODE,CPHONENO,CVENCOMP','laTemp')
          *! E302623,3 MMT 01/03/2010 Convert Payable invoice screen to use SQL tables[Start]
          *=gfBrows([FOR CPHONENO = lcObjName],'CVENDCODE,CPHONENO,CVENCOMP','laTemp',lcFile_Ttl)
          =ARIABROW([FOR CPHONENO = lcObjName], LCFILE_TTL , .F., .F., .F., .F., .F., .T., ;
            'CVENDCODE,CPHONENO,CVENCOMP', 'laTemp', .F., .F., .F., ;
            .F., .F., .F., .F., .F., ;
            .F., .F.)
          *! E302623,3 MMT 01/03/2010 Convert Payable invoice screen to use SQL tables[End]
          *! E302623,2 MMT 10/12/2009 Convert Payable invoice screen to use SQL tables[End]
        ELSE
          *! E302623,2 MMT 10/12/2009 Convert Payable invoice screen to use SQL tables[Start]
          *=gfBrows([FOR UPPER(ALLTRIM(CVENCOMP)) = lcObjName],'CVENDCODE,CPHONENO,CVENCOMP','laTemp')
          *! E302623,3 MMT 01/03/2010 Convert Payable invoice screen to use SQL tables[Start]
          *=gfBrows([FOR UPPER(ALLTRIM(CVENCOMP)) = lcObjName],'CVENDCODE,CPHONENO,CVENCOMP','laTemp',lcFile_Ttl )
          =ARIABROW([FOR UPPER(ALLTRIM(CVENCOMP)) = lcObjName], LCFILE_TTL , .F., .F., .F., .F., .F., .T., ;
            'CVENDCODE,CPHONENO,CVENCOMP', 'laTemp', .F., .F., .F., ;
            .F., .F., .F., .F., .F., ;
            .F., .F.)
          *! E302623,3 MMT 01/03/2010 Convert Payable invoice screen to use SQL tables[End]
          *! E302623,2 MMT 10/12/2009 Convert Payable invoice screen to use SQL tables[End]
        ENDIF

        *lcBrFields = lcSavBrFld
        *lcFile_Ttl = lcSavTitle

        IF !EMPTY(LATEMP[1])
          LOFORMSET.LCVENDOR  = LATEMP[1]
          LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE = ALLTRIM(LATEMP[1])  &&lower
          LOFORMSET.LCPHONE   = LATEMP[2]
          LOFORMSET.ARIAFORM1.KBVENDPHONE.KEYTEXTBOX.VALUE = ALLTRIM(LATEMP[2])
          LOFORMSET.LCCOMPANY = LATEMP[3]
          LOFORMSET.ARIAFORM1.KBVENDCOMPANY.KEYTEXTBOX.VALUE = ALLTRIM(LATEMP[3])
          *Old: _CUROBJ   = OBJNUM(loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value)  &&lower&&Old CurObj
          *loFormSet.AriaForm1.kbInvNo.KeyTextBox.SetFocus()
        ELSE
          IF LCOBJNUM = '1'
            LOFORMSET.LCPHONE   = LOFORMSET.LCOLDPHONE
            LOFORMSET.ARIAFORM1.KBVENDPHONE.KEYTEXTBOX.VALUE = LOFORMSET.ARIAFORM1.KBVENDPHONE.KEYTEXTBOX.OLDVALUE
          ELSE
            LOFORMSET.LCCOMPANY = LOFORMSET.LCOLDCOMP
            LOFORMSET.ARIAFORM1.KBVENDCOMPANY.KEYTEXTBOX.VALUE = LOFORMSET.ARIAFORM1.KBVENDCOMPANY.KEYTEXTBOX.OLDVALUE
          ENDIF
        ENDIF
      ELSE
        SKIP - 1
        LOFORMSET.LCVENDOR  = CVENDCODE
        LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE = ALLTRIM(CVENDCODE)  &&lower
        LOFORMSET.LCPHONE   = CPHONENO
        LOFORMSET.ARIAFORM1.KBVENDPHONE.KEYTEXTBOX.VALUE = CPHONENO
        LOFORMSET.LCCOMPANY = CVENCOMP
        LOFORMSET.ARIAFORM1.KBVENDCOMPANY.KEYTEXTBOX.VALUE = CVENCOMP
        *Old: _CUROBJ   = OBJNUM(loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value)  &&lower&&Old CurObj
        *loFormSet.AriaForm1.kbInvNo.KeyTextBox.SetFocus()
      ENDIF
    ENDIF
  ENDIF
ELSE
  IF LCOBJNUM = '1'
    LOFORMSET.LCPHONE   = LOFORMSET.LCOLDPHONE
    LOFORMSET.ARIAFORM1.KBVENDPHONE.KEYTEXTBOX.VALUE = LOFORMSET.ARIAFORM1.KBVENDPHONE.KEYTEXTBOX.OLDVALUE
  ELSE
    LOFORMSET.LCCOMPANY = LOFORMSET.LCOLDCOMP
    LOFORMSET.ARIAFORM1.KBVENDCOMPANY.KEYTEXTBOX.VALUE = LOFORMSET.ARIAFORM1.KBVENDCOMPANY.KEYTEXTBOX.OLDVALUE
  ENDIF
ENDIF

SET EXACT &LCSAVEXACT

*Old: SHOW GET loFormSet.AriaForm1.KBVendCode.KeyTextBox.Value  &&lower &&Revise
*Old: SHOW GET ibVendor  ENABLE &&Revise
LOFORMSET.ARIAFORM1.KBVENDCODE.ENABLED = .T.
*Old: SHOW GET loFormSet.lcPhone   ENABLE &&Revise
*Old: SHOW GET ibPhone   ENABLE &&Revise
LOFORMSET.ARIAFORM1.KBVENDPHONE.ENABLED = .T.
*Old: SHOW GET loFormSet.lcCompany ENABLE &&Revise
*Old: SHOW GET ibCompany ENABLE &&Revise
LOFORMSET.ARIAFORM1.KBVENDCOMPANY.ENABLED = .T.
*Old: SHOW GET loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value  &&lower &&Revise
*Old: SHOW GET ibInvoice ENABLE &&Revise
LOFORMSET.ARIAFORM1.KBINVNO.ENABLED = .T.

SELECT APVENDOR
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*SET ORDER TO &lcSavOrder
=GFSETORDER(LCSAVORDER)
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

LOFORMSET.LLBROWSE = .F.

*Old: =lfRefresh()
LOFORMSET.REFRESH()

SELECT APINVHDR

*--end of lfvCompPhone

*:********************************************************************
*: Name      : lfGetBrHd
*: Developer : Ahmad Shoukry Mohammed (ASM)
*: Date      : 7/25/2004
*: Purpose   : Return the Brows Fields and its header
*!*************************************************************
*! Parameters: The FormSet
*!           : lcBrFile
*:********************************************************************
*: Returns            : lcBrReturn
*:********************************************************************
FUNCTION LFGETBRHD
PARAMETER LOFORMSET, LCBRFILE

PRIVATE LCBRRETURN

LCBRRETURN = ''
LCALIAS = ALIAS()
*! B610199,1 HIA 01/16/2013 Aria4xp-SM - Release to GL screen freezes once release is complete [T20121213.0012][Start]
*IF !USED('SYDFIELD')
*  *Old: =gfOpenFile(gcSysHome+'SYDFIELD','','SH')
*  =OARIAAPPLICATION.REMOTESYSTEMDATA.EXECUTE("SELECT * FROM sydField","", "sydField","",OARIAAPPLICATION.SYSTEMCONNECTIONSTRING,3 ,"",SET("Datasession"))
*ENDIF
IF !USED('AYDFIELD')
  =OARIAAPPLICATION.REMOTESYSTEMDATA.EXECUTE("SELECT * FROM sydField","", "AydField","",OARIAAPPLICATION.SYSTEMCONNECTIONSTRING,3 ,"",SET("Datasession"))
ENDIF
*! B610199,1 HIA 01/16/2013 Aria4xp-SM - Release to GL screen freezes once release is complete [T20121213.0012][END]

IF !USED('SYDFLFLD')
  *Old: =gfOpenFile(gcSysHome+'SYDFLFLD','','SH')
  =OARIAAPPLICATION.REMOTESYSTEMDATA.EXECUTE("SELECT * FROM SYDFLFLD","", "SYDFLFLD","",OARIAAPPLICATION.SYSTEMCONNECTIONSTRING,3 ,"",SET("Datasession"))
ENDIF

*! B610199,1 HIA 01/16/2013 Aria4xp-SM - Release to GL screen freezes once release is complete [T20121213.0012][Start]
*SELECT SYDFIELD.CFLD_NAME,SYDFIELD.CFLD_HEAD FROM SYDFIELD,SYDFLFLD WHERE ;
  SYDFLFLD.CFILE_NAM = LCBRFILE AND SYDFIELD.CFLD_NAME = SYDFLFLD.CFLD_NAME ;
  ORDER BY SYDFLFLD.NFLD_POS INTO ARRAY LAFLDNAME
SELECT AYDFIELD.CFLD_NAME,AYDFIELD.CFLD_HEAD FROM AYDFIELD,SYDFLFLD WHERE ;
  SYDFLFLD.CFILE_NAM = LCBRFILE AND AYDFIELD.CFLD_NAME = SYDFLFLD.CFLD_NAME ;
  ORDER BY SYDFLFLD.NFLD_POS INTO ARRAY LAFLDNAME
*! B610199,1 HIA 01/16/2013 Aria4xp-SM - Release to GL screen freezes once release is complete [T20121213.0012][End]

IF _TALLY <> 0
  
  LNCOUNT = 1
  *N000682,1 MMT 12/09/2012 Globalization changes[Start]
  IF oAriaApplication.oActivelang.cLang_ID <> "EN" AND TYPE('LOFORMSET.A27FIELD') = 'C' AND USED(LOFORMSET.A27FIELD)
     if  SEEK(ALLTRIM(LAFLDNAME[lnCount,1]) ,LOFORMSET.A27FIELD,LOFORMSET.A27FIELD)
         LAFLDNAME[lnCount,2]= ALLTRIM(EVALUATE(LOFORMSET.A27FIELD+'.langtext'))
     ENDIF 
  ENDIF
  *N000682,1 MMT 12/09/2012 Globalization changes[End]
  LNMAXCOLM = IIF(_TALLY-10 > 29,29,_TALLY-10)
  LCBRRETURN = LCBRRETURN + LAFLDNAME[lnCount,1] + " :H= '" + ALLTRIM(LAFLDNAME[lnCount,2]) + "'"
  FOR LNCOUNT = 2 TO LNMAXCOLM
    *N000682,1 MMT 12/09/2012 Globalization changes[Start]
    IF oAriaApplication.oActivelang.cLang_ID <> "EN" AND TYPE('LOFORMSET.A27FIELD') = 'C' AND USED(LOFORMSET.A27FIELD)
       if  SEEK(ALLTRIM(LAFLDNAME[lnCount,1]) ,LOFORMSET.A27FIELD,LOFORMSET.A27FIELD)
         LAFLDNAME[lnCount,2]= ALLTRIM(EVALUATE(LOFORMSET.A27FIELD+'.langtext'))
       ENDIF 
    ENDIF
   *N000682,1 MMT 12/09/2012 Globalization changes[End]
    LCBRRETURN = LCBRRETURN + ", "+ LAFLDNAME[lnCount,1] + " :H= '" + ALLTRIM(LAFLDNAME[lnCount,2]) + "'"
  ENDFOR
ENDIF
SELECT (LCALIAS)
RETURN LCBRRETURN


*!*************************************************************
*! Name      : lfGotFocus
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 8/1/2004
*! Purpose   : function Called from the GotFocus event for all the editabled controls
*!*************************************************************
*! Parameters: The Form
*!*************************************************************
*! Returns   : True or False
*!*************************************************************
FUNCTION LFGOTFOCUS
LPARAMETERS LOFORM


IF !EMPTY(LOFORM.DTPOSTDATE.TAG)
  LOFORM.DTPOSTDATE.SETFOCUS()
  RETURN .F.
ENDIF

*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*IF !EMPTY(loForm.dtInvDate.Tag)
*loForm.dtInvDate.SetFocus()
IF !EMPTY(LOFORM.PGFPAYINV.PGHEAD.DTINVDATE.TAG)
  LOFORM.PGFPAYINV.PGHEAD.DTINVDATE.SETFOCUS()
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  RETURN .F.
ENDIF
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*IF !EMPTY(loForm.txtInvAmount.Tag)
*loForm.txtInvAmount.SetFocus()
IF !EMPTY(LOFORM.PGFPAYINV.PGHEAD.TXTINVAMOUNT.TAG)
  LOFORM.PGFPAYINV.PGHEAD.TXTINVAMOUNT.SETFOCUS()
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  RETURN .F.
ENDIF

RETURN
*--end of lfGotFocus


*!*************************************************************
*! Name      : lfvPostdate
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 7/26/2004
*! Purpose   : To Validate of the Posting Date.
*!*************************************************************
*! Parameters: The FormSet
*!*************************************************************
*! Returns   : True or False
*!*************************************************************
FUNCTION LFVPOSTDATE
PARAMETERS LOFORMSET
LOCAL LCFISPRD, LCFISYER, LCM

IF !INLIST(LOFORMSET.ACTIVEMODE,'A','E')
  RETURN
ENDIF

IF LOFORMSET.LLLOKPER .AND. LOFORMSET.ACTIVEMODE="E"  &&lower

  IF LOFORMSET.ARIAFORM1.DTPOSTDATE.VALUE <> LOFORMSET.ARIAFORM1.DTPOSTDATE.OLDVALUE  &&lower

    =GFMODALGEN("TRM04163B00000" , "DIALOG" , 'it')

    LOFORMSET.ARIAFORM1.DTPOSTDATE.VALUE = LOFORMSET.ARIAFORM1.DTPOSTDATE.OLDVALUE
    *_CUROBJ    = _CUROBJ&&Old CurObj
    RETURN 0

  ELSE
    RETURN LFCHKINVPOSTDATE(LOFORMSET, LOFORMSET.ARIAFORM1.DTPOSTDATE)
  ENDIF

ENDIF



IF LOFORMSET.ARIAFORM1.DTPOSTDATE.VALUE = {}  &&lower

  IF GFMODALGEN("TRM04005B00006","DIALOG",'posting date cannot be empty') = 1
    *laScrMode    = .F.
    LOFORMSET.CHANGEMODE("S")
    LOFORMSET.LLINVCAN     = .T.
    *Old: SHOW GETS &&Revise
    * _CUROBJ      = OBJNUM(loFormSet.AriaForm1.KBVendCode.KeyTextBox.Value)  &&lower&&Old CurObj
    RETURN
  ELSE
    LOFORMSET.ARIAFORM1.DTPOSTDATE.VALUE = LOFORMSET.ARIAFORM1.DTPOSTDATE.OLDVALUE
    *_CUROBJ      = _CUROBJ&&Old CurObj
    RETURN 0
  ENDIF
ELSE
  LCFISPRD = LOFORMSET.LCFISPRD
  LCFISYER = LOFORMSET.LCFISYER
  IF LFVDTMSG(OARIAAPPLICATION.PRNTCOMPANYID,@LCFISPRD,@LCFISYER,LOFORMSET.ARIAFORM1.DTPOSTDATE)
    LOFORMSET.LCFISPRD = LCFISPRD
    LOFORMSET.LCFISYER = LCFISYER
    LOFORMSET.LCDISTPRD = LOFORMSET.LCFISPRD
    LOFORMSET.LCDISTYER = LOFORMSET.LCFISYER
    *_CUROBJ   = OBJNUM(loFormSet.AriaForm1.DtInvDate.Value)  &&lower&&Old CurObj
  ELSE
    LOFORMSET.ARIAFORM1.DTPOSTDATE.VALUE = LOFORMSET.ARIAFORM1.DTPOSTDATE.OLDVALUE  &&lower
    *_CUROBJ    = _CUROBJ&&Old CurObj
    RETURN 0
  ENDIF
ENDIF

*Old: SHOW GET loFormSet.AriaForm1.DtPostDate.Value  &&lower &&Revise
*E303001,1 TMI 11/30/2011 [Start] get the function result in a variable
*RETURN LFCHKINVPOSTDATE(LOFORMSET, LOFORMSET.ARIAFORM1.DTPOSTDATE)
*RETURN lfChkInvPostDate(loFormSet, loFormSet.AriaForm1.DtPostDate)
IF LFCHKINVPOSTDATE(LOFORMSET, LOFORMSET.ARIAFORM1.DTPOSTDATE) = 0
  RETURN 0
ENDIF
*- update the fiscal year & period in APINVHDR
REPLACE APINVHDR.CFSPPRDID WITH LOFORMSET.LCFISPRD
REPLACE APINVHDR.CFISFYEAR WITH LOFORMSET.LCFISYER

RETURN 1
*E303001,1 TMI 11/30/2011 [End  ]
*--end of lfvPostdate


*!*************************************************************
*! Name      : lfChkInvPostDate
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 7/27/2004
*! Purpose   : To Make sure the Invoice Date is not After the Posting Date.
*!*************************************************************
*! Parameters: The FormSet
*!           : The Control Being Edited
*!*************************************************************
*! Returns   : True or False
*!*************************************************************
FUNCTION LFCHKINVPOSTDATE
PARAMETERS LOFORMSET, LOCONTROL

IF TYPE('APINVHDR.DPOSTDATE') = 'D'
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *  IF loFormSet.AriaForm1.DtInvDate.Value > loFormSet.AriaForm1.DtPostDate.Value  &&lower  &&lower
  IF LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.DTINVDATE.VALUE > LOFORMSET.ARIAFORM1.DTPOSTDATE.VALUE  &&lower  &&lower
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
	*N000682,1 MMT 12/09/2012 Globalization changes[Start]
	*IF GFMODALGEN("TRM04197B04012","DIALOG","invoices|"+LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE) = 1  &&lower
    IF GFMODALGEN("TRM04197B04012","DIALOG",;
	IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_INVOICESTITLE,LOFORMSET.GetHeaderText("LANG_APPYINV_INVOICESTITLE",LOFORMSET.HeaderAlias))+"|"+LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE) = 1  &&lower
	*N000682,1 MMT 12/09/2012 Globalization changes[End]
      LOFORMSET.ARIAFORM1.DTPOSTDATE.VALUE   = LOFORMSET.ARIAFORM1.DTPOSTDATE.OLDVALUE  &&lower
      *_CUROBJ = _CUROBJ&&Old CurObj
      *Old: SHOW GET loFormSet.AriaForm1.DtPostDate.Value  &&lower &&Revise
      RETURN 0
    ENDIF
  ENDIF
ENDIF

LOCONTROL.TAG=''

RETURN 1
*--end of lfChkInvPostDate


*!*************************************************************
*! Name      : lfvInvDate
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 7/26/2004
*! Purpose   : To Validate the Invoice Date.
*!*************************************************************
*! Parameters: The FormSet
*!*************************************************************
*! Returns   : True or False
*!*************************************************************
FUNCTION LFVINVDATE
PARAMETERS LOFORMSET
LOCAL LCFISPRD, LCFISYER, LCEXSIN2

IF !INLIST(LOFORMSET.ACTIVEMODE,'A','E')
  RETURN
ENDIF

*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*IF loFormSet.AriaForm1.DtInvDate.Value = {}  &&lower
IF LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.DTINVDATE.VALUE = {}  &&lower
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  IF GFMODALGEN("TRM04005B00006","DIALOG",'date cannot be empty') = 1
    *laScrMode    = .F.
    LOFORMSET.CHANGEMODE="S"
    LOFORMSET.LLINVCAN     = .T.
    *Old: SHOW GETS &&Revise
    *_CUROBJ      = OBJNUM(loFormSet.AriaForm1.KBVendCode.KeyTextBox.Value)  &&lower&&Old CurObj
    RETURN .T.
  ELSE
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *    loFormSet.AriaForm1.DtInvDate.Value   = loFormSet.ldOldData  &&lower
    LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.DTINVDATE.VALUE   = LOFORMSET.LDOLDDATA  &&lower
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    *_CUROBJ      = _CUROBJ&&Old CurObj
    RETURN 0
  ENDIF
ELSE
  *E303001,1 TMI 11/30/2011 [Start] Not to call the function lfVDtMsg that gets and validate fiscal year and period
  *!*	  PRIVATE LCOLDFISPD , LCOLDFISYR
  *!*	  LCOLDFISPD = LOFORMSET.LCFISPRD
  *!*	  LCOLDFISYR = LOFORMSET.LCFISYER
  *!*	  LOFORMSET.LCFISPRD = ''
  *!*	  LOFORMSET.LCFISYER = ''

  *!*	  LCFISPRD = LOFORMSET.LCFISPRD
  *!*	  LCFISYER = LOFORMSET.LCFISYER
  *!*	  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	  *  =lfVDtMsg(oAriaApplication.PrntCompanyID,@lcFisPrd,@lcFisYer,loFormSet.AriaForm1.DtInvDate.Value)
  *!*	  =LFVDTMSG(OARIAAPPLICATION.PRNTCOMPANYID,@LCFISPRD,@LCFISYER,LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.DTINVDATE.VALUE)
  *!*	  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  *!*	  LOFORMSET.LCFISPRD = LCFISPRD
  *!*	  LOFORMSET.LCFISYER = LCFISYER


  *!*	  IF !EMPTY(LOFORMSET.LCFISPRD) .AND. !EMPTY(LOFORMSET.LCFISYER)

  *!*	    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	    *!*	    REPLACE apinvhdr.cfspprdid WITH loFormSet.lcFisPrd
  *!*	    *!*	    REPLACE apinvhdr.cfisfyear WITH loFormSet.lcFisYer
  *!*	    SELECT APINVHDR
  *!*	    GFREPLACE("cfspprdid WITH '"+LOFORMSET.LCFISPRD+"'")
  *!*	    GFREPLACE("cfisfyear WITH '"+LOFORMSET.LCFISYER+"'")
  *!*	    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

  *E303001,1 TMI 11/30/2011 [Start] Not to call the function lfVDtMsg that gets and validate fiscal year and period
  IF LOFORMSET.ACTIVEMODE="A"  &&lower
    IF GFGETMEMVAR('LLMULCURR')
      PRIVATE LNCURRUNIT
      LNCURRUNIT = 0

      DO CASE
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        *!*	          CASE loFormSet.AriaForm1.DtInvDate.Value <> loFormSet.AriaForm1.DtInvDate.OldValue ;
        *!*	               .AND. EMPTY(loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value)
        *!*	            loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value = ;
        *!*	               IIF(EMPTY(APVENDOR.CCURRCODE),oAriaApplication.BaseCurrency,APVENDOR.CCURRCODE)
        *!*	            loFormSet.AriaForm1.txtNexRate.Value = ;
        *!*	               gfChkRate('lnCurrUnit',loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value,;
        *!*	               loFormSet.AriaForm1.DtInvDate.Value,.T.)
        *REPLACE apinvhdr.ncurrunit WITH lnCurrUnit
        *!*	          CASE loFormSet.AriaForm1.DtInvDate.Value <> loFormSet.AriaForm1.DtInvDate.OldValue ;
        *!*	               .AND. !EMPTY(loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value)
        *!*	            loFormSet.AriaForm1.txtNexRate.Value = ;
        *!*	               gfChkRate('lnCurrUnit',loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value,;
        *!*	               loFormSet.AriaForm1.DtInvDate.Value,.T.)
        *REPLACE apinvhdr.ncurrunit WITH lnCurrUnit
        *!*	          CASE EMPTY(loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value)  &&lower
        *!*	            loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value = ;
        *!*	               IIF(EMPTY(APVENDOR.CCURRCODE),oAriaApplication.BaseCurrency,APVENDOR.CCURRCODE)
        *!*	            loFormSet.AriaForm1.txtNexRate.Value = ;
        *!*	               gfChkRate('lnCurrUnit',loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value,;
        *!*	               loFormSet.AriaForm1.DtInvDate.Value,.T.)
        *REPLACE apinvhdr.ncurrunit WITH lnCurrUnit
      CASE LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.DTINVDATE.VALUE <> LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.DTINVDATE.OLDVALUE ;
          .AND. EMPTY(LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.KEYTEXTBOX.VALUE)
        LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.KEYTEXTBOX.VALUE = ;
          IIF(EMPTY(APVENDOR.CCURRCODE),OARIAAPPLICATION.BASECURRENCY,APVENDOR.CCURRCODE)


        LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTNEXRATE.VALUE = ;
          GFCHKRATE('lnCurrUnit',LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.KEYTEXTBOX.VALUE,;
          LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.DTINVDATE.VALUE,.T.)


        GFREPLACE("ncurrunit WITH lnCurrUnit")


      CASE LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.DTINVDATE.VALUE <> LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.DTINVDATE.OLDVALUE ;
          .AND. !EMPTY(LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.KEYTEXTBOX.VALUE)
        LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTNEXRATE.VALUE = ;
          GFCHKRATE('lnCurrUnit',LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.KEYTEXTBOX.VALUE,;
          LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.DTINVDATE.VALUE,.T.)


        GFREPLACE("ncurrunit WITH lnCurrUnit")


      CASE EMPTY(LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.KEYTEXTBOX.VALUE)  &&lower
        LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.KEYTEXTBOX.VALUE = ;
          IIF(EMPTY(APVENDOR.CCURRCODE),OARIAAPPLICATION.BASECURRENCY,APVENDOR.CCURRCODE)


        LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTNEXRATE.VALUE = ;
          GFCHKRATE('lnCurrUnit',LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.KEYTEXTBOX.VALUE,;
          LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.DTINVDATE.VALUE,.T.)


        GFREPLACE("ncurrunit WITH lnCurrUnit")
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      ENDCASE

      LOFORMSET.LCEXSIN2 = ' '
      LCEXSIN2 = LOFORMSET.LCEXSIN2

      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *loFormSet.lcExSin1 = gfGetExSin(@lcExSin2,loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value)  &&lower
      LOFORMSET.LCEXSIN1 = GFGETEXSIN(@LCEXSIN2,LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.KEYTEXTBOX.VALUE)  &&lower
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

      LOFORMSET.LCEXSIN2 = LCEXSIN2


      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *IF loFormSet.AriaForm1.txtNexRate.Value = 0  &&lower
      *loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value = oAriaApplication.BaseCurrency
      *loFormSet.AriaForm1.txtNexRate.Value = 1  &&lower
      *REPLACE apinvhdr.ncurrunit WITH 1  &&lower
      IF LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTNEXRATE.VALUE = 0  &&lower
        LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.KEYTEXTBOX.VALUE = OARIAAPPLICATION.BASECURRENCY
        LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTNEXRATE.VALUE = 1  &&lower
        GFREPLACE("ncurrunit WITH 1")
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      ENDIF
      *Old: SHOW GET loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value ENABLE  &&lower &&Revise

      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *!*	        loFormSet.AriaForm1.kbCurrCode.Enabled = .T.
      *!*	        IF gfGetMemVar('LLEDITEXRA') .AND. ;
      *!*	          loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value <> oAriaApplication.BaseCurrency
      *!*	loFormSet.AriaForm1.txtNexRate.Enabled = .T.
      LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.ENABLED = .T.
      IF GFGETMEMVAR('LLEDITEXRA') .AND. ;
          LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.KEYTEXTBOX.VALUE <> OARIAAPPLICATION.BASECURRENCY
        LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTNEXRATE.ENABLED = .T.
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
        *Old: SHOW GET loFormSet.AriaForm1.txtNexRate.Value ENABLE  &&lower &&Revise

      ELSE
        *Old: SHOW GET loFormSet.AriaForm1.txtNexRate.Value DISABLE  &&lower &&Revise
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        *loFormSet.AriaForm1.txtNexRate.Enabled = .F.
        LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTNEXRATE.ENABLED = .F.
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

      ENDIF
    ELSE
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value = oAriaApplication.BaseCurrency  &&lower  &&lower
      *loFormSet.AriaForm1.txtNexRate.Value = 1  &&lower
      LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.KEYTEXTBOX.VALUE = OARIAAPPLICATION.BASECURRENCY  &&lower  &&lower
      LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTNEXRATE.VALUE = 1  &&lower
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

      REPLACE APINVHDR.NCURRUNIT WITH 1  &&lower
      *Old: SHOW GET loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value DISABLE  &&lower &&Revise
      *Old: SHOW GEt ibCurrency DISABLE &&Revise

      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *loFormSet.AriaForm1.kbCurrCode.Enabled = .F.
      LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.ENABLED = .F.
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

      *Old: SHOW GET loFormSet.AriaForm1.txtNexRate.Value DISABLE  &&lower &&Revise
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *loFormSet.AriaForm1.txtNexRate.Enabled = .F.
      LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTNEXRATE.ENABLED = .F.
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

    ENDIF
  ELSE
    *Old: SHOW GET loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value DISABLE  &&lower &&Revise
    *Old: SHOW GEt ibCurrency DISABLE &&Revise

    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *loFormSet.AriaForm1.kbCurrCode.Enabled = .F.
    LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.ENABLED = .F.
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

    *Old: SHOW GET loFormSet.AriaForm1.txtNexRate.Value DISABLE  &&lower &&Revise

    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *loFormSet.AriaForm1.txtNexRate.Enabled = .F.
    LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTNEXRATE.ENABLED = .F.
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

  ENDIF
  *_CUROBJ    = OBJNUM(loFormSet.AriaForm1.txtInvAmount.Value)  &&lower&&Old CurObj
  *RETURN .T.
  *E303001,1 TMI 11/30/2011 [Start] no need for this ELS as the original IF was commented
  *!*	  ELSE

  *!*	    LOFORMSET.LCFISPRD = LCOLDFISPD
  *!*	    LOFORMSET.LCFISYER = LCOLDFISYR

  *!*	    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	    *loFormSet.AriaForm1.DtInvDate.Value = loFormSet.AriaForm1.DtInvDate.OldValue  &&lower
  *!*	    LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.DTINVDATE.VALUE = LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.DTINVDATE.OLDVALUE  &&lower
  *!*	    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

  *!*	    *_CUROBJ    = _CUROBJ&&Old CurObj
  *!*	    RETURN 0
  *!*	  ENDIF
  *E303001,1 TMI 11/30/2011 [Start] no need for this ELS as the original IF was commented
ENDIF

*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*IF lfChkInvPostDate(loFormSet, loFormSet.AriaForm1.DtInvDate) = 0
IF LFCHKINVPOSTDATE(LOFORMSET, LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.DTINVDATE) = 0
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  RETURN 0
ENDIF

*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*loFormSet.AriaForm1.dtInvDuDat.Value  = lfGetdueD(loFormSet.AriaForm1.DtInvDate.Value,loFormSet.AriaForm1.txtterdued.Value,loFormSet.lnEomDay)  &&lower  &&lower  &&lower
*! B609614,1 MMT 06/13/2011 Fix bug of wrong AP invoice Due date[Start]
*loFormSet.AriaForm1.pgfpayInv.pgHead.dtInvDuDat.VALUE  = lfGetdueD(loFormSet.AriaForm1.pgfpayInv.pgHead.DtInvDate.VALUE,loFormSet.AriaForm1.pgfpayInv.pgHead.txtterdued.VALUE,loFormSet.lnEomDay)  &&lo
LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.DTINVDUDAT.VALUE  = LFGETDUED(LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.DTINVDATE.VALUE,LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTTERDUED.VALUE,LOFORMSET.LNEOMDAY,LOFORMSET.LCEOM)  &&lower  &&lower  &&lower)  &&lower  &&lower  &&lower
*! B609614,1 MMT 06/13/2011 Fix bug of wrong AP invoice Due date[End]
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
*! E302623,3 MMT 01/03/2010 Convert Payable invoice screen to use SQL tables[Start]
LFINVDTINIT(LOFORMSET,LOFORMSET.ARIAFORM1.PGFPAYINV.PGDET)
*! E302623,3 MMT 01/03/2010 Convert Payable invoice screen to use SQL tables[End]
*Old: SHOW GET loFormSet.AriaForm1.dtInvDuDat.Value  &&lower &&Revise
*Old: SHOW GET loFormSet.AriaForm1.DtInvDate.Value  &&lower &&Revise

RETURN
*--end of lfvInvDate


*!*************************************************************
*! Name      : lfvInvAmount
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 7/26/2004
*! Purpose   : Function called from the Valid of the Invoice Amount.
*!*************************************************************
*! Parameters: The FormSet
*!*************************************************************
*! Returns   : True or False
*!*************************************************************
FUNCTION LFVINVAMOUNT
PARAMETERS LOFORMSET
LOCAL LCEXSIN2, LCEXPR

IF !INLIST(LOFORMSET.ACTIVEMODE,'A','E')
  RETURN
ENDIF
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*IF loFormSet.llLokPer .AND. loFormSet.ActiveMode="E" .AND. ;
loFormSet.AriaForm1.txtInvAmount.Value <> loFormSet.AriaForm1.txtInvAmount.OldValue
IF LOFORMSET.LLLOKPER .AND. LOFORMSET.ACTIVEMODE="E" .AND. ;
    LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTINVAMOUNT.VALUE <> LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTINVAMOUNT.OLDVALUE
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  *N000682,1 MMT 11/22/2012 Globalization changes[Start]
  *=GFMODALGEN("TRM04163B00000" , "DIALOG" , 'the invoice amount')
  *N000682,1 11/20/2012 MMT Globlization changes[Start]
*=GFMODALGEN("TRM04163B00000" , "DIALOG" , LANG_APPYINV_INVOICE_AMOUNT)
=GFMODALGEN("TRM04163B00000" , "DIALOG" , IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_INVOICE_AMOUNT,loFormSet.GetHeaderText("LANG_APPYINV_INVOICE_AMOUNT",loFormSet.HeaderAlias)))
*N000682,1 11/20/2012 MMT Globlization changes[End]

  *N000682,1 MMT 11/22/2012 Globalization changes[END]
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *loFormSet.AriaForm1.txtInvAmount.Value = loFormSet.AriaForm1.txtInvAmount.OldValue
  LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTINVAMOUNT.VALUE = LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTINVAMOUNT.OLDVALUE
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

  *_CUROBJ    = _CUROBJ&&Old CurObj
  RETURN 0
ENDIF


*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*IF loFormSet.AriaForm1.txtInvAmount.Value = 0  &&lower
IF LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTINVAMOUNT.VALUE = 0  &&lower
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  IF LOFORMSET.ACTIVEMODE="A"  &&lower

    IF GFMODALGEN("TRM04005B00006","DIALOG",LOFORMSET.LCTINVAMNT) = 1
      *_CUROBJ  = OBJNUM(loFormSet.AriaForm1.DtPostDate.Value)  &&lower&&Old CurObj
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *!*	      STORE 'x' TO loFormSet.AriaForm1.dtPostDate.Tag, loFormSet.AriaForm1.dtInvDate.Tag, ;
      *!*	        loFormSet.AriaForm1.txtInvAmount.Tag
      STORE 'x' TO LOFORMSET.ARIAFORM1.DTPOSTDATE.TAG, LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.DTINVDATE.TAG, ;
        LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTINVAMOUNT.TAG
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      RETURN -2
    ELSE

      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *loFormSet.AriaForm1.txtInvAmount.Value = loFormSet.AriaForm1.txtInvAmount.OldValue  &&lower
      LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTINVAMOUNT.VALUE = LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTINVAMOUNT.OLDVALUE  &&lower
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

      *_CUROBJ    = _CUROBJ&&Old CurObj
      RETURN 0
    ENDIF
  ELSE
    =GFMODALGEN("TRM04072B00000","DIALOG",LOFORMSET.LCTINVAMNU+"|"+'0')

    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *    loFormSet.AriaForm1.txtInvAmount.Value = loFormSet.AriaForm1.txtInvAmount.OldValue  &&lower
    LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTINVAMOUNT.VALUE = LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTINVAMOUNT.OLDVALUE  &&lower
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

    *_CUROBJ    = _CUROBJ&&Old CurObj
    RETURN 0
  ENDIF
ELSE
  LNVENCRAVL = APVENDOR.NVENCRLIM - ROUND(APVENDOR.NVENBAL,0)
  IF LOFORMSET.ACTIVEMODE="E"  &&lower
    *Old: lnVenCrAvl = lnVenCrAvl + APINVHDR.nInvAmnt
    LNVENCRAVL = LNVENCRAVL + OLDVAL('APINVHDR.nInvAmnt')
  ENDIF
  LOFORMSET.LCEXSIN2 = ' '
  LCEXSIN2 = LOFORMSET.LCEXSIN2

  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *  loFormSet.lcExSin1 = gfGetExSin(@lcExSin2,loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value)  &&lower
  LOFORMSET.LCEXSIN1 = GFGETEXSIN(@LCEXSIN2,LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.KEYTEXTBOX.VALUE)  &&lower
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

  LOFORMSET.LCEXSIN2 = LCEXSIN2

  *Old: IF ROUND(laData[12] &lcExSin1 laData[45] &lcExSin2 laData[48],2) > lnVenCrAvl .AND. APVENDOR.NVENCRLIM <> 0
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	  lcExpr=STR(loFormSet.AriaForm1.txtInvAmount.Value,12,3)+loFormSet.lcExSin1+;
  *!*	         STR(loFormSet.AriaForm1.txtNexRate.Value,12,3)+loFormSet.lcExSin2+STR(apinvhdr.ncurrunit,12,3)
  LCEXPR=STR(LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTINVAMOUNT.VALUE,12,3)+LOFORMSET.LCEXSIN1+;
    STR(LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTNEXRATE.VALUE,12,3)+LOFORMSET.LCEXSIN2+STR(APINVHDR.NCURRUNIT,12,3)
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][Start]
  TRY
    *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][End]
    IF ROUND(&LCEXPR,2) > LNVENCRAVL .AND. APVENDOR.NVENCRLIM <> 0

      =GFMODALGEN("TRM04043B00000","DIALOG",;
        ALLTRIM(STR(ROUND(&LCEXPR,2) - LNVENCRAVL,15,2)))
    ENDIF
    *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][Start]
  CATCH
  ENDTRY
  *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][End]
  IF LOFORMSET.ACTIVEMODE="E"     && Edit Mode  &&lower
    DO CASE
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *CASE SIGN(loFormSet.AriaForm1.txtInvAmount.OldValue) <> SIGN(loFormSet.AriaForm1.txtInvAmount.Value)  &&lower
    CASE SIGN(LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTINVAMOUNT.OLDVALUE) <> SIGN(LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTINVAMOUNT.VALUE)  &&lower
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

      =GFMODALGEN("TRM04008B00000","DIALOG")
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *loFormSet.AriaForm1.txtInvAmount.Value = loFormSet.AriaForm1.txtInvAmount.OldValue  &&lower
      LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTINVAMOUNT.VALUE = LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTINVAMOUNT.OLDVALUE  &&lower
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

      *_CUROBJ    = _CUROBJ&&Old CurObj
      RETURN 0

      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *!*	      CASE loFormSet.AriaForm1.txtInvAmount.OldValue > 0 AND ;
      *!*	           loFormSet.AriaForm1.txtInvAmount.Value < apinvhdr.ninvamtap + ;
      *!*	           apinvhdr.ninvdisap + apinvhdr.ninvadjap
    CASE LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTINVAMOUNT.OLDVALUE > 0 AND ;
        LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTINVAMOUNT.VALUE < APINVHDR.NINVAMTAP + ;
        APINVHDR.NINVDISAP + APINVHDR.NINVADJAP
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      =GFMODALGEN("TRM04009B00000","DIALOG")

      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *        loFormSet.AriaForm1.txtInvAmount.Value = loFormSet.AriaForm1.txtInvAmount.OldValue
      LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTINVAMOUNT.VALUE = LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTINVAMOUNT.OLDVALUE
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

      *_CUROBJ    = _CUROBJ&&Old CurObj
      RETURN 0

      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *!*	      CASE loFormSet.AriaForm1.txtInvAmount.OldValue < 0  AND ;
      *!*	           ABS(loFormSet.AriaForm1.txtInvAmount.Value) < ;
      *!*	           ABS(apinvhdr.ninvamtap + apinvhdr.ninvdisap + apinvhdr.ninvadjap)
    CASE LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTINVAMOUNT.OLDVALUE < 0  AND ;
        ABS(LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTINVAMOUNT.VALUE) < ;
        ABS(APINVHDR.NINVAMTAP + APINVHDR.NINVDISAP + APINVHDR.NINVADJAP)
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

      =GFMODALGEN("TRM04009B00000","DIALOG")

      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *!*	        loFormSet.AriaForm1.txtInvAmount.Value = loFormSet.AriaForm1.txtInvAmount.OldValue
      LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTINVAMOUNT.VALUE = LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTINVAMOUNT.OLDVALUE
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

      *_CUROBJ    = _CUROBJ&&Old CurObj
      RETURN 0

      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *      CASE ABS(loFormSet.AriaForm1.txtInvAmount.Value) < ABS(apinvhdr.ninvpaid + apinvhdr.ninvdistk + apinvhdr.ninvadj)
    CASE ABS(LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTINVAMOUNT.VALUE) < ABS(APINVHDR.NINVPAID + APINVHDR.NINVDISTK + APINVHDR.NINVADJ)
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

      =GFMODALGEN("TRM04010B00000","DIALOG")

      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *loFormSet.AriaForm1.txtInvAmount.Value = loFormSet.AriaForm1.txtInvAmount.OldValue  &&lower
      LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTINVAMOUNT.VALUE = LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTINVAMOUNT.OLDVALUE  &&lower
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

      *_CUROBJ    = _CUROBJ&&Old CurObj
      RETURN 0
    ENDCASE
  ELSE

    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *!*	    IF loFormSet.ActiveMode="A" .AND. loFormSet.AriaForm1.txtInvAmount.Value < 0 .AND. ;
    *!*	       SIGN(loFormSet.AriaForm1.txtInvAmount.OldValue) <> SIGN(loFormSet.AriaForm1.txtInvAmount.Value)
    IF LOFORMSET.ACTIVEMODE="A" .AND. LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTINVAMOUNT.VALUE < 0 .AND. ;
        SIGN(LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTINVAMOUNT.OLDVALUE) <> SIGN(LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTINVAMOUNT.VALUE)
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

      IF GFMODALGEN("TRM04006B00006","DIALOG") = 2
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        *   loFormSet.AriaForm1.txtInvAmount.Value = 0  &&lower
        LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTINVAMOUNT.VALUE = 0  &&lower
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

        *_CUROBJ    = _CUROBJ&&Old CurObj
        LOFORMSET.LLDEBITM  = .F.
        RETURN 0
      ELSE
        LOFORMSET.LLDEBITM  = .T.

        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        *!*	        IF loFormSet.AriaForm1.cboVendPmeth.Value = 'C'  &&lower
        *!*	          loFormSet.AriaForm1.cboVendPmeth.Value  = 'P'  &&lower
        *!*	          loFormSet.lcPayMethd = loFormSet.laPayMethd[AT(loFormSet.AriaForm1.cboVendPmeth.Value,'PMNCH'),1]  &&lower
        IF LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.CBOVENDPMETH.VALUE = 'C'  &&lower
          LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.CBOVENDPMETH.VALUE  = 'P'  &&lower
          LOFORMSET.LCPAYMETHD = LOFORMSET.LAPAYMETHD[AT(loFormSet.AriaForm1.pgfpayInv.pgHead.cboVendPmeth.Value,'PMNCH'),1]  &&lower
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
          *Old: SHOW GET pbApprove,1 PROMPT '\<Approve for payment...' &&Revise
          *loFormSet.AriaForm1.cmdApprove.Caption = '\<Approve for payment...'
          *=lfRefresh()
        ENDIF
      ENDIF
    ENDIF
  ENDIF

  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	  IF ABS(loFormSet.AriaForm1.txtInvAmount.Value) < ;
  *!*	     ABS(apinvhdr.ninvamtap + apinvhdr.ninvdisap + ;
  *!*	     apinvhdr.ninvadjap) .AND. loFormSet.AriaForm1.cboVendPmeth.Value <> 'C'
  IF ABS(LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTINVAMOUNT.VALUE) < ;
      ABS(APINVHDR.NINVAMTAP + APINVHDR.NINVDISAP + ;
      APINVHDR.NINVADJAP) .AND. LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.CBOVENDPMETH.VALUE <> 'C'
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

    =GFMODALGEN("TRM04009B00000","DIALOG")

    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *    loFormSet.AriaForm1.txtInvAmount.Value = loFormSet.AriaForm1.txtInvAmount.OldValue
    LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTINVAMOUNT.VALUE = LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTINVAMOUNT.OLDVALUE
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

    *_CUROBJ    = _CUROBJ&&Old CurObj
    RETURN 0
  ENDIF
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	  IF loFormSet.AriaForm1.txtInvAmount.Value-apinvhdr.ninvpaid-apinvhdr.ninvdistk = 0 .AND. ;
  *!*	     loFormSet.AriaForm1.cboVendPmeth.Value <> 'C'
  IF LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTINVAMOUNT.VALUE-APINVHDR.NINVPAID-APINVHDR.NINVDISTK = 0 .AND. ;
      LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.CBOVENDPMETH.VALUE <> 'C'
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

    LOFORMSET.LCAPRSTAT = 'DISABLE'
    *Old: SHOW GET pbApprove &loFormSet.lcAprStat &&Revise
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *    loFormSet.AriaForm1.cmdApprove.Enabled = (loFormSet.lcAprStat='ENABLE')
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  ELSE
    LOFORMSET.LCAPRSTAT = 'ENABLE'
    *Old: SHOW GET pbApprove &loFormSet.lcAprStat &&Revise
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *loFormSet.AriaForm1.cmdApprove.Enabled = (loFormSet.lcAprStat='ENABLE')
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  ENDIF
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	  IF loFormSet.AriaForm1.txtInvAmount.Value > 0  &&lower
  *!*	    IF loFormSet.AriaForm1.txtInvAmount.Value <> loFormSet.AriaForm1.txtInvAmount.OldValue .OR. ;
  *!*	       loFormSet.AriaForm1.txtInvDisof.Value = 0
  *!*	      loFormSet.AriaForm1.txtInvDisof.Value = (loFormSet.AriaForm1.txtTerDiscr.Value * loFormSet.AriaForm1.txtInvAmount.Value) / 100
  IF LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTINVAMOUNT.VALUE > 0  &&lower
    IF LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTINVAMOUNT.VALUE <> LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTINVAMOUNT.OLDVALUE .OR. ;
        LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTINVDISOF.VALUE = 0
      LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTINVDISOF.VALUE = (LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTTERDISCR.VALUE * LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTINVAMOUNT.VALUE) / 100
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    ENDIF
    *Old: SHOW GET pbDiscount ENABLE &&Revise
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *loFormSet.AriaForm1.cmdDiscount.Enabled = .T.
    LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.CMDDISCOUNT.ENABLED = .T.
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    *Old: SHOW GET loFormSet.AriaForm1.txtInvDisof.Value ENABLE  &&lower &&Revise

    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *loFormSet.AriaForm1.txtInvDisof.Enabled = .T.
    LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTINVDISOF.ENABLED = .T.
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

  ELSE

    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *loFormSet.AriaForm1.txtInvDisof.Value = 0  &&lower
    LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTINVDISOF.VALUE = 0  &&lower
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

    *Old: SHOW GET pbDiscount DISABLE &&Revise

    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *loFormSet.AriaForm1.cmdDiscount.Enabled = .F.
    LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.CMDDISCOUNT.ENABLED = .F.
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

    *Old: SHOW GET loFormSet.AriaForm1.txtInvDisof.Value DISABLE  &&lower &&Revise

    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *loFormSet.AriaForm1.txtInvDisof.Enabled = .F.
    LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTINVDISOF.ENABLED = .F.
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

  ENDIF
  *Old: SHOW GET loFormSet.AriaForm1.txtInvAmount.Value  &&lower &&Revise
ENDIF

*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*!*	IF loFormSet.AriaForm1.txtInvAmount.Value = 0 .AND. ;
*!*	   (loFormSet.ActiveMode="A" .OR. loFormSet.ActiveMode="S")
IF LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTINVAMOUNT.VALUE = 0 .AND. ;
    (LOFORMSET.ACTIVEMODE="A" .OR. LOFORMSET.ACTIVEMODE="S")
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

  LOFORMSET.LCDISTSTAT = 'DISABLE'
  *Old: SHOW GET pbDisLine DISABLE &&Revise
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *loFormSet.AriaForm1.cmdDisLine.Enabled = (loFormSet.lcDistStat='ENABLE')
  LOFORMSET.ARIAFORM1.PGFPAYINV.PGDIST.ENABLED = (LOFORMSET.LCDISTSTAT='ENABLE')
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

ELSE
  LOFORMSET.LCDISTSTAT = 'ENABLE'
  *Old: SHOW GET pbDisLine ENABLE &&Revise

  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *loFormSet.AriaForm1.cmdDisLine.Enabled = (loFormSet.lcDistStat='ENABLE')
  LOFORMSET.ARIAFORM1.PGFPAYINV.PGDIST.ENABLED = (LOFORMSET.LCDISTSTAT='ENABLE')
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

ENDIF

*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*IF loFormSet.AriaForm1.txtInvAmount.Value <> loFormSet.AriaForm1.txtInvAmount.OldValue
IF LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTINVAMOUNT.VALUE <> LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTINVAMOUNT.OLDVALUE
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  SELECT(LOFORMSET.LCTMPDIST)
  DO CASE
  CASE LOFORMSET.ACTIVEMODE="A"
    IF RECCOUNT() > 0
      LOCATE FOR CAPDACTID = 'A'
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *REPLACE NAPDAMNT  WITH -loFormSet.AriaForm1.txtInvAmount.Value  &&lower
      REPLACE NAPDAMNT  WITH -LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTINVAMOUNT.VALUE  &&lower
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    ENDIF

  CASE LOFORMSET.ACTIVEMODE="E"
    
	*! B610184,1 HIA 12/30/2012 T20121212.0018 AP Journal Discripancy [Start]
    lnSAVAPREC = RECNO()
    cFilterNow = FILTER()
    SET FILTER TO
    *! B610184,1 HIA 12/30/2012 T20121212.0018 AP Journal Discripancy [End]

    LOCATE FOR CAPDACTID = 'A' .AND. EMPTY(CAPDSTAT)
	*! B610184,1 HIA 12/30/2012 T20121212.0018 AP Journal Discripancy [Start]
    *LNSAVAPREC = RECNO()
    IF FOUND()
	*! B610184,1 HIA 12/30/2012 T20121212.0018 AP Journal Discripancy [End]
    IF CSTATUS = 'A'
	  SCATTER MEMVAR MEMO
      m.CSTATUS  = 'A'
      m.CAPDSTAT = ' '
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *m.nApdAmnt = -loFormSet.AriaForm1.txtInvAmount.Value  &&lower
      m.NAPDAMNT = -LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTINVAMOUNT.VALUE  &&lower
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      m.LAPDPOST = .F.
      m.CBATCHNO = ' '
      m.CTRNSLEDN= ' '
      m.CAPSESSNO= LOFORMSET.LCSEQUENCE

      m.NENTRYNO = 0
    
      GATHER MEMVAR MEMO
    ELSE

      REPLACE CAPDSTAT  WITH 'V'        ,;
        CSTATUS   WITH 'M'
      SCATTER MEMVAR MEMO
      m.NAPDAMNT = -1 * m.NAPDAMNT
      m.CSTATUS  = 'A'
      m.LAPDPOST = .F.
      m.CBATCHNO = ' '
      m.CTRNSLEDN= ' '
      m.NEQVAMNT = -1 * m.NEQVAMNT
      m.CAPSESSNO = LOFORMSET.LCSEQUENCE

      m.NENTRYNO = 0
      *! B610184,1 HIA 12/30/2012 T20121212.0018 AP Journal Discripancy [Start]
       && voided line amnount +Ve, so modify CAPDACTID to "D"
      m.CAPDACTID = 'D'
      *! B610184,1 HIA 12/30/2012 T20121212.0018 AP Journal Discripancy [End]
      APPEND BLANK
      GATHER MEMVAR MEMO

	  && Add new lines
      IF BETWEEN(LNSAVAPREC,0,RECCOUNT())
        GO LNSAVAPREC
      ENDIF

      *! B610184,1 HIA 12/30/2012 T20121212.0018 AP Journal Discripancy [Start]
      * modify the current line, with user entered values
      REPLACE  NAPDAMNT WITH LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTINVAMOUNT.VALUE, cStatus WITH 'M' ,;
               NEQVAMNT WITH LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTINVAMOUNT.VALUE
      *! B610184,1 HIA 12/30/2012 T20121212.0018 AP Journal Discripancy [End]

      SCATTER MEMVAR MEMO
      m.CSTATUS  = 'A'
      m.CAPDSTAT = ' '

      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *m.nApdAmnt = -loFormSet.AriaForm1.txtInvAmount.Value  &&lower
      m.NAPDAMNT = -LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTINVAMOUNT.VALUE  &&lower
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      m.LAPDPOST = .F.
      m.CBATCHNO = ' '
      m.CTRNSLEDN= ' '
      m.CAPSESSNO= LOFORMSET.LCSEQUENCE

      m.NENTRYNO = 0

      *! B610184,1 HIA 12/30/2012 T20121212.0018 AP Journal Discripancy [Start]
      * modify the co-line, Values with user entered values
      * NEQVAMNT, will be calculated later in save fn.
      m.CAPDACTID = 'A'
      m.NEQVAMNT  = -1 * LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTINVAMOUNT.VALUE
      *! B610184,1 HIA 12/30/2012 T20121212.0018 AP Journal Discripancy [End]

      APPEND BLANK
      GATHER MEMVAR MEMO
    ENDIF
  *! B610184,1 HIA 12/30/2012 T20121212.0018 AP Journal Discripancy [Start]
  ENDIF
  TRY
    IF !EMPTY(ALLTRIM(cFilterNow))
      SET FILTER TO &cFilterNow.
    ENDIF
  CATCH
  ENDTRY
  IF BETWEEN(LNSAVAPREC,0,RECCOUNT())
    GO LNSAVAPREC
  ENDIF
  *! B610184,1 HIA 12/30/2012 T20121212.0018 AP Journal Discripancy [End]
  ENDCASE
  SELECT APINVHDR
ENDIF

*IF loFormSet.AriaForm1.txtInvAmount.Value <> loFormSet.lnOldAmnt .AND. WVISIBLE('CWRAPDISTR')
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*IF loFormSet.AriaForm1.txtInvAmount.Value <> loFormSet.AriaForm1.txtInvAmount.OldValue .AND. loFormSet.DistLines.Visible
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

*=gfChClose('CWRAPDISTR')

*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*loFormSet.DistLines.Visible = .F.
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
*ENDIF
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*IF loFormSet.AriaForm1.txtInvAmount.Value > 0  &&lower
IF LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTINVAMOUNT.VALUE > 0  &&lower
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  LOFORMSET.LLDEBITM  = .F.
ELSE
  LOFORMSET.LLDEBITM  = .T.
ENDIF
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*loFormSet.AriaForm1.txtInvAmount.Tag=''
LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTINVAMOUNT.TAG=''
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
RETURN 1
*--end of lfvInvAmount


*!*************************************************************
*! Name      : lfvInvDisof
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 7/26/2004
*! Purpose   : To Validate the Invoice Discount.
*!*************************************************************
*! Parameters: The FormSet
*!*************************************************************
*! Returns   : True or False
*!*************************************************************
FUNCTION LFVINVDISOF
PARAMETERS LOFORMSET

IF !INLIST(LOFORMSET.ACTIVEMODE,'A','E')
  RETURN
ENDIF

*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*!*	IF loFormSet.AriaForm1.txtInvDisof.Value < 0  &&lower
*!*	  loFormSet.AriaForm1.txtInvDisof.Value = loFormSet.AriaForm1.txtInvDisof.OldValue  &&lower
IF LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTINVDISOF.VALUE < 0  &&lower
  LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTINVDISOF.VALUE = LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTINVDISOF.OLDVALUE  &&lower
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

  *Old: SHOW GET loFormSet.AriaForm1.txtInvDisof.Value  &&lower &&Revise
  RETURN
ENDIF

*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*IF loFormSet.AriaForm1.txtInvDisof.Value > loFormSet.AriaForm1.txtInvAmount.Value  &&lower  &&lower
IF LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTINVDISOF.VALUE > LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTINVAMOUNT.VALUE  &&lower  &&lower
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

  =GFMODALGEN("TRM04011B00000","DIALOG")
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	  loFormSet.AriaForm1.txtInvDisof.Value = ;
  *!*	     IIF(loFormSet.AriaForm1.txtInvDisof.OldValue > 0,loFormSet.AriaForm1.txtInvDisof.Value,0)
  *! E302623,3 MMT 01/03/2010 Convert Payable invoice screen to use SQL tables[Start]
  *!*	    loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvDisof.VALUE = ;
  *!*	      IIF(loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvDisof.OldValue > 0,loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvDisof.VALUE,0)
  LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTINVDISOF.VALUE = ;
    IIF(LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTINVDISOF.OLDVALUE > 0,LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTINVDISOF.OLDVALUE ,0)
  *! E302623,3 MMT 01/03/2010 Convert Payable invoice screen to use SQL tables[End]
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
ENDIF

*Old: SHOW GET loFormSet.AriaForm1.txtInvDisof.Value  &&lower &&Revise

RETURN
*--end of lfvInvDisof



*!*************************************************************
*! Name      : lfvTermCode
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 7/26/2004
*! Purpose   : Function called from the Valid of the Terms.
*!*************************************************************
*! Parameters: The FormSet
*!*************************************************************
*! Returns   : True or False
*!*************************************************************
FUNCTION LFVTERMCODE
PARAMETERS LOFORMSET

IF !INLIST(LOFORMSET.ACTIVEMODE,'A','E')
  RETURN
ENDIF

*B128399,1 KHM 06/15/2005 Check if last key is down or up arrow do not change the value [Begin]
IF LASTKEY() = 24 OR LASTKEY() = 5 && 24 = Down Arrow and 5 = Up Arrow
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  * loFormSet.AriaForm1.cboTermCode.Value = loFormSet.AriaForm1.cboTermCode.OldValue
  LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.CBOTERMCODE.VALUE = LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.CBOTERMCODE.OLDVALUE
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  RETURN 1
ENDIF
*B128399,1 KHM 06/15/2005 [End]


*DO CASE
*CASE _DOS
*loFormSet.AriaForm1.cboTermCode.Value  =gfActPop(5,1,12,34,'SYCCODES','cCode_No','cDiscrep',@loFormSet.lcTermCode)  &&lower
*CASE _WINDOWS

LOFORMSET.LCPUTERM   = CODES.CDISCREP
*loFormSet.AriaForm1.cboTermCode.Value = CODES.cCode_No  &&lower

*Old: SHOW GET loFormSet.lcPuTerm &&Revise
*ENDCASE

IF LASTKEY() <> 27  && ESC

  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	  DIMENSION laAry[ALEN(loFormSet.laTermAry,1),ALEN(loFormSet.laTermAry,2)]
  *!*	  =ACOPY(loFormSet.laTermAry,laAry)
  *!*	  =gfRltFld(loFormSet.AriaForm1.cboTermCode.Value , @laAry , 'CTERMCODE')
  *!*	  DIMENSION loFormSet.laTermAry[ALEN(laAry,1),ALEN(laAry,2)]
  *!*	  =ACOPY(laAry,loFormSet.laTermAry)
  DIMENSION LAARRAY[ALEN(loFormSet.laTermAry,1),ALEN(loFormSet.laTermAry,2)]
  =ACOPY(LOFORMSET.LATERMARY,LAARRAY)
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

  * =gfRltFld(loFormSet.AriaForm1.cboTermCode.Value , @laArray, 'CTERMCODE')
  =GFRLTFLD(LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.CBOTERMCODE.VALUE , @LAARRAY, 'CTERMCODE')
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *  loFormSet.lcTermsDisp = IIF(EMPTY(loFormSet.AriaForm1.cboTermCode.Value),'ENABLE','DISABLE')  &&lower
  *loFormSet.AriaForm1.dtInvDuDat.Value  = lfGetdueD(loFormSet.AriaForm1.DtInvDate.Value,loFormSet.AriaForm1.txtterdued.Value,loFormSet.lnEomDay)  &&lower  &&lower  &&lower
  *!*	    IF loFormSet.AriaForm1.txtInvAmount.Value > 0
  *!*	    loFormSet.AriaForm1.txtInvAmount.OldValue = ;
  *!*	      IIF(TYPE('loFormSet.AriaForm1.txtInvAmount.OldValue')<>'N',;
  *!*	          loFormSet.AriaForm1.txtInvAmount.Value,loFormSet.AriaForm1.txtInvAmount.OldValue)
  *!*	    IF loFormSet.AriaForm1.txtInvAmount.Value <> loFormSet.AriaForm1.txtInvAmount.OldValue
  *!*	      loFormSet.AriaForm1.txtInvDisof.Value = (loFormSet.AriaForm1.txtTerDiscr.Value * loFormSet.AriaForm1.txtInvAmount.Value) / 100
  DIMENSION LOFORMSET.LATERMARY[ALEN(laArray,1),ALEN(laArray,2)]
  =ACOPY(LAARRAY,LOFORMSET.LATERMARY)
  LOFORMSET.LCTERMSDISP = IIF(EMPTY(LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.CBOTERMCODE.VALUE),'ENABLE','DISABLE')  &&lower
  *B609614,1 TMI [START]
  *loFormSet.AriaForm1.pgfpayInv.pgHead.dtInvDuDat.VALUE  = lfGetdueD(loFormSet.AriaForm1.pgfpayInv.pgHead.DtInvDate.VALUE,loFormSet.AriaForm1.pgfpayInv.pgHead.txtterdued.VALUE,loFormSet.lnEomDay)  &&
LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.DTINVDUDAT.VALUE  = LFGETDUED(LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.DTINVDATE.VALUE,LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTTERDUED.VALUE,LOFORMSET.LNEOMDAY,LOFORMSET.LCEOM)  &&lower  &&lower  &&lower
  *B609614,1 TMI [END]
  IF LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTINVAMOUNT.VALUE > 0
    LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTINVAMOUNT.OLDVALUE = ;
      IIF(TYPE('loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.OldValue')<>'N',;
      LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTINVAMOUNT.VALUE,LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTINVAMOUNT.OLDVALUE)
    IF LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTINVAMOUNT.VALUE <> LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTINVAMOUNT.OLDVALUE
      LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTINVDISOF.VALUE = (LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTTERDISCR.VALUE * LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTINVAMOUNT.VALUE) / 100
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    ENDIF
  ENDIF

  *Old: SHOW GET loFormSet.AriaForm1.txtTerDiscr.Value &loFormSet.lcTermsDisp  &&lower &&Revise
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	  loFormSet.AriaForm1.txtTerDiscr.Enabled = (loFormSet.lcTermsDisp='ENABLE')
  *!*	  *Old: SHOW GET loFormSet.AriaForm1.txtterdued.Value &loFormSet.lcTermsDisp  &&lower &&Revise
  *!*	  loFormSet.AriaForm1.txtterdued.Enabled = (loFormSet.lcTermsDisp='ENABLE')
  *!*	  *Old: SHOW GET loFormSet.AriaForm1.txtTerDiscd.Value &loFormSet.lcTermsDisp  &&lower &&Revise
  *!*	  loFormSet.AriaForm1.txtTerDiscd.Enabled = (loFormSet.lcTermsDisp='ENABLE')
  LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTTERDISCR.ENABLED = (LOFORMSET.LCTERMSDISP='ENABLE')
  *Old: SHOW GET loFormSet.AriaForm1.txtterdued.Value &loFormSet.lcTermsDisp  &&lower &&Revise
  LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTTERDUED.ENABLED = (LOFORMSET.LCTERMSDISP='ENABLE')
  *Old: SHOW GET loFormSet.AriaForm1.txtTerDiscd.Value &loFormSet.lcTermsDisp  &&lower &&Revise
  LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTTERDISCD.ENABLED = (LOFORMSET.LCTERMSDISP='ENABLE')
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  *Old: SHOW GET loFormSet.AriaForm1.dtInvDuDat.Value  &&lower &&Revise

  *=gfUpdate()
  *=lfRefresh() && refresh says filed on the screen
ENDIF

SELECT APINVHDR

*IF _WINDOWS
*DEACTIVATE POPUP puTermDes
*ENDIF

RETURN 1
*--end of lfvTermCode


*!*************************************************************
*! Name      : lfvDivision
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 7/26/2004
*! Purpose   : Function called from the Valid of the Divisions.
*!*************************************************************
*! Parameters: The FormSet
*!*************************************************************
*! Returns   : True or False
*!*************************************************************
FUNCTION LFVDIVISION
PARAMETERS LOFORMSET

IF !INLIST(LOFORMSET.ACTIVEMODE,'A','E')
  RETURN
ENDIF

*B128399,1 KHM 06/15/2005 Check if last key is down or up arrow do not change the value [Begin]
IF LASTKEY() = 24 OR LASTKEY() = 5 && 24 = Down Arrow and 5 = Up Arrow
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *loFormSet.AriaForm1.cboDivision.Value = loFormSet.AriaForm1.cboDivision.OldValue
  LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.CBODIVISION.VALUE = LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.CBODIVISION.OLDVALUE
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  RETURN 1
ENDIF
*B128399,1 KHM 06/15/2005 [End]

*DO CASE
*CASE _DOS
*loFormSet.AriaForm1.cboDivision.Value = gfActPop(7,1,13,34,'SYCCODES','cCode_No','cDiscrep',@loFormSet.lcDivision)  &&lower

*CASE _WINDOWS

LOFORMSET.LCPUDIV   = CODES.CDISCREP
*loFormSet.AriaForm1.cboDivision.Value = CODES.cCode_No  &&lower

*Old: SHOW GET loFormSet.lcPuDiv &&Revise
*=gfUpdate()
*ENDCASE

*IF _WINDOWS
*DEACTIVATE POPUP puDivision
*ENDIF

*=lfRefresh()    && refresh says filed on the screen

RETURN 1
*--end of lfvDivision


*!*************************************************************
*! Name      : lfVlDate
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 7/26/2004
*! Purpose   : To Validate dates from the periods file.
*!*************************************************************
*! Parameters: The company that you want to validate from its periods.
*!           : Logical parameter to accept the date in a locked period.
*!*************************************************************
*! Returns   : True or False
*!*************************************************************
FUNCTION LFVLDATE
PARAMETERS LCCOMPANY, LCCRPRD, LCCRYER, LDDATETVAL, LLLOCKPER
LOCAL AP1

PRIVATE LLOPENPRD, LCSAVORDPR, LLVALIDDATE, LCEXACTSTAT

IF TYPE('lcCurYear') <> 'C' .AND. TYPE('lcCurPrd') <> 'C'
  PRIVATE LCCURYEAR, LCCURPRD, LLOCKSTAT

  LCCRYER    = IIF(TYPE('lcCrYer') <> 'C',' ',LCCRYER)

  LCCRPRD    = IIF(TYPE('lcCrPrd') <> 'C',' ',LCCRPRD)
ENDIF

LLLOCKPER  = IIF(LLLOCKPER,LLLOCKPER,.F.)

LLVALIDDATE= .F.      && Variable to return with from the function.

LCCURYEAR  = ' '      && Variable to hold the current year.
LCCURPRD   = ' '      && Varibale to hold the current period.
LCEXACTSTAT= ' '      && Variable to hold the SET EXACT status.
LLOCKSTAT  = .F.      && Variable to hold the lock stat of the record.

LCSAVSELCT = ALIAS()  && Variable to save the currently selected file.

LLOPENPRD  = .F.      && Variable to indicate that the there is a file;
&& OPEN BY the FUNCTION.

AP1 = CREATEOBJECT("ap")

*PRIVATE llOpAPS, llOpcomp

*llOpcomp = gfOpenFile(oAriaApplication.SysPath+'SYCCOMP','Ccomp_id','SH')  &&lower
*llOpAPS  = gfOpenFile(oAriaApplication.DataDir+'APSETUP','','SH')  &&lower

LCCOMPANY  = IIF(TYPE('lcCompany') <> 'C',APSETUP.CAPSGLCOM,LCCOMPANY)

LCCOMPYER  = OARIAAPPLICATION.CURRENTYEAR
LCCOMPPRD  = OARIAAPPLICATION.CURRENTPERIOD



LCCOMPANY  = IIF(TYPE('lcCompany') <> 'C',APSETUP.CAPSGLCOM,LCCOMPANY)


LCCOMPYER  = OARIAAPPLICATION.CURRENTYEAR
LCCOMPPRD  = OARIAAPPLICATION.CURRENTPERIOD

IF !USED('FSPRD')   && Check if the period file is open or not.
  LLOPENPRD = .T.      && Indicates that the file is open by the function.
  SELECT 0             && Select an empty work area.
  *lcDataDir = ALLTRIM(IIF(SEEK(oAriaApplication.PrntCompanyID, 'SYCCOMP'), gfGetDataDir(ALLT(SYCCOMP.cCom_DDir)), oAriaApplication.DataDir))  &&lower  &&lower
  LCDATADIR = AP1.LCDATADIR

  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *USE &lcDataDir.fsprd ORDER TAG COMFYRPRDI
  =GFOPENTABLE('fsprd','COMFYRPRDI','SH')
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

ELSE
  SELECT FSPRD      && The file is open so we are going to select

  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	  lcSavOrdPr = SYS(22) && Save the file order
  *!*	  SET ORDER TO TAG COMFYRPRDI   && Change the order
  LCSAVORDPR = ORDER() && Save the file order
  =GFSETORDER('COMFYRPRDI')
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
ENDIF
*IF USED('SYCCOMP') .AND. llOpcomp
*=gfCloseFile('SYCCOMP')
*ENDIF
*IF USED('APSETUP') .AND. llOpAPS
*=gfCloseFile('APSETUP')
*ENDIF

IF TYPE('ldDateTVal') <> 'D'
  LDDATE = IIF(TYPE('_screen.ActiveForm.ActiveControl.Value')='D',_SCREEN.ACTIVEFORM.ACTIVECONTROL.VALUE,{})
ELSE
  LDDATE = LDDATETVAL
ENDIF
*ldDate = ldDateTVal

LCEXACTSTAT = SET('EXACT')
SET EXACT OFF
GO TOP

SET EXACT &LCEXACTSTAT


LOCATE REST FOR BETWEEN(LDDATE,DFSPPBGDT,DFSPPENDT)
IF FOUND() .AND. BETWEEN(LDDATE,AP1.LDPYBGDATE,AP1.LDNYENDATE)

  LLLOCKSTAT = LFSPLOCKS  && Assign the variable with the period lock stat.
  LCCURYEAR  = CFISFYEAR  && Assign the variable with fiscal year of the period.
  LCCURPRD   = CFSPPRDID  && Assign the variable with the period no.
  LCCRYER    = CFISFYEAR  && Assign the variable with fiscal year of the period.
  LCCRPRD    = CFSPPRDID  && Assign the variable with the period no.
  LLLOCKPER  = LFSPLOCKS  && Assign the variable with the period lock stat.
  LLVALIDDATE= .T.        && Assign the variable with .T.

  IF USED('FSPRD') .AND. LLOPENPRD
    LLOPENPRD = .F.
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *USE IN FSPRD
    =GFCLOSETABLE('FSPRD')
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[END]
  ELSE
    SELECT FSPRD
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *SET ORDER TO &lcSavOrdPr
    =GFSETORDER(LCSAVORDPR)
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  ENDIF

  IF !EMPTY(LCSAVSELCT)
    SELECT(LCSAVSELCT)
  ENDIF
ELSE
  IF USED('FSPRD') .AND. LLOPENPRD
    LLOPENPRD = .F.
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *USE IN FSPRD
    =GFCLOSETABLE('FSPRD')
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  ELSE
    SELECT FSPRD
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *SET ORDER TO &lcSavOrdPr
    =GFSETORDER(LCSAVORDPR)
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  ENDIF

  IF !EMPTY(LCSAVSELCT)
    SELECT(LCSAVSELCT)
  ENDIF
ENDIF

RETURN LLVALIDDATE

*--end of lfVlDate


*!*************************************************************
*! Name      : lfVDtMsg
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 7/26/2004
*! Purpose   : Validation function for date by giving messages.
*!*************************************************************
*! Parameters: The company that you want to validate from its periods.
*!           : Logical parameter to accept the date in a locked period.
*!*************************************************************
*! Returns   : True or False
*!*************************************************************
FUNCTION LFVDTMSG
PARAMETERS LCCOMPANY, LCCRPRD, LCCRYER, LDDATETVAL, LLLOCKPER


PRIVATE LLLOCKSTAT, LCCOMPYER, LCCOMPPRD
PRIVATE LNYEAR, LCYERPER, LCMESSAGE, LCMESSGSEL
PRIVATE LCCURYEAR, LCCURPRD, LLVAILDDATE

LCCOMPYER  = ' '   && Variable to hlod the current year of the company.
LCCOMPPRD  = ' '   && Variable to hlod the current period of the company.

LCCURYEAR  = ' '
LCCURPRD   = ' '

LLVAILDDATE= .F.   && Variable to indicate if the date is valid or not

LCCRYER    = IIF(TYPE('lcCrYer') <> 'C',' ',LCCRYER)

LCCRPRD    = IIF(TYPE('lcCrPrd') <> 'C',' ',LCCRPRD)

LLLOCKPER  = IIF(LLLOCKPER,LLLOCKPER,.F.)

LNYEAR     = 0     && Variable to hold the year No.

LLLOCKSTAT = .F.   && Variable to hold the lock stat of the period.

LDDATETVAL = IIF(TYPE('ldDateTVal')='O',LDDATETVAL.TEXT1.VALUE,LDDATETVAL)

IF LFVLDATE(LCCOMPANY,LCCRPRD,LCCRYER,LDDATETVAL)  && Call the date validation function.

  LCCRPRD  = LCCURPRD
  LCCRYER  = LCCURYEAR
  LCYERPER = LCCURPRD+'-'+LCCURYEAR


  LNYEAR   = (INT(VAL(LCCURYEAR))-INT(VAL(LCCOMPYER))) + 3


  LNYEAR   = IIF(LNYEAR <= 0,1,LNYEAR)

  IF LNYEAR = 3
    LNYEAR  = LNYEAR + SIGN(VAL(LCCRPRD) - VAL(OARIAAPPLICATION.CURRENTPERIOD))
  ENDIF  && End Period Validation

  DO CASE
  CASE LLLOCKSTAT


    =GFMODALGEN("TRM00134B00000","DIALOG",LCYERPER)
    LLVAILDDATE = .F.

  CASE LNYEAR > 0
    *N000682,1 MMT 11/22/2012 Globalization changes[Start]
    *LCMESSAGE  = 'history prior   current  future  '
    *N000682,1 11/20/2012 MMT Globlization changes[Start]
*LCMESSAGE  = LANG_APPYINV_INVOICE_HISTORYPRIOR
LCMESSAGE  = IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_INVOICE_HISTORYPRIOR,loFormSet.GetHeaderText("LANG_APPYINV_INVOICE_HISTORYPRIOR",loFormSet.HeaderAlias))
*N000682,1 11/20/2012 MMT Globlization changes[End]

    *N000682,1 MMT 11/22/2012 Globalization changes[Start]
    LCMESSGSEL = ALLTRIM(SUBSTR(LCMESSAGE,(LNYEAR*8)-7,8))


    IF LNYEAR <> 3
      =GFMODALGEN("TRM00136B00000","DIALOG",LCMESSGSEL+"|"+LCYERPER)
    ENDIF

    IF LNYEAR = 1   && If the year = 1 we are not going to accept.
      LLVAILDDATE = .F.
    ELSE
      LLVAILDDATE = .T.
    ENDIF
  ENDCASE
ELSE

  =GFMODALGEN("TRM00133B00000","DIALOG")

  LLVAILDDATE = .F.
ENDIF

RETURN LLVAILDDATE

*--end of lfVDtMsg


*!*************************************************************
*! Name      : lfGetdueD
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 7/26/2004
*! Purpose   : Return the Due Date
*!*************************************************************
*! Parameters: ldDueDay,lnMonthDays,lnAddDays,lnDiffDays
*!*************************************************************
*! Returns   : ldDueDay
*!*************************************************************

FUNCTION LFGETDUED



*! B609614,1 MMT 06/13/2011 Fix bug of wrong AP invoice Due date[Start]
*PARAMETER ldInvDate, lnDueDays, lnEOM
*PRIVATE ldDueDay, lnMonthDays, lnAddDays, lnDiffDays
PARAMETER LDINVDATE, LNDUEDAYS, LNEOM,LCEOM
*! E303111,1 HIA 04/22/2012 Add Next month day related field, to trems code [T20120301.0038][Begin]
*!*	LNEOM = IIF(TYPE('lnEOM') <> 'N' .OR. LNEOM= 0,20,LNEOM -1)
*!*	LDDUEDATE = IIF(LCEOM<> 'Y',LDINVDATE+ LNDUEDAYS,;
*!*	  GOMONTH(CTOD(SUBSTR(DTOC(LDINVDATE),1,3) +'10'+;
*!*	  SUBSTR(DTOC(LDINVDATE),6,5)),IIF(DAY(LDINVDATE)>LNEOM,2,1))+LNDUEDAYS)
*!*	rETURN LDDUEDATE
ldDueDate = gfGetdueD(ldInvDate, loFormSet.AriaForm1.pgfpayInv.pgHead.cboTermCode.VALUE)
RETURN ldDueDate
*! E303111,1 HIA 04/22/2012 Add Next month day related field, to trems code [T20120301.0038][end]
*! B609614,1 MMT 06/13/2011 Fix bug of wrong AP invoice Due date[End]

LNDIFFDAYS = 0

IF LNEOM > 0
  DO CASE
  CASE INLIST(ALLTRIM(STR(MONTH(LDINVDATE))),'01','03','05','07','08','10','12')
    LNMONTHDAYS = 31
  CASE INLIST(ALLTRIM(STR(MONTH(LDINVDATE))),'04','06','09','11')
    LNMONTHDAYS = 30
  OTHERWISE
    LNMONTHDAYS = IIF(MOD(YEAR(LDINVDATE),4)=0,29,28)
    LNDIFFDAYS = LNEOM - LNMONTHDAYS
  ENDCASE
  LNADDDAYS = IIF(DAY(LDINVDATE)>LNEOM,LNMONTHDAYS - DAY(LDINVDATE),LNEOM-DAY(LDINVDATE))
ELSE
  LNADDDAYS = 0
ENDIF

LDDUEDAY = LDINVDATE + LNDUEDAYS + LNADDDAYS - LNDIFFDAYS

RETURN LDDUEDAY

*--end of lfGetdueD



***xxx***


*!*************************************************************
*! Name      : lfvRemit
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 7/29/2004
*! Purpose   : To Validate The RemitTo ComboBox.
*!*************************************************************
*! Parameters: loFormSet, llJustShow
*!*************************************************************
*! Returns   : None
*!*************************************************************
FUNCTION LFVREMIT
PARAMETERS LOFORMSET, LLJUSTSHOW
PRIVATE LCREMITSTAT, LCREMITTO

IF !INLIST(LOFORMSET.ACTIVEMODE,'A','E')
  RETURN
ENDIF


*** Default factor for the vendor
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*!*	loFormSet.AriaForm1.kbFacCode.KeyTextBox.Value = ;
*!*	   IIF(EMPTY(loFormSet.AriaForm1.kbFacCode.KeyTextBox.Value), APVENDOR.cFacCode, ;
*!*	       loFormSet.AriaForm1.kbFacCode.KeyTextBox.Value)
*!*	DIMENSION laAry[6]
*!*	laAry[1]=loFormSet.AriaForm1.txtOutComp.Value
*!*	laAry[2]=apinvhdr.coutaddr1
*!*	laAry[3]=apinvhdr.coutaddr2
*!*	laAry[4]=apinvhdr.coutaddr3
*!*	laAry[5]=apinvhdr.coutaddr4
*!*	laAry[6]=apinvhdr.coutaddr5

LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBFACCODE.KEYTEXTBOX.VALUE = ;
  IIF(EMPTY(LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBFACCODE.KEYTEXTBOX.VALUE), APVENDOR.CFACCODE, ;
  LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBFACCODE.KEYTEXTBOX.VALUE)

DIMENSION LAARRAY[6]
LAARRAY[1]=LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTOUTCOMP.VALUE
LAARRAY[2]=APINVHDR.COUTADDR1
LAARRAY[3]=APINVHDR.COUTADDR2
LAARRAY[4]=APINVHDR.COUTADDR3
LAARRAY[5]=APINVHDR.COUTADDR4
LAARRAY[6]=APINVHDR.COUTADDR5
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

LCREMITSTAT = LOFORMSET.LCREMITSTAT
LCREMITTO = LOFORMSET.LCREMITTO
DIMENSION LAREMITTO[ALEN(loFormSet.laRemitTo,1),ALEN(loFormSet.laRemitTo,2)]
=ACOPY(LOFORMSET.LAREMITTO,LAREMITTO)

*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*!*	loFormSet.AriaForm1.cboInvRemit.Value  = ;
*!*	  gfRemit(loFormSet.AriaForm1.cboInvRemit.Value, !llJustShow, ;
*!*	          loFormSet.AriaForm1.KBVendCode.KeyTextBox.Value, ;
*!*	          loFormSet.AriaForm1.kbFacCode.KeyTextBox.Value, @lcRemitStat, ;
*!*	          'laAry[1]','laAry[2]','laAry[3]','laAry[4]','laAry[5]','laAry[6]',;
*!*	          3, 40, 'laRemitTo', @lcRemitTo, loFormSet.lnRemitLen)
*!*	loFormSet.AriaForm1.txtOutComp.Value = laAry[1]

*!*	REPLACE apinvhdr.coutaddr1 WITH laAry[2] IN apinvhdr
*!*	REPLACE apinvhdr.coutaddr2 WITH laAry[3] IN apinvhdr
*!*	REPLACE apinvhdr.coutaddr3 WITH laAry[4] IN apinvhdr
*!*	REPLACE apinvhdr.coutaddr4 WITH laAry[5] IN apinvhdr
*!*	REPLACE apinvhdr.coutaddr5 WITH laAry[6] IN apinvhdr
LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.CBOINVREMIT.VALUE  = ;
  GFREMIT(LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.CBOINVREMIT.VALUE, !LLJUSTSHOW, ;
  LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE, ;
  LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBFACCODE.KEYTEXTBOX.VALUE, @LCREMITSTAT, ;
  'laArray[1]','laArray[2]','laArray[3]','laArray[4]','laArray[5]','laArray[6]',;
  3, 40, 'laRemitTo', @LCREMITTO, LOFORMSET.LNREMITLEN)
LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTOUTCOMP.VALUE = LAARRAY[1]
REPLACE APINVHDR.COUTADDR1 WITH LAARRAY[2] IN APINVHDR
REPLACE APINVHDR.COUTADDR2 WITH LAARRAY[3] IN APINVHDR
REPLACE APINVHDR.COUTADDR3 WITH LAARRAY[4] IN APINVHDR
REPLACE APINVHDR.COUTADDR4 WITH LAARRAY[5] IN APINVHDR
REPLACE APINVHDR.COUTADDR5 WITH LAARRAY[6] IN APINVHDR
SELECT APINVHDR
=GFREPLACE('')
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
LOFORMSET.LCREMITSTAT = LCREMITSTAT
LOFORMSET.LCREMITTO = LCREMITTO
=ACOPY(LAREMITTO,LOFORMSET.LAREMITTO)

*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*!*	loFormSet.AriaForm1.kbFacCode.KeyTextBox.Value = ;
*!*	  IIF(loFormSet.AriaForm1.cboInvRemit.Value = 'F', ;
*!*	      loFormSet.AriaForm1.kbFacCode.KeyTextBox.Value, SPACE(6))
LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBFACCODE.KEYTEXTBOX.VALUE = ;
  IIF(LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.CBOINVREMIT.VALUE = 'F', ;
  LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBFACCODE.KEYTEXTBOX.VALUE, SPACE(6))
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
*loFormSet.lnOldRemit = puRemitTo


*** If a vendor code exists,
DO CASE
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *  CASE loFormSet.AriaForm1.cboInvRemit.Value = 'F'
CASE LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.CBOINVREMIT.VALUE = 'F'
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  LOFORMSET.LCFACTSTAT   = IIF(!LOFORMSET.ACTIVEMODE="V", 'ENABLE', 'DISABLE')  &&lower

OTHERWISE
  LOFORMSET.LCFACTSTAT   = 'DISABLE'
ENDCASE
*Old: =lfShiftlaData(loFormSet.lnStartAdr)
*Old: SHOW GET loFormSet.laAddrs[1] &loFormSet.lcRemitStat &&Revise
*Old: SHOW GET loFormSet.laAddrs[2] &loFormSet.lcRemitStat &&Revise
*Old: SHOW GET loFormSet.laAddrs[3] &loFormSet.lcRemitStat &&Revise
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*!*	STORE (loFormSet.lcRemitStat='ENABLE') TO loFormSet.AriaForm1.txtOutComp.Enabled, ;
*!*	  loFormSet.AriaForm1.txtOutAddr1.Enabled, loFormSet.AriaForm1.txtOutAddr2.Enabled, ;
*!*	  loFormSet.AriaForm1.txtOutAddr3.Enabled
STORE (LOFORMSET.LCREMITSTAT='ENABLE') TO LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTOUTCOMP.ENABLED, ;
  LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTOUTADDR1.ENABLED, LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTOUTADDR2.ENABLED, ;
  LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTOUTADDR3.ENABLED
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
*Old: SHOW GET loFormSet.AriaForm1.kbFacCode.KeyTextBox.Value &loFormSet.lcFactStat  &&lower &&Revise
*Old: SHOW GET ibFactor   &loFormSet.lcFactStat &&Revise
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*loFormSet.AriaForm1.kbFacCode.Enabled=(loFormSet.lcFactStat='ENABLE')
LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBFACCODE.ENABLED=(LOFORMSET.LCFACTSTAT='ENABLE')
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
*=lfRefresh()

SELECT APINVHDR
*B128399,1 KHM 06/15/2005 Return 0 to stay in the popup [Begin]
*RETURN 1
RETURN 0
*B128399,1 KHM 06/15/2005 [End]
*--end of lfvRemit


*!*************************************************************
*! Name      : lfvFactor
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 7/29/2004
*! Purpose   : To Validate The Factor Control.
*!*************************************************************
*! Parameters: loFormSet
*!*************************************************************
*! Returns   : None
*!*************************************************************
FUNCTION LFVFACTOR
PARAMETERS LOFORMSET

IF !INLIST(LOFORMSET.ACTIVEMODE,'A','E')
  RETURN
ENDIF
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*!*	loFormSet.llBrowse = loFormSet.AriaForm1.kbFacCode.Selectedfrombrowse
*!*	IF !loFormSet.llBrowse .AND.  ;
*!*	  loFormSet.AriaForm1.kbFacCode.KeyTextBox.Value = loFormSet.AriaForm1.kbFacCode.KeyTextBox.OldValue
LOFORMSET.LLBROWSE = LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBFACCODE.SELECTEDFROMBROWSE
IF !LOFORMSET.LLBROWSE .AND.  ;
    LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBFACCODE.KEYTEXTBOX.VALUE = LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBFACCODE.KEYTEXTBOX.OLDVALUE
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  RETURN
ENDIF
*Open file
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*llopFact = gfOpenFile(oAriaApplication.SysPath+'SYCFACT','CFACCODE','SH')  &&lower
*IF loFormSet.llBrowse .OR. !EMPTY(loFormSet.AriaForm1.kbFacCode.KeyTextBox.Value)  &&lower
* IF lfGetFac(loFormSet.AriaForm1.kbFacCode.KeyTextBox.OldValue, loFormSet.llBrowse)
*!*	    loFormSet.AriaForm1.txtOutComp.Value = SYCFACT.cFacComp  &&lower
*!*	    loFormSet.AriaForm1.txtOutAddr1.Value = SYCFACT.cAddress1  &&lower
*!*	    loFormSet.AriaForm1.txtOutAddr2.Value = SYCFACT.cAddress2  &&lower
*!*	    loFormSet.AriaForm1.txtOutAddr3.Value = lfGetAdr('SYCFACT','CFACCODE')  &&lower
LLOPFACT = GFOPENTABLE(OARIAAPPLICATION.SYSPATH+'SYCFACT','CFACCODE','SH')  &&lower
IF LOFORMSET.LLBROWSE .OR. !EMPTY(LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBFACCODE.KEYTEXTBOX.VALUE)  &&lower
  *! B609775,1 MMT 12/15/2011 Error while browsing factors in Payable invoice screen[Start]
  *IF LFGETFAC(LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBFACCODE.KEYTEXTBOX.OLDVALUE, LOFORMSET.LLBROWSE)
  IF LFGETFAC(LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBFACCODE.KEYTEXTBOX.VALUE, LOFORMSET.LLBROWSE)
    LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBFACCODE.KEYTEXTBOX.VALUE = SYCFACT.CFACCODE
    *! B609775,1 MMT 12/15/2011 Error while browsing factors in Payable invoice screen[Start]
    LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTOUTCOMP.VALUE = SYCFACT.CFACCOMP  &&lower
    LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTOUTADDR1.VALUE = SYCFACT.CADDRESS1  &&lower
    LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTOUTADDR2.VALUE = SYCFACT.CADDRESS2  &&lower
    LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTOUTADDR3.VALUE = LFGETADR('SYCFACT','CFACCODE')  &&lower
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    REPLACE APINVHDR.COUTADDR1 WITH GFGETADR('SYCFACT','CFACCODE',.F.,.F.,1) IN APINVHDR
    REPLACE APINVHDR.COUTADDR2 WITH GFGETADR('SYCFACT','CFACCODE',.F.,.F.,2) IN APINVHDR
    REPLACE APINVHDR.COUTADDR3 WITH GFGETADR('SYCFACT','CFACCODE',.F.,.F.,3) IN APINVHDR
    REPLACE APINVHDR.COUTADDR4 WITH GFGETADR('SYCFACT','CFACCODE',.F.,.F.,4) IN APINVHDR
    REPLACE APINVHDR.COUTADDR5 WITH GFGETADR('SYCFACT','CFACCODE',.F.,.F.,5) IN APINVHDR
    *! B609775,1 MMT 12/15/2011 Error while browsing factors in Payable invoice screen[Start]
  ELSE
    *LOFORMSET.ARIAFORM1.KBFACCODE.KEYTEXTBOX.VALUE = LOFORMSET.ARIAFORM1.KBFACCODE.KEYTEXTBOX.OLDVALUE
    LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBFACCODE.KEYTEXTBOX.VALUE = LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBFACCODE.KEYTEXTBOX.OLDVALUE
    *! B609775,1 MMT 12/15/2011 Error while browsing factors in Payable invoice screen[END]
  ENDIF
ELSE
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *    loFormSet.AriaForm1.txtOutComp.Value = ''
  LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTOUTCOMP.VALUE = ''
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  REPLACE APINVHDR.COUTADDR1 WITH ''
  REPLACE APINVHDR.COUTADDR2 WITH ''
  REPLACE APINVHDR.COUTADDR3 WITH ''
  REPLACE APINVHDR.COUTADDR4 WITH ''
  REPLACE APINVHDR.COUTADDR5 WITH ''
ENDIF
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
SELECT APINVHDR
=GFREPLACE("")
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

*Old: SHOW GET loFormSet.AriaForm1.txtOutComp.Value  &&lower &&Revise
*Old: SHOW GET loFormSet.AriaForm1.txtOutAddr1.Value   &&lower &&Revise
*Old: SHOW GET loFormSet.AriaForm1.txtOutAddr2.Value   &&lower &&Revise
*Old: SHOW GET loFormSet.AriaForm1.txtOutAddr3.Value   &&lower &&Revise

*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*!*	loFormSet.AriaForm1.txtOutComp.Refresh()
*!*	loFormSet.AriaForm1.txtOutAddr1.Refresh()
*!*	loFormSet.AriaForm1.txtOutAddr2.Refresh()
*!*	loFormSet.AriaForm1.txtOutAddr3.Refresh()
LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTOUTCOMP.REFRESH()
LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTOUTADDR1.REFRESH()
LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTOUTADDR2.REFRESH()
LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTOUTADDR3.REFRESH()
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
*Old: =lfShiftlaData(loFormSet.lnStartAdr)
*Old: SHOW GET loFormSet.laAddrs[1] &&Revise
*Old: SHOW GET loFormSet.laAddrs[2] &&Revise
*Old: SHOW GET loFormSet.laAddrs[3] &&Revise
LOFORMSET.LLBROWSE = .F.
IF USED('SYCFAC') .AND. LLOPFACT
  *=gfCloseFile('SYCFAC')
  USE IN SYCFAC
ENDIF

RETURN
*--end of lfvFactor


*!*************************************************************
*! Name      : lfvPriority
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 7/29/2004
*! Purpose   : To Validate The Priority.
*!*************************************************************
*! Parameters: loFormSet
*!*************************************************************
*! Returns   : None
*!*************************************************************
FUNCTION LFVPRIORITY
PARAMETERS LOFORMSET

IF !INLIST(LOFORMSET.ACTIVEMODE,'A','E')
  RETURN
ENDIF
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*!*	IF EMPTY(loFormSet.AriaForm1.txtVendPrior.Value)  &&lower
*!*	  loFormSet.AriaForm1.txtVendPrior.Value = loFormSet.AriaForm1.txtVendPrior.OldValue
IF EMPTY(LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTVENDPRIOR.VALUE)  &&lower
  LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTVENDPRIOR.VALUE = LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTVENDPRIOR.OLDVALUE
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
ENDIF
*Old: SHOW GET loFormSet.AriaForm1.txtVendPrior.Value  &&lower &&Revise

RETURN
*--end of lfvPriority



*!*************************************************************
*! Name      : lfvCurrency
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 7/29/2004
*! Purpose   : To Validate The Currency Control.
*!*************************************************************
*! Parameters: loFormSet
*!*************************************************************
*! Returns   : None
*!*************************************************************
*
FUNCTION LFVCURRENCY
PARAMETERS LOFORMSET
LOCAL LCEXSIN2

IF !INLIST(LOFORMSET.ACTIVEMODE,'A','E')
  RETURN
ENDIF

*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*loFormSet.llBrowse = loFormSet.AriaForm1.kbCurrCode.Selectedfrombrowse
LOFORMSET.LLBROWSE = LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.SELECTEDFROMBROWSE
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

*IF !USED('SYCCURR')

*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*  =gfOpenFile(oAriaApplication.SysPath + 'SYCCURR' , 'CCURRCODE' , 'SH')
=GFOPENTABLE(OARIAAPPLICATION.SYSPATH + 'SYCCURR' , 'CCURRCODE' , 'SH')
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
*ENDIF

*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*!*	IF loFormSet.llBrowse .OR. !SEEK(loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value,'SYCCURR') .OR. ;
*!*	  ATC("?",loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value) > 0 .AND. LASTKEY() = 13
IF LOFORMSET.LLBROWSE .OR. !SEEK(LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.KEYTEXTBOX.VALUE,'SYCCURR') .OR. ;
    ATC("?",LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.KEYTEXTBOX.VALUE) > 0 .AND. LASTKEY() = 13
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  SELECT SYCCURR
  DIMENSION LATEMP[1]
  LATEMP     = ''
  *Old: lcSavBrFld = lcBrFields
  *Old: lcSavTitle = lcFile_Ttl
  *N000682,1 MMT 11/22/2012 Globalization changes[Start]
  *LCFILE_TTL = "Currency"
  *LCBRFIELDS = "CCURRCODE :R :H= 'Currency code'," +;
    "CCURRDESC :R :H= 'Description',  " +;
    "CCURRSMBL :R :H= 'Symbol'"
  *N000682,1 11/20/2012 MMT Globlization changes[Start]
*LCFILE_TTL = LANG_APPYINV_CURRENCY
LCFILE_TTL = IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_CURRENCY,loFormSet.GetHeaderText("LANG_APPYINV_CURRENCY",loFormSet.HeaderAlias))
*N000682,1 11/20/2012 MMT Globlization changes[End]

  LCBRFIELDS = "CCURRCODE :R :H= '"+IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_CURRENCYCODE,loFormSet.GetHeaderText("LANG_APPYINV_CURRENCYCODE",loFormSet.HeaderAlias))+"'," +;
    "CCURRDESC :R :H= '"+IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_DESC,loFormSet.GetHeaderText("LANG_APPYINV_DESC",loFormSet.HeaderAlias))+"',  " +;
    "CCURRSMBL :R :H= '"+IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_SYMBOL,loFormSet.GetHeaderText("LANG_APPYINV_SYMBOL",loFormSet.HeaderAlias))+"'"

  *N000682,1 MMT 11/22/2012 Globalization changes[END]
  *! E302623,2 MMT 10/12/2009 Convert Payable invoice screen to use SQL tables[Start]
  *=gfBrows('','CCURRCODE','laTemp')
  *! E302623,3 MMT 01/03/2010 Convert Payable invoice screen to use SQL tables[Start]
  *=gfBrows('','CCURRCODE','laTemp',lcFile_Ttl )
  =ARIABROW('', LCFILE_TTL , .F., .F., .F., .F., .F., .T., ;
    'CCURRCODE', 'laTemp', .F., .F., .F., ;
    .F., .F., .F., .F., .F., ;
    .F., .F.)
  *! E302623,3 MMT 01/03/2010 Convert Payable invoice screen to use SQL tables[End]
  *! E302623,2 MMT 08/12/2009 Convert Payable invoice screen to use SQL tables[End]
  *Old: lcBrFields = lcSavBrFld
  *Old: lcFile_Ttl = lcSavTitle
  IF EMPTY(LATEMP[1])
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value = loFormSet.AriaForm1.kbCurrCode.KeyTextBox.OldValue
    LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.KEYTEXTBOX.VALUE = LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.KEYTEXTBOX.OLDVALUE
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  ELSE
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value = laTemp[1]  &&lower
    LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.KEYTEXTBOX.VALUE = LATEMP[1]  &&lower
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  ENDIF
ENDIF

*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*IF loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value <> loFormSet.AriaForm1.kbCurrCode.KeyTextBox.OldValue
IF LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.KEYTEXTBOX.VALUE <> LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.KEYTEXTBOX.OLDVALUE
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  *Add this lines to clear the approve for payment amount if the
  *        invoice currency was changed [Begin]
  *IF Statment to check that the approve amount do not = 0
  IF !EMPTY(APINVHDR.NINVAMTAP)  &&lower
    ** MESSAGE : " Changing the invoice currency will clear the "
    **           " approved amounts.                            "
    **           "            <   Ok   >  < Cancel >            "
    **
    LNCHANGE = GFMODALGEN("TRM04160B04004" , "DIALOG")
    *IF the user selected to cancel
    IF LNCHANGE = 2

      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value = loFormSet.AriaForm1.kbCurrCode.KeyTextBox.OldValue   && Restore the old value
      LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.KEYTEXTBOX.VALUE = LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.KEYTEXTBOX.OLDVALUE   && Restore the old value
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

      LOFORMSET.LLBROWSE = .F.

      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *loFormSet.AriaForm1.kbCurrCode.Selectedfrombrowse = loFormSet.llBrowse
      LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.SELECTEDFROMBROWSE = LOFORMSET.LLBROWSE
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

      RETURN
    ELSE   && Else clear the approve amount
      = LFVCLRAPR(LOFORMSET)
    ENDIF   && End of IF
  ENDIF   && End of IF
  *Add this lines [End]
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *IF gfGetMemVar('LLMULCURR') .AND. loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value <> oAriaApplication.BaseCurrency
  IF GFGETMEMVAR('LLMULCURR') .AND. LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.KEYTEXTBOX.VALUE <> OARIAAPPLICATION.BASECURRENCY
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    PRIVATE LNCURRUNIT
    LNCURRUNIT = 0
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *!*	    loFormSet.AriaForm1.txtNexRate.Value = gfChkRate('lnCurrUnit',;
    *!*	       loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value,loFormSet.AriaForm1.DtInvDate.Value,.T.)
    LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTNEXRATE.VALUE = GFCHKRATE('lnCurrUnit',;
      LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.KEYTEXTBOX.VALUE,LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.DTINVDATE.VALUE,.T.)
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    *Got the equation signs. (Begin)
    *to exchange currency from invoice currency to company base currency.
    *laData[44] ------> cCurrCode
    *Passed pointer parameter to get Unit sgin. (Begin)
    LOFORMSET.LCEXSIN2 = ' '
    LCEXSIN2 = LOFORMSET.LCEXSIN2

    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *loFormSet.lcExSin1 = gfGetExSin(@lcExSin2,loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value)
    LOFORMSET.LCEXSIN1 = GFGETEXSIN(@LCEXSIN2,LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.KEYTEXTBOX.VALUE)
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

    *B608763,1 WAM 12/15/2008 Restore exchange rate
    *lcExSin2 = loFormSet.lcExSin2
    LOFORMSET.LCEXSIN2 = LCEXSIN2
    *B608763,1 WAM 12/15/2008 (End)

    *lcExSin2 = IIF(lcExSin1 = '*','/','*')

    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *IF loFormSet.AriaForm1.txtNexRate.Value = 0
    *loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value = oAriaApplication.BaseCurrency
    *loFormSet.AriaForm1.txtNexRate.Value = 1
    IF LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTNEXRATE.VALUE = 0
      LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.KEYTEXTBOX.VALUE = OARIAAPPLICATION.BASECURRENCY
      LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTNEXRATE.VALUE = 1
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

    ENDIF
    IF GFGETMEMVAR('LLEDITEXRA')
      *Old: SHOW GET loFormSet.AriaForm1.txtNexRate.Value ENABLE  &&lower &&Revise

      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *loFormSet.AriaForm1.txtNexRate.Enabled = .T.
      LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTNEXRATE.ENABLED = .T.
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

    ELSE
      *Old: SHOW GET loFormSet.AriaForm1.txtNexRate.Value DISABLE  &&lower &&Revise

      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *loFormSet.AriaForm1.txtNexRate.Enabled = .F.
      LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTNEXRATE.ENABLED = .F.
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

    ENDIF
  ELSE

    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *!*	    loFormSet.AriaForm1.txtNexRate.Value = 1  &&lower
    *!*	    *Old: SHOW GET loFormSet.AriaForm1.txtNexRate.Value DISABLE  &&lower &&Revise
    *!*	    loFormSet.AriaForm1.txtNexRate.Enabled = .F.
    LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTNEXRATE.VALUE = 1  &&lower
    *Old: SHOW GET loFormSet.AriaForm1.txtNexRate.Value DISABLE  &&lower &&Revise
    LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTNEXRATE.ENABLED = .F.
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    *! B610205,1 HIA 01/20/2013 Aria4xp - AP - AP Invoice error message + incorrect ncurrunit update[T20130114.0001][Start]
    lcAilas = ALIAS()
    SELECT apinvhdr
    GFREPLACE("ncurrunit with 1")
    TRY
      SELECT (lcAilas)
    CATCH
    ENDTRY 
    *! B610205,1 HIA 01/20/2013 Aria4xp - AP - AP Invoice error message + incorrect ncurrunit update[T20130114.0001][End]
  ENDIF
  *Disable Invoice lines option when the vendor supply only cutting
  *ticket and invoicing with forign currency.

  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *  IF EMPTY(loFormSet.lcVenInvTypes) OR  ('M'=loFormSet.lcVenInvTypes AND gfGetMemVar('LLMULCURR') AND PADR(loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value,3)<>PADR(oAriaApplication.BaseCurrency,3)
  IF EMPTY(loFormSet.lcVenInvTypes) OR  ('M'=loFormSet.lcVenInvTypes AND gfGetMemVar('LLMULCURR') AND PADR(loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value,3)<>PADR(oAriaApplication.BaseCurrency,3) )  &&lower  &&lower
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    *Old: SHOW GET pbAPVInvDt DISABLE &&Revise

    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *loFormSet.AriaForm1.cmdInvLines.Enabled = .F.
    LOFORMSET.ARIAFORM1.PGFPAYINV.PGDET.ENABLED = .F.
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

  ELSE
    *Old: SHOW GET pbAPVInvDt ENABLE &&Revise

    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *loFormSet.AriaForm1.cmdInvLines.Enabled = .T.
    LOFORMSET.ARIAFORM1.PGFPAYINV.PGDET.ENABLED = .T.
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

  ENDIF
ENDIF
LOFORMSET.LLBROWSE = .F.

*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*loFormSet.AriaForm1.kbCurrCode.Selectedfrombrowse = loFormSet.llBrowse
LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.SELECTEDFROMBROWSE = LOFORMSET.LLBROWSE
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

SELECT APINVHDR

RETURN
*--end of lfvCurrency


*!*************************************************************
*! Name      : lfvExRate
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 7/29/2004
*! Purpose   : To Validate The Exchange Rate.
*!*************************************************************
*! Parameters: loFormSet
*!*************************************************************
*! Returns   : None
*!*************************************************************
FUNCTION LFVEXRATE
PARAMETERS LOFORMSET

IF !INLIST(LOFORMSET.ACTIVEMODE,'A','E')
  RETURN
ENDIF

*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*!*	IF loFormSet.AriaForm1.txtNexRate.Value <= 0  &&lower
*!*	  loFormSet.AriaForm1.txtNexRate.Value = loFormSet.AriaForm1.txtNexRate.OldValue  &&lower
IF LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTNEXRATE.VALUE <= 0  &&lower
  LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTNEXRATE.VALUE = LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTNEXRATE.OLDVALUE  &&lower
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
ENDIF
*Old: SHOW GET loFormSet.AriaForm1.txtNexRate.Value  &&lower &&Revise

RETURN
*--end of lfvExRate


*!*************************************************************
*! Name      : lfvPayMethd
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 7/29/2004
*! Purpose   : To Validate The Payment Methods Control.
*!*************************************************************
*! Parameters: loFormSet
*!*************************************************************
*! Returns   : True or False
*!*************************************************************
FUNCTION LFVPAYMETHD
PARAMETERS LOFORMSET

IF !INLIST(LOFORMSET.ACTIVEMODE,'A','E')
  RETURN
ENDIF

*Old: loFormSet.AriaForm1.cboVendPmeth.Value = loFormSet.laPayMethd[puMethod,2]  &&lower

*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*IF loFormSet.AriaForm1.cboVendPmeth.Value = 'C' .AND. loFormSet.AriaForm1.txtInvAmount.Value < 0
IF LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.CBOVENDPMETH.VALUE = 'C' .AND. LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTINVAMOUNT.VALUE < 0
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  ** MESSAGE : " You can not pay the debit invoice "
  **           " by credit card.                   "
  **           "                  Ok             "
  =GFMODALGEN("TRM04041B00000","DIALOG")

  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	  loFormSet.AriaForm1.cboVendPmeth.Value  = loFormSet.AriaForm1.cboVendPmeth.OldValue  &&lower
  *!*	  loFormSet.lcPayMethd = loFormSet.laPayMethd[AT(loFormSet.AriaForm1.cboVendPmeth.Value,'PMNCH'),1]  &&lower
  LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.CBOVENDPMETH.VALUE  = LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.CBOVENDPMETH.OLDVALUE  &&lower
  LOFORMSET.LCPAYMETHD = LOFORMSET.LAPAYMETHD[AT(loFormSet.AriaForm1.pgfpayInv.pgHead.cboVendPmeth.Value,'PMNCH'),1]  &&lower
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

  *_CUROBJ    = _CUROBJ&&Old CurObj
  *=lfRefresh()
  RETURN 0
ENDIF


*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*IF !EMPTY(apinvhdr.cvenccven) .AND. loFormSet.AriaForm1.cboVendPmeth.Value = 'C'
IF !EMPTY(APINVHDR.CVENCCVEN) .AND. LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.CBOVENDPMETH.VALUE = 'C'
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

  ** MESSAGE : " This invoice is a credit card pqayment   "
  **           " for vendor  Invoice . You cannot change"
  **           " to a credit card payment.                "
  **           "                     Ok                 "
  =GFMODALGEN("TRM04145B00000","DIALOG",ALLTRIM(APINVHDR.CVENCCVEN)+"|"+ALLTRIM(APINVHDR.CVENCCINV)))

  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	  loFormSet.AriaForm1.cboVendPmeth.Value  = loFormSet.AriaForm1.cboVendPmeth.OldValue
  *!*	  loFormSet.lcPayMethd = loFormSet.laPayMethd[AT(loFormSet.AriaForm1.cboVendPmeth.Value,'PMNCH'),1]
  LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.CBOVENDPMETH.VALUE  = LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.CBOVENDPMETH.OLDVALUE
  LOFORMSET.LCPAYMETHD = LOFORMSET.LAPAYMETHD[AT(loFormSet.AriaForm1.pgfpayInv.pgHead.cboVendPmeth.Value,'PMNCH'),1]
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  *_CUROBJ    = _CUROBJ&&Old CurObj
  *=lfRefresh()
  RETURN 0
ENDIF

SELECT APINVAHD

*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*!*	lcSavOrder = SET('ORDER')
*!*	SET ORDER TO TAG TVENDINV
LCSAVORDER = ORDER()
=GFSETORDER('TVENDINV')
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
LCSAVEXACT = SET('EXACT')
SET EXACT ON

IF SEEK('I'+LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE+;
    LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE) .AND. LOFORMSET.ACTIVEMODE="E"
  ** MESSAGE : " This invoice has corresponding instalment "
  **           " record.  .
  **           "                      Ok                 "

  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	  lcNewPay  = loFormSet.laPayMethd[AT(loFormSet.AriaForm1.cboVendPmeth.Value,'PMNCH'),1]
  LCNEWPAY  = LOFORMSET.LAPAYMETHD[AT(loFormSet.AriaForm1.pgfpayInv.pgHead.cboVendPmeth.Value,'PMNCH'),1]
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

  LCTISTCOR = LOFORMSET.LCTCRDTCOR+ALLTRIM(LOWER(LCNEWPAY))

  =GFMODALGEN("TRM04120B00000","DIALOG",LCTISTCOR)

  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	  loFormSet.AriaForm1.cboVendPmeth.Value  = loFormSet.AriaForm1.cboVendPmeth.OldValue
  *!*	  loFormSet.lcPayMethd = loFormSet.laPayMethd[AT(loFormSet.AriaForm1.cboVendPmeth.Value,'PMNCH'),1]  &&lower
  LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.CBOVENDPMETH.VALUE  = LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.CBOVENDPMETH.OLDVALUE
  LOFORMSET.LCPAYMETHD = LOFORMSET.LAPAYMETHD[AT(loFormSet.AriaForm1.pgfpayInv.pgHead.cboVendPmeth.Value,'PMNCH'),1]  &&lower
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

  *_CUROBJ    = _CUROBJ&&Old CurObj

  *=lfRefresh()

  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *SET ORDER TO &lcSavOrder
  =GFSETORDER(LCSAVORDER)
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

  SET EXACT &LCSAVEXACT
  RETURN 0
ENDIF

*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*SET ORDER TO &lcSavOrder
=GFSETORDER(LCSAVORDER)
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

SET EXACT &LCSAVEXACT

*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*!*	IF loFormSet.AriaForm1.cboVendPmeth.Value = 'C'    && If the user select the credit card payment.  &&lower
IF LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.CBOVENDPMETH.VALUE = 'C'    && If the user select the credit card payment.  &&lower
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

  ** If the amount paid + the discount taken not equal to 0.
  IF APINVHDR.NINVPAID+APINVHDR.NINVDISTK+APINVHDR.NINVADJ > 0
    ** MESSAGE : " You can not change to credit card payment "
    **           " for fully or partially paid invoice.      "
    **           "                     Ok                  "

    =GFMODALGEN("TRM04012B00000","DIALOG")

    *Old: SHOW GET pbApprove,1 PROMPT '\<Approve for payment...' &&Revise

    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *loFormSet.AriaForm1.cmdApprove.Caption = '\<Approve for payment...'
    *!*	    loFormSet.AriaForm1.cboVendPmeth.Value =  loFormSet.AriaForm1.cboVendPmeth.OldValue
    LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.CBOVENDPMETH.VALUE =  LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.CBOVENDPMETH.OLDVALUE
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    *_CUROBJ   = _CUROBJ&&Old CurObj

    *=lfRefresh()
    RETURN 0

  ELSE
    *Old: SHOW GET pbApprove,1 PROMPT 'Credit c\<ard payment...' &&Revise
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *loFormSet.AriaForm1.cmdApprove.Caption = 'Credit c\<ard payment...'
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

    ** We are going to intialize the approved payments screen objects with 0.
    REPLACE APINVHDR.CBNKCODE WITH SPACE(8)
    REPLACE APINVHDR.CCHKACCT WITH SPACE(12)
    REPLACE APINVHDR.CCHKGLACC WITH LOFORMSET.ARIAFORM1.AP1.LCEMPTYACC
    REPLACE APINVHDR.NINVDISAP WITH 0.00
    REPLACE APINVHDR.NINVAMTAP WITH 0.00

    REPLACE APINVHDR.NINVFAAP WITH 0.00

    REPLACE APINVHDR.NINVADJAP WITH 0.00
    REPLACE APINVHDR.NINVA1099 WITH 0.00
    LOFORMSET.LNTOTAPPPAY = 0.00
  ENDIF
ELSE
  *Old: SHOW GET pbApprove,1 PROMPT '\<Approve for payment...' &&Revise
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  * loFormSet.AriaForm1.cmdApprove.Caption = '\<Approve for payment...'
  *!*	  IF (loFormSet.AriaForm1.cboVendPmeth.OldValue = 'H' .AND. loFormSet.AriaForm1.cboVendPmeth.Value <> 'H') .OR.;
  *!*	     (loFormSet.AriaForm1.cboVendPmeth.OldValue $ 'MPN' .AND. loFormSet.AriaForm1.cboVendPmeth.Value = 'H')
  IF (LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.CBOVENDPMETH.OLDVALUE = 'H' .AND. LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.CBOVENDPMETH.VALUE <> 'H') .OR.;
      (LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.CBOVENDPMETH.OLDVALUE $ 'MPN' .AND. LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.CBOVENDPMETH.VALUE = 'H')
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    REPLACE APINVHDR.NINVDISAP WITH 0.00
    REPLACE APINVHDR.NINVAMTAP WITH 0.00

    REPLACE APINVHDR.NINVFAAP WITH 0.00

    REPLACE APINVHDR.NINVA1099 WITH 0.00
    REPLACE APINVHDR.CBNKCODE WITH ' '
    REPLACE APINVHDR.CCHKACCT WITH ' '
    REPLACE APINVHDR.CCHKGLACC WITH LOFORMSET.ARIAFORM1.AP1.LCEMPTYACC
    REPLACE APINVHDR.NINVADJAP WITH 0
    LOFORMSET.LNTOTAPPPAY = 0.00
  ENDIF

  REPLACE APINVHDR.CVENCCVEN WITH ;
    IIF(LOFORMSET.LLPAIDBYCRD,APINVHDR.CVENCCVEN,SPACE(8))
  REPLACE APINVHDR.CVENCCINV WITH ;
    IIF(LOFORMSET.LLPAIDBYCRD,APINVHDR.CVENCCINV,SPACE(12))
  LOFORMSET.LCACCOUNT  = LOFORMSET.ARIAFORM1.AP1.LCEMPTYACC

ENDIF
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
SELECT APINVHDR
=GFREPLACE("")
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
*=lfRefresh()    && refresh says filed on the screen

*B128399,1 KHM 06/15/2005 Return 0 to stay in the popup [Begin]
*RETURN 1
RETURN 0
*B128399,1 KHM 06/15/2005 [End]
*--end of lfvPayMethd


*!*************************************************************
*! Name      : lfvDueDays
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 7/29/2004
*! Purpose   : To Validate The Due Days.
*!*************************************************************
*! Parameters: loFormSet
*!*************************************************************
*! Returns   : None
*!*************************************************************
FUNCTION LFVDUEDAYS
PARAMETERS LOFORMSET

IF !INLIST(LOFORMSET.ACTIVEMODE,'A','E')
  RETURN
ENDIF
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*!*	IF loFormSet.AriaForm1.txtterdued.Value < 0  &&lower
*!*	  loFormSet.AriaForm1.txtterdued.Value = loFormSet.AriaForm1.txtterdued.OldValue
IF LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTTERDUED.VALUE < 0  &&lower
  LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTTERDUED.VALUE = LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTTERDUED.OLDVALUE
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  *Old: SHOW GET loFormSet.AriaForm1.txtterdued.Value  &&lower &&Revise
ELSE
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	  loFormSet.AriaForm1.dtInvDuDat.Value  = ;
  *!*	    lfGetdueD(loFormSet.AriaForm1.DtInvDate.Value,loFormSet.AriaForm1.txtterdued.Value,;
  *!*	    loFormSet.lnEomDay)
  *! B609614,1 TMI 07/25/2011 Fix bug of wrong AP invoice Due date[Start]
  *loFormSet.AriaForm1.pgfpayInv.pgHead.dtInvDuDat.VALUE  = ;
  lfGetdueD(loFormSet.AriaForm1.pgfpayInv.pgHead.DtInvDate.VALUE,loFormSet.AriaForm1.pgfpayInv.pgHead.txtterdued.VALUE,;
  loFormSet.lnEomDay)
  LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.DTINVDUDAT.VALUE  = ;
    LFGETDUED(LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.DTINVDATE.VALUE,LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTTERDUED.VALUE,;
    LOFORMSET.LNEOMDAY,LOFORMSET.LCEOM)
  *! B609614,1 TMI 07/25/2011 Fix bug of wrong AP invoice Due date[END]
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
ENDIF

RETURN
*--end of lfvDueDays

*!*************************************************************
*! Name      : lfvDueDate
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 7/29/2004
*! Purpose   : To Validate The Due Date.
*!*************************************************************
*! Parameters: loFormSet
*!*************************************************************
*! Returns   : None
*!*************************************************************
FUNCTION LFVDUEDATE
PARAMETERS LOFORMSET

IF !INLIST(LOFORMSET.ACTIVEMODE,'A','E')
  RETURN
ENDIF

*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*IF loFormSet.AriaForm1.dtInvDuDat.Value < loFormSet.AriaForm1.DtInvDate.Value
IF LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.DTINVDUDAT.VALUE < LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.DTINVDATE.VALUE
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  ** MESSAGE : " The due date can not be less than  "
  **           " the invoice date.                  "
  **           "                 Ok               "
  =GFMODALGEN("TRM04016B00000","DIALOG")
  *_CUROBJ = _CUROBJ&&Old CurObj
  *Old: SHOW GET loFormSet.AriaForm1.dtInvDuDat.Value  &&lower &&Revise
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	  loFormSet.AriaForm1.dtInvDuDat.Value = loFormSet.AriaForm1.dtInvDuDat.OldValue
  LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.DTINVDUDAT.VALUE = LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.DTINVDUDAT.OLDVALUE
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  RETURN 0
ELSE
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	  loFormSet.AriaForm1.txtterdued.Value = ;
  *!*	    loFormSet.AriaForm1.dtInvDuDat.Value - loFormSet.AriaForm1.DtInvDate.Value
  LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTTERDUED.VALUE = ;
    LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.DTINVDUDAT.VALUE - LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.DTINVDATE.VALUE
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  *Old: SHOW GET loFormSet.AriaForm1.txtterdued.Value  &&lower &&Revise
ENDIF

RETURN
*--end of lfvDueDate


*!*************************************************************
*! Name      : lfvDiscDays
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 7/29/2004
*! Purpose   : To Validate The Discount Days.
*!*************************************************************
*! Parameters: loFormSet
*!*************************************************************
*! Returns   : None
*!*************************************************************
FUNCTION LFVDISCDAYS
PARAMETERS LOFORMSET

IF !INLIST(LOFORMSET.ACTIVEMODE,'A','E')
  RETURN
ENDIF

*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*!*	IF loFormSet.AriaForm1.txtTerDiscd.Value < 0  &&lower
*!*	  loFormSet.AriaForm1.txtTerDiscd.Value = loFormSet.AriaForm1.txtTerDiscd.OldValue
*!*	ENDIF
IF LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTTERDISCD.VALUE < 0  &&lower
  LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTTERDISCD.VALUE = LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTTERDISCD.OLDVALUE
ENDIF
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
*Old: SHOW GET loFormSet.AriaForm1.txtTerDiscd.Value  &&lower &&Revise

RETURN
*--end of lfvDiscDays


*!*************************************************************
*! Name      : lfvDiscPer
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 7/29/2004
*! Purpose   : To Validate The Discount Percentage.
*!*************************************************************
*! Parameters: loFormSet
*!*************************************************************
*! Returns   : None
*!*************************************************************
FUNCTION LFVDISCPER
PARAMETERS LOFORMSET

IF !INLIST(LOFORMSET.ACTIVEMODE,'A','E')
  RETURN
ENDIF

*Execute the validation only in case of the disc. amount is > 0
*OR the Disc % is changed
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*!*	IF (loFormSet.AriaForm1.txtTerDiscr.Value <> loFormSet.AriaForm1.txtTerDiscr.OldValue) .OR. ;
*!*	  (loFormSet.AriaForm1.txtTerDiscr.Value > 0 AND loFormSet.AriaForm1.txtInvDisof.Value > 0)
*!*	  IF loFormSet.AriaForm1.txtTerDiscr.Value < 0
*!*	    loFormSet.AriaForm1.txtTerDiscr.Value = loFormSet.AriaForm1.txtTerDiscr.OldValue
IF (LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTTERDISCR.VALUE <> LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTTERDISCR.OLDVALUE) .OR. ;
    (LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTTERDISCR.VALUE > 0 AND LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTINVDISOF.VALUE > 0)
  IF LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTTERDISCR.VALUE < 0
    LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTTERDISCR.VALUE = LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTTERDISCR.OLDVALUE
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    *Old: SHOW GET loFormSet.AriaForm1.txtTerDiscr.Value  &&lower &&Revise
  ELSE
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *!*	    IF loFormSet.AriaForm1.txtInvAmount.Value > 0  &&lower
    *!*	      loFormSet.AriaForm1.txtInvDisof.Value = ;
    *!*	        (loFormSet.AriaForm1.txtTerDiscr.Value * loFormSet.AriaForm1.txtInvAmount.Value) / 100
    IF LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTINVAMOUNT.VALUE > 0  &&lower
      LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTINVDISOF.VALUE = ;
        (LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTTERDISCR.VALUE * LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTINVAMOUNT.VALUE) / 100
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      *Old: SHOW GET loFormSet.AriaForm1.txtInvDisof.Value  &&lower &&Revise
    ENDIF
  ENDIF
ENDIF



*Old: SHOW GET loFormSet.AriaForm1.txtInvDisof.Value  &&lower &&Revise

RETURN
*--end of lfvDiscPer


*!*************************************************************
*! Name      : lfvTemplate
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 7/29/2004
*! Purpose   : To Validate The Template Control.
*!*************************************************************
*! Parameters: loFormSet
*!*************************************************************
*! Returns   : None
*!*************************************************************
* Valid function for get field laData[38] representing template code.
*
FUNCTION LFVTEMPLATE
PARAMETERS LOFORMSET

IF !INLIST(LOFORMSET.ACTIVEMODE,'A','E')
  RETURN
ENDIF
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*loFormSet.llBrowse = loFormSet.AriaForm1.kbAutmCode.Selectedfrombrowse
LOFORMSET.LLBROWSE = LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBAUTMCODE.SELECTEDFROMBROWSE
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
*IF Statment to check if the template field is empty
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*IF EMPTY(loFormSet.AriaForm1.kbAutmCode.KeyTextBox.Value) .AND. !loFormSet.llBrowse  &&lower
IF EMPTY(LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBAUTMCODE.KEYTEXTBOX.VALUE) .AND. !LOFORMSET.LLBROWSE  &&lower
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  RETURN
ENDIF

SELECT APINVAHD

*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*!*	loFormSet.AriaForm1.kbAutmCode.KeyTextBox.Value     = ;
*!*	  ALLTRIM(loFormSet.AriaForm1.kbAutmCode.KeyTextBox.Value)
*!*	loFormSet.AriaForm1.kbAutmCode.KeyTextBox.Value     = ;
*!*	  IIF(ISDIGIT(LEFT(loFormSet.AriaForm1.kbAutmCode.KeyTextBox.Value,1)),;
*!*	    PADL(loFormSet.AriaForm1.kbAutmCode.KeyTextBox.Value, FSIZE('cAutMCode','APINVAHD'),'0'),;
*!*	    PADR(loFormSet.AriaForm1.kbAutmCode.KeyTextBox.Value,FSIZE('cAutMCode','APINVAHD')))
LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBAUTMCODE.KEYTEXTBOX.VALUE     = ;
  ALLTRIM(LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBAUTMCODE.KEYTEXTBOX.VALUE)
LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBAUTMCODE.KEYTEXTBOX.VALUE     = ;
  IIF(ISDIGIT(LEFT(LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBAUTMCODE.KEYTEXTBOX.VALUE,1)),;
  PADL(LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBAUTMCODE.KEYTEXTBOX.VALUE, FSIZE('cAutMCode','APINVAHD'),'0'),;
  PADR(LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBAUTMCODE.KEYTEXTBOX.VALUE,FSIZE('cAutMCode','APINVAHD')))
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
LOFORMSET.LCTMPLATE = 'ENABLE'
*Old: SHOW GET loFormSet.AriaForm1.kbAutmCode.KeyTextBox.Value  &&lower &&Revise
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*loFormSet.AriaForm1.kbAutmCode.Enabled = (loFormSet.lcTmplate='ENABLE')
*IF !loFormSet.llBrowse .AND. ;
loFormSet.AriaForm1.pgfpayInv.pgHead.kbAutmCode.KeyTextBox.OldValue = loFormSet.AriaForm1.kbAutmCode.KeyTextBox.Value
LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBAUTMCODE.ENABLED = (LOFORMSET.LCTMPLATE='ENABLE')
IF !LOFORMSET.LLBROWSE .AND. ;
    LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBAUTMCODE.KEYTEXTBOX.OLDVALUE = LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBAUTMCODE.KEYTEXTBOX.VALUE
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  RETURN
ENDIF

*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*!*	IF loFormSet.llBrowse .OR. !EMPTY(loFormSet.AriaForm1.kbAutmCode.KeyTextBox.Value) ;
*!*	  .AND. LASTKEY() = 13
*!*	  IF loFormSet.llBrowse .OR. !SEEK('T'+loFormSet.AriaForm1.kbAutmCode.KeyTextBox.Value) .OR. ;
*!*	    ATC("?",loFormSet.AriaForm1.kbAutmCode.KeyTextBox.Value) > 0
IF LOFORMSET.LLBROWSE .OR. !EMPTY(LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBAUTMCODE.KEYTEXTBOX.VALUE) ;
    .AND. LASTKEY() = 13
  IF LOFORMSET.LLBROWSE .OR. !SEEK('T'+LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBAUTMCODE.KEYTEXTBOX.VALUE) .OR. ;
      ATC("?",LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBAUTMCODE.KEYTEXTBOX.VALUE) > 0
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    LNCLOSREC  = RECNO(0)
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *IF SEEK('T')
    IF GFSEEK('T')
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      DIMENSION LATEMP[2]

      LATEMP = ''

      *lcSavBrFld = lcBrFields
      *lcSavTitle = lcFile_Ttl
      *N000682,1 MMT 11/22/2012 Globalization changes[Start]
      *LCBRFIELDS = "CAUTMCODE :H= 'Template code'"

      *LCFILE_TTL = "Automatic invoices header"
      *N000682,1 11/20/2012 MMT Globlization changes[Start]
      *LCBRFIELDS = "CAUTMCODE :H= '"+LANG_APPYINV_TEMPLATECODE+"'"
       LCBRFIELDS = "CAUTMCODE :H= '"+IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_TEMPLATECODE,loFormSet.GetHeaderText("LANG_APPYINV_TEMPLATECODE",loFormSet.HeaderAlias))+"'"
      *N000682,1 11/20/2012 MMT Globlization changes[End]

      *N000682,1 11/20/2012 MMT Globlization changes[Start]
      *LCFILE_TTL = LANG_APPYINV_AUTOMTICINVOICEHEADER
      LCFILE_TTL = IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_AUTOMTICINVOICEHEADER,loFormSet.GetHeaderText("LANG_APPYINV_AUTOMTICINVOICEHEADER",loFormSet.HeaderAlias))
      *N000682,1 11/20/2012 MMT Globlization changes[End]

      *N000682,1 MMT 11/22/2012 Globalization changes[END]
      IF BETWEEN(LNCLOSREC,1,RECCOUNT('APINVAHD'))
        GO LNCLOSREC
      ELSE
        GO TOP
      ENDIF

      *! E302623,2 MMT 10/12/2009 Convert Payable invoice screen to use SQL tables[Start]
      *=gfBrows([FOR CAUTMTYPE = 'T'],'CAUTMTYPE,CAUTMCODE','laTemp')
      *! E302623,3 MMT 01/03/2010 Convert Payable invoice screen to use SQL tables[Start]
      *=gfBrows([FOR CAUTMTYPE = 'T'],'CAUTMTYPE,CAUTMCODE','laTemp',lcFile_Ttl )
      =ARIABROW([FOR CAUTMTYPE = 'T'], LCFILE_TTL , .F., .F., .F., .F., .F., .T., ;
        'CAUTMTYPE,CAUTMCODE', 'laTemp', .F., .F., .F., ;
        .F., .F., .F., .F., .F., ;
        .F., .F.)
      *! E302623,3 MMT 01/03/2010 Convert Payable invoice screen to use SQL tables[End]
      *! E302623,2 MMT 10/12/2009 Convert Payable invoice screen to use SQL tables[End]

      *lcBrFields = lcSavBrFld
      *lcFile_Ttl = lcSavTitle

      IF !EMPTY(LATEMP[1])
        REPLACE APINVHDR.CAUTMTYPE WITH LATEMP[1] IN APINVHDR
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        *loFormSet.AriaForm1.kbAutmCode.KeyTextBox.Value = laTemp[2]
        LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBAUTMCODE.KEYTEXTBOX.VALUE = LATEMP[2]
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      ELSE
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        *!*	        loFormSet.AriaForm1.kbAutmCode.KeyTextBox.Value = ;
        *!*	          loFormSet.AriaForm1.kbAutmCode.KeyTextBox.OldValue
        LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBAUTMCODE.KEYTEXTBOX.VALUE = ;
          LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBAUTMCODE.KEYTEXTBOX.OLDVALUE
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      ENDIF
    ELSE
      ** MESSAGE : " There are no records to display. "
      **           "                Ok              "
      =GFMODALGEN('QRM00052B00000','Dialog')

      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *!*	      REPLACE apinvhdr.cautmtype WITH ' ' IN apinvhdr
      *!*	      loFormSet.AriaForm1.kbAutmCode.KeyTextBox.Value = ;
      *!*	        loFormSet.AriaForm1.kbAutmCode.KeyTextBox.OldValue
      REPLACE APINVHDR.CAUTMTYPE WITH ' ' IN APINVHDR
      LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBAUTMCODE.KEYTEXTBOX.VALUE = ;
        LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBAUTMCODE.KEYTEXTBOX.OLDVALUE
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

    ENDIF
  ELSE

    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *IF SEEK('T'+loFormSet.AriaForm1.kbAutmCode.KeyTextBox.Value)
    IF GFSEEK('T'+LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBAUTMCODE.KEYTEXTBOX.VALUE)
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      REPLACE APINVHDR.CAUTMTYPE WITH APINVAHD.CAUTMTYPE IN APINVHDR
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *loFormSet.AriaForm1.kbAutmCode.KeyTextBox.Value  = APINVAHD.CAUTMCODE
      LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBAUTMCODE.KEYTEXTBOX.VALUE  = APINVAHD.CAUTMCODE
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    ENDIF
  ENDIF
ELSE
  REPLACE APINVHDR.CAUTMTYPE WITH ' ' IN APINVHDR
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	  loFormSet.AriaForm1.kbAutmCode.KeyTextBox.Value = ;
  *!*	    loFormSet.AriaForm1.kbAutmCode.KeyTextBox.OldValue
  LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBAUTMCODE.KEYTEXTBOX.VALUE = ;
    LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBAUTMCODE.KEYTEXTBOX.OLDVALUE
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
ENDIF

*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*IF !EMPTY(loFormSet.AriaForm1.kbAutmCode.KeyTextBox.Value)
IF !EMPTY(LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBAUTMCODE.KEYTEXTBOX.VALUE)
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  IF APVENDOR.CTAXTYPE <> APINVAHD.CAUTMBASE
    ** MESSAGE : "You cannot use this distribution    "
    **           "template since the vendor tax type  "
    **           "is  and the template lines uses tax"
    **           "type .                             "
    **           "                 Ok               "
    LCVENDTAX = IIF(APVENDOR.CTAXTYPE  = 'L','line item tax','percentage of the total')
    LCTEMPTAX = IIF(APINVAHD.CAUTMBASE = 'L','line item tax','percentage of the total')
    =GFMODALGEN("TRM04109B00000","DIALOG",LCVENDTAX+"|"+LCTEMPTAX)
    REPLACE APINVHDR.CAUTMTYPE WITH ' ' IN APINVHDR

    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *!*	    loFormSet.AriaForm1.kbAutmCode.KeyTextBox.Value = ;
    *!*	      loFormSet.AriaForm1.kbAutmCode.KeyTextBox.OldValue
    LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBAUTMCODE.KEYTEXTBOX.VALUE = ;
      LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBAUTMCODE.KEYTEXTBOX.OLDVALUE
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  ELSE
    *Old: IF WVISIBLE('CWRAPDISTR')
    *Old: =gfChClose('CWRAPDISTR')
    *Old: ENDIF
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *!*	    IF loFormSet.DistLines.Visible
    *!*	      loFormSet.DistLines.Visible = .F.
    IF LOFORMSET.ARIAFORM1.PGFPAYINV.PGDIST.ENABLED
      LOFORMSET.ARIAFORM1.PGFPAYINV.PGDIST.ENABLED = .F.
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    ENDIF
  ENDIF
ENDIF

LOFORMSET.LLBROWSE = .F.
LOFORMSET.LCTMPLATE = 'ENABLE'
*Old: SHOW GET loFormSet.AriaForm1.kbAutmCode.KeyTextBox.Value  &&lower &&Revise

SELECT APINVHDR
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
=GFREPLACE('')
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[ENd]

RETURN
*--end of lfvTemplate


*!*************************************************************
*! Name      : gfRemit
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 7/29/2004
*! Purpose   : Global Function.
*!*************************************************************
*! Parameters: Many
*!*************************************************************
*! Returns   : lcRmtToCode
*!*************************************************************
FUNCTION GFREMIT
PARAMETERS LCRMTTOCODE, LLACTPOPUP, LCVENDCODE, LCFACTCODE, LCREMITSTAT,;
  LCREMITCMP, LCREMITAD1, LCREMITAD2, LCREMITAD3,LCREMITAD4,LCREMITAD5, LNROW, LNCOL,;
  LCARRNAME, LCDISPSTR, LNPOPWDTH
*** lcRmtToCode : normally ('V', 'F', 'O')
*** llActPopup  : .T. if the popup is to be activated
*** lcVendCode  : vendor code
*** lcFactCode  : factor code
*** lcRemitStat : remit objects display status
*** lcRemitCmp  : remit company object name
*** lcRemitAd1  : remit address1 object name
*** lcRemitAd2  : remit address2 object name
*** lcRemitAd3  : remit address(3+4+5) object name
*** lnRow       : DOS popup top left row
*** lnCol       : DOS popup top left column
*** lcArrName   : remit to array name
*** lcDispStr   : display string of the popup
*** lnPopWdth   : dos popup width
*** example call from APPYINV.PRG
*** laData[5]    = lfRemit(laData[5], !llJustShow, laData[1], laData[36],;
***              @lcRemitStat, 'laData[6]', 'laData[7]', 'laData[8]', 'laData[9]',;
***              6, 39, 'laRemitTo', @lcRemitTo, lnRemitLen)
PRIVATE LCREMITFIL, LCREMITTAG, LCKEYCODE

*Old: IF llActPopup
*Old: lcRmtToCode = lfvPopups(lcArrName, @lcDispStr,;
lnRow, lnCol, lnPopWdth)
*Old: ELSE
LCRMTTOCODE = UPPER(ALLTRIM(LCRMTTOCODE))
*Old: ENDIF

LCKEYCODE = IIF(LCRMTTOCODE = 'V', LCVENDCODE, LCFACTCODE)
STORE .F. TO LLOPVEN, LLOPFACT

IF LCRMTTOCODE = 'V'
  **! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *lcRemitFil = 'APVENDOR'
  LCREMITFIL = 'APVENDOR_A'
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  LCREMITTAG = 'VENCODE'
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *llOpVen    = gfOpenFile(oAriaApplication.DataDir+'APVENDOR','VENCODE','SH')  &&lower
  LLOPVEN    = GFOPENTABLE('APVENDOR','VENCODE','SH','APVENDOR_A')  &&lower
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
ELSE
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *lcRemitFil = 'SYCFACT'
  LCREMITFIL = 'SYCFACT_A'
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  LCREMITTAG = 'CFACCODE'

  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *llOpFact   = gfOpenFile(oAriaApplication.SysPath+'SYCFACT','CFACCODE','SH')  &&lower
  LLOPFACT   = GFOPENTABLE(OARIAAPPLICATION.SYSPATH+'SYCFACT','CFACCODE','SH','SYCFACT_A')  &&lower
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

ENDIF

DO CASE
CASE LCRMTTOCODE $ 'VF'

  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *IF SEEK(lcKeyCode, lcRemitFil)
  *!*	      &lcRemitCmp  = PADR(IIF(lcRmtToCode = 'V',;
  *!*	                       APVENDOR.cVenComp, SYCFACT.cFacComp), 40)
  IF GFSEEK(LCKEYCODE, LCREMITFIL)
    &LCREMITCMP  = PADR(IIF(LCRMTTOCODE = 'V',;
      APVENDOR_A.CVENCOMP, SYCFACT_A.CFACCOMP), 40)
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    &LCREMITAD1 = GFGETADR(LCREMITFIL, LCREMITTAG,.F.,.F.,1)
    &LCREMITAD2 = GFGETADR(LCREMITFIL, LCREMITTAG,.F.,.F.,2)
    &LCREMITAD3 = GFGETADR(LCREMITFIL, LCREMITTAG,.F.,.F.,3)
    &LCREMITAD4 = GFGETADR(LCREMITFIL, LCREMITTAG,.F.,.F.,4)
    &LCREMITAD5 = GFGETADR(LCREMITFIL, LCREMITTAG,.F.,.F.,5)
  ELSE
    STORE SPACE(40) TO &LCREMITCMP, &LCREMITAD1,;
      (LCREMITAD2), (LCREMITAD3),;
      (LCREMITAD4), (LCREMITAD5)
  ENDIF
  LCREMITSTAT= 'DISABLE'
OTHERWISE
  LCREMITSTAT= IIF(LOFORMSET.ACTIVEMODE="V",'DISABLE','ENABLE')
ENDCASE

*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*IF USED('APVENDOR') .AND. llOpVen
IF USED('APVENDOR_A') .AND. LLOPVEN
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  *=gfCloseFile('APVENDOR')
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *USE IN APVENDOR
  =GFCLOSETABLE('APVENDOR_A')
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
ENDIF
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*IF USED('SYCFACT') .AND. llOpFact
IF USED('SYCFACT_A') .AND. LLOPFACT
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  *=gfCloseFile('SYCFACT')
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *USE IN SYCFACT
  =GFCLOSETABLE('SYCFACT_A')
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
ENDIF
*Old: SHOW GET (lcRemitCmp) &lcRemitStat &&Revise
*Old: SHOW GET (lcRemitAd1) &lcRemitStat &&Revise
*Old: SHOW GET (lcRemitAd2) &lcRemitStat &&Revise
*Old: SHOW GET (lcRemitAd3) &lcRemitStat &&Revise
*Old: SHOW GET (lcRemitAd4) &lcRemitStat &&Revise
*Old: SHOW GET (lcRemitAd5) &lcRemitStat &&Revise
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*IF type('_Screen.ActiveForm.txtOutcomp,Value')='C'
*WITH _Screen.ActiveForm
IF TYPE('_Screen.ActiveForm.pgfpayInv.pgHead.txtOutcomp,Value')='C'
  WITH _SCREEN.ACTIVEFORM.PGFPAYINV.PGHEAD
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    STORE (LCREMITSTAT='ENABLE') TO .TXTOUTCOMP.ENABLED, .TXTOUTADDR1.ENABLED, ;
      .TXTOUTADDR2.ENABLED,  .TXTOUTADDR3.ENABLED
  ENDWITH
ENDIF
RETURN LCRMTTOCODE

RETURN
*--end of gfRemit


*!*************************************************************
*! Name      : lfGetFac
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 7/29/2004
*! Purpose   : Global Function used by the validation function of the Factor Control.
*!*************************************************************
*! Parameters: lcOldVal, llBrowse
*!*************************************************************
*! Returns   : llFactFound
*!*************************************************************
FUNCTION LFGETFAC
*PARAMETERS LCOLDVAL, LLBROWSE
*** Old factor value
*** .T. if browsed from browsing invisible button
*PRIVATE LCPRFACTOR, LOFACTOBJ, LCCURALIAS, LNSAVFACTG, LNCLOSREC,;
*  LLFACTFOUND, LLOPENFACT, LCFILE_TTL, LCBRFIELDS


*B609775,1 MMT 12/15/2011 Error while browsing factors in Payable invoice screen[START]
*PARAMETERS lcOldVal, llBrowse
*** Old factor value
*** .T. if browsed from browsing invisible button

*!*  PRIVATE lcPrFactor, loFactObj, lcCurAlias, lnSavFacTg, lnClosRec,;
*!*          llFactFound, llOpenFact, lcFile_Ttl, lcBrFields

*!*  loFactObj    = IIF(TYPE('_Screen.ActiveForm.ActiveControl.value')='C', ;
*!*                     _Screen.ActiveForm.ActiveControl, ;
*!*                     _Screen.ActiveForm.ActiveControl.Parent.KeyTextBox)
*!*  lcPrFactor     = ALLTRIM(loFactObj.Value)
PARAMETERS LCVALFACT, LLBROWSE
PRIVATE LCPRFACTOR, LCCURALIAS, LNSAVFACTG, LNCLOSREC,;
  LLFACTFOUND, LLOPENFACT, LCFILE_TTL, LCBRFIELDS
LCPRFACTOR     = ALLTRIM(LCVALFACT)
*B609775,1 MMT 12/15/2011 Error while browsing factors in Payable invoice screen[END]



*! E302678,1 MMT 03/24/2010 Convert Payable invoice screen to use SQL tables[Start]
TRY
  *! E302678,1 MMT 03/24/2010 Convert Payable invoice screen to use SQL tables[End]
  LOFACTOBJ    = IIF(TYPE('_Screen.ActiveForm.ActiveControl.value')='C', ;
    _SCREEN.ACTIVEFORM.ACTIVECONTROL, ;
    _SCREEN.ACTIVEFORM.ACTIVECONTROL.PARENT.KEYTEXTBOX)
  LCPRFACTOR     = ALLTRIM(LOFACTOBJ.VALUE)
  *! E302678,1 MMT 03/24/2010 Convert Payable invoice screen to use SQL tables[Start]
CATCH
  RETURN .F.
ENDTRY
*! E302678,1 MMT 03/24/2010 Convert Payable invoice screen to use SQL tables[End]
LLFACTFOUND  = .F.

IF LLBROWSE .OR. !EMPTY(LCPRFACTOR)

  LCCURALIAS = ALIAS()

  IF !USED('SYCFACT')  && Check if the factors file is open or not.
    LLOPENFACT  = .T.     && Indicates that the file is open by the function.
    ** Use the file and assign the index.
    SELECT 0
    *USE &oAriaApplication.SysPath.SYCFACT ORDER TAG cFacCode  &&lower
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *    gfOpenFile(oAriaApplication.SysPath+'SYCFACT','CFACCODE','SH')
    GFOPENTABLE(OARIAAPPLICATION.SYSPATH+'SYCFACT','CFACCODE','SH')
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  ELSE
    LLOPENFACT = .F.
    SELECT SYCFACT

    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *!*	    lnSavFacTg = VAL(SYS(21))
    *!*	    SET ORDER TO TAG cFacCode
    LNSAVFACTG = ORDER()
    =GFSETORDER('cFacCode')
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  ENDIF

  LCPRFACTOR   = PADR(ALLTRIM(LCPRFACTOR), FSIZE('cFacCode','SYCFACT'))
  *Old: &lcFactObj = lcPrFactor
  *LOFACTOBJ.VALUE = LCPRFACTOR
  *B609775,1 MMT 12/15/2011 Error while browsing factors in Payable invoice screen[Start]
  *loFactObj.Value = lcPrFactor
  *B609775,1 MMT 12/15/2011 Error while browsing factors in Payable invoice screen[END]

  *Old: SHOW GET (lcFactObj) &&Revise

  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  * IF llBrowse .OR. !SEEK(lcPrFactor,'SYCFACT')
  IF LLBROWSE .OR. !GFSEEK(LCPRFACTOR,'SYCFACT')
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    *** If a record is to be selected
    DIMENSION LATEMP[1]
    LATEMP = ''
    *N000682,1 MMT 11/22/2012 Globalization changes[Start]
    *LCFILE_TTL = 'Factors'
    *N000682,1 11/20/2012 MMT Globlization changes[Start]
    *LCFILE_TTL = LANG_APPYINV_FACTORS
     LCFILE_TTL = IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_FACTORS,loFormSet.GetHeaderText("LANG_APPYINV_FACTORS",loFormSet.HeaderAlias))
    *N000682,1 11/20/2012 MMT Globlization changes[End]

    *N000682,1 MMT 11/22/2012 Globalization changes[END]
    LCBRFIELDS = ' '
    LNCLOSREC = RECNO(0)

    *** Get browse fields from dictionary
    =GFGETBRF(@LCFILE_TTL, @LCBRFIELDS, 'SYCFACT',;  &&lower
    "CFACCODE,CFACCOMP,CPHONENO,CFAXNO,CFACTITLE,CFACCONT")
    IF BETWEEN(LNCLOSREC,1,RECCOUNT())
      GO LNCLOSREC
    ELSE
      GO TOP
    ENDIF
    *! E302623,2 MMT 10/12/2009 Convert Payable invoice screen to use SQL tables[Start]
    *=gfBrows(.F.,'cFacCode','laTemp')
    *! E302623,3 MMT 01/03/2010 Convert Payable invoice screen to use SQL tables[Start]
    *=gfBrows(.F.,'cFacCode','laTemp',lcFile_Ttl)
    =ARIABROW(.F., LCFILE_TTL , .F., .F., .F., .F., .F., .T., ;
      'cFacCode', 'laTemp', .F., .F., .F., ;
      .F., .F., .F., .F., .F., ;
      .F., .F.)
    *! E302623,3 MMT 01/03/2010 Convert Payable invoice screen to use SQL tables[End]
    *! E302623,2 MMT 10/12/2009 Convert Payable invoice screen to use SQL tables[End]

    *** If a factor has been selected from the browse
    IF !EMPTY(LATEMP[1])
      *Old: &lcFactObj  = laTemp[1]
      *LOFACTOBJ.VALUE = LATEMP[1]
      *B609775,1 MMT 12/15/2011 Error while browsing factors in Payable invoice screen[Start]
      *loFactObj.Value = laTemp[1]
      *B609775,1 MMT 12/15/2011 Error while browsing factors in Payable invoice screen[End]

      LLFACTFOUND = .T.
    ELSE
      *Old: &lcFactObj  = lcOldVal
      *LOFACTOBJ.VALUE = LOFACTOBJ.OLDVALUE
      *B609775,1 MMT 12/15/2011 Error while browsing factors in Payable invoice screen[Start]
      *loFactObj.Value = loFactObj.OldValue
      *B609775,1 MMT 12/15/2011 Error while browsing factors in Payable invoice screen[END]
      LLFACTFOUND = .F.
    ENDIF
    *Old: SHOW GET (lcFactObj) &&Revise
  ELSE
    LLFACTFOUND = .T.
  ENDIF

  IF USED('SYCFACT')
    IF LLOPENFACT
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      * USE IN SYCFACT
      =GFCLOSETABLE('SYCFACT')
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    ELSE

      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *SET ORDER TO lnSavFacTg IN SYCFACT
      SELECT SYCFACT
      =GFSETORDER(LNSAVFACTG)
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    ENDIF
  ENDIF

  SELECT IIF(!EMPTY(LCCURALIAS), (LCCURALIAS), 0)
ENDIF

RETURN LLFACTFOUND

*--end of lfGetFac

*!*************************************************************
*! Name      : lfGetAdr
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 7/29/2004
*! Purpose   : Global Function used by the validation function of the Factor Control.
*!*************************************************************
*! Parameters: lcAlias, lcTag, lcKeyCode, lcAdrCode
*!*************************************************************
*! Returns   : The Address
*!*************************************************************
FUNCTION LFGETADR
PARAMETERS LCALIAS, LCTAG, LCKEYCODE, LCADRCODE
*** lcAlias   : source file name
*** lcTag     : source file tag that is to be used in seeking
*** lckeycode : search key code (of the source file) (optional)
*** lcAdrCode : address code (optional)

PRIVATE LNSAVINTTG, LNSAVCMPTG, LCCURALIAS, LNOLDTAG,;
  LLOPENINT, LLOPENCMP, LLCONTINUE, LAADDRESS

DECLARE LAADDRESS[3,2]
LAADDRESS = " "

LCTAG = IIF(TYPE('lcTag') = 'C' .AND. !EMPTY(LCTAG),LCTAG,;
  IIF(TYPE('lcAlias') = 'C' .AND. ALIAS() = LCALIAS,;
  SYS(22),""))
IF TYPE('lcAlias') = 'C' .AND. !EMPTY(LCALIAS) .AND.;
    !EMPTY(LCTAG)

  LLCONTINUE = .T.
  LCCURALIAS = ALIAS()

  SELECT (LCALIAS)
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	  lnOldTag = VAL(SYS(21))
  *!*	  SET ORDER TO TAG (lcTag)
  LNOLDTAG = ORDER()
  =GFSETORDER(LCTAG)
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

  LCADRCODE = IIF(TYPE('lcAdrCode') = 'C'.AND. !EMPTY(LCADRCODE), LCADRCODE,;
    &LCALIAS..CCONT_CODE)
  IF (TYPE('lcKeyCode') = 'C' .AND. !SEEK(LCKEYCODE,LCALIAS)) ;
      .OR. LCADRCODE <> &LCALIAS..CCONT_CODE
    LLCONTINUE = .F.
  ENDIF

  IF LLCONTINUE
    STORE .F. TO LLOPENINT, LLOPENCMP
    *** Check being on a correct alias

    IF !USED('SYCINT')  && Check if the internationals file is open or not.
      LLOPENINT  = .T.     && Indicates that the file is open by the function.
      ** Use the file and assign the index.
      *USE &oAriaApplication.SysPath.SYCINT ORDER TAG cContCode IN 0   &&lower
      =OARIAAPPLICATION.REMOTESYSTEMDATA.EXECUTE("SELECT * FROM SYCINT","", ;
        "SYCINT","",OARIAAPPLICATION.SYSTEMCONNECTIONSTRING,3 ,"",SET("Datasession"))
      SELECT SYCINT
      =CURSORSETPROP("Buffering",3,'SYCINT')
      INDEX ON CCONT_CODE TAG CCONTCODE
    ELSE
      SELECT SYCINT
      LNSAVINTTG = VAL(SYS(21))
      IF TAGNO('cContCode')<>0
        SET ORDER TO TAG CCONTCODE   && Change the order
      ELSE
        =CURSORSETPROP("Buffering",3,'SYCINT')
        INDEX ON CCONT_CODE TAG CCONTCODE
      ENDIF
    ENDIF

    IF !USED('SYCCOMP')  && Check if the internationals file is open or not.
      LLOPENCMP  = .T.     && Indicates that the file is open by the function.
      ** Use the file and assign the index.
      *USE &oAriaApplication.SysPath.SYCCOMP ORDER TAG cComp_ID IN 0   &&lower
      =OARIAAPPLICATION.REMOTESYSTEMDATA.EXECUTE("SELECT * FROM SYCCOMP","", ;
        "SYCCOMP","",OARIAAPPLICATION.SYSTEMCONNECTIONSTRING,3 ,"",SET("Datasession"))
      SELECT SYCCOMP
      =CURSORSETPROP("Buffering",3,'SYCCOMP')
      INDEX ON CCOMP_ID TAG CCOMP_ID
    ELSE
      SELECT SYCCOMP
      LNSAVCMPTG = VAL(SYS(21))
      IF TAGNO('cComp_ID')<>0
        SET ORDER TO TAG CCOMP_ID   && Change the order
      ELSE
        =CURSORSETPROP("Buffering",3,'SYCCOMP')
        INDEX ON CCOMP_ID TAG CCOMP_ID
      ENDIF
    ENDIF

    IF SEEK(&LCALIAS..CCONT_CODE,'SYCINT');
        .OR. (SEEK(OARIAAPPLICATION.ACTIVECOMPANYID,'SYCCOMP') ;
        .AND. SEEK(SYCCOMP.CCONT_CODE,'SYCINT'))
      LAADDRESS[1,1] = SYCINT.NPART3ORD
      LAADDRESS[1,2] = &LCALIAS..CADDRESS3
      LAADDRESS[2,1] = SYCINT.NPART4ORD
      LAADDRESS[2,2] = &LCALIAS..CADDRESS4
      LAADDRESS[3,1] = SYCINT.NPART5ORD
      LAADDRESS[3,2] = &LCALIAS..CADDRESS5
      =ASORT(LAADDRESS,1)
    ELSE
      LAADDRESS[1,2] = &LCALIAS..CADDRESS3
      LAADDRESS[2,2] = &LCALIAS..CADDRESS4
      LAADDRESS[3,2] = &LCALIAS..CADDRESS5
    ENDIF

    IF USED('SYCCOMP')
      IF LLOPENCMP
        USE IN SYCCOMP
      ELSE
        SET ORDER TO LNSAVCMPTG IN SYCCOMP
      ENDIF
    ENDIF

    IF USED('SYCINT')
      IF LLOPENINT
        USE IN SYCINT
      ELSE
        SET ORDER TO LNSAVINTTG IN SYCCOMP
      ENDIF
    ENDIF
  ENDIF
  SET ORDER TO LNOLDTAG IN (LCALIAS)
  SELECT IIF(!EMPTY(LCCURALIAS),(LCCURALIAS),0)
ENDIF

*RETURN PADR(RTRIM(laAddress[1,2]) + RTRIM(laAddress[2,2]) +;
RTRIM(laAddress[3,2]),40)

RETURN ALLTRIM(LAADDRESS[1,2]) +" "+ ALLTRIM(LAADDRESS[2,2]) + " " + ALLTRIM(LAADDRESS[3,2])

*--end of lfGetAdr


*!*************************************************************
*! Name      : gfGetBrF
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 7/29/2004
*! Purpose   : Global Function to Get browse field string,
*!             used by the validation function of the Factor Control.
*!*************************************************************
*! Parameters: lcFileTitl, lcBrowFlds, lcSrchFile, lcFields
*!*************************************************************
*! Returns   : llMayProceed
*!*************************************************************
FUNCTION GFGETBRF
PARAMETERS LCFILETITL, LCBROWFLDS, LCSRCHFILE, LCFIELDS

PRIVATE LCCURALIAS, LNSAVFLSTG, LNSAVFLDTG, LNFIELDNUM,;
  LLSYDFILES, LLSYDFIELD, LLMAYPROCEED, LAFIELDS&&Old Afields

*** Check parameters
*llMayProceed = TYPE('lcFileTitl'= C) .AND. ;
*              TYPE('lcBrowFlds'= C)
LLMAYPROCEED = .T.

IF LLMAYPROCEED

  STORE " " TO LCFILETITL, LCBROWFLDS

  *** If a file name is not included as a parameter,
  *** use the current work area alias ( if there is any)
  LCCURALIAS = ALIAS()

  LCSRCHFILE   = IIF(TYPE('lcSrchFile') <> 'C' .OR.;
    EMPTY(LCSRCHFILE), LCCURALIAS, LCSRCHFILE)

  IF !EMPTY(LCSRCHFILE)

    IF !USED('SYDFILES')  && Check if the internationals file is open or not.
      LLSYDFILES   = .T.     && Indicates that the file is open by the function.
      *** Use the file and assign the index.
      *USE &oAriaApplication.SysPath.SYDFILES ORDER TAG cFile_Nam IN 0   &&lower
      =OARIAAPPLICATION.REMOTESYSTEMDATA.EXECUTE("SELECT * FROM SYDFILES","", ;
        "SYDFILES","",OARIAAPPLICATION.SYSTEMCONNECTIONSTRING,3 ,"",SET("Datasession"))
      SELECT SYDFILES
      =CURSORSETPROP("Buffering",3,'SYDFILES')
      INDEX ON CFILE_NAM TAG CFILE_NAM

    ELSE
      LLSYDFILES   = .F.
      SELECT SYDFILES
      LNSAVFLSTG = VAL(SYS(21))
      IF TAGNO('cFile_Nam')<>0
        SET ORDER TO TAG CFILE_NAM   && Change the order
      ELSE
        =CURSORSETPROP("Buffering",3,'SYDFILES')
        INDEX ON CFILE_NAM TAG CFILE_NAM
      ENDIF
    ENDIF
	*! B610199,1 HIA 01/16/2013 Aria4xp-SM - Release to GL screen freezes once release is complete [T20121213.0012][Start]
    *IF !USED('SYDFIELD')  && Check if the internationals file is open or not.
    IF !USED('AYDFIELD')  && Check if the internationals file is open or not.
	*! B610199,1 HIA 01/16/2013 Aria4xp-SM - Release to GL screen freezes once release is complete [T20121213.0012][END]
      LLSYDFIELD  = .T.     && Indicates that the file is open by the function.
      *** Use the file and assign the index.
      *USE &oAriaApplication.SysPath.SYDFIELD ORDER TAG cFld_Name IN 0   &&lower
	  *! B610199,1 HIA 01/16/2013 Aria4xp-SM - Release to GL screen freezes once release is complete [T20121213.0012][Start]
      *=OARIAAPPLICATION.REMOTESYSTEMDATA.EXECUTE("SELECT * FROM SYDFIELD","", ;
        "SYDFIELD","",OARIAAPPLICATION.SYSTEMCONNECTIONSTRING,3 ,"",SET("Datasession"))
      *SELECT SYDFIELD
      *=CURSORSETPROP("Buffering",3,'SYDFIELD')
      =OARIAAPPLICATION.REMOTESYSTEMDATA.EXECUTE("SELECT * FROM SYDFIELD","", ;
        "AYDFIELD","",OARIAAPPLICATION.SYSTEMCONNECTIONSTRING,3 ,"",SET("Datasession"))
      SELECT AYDFIELD
      =CURSORSETPROP("Buffering",3,'AYDFIELD')
	  *! B610199,1 HIA 01/16/2013 Aria4xp-SM - Release to GL screen freezes once release is complete [T20121213.0012][End]
      INDEX ON CFLD_NAME TAG CFLD_NAME

    ELSE
      LLSYDFIELD       = .F.
	  *! B610199,1 HIA 01/16/2013 Aria4xp-SM - Release to GL screen freezes once release is complete [T20121213.0012][Start]
      *SELECT SYDFIELD
	  SELECT AYDFIELD
	  *! B610199,1 HIA 01/16/2013 Aria4xp-SM - Release to GL screen freezes once release is complete [T20121213.0012][END]
      LNSAVFLDTG = VAL(SYS(21))
      IF TAGNO('cFld_Name')<>0
        SET ORDER TO TAG CFLD_NAME    && Change the order
      ELSE
	    *! B610199,1 HIA 01/16/2013 Aria4xp-SM - Release to GL screen freezes once release is complete [T20121213.0012][Start]
        *=CURSORSETPROP("Buffering",3,'SYDFIELD')
		=CURSORSETPROP("Buffering",3,'AYDFIELD')
		*! B610199,1 HIA 01/16/2013 Aria4xp-SM - Release to GL screen freezes once release is complete [T20121213.0012][END]
        INDEX ON CFLD_NAME TAG CFLD_NAME
      ENDIF
    ENDIF

    DECLARE LAFIELDS[1,1]
    LAFIELDS   = " "

    LCFILETITL = ALLTRIM(LOOKUP(SYDFILES.CFILE_TTL, UPPER(ALLTRIM(LCSRCHFILE)),;
      SYDFILES.CFILE_NAM, 'cFile_Nam'))
    LCFIELDS   = IIF(TYPE('lcFields') <> 'C' .OR. EMPTY(LCFIELDS),;
      STRTRAN(SYDFILES.MBROW_FLD, '|', ','), LCFIELDS)

    =GFSUBSTR(LCFIELDS, @LAFIELDS, ",")
    FOR LNFIELDNUM = 1 TO ALEN(LAFIELDS,1)
	  *! B610199,1 HIA 01/16/2013 Aria4xp-SM - Release to GL screen freezes once release is complete [T20121213.0012][Start]
      *LCBROWFLDS = LCBROWFLDS + LAFIELDS[lnFieldNum]+;
        [:H=']+ALLTRIM(LOOKUP(SYDFIELD.CFLD_HEAD,;
        UPPER(ALLTRIM(LAFIELDS[lnFieldNum])),;&&Old Afields
      SYDFIELD.CFLD_NAME,;
        'cFld_Name'))+[',]
      LCBROWFLDS = LCBROWFLDS + LAFIELDS[lnFieldNum]+;
        [:H=']+ALLTRIM(LOOKUP(AYDFIELD.CFLD_HEAD,;
        UPPER(ALLTRIM(LAFIELDS[lnFieldNum])),;&&Old Afields
      AYDFIELD.CFLD_NAME,;
        'cFld_Name'))+[',]
      *! B610199,1 HIA 01/16/2013 Aria4xp-SM - Release to GL screen freezes once release is complete [T20121213.0012][END]
    ENDFOR
    LCBROWFLDS  = SUBSTR(LCBROWFLDS, 1, LEN(LCBROWFLDS)-1)

    IF USED('SYDFILES')
      IF LLSYDFILES
        USE IN SYDFILES
      ELSE
        SET ORDER TO LNSAVFLSTG IN SYDFILES
      ENDIF
    ENDIF
	*! B610199,1 HIA 01/16/2013 Aria4xp-SM - Release to GL screen freezes once release is complete [T20121213.0012][Start]
    *IF USED('SYDFIELD')
    *  IF LLSYDFIELD
    *    USE IN SYDFIELD
    *  ELSE
    *    SET ORDER TO LNSAVFLDTG IN SYDFIELD
    *  ENDIF
    *ENDIF
    IF USED('AYDFIELD')
      IF LLSYDFIELD
        USE IN AYDFIELD
      ELSE
        SET ORDER TO LNSAVFLDTG IN AYDFIELD
      ENDIF
    ENDIF
	*! B610199,1 HIA 01/16/2013 Aria4xp-SM - Release to GL screen freezes once release is complete [T20121213.0012][END]
    SELECT IIF(!EMPTY(LCCURALIAS),(LCCURALIAS),0)
  ELSE
    LLMAYPROCEED = .F.
  ENDIF
ENDIF

RETURN LLMAYPROCEED

*--end of gfGetBrF

***xxx***



***zzz***

*!*************************************************************
*! Name      : lfvAprovPay
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 8/3/2004
*! Purpose   : Function called from Click Event of The Approve For Payment Button.
*!*************************************************************
*! Parameters: The FormSet
*!*************************************************************
*! Returns   : None
*!*************************************************************
FUNCTION LFVAPROVPAY

*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*LPARAMETERS loFormSet
PARAMETERS LOFORMSET
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
LOCAL LCTEMP, LCEXSIN4


IF APVENDOR.CVENPRIOR = '0'
  LCVENDORR=ALLTRIM(APVENDOR.CVENDCODE)
  ** MESSAGE : " Vendor XXXXXX has payment priority 0."
  **           " This vendor in on hold.              "
  =GFMODALGEN("TRM04060B00000","DIALOG",LCVENDORR)
  IF LOFORMSET.LNTOTAPPPAY = 0
    RETURN
  ENDIF
ENDIF
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*!*	llopchk = gfOpenFile(oAriaApplication.DataDir+'APCHECKS','BANKCHECK','SH')
*!*	llopBNK = gfOpenFile(oAriaApplication.DataDir+'APBANKS','BANKCODE','SH')
LLOPCHK = GFOPENTABLE('APCHECKS','BANKCHECK','SH')
LLOPBNK = GFOPENTABLE('APBANKS','BANKCODE','SH')
SELECT APCHECKS
=GFSEEK('')
SELECT APBANKS
=GFSEEK('')
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

** If bank code in the vendor file is not empty.

*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*!*	IF loFormSet.AriaForm1.cboVendPmeth.Value <> 'C'
IF LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.CBOVENDPMETH.VALUE <> 'C'
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[END]
  LOFORMSET.LCBANKCODE = APINVHDR.CBNKCODE
  LOFORMSET.LCCHECKACC = APINVHDR.CCHKACCT
  LOFORMSET.LCGLACOUNT = APINVHDR.CCHKGLACC
  LOFORMSET.LCAPPRPAY  = APINVHDR.NINVAMTAP

  LOFORMSET.LNFAAP = APINVHDR.NINVFAAP

  LOFORMSET.LCAPPRDIS  = APINVHDR.NINVDISAP
  LOFORMSET.LC1099AMNT = APINVHDR.NINVA1099
  LOFORMSET.LCAPPRADJ  = APINVHDR.NINVADJAP
  *! E302623,3 MMT 01/03/2010 Convert Payable invoice screen to use SQL tables[Start]
  *lcAprCurr  = apinvhdr.caprcurcod
  LOFORMSET.LCAPRCURR  = APINVHDR.CAPRCURCOD
  *! E302623,3 MMT 01/03/2010 Convert Payable invoice screen to use SQL tables[End]
  LOFORMSET.LNAPRRATE  = APINVHDR.NAPREXRAT
  LOFORMSET.LNAPRUNIT  = APINVHDR.NAPRCURUNT

ENDIF
IF !LOFORMSET.ACTIVEMODE="V"
  DO CASE
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    * CASE loFormSet.AriaForm1.cboVendPmeth.Value $ 'PMN'
  CASE LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.CBOVENDPMETH.VALUE $ 'PMN'
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[END]
    IF EMPTY(APINVHDR.NINVAMTAP)
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *!*	        REPLACE apinvhdr.ninvamtap WITH loFormSet.AriaForm1.txtInvAmount.Value - apinvhdr.ninvpaid - ;
      *!*	                                        apinvhdr.ninvadj - apinvhdr.ninvdistk - ;
      *!*	                                        IIF(apinvhdr.ninvdistk < loFormSet.AriaForm1.txtInvDisof.Value,;
      *!*	                                        loFormSet.AriaForm1.txtInvDisof.Value - apinvhdr.ninvdistk,0)
      REPLACE APINVHDR.NINVAMTAP WITH LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTINVAMOUNT.VALUE - APINVHDR.NINVPAID - ;
        APINVHDR.NINVADJ - APINVHDR.NINVDISTK - ;
        IIF(APINVHDR.NINVDISTK < LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTINVDISOF.VALUE,;
        LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTINVDISOF.VALUE - APINVHDR.NINVDISTK,0)
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      IF EMPTY(APINVHDR.NINVDISAP)
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        *!*	          REPLACE apinvhdr.ninvdisap WITH IIF(apinvhdr.ninvdistk < loFormSet.AriaForm1.txtInvDisof.Value,;
        *!*	                                              loFormSet.AriaForm1.txtInvDisof.Value - apinvhdr.ninvdistk,0)
        REPLACE APINVHDR.NINVDISAP WITH IIF(APINVHDR.NINVDISTK < LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTINVDISOF.VALUE,;
          LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTINVDISOF.VALUE - APINVHDR.NINVDISTK,0)
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      ENDIF
    ENDIF

    IF EMPTY(APINVHDR.CBNKCODE)
      LLBNKCHKCHNG = .F.
      IF !EMPTY(APVENDOR.CBNKCODE)
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        *!*	          REPLACE apinvhdr.cbnkcode WITH APVENDOR.CBNKCODE && Assign the bank code from vendor.
        *!*	          REPLACE apinvhdr.cchkacct WITH APVENDOR.CCHKACCT && Assign the check code from vendor.
        SELECT APINVHDR
        GFREPLACE("cbnkcode WITH APVENDOR.CBNKCODE") && Assign the bank code from vendor.
        GFREPLACE("cchkacct WITH APVENDOR.CCHKACCT") && Assign the check code from vendor.
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
        LLBNKCHKCHNG = .T.
      ELSE
        IF !EMPTY(APDIV.CBNKCODE)
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
          *!*	            REPLACE apinvhdr.cbnkcode WITH APDIV.CBNKCODE  && Assign the bank code from division.
          *!*	            REPLACE apinvhdr.cchkacct WITH APDIV.CCHKACCT  && Assign the bank code from division.
          SELECT APINVHDR
          GFREPLACE("cbnkcode WITH APDIV.CBNKCODE")  && Assign the bank code from division.
          GFREPLACE("cchkacct WITH APDIV.CCHKACCT")  && Assign the bank code from division.
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[END]
          LLBNKCHKCHNG = .T.
        ELSE
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
          *!*	            REPLACE apinvhdr.cbnkcode WITH APSETUP.CBNKCODE  && Assign the bank code from division.
          *!*	            REPLACE apinvhdr.cchkacct WITH APSETUP.CCHKACCT  && Assign the bank code from division.
          SELECT APINVHDR
          GFREPLACE("cbnkcode WITH APSETUP.CBNKCODE")  && Assign the bank code from division.
          GFREPLACE("cchkacct WITH APSETUP.CCHKACCT")  && Assign the bank code from division.
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
          LLBNKCHKCHNG = .T.
        ENDIF
      ENDIF

      IF LLBNKCHKCHNG
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        *!*	          IF SEEK(apinvhdr.cbnkcode+apinvhdr.cchkacct,'APCHECKS')
        *!*	            REPLACE apinvhdr.cchkglacc WITH IIF(!EMPTY(APCHECKS.CCHKGLACC),;
        *!*	                                                APCHECKS.CCHKGLACC,loFormSet.AriaForm1.ap1.lcemptyacc)
        IF GFSEEK(APINVHDR.CBNKCODE+APINVHDR.CCHKACCT,'APCHECKS')
          SELECT APINVHDR
          GFREPLACE("cchkglacc WITH '"+IIF(!EMPTY(APCHECKS.CCHKGLACC),;
            APCHECKS.CCHKGLACC,LOFORMSET.ARIAFORM1.AP1.LCEMPTYACC)+"'")
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
        ENDIF
      ENDIF

      IF GFGETMEMVAR('LLMULCURR') .AND. !EMPTY(APINVHDR.CCHKACCT)
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        *!*	          IF SEEK(apinvhdr.cbnkcode+apinvhdr.cchkacct,'APCHECKS')
        *!*	            REPLACE apinvhdr.caprcurcod WITH IIF(EMPTY(APCHECKS.CCURRCODE),;
        *!*	                                                 loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value,;
        *!*	                                                 APCHECKS.CCURRCODE)
        IF GFSEEK(APINVHDR.CBNKCODE+APINVHDR.CCHKACCT,'APCHECKS')
          SELECT APINVHDR
          GFREPLACE("caprcurcod WITH '"+IIF(EMPTY(APCHECKS.CCURRCODE),;
            LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.KEYTEXTBOX.VALUE,;
            APCHECKS.CCURRCODE)+"'")
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
        ELSE
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
          *REPLACE apinvhdr.caprcurcod WITH loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value
          GFREPLACE("caprcurcod WITH '"+LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.KEYTEXTBOX.VALUE+"'")
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
        ENDIF
      ELSE
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        *REPLACE apinvhdr.caprcurcod WITH loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value
        SELECT APINVHDR
        GFREPLACE("caprcurcod WITH '"+LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.KEYTEXTBOX.VALUE+"'")
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[end]
      ENDIF


      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *IF apinvhdr.caprcurcod = loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value
      *!*	          REPLACE apinvhdr.naprexrat WITH 1
      *!*	          REPLACE apinvhdr.naprcurunt WITH 1
      IF APINVHDR.CAPRCURCOD = LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.KEYTEXTBOX.VALUE
        SELECT APINVHDR
        GFREPLACE("naprexrat WITH 1")
        GFREPLACE("naprcurunt WITH 1")
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      ELSE
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        *IF loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value = oAriaApplication.BaseCurrency
        IF LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.KEYTEXTBOX.VALUE = OARIAAPPLICATION.BASECURRENCY
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
          PRIVATE APRCURUNT
          APRCURUNT = APINVHDR.NAPRCURUNT
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
          *!*	            REPLACE apinvhdr.naprexrat WITH gfChkRate('aprcurunt',;
          *!*	                                                      apinvhdr.caprcurcod,;
          *!*	                                                      loFormSet.AriaForm1.DtInvDate.Value,.F.,.F.,;
          *!*	                                                      loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value)
          *!*	            REPLACE apinvhdr.naprcurunt WITH aprcurunt
          LDDATEINV = LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.DTINVDATE.VALUE
          LCCURCODE = LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.KEYTEXTBOX.VALUE
          SELECT APINVHDR
          GFREPLACE("naprexrat WITH gfChkRate('aprcurunt',apinvhdr.caprcurcod,ldDateInv ,.F.,.F.,lcCurCode)")

          GFREPLACE("naprcurunt WITH aprcurunt")
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
        ELSE
          PRIVATE APRCURUNT
          APRCURUNT = APINVHDR.NAPRCURUNT
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
          *!*	            REPLACE apinvhdr.naprexrat WITH gfChkRate('aprcurunt',;
          *!*	                                                      loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value,;
          *!*	                                                      loFormSet.AriaForm1.DtInvDate.Value,.F.,.F.,;
          *!*	                                                      apinvhdr.caprcurcod)
          *!*	            REPLACE apinvhdr.naprcurunt WITH aprcurunt
          LDDATEINV = LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.DTINVDATE.VALUE
          LCCURCODE = LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.KEYTEXTBOX.VALUE
          SELECT APINVHDR
          GFREPLACE("naprexrat WITH gfChkRate('aprcurunt',"+;
            "lcCurCode ,"+;
            "ldDateInv ,.F.,.F.,"+;
            "apinvhdr.caprcurcod)")
          GFREPLACE("naprcurunt WITH aprcurunt")
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
        ENDIF

      ENDIF
    ENDIF

    LOFORMSET.LCEXSIN4 = ' '

    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *IF loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value = oAriaApplication.BaseCurrency
    IF LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.KEYTEXTBOX.VALUE = OARIAAPPLICATION.BASECURRENCY
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      LCEXSIN4 = LOFORMSET.LCEXSIN4
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *!*	        loFormSet.lcExSin3 = gfGetExSin(@lcExSin4,apinvhdr.caprcurcod,;
      *!*	                                        loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value)
      LOFORMSET.LCEXSIN3 = GFGETEXSIN(@LCEXSIN4,APINVHDR.CAPRCURCOD,;
        LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.KEYTEXTBOX.VALUE)
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

      LOFORMSET.LCEXSIN4 = LCEXSIN4
      LOFORMSET.LCEXSIN3 = IIF(LOFORMSET.LCEXSIN3 = '*' , '/' , '*')
      LOFORMSET.LCEXSIN4 = IIF(LOFORMSET.LCEXSIN4 = '*' , '/' , '*')
    ELSE
      LCEXSIN4 = LOFORMSET.LCEXSIN4
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *!*	        loFormSet.lcExSin3 = gfGetExSin(@lcExSin4,;
      *!*	                                        loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value,;
      *!*	                                        apinvhdr.caprcurcod)
      LOFORMSET.LCEXSIN3 = GFGETEXSIN(@LCEXSIN4,;
        LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.KEYTEXTBOX.VALUE,;
        APINVHDR.CAPRCURCOD)
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

      LOFORMSET.LCEXSIN4 = LCEXSIN4
    ENDIF


    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *        IF loFormSet.ActiveMode="A" .AND. loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value = apinvhdr.caprcurcod
    *!*	        REPLACE apinvhdr.naprexrat WITH 1
    *!*	        REPLACE apinvhdr.naprcurunt WITH 1
    IF LOFORMSET.ACTIVEMODE="A" .AND. LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.KEYTEXTBOX.VALUE = APINVHDR.CAPRCURCOD
      SELECT APINVHDR
      GFREPLACE("naprexrat WITH 1")
      GFREPLACE("naprcurunt WITH 1")
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    ENDIF

    LCTEMP = 'apinvhdr.ninvamtap'+LOFORMSET.LCEXSIN3+'apinvhdr.naprexrat'+;
      LOFORMSET.LCEXSIN4+'apinvhdr.naprcurunt'
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *REPLACE apinvhdr.ninvfaap WITH ROUND(&lcTemp,2)
    SELECT APINVHDR
    *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][Start]
    TRY
      *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][End]
      GFREPLACE("ninvfaap WITH ROUND(&lcTemp,2)")
      *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][Start]
    CATCH
      GFREPLACE("ninvfaap WITH 0")
    ENDTRY
    *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][End]
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

    *Old: ON KEY LABEL ESC DO lfvCanPay
    LOFORMSET.LCOLDGLACC = APINVHDR.CCHKGLACC

    IF GFGETMEMVAR('LLMULCURR')
      * DO APAPROVC.SPR  && Approved screen if multi currency = .T.
      *Old: DO (oAriaApplication.ScreenHome + oAriaApplication.ActiveModuleID + '\APAPROVC.SPR')

      *! E303029,1 MMT 12/26/2011 correct the calling of non-major programs within the SaaS environemnt[STart]
      *DO FORM (OARIAAPPLICATION.SCREENHOME+"AP\APAPROV.SCX") WITH LOFORMSET.ARIAFORM1
      *DO FORM (oAriaApplication.ScreenHome+"AP\APAPROV.SCX") WITH loFormSet.AriaForm1
      LOPARAMLIST = LOFORMSET
      =GFCALLFORM('APAPROV','AP',"loParamList.AriaForm1")
      *! E303029,1 MMT 12/26/2011 correct the calling of non-major programs within the SaaS environemnt[END]

    ELSE
      * DO APAPROV.SPR  && Approved screen if multi currency = .F.
      *Old: DO (oAriaApplication.ScreenHome + oAriaApplication.ActiveModuleID + '\APAPROV.SPR')
      *! E303029,1 MMT 12/26/2011 correct the calling of non-major programs within the SaaS environemnt[STart]
      *DO FORM (OARIAAPPLICATION.SCREENHOME+"AP\APAPROV.SCX") WITH LOFORMSET.ARIAFORM1
      *DO FORM (oAriaApplication.ScreenHome+"AP\APAPROV.SCX") WITH loFormSet.AriaForm1
      LOPARAMLIST = LOFORMSET
      =GFCALLFORM('APAPROV','AP',"loParamList.AriaForm1")
      *! E303029,1 MMT 12/26/2011 correct the calling of non-major programs within the SaaS environemnt[END]

      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *REPLACE apinvhdr.ninvfaap WITH apinvhdr.ninvamtap
      *! E302623,2 MMT 10/11/2009 Convert Payable invoice screen to use SQL tables[Start]
      SELECT APINVHDR
      *! E302623,2 MMT 10/11/2009 Convert Payable invoice screen to use SQL tables[End]
      GFREPLACE("ninvfaap WITH apinvhdr.ninvamtap")
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

    ENDIF
    *Old: ON KEY LABEL ESC DO lfEscap

    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *!*	    CASE loFormSet.AriaForm1.cboVendPmeth.Value = 'H'
  CASE LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.CBOVENDPMETH.VALUE = 'H'
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    IF EMPTY(APINVHDR.NINVAMTAP)
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *!*	        REPLACE apinvhdr.ninvamtap WITH loFormSet.AriaForm1.txtInvAmount.Value - apinvhdr.ninvpaid - ;
      *!*	                                        apinvhdr.ninvadj - apinvhdr.ninvdistk - ;
      *!*	                                        IIF(apinvhdr.ninvdistk < loFormSet.AriaForm1.txtInvDisof.Value,;
      *!*	                                        loFormSet.AriaForm1.txtInvDisof.Value - apinvhdr.ninvdistk,0)
      SELECT APINVHDR
      GFREPLACE("ninvamtap WITH loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.Value - apinvhdr.ninvpaid -"+ ;
        "apinvhdr.ninvadj - apinvhdr.ninvdistk - "+;
        "IIF(apinvhdr.ninvdistk < loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvDisof.Value,"+;
        "loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvDisof.Value - apinvhdr.ninvdistk,0)")

      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      IF EMPTY(APINVHDR.NINVDISAP)
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        *!*	          REPLACE apinvhdr.ninvdisap WITH IIF(apinvhdr.ninvdistk < loFormSet.AriaForm1.txtInvDisof.Value,;
        *!*	                                              loFormSet.AriaForm1.txtInvDisof.Value - ;
        *!*	                                              apinvhdr.ninvdistk,0)
        SELECT APINVHDR
        GFREPLACE("ninvdisap WITH IIF(apinvhdr.ninvdistk < loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvDisof.Value,"+;
          "loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvDisof.Value - "+;
          "apinvhdr.ninvdistk,0)")

        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      ENDIF
    ENDIF
    IF EMPTY(STRTRAN(STRTRAN(APINVHDR.CCHKGLACC,'-'),'0'))
      DO CASE
      CASE !EMPTY(APVENDOR.CCASHACCT)
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        *REPLACE apinvhdr.cchkglacc WITH APVENDOR.CCASHACCT
        *CASE !EMPTY(loFormSet.AriaForm1.cboDivision.Value) .AND. !EMPTY(APDIV.CCASHACCT)
        *REPLACE apinvhdr.cchkglacc WITH APDIV.CCASHACCT
        SELECT APINVHDR
        GFREPLACE("cchkglacc WITH APVENDOR.CCASHACCT")
      CASE !EMPTY(LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.CBODIVISION.VALUE) .AND. !EMPTY(APDIV.CCASHACCT)
        SELECT APINVHDR
        GFREPLACE("cchkglacc WITH APDIV.CCASHACCT")
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      OTHERWISE
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        *REPLACE apinvhdr.cchkglacc WITH APDIV.CCASHACCT
        SELECT APINVHDR
        GFREPLACE("cchkglacc WITH APSETUP.CCASHACCT")
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      ENDCASE
    ENDIF

    IF EMPTY(APINVHDR.CAPRCURCOD)
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *REPLACE apinvhdr.caprcurcod WITH loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value
      SELECT APINVHDR
      GFREPLACE("caprcurcod WITH loFormSet.AriaForm1.pgfpayInv.pgHead.kbCurrCode.KeyTextBox.Value")
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    ENDIF


    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *      IF loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value = apinvhdr.caprcurcod
    *!*	        REPLACE apinvhdr.naprexrat WITH 1
    *!*	        REPLACE apinvhdr.naprcurunt WITH 1
    IF LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.KEYTEXTBOX.VALUE = APINVHDR.CAPRCURCOD
      SELECT APINVHDR
      GFREPLACE("naprexrat WITH 1")
      GFREPLACE("naprcurunt WITH 1")
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    ENDIF

    LOFORMSET.LCEXSIN4 = ' '
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *IF loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value = oAriaApplication.BaseCurrency
    IF LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.KEYTEXTBOX.VALUE = OARIAAPPLICATION.BASECURRENCY
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      LCEXSIN4 = LOFORMSET.LCEXSIN4
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *loFormSet.lcExSin3 = gfGetExSin(@lcExSin4,apinvhdr.caprcurcod,loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value)
      LOFORMSET.LCEXSIN3 = GFGETEXSIN(@LCEXSIN4,APINVHDR.CAPRCURCOD,LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.KEYTEXTBOX.VALUE)
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      LOFORMSET.LCEXSIN4 = LCEXSIN4
      LOFORMSET.LCEXSIN3 = IIF(LOFORMSET.LCEXSIN3 = '*' , '/' , '*')
      LOFORMSET.LCEXSIN4 = IIF(LOFORMSET.LCEXSIN4 = '*' , '/' , '*')
      LOFORMSET.LCEXSIN4 = LCEXSIN4
    ELSE
      LCEXSIN4 = LOFORMSET.LCEXSIN4
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *loFormSet.lcExSin3 = gfGetExSin(@lcExSin4,loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value,apinvhdr.caprcurcod)    &&lower  &&lower
      LOFORMSET.LCEXSIN3 = GFGETEXSIN(@LCEXSIN4,LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.KEYTEXTBOX.VALUE,APINVHDR.CAPRCURCOD)    &&lower  &&lower
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      LOFORMSET.LCEXSIN4 = LCEXSIN4
    ENDIF

    LCTEMP = 'apinvhdr.ninvamtap'+LOFORMSET.LCEXSIN3+'apinvhdr.naprexrat'+;
      LOFORMSET.LCEXSIN4+'apinvhdr.naprcurunt'
    *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][Start]
    TRY
      *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][End]
      REPLACE APINVHDR.NINVFAAP WITH ROUND(&LCTEMP,2)
      *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][Start]
    CATCH
      REPLACE APINVHDR.NINVFAAP WITH 0
    ENDTRY
    *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][End]
    *Old: ON KEY LABEL ESC DO lfvCanPay
    LOFORMSET.LCOLDGLACC = APINVHDR.CCHKGLACC

    IF GFGETMEMVAR('LLMULCURR')
      * DO APCSHPYC.SPR  && Approved screen if multi currency = .T.
      *Old: DO (oAriaApplication.ScreenHome + oAriaApplication.ActiveModuleID + '\APCSHPYC.SPR')
      *! E303029,1 MMT 12/26/2011 correct the calling of non-major programs within the SaaS environemnt[STart]
      *DO FORM (OARIAAPPLICATION.SCREENHOME+"AP\APAPROV.SCX") WITH LOFORMSET.ARIAFORM1
      *DO FORM (oAriaApplication.ScreenHome+"AP\APAPROV.SCX") WITH loFormSet.AriaForm1
      LOPARAMLIST = LOFORMSET
      =GFCALLFORM('APAPROV','AP',"loParamList.AriaForm1")
      *! E303029,1 MMT 12/26/2011 correct the calling of non-major programs within the SaaS environemnt[END]


    ELSE
      * DO APCASHPY.SPR  && Approved screen if multi currency = .F.
      *Old: DO (oAriaApplication.ScreenHome + oAriaApplication.ActiveModuleID + '\APCASHPY.SPR')

      *! E303029,1 MMT 12/26/2011 correct the calling of non-major programs within the SaaS environemnt[STart]
      *DO FORM (OARIAAPPLICATION.SCREENHOME+"AP\APAPROV.SCX") WITH LOFORMSET.ARIAFORM1
      *DO FORM (oAriaApplication.ScreenHome+"AP\APAPROV.SCX") WITH loFormSet.AriaForm1
      LOPARAMLIST = LOFORMSET
      =GFCALLFORM('APAPROV','AP',"loParamList.AriaForm1")
      *! E303029,1 MMT 12/26/2011 correct the calling of non-major programs within the SaaS environemnt[END]

      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *REPLACE apinvhdr.ninvfaap WITH apinvhdr.ninvamtap
      GFREPLACE('ninvfaap WITH apinvhdr.ninvamtap')
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

    ENDIF
    *Old: ON KEY LABEL ESC DO lfEscap
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *!*	    CASE loFormSet.AriaForm1.cboVendPmeth.Value = 'C'
  CASE LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.CBOVENDPMETH.VALUE = 'C'
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    *Old: ON KEY LABEL ESC

    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *!*	      REPLACE apinvhdr.caprcurcod WITH loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value
    *!*	      REPLACE apinvhdr.naprexrat WITH loFormSet.AriaForm1.txtNexRate.Value
    *!*	      REPLACE apinvhdr.naprcurunt WITH apinvhdr.ncurrunit
    SELECT APINVHDR
    GFREPLACE("caprcurcod WITH loFormSet.AriaForm1.pgfpayInv.pgHead.kbCurrCode.KeyTextBox.Value")
    GFREPLACE("naprexrat WITH loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.Value")
    GFREPLACE("naprcurunt WITH apinvhdr.ncurrunit")
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    *E300683,1 Call *.SPR from screens directory
    * DO APINVCRD.SPR
    *Old: DO (oAriaApplication.ScreenHome + oAriaApplication.ActiveModuleID + '\APINVCRD.SPR')
    *! E303029,1 MMT 12/26/2011 correct the calling of non-major programs within the SaaS environemnt[STart]
    *DO FORM (OARIAAPPLICATION.SCREENHOME+"AP\APINVCRD.SCX") WITH LOFORMSET.ARIAFORM1
    *DO FORM (oAriaApplication.ScreenHome+"AP\APINVCRD.SCX") WITH loFormSet.AriaForm1
    LOPARAMLIST = LOFORMSET
    =GFCALLFORM('APINVCRD','AP',"loParamList.AriaForm1")
    *! E303029,1 MMT 12/26/2011 correct the calling of non-major programs within the SaaS environemnt[END]

    *E300683,1 end
    *Old: ON KEY LABEL ESC DO lfEscap
  ENDCASE
ELSE
  DO CASE
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *!*	    CASE loFormSet.AriaForm1.cboVendPmeth.Value = 'H'
  CASE LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.CBOVENDPMETH.VALUE = 'H'
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[END]
    *Old: ON KEY LABEL ESC DO lfvCanPay
    LOFORMSET.LCOLDGLACC = APINVHDR.CCHKGLACC  &&lower

    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *IF loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value = oAriaApplication.BaseCurrency
    IF LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.KEYTEXTBOX.VALUE = OARIAAPPLICATION.BASECURRENCY
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      LCEXSIN4 = LOFORMSET.LCEXSIN4
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *loFormSet.lcExSin3 = gfGetExSin(@lcExSin4,apinvhdr.caprcurcod,loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value)    &&lower  &&lower
      LOFORMSET.LCEXSIN3 = GFGETEXSIN(@LCEXSIN4,APINVHDR.CAPRCURCOD,LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.KEYTEXTBOX.VALUE)    &&lower  &&lower
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      LOFORMSET.LCEXSIN4 = LCEXSIN4
      LOFORMSET.LCEXSIN3 = IIF(LOFORMSET.LCEXSIN3 = '*' , '/' , '*')
      LOFORMSET.LCEXSIN4 = IIF(LOFORMSET.LCEXSIN4 = '*' , '/' , '*')
    ELSE
      LCEXSIN4 = LOFORMSET.LCEXSIN4
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *loFormSet.lcExSin3 = gfGetExSin(@lcExSin4,loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value,apinvhdr.caprcurcod)    &&lower  &&lower
      LOFORMSET.LCEXSIN3 = GFGETEXSIN(@LCEXSIN4,LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.KEYTEXTBOX.VALUE,APINVHDR.CAPRCURCOD)    &&lower  &&lower
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      LOFORMSET.LCEXSIN4 = LCEXSIN4
    ENDIF

    LCTEMP = 'apinvhdr.ninvamtap'+LOFORMSET.LCEXSIN3+'apinvhdr.naprexrat'+;
      LOFORMSET.LCEXSIN4+'apinvhdr.naprcurunt'
    APINVHDR.NINVFAAP = ROUND(&LCTEMP,2)


    IF GFGETMEMVAR('LLMULCURR')
      * DO APCSHPYC.SPR && Approved screen if multi currency = .T.
      *Old: DO (oAriaApplication.ScreenHome + oAriaApplication.ActiveModuleID + '\APCSHPYC.SPR')
      *! E303029,1 MMT 12/26/2011 correct the calling of non-major programs within the SaaS environemnt[STart]
      *DO FORM (oAriaApplication.ScreenHome+"AP\APAPROV.SCX") WITH loFormSet.AriaForm1
      LOPARAMLIST = LOFORMSET
      =GFCALLFORM('APAPROV','AP',"loParamList.AriaForm1")
      *! E303029,1 MMT 12/26/2011 correct the calling of non-major programs within the SaaS environemnt[END]

    ELSE
      * DO APCASHPY.SPR && Approved screen if multi currency = .F.
      *Old: DO (oAriaApplication.ScreenHome + oAriaApplication.ActiveModuleID + '\APCASHPY.SPR')
      *! E303029,1 MMT 12/26/2011 correct the calling of non-major programs within the SaaS environemnt[STart]
      *DO FORM (oAriaApplication.ScreenHome+"AP\APAPROV.SCX") WITH loFormSet.AriaForm1
      LOPARAMLIST = LOFORMSET
      =GFCALLFORM('APAPROV','AP',"loParamList.AriaForm1")
      *! E303029,1 MMT 12/26/2011 correct the calling of non-major programs within the SaaS environemnt[END]
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *        REPLACE apinvhdr.ninvfaap WITH apinvhdr.ninvamtap
      SELECT APINVHDR
      GFREPLACE("ninvfaap WITH apinvhdr.ninvamtap")
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    ENDIF
    *Old: ON KEY LABEL ESC DO lfEscap
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *!*	    CASE loFormSet.AriaForm1.cboVendPmeth.Value $ 'PMN'
  CASE LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.CBOVENDPMETH.VALUE $ 'PMN'
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    *Old: ON KEY LABEL ESC DO lfvCanPay
    LOFORMSET.LCOLDGLACC = APINVHDR.CCHKGLACC

    LOFORMSET.LCEXSIN4 = ' '
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *IF loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value = oAriaApplication.BaseCurrency
    IF LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.KEYTEXTBOX.VALUE = OARIAAPPLICATION.BASECURRENCY
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

      LCEXSIN4 = LOFORMSET.LCEXSIN4
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *loFormSet.lcExSin3 = gfGetExSin(@lcExSin4,apinvhdr.caprcurcod,loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value)    &&lower  &&lower
      LOFORMSET.LCEXSIN3 = GFGETEXSIN(@LCEXSIN4,APINVHDR.CAPRCURCOD,LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.KEYTEXTBOX.VALUE)    &&lower  &&lower
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      LOFORMSET.LCEXSIN4 = LCEXSIN4
      LOFORMSET.LCEXSIN3 = IIF(LOFORMSET.LCEXSIN3 = '*' , '/' , '*')
      LOFORMSET.LCEXSIN4 = IIF(LOFORMSET.LCEXSIN4 = '*' , '/' , '*')
    ELSE
      LCEXSIN4 = LOFORMSET.LCEXSIN4
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *loFormSet.lcExSin3 = gfGetExSin(@lcExSin4,loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value,apinvhdr.caprcurcod)    &&lower  &&lower
      LOFORMSET.LCEXSIN3 = GFGETEXSIN(@LCEXSIN4,LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.KEYTEXTBOX.VALUE,APINVHDR.CAPRCURCOD)    &&lower  &&lower
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      LOFORMSET.LCEXSIN4 = LCEXSIN4
    ENDIF

    LCTEMP = 'apinvhdr.ninvamtap'+LOFORMSET.LCEXSIN3+'apinvhdr.naprexrat'+;
      LOFORMSET.LCEXSIN4+'apinvhdr.naprcurunt'
    *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][Start]
    TRY
      *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][End]
      REPLACE APINVHDR.NINVFAAP WITH ROUND(&LCTEMP,2)
      *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][Start]
    CATCH
      REPLACE APINVHDR.NINVFAAP WITH 0
    ENDTRY
    *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][End]
    IF GFGETMEMVAR('LLMULCURR')
      * DO APAPROVC.SPR && Approved screen if multi currency = .T.
      *Old: DO (oAriaApplication.ScreenHome + oAriaApplication.ActiveModuleID + '\APAPROVC.SPR')
      *! E303029,1 MMT 12/26/2011 correct the calling of non-major programs within the SaaS environemnt[STart]
      *DO FORM (oAriaApplication.ScreenHome+"AP\APAPROV.SCX") WITH loFormSet.AriaForm1
      LOPARAMLIST = LOFORMSET
      =GFCALLFORM('APAPROV','AP',"loParamList.AriaForm1")
      *! E303029,1 MMT 12/26/2011 correct the calling of non-major programs within the SaaS environemnt[END]

    ELSE
      * DO APAPROV.SPR && Approved screen if multi currency = .F.
      *Old: DO (oAriaApplication.ScreenHome + oAriaApplication.ActiveModuleID + '\APAPROV.SPR')  &&lower  &&lower
      *! E303029,1 MMT 12/26/2011 correct the calling of non-major programs within the SaaS environemnt[STart]
      *DO FORM (oAriaApplication.ScreenHome+"AP\APAPROV.SCX") WITH loFormSet.AriaForm1
      LOPARAMLIST = LOFORMSET
      =GFCALLFORM('APAPROV','AP',"loParamList.AriaForm1")
      *! E303029,1 MMT 12/26/2011 correct the calling of non-major programs within the SaaS environemnt[END]
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *REPLACE apinvhdr.ninvfaap WITH apinvhdr.ninvamtap
      SELECT APINVHDR
      GFREPLACE("ninvfaap WITH apinvhdr.ninvamtap")
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

    ENDIF
    *Old: ON KEY LABEL ESC DO lfEscap
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *!*	    CASE loFormSet.AriaForm1.cboVendPmeth.Value = 'C'
  CASE LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.CBOVENDPMETH.VALUE = 'C'
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    *Old: ON KEY LABEL ESC
    * DO APINVCRD.SPR
    *Old: DO (oAriaApplication.ScreenHome + oAriaApplication.ActiveModuleID + '\APINVCRD.SPR')

    *! E303029,1 MMT 12/26/2011 correct the calling of non-major programs within the SaaS environemnt[STart]
    *DO FORM (OARIAAPPLICATION.SCREENHOME+"AP\APINVCRD.SCX") WITH LOFORMSET.ARIAFORM1
    *DO FORM (oAriaApplication.ScreenHome+"AP\APINVCRD.SCX") WITH loFormSet.AriaForm1
    LOPARAMLIST = LOFORMSET
    =GFCALLFORM('APINVCRD','AP',"loParamList.AriaForm1")
    *! E303029,1 MMT 12/26/2011 correct the calling of non-major programs within the SaaS environemnt[END]
    *Old: ON KEY LABEL ESC DO lfEscap
  ENDCASE
ENDIF

LOFORMSET.LNTOTAPPPAY = APINVHDR.NINVAMTAP + APINVHDR.NINVDISAP + APINVHDR.NINVADJAP
IF USED('APCHECKS') .AND. LLOPCHK
  *Odl: =gfCloseFile('APCHECKS')
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *USE IN APCHECKS
  =GFCLOSETABLE('APCHECKS')
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
ENDIF
IF USED('APBANKS') .AND. LLOPBNK
  *Old: =gfCloseFile('APBANKS')
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *USE IN APBANKS
  =GFCLOSETABLE('APBANKS')
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
ENDIF
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
SELECT APINVHDR
=GFREPLACE('')
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[end]
*Old: =lfRefresh()

RETURN
*--end of lfvAprovPay

*!*************************************************************
*! Name      : lfvCrdVend
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 8/3/2004
*! Purpose   : To Validate the Vendor Code in the apInvCrd Screen
*!*************************************************************
*! Parameters: The FormSet, Reference to apInvCrd Form
*!*************************************************************
*! Returns   : None
*!*************************************************************
FUNCTION LFVCRDVEND
LPARAMETERS LOFORMSET, LOINVCRD
LOCAL LLRETVAL

LLRETVAL = .T.

SELECT APVENDOR
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
=GFSEEK("")
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
LCSAVEXACT= SET('EXACT')
SET EXACT ON

LOFORMSET.LLBROWSE = LOINVCRD.KBVENDCODE.SELECTEDFROMBROWSE

IF LOFORMSET.LLBROWSE .OR. !EMPTY(LOINVCRD.KBVENDCODE.KEYTEXTBOX.VALUE)
  IF LOFORMSET.LLBROWSE .OR. !SEEK(LOINVCRD.KBVENDCODE.KEYTEXTBOX.VALUE) .OR. ;
      ATC("?",LOINVCRD.KBVENDCODE.KEYTEXTBOX.VALUE) > 0
    LOFORMSET.LLBROWSE = .F.
    DIMENSION LATEMP[1]

    LATEMP = ''

    *lcSavBrFld = lcBrFields
    *lcSavTitle = lcFile_Ttl
    *N000682,1 MMT 11/22/2012 Globalization changes[Start]
    *LCBRFIELDS = "CVENDCODE :H= 'Vendor Code',;
                  CVENCOMP :H= 'Company',;
                  CPHONENO :H= 'Phone'"

    *lcFile_Ttl = "Vendor"
    LCBRFIELDS = "CVENDCODE :H= '"+IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_VENDORCODE,loFormSet.GetHeaderText("LANG_APPYINV_VENDORCODE",loFormSet.HeaderAlias))+"',;
                  CVENCOMP :H= '"+IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_COMPANY,loFormSet.GetHeaderText("LANG_APPYINV_COMPANY",loFormSet.HeaderAlias))+"',;
CPHONENO :H= '"+IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_PHONE,loFormSet.GetHeaderText("LANG_APPYINV_PHONE",loFormSet.HeaderAlias))+"'"


    *lcFile_Ttl = LANG_APPYINV_VENDORS
    *N000682,1 MMT 11/22/2012 Globalization changes[END]
    *! E302623,2 MMT 10/12/2009 Convert Payable invoice screen to use SQL tables[Start]
    *=gfBrows(.F.,'CVENDCODE,CVENCOMP,CPHONENO','laTemp')
    *! E302623,3 MMT 01/03/2010 Convert Payable invoice screen to use SQL tables[Start]
    *=gfBrows(.F.,'CVENDCODE,CVENCOMP,CPHONENO','laTemp',"Vendor")
    =ARIABROW(.F., 'Vendors', .F., .F., .F., .F., .F., .T., ;
      'CVENDCODE,CPHONENO,CVENCOMP', 'laTemp', .F., .F., .F., ;
      .F., .F., .F., .F., .F., ;
      .F., .F.)

    *! E302623,3 MMT 01/03/2010 Convert Payable invoice screen to use SQL tables[End]
    *! E302623,2 MMT 10/12/2009 Convert Payable invoice screen to use SQL tables[End]

    *lcBrFields = lcSavBrFld
    *lcFile_Ttl = lcSavTitle

    IF !EMPTY(LATEMP[1])
      LOINVCRD.KBVENDCODE.KEYTEXTBOX.VALUE = LATEMP[1]
      IF !EMPTY(LOINVCRD.KBVENDCODE.KEYTEXTBOX.VALUE) .AND. ;
          LOINVCRD.KBVENDCODE.KEYTEXTBOX.VALUE = LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE
        ** MESSAGE : " The credit card vendor can not be  "
        **           " the same as the invoice vendor.    "

        =GFMODALGEN("TRM04013B00000","DIALOG")

        LOINVCRD.KBVENDCODE.KEYTEXTBOX.VALUE = SPACE(8)
        LOINVCRD.TXTVENCINV.VALUE = SPACE(12)
        LOFORMSET.LCACCOUNT  = LOFORMSET.ARIAFORM1.AP1.LCEMPTYACC
        *_CUROBJ    = _CUROBJ&&Old CurObj
        LLRETVAL = .F.
      ELSE

        IF !EMPTY(APVENDOR.CAPACCT)
          LOFORMSET.LCACCOUNT = APVENDOR.CAPACCT
        ELSE
          IF !EMPTY(APDIV.CAPACCT)
            LOFORMSET.LCACCOUNT = APDIV.CAPACCT
          ELSE
            LOFORMSET.LCACCOUNT = APSETUP.CAPACCT
          ENDIF
        ENDIF

        LOINVCRD.TXTVENCINV.VALUE = LFCRCINO(LOFORMSET, LOINVCRD)

      ENDIF
    ELSE
      LOINVCRD.KBVENDCODE.KEYTEXTBOX.VALUE = SPACE(8)
      LLRETVAL=.F.
    ENDIF
  ELSE
    IF !EMPTY(LOINVCRD.KBVENDCODE.KEYTEXTBOX.VALUE) .AND. ;
        LOINVCRD.KBVENDCODE.KEYTEXTBOX.VALUE = LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE
      ** MESSAGE : " The credit card vendor can not be  "
      **           " the same as the invoice vendor.    "
      =GFMODALGEN("TRM04013B00000","DIALOG")
      LOINVCRD.KBVENDCODE.KEYTEXTBOX.VALUE = SPACE(8)
      LOINVCRD.TXTVENCINV.VALUE = SPACE(12)
      LOFORMSET.LCACCOUNT  = LOFORMSET.ARIAFORM1.AP1.LCEMPTYACC  &&lower
      *_CUROBJ    = _CUROBJ&&Old CurObj
      LLRETVAL = .F.
    ELSE
      IF SEEK(LOINVCRD.KBVENDCODE.KEYTEXTBOX.VALUE)

        IF !EMPTY(APVENDOR.CAPACCT)
          LOFORMSET.LCACCOUNT = APVENDOR.CAPACCT
        ELSE
          IF !EMPTY(APDIV.CAPACCT)
            LOFORMSET.LCACCOUNT = APDIV.CAPACCT
          ELSE
            LOFORMSET.LCACCOUNT = APSETUP.CAPACCT
          ENDIF
        ENDIF

        LOINVCRD.TXTVENCINV.VALUE = LFCRCINO(LOFORMSET, LOINVCRD)

      ENDIF
    ENDIF
  ENDIF
ENDIF
SET EXACT &LCSAVEXACT

=SEEK (LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE,'APVENDOR')
SELECT APINVHDR
LOINVCRD.REFRESH()

RETURN LLRETVAL
*--end of lfvCrdVend

*!*************************************************************
*! Name      : lfCrCINo
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 8/3/2004
*! Purpose   : to create the Invoice No. in the apInvCrd screen
*!*************************************************************
*! Parameters: The FormSet, Reference to apInvCrd Form
*!*************************************************************
*! Returns   : None
*!*************************************************************
FUNCTION LFCRCINO
LPARAMETERS LOFORMSET, LOINVCRD

PRIVATE LCRETVAL

SELECT APINVHDR
LNCURRCO = RECNO()     &&Varible to hold the current record number

LOFORMSET.LCOLDVAL = IIF(LOINVCRD.KBVENDCODE.KEYTEXTBOX.VALUE = LOINVCRD.KBVENDCODE.KEYTEXTBOX.OLDVALUE, ;
  LOINVCRD.TXTVENCINV.VALUE, SPACE(12))
LCRETVAL = IIF(LFSEEKVENDINVNO(PADR(LOINVCRD.KBVENDCODE.KEYTEXTBOX.VALUE,8),PADR(LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE , 12)),;
  LOFORMSET.LCOLDVAL,IIF(EMPTY(LOFORMSET.LCOLDVAL),PADR(LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE,12) , LOFORMSET.LCOLDVAL) )

IF LNCURRCO <= RECCOUNT()
  GO LNCURRCO
ELSE      &&Else go to the end of file
  GO BOTTOM
  SKIP
ENDIF      &&End of IF

SELECT APVENDOR
RETURN LCRETVAL
*--end of lfCrCINo


*!*************************************************************
*! Name      : lfvCrdInvNo
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 8/3/2004
*! Purpose   : To Validate the Invoice in the apInvCrd Screen
*!*************************************************************
*! Parameters: The FormSet, Reference to apInvCrd Form
*!*************************************************************
*! Returns   : None
*!*************************************************************
FUNCTION LFVCRDINVNO
LPARAMETERS LOFORMSET, LOINVCRD
LOCAL LLRETVAL

LLRETVAL = .T.

SELECT APINVHDR
LNSAVRECNO = RECNO()

LCSAVEXACT= SET('EXACT')
SET EXACT ON

IF !EMPTY(LOINVCRD.KBVENDCODE.KEYTEXTBOX.VALUE) .AND. !EMPTY(LOINVCRD.TXTVENCINV.VALUE)
  IF LFSEEKVENDINVNO(LOINVCRD.KBVENDCODE.KEYTEXTBOX.VALUE,LOINVCRD.TXTVENCINV.VALUE)
    ** MESSAGE : " The invoice number already exist   "
    =GFMODALGEN("TRM04014B00000","DIALOG",APINVHDR.CVENCCINV)  &&lower
    LOINVCRD.TXTVENCINV.VALUE = SPACE(12)
    *_CUROBJ    = _CUROBJ&&Old CurObj
    LLRETVAL = 0
  ELSE
    IF EMPTY(STRTRAN(STRTRAN(LOFORMSET.LCACCOUNT,'-'),'0'))
      IF !EMPTY(APVENDOR.CAPACCT)
        LOFORMSET.LCACCOUNT = APVENDOR.CAPACCT
      ELSE
        IF !EMPTY(APDIV.CAPACCT)
          LOFORMSET.LCACCOUNT = APDIV.CAPACCT
        ELSE
          LOFORMSET.LCACCOUNT = APSETUP.CAPACCT
        ENDIF
      ENDIF
    ENDIF
  ENDIF
ENDIF

SET EXACT &LCSAVEXACT

SELECT APINVHDR

IF BETWEEN(LNSAVRECNO,0,RECCOUNT())
  GO LNSAVRECNO
ENDIF

*Old: SHOW GET apinvhdr.cvenccinv  &&lower &&Revise
*Old: SHOW GET loFormSet.lcAccount &&Revise

RETURN LLRETVAL
*--end of lfvCrdInvNo

*!*************************************************************
*! Name      : lfSeekVendInvNo
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 8/3/2004
*! Purpose   : To Seek Vendor Code + Invoice No. in APINVHDR
*!*************************************************************
*! Parameters: Vendor Code, Invoice No.
*!*************************************************************
*! Returns   : None
*!*************************************************************
FUNCTION LFSEEKVENDINVNO
LPARAMETERS LCVEND, LCINVNO

*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*!*	LOCAL ARRAY laAry[1]

*!*	laAry = .F.

*!*	SELECT CVENDCODE FROM (oAriaApplication.DataDir+'APINVHDR') WHERE ;
*!*	  CVENDCODE=lcVend AND CINVNO=lcInvNo INTO ARRAY laAry
*!*
*!*	RETURN (TYPE('laAry[1]')='C')
LOCAL ARRAY LAARRAY[1]

LAARRAY= .F.

SELECT CVENDCODE FROM (OARIAAPPLICATION.DATADIR+'APINVHDR') WHERE ;
  CVENDCODE=LCVEND AND CINVNO=LCINVNO INTO ARRAY LAARRAY

RETURN (TYPE('laArray[1]')='C')
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[END]
*--end of lfSeekVendInvNo


*!*************************************************************
*! Name      : lfvBnkChk
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 8/3/2004
*! Purpose   : To Validate the Bank Code and Checking Account Code in the apAprov Screen
*!*************************************************************
*! Parameters: The FormSet, Reference to apAprov Form
*!*************************************************************
*! Returns   : None
*!*************************************************************
FUNCTION LFVBNKCHK
LPARAMETERS LOFORMSET, LOAPROV
LOCAL LCTEMP

IF GFGETMEMVAR('LLMULCURR') .AND. !EMPTY(APINVHDR.CCHKACCT)
  IF SEEK(APINVHDR.CBNKCODE+APINVHDR.CCHKACCT,'APCHECKS')
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *!*	    REPLACE apinvhdr.caprcurcod WITH IIF(EMPTY(APCHECKS.CCURRCODE),;
    *!*	                                         loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value,;
    *!*	                                         APCHECKS.CCURRCODE)
    REPLACE APINVHDR.CAPRCURCOD WITH IIF(EMPTY(APCHECKS.CCURRCODE),;
      LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.KEYTEXTBOX.VALUE,;
      APCHECKS.CCURRCODE)
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[END]
  ELSE
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *    REPLACE apinvhdr.caprcurcod WITH loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value
    REPLACE APINVHDR.CAPRCURCOD WITH LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.KEYTEXTBOX.VALUE
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  ENDIF
ELSE
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *  REPLACE apinvhdr.caprcurcod WITH loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value
  REPLACE APINVHDR.CAPRCURCOD WITH LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.KEYTEXTBOX.VALUE
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
ENDIF

*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*IF apinvhdr.caprcurcod = loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value
IF APINVHDR.CAPRCURCOD = LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.KEYTEXTBOX.VALUE
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  REPLACE APINVHDR.NAPREXRAT WITH 1
  REPLACE APINVHDR.NAPRCURUNT WITH 1
  *Old: SHOW GET apinvhdr.naprexrat DISABLE  &&lower &&Revise
  LOAPROV.TXTAPREXRAT.ENABLED = .F.
ELSE
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *IF loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value = oAriaApplication.BaseCurrency
  IF LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.KEYTEXTBOX.VALUE = OARIAAPPLICATION.BASECURRENCY
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    PRIVATE APRCURUNT
    APRCURUNT = APINVHDR.NAPRCURUNT

    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *!*	    REPLACE apinvhdr.naprexrat WITH gfChkRate('aprcurunt',apinvhdr.caprcurcod,;
    *!*	                                              loFormSet.AriaForm1.DtInvDate.Value,.F.,.F.,;
    *!*	                                              loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value)
    REPLACE APINVHDR.NAPREXRAT WITH GFCHKRATE('aprcurunt',APINVHDR.CAPRCURCOD,;
      LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.DTINVDATE.VALUE,.F.,.F.,;
      LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.KEYTEXTBOX.VALUE)
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    REPLACE APINVHDR.NAPRCURUNT WITH APRCURUNT
  ELSE
    PRIVATE APRCURUNT
    APRCURUNT = APINVHDR.NAPRCURUNT
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *    REPLACE apinvhdr.naprexrat WITH gfChkRate('aprcurunt',;
    loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value,;
    loFormSet.AriaForm1.DtInvDate.Value,.F.,.F.,;
    apinvhdr.caprcurcod)
    REPLACE APINVHDR.NAPREXRAT WITH GFCHKRATE('aprcurunt',;
      LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.KEYTEXTBOX.VALUE,;
      LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.DTINVDATE.VALUE,.F.,.F.,;
      APINVHDR.CAPRCURCOD)
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    REPLACE APINVHDR.NAPRCURUNT WITH APRCURUNT
  ENDIF

  IF APINVHDR.NAPREXRAT = 0
    ** MESSAGE : " A valid  to  exchange rate could not "
    **           " be found for .                        "

    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *IF loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value = oAriaApplication.BaseCurrency
    *=gfModalGen("QRM04157B00000","DIALOG",ALLTRIM(apinvhdr.caprcurcod)+'|'+ALLTRIM(loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value)+'|'+DTOC(loFormSet.AriaForm1.DtInvDate.Value))
    IF LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.KEYTEXTBOX.VALUE = OARIAAPPLICATION.BASECURRENCY
            =GFMODALGEN("QRM04157B00000","DIALOG",ALLTRIM(APINVHDR.CAPRCURCOD)+'|'+ALLTRIM(LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.KEYTEXTBOX.VALUE)+'|'+DTOC(LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.DTINVDATE.VALUE))
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    ELSE
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *=gfModalGen("QRM04157B00000","DIALOG",ALLTRIM(loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value)+'|'+ALLTRIM(apinvhdr.caprcurcod)+'|'+DTOC(loFormSet.AriaForm1.DtInvDate.Value))
      =GFMODALGEN("QRM04157B00000","DIALOG",ALLTRIM(LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.KEYTEXTBOX.VALUE)+'|'+ALLTRIM(APINVHDR.CAPRCURCOD)+'|'+DTOC(LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.DTINVDATE.VALUE))
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    ENDIF

    LOAPROV.TXTAPREXRAT.VALUE = 1
    *_CUROBJ = OBJNUM(apinvhdr.cchkglacc)
  ENDIF
  *Old: SHOW GET apinvhdr.naprexrat ENABLE  &&lower &&Revise
  LOAPROV.TXTAPREXRAT.ENABLED = .T.
ENDIF
LOFORMSET.LCEXSIN4 = ' '

*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*IF loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value = oAriaApplication.BaseCurrency
IF LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.KEYTEXTBOX.VALUE = OARIAAPPLICATION.BASECURRENCY
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  LCEXSIN4 = LOFORMSET.LCEXSIN4
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  * loFormSet.lcExSin3 = gfGetExSin(@lcExSin4,apinvhdr.caprcurcod,loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value)
  LOFORMSET.LCEXSIN3 = GFGETEXSIN(@LCEXSIN4,APINVHDR.CAPRCURCOD,LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.KEYTEXTBOX.VALUE)
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  LOFORMSET.LCEXSIN4 = LCEXSIN4
  LOFORMSET.LCEXSIN3 = IIF(LOFORMSET.LCEXSIN3 = '*' , '/' , '*')
  LOFORMSET.LCEXSIN4 = IIF(LOFORMSET.LCEXSIN4 = '*' , '/' , '*')
ELSE
  LCEXSIN4 = LOFORMSET.LCEXSIN4

  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *loFormSet.lcExSin3 = gfGetExSin(@lcExSin4,loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value,apinvhdr.caprcurcod)    &&lower  &&lower
  LOFORMSET.LCEXSIN3 = GFGETEXSIN(@LCEXSIN4,LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.KEYTEXTBOX.VALUE,APINVHDR.CAPRCURCOD)    &&lower  &&lower
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

  LOFORMSET.LCEXSIN4 = LCEXSIN4
ENDIF

LCTEMP = 'apinvhdr.ninvamtap'+LOFORMSET.LCEXSIN3+'apinvhdr.naprexrat'+LOFORMSET.LCEXSIN4+;
  'apinvhdr.naprcurunt'
*!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][Start]
TRY
  *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][End]
  REPLACE APINVHDR.NINVFAAP WITH ROUND(&LCTEMP,2)
  *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][Start]
CATCH
  REPLACE  APINVHDR.NINVFAAP WITH 0
ENDTRY
*!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][End]
*=lfRefresh()

RETURN
*--end of lfvBnkChk


*!*************************************************************
*! Name      : lfvAprCurrency
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 11/1/2004
*! Purpose   : To Validate Currency in the apAprov Screen
*!*************************************************************
*! Parameters: The FormSet, Reference to apAprov Form
*!*************************************************************
*! Returns   : None
*!*************************************************************
FUNCTION LFVAPRCURRENCY
LPARAMETERS LOFORMSET, LOAPROV
LOCAL LCTEMP

*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*=gfOpenFile(oAriaApplication.SysPath + 'SYCCURR' , 'CCURRCODE' , 'SH')
=GFOPENTABLE(OARIAAPPLICATION.SYSPATH + 'SYCCURR' , 'CCURRCODE' , 'SH')
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
LOFORMSET.LLBROWSE = LOAPROV.KBAPRCURRCODE.SELECTEDFROMBROWSE
IF LOFORMSET.LLBROWSE .OR. !SEEK(LOAPROV.KBAPRCURRCODE.KEYTEXTBOX.VALUE,'SYCCURR') .OR. ;
    ATC("?",LOAPROV.KBAPRCURRCODE.KEYTEXTBOX.VALUE) > 0
  SELECT SYCCURR
  DIMENSION LATEMP[1]
  LATEMP     = ''
  *N000682,1 MMT 11/22/2012 Globalization changes[Start]
  *LCFILE_TTL = "Currency"
  *LCBRFIELDS = "CCURRCODE :R :H= 'Currency code'," +;
    "CCURRDESC :R :H= 'Description',  " +;
    "CCURRSMBL :R :H= 'Symbol'"
  *N000682,1 11/20/2012 MMT Globlization changes[Start]
*LCFILE_TTL = LANG_APPYINV_CURRENCY
LCFILE_TTL = IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_CURRENCY,loFormSet.GetHeaderText("LANG_APPYINV_CURRENCY",loFormSet.HeaderAlias))
*N000682,1 11/20/2012 MMT Globlization changes[End]

  LCBRFIELDS = "CCURRCODE :R :H= '"+IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_CURRENCYCODE,loFormSet.GetHeaderText("LANG_APPYINV_CURRENCYCODE",loFormSet.HeaderAlias))+"'," +;
    "CCURRDESC :R :H= '"+IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_DESC,loFormSet.GetHeaderText("LANG_APPYINV_DESC",loFormSet.HeaderAlias))+"',  " +;
"CCURRSMBL :R :H= '"+IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_SYMBOL,loFormSet.GetHeaderText("LANG_APPYINV_SYMBOL",loFormSet.HeaderAlias))+"'"


  *N000682,1 MMT 11/22/2012 Globalization changes[END]
  *! E302623,2 MMT 10/12/2009 Convert Payable invoice screen to use SQL tables[Start]
  *=gfBrows('','CCURRCODE','laTemp')
  *! E302623,3 MMT 01/03/2010 Convert Payable invoice screen to use SQL tables[Start]
  *=gfBrows('','CCURRCODE','laTemp',lcFile_Ttl )
  =ARIABROW('', LCFILE_TTL , .F., .F., .F., .F., .F., .T., ;
    'CCURRCODE', 'laTemp', .F., .F., .F., ;
    .F., .F., .F., .F., .F., ;
    .F., .F.)
  *! E302623,3 MMT 01/03/2010 Convert Payable invoice screen to use SQL tables[End]
  *! E302623,2 MMT 10/12/2009 Convert Payable invoice screen to use SQL tables[End]
  IF EMPTY(LATEMP[1])
    LOAPROV.KBAPRCURRCODE.KEYTEXTBOX.VALUE = LOAPROV.KBAPRCURRCODE.KEYTEXTBOX.OLDVALUE
  ELSE
    LOAPROV.KBAPRCURRCODE.KEYTEXTBOX.VALUE = LATEMP[1]
  ENDIF
ENDIF

IF LOAPROV.KBAPRCURRCODE.KEYTEXTBOX.VALUE <> LOAPROV.KBAPRCURRCODE.KEYTEXTBOX.OLDVALUE

  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *IF gfGetMemVar('LLMULCURR') .AND. ;
  * loAprov.kbAprCurrCode.KeyTextBox.Value <> loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value
  IF GFGETMEMVAR('LLMULCURR') .AND. ;
      LOAPROV.KBAPRCURRCODE.KEYTEXTBOX.VALUE <> LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.KEYTEXTBOX.VALUE
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    LNCURRUNIT = 0


    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *IF loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value = oAriaApplication.BaseCurrency
    *REPLACE apinvhdr.naprexrat WITH gfChkRate('lnCurrUnit',apinvhdr.caprcurcod,loFormSet.AriaForm1.DtInvDate.Value,.F.,.F.,loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value) IN apinvhdr
    IF LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.KEYTEXTBOX.VALUE = OARIAAPPLICATION.BASECURRENCY
      REPLACE APINVHDR.NAPREXRAT WITH GFCHKRATE('lnCurrUnit',APINVHDR.CAPRCURCOD,LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.DTINVDATE.VALUE,.F.,.F.,LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.KEYTEXTBOX.VALUE) IN APINVHDR
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    ELSE
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *REPLACE apinvhdr.naprexrat WITH gfChkRate('lnCurrUnit',loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value,loFormSet.AriaForm1.DtInvDate.Value,.F.,.F.,apinvhdr.caprcurcod) IN apinvhdr
      REPLACE APINVHDR.NAPREXRAT WITH GFCHKRATE('lnCurrUnit',LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.KEYTEXTBOX.VALUE,LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.DTINVDATE.VALUE,.F.,.F.,APINVHDR.CAPRCURCOD) IN APINVHDR
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    ENDIF
    REPLACE APINVHDR.NAPRCURUNT WITH LNCURRUNIT IN APINVHDR

    LOFORMSET.LCEXSIN4 = ' '
    LCEXSIN4 = LOFORMSET.LCEXSIN4
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *IF loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value = oAriaApplication.BaseCurrency
    *loFormSet.lcExSin3 = gfGetExSin(@lcExSin4,apinvhdr.caprcurcod,loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value)
    IF LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.KEYTEXTBOX.VALUE = OARIAAPPLICATION.BASECURRENCY
      LOFORMSET.LCEXSIN3 = GFGETEXSIN(@LCEXSIN4,APINVHDR.CAPRCURCOD,LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.KEYTEXTBOX.VALUE)
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

      LOFORMSET.LCEXSIN4 = LCEXSIN4
      LOFORMSET.LCEXSIN3 = IIF(LOFORMSET.LCEXSIN3 = '*' , '/' , '*')
      LOFORMSET.LCEXSIN4 = IIF(LOFORMSET.LCEXSIN4 = '*' , '/' , '*')
    ELSE
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *loFormSet.lcExSin3 = gfGetExSin(@lcExSin4,loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value,apinvhdr.caprcurcod)
      LOFORMSET.LCEXSIN3 = GFGETEXSIN(@LCEXSIN4,LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.KEYTEXTBOX.VALUE,APINVHDR.CAPRCURCOD)
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      LOFORMSET.LCEXSIN4 = LCEXSIN4
    ENDIF

    IF APINVHDR.NAPREXRAT = 0
      ** MESSAGE : " A valid  to  exchange rate could not "
      **           " be found for .                        "
      **           "                   Ok                 "

      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      * IF loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value = oAriaApplication.BaseCurrency
      *=gfModalGen("QRM04157B00000","DIALOG",ALLTRIM(apinvhdr.caprcurcod)+'|'+ALLTRIM(loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value)+'|'+DTOC(loFormSet.AriaForm1.DtInvDate.Value))
      IF LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.KEYTEXTBOX.VALUE = OARIAAPPLICATION.BASECURRENCY
        =GFMODALGEN("QRM04157B00000","DIALOG",ALLTRIM(APINVHDR.CAPRCURCOD)+'|'+ALLTRIM(LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.KEYTEXTBOX.VALUE)+'|'+DTOC(LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.DTINVDATE.VALUE))
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      ELSE
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        *=gfModalGen("QRM04157B00000","DIALOG",ALLTRIM(loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value)+'|'+ALLTRIM(apinvhdr.caprcurcod)+'|'+DTOC(loFormSet.AriaForm1.DtInvDate.Value))
        =gfModalGen("QRM04157B00000","DIALOG",ALLTRIM(loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value)+'|'+ALLTRIM(apinvhdr.caprcurcod)+'|'+DTOC(loFormSet.AriaForm1.DtInvDate.Value))
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      ENDIF

      REPLACE APINVHDR.NAPREXRAT WITH  1 IN APINVHDR
      REPLACE APINVHDR.NAPRCURUNT WITH 1 IN APINVHDR
    ENDIF

    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *!*	    IF loAprov.kbAprCurrCode.KeyTextBox.Value  = loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value
    IF LOAPROV.KBAPRCURRCODE.KEYTEXTBOX.VALUE  = LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.KEYTEXTBOX.VALUE
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      *Old: SHOW GET apinvhdr.naprexrat DISABLE  &&lower &&Revise
      LOAPROV.TXTAPREXRAT.ENABLED = .F.
    ELSE
      *Old: SHOW GET apinvhdr.naprexrat ENABLE  &&lower &&Revise
      LOAPROV.TXTAPREXRAT.ENABLED = .T.
    ENDIF
  ELSE
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *REPLACE apinvhdr.caprcurcod WITH loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value IN apinvhdr
    REPLACE APINVHDR.CAPRCURCOD WITH LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.KEYTEXTBOX.VALUE IN APINVHDR
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    REPLACE APINVHDR.NAPREXRAT WITH 1 IN APINVHDR
    REPLACE APINVHDR.NAPRCURUNT WITH 1 IN APINVHDR
    *Old: SHOW GET apinvhdr.naprexrat DISABLE  &&lower &&Revise
    LOAPROV.TXTAPREXRAT.ENABLED = .F.
  ENDIF
ENDIF
LCTEMP ='apinvhdr.ninvamtap'+LOFORMSET.LCEXSIN3+'apinvhdr.naprexrat'+LOFORMSET.LCEXSIN4+;
  'apinvhdr.naprcurunt'
*!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][Start]
TRY
  *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][End]
  REPLACE APINVHDR.NINVFAAP WITH ROUND(&LCTEMP,2) IN APINVHDR
  *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][Start]
CATCH
  REPLACE APINVHDR.NINVFAAP WITH 0 IN APINVHDR
ENDTRY
*!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][End]
WITH LOAPROV
  .KBAPRCURRCODE.REFRESH()
  .TXTAPREXRAT.REFRESH()
  .TXTINVFAAP.REFRESH()
ENDWITH

SELECT APINVHDR

RETURN
*--end of lfvAprCurrency


*!*************************************************************
*! Name      : lfvExRate
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 8/3/2004
*! Purpose   : To Validate Exchange Rate in the apAprov Screen
*!*************************************************************
*! Parameters: The FormSet, Reference to apAprov Form
*!*************************************************************
*! Returns   : None
*!*************************************************************

*B608697,1 MMT 09/29/2008 fix bug while editing ex. rate[Start]
*FUNCTION lfvExRate
FUNCTION LFVAPREXRATE
*B608697,1 MMT 09/29/2008 fix bug while editing ex. rate[End]

LPARAMETERS LOFORMSET, LOAPROV
LOCAL LCTEMP


IF LOAPROV.TXTAPREXRAT.VALUE <= 0
  LOAPROV.TXTAPREXRAT.VALUE = LOAPROV.TXTAPREXRAT.OLDVALUE
ENDIF

LCTEMP = 'apinvhdr.ninvamtap'+LOFORMSET.LCEXSIN3+'apinvhdr.naprexrat'+LOFORMSET.LCEXSIN4+;
  'apinvhdr.naprcurunt'
*!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][Start]
TRY
  *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][End]
  REPLACE APINVHDR.NINVFAAP WITH ROUND(&LCTEMP,2)
  *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][Start]
CATCH
  REPLACE APINVHDR.NINVFAAP WITH 0
ENDTRY
*!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][End]
*=lfRefresh()

RETURN
*--end of lfvExRate

*!*************************************************************
*! Name      : lfvApprove
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 8/3/2004
*! Purpose   : To Validate the Approved amount, discount and adjustment in the apAprov screen
*!*************************************************************
*! Parameters: The FormSet, Reference to apAprov Form, lnObjNum
*!*************************************************************
*! Returns   : None
*!*************************************************************
FUNCTION LFVAPPROVE
LPARAMETERS LOFORMSET, LOAPROV, LNOBJNUM
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*IF loFormSet.AriaForm1.txtInvAmount.Value > 0
* IF !BETWEEN(apinvhdr.ninvdisap+apinvhdr.ninvamtap+apinvhdr.ninvadjap,;
0, loFormSet.AriaForm1.txtInvAmount.Value-apinvhdr.ninvpaid-;
apinvhdr.ninvdistk-apinvhdr.ninvadj)

IF LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTINVAMOUNT.VALUE > 0
  IF !BETWEEN(APINVHDR.NINVDISAP+APINVHDR.NINVAMTAP+APINVHDR.NINVADJAP,;
      0, LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTINVAMOUNT.VALUE-APINVHDR.NINVPAID-;
      APINVHDR.NINVDISTK-APINVHDR.NINVADJ)
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    ** MESSAGE : " Total approved amount can not be greater than "
    **           " the open amount.
    *N000682,1 MMT 11/22/2012 Globalization changes[Start]
    *=GFMODALGEN("TRM04015B00000","DIALOG",LOFORMSET.LCTAPRAMNT+"|"+'invoice')           "
    *N000682,1 11/20/2012 MMT Globlization changes[Start]
*=GFMODALGEN("TRM04015B00000","DIALOG",LOFORMSET.LCTAPRAMNT+"|"+LANG_APPYINV_INVOICE_TEXT)
=GFMODALGEN("TRM04015B00000","DIALOG",LOFORMSET.LCTAPRAMNT+"|"+IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_INVOICE_TEXT,loFormSet.GetHeaderText("LANG_APPYINV_INVOICE_TEXT",loFormSet.HeaderAlias)))
*N000682,1 11/20/2012 MMT Globlization changes[End]

    *N000682,1 MMT 11/22/2012 Globalization changes[END]
    DO CASE
    CASE LNOBJNUM = 1
      LOAPROV.TXTINVDISAP.VALUE = LOAPROV.TXTINVDISAP.OLDVALUE
    CASE LNOBJNUM = 2
      LOAPROV.TXTINVAMTAP.VALUE = LOAPROV.TXTINVAMTAP.OLDVALUE
    CASE LNOBJNUM = 3
      LOAPROV.TXTINVADJAP.VALUE = LOAPROV.TXTINVADJAP.OLDVALUE
    ENDCASE
  ENDIF
ELSE
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	  IF !BETWEEN(apinvhdr.ninvdisap+apinvhdr.ninvamtap+apinvhdr.ninvadjap,;
  *!*	              loFormSet.AriaForm1.txtInvAmount.Value-apinvhdr.ninvpaid-apinvhdr.ninvdistk-;
  *!*	              apinvhdr.ninvadj,0)
  IF !BETWEEN(APINVHDR.NINVDISAP+APINVHDR.NINVAMTAP+APINVHDR.NINVADJAP,;
      LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTINVAMOUNT.VALUE-APINVHDR.NINVPAID-APINVHDR.NINVDISTK-;
      APINVHDR.NINVADJ,0)
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    ** MESSAGE : " Total approved amount can not be greater than "
    **           " the open amount.
    *N000682,1 MMT 11/22/2012 Globalization changes[Start]
    *=GFMODALGEN("TRM04015B00000","DIALOG",LOFORMSET.LCTAPRAMNT+"|"+'debit memo ')
    *N000682,1 11/20/2012 MMT Globlization changes[Start]
*=GFMODALGEN("TRM04015B00000","DIALOG",LOFORMSET.LCTAPRAMNT+"|"+LANG_APPYINV_DEBITMEMO_TEXT)
=GFMODALGEN("TRM04015B00000","DIALOG",LOFORMSET.LCTAPRAMNT+"|"+IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_DEBITMEMO_TEXT,loFormSet.GetHeaderText("LANG_APPYINV_DEBITMEMO_TEXT",loFormSet.HeaderAlias)))
*N000682,1 11/20/2012 MMT Globlization changes[End]

    *N000682,1 MMT 11/22/2012 Globalization changes[END]
    DO CASE
    CASE LNOBJNUM = 1
      LOAPROV.TXTINVDISAP.VALUE = LOAPROV.TXTINVDISAP.OLDVALUE
    CASE LNOBJNUM = 2
      LOAPROV.TXTINVAMTAP.VALUE = LOAPROV.TXTINVAMTAP.OLDVALUE
    CASE LNOBJNUM = 3
      LOAPROV.TXTINVADJAP.VALUE = LOAPROV.TXTINVADJAP.OLDVALUE
    ENDCASE
  ENDIF
ENDIF

LCTEMP = 'apinvhdr.ninvamtap'+LOFORMSET.LCEXSIN3+;
  IIF(LOFORMSET.LCEXSIN3='/',"iif(apinvhdr.naprexrat=0,1,apinvhdr.naprexrat)","apinvhdr.naprexrat")+LOFORMSET.LCEXSIN4+;
  IIF(LOFORMSET.LCEXSIN4='/',"iif(apinvhdr.naprcurunt=0,1,apinvhdr.naprcurunt)","apinvhdr.naprcurunt")

*!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][Start]
TRY
  *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][End]
  REPLACE APINVHDR.NINVFAAP WITH ROUND(&LCTEMP,2) IN APINVHDR
  *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][Start]
CATCH
  REPLACE APINVHDR.NINVFAAP WITH 0 IN APINVHDR
ENDTRY
*!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][End]
*Old: SHOW GET apinvhdr.ninvdisap  &&lower &&Revise
*Old: SHOW GET apinvhdr.ninvamtap  &&lower &&Revise
*Old: SHOW GET apinvhdr.ninva1099 &loFormSet.lcData23St  &&lower &&Revise
LOAPROV.TXTINVA1099.ENABLED = (LOFORMSET.LCDATA23ST='ENABLE')
*Old: SHOW GET apinvhdr.ninvadjap  &&lower &&Revise

*=lfRefresh()

RETURN
*--end of lfvApprove

*!*************************************************************
*! Name      : lfv1099Aprov
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 8/3/2004
*! Purpose   : To Validate the 1099amount of the apApprov Screen
*!*************************************************************
*! Parameters: The FormSet, Reference to apAprov Form
*!*************************************************************
*! Returns   : None
*!*************************************************************
FUNCTION LFV1099APROV
LPARAMETERS LOFORMSET, LOAPROV

DO CASE
CASE APINVHDR.NINVAMTAP > 0
  IF !BETWEEN(APINVHDR.NINVA1099,0,APINVHDR.NINVAMTAP)
    ** MESSAGE : " The 1099 amount must be between 0 and ."
    =GFMODALGEN("TRM04017B00000","DIALOG",'0'+"|"+ALLTRIM(STR(APINVHDR.NINVAMTAP,15,2)))
    LOAPROV.TXTINVA1099.VALUE = LOAPROV.TXTINVA1099.OLDVALUE
  ENDIF
CASE APINVHDR.NINVAMTAP < 0
  IF !BETWEEN(APINVHDR.NINVA1099,APINVHDR.NINVAMTAP,0)
    ** MESSAGE : " The 1099 amount must be between  and 0."
    =GFMODALGEN("TRM04017B00000","DIALOG",ALLTRIM(STR(APINVHDR.NINVAMTAP,15,2))+"|"+'0')  &&lower
    LOAPROV.TXTINVA1099.VALUE = LOAPROV.TXTINVA1099.OLDVALUE
  ENDIF
CASE APINVHDR.NINVAMTAP = 0 .AND. APINVHDR.NINVA1099 > APINVHDR.NINVAMTAP
  ** MESSAGE : " The 1099 amount can not be greater than "
  **           " the approve to pay amount.              "
  =GFMODALGEN("TRM04147B00000","DIALOG")
  LOAPROV.TXTINVA1099.VALUE = LOAPROV.TXTINVA1099.OLDVALUE
ENDCASE

*Old: SHOW GET apinvhdr.ninva1099 &loFormSet.lcData23St  &&lower &&Revise
LOAPROV.TXTINVA1099.ENABLED = (LOFORMSET.LCDATA23ST='ENABLE')

RETURN
*--end of lfv1099Aprov

*!*************************************************************
*! Name      : lfvOkApr
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 8/3/2004
*! Purpose   : Clicking Ok button of the in the apAprov Screen
*!*************************************************************
*! Parameters: The FormSet, Reference to apAprov Form
*!*************************************************************
*! Returns   : None
*!*************************************************************
FUNCTION LFVOKAPR
LPARAMETERS LOFORMSET, LOAPROV

IF EMPTY(APINVHDR.NAPREXRAT)
  ** MESSAGE : "      should be greater than        "
  *N000682,1 MMT 11/22/2012 Globalization changes[Start]
  *=GFMODALGEN("TRM04072B00000" , "DIALOG" , "Exchange rate|zero")
  *N000682,1 11/20/2012 MMT Globlization changes[Start]
*=GFMODALGEN("TRM04072B00000" , "DIALOG" , LANG_APPYINV_EXCHANGE)
=GFMODALGEN("TRM04072B00000" , "DIALOG" , IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_EXCHANGE,loFormSet.GetHeaderText("LANG_APPYINV_EXCHANGE",loFormSet.HeaderAlias)))
*N000682,1 11/20/2012 MMT Globlization changes[End]

  *N000682,1 MMT 11/22/2012 Globalization changes[END]
  LOAPROV.TXTAPREXRAT.SETFOCUS()
  RETURN .F.
ENDIF

LCEMPTYOBJ = NULL


DO CASE
CASE APINVHDR.NINVAMTAP = 0
  ** MESSAGE : " You have to enter the approved to pay amount."
  =GFMODALGEN("TRM04022B00000","DIALOG")
  *Old: _CUROBJ = OBJNUM(apinvhdr.ninvamtap)  &&lower&&Old CurObj
  LOAPROV.TXTINVAMTAP.SETFOCUS()
  RETURN .F.

CASE EMPTY(STRTRAN(STRTRAN(APINVHDR.CCHKGLACC,'-'),'0'))
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	    IF loFormSet.AriaForm1.cboVendPmeth.Value = 'H'
  IF LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.CBOVENDPMETH.VALUE = 'H'
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    ** MESSAGE : " You have to enter the  account.     "
    =GFMODALGEN("TRM04020B00000","DIALOG",LOFORMSET.LCTPAYACCT)
    *Old: _CUROBJ = OBJNUM(apinvhdr.cchkglacc)
    LOAPROV.GLCHKACTCODE.KEYTEXTBOX.SETFOCUS()
    RETURN .F.
  ELSE
    LCEMPTYOBJ = LOAPROV.GLCHKACTCODE.KEYTEXTBOX
  ENDIF
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	  CASE loFormSet.AriaForm1.cboVendPmeth.Value <> 'H' .AND. EMPTY(apinvhdr.cbnkcode)
CASE LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.CBOVENDPMETH.VALUE <> 'H' .AND. EMPTY(APINVHDR.CBNKCODE)
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  LCEMPTYOBJ = LOAPROV.BANKCHK.KBBANKS.KEYTEXTBOX

  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	  CASE loFormSet.AriaForm1.cboVendPmeth.Value <> 'H' .AND. EMPTY(apinvhdr.cchkacct)
CASE LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.CBOVENDPMETH.VALUE <> 'H' .AND. EMPTY(APINVHDR.CCHKACCT)
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[END]
  LCEMPTYOBJ = LOAPROV.BANKCHK.KBCHKACCOUNT.KEYTEXTBOX

ENDCASE

*IF !EMPTY(lcEmptyObj)
IF !ISNULL(LCEMPTYOBJ)
  ** MESSAGE : " You have to enter the bank code,the  "
  **           " checking account,and the GL account. "
  =GFMODALGEN("TRM04021B00000","DIALOG")
  *_CUROBJ = OBJNUM(&lcEmptyObj)
  LCEMPTYOBJ.SETFOCUS()
  RETURN .F.
ENDIF

IF LOFORMSET.LCDATA23ST = 'ENABLE'
  IF APINVHDR.NINVAMTAP >= 0  &&lower
    LNLOWERVAL = 0
    LNUPPERVAL = APINVHDR.NINVAMTAP  &&lower
  ELSE
    LNLOWERVAL = APINVHDR.NINVAMTAP  &&lower
    LNUPPERVAL = 0
  ENDIF

  IF !BETWEEN(APINVHDR.NINVA1099,LNLOWERVAL,LNUPPERVAL)
    ** MESSAGE : " The 1099 amount must be between 0 and ."
    =GFMODALGEN("TRM04017B00000","DIALOG",;
      ALLTRIM(STR(LNLOWERVAL,15,2))+"|"+ALLTRIM(STR(LNUPPERVAL,15,2)))
    *_CUROBJ = OBJNUM(apinvhdr.ninva1099)
    LOAPROV.TXTINVA1099.SETFOCUS()
    RETURN .F.
  ENDIF
ENDIF

IF !GFGETMEMVAR('LLMULCURR') .AND. LOFORMSET.ACTIVEMODE="A" && If not multi currrency.
  REPLACE APINVHDR.CAPRCURCOD WITH OARIAAPPLICATION.BASECURRENCY
  REPLACE APINVHDR.NAPREXRAT WITH 1
  REPLACE APINVHDR.NAPRCURUNT WITH 1
ENDIF

*CLEAR READ

RETURN .T.
*--end of lfvOkApr


*!*************************************************************
*! Name      : lfvClrApr
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 7/29/2004
*! Purpose   : Validation function of the Cancel push button of the apAprov Screen.
*!*************************************************************
*! Parameters: loFormSet
*!*************************************************************
*! Returns   : None
*!*************************************************************
FUNCTION LFVCLRAPR
PARAMETERS LOFORMSET

REPLACE APINVHDR.CCHKGLACC WITH LOFORMSET.ARIAFORM1.AP1.LCEMPTYACC
REPLACE APINVHDR.NINVDISAP WITH 0
REPLACE APINVHDR.NINVAMTAP WITH 0

REPLACE APINVHDR.NINVFAAP WITH 0

REPLACE APINVHDR.NINVA1099 WITH 0
REPLACE APINVHDR.NINVADJAP WITH 0

REPLACE APINVHDR.NAPREXRAT WITH 0
REPLACE APINVHDR.CAPRCURCOD WITH ''
REPLACE APINVHDR.NAPRCURUNT WITH 0

REPLACE APINVHDR.CBNKCODE WITH SPACE(8)
REPLACE APINVHDR.CCHKACCT WITH SPACE(12)

RETURN
*--end of lfvClrApr



*!*************************************************************
*! Name      : lfvCanPay
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 8/3/2004
*! Purpose   : Clicking Cancel button of the in the apAprov Screen
*!*************************************************************
*! Parameters: The FormSet
*!*************************************************************
*! Returns   : None
*!*************************************************************
FUNCTION LFVCANPAY
LPARAMETERS LOFORMSET
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*!*	IF loFormSet.AriaForm1.cboVendPmeth.Value <> 'H'  &&lower
IF LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.CBOVENDPMETH.VALUE <> 'H'  &&lower
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  REPLACE APINVHDR.CBNKCODE WITH LOFORMSET.LCBANKCODE
  REPLACE APINVHDR.CCHKACCT WITH LOFORMSET.LCCHECKACC
ENDIF
REPLACE APINVHDR.CCHKGLACC WITH IIF(!EMPTY(LOFORMSET.LCGLACOUNT),LOFORMSET.LCGLACOUNT, ;
  LOFORMSET.ARIAFORM1.AP1.LCEMPTYACC)
REPLACE APINVHDR.NINVAMTAP WITH LOFORMSET.LCAPPRPAY

REPLACE APINVHDR.NINVFAAP WITH LOFORMSET.LNFAAP

REPLACE APINVHDR.NINVDISAP WITH LOFORMSET.LCAPPRDIS
REPLACE APINVHDR.NINVA1099 WITH LOFORMSET.LC1099AMNT
REPLACE APINVHDR.NINVADJAP WITH LOFORMSET.LCAPPRADJ
*! E302623,3 MMT 01/03/2010 Convert Payable invoice screen to use SQL tables[Start]
*REPLACE apinvhdr.caprcurcod WITH lcAprCurr
REPLACE APINVHDR.CAPRCURCOD WITH LOFORMSET.LCAPRCURR
*! E302623,3 MMT 01/03/2010 Convert Payable invoice screen to use SQL tables[End]
REPLACE APINVHDR.NAPREXRAT WITH LOFORMSET.LNAPRRATE
REPLACE APINVHDR.NAPRCURUNT WITH LOFORMSET.LNAPRUNIT

*CLEAR READ

RETURN
*--end of lfvCanPay


*!*************************************************************
*! Name      : lfAprovRefresh
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 8/3/2004
*! Purpose   : Called from the Resfresh Event of the apAprov Screen
*!*************************************************************
*! Parameters: The FormSet, Reference to apAprov Form
*!*************************************************************
*! Returns   : None
*!*************************************************************
FUNCTION LFAPROVREFRESH
LPARAMETERS LOFORMSET, LOAPROV

IF LOFORMSET.ACTIVEMODE="V"
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *IF loFormSet.AriaForm1.cboVendPmeth.Value $ 'PMN'  &&lower
  IF LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.CBOVENDPMETH.VALUE $ 'PMN'  &&lower
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    *Old: SHOW GET apinvhdr.cbnkcode DISABLE  &&lower &&Revise
    *Old: SHOW GET ibBank     DISABLE &&Revise
    *Old: SHOW GET apinvhdr.cchkacct DISABLE  &&lower &&Revise
    *Old: SHOW GET ibChecks   DISABLE &&Revise
  ELSE
    *Old: SHOW GET ibAprCur   DISABLE &&Revise
  ENDIF

  *Old: SHOW GET apinvhdr.cchkglacc DISABLE  &&lower &&Revise
  *Old: SHOW GET ibGLAcc    DISABLE &&Revise
  *Old: SHOW GET apinvhdr.ninvdisap DISABLE  &&lower &&Revise
  *Old: SHOW GET apinvhdr.ninvamtap DISABLE  &&lower &&Revise
  *Old: SHOW GET apinvhdr.ninva1099 &loFormSet.lcData23St  &&lower &&Revise
  *Old: SHOW GET apinvhdr.ninvadjap DISABLE  &&lower &&Revise
  *Old: SHOW GET pbCancel   DISABLE &&Revise
  *Old: SHOW GET pbClrApr   DISABLE &&Revise
  *Old: SHOW GET apinvhdr.naprexrat DISABLE  &&lower &&Revise
  *Old: SHOW GET apinvhdr.caprcurcod DISABLE  &&lower &&Revise

  STORE .F. TO LOAPROV.BANKCHK.ENABLED, LOAPROV.GLCHKACTCODE.ENABLED, ;
    LOAPROV.TXTAPREXRAT.ENABLED,LOAPROV.TXTINVA1099.ENABLED, LOAPROV.TXTINVAMTAP.ENABLED, ;
    LOAPROV.TXTINVDISAP.ENABLED, LOAPROV.TXTINVADJAP.ENABLED, LOAPROV.CMDCLEARAPPROV.ENABLED, ;
    LOAPROV.CMDCANCEL.ENABLED


   *N000682,1 MMT 11/20/2012 Globalization Changes[Start]
   *  LOAPROV.CMDAPPROVE.CAPTION = '\<Ok'
   *N000682,1 11/20/2012 MMT Globlization changes[Start]
*LOAPROV.CMDAPPROVE.CAPTION =LANG_APPYINV_OK
LOAPROV.CMDAPPROVE.CAPTION =IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_OK,loFormSet.GetHeaderText("LANG_APPYINV_OK",loFormSet.HeaderAlias))
*N000682,1 11/20/2012 MMT Globlization changes[End]

   *N000682,1 MMT 11/20/2012 Globalization Changes[End]

ELSE

  *IF EMPTY(apinvhdr.cbnkcode)
  *Old: SHOW GET apinvhdr.cchkacct DISABLE      && Disable check account field
  *Old: SHOW GET ibChecks   DISABLE      && Disable check account browse push button
  *ENDIF
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	  IF loFormSet.AriaForm1.cboVendPmeth.Value = 'H' .AND. ;
  *!*	     apinvhdr.caprcurcod = loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value
  IF LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.CBOVENDPMETH.VALUE = 'H' .AND. ;
      APINVHDR.CAPRCURCOD = LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.KEYTEXTBOX.VALUE
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    *Old: SHOW GET apinvhdr.naprexrat DISABLE
    LOAPROV.TXTAPREXRAT.ENABLED = .F.
  ELSE
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *IF apinvhdr.caprcurcod = loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value
    IF APINVHDR.CAPRCURCOD = LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.KEYTEXTBOX.VALUE
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      *Old: SHOW GET apinvhdr.naprexrat DISABLE
      LOAPROV.TXTAPREXRAT.ENABLED = .F.
    ELSE
      *Old: SHOW GET apinvhdr.naprexrat ENABLE
      LOAPROV.TXTAPREXRAT.ENABLED = .T.
    ENDIF
  ENDIF
ENDIF

IF INLIST(LOFORMSET.ACTIVEMODE,"E","A")
  *_CUROBJ = OBJNUM(apinvhdr.ninvamtap)
  LOAPROV.TXTINVAMTAP.SETFOCUS()
ENDIF
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*IF loFormSet.AriaForm1.txtInvAmount.Value < 0
IF LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTINVAMOUNT.VALUE < 0
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  *Old: Show GET apinvhdr.ninvdisap DISABLE
  *Old: Show GET apinvhdr.ninvadjap DISABLE
  STORE .F. TO LOAPROV.TXTINVDISAP.ENABLED, LOAPROV.TXTINVADJAP.ENABLED
ENDIF

LOAPROV.TXTACTNAME.VALUE = IIF(LOFORMSET.ARIAFORM1.AP1.LLAPGLLINK,;
  ALLTRIM(LOOKUP(LCLINKCHAR.CACCNLDES,LOAPROV.GLCHKACTCODE.KEYTEXTBOX.VALUE,LCLINKCHAR.CACCTCODE,"ACCTCODE")),' ')


RETURN
*--end of lfAprovRefresh

***zzz***




***ddd***


*!*************************************************************
*! Name      : lfvDistrib
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 8/8/2004
*! Purpose   : Function called from the Click Event of the Distribution Lines Button
*!*************************************************************
*! Parameters: The FormSet
*!*************************************************************
*! Returns   : None
*!*************************************************************
FUNCTION LFVDISTRIB
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*LPARAMETERS loFormSet
PARAMETERS LOFORMSET
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
LLOPINVAD = .F.
*Old: IF loFormSet.ActiveMode="S" .OR. loFormSet.ActiveMode="V"
*Old: ON KEY LABEL ALT+N
*Old: ON KEY LABEL ALT+V
*Old: ELSE
*Old: ON KEY LABEL ALT+N DO LFVNEWLINE
*Old: ON KEY LABEL ALT+V DO LFVREMLINE
*Old: ENDIF
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*IF loFormSet.AriaForm1.cboVendPmeth.Value <> 'C' .AND. !EMPTY(apinvhdr.cvenccven)
IF LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.CBOVENDPMETH.VALUE <> 'C' .AND. !EMPTY(APINVHDR.CVENCCVEN)
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  ** MESSAGE : " This invoice is a credit card payment for "
  **           " vendor  invoice .                       "
  **           "                     Ok                  "
  =GFMODALGEN("TRM04034B00000","DIALOG",ALLTRIM(APINVHDR.CVENCCVEN)+"|"+ALLTRIM(APINVHDR.CVENCCINV))
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *RETURN
  LOFORMSET.ARIAFORM1.PGFPAYINV.ACTIVEPAGE = 1
  RETURN .F.
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
ELSE
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *  llOpInvad= gfOpenFile(oAriaApplication.DataDir+'APINVADT','DTYPCOD','SH')  &&lower
  LLOPINVAD= GFOPENTABLE('APINVADT','DTYPCOD','SH')  &&lower
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  IF INLIST(LOFORMSET.ACTIVEMODE,"A","E")

    SELECT(LOFORMSET.LCTMPDIST)
    IF LOFORMSET.ACTIVEMODE="A"
      IF RECCOUNT() = 0
        SELECT(LOFORMSET.LCTMPDIST)

        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        *!*	        REPLACE apinvhdr.capacct WITH ;
        *!*	          IIF(!EMPTY(APVENDOR.cAPAcct) , APVENDOR.cAPAcct ,;
        *!*	               IIF(SEEK(loFormSet.AriaForm1.cboDivision.Value , 'APDIV') .AND.;
        *!*	                   !EMPTY(APDIV.cAPAcct) , APDIV.cAPAcct ,APSETUP.cAPAcct)) IN apinvhdr
        *loFormSet.DistLines.glAPActCode.KeyTextBox.Value = apinvhdr.capacct
        SELECT APINVHDR
        GFREPLACE("capacct WITH '"+;
          IIF(!EMPTY(APVENDOR.CAPACCT) , APVENDOR.CAPACCT ,;
          IIF(GFSEEK(LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.CBODIVISION.VALUE , 'APDIV') .AND.;
          !EMPTY(APDIV.CAPACCT) , APDIV.CAPACCT ,APSETUP.CAPACCT)) +"'")
        SELECT(LOFORMSET.LCTMPDIST)

        LOFORMSET.ARIAFORM1.PGFPAYINV.PGDIST.GLAPACTCODE.KEYTEXTBOX.VALUE = APINVHDR.CAPACCT
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
        APPEND BLANK
        =GFADD_INFO(LOFORMSET.LCTMPDIST)
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        *!*	        REPLACE CVENDCODE WITH loFormSet.AriaForm1.KBVendCode.KeyTextBox.Value  ,;
        *!*	                CINVNO    WITH loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value  ,;
        *!*	                DAPDTRDAT WITH loFormSet.AriaForm1.DtPostDate.Value ,;
        *!*	                LAPDPOST  WITH .F.        ,;
        *!*	                CAPDGLACT WITH loFormSet.DistLines.glAPActCode.KeyTextBox.Value ,;
        *!*	                NAPDAMNT  WITH -loFormSet.AriaForm1.txtInvAmount.Value,;
        *!*	                CAPDACTID WITH 'A'        ,;
        *!*	                CAPDREF   WITH loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value  ,;
        *!*	                CFISFYEAR WITH loFormSet.lcDistYer  ,;
        *!*	                CFSPPRDID WITH loFormSet.lcDistPrd  ,;
        *!*	                CAPSESSNO WITH loFormSet.lcSequence ,;
        *!*	                CAPDTRTYP WITH 'I'        ,;
        *!*	                CSTATUS   WITH 'A'
        REPLACE CVENDCODE WITH LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE  ,;
          CINVNO    WITH LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE  ,;
          DAPDTRDAT WITH LOFORMSET.ARIAFORM1.DTPOSTDATE.VALUE ,;
          LAPDPOST  WITH .F.        ,;
          CAPDGLACT WITH LOFORMSET.ARIAFORM1.PGFPAYINV.PGDIST.GLAPACTCODE.KEYTEXTBOX.VALUE ,;
          NAPDAMNT  WITH -LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTINVAMOUNT.VALUE,;
          CAPDACTID WITH 'A'        ,;
          CAPDREF   WITH LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE  ,;
          CFISFYEAR WITH LOFORMSET.LCDISTYER  ,;
          CFSPPRDID WITH LOFORMSET.LCDISTPRD  ,;
          CAPSESSNO WITH LOFORMSET.LCSEQUENCE ,;
          CAPDTRTYP WITH 'I'        ,;
          CSTATUS   WITH 'A'
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      ELSE
        SELECT(LOFORMSET.LCTMPDIST)
        LOCATE FOR CAPDACTID = 'A'
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        *REPLACE NAPDAMNT WITH -loFormSet.AriaForm1.txtInvAmount.Value
        REPLACE NAPDAMNT WITH -LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTINVAMOUNT.VALUE
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[END]
        =GFADD_INFO(LOFORMSET.LCTMPDIST)
      ENDIF
    ENDIF
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *!*	    IF loFormSet.ActiveMode="E" AND TYPE('loFormSet.AriaForm1.txtInvAmount.OldValue')='N' ;
    *!*	      AND loFormSet.AriaForm1.txtInvAmount.Value <> loFormSet.AriaForm1.txtInvAmount.OldValue
    IF LOFORMSET.ACTIVEMODE="E" AND TYPE('loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.OldValue')='N' ;
        AND LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTINVAMOUNT.VALUE <> LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTINVAMOUNT.OLDVALUE
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      LOCATE FOR CAPDACTID = 'A' .AND. EMPTY(CAPDSTAT)
      LNSAVAPREC = RECNO()
      IF CSTATUS = 'A'
        SCATTER MEMVAR MEMO
        m.CSTATUS  = 'A'
        m.CAPDSTAT = ' '
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        *m.nApdAmnt = -loFormSet.AriaForm1.txtInvAmount.Value
        m.NAPDAMNT = -LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTINVAMOUNT.VALUE
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
        m.LAPDPOST = .F.
        m.CBATCHNO = ' '
        m.CTRNSLEDN= ' '
        m.CAPSESSNO= LOFORMSET.LCSEQUENCE
        m.NENTRYNO = 0
        GATHER MEMVAR MEMO
      ELSE
        REPLACE CAPDSTAT  WITH 'V'        ,;
          CAPSESSNO WITH LOFORMSET.LCSEQUENCE ,;
          CSTATUS   WITH 'M'
        SCATTER MEMVAR MEMO
        m.NAPDAMNT = -1 * m.NAPDAMNT
        m.CSTATUS  = 'A'
        m.LAPDPOST = .F.
        m.CBATCHNO = ' '
        m.CTRNSLEDN= ' '
        m.NEQVAMNT = -1 * m.NEQVAMNT
        m.NENTRYNO = 0
        APPEND BLANK
        =GFADD_INFO(LOFORMSET.LCTMPDIST)
        GATHER MEMVAR MEMO
        IF BETWEEN(LNSAVAPREC,0,RECCOUNT())
          GO LNSAVAPREC
        ENDIF
        SCATTER MEMVAR MEMO
        m.CSTATUS  = 'A'
        m.CAPDSTAT = ' '
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        *m.nApdAmnt = -loFormSet.AriaForm1.txtInvAmount.Value
        m.NAPDAMNT = -LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTINVAMOUNT.VALUE
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
        m.LAPDPOST = .F.
        m.CBATCHNO = ' '
        m.CTRNSLEDN= ' '
        m.CAPSESSNO= LOFORMSET.LCSEQUENCE
        m.NENTRYNO = 0
        APPEND BLANK
        =GFADD_INFO(LOFORMSET.LCTMPDIST)
        GATHER MEMVAR MEMO
      ENDIF
    ENDIF
    SELECT(LOFORMSET.LCTMPDIST)
    GO TOP
    IF !EOF()
      SKIP 1
    ENDIF
    DO CASE
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *CASE !EMPTY(loFormSet.AriaForm1.kbAutmCode.KeyTextBox.Value) .AND. loFormSet.lnLineNo = 0
    CASE !EMPTY(LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBAUTMCODE.KEYTEXTBOX.VALUE) .AND. LOFORMSET.LNLINENO = 0
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      SELECT APINVADT
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *!*	        IF SEEK('T'+loFormSet.AriaForm1.kbAutmCode.KeyTextBox.Value)
      *!*	          SCAN REST WHILE CAUTMTYPE+CAUTMCODE = 'T'+loFormSet.AriaForm1.kbAutmCode.KeyTextBox.Value
      IF SEEK('T'+LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBAUTMCODE.KEYTEXTBOX.VALUE)
        SCAN REST WHILE CAUTMTYPE+CAUTMCODE = 'T'+LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBAUTMCODE.KEYTEXTBOX.VALUE
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
          IF LOFORMSET.ARIAFORM1.AP1.LLAPGLLINK
            IF !SEEK(APINVADT.CAPDGLACT,'lcLinkChar')
              *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
              *=gfModalGen("TRM04110B00000","DIALOG",ALLTRIM(loFormSet.AriaForm1.kbAutmCode.KeyTextBox.Value)+'|'+ALLTRIM(APINVADT.CAPDGLACT))
              =GFMODALGEN("TRM04110B00000","DIALOG",ALLTRIM(LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBAUTMCODE.KEYTEXTBOX.VALUE)+'|'+ALLTRIM(APINVADT.CAPDGLACT))
              *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[ENd]
              SELECT(LOFORMSET.LCTMPDIST)
              SCAN
                IF CAPDACTID <> 'A'
                  REPLACE CSTATUS WITH 'S'
                  DELETE
                ENDIF
              ENDSCAN
              SELECT APINVHDR
              LOFORMSET.LCTMPLATE = 'ENABLE'
              *_CUROBJ = OBJNUM(loFormSet.AriaForm1.kbAutmCode.KeyTextBox.Value)
              *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
              *loFormSet.AriaForm1.kbAutmCode.KeyTextBox.SetFocus()
              LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBAUTMCODE.KEYTEXTBOX.SETFOCUS()
              *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
              RETURN
            ELSE
              SELECT(LOFORMSET.LCTMPDIST)
              *** Add the distribution account. ***
              APPEND BLANK
              =GFADD_INFO(LOFORMSET.LCTMPDIST)
              *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
              *!*	                REPLACE CVENDCODE WITH loFormSet.AriaForm1.KBVendCode.KeyTextBox.Value  ,;
              *!*	                        CINVNO    WITH loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value  ,;
              *!*	                        DAPDTRDAT WITH loFormSet.AriaForm1.DtPostDate.Value ,;
              *!*	                        LAPDPOST  WITH .F.        ,;
              *!*	                        CAPDREF   WITH loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value  ,;
              *!*	                        CAPDACTID WITH 'D'        ,;
              *!*	                        CFISFYEAR WITH loFormSet.lcDistYer  ,;
              *!*	                        CFSPPRDID WITH loFormSet.lcDistPrd  ,;
              *!*	                        CAPSESSNO WITH loFormSet.lcSequence ,;
              *!*	                        CAPDTRTYP WITH 'I'        ,;
              *!*	                        CSTATUS   WITH 'A'        ,;
              *!*	                        NAPDLINNO WITH lfvLineNo(loFormSet),;
              *!*	                        CTAXCODE  WITH APINVADT.CTAXCODE,;
              *!*	                        CAPDGLACT WITH APINVADT.CAPDGLACT,;
              *!*	                        NAPDAMNT  WITH APINVADT.NAPDAMNT * loFormSet.AriaForm1.txtInvAmount.Value / 100
              REPLACE CVENDCODE WITH LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE  ,;
                CINVNO    WITH LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE  ,;
                DAPDTRDAT WITH LOFORMSET.ARIAFORM1.DTPOSTDATE.VALUE ,;
                LAPDPOST  WITH .F.        ,;
                CAPDREF   WITH LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE  ,;
                CAPDACTID WITH 'D'        ,;
                CFISFYEAR WITH LOFORMSET.LCDISTYER  ,;
                CFSPPRDID WITH LOFORMSET.LCDISTPRD  ,;
                CAPSESSNO WITH LOFORMSET.LCSEQUENCE ,;
                CAPDTRTYP WITH 'I'        ,;
                CSTATUS   WITH 'A'        ,;
                NAPDLINNO WITH LFVLINENO(LOFORMSET),;
                CTAXCODE  WITH APINVADT.CTAXCODE,;
                CAPDGLACT WITH APINVADT.CAPDGLACT,;
                NAPDAMNT  WITH APINVADT.NAPDAMNT * LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTINVAMOUNT.VALUE / 100
              *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

              LOFORMSET.LNDISTAMNT = LOFORMSET.LNDISTAMNT + NAPDAMNT
            ENDIF
          ELSE
            SELECT(LOFORMSET.LCTMPDIST)
            *** Add the distribution account. ***
            APPEND BLANK
            =GFADD_INFO(LOFORMSET.LCTMPDIST)
            *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
            *!*	              REPLACE CVENDCODE WITH loFormSet.AriaForm1.KBVendCode.KeyTextBox.Value  ,;
            *!*	                      CINVNO    WITH loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value  ,;
            *!*	                      DAPDTRDAT WITH loFormSet.AriaForm1.DtPostDate.Value ,;
            *!*	                      LAPDPOST  WITH .F.        ,;
            *!*	                      CAPDREF   WITH loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value  ,;
            *!*	                      CAPDACTID WITH 'D'        ,;
            *!*	                      CFISFYEAR WITH loFormSet.lcDistYer  ,;
            *!*	                      CFSPPRDID WITH loFormSet.lcDistPrd  ,;
            *!*	                      CAPSESSNO WITH loFormSet.lcSequence ,;
            *!*	                      CAPDTRTYP WITH 'I'        ,;
            *!*	                      CSTATUS   WITH 'A'        ,;
            *!*	                      NAPDLINNO WITH lfvLineNo(loFormSet),;
            *!*	                      CTAXCODE  WITH APINVADT.CTAXCODE,;
            *!*	                      CAPDGLACT WITH APINVADT.CAPDGLACT,;
            *!*	                      NAPDAMNT  WITH APINVADT.NAPDAMNT * loFormSet.AriaForm1.txtInvAmount.Value / 100
            REPLACE CVENDCODE WITH LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE  ,;
              CINVNO    WITH LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE  ,;
              DAPDTRDAT WITH LOFORMSET.ARIAFORM1.DTPOSTDATE.VALUE ,;
              LAPDPOST  WITH .F.        ,;
              CAPDREF   WITH LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE  ,;
              CAPDACTID WITH 'D'        ,;
              CFISFYEAR WITH LOFORMSET.LCDISTYER  ,;
              CFSPPRDID WITH LOFORMSET.LCDISTPRD  ,;
              CAPSESSNO WITH LOFORMSET.LCSEQUENCE ,;
              CAPDTRTYP WITH 'I'        ,;
              CSTATUS   WITH 'A'        ,;
              NAPDLINNO WITH LFVLINENO(LOFORMSET),;
              CTAXCODE  WITH APINVADT.CTAXCODE,;
              CAPDGLACT WITH APINVADT.CAPDGLACT,;
              NAPDAMNT  WITH APINVADT.NAPDAMNT * LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTINVAMOUNT.VALUE / 100
            *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
            LOFORMSET.LNDISTAMNT = LOFORMSET.LNDISTAMNT + NAPDAMNT
          ENDIF
          SELECT APINVADT
        ENDSCAN
      ENDIF
    CASE LOFORMSET.ACTIVEMODE="A" .AND. RECCOUNT(LOFORMSET.LCTMPDIST) = 1 AND EMPTY(LOFORMSET.LCVENINVTYPES)
      SELECT(LOFORMSET.LCTMPDIST)

      *B602946,1 Add this line to get the default Expense Account [Begin]
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *!*	        *loFormSet.lcDistAcct = IIF(!EMPTY(APVENDOR.cExpAcct) , APVENDOR.cExpAcct ,;
      *!*	                         IIF(SEEK(loFormSet.AriaForm1.cboDivision.Value , 'APDIV') .AND.;
      *!*	                             !EMPTY(APDIV.cExpAcct) , APDIV.cExpAcct ,;
      *!*	                             APSETUP.cExpAcct))
      LOFORMSET.LCDISTACCT = IIF(!EMPTY(APVENDOR.CEXPACCT) , APVENDOR.CEXPACCT ,;
        IIF(GFSEEK(LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.CBODIVISION.VALUE , 'APDIV') .AND.;
        !EMPTY(APDIV.CEXPACCT) , APDIV.CEXPACCT ,;
        APSETUP.CEXPACCT))
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      *B602946,1 Add this line to get the default Expense Account [End]

      *** Add the distribution account. ***
      APPEND BLANK
      =GFADD_INFO(LOFORMSET.LCTMPDIST)
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *!*	        REPLACE CVENDCODE WITH loFormSet.AriaForm1.KBVendCode.KeyTextBox.Value  ,;
      *!*	                CINVNO    WITH loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value  ,;
      *!*	                DAPDTRDAT WITH loFormSet.AriaForm1.DtPostDate.Value ,;
      *!*	                LAPDPOST  WITH .F.        ,;
      *!*	                CAPDGLACT WITH loFormSet.lcDistAcct ,;
      *!*	                NAPDAMNT  WITH loFormSet.AriaForm1.txtInvAmount.Value ,;
      *!*	                CAPDREF   WITH loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value  ,;
      *!*	                CAPDACTID WITH 'D'        ,;
      *!*	                CFISFYEAR WITH loFormSet.lcDistYer  ,;
      *!*	                CFSPPRDID WITH loFormSet.lcDistPrd  ,;
      *!*	                CAPSESSNO WITH loFormSet.lcSequence ,;
      *!*	                CAPDTRTYP WITH 'I'        ,;
      *!*	                CSTATUS   WITH 'A'        ,;
      *!*	                NAPDLINNO WITH lfvLineNo(loFormSet)
      REPLACE CVENDCODE WITH LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE  ,;
        CINVNO    WITH LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE  ,;
        DAPDTRDAT WITH LOFORMSET.ARIAFORM1.DTPOSTDATE.VALUE ,;
        LAPDPOST  WITH .F.        ,;
        CAPDGLACT WITH LOFORMSET.LCDISTACCT ,;
        NAPDAMNT  WITH LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTINVAMOUNT.VALUE ,;
        CAPDREF   WITH LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE  ,;
        CAPDACTID WITH 'D'        ,;
        CFISFYEAR WITH LOFORMSET.LCDISTYER  ,;
        CFSPPRDID WITH LOFORMSET.LCDISTPRD  ,;
        CAPSESSNO WITH LOFORMSET.LCSEQUENCE ,;
        CAPDTRTYP WITH 'I'        ,;
        CSTATUS   WITH 'A'        ,;
        NAPDLINNO WITH LFVLINENO(LOFORMSET)
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      LOFORMSET.LNDISTAMNT = LOFORMSET.LNDISTAMNT + NAPDAMNT
    ENDCASE
    SELECT(LOFORMSET.LCTMPDIST)
    GO TOP
    IF !EOF()
      SKIP 1
    ENDIF
    *E300798,1 Disable Editing Distribution lines created for invoice lines
    IF LOFORMSET.LLLOKPER OR !EMPTY(LOFORMSET.LCVENINVTYPES)
      LOFORMSET.LLNEWSTAT  = .F.
      *Old: SHOW GET pbNew    DISABLE &&Revise
      *Old: SHOW GET pbRemove DISABLE &&Revise
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *!*	      loFormSet.DistLines.cmdNew.Enabled = .F.
      *!*	      loFormSet.DistLines.cmdRemove.Enabled = .F.
      LOFORMSET.ARIAFORM1.PGFPAYINV.PGDIST.CMDNEW.ENABLED = .F.
      LOFORMSET.ARIAFORM1.PGFPAYINV.PGDIST.CMDREMOVE.ENABLED = .F.
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    ENDIF
    IF LOFORMSET.LLLOKPER
      *Old: SHOW GET loFormSet.DistLines.glAPActCode.KeyTextBox.Value DISABLE  &&lower &&Revise
      *Old: SHOW GET ibApAcc    DISABLE &&Revise
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *loFormSet.DistLines.glAPActCode.Enabled = .F.
      LOFORMSET.ARIAFORM1.PGFPAYINV.PGDIST.GLAPACTCODE.ENABLED = .F.
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    ENDIF
  ELSE
    SELECT APINVHDR
    IF !EOF()
      GO RECNO()
    ENDIF
    SELECT APDIST
    LOFORMSET.LLNEWSTAT = .F.
    *Old: SHOW GET pbNew      DISABLE &&Revise
    *Old: SHOW GET pbRemove   DISABLE &&Revise
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *!*	    loFormSet.DistLines.cmdNew.Enabled = .F.
    *!*	    loFormSet.DistLines.cmdRemove.Enabled = .F.
    *!*	    *Old: SHOW GET loFormSet.DistLines.glAPActCode.KeyTextBox.Value DISABLE  &&lower &&Revise
    *!*	    *Old: SHOW GET ibApAcc    DISABLE &&Revise
    *!*	    loFormSet.DistLines.glAPActCode.Enabled = .F.
    LOFORMSET.ARIAFORM1.PGFPAYINV.PGDIST.CMDNEW.ENABLED = .F.
    LOFORMSET.ARIAFORM1.PGFPAYINV.PGDIST.CMDREMOVE.ENABLED = .F.
    *Old: SHOW GET loFormSet.DistLines.glAPActCode.KeyTextBox.Value DISABLE  &&lower &&Revise
    *Old: SHOW GET ibApAcc    DISABLE &&Revise
    LOFORMSET.ARIAFORM1.PGFPAYINV.PGDIST.GLAPACTCODE.ENABLED = .F.
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  ENDIF
  *Old: RELEASE WINDOW (loFormSet.lcBrowsTtl)
  LOFORMSET.LCTMPLATE = 'DISABLE'
  *Old: SHOW GET loFormSet.AriaForm1.kbAutmCode.KeyTextBox.Value DISABLE  &&lower &&Revise
  *Old: SHOW GET ibTemplate DISABLE &&Revise
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *loFormSet.AriaForm1.kbAutmCode.Enabled =.F.
  LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBAUTMCODE.ENABLED =.F.
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  *Old: loFormSet.lcCodeFilt = ''
  =LFDISPOBJCT(LOFORMSET)
  =LFBROWSE(LOFORMSET)
  *Old: =lfRefresh()
  *Old: =gfActWind('CWRAPDISTR',loFormSet.lcTChldTitl,gcBaseWind)
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *loFormSet.DistLines.Show()
  LOFORMSET.ARIAFORM1.PGFPAYINV.PGDIST.ENABLED = .T.
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
ENDIF
IF USED('APINVADT') .AND. LLOPINVAD
  *Old: =gfCloseFile('APINVADT')
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *USE IN APINVADT
  =GFCLOSETABLE('APINVADT')
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
ENDIF

RETURN
*--end of lfvDistrib



*!*************************************************************
*! Name      : lfvApAccount
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 8/8/2004
*! Purpose   : To validate the AP account in the Ditribution Lines screen
*!*************************************************************
*! Parameters: The FormSet
*!*************************************************************
*! Returns   : None
*!**************************************************************
FUNCTION LFVAPACCOUNT
LPARAMETERS LOFORMSET
LOCAL LCFILT

*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*!*	IF loFormSet.DistLines.glAPActCode.SelectedFromBrowse OR ;
*!*	  loFormSet.DistLines.glAPActCode.KeyTextBox.OldValue<>loFormSet.DistLines.glAPActCode.KeyTextBox.Value
*!*	  IF EMPTY(STRTRAN(STRTRAN(loFormSet.DistLines.glAPActCode.KeyTextBox.Value,'-'),'0'))
*!*	    loFormSet.DistLines.glAPActCode.KeyTextBox.Value = ;
*!*	      loFormSet.DistLines.glAPActCode.KeyTextBox.OldValue
IF LOFORMSET.ARIAFORM1.PGFPAYINV.PGDIST.GLAPACTCODE.SELECTEDFROMBROWSE OR ;
    LOFORMSET.ARIAFORM1.PGFPAYINV.PGDIST.GLAPACTCODE.KEYTEXTBOX.OLDVALUE<>LOFORMSET.ARIAFORM1.PGFPAYINV.PGDIST.GLAPACTCODE.KEYTEXTBOX.VALUE
  IF EMPTY(STRTRAN(STRTRAN(LOFORMSET.ARIAFORM1.PGFPAYINV.PGDIST.GLAPACTCODE.KEYTEXTBOX.VALUE,'-'),'0'))
    LOFORMSET.ARIAFORM1.PGFPAYINV.PGDIST.GLAPACTCODE.KEYTEXTBOX.VALUE = ;
      LOFORMSET.ARIAFORM1.PGFPAYINV.PGDIST.GLAPACTCODE.KEYTEXTBOX.OLDVALUE
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  ELSE
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *!*	    IF loFormSet.DistLines.glAPActCode.KeyTextBox.OldValue <> ;
    *!*	      loFormSet.DistLines.glAPActCode.KeyTextBox.Value
    IF LOFORMSET.ARIAFORM1.PGFPAYINV.PGDIST.GLAPACTCODE.KEYTEXTBOX.OLDVALUE <> ;
        LOFORMSET.ARIAFORM1.PGFPAYINV.PGDIST.GLAPACTCODE.KEYTEXTBOX.VALUE
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      IF (APINVHDR.NINVPAID+APINVHDR.NINVDISTK+APINVHDR.NINVADJ) > 0
        ** MESSAGE : " This invoice is  paid.  You have "
        **           " to make an adjustment entry in GL "
        **           " to clear the old AP account.      "
        **           "                 Ok              "
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        *=gfModalGen('QRM04039B00000','Dialog',IIF(apinvhdr.ninvpaid+apinvhdr.ninvdistk+apinvhdr.ninvadj = loFormSet.AriaForm1.txtInvAmount.Value,loFormSet.lcTFully,loFormSet.lcTPart))
        =GFMODALGEN('QRM04039B00000','Dialog',IIF(APINVHDR.NINVPAID+APINVHDR.NINVDISTK+APINVHDR.NINVADJ = LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTINVAMOUNT.VALUE,LOFORMSET.LCTFULLY,LOFORMSET.LCTPART))
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[END]
      ENDIF


      SELECT(LOFORMSET.LCTMPDIST)
      LCFILT = FILTER()
      SET FILTER TO
      LNSAVRECNO = RECNO()
      LOCATE FOR CAPDACTID = 'A'
      LNSAVAPREC = RECNO()
      IF LOFORMSET.ACTIVEMODE="A"
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        *REPLACE CAPDGLACT WITH loFormSet.DistLines.glAPActCode.KeyTextBox.Value
        REPLACE CAPDGLACT WITH LOFORMSET.ARIAFORM1.PGFPAYINV.PGDIST.GLAPACTCODE.KEYTEXTBOX.VALUE
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[END]
        =GFADD_INFO(LOFORMSET.LCTMPDIST)
        IF BETWEEN(LNSAVRECNO,0,RECCOUNT())
          GO LNSAVRECNO
        ENDIF
      ELSE
        IF CSTATUS = 'S' .AND. UPDATED() && IF the record is modified.
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
          *=lfvUpdTemp(loFormSet,'capdglact',loFormSet.DistLines.glAPActCode.KeyTextBox.OldValue)
          =LFVUPDTEMP(LOFORMSET,'capdglact',LOFORMSET.ARIAFORM1.PGFPAYINV.PGDIST.GLAPACTCODE.KEYTEXTBOX.OLDVALUE)
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[END]
          IF BETWEEN(LNSAVAPREC,0,RECCOUNT())
            GO LNSAVAPREC
          ENDIF
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
          *!*	          REPLACE CAPDGLACT WITH loFormSet.DistLines.glAPActCode.KeyTextBox.Value ,;
          *!*	                  CSTATUS   WITH 'M'        ,;
          *!*	                  LAPDPOST  WITH .F.        ,;
          *!*	                  CBATCHNO  WITH ' '        ,;
          *!*	                  CTRNSLEDN WITH ' '        ,;
          *!*	                  CAPSESSNO WITH loFormSet.lcSequence ,;
          *!*	                  CUPDSERNO WITH ' '        ,;
          *!*	                  nEntryNo  WITH 0
          REPLACE CAPDGLACT WITH LOFORMSET.ARIAFORM1.PGFPAYINV.PGDIST.GLAPACTCODE.KEYTEXTBOX.VALUE ,;
            CSTATUS   WITH 'M'        ,;
            LAPDPOST  WITH .F.        ,;
            CBATCHNO  WITH ' '        ,;
            CTRNSLEDN WITH ' '        ,;
            CAPSESSNO WITH LOFORMSET.LCSEQUENCE ,;
            CUPDSERNO WITH ' '        ,;
            NENTRYNO  WITH 0
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[END]
          =GFADD_INFO(LOFORMSET.LCTMPDIST)
          IF BETWEEN(LNSAVRECNO,0,RECCOUNT())
            GO LNSAVRECNO
          ENDIF
        ENDIF
      ENDIF
      IF BETWEEN(LNSAVRECNO,0,RECCOUNT())
        GO LNSAVRECNO
      ENDIF
    ENDIF
  ENDIF
ENDIF

*Old: SHOW GET loFormSet.DistLines.glAPActCode.KeyTextBox.Value  &&lower &&Revise
SELECT(LOFORMSET.LCTMPDIST)
IF !EMPTY(LCFILT)
  SET FILTER TO &LCFILT
ENDIF

*Old: =lfvTrapKey()
LFDISTREFRESH(LOFORMSET)
*Old: IF SUBSTR(gcBaseWind,4,LEN(gcBaseWind)) = loFormSet.lcActProg
*Old: =lfRefresh()
*Old: ENDIF

RETURN
*--end of lfvApAccount


*!*************************************************************
*! Name      : lfvLineNo
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 8/8/2004
*! Purpose   : To Increment the Line No. in the Ditribution Lines screen
*!*************************************************************
*! Parameters: The FormSet
*!*************************************************************
*! Returns   : None
*!**************************************************************
FUNCTION LFVLINENO
LPARAMETERS LOFORMSET

LOFORMSET.LNLINENO = LOFORMSET.LNLINENO + 1

RETURN LOFORMSET.LNLINENO
*--end of lfvLineNo


*!*************************************************************
*! Name      : lfvTaxCode
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 8/8/2004
*! Purpose   : To validate the Tax Code Control in the Ditribution Lines screen
*!*************************************************************
*! Parameters: The FormSet
*!*************************************************************
*! Returns   : None
*!**************************************************************
FUNCTION LFVTAXCODE
LPARAMETERS LOFORMSET
LOCAL LCFILT


PRIVATE LCOLDTAX, LCOLDACCT

*Old: lcOldTax  = &loFormSet.lcTmpDist..cTaxCode
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*!*	lcOldTax  = loFormSet.DistLines.cboTaxCode.OldValue
*!*	*Old: lcOldAcct = &loFormSet.lcTmpDist..cApDGlAct
*!*	lcOldAcct = loFormSet.DistLines.glActCode.KeyTextbox.OldValue
*!*	*Old: puTax     = CODES.cdiscrep

*!*	*! B608045,1 MMT 04/16/2007 fix bug or wrong record in grid after selecting GL account[Start]
*!*	*puTax = loFormSet.DistLines.cboTaxCode.Text
*!*	puTax = loFormSet.DistLines.cboTaxCode.DisplayValue
*!*	*! B608045,1 MMT 04/16/2007 fix bug or wrong record in grid after selecting GL account[End]

*!*	*Old: loFormSet.lcTaxCode = CODES.cCode_No
*!*	loFormSet.lcTaxCode = loFormSet.DistLines.cboTaxCode.Value
LCOLDTAX  = LOFORMSET.ARIAFORM1.PGFPAYINV.PGDIST.CBOTAXCODE.OLDVALUE
*Old: lcOldAcct = &loFormSet.lcTmpDist..cApDGlAct
LCOLDACCT = LOFORMSET.ARIAFORM1.PGFPAYINV.PGDIST.GLACTCODE.KEYTEXTBOX.OLDVALUE
*Old: puTax     = CODES.cdiscrep
*puTax = loFormSet.DistLines.cboTaxCode.Text
PUTAX = LOFORMSET.ARIAFORM1.PGFPAYINV.PGDIST.CBOTAXCODE.DISPLAYVALUE
*Old: loFormSet.lcTaxCode = CODES.cCode_No
LOFORMSET.LCTAXCODE = LOFORMSET.ARIAFORM1.PGFPAYINV.PGDIST.CBOTAXCODE.VALUE
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[END]

*Old: SHOW GET puTax &&Revise
LOFORMSET.LCCODEFILT = ''

*IF LASTKEY() = 13 OR LASTKEY() = 32
IF LASTKEY()<>27
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *IF !EMPTY(loFormSet.DistLines.cboTaxCode.Value)
  IF !EMPTY(LOFORMSET.ARIAFORM1.PGFPAYINV.PGDIST.CBOTAXCODE.VALUE)
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    DIMENSION LATAXARY[ALEN(loFormSet.laTaxAry,1),ALEN(loFormSet.laTaxAry,2)]
    =ACOPY(LOFORMSET.LATAXARY,LATAXARY)
    =GFRLTFLD(LOFORMSET.LCTAXCODE , @LATAXARY , 'CTAXCODE')
    =ACOPY(LATAXARY,LOFORMSET.LATAXARY)
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *!*	    loFormSet.DistLines.glActCode.KeyTextbox.Value = ;
    *!*	      IIF(!EMPTY(STRTRAN(STRTRAN(loFormSet.DistLines.glActCode.KeyTextbox.Value,'-'),'0')),;
    *!*	           loFormSet.DistLines.glActCode.KeyTextbox.Value,loFormSet.AriaForm1.ap1.lcemptyacc)
    LOFORMSET.ARIAFORM1.PGFPAYINV.PGDIST.GLACTCODE.KEYTEXTBOX.VALUE = ;
      IIF(!EMPTY(STRTRAN(STRTRAN(LOFORMSET.ARIAFORM1.PGFPAYINV.PGDIST.GLACTCODE.KEYTEXTBOX.VALUE,'-'),'0')),;
      LOFORMSET.ARIAFORM1.PGFPAYINV.PGDIST.GLACTCODE.KEYTEXTBOX.VALUE,LOFORMSET.ARIAFORM1.AP1.LCEMPTYACC)
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    ** If there is a G/L link, validate the G/L input account,
    ** from the chart of accounts.
    ** If it is not found, present the following message and
    ** reset tax code to N/A.

    ** Message :    "    G/L input account   for tax code      "
    **              "    is not found in the chart of accounts.  "
    **              "    You cannot select this tax code.        "

    *! B608045,1 MMT 04/16/2007 fix bug or wrong record in grid after selecting GL account[Start]
    *IF loFormSet.AriaForm1.ap1.llApGlLink .AND. ;
    !SEEK(loFormSet.DistLines.glActCode.KeyTextbox.Value, 'lcLinkChar')
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *!*	    IF loFormSet.AriaForm1.ap1.llApGlLink .AND. ;
    *!*	      !SEEK(ALLTRIM(loFormSet.DistLines.glActCode.KeyTextbox.Value), 'lcLinkChar')
    IF LOFORMSET.ARIAFORM1.AP1.LLAPGLLINK .AND. ;
        !SEEK(ALLTRIM(LOFORMSET.ARIAFORM1.PGFPAYINV.PGDIST.GLACTCODE.KEYTEXTBOX.VALUE), 'lcLinkChar')
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      *! B608045,1 MMT 04/16/2007 fix bug or wrong record in grid after selecting GL account[End]

      *! B608045,1 MMT 04/16/2007 fix bug or wrong record in grid after selecting GL account[Start]
      *loFormSet.lcTaxDesMs = puTax
      *=gfModalGen("TRM04091B00000","DIALOG",;
      ALLTRIM(loFormSet.DistLines.glActCode.KeyTextbox.Value)+'|'+;
      ALLTRIM(loFormSet.lcTaxDesMs))
      LOFORMSET.LCTAXDES = PUTAX
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *!*	      =gfModalGen("TRM04091B00000","DIALOG",;
      *!*	        ALLTRIM(loFormSet.DistLines.glActCode.KeyTextbox.Value)+'|'+;
      *!*	        ALLTRIM(loFormSet.lcTaxDes))
      =GFMODALGEN("TRM04091B00000","DIALOG",;
        ALLTRIM(LOFORMSET.ARIAFORM1.PGFPAYINV.PGDIST.GLACTCODE.KEYTEXTBOX.VALUE)+'|'+;
        ALLTRIM(LOFORMSET.LCTAXDES))
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      *! B608045,1 MMT 04/16/2007 fix bug or wrong record in grid after selecting GL account[End]
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *!*	      IF loFormSet.DistLines.cboTaxCode.Value <> lcOldTax
      *!*	        loFormSet.DistLines.cboTaxCode.Value  = lcOldTax
      *!*	        loFormSet.DistLines.glActCode.KeyTextbox.Value = lcOldAcct
      *!*	        loFormSet.lcTaxDes   = gfCodDes(loFormSet.DistLines.cboTaxCode.Value , 'CTAXCODE')
      IF LOFORMSET.ARIAFORM1.PGFPAYINV.PGDIST.CBOTAXCODE.VALUE <> LCOLDTAX
        LOFORMSET.ARIAFORM1.PGFPAYINV.PGDIST.CBOTAXCODE.VALUE  = LCOLDTAX
        LOFORMSET.ARIAFORM1.PGFPAYINV.PGDIST.GLACTCODE.KEYTEXTBOX.VALUE = LCOLDACCT
        LOFORMSET.LCTAXDES   = GFCODDES(LOFORMSET.ARIAFORM1.PGFPAYINV.PGDIST.CBOTAXCODE.VALUE , 'CTAXCODE')
        PUTAX      = LOFORMSET.LCTAXDES
      ELSE
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        *!*	        loFormSet.DistLines.cboTaxCode.Value   = SPACE(6)
        *!*	        loFormSet.DistLines.glActCode.KeyTextbox.Value = lcOldAcct
        LOFORMSET.ARIAFORM1.PGFPAYINV.PGDIST.CBOTAXCODE.VALUE   = SPACE(6)
        LOFORMSET.ARIAFORM1.PGFPAYINV.PGDIST.GLACTCODE.KEYTEXTBOX.VALUE = LCOLDACCT
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
        LOFORMSET.LCTAXDES   = LOFORMSET.LCEMPTYCODE
        PUTAX      = LOFORMSET.LCTAXDES
      ENDIF
      *Old: SHOW GET puTax &&Revise
    ENDIF
  ENDIF
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	  IF !EMPTY(loFormSet.DistLines.cboTaxCode.Value)
  *!*	    *Old: SHOW GET lcApdGlAct DISABLE &&Revise
  *!*	    *Old: SHOW GET ibApGlAcc  DISABLE &&Revise
  *!*	    loFormSet.DistLines.glActCode.Enabled = .F.
  IF !EMPTY(LOFORMSET.ARIAFORM1.PGFPAYINV.PGDIST.CBOTAXCODE.VALUE)
    *Old: SHOW GET lcApdGlAct DISABLE &&Revise
    *Old: SHOW GET ibApGlAcc  DISABLE &&Revise
    LOFORMSET.ARIAFORM1.PGFPAYINV.PGDIST.GLACTCODE.ENABLED = .F.
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    LOFORMSET.LLGLACTSTA = .F.
  ELSE
    *Old: SHOW GET lcApdGlAct ENABLE &&Revise
    *Old: SHOW GET ibApGlAcc  ENABLE &&Revise
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *loFormSet.DistLines.glActCode.Enabled = .T.
    LOFORMSET.ARIAFORM1.PGFPAYINV.PGDIST.GLACTCODE.ENABLED = .T.
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    LOFORMSET.LLGLACTSTA = .T.
  ENDIF
ENDIF
SELECT(LOFORMSET.LCTMPDIST)
LCFILT = FILTER()
SET FILTER TO
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*IF loFormSet.DistLines.cboTaxCode.Value <> loFormSet.DistLines.cboTaxCode.OldValue
IF LOFORMSET.ARIAFORM1.PGFPAYINV.PGDIST.CBOTAXCODE.VALUE <> LOFORMSET.ARIAFORM1.PGFPAYINV.PGDIST.CBOTAXCODE.OLDVALUE
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  IF LOFORMSET.ACTIVEMODE="E"  &&lower
    LNSAVRECNO = RECNO()
    IF CSTATUS = 'S' .AND. UPDATED() && IF the record is modified.
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *=lfvUpdTemp(loFormSet,'cTaxCode',loFormSet.DistLines.cboTaxCode.OldValue)
      =LFVUPDTEMP(LOFORMSET,'cTaxCode',LOFORMSET.ARIAFORM1.PGFPAYINV.PGDIST.CBOTAXCODE.OLDVALUE)
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      IF BETWEEN(LNSAVRECNO,0,RECCOUNT())
        GO LNSAVRECNO
      ENDIF
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *!*	      REPLACE CTAXCODE  WITH loFormSet.DistLines.cboTaxCode.Value       ,;
      *!*	              CAPDGLACT WITH loFormSet.DistLines.glActCode.KeyTextbox.Value      ,;
      *!*	              CSTATUS   WITH 'M'             ,;
      *!*	              LAPDPOST  WITH .F.             ,;
      *!*	              CBATCHNO  WITH ' '             ,;
      *!*	              CTRNSLEDN WITH ' '             ,;
      *!*	              CAPSESSNO WITH loFormSet.lcSequence      ,;
      *!*	              CUPDSERNO WITH ' '
      REPLACE CTAXCODE  WITH LOFORMSET.ARIAFORM1.PGFPAYINV.PGDIST.CBOTAXCODE.VALUE       ,;
        CAPDGLACT WITH LOFORMSET.ARIAFORM1.PGFPAYINV.PGDIST.GLACTCODE.KEYTEXTBOX.VALUE      ,;
        CSTATUS   WITH 'M'             ,;
        LAPDPOST  WITH .F.             ,;
        CBATCHNO  WITH ' '             ,;
        CTRNSLEDN WITH ' '             ,;
        CAPSESSNO WITH LOFORMSET.LCSEQUENCE      ,;
        CUPDSERNO WITH ' '
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      REPLACE NENTRYNO  WITH 0

      =GFADD_INFO(LOFORMSET.LCTMPDIST)
    ELSE
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *!*	      REPLACE CTAXCODE  WITH loFormSet.DistLines.cboTaxCode.Value, ;
      *!*	              CAPDGLACT WITH loFormSet.DistLines.glActCode.KeyTextbox.Value
      REPLACE CTAXCODE  WITH LOFORMSET.ARIAFORM1.PGFPAYINV.PGDIST.CBOTAXCODE.VALUE, ;
        CAPDGLACT WITH LOFORMSET.ARIAFORM1.PGFPAYINV.PGDIST.GLACTCODE.KEYTEXTBOX.VALUE
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    ENDIF
  ELSE
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *!*	    REPLACE CTAXCODE WITH loFormSet.DistLines.cboTaxCode.Value  ,;
    *!*	            CAPDGLACT WITH loFormSet.DistLines.glActCode.KeyTextbox.Value
    REPLACE CTAXCODE WITH LOFORMSET.ARIAFORM1.PGFPAYINV.PGDIST.CBOTAXCODE.VALUE  ,;
      CAPDGLACT WITH LOFORMSET.ARIAFORM1.PGFPAYINV.PGDIST.GLACTCODE.KEYTEXTBOX.VALUE
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  ENDIF
ENDIF
*=lfRefresh(lcDisChld1+','+lcDisChld3+','+lcDisChld4+','+lcDisChld5)
*=lfvTrapKey()
SELECT(LOFORMSET.LCTMPDIST)
IF !EMPTY(LCFILT)
  SET FILTER TO &LCFILT
ENDIF
LFDISTREFRESH(LOFORMSET)
*DEACTIVATE POPUP puTaxDes

RETURN
*--end of lfvTaxCode


*!*************************************************************
*! Name      : lfvApGlAcc
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 8/8/2004
*! Purpose   : To validate the AP GL account in the Ditribution Lines screen
*!*************************************************************
*! Parameters: The FormSet
*!*************************************************************
*! Returns   : None
*!**************************************************************
FUNCTION LFVAPGLACC
LPARAMETERS LOFORMSET
LOCAL LCFILT


SELECT(LOFORMSET.LCTMPDIST)
LCFILT = FILTER()
SET FILTER TO

*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*!*	IF loFormSet.DistLines.glActCode.KeyTextbox.OldValue <> ;
*!*	  loFormSet.DistLines.glActCode.KeyTextbox.Value .AND. ;
*!*	  !EMPTY(STRTRAN(STRTRAN(loFormSet.DistLines.glActCode.KeyTextbox.Value,'-'),'0'))
IF LOFORMSET.ARIAFORM1.PGFPAYINV.PGDIST.GLACTCODE.KEYTEXTBOX.OLDVALUE <> ;
    LOFORMSET.ARIAFORM1.PGFPAYINV.PGDIST.GLACTCODE.KEYTEXTBOX.VALUE .AND. ;
    !EMPTY(STRTRAN(STRTRAN(LOFORMSET.ARIAFORM1.PGFPAYINV.PGDIST.GLACTCODE.KEYTEXTBOX.VALUE,'-'),'0'))
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  IF LOFORMSET.ACTIVEMODE="E"
    LNSAVRECNO = RECNO()
    IF CSTATUS = 'S' .AND. UPDATED() && IF the record is modified.
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *=lfvUpdTemp(loFormSet,'capdglact',loFormSet.DistLines.glActCode.KeyTextBox.OldValue)
      =LFVUPDTEMP(LOFORMSET,'capdglact',LOFORMSET.ARIAFORM1.PGFPAYINV.PGDIST.GLACTCODE.KEYTEXTBOX.OLDVALUE)
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

      IF BETWEEN(LNSAVRECNO,0,RECCOUNT())
        GO LNSAVRECNO
      ENDIF
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *!*	      REPLACE CAPDGLACT WITH ;
      *!*	      IIF(EMPTY(STRTRAN(STRTRAN(loFormSet.DistLines.glActCode.KeyTextbox.Value,'-'),'0')),;
      *!*	          SPACE(loFormSet.DistLines.glActCode.KeyTextbox.Value), loFormSet.DistLines.glActCode.KeyTextbox.Value),;
      *!*	              CSTATUS   WITH 'M'        ,;
      *!*	              LAPDPOST  WITH .F.        ,;
      *!*	              CBATCHNO  WITH ' '        ,;
      *!*	              CTRNSLEDN WITH ' '        ,;
      *!*	              CAPSESSNO WITH loFormSet.lcSequence ,;
      *!*	              CUPDSERNO WITH ' '
      REPLACE CAPDGLACT WITH ;
        IIF(EMPTY(STRTRAN(STRTRAN(LOFORMSET.ARIAFORM1.PGFPAYINV.PGDIST.GLACTCODE.KEYTEXTBOX.VALUE,'-'),'0')),;
        SPACE(LOFORMSET.ARIAFORM1.PGFPAYINV.PGDIST.GLACTCODE.KEYTEXTBOX.VALUE), LOFORMSET.ARIAFORM1.PGFPAYINV.PGDIST.GLACTCODE.KEYTEXTBOX.VALUE),;
        CSTATUS   WITH 'M'        ,;
        LAPDPOST  WITH .F.        ,;
        CBATCHNO  WITH ' '        ,;
        CTRNSLEDN WITH ' '        ,;
        CAPSESSNO WITH LOFORMSET.LCSEQUENCE ,;
        CUPDSERNO WITH ' '
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      REPLACE NENTRYNO  WITH 0

      =GFADD_INFO(LOFORMSET.LCTMPDIST)
    ELSE
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *!*	      REPLACE CAPDGLACT WITH IIF(EMPTY(STRTRAN(STRTRAN(loFormSet.DistLines.glActCode.KeyTextbox.Value,'-'),'0')),;
      *!*	                             SPACE(loFormSet.DistLines.glActCode.KeyTextbox.Value), ;
      *!*	                             loFormSet.DistLines.glActCode.KeyTextbox.Value)
      REPLACE CAPDGLACT WITH IIF(EMPTY(STRTRAN(STRTRAN(LOFORMSET.ARIAFORM1.PGFPAYINV.PGDIST.GLACTCODE.KEYTEXTBOX.VALUE,'-'),'0')),;
        SPACE(LOFORMSET.ARIAFORM1.PGFPAYINV.PGDIST.GLACTCODE.KEYTEXTBOX.VALUE), ;
        LOFORMSET.ARIAFORM1.PGFPAYINV.PGDIST.GLACTCODE.KEYTEXTBOX.VALUE)
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    ENDIF
  ELSE
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *!*	    REPLACE CAPDGLACT WITH IIF(EMPTY(STRTRAN(STRTRAN(loFormSet.DistLines.glActCode.KeyTextbox.Value,'-'),'0')),;
    *!*	                             SPACE(loFormSet.DistLines.glActCode.KeyTextbox.Value), ;
    *!*	                             loFormSet.DistLines.glActCode.KeyTextbox.Value)
    REPLACE CAPDGLACT WITH IIF(EMPTY(STRTRAN(STRTRAN(LOFORMSET.ARIAFORM1.PGFPAYINV.PGDIST.GLACTCODE.KEYTEXTBOX.VALUE,'-'),'0')),;
      SPACE(LOFORMSET.ARIAFORM1.PGFPAYINV.PGDIST.GLACTCODE.KEYTEXTBOX.VALUE), ;
      LOFORMSET.ARIAFORM1.PGFPAYINV.PGDIST.GLACTCODE.KEYTEXTBOX.VALUE)
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  ENDIF
ELSE
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *loFormSet.DistLines.glActCode.KeyTextbox.Value = loFormSet.DistLines.glActCode.KeyTextbox.OldValue
  LOFORMSET.ARIAFORM1.PGFPAYINV.PGDIST.GLACTCODE.KEYTEXTBOX.VALUE = LOFORMSET.ARIAFORM1.PGFPAYINV.PGDIST.GLACTCODE.KEYTEXTBOX.OLDVALUE
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
ENDIF

*Old: SHOW GET loFormSet.lcApdGLAct &&Revise

*SHOW WINDOW (loFormSet.lcBrowsTtl) REFRESH
*!B500684,1 MAN 06/01/95
*=lfRefresh()
*=lfRefresh(lcDisChld5)
*=lfvTrapKey()
SELECT(LOFORMSET.LCTMPDIST)
IF !EMPTY(LCFILT)
  SET FILTER TO &LCFILT
ENDIF
LFDISTREFRESH(LOFORMSET)

RETURN
*--end of lfvApGlAcc

*!*************************************************************
*! Name      : lfvDistAmnt
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 8/8/2004
*! Purpose   : To validate the Distibuted Amount in the Ditribution Lines screen
*!*************************************************************
*! Parameters: The FormSet
*!*************************************************************
*! Returns   : None
*!**************************************************************
FUNCTION LFVDISTAMNT
LPARAMETERS LOFORMSET
LOCAL LCFILT
SELECT(LOFORMSET.LCTMPDIST)
LCFILT = FILTER()
SET FILTER TO

*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*!*	IF loFormSet.DistLines.txtlnApdAmnt.Value <> loFormSet.DistLines.txtlnApdAmnt.OldValue
*!*	  loFormSet.lnDistAmnt = loFormSet.lnDistAmnt - loFormSet.DistLines.txtlnApdAmnt.OldValue + ;
*!*	                         loFormSet.DistLines.txtlnApdAmnt.Value
IF LOFORMSET.ARIAFORM1.PGFPAYINV.PGDIST.TXTLNAPDAMNT.VALUE <> LOFORMSET.ARIAFORM1.PGFPAYINV.PGDIST.TXTLNAPDAMNT.OLDVALUE
  LOFORMSET.LNDISTAMNT = LOFORMSET.LNDISTAMNT - LOFORMSET.ARIAFORM1.PGFPAYINV.PGDIST.TXTLNAPDAMNT.OLDVALUE + ;
    LOFORMSET.ARIAFORM1.PGFPAYINV.PGDIST.TXTLNAPDAMNT.VALUE
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  *B608804,1 WAM 02/17/2009 Don't change the value of the OLDVALUE property
  *B608804,1 WAM 02/17/2009 Followinh line comented out

  *!*	  *B608528,1 MHM 04/21/2008 Invoice Lines-cannot amend the GL account for General Expense Item [Start]
  *!*	  *-Assing value to old Value as it is updated only if you click ENTER
  *!*	  loFormSet.DistLines.txtlnApdAmnt.OldValue = loFormSet.DistLines.txtlnApdAmnt.Value
  *!*	  *B608528,1 MHM 04/21/2008 Invoice Lines-cannot amend the GL account for General Expense Item[END]

  *B608804,1 WAM 02/17/2009 (End)
ENDIF

*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*IF loFormSet.DistLines.txtlnApdAmnt.Value <> loFormSet.DistLines.txtlnApdAmnt.OldValue
IF LOFORMSET.ARIAFORM1.PGFPAYINV.PGDIST.TXTLNAPDAMNT.VALUE <> LOFORMSET.ARIAFORM1.PGFPAYINV.PGDIST.TXTLNAPDAMNT.OLDVALUE
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  IF LOFORMSET.ACTIVEMODE="E"  &&lower
    LNSAVRECNO = RECNO()
    IF CSTATUS = 'S' .AND. UPDATED() && IF the record is modified.
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      * =lfvUpdTemp(loFormSet,'napdamnt',loFormSet.DistLines.txtlnApdAmnt.OldValue)
      =LFVUPDTEMP(LOFORMSET,'napdamnt',LOFORMSET.ARIAFORM1.PGFPAYINV.PGDIST.TXTLNAPDAMNT.OLDVALUE)
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      IF BETWEEN(LNSAVRECNO,0,RECCOUNT())
        GO LNSAVRECNO
      ENDIF

      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *!*	      REPLACE NAPDAMNT  WITH loFormSet.DistLines.txtlnApdAmnt.Value  ,;
      *!*	              CSTATUS   WITH 'M'        ,;
      *!*	              LAPDPOST  WITH .F.        ,;
      *!*	              CBATCHNO  WITH ' '        ,;
      *!*	              CTRNSLEDN WITH ' '        ,;
      *!*	              CAPSESSNO WITH loFormSet.lcSequence ,;
      *!*	              CUPDSERNO WITH ' '
      REPLACE NAPDAMNT  WITH LOFORMSET.ARIAFORM1.PGFPAYINV.PGDIST.TXTLNAPDAMNT.VALUE  ,;
        CSTATUS   WITH 'M'        ,;
        LAPDPOST  WITH .F.        ,;
        CBATCHNO  WITH ' '        ,;
        CTRNSLEDN WITH ' '        ,;
        CAPSESSNO WITH LOFORMSET.LCSEQUENCE ,;
        CUPDSERNO WITH ' '
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      *B801498,1 Add these line to clear the entry number [Begin]
      REPLACE NENTRYNO  WITH 0
      *B801498,1 Add these line to clear the entry number [End]

      =GFADD_INFO(LOFORMSET.LCTMPDIST)
    ELSE
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *REPLACE NAPDAMNT WITH loFormSet.DistLines.txtlnApdAmnt.Value
      REPLACE NAPDAMNT WITH LOFORMSET.ARIAFORM1.PGFPAYINV.PGDIST.TXTLNAPDAMNT.VALUE
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    ENDIF
  ELSE
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    * REPLACE NAPDAMNT WITH loFormSet.DistLines.txtlnApdAmnt.Value
    REPLACE NAPDAMNT WITH LOFORMSET.ARIAFORM1.PGFPAYINV.PGDIST.TXTLNAPDAMNT.VALUE
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  ENDIF
ENDIF

*B608804,1 WAM 02/17/2009 Change the value of the OLDVALUE property here
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*loFormSet.DistLines.txtlnApdAmnt.OldValue = loFormSet.DistLines.txtlnApdAmnt.Value
LOFORMSET.ARIAFORM1.PGFPAYINV.PGDIST.TXTLNAPDAMNT.OLDVALUE = LOFORMSET.ARIAFORM1.PGFPAYINV.PGDIST.TXTLNAPDAMNT.VALUE
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
*B608804,1 WAM 02/17/2009 (End)

*Old: SHOW GET loFormSet.lnApdAmnt &&Revise
*!B500684,1 MAN 06/01/95
*=lfRefresh()
*=lfRefresh(lcDisChld1)
*=lfvTrapKey()
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*loFormSet.DistLines.txtUnDist.Refresh()
LOFORMSET.ARIAFORM1.PGFPAYINV.PGDIST.TXTUNDIST.REFRESH()
LNSAVRECNO = RECNO()
=LFVDISTRIB(LOFORMSET)
IF BETWEEN(LNSAVRECNO,0,RECCOUNT())
  GO LNSAVRECNO
ENDIF
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
SELECT(LOFORMSET.LCTMPDIST)
IF !EMPTY(LCFILT)
  SET FILTER TO &LCFILT
ENDIF
LFDISTREFRESH(LOFORMSET)
RETURN
*--end of lfvDistAmnt


*!*************************************************************
*! Name      : lfvUpdTemp
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 8/8/2004
*! Purpose   : To Add a record to the TempDist Table
*!*************************************************************
*! Parameters: The FormSet, Control Name, Control's Old Value
*!*************************************************************
*! Returns   : None
*!**************************************************************
FUNCTION LFVUPDTEMP
LPARAMETERS LOFORMSET, LCWHICH, LOLDVAL


SCATTER MEMVAR MEMO

m.CSTATUS  = 'A'
m.CAPDSTAT = 'V'
LCWHICH = 'm.'+LCWHICH
&LCWHICH = LOLDVAL

APPEND BLANK
GATHER MEMVAR MEMO

m.NAPDAMNT  = -1 * m.NAPDAMNT
m.NEQVAMNT  = -1 * m.NEQVAMNT
m.LAPDPOST  = .F.
m.CBATCHNO  = ' '
m.CTRNSLEDN = ' '
m.CAPSESSNO = LOFORMSET.LCSEQUENCE

m.NENTRYNO = 0

APPEND BLANK
GATHER MEMVAR MEMO

RETURN
*--end of lfvUpdTemp



*!*************************************************************
*! Name      : lfvNewLine
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 8/8/2004
*! Purpose   : Function called from the Click Event of New Button of the Distribution Lines Screen
*!*************************************************************
*! Parameters: The FormSet
*!*************************************************************
*! Returns   : None
*!*************************************************************
FUNCTION LFVNEWLINE
LPARAMETERS LOFORMSET


IF !EMPTY(APVENDOR.CEXPACCT)
  LOFORMSET.LCDISTACCT = APVENDOR.CEXPACCT
ELSE
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *  IF SEEK(loFormSet.AriaForm1.cboDivision.Value,'APDIV') .AND. !EMPTY(APDIV.CEXPACCT)
  IF GFSEEK(LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.CBODIVISION.VALUE,'APDIV') .AND. !EMPTY(APDIV.CEXPACCT)
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[END]
    LOFORMSET.LCDISTACCT = APDIV.CEXPACCT
  ELSE
    LOFORMSET.LCDISTACCT = APSETUP.CEXPACCT
  ENDIF
ENDIF


SELECT(LOFORMSET.LCTMPDIST)


** Add the distribution account. **
APPEND BLANK
IF TYPE('APINVHDR.DPOSTDATE') = 'D'
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	  REPLACE CVENDCODE WITH loFormSet.AriaForm1.KBVendCode.KeyTextBox.Value  ,;
  *!*	          CINVNO    WITH loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value  ,;
  *!*	          DAPDTRDAT WITH loFormSet.AriaForm1.DtPostDate.Value ,;
  *!*	          LAPDPOST  WITH .F.        ,;
  *!*	          CAPDGLACT WITH loFormSet.lcDistAcct ,;
  *!*	          NAPDAMNT  WITH loFormSet.AriaForm1.txtInvAmount.Value - loFormSet.lnDistAmnt,;
  *!*	          CAPDACTID WITH 'D'        ,;
  *!*	          CFISFYEAR WITH loFormSet.lcDistYer  ,;
  *!*	          CFSPPRDID WITH loFormSet.lcDistPrd  ,;
  *!*	          CAPSESSNO WITH loFormSet.lcSequence,;
  *!*	          CAPDTRTYP WITH 'I'        ,;
  *!*	          CSTATUS   WITH 'A'        ,;
  *!*	          NAPDLINNO WITH lfvLineNo(loFormSet),;
  *!*	          CAPDREF   WITH loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value
  REPLACE CVENDCODE WITH LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE  ,;
    CINVNO    WITH LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE  ,;
    DAPDTRDAT WITH LOFORMSET.ARIAFORM1.DTPOSTDATE.VALUE ,;
    LAPDPOST  WITH .F.        ,;
    CAPDGLACT WITH LOFORMSET.LCDISTACCT ,;
    NAPDAMNT  WITH LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTINVAMOUNT.VALUE - LOFORMSET.LNDISTAMNT,;
    CAPDACTID WITH 'D'        ,;
    CFISFYEAR WITH LOFORMSET.LCDISTYER  ,;
    CFSPPRDID WITH LOFORMSET.LCDISTPRD  ,;
    CAPSESSNO WITH LOFORMSET.LCSEQUENCE,;
    CAPDTRTYP WITH 'I'        ,;
    CSTATUS   WITH 'A'        ,;
    NAPDLINNO WITH LFVLINENO(LOFORMSET),;
    CAPDREF   WITH LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
ELSE
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	  REPLACE CVENDCODE WITH loFormSet.AriaForm1.KBVendCode.KeyTextBox.Value  ,;
  *!*	          CINVNO    WITH loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value  ,;
  *!*	          DAPDTRDAT WITH loFormSet.AriaForm1.DtInvDate.Value ,;
  *!*	          LAPDPOST  WITH .F.        ,;
  *!*	          CAPDGLACT WITH loFormSet.lcDistAcct ,;
  *!*	          NAPDAMNT  WITH loFormSet.AriaForm1.txtInvAmount.Value - loFormSet.lnDistAmnt,;
  *!*	          CAPDACTID WITH 'D'        ,;
  *!*	          CFISFYEAR WITH apinvhdr.cfisfyear ,;
  *!*	          CFSPPRDID WITH apinvhdr.cfspprdid ,;
  *!*	          CAPSESSNO WITH loFormSet.lcSequence,;
  *!*	          CAPDTRTYP WITH 'I'        ,;
  *!*	          CSTATUS   WITH 'A'        ,;
  *!*	          NAPDLINNO WITH lfvLineNo(loFormSet),;
  *!*	          CAPDREF   WITH loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value
  REPLACE CVENDCODE WITH LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE  ,;
    CINVNO    WITH LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE  ,;
    DAPDTRDAT WITH LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.DTINVDATE.VALUE ,;
    LAPDPOST  WITH .F.        ,;
    CAPDGLACT WITH LOFORMSET.LCDISTACCT ,;
    NAPDAMNT  WITH LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTINVAMOUNT.VALUE - LOFORMSET.LNDISTAMNT,;
    CAPDACTID WITH 'D'        ,;
    CFISFYEAR WITH APINVHDR.CFISFYEAR ,;
    CFSPPRDID WITH APINVHDR.CFSPPRDID ,;
    CAPSESSNO WITH LOFORMSET.LCSEQUENCE,;
    CAPDTRTYP WITH 'I'        ,;
    CSTATUS   WITH 'A'        ,;
    NAPDLINNO WITH LFVLINENO(LOFORMSET),;
    CAPDREF   WITH LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
ENDIF
*C100728,1 M.H End.
=GFADD_INFO(LOFORMSET.LCTMPDIST)

*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*loFormSet.DistLines.grdDist.Refresh()
LOFORMSET.ARIAFORM1.PGFPAYINV.PGDIST.GRDDIST.REFRESH()
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

IF APVENDOR.CTAXTYPE = 'T'
  *Old: _CUROBJ = OBJNUM(loFormSet.lcApdGLAct)
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *  loFormSet.DistLines.glActCode.KeyTextbox.SetFocus()
  LOFORMSET.ARIAFORM1.PGFPAYINV.PGDIST.GLACTCODE.KEYTEXTBOX.SETFOCUS()
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
ELSE
  *Old: _CUROBJ = OBJNUM(ibTaxCode)
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *loFormSet.DistLines.cboTaxCode.SetFocus()
  LOFORMSET.ARIAFORM1.PGFPAYINV.PGDIST.CBOTAXCODE.SETFOCUS()
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
ENDIF
LOFORMSET.LNDISTAMNT = LOFORMSET.LNDISTAMNT + NAPDAMNT

LOFORMSET.LCTMPLATE = 'DISABLE'
*Old: SHOW GET loFormSet.AriaForm1.kbAutmCode.KeyTextBox.Value DISABLE  &&lower &&Revise
*Old: SHOW GET ibTemplate DISABLE &&Revise
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*loFormSet.AriaForm1.kbAutmCode.Enabled = .F.
LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBAUTMCODE.ENABLED = .F.
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

*SHOW WINDOW ALL REFRESH SAME
*Old: SHOW WINDOW (loFormSet.lcBrowsTtl) REFRESH
*Old: SHOW WINDOW (loFormSet.lcBrowsTtl) TOP IN WINDOW CWRAPDISTR

=LFDISPOBJCT(LOFORMSET)
*!B500684,1 MAN 06/01/95
*Old: =lfvTrapKey()
LFDISTREFRESH(LOFORMSET)
*Old: =lfRefresh()

RETURN
*--end of lfvNewLine


*!*************************************************************
*! Name      : lfvRemLine
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 8/8/2004
*! Purpose   : Function called from the Click Event of Remove Button of the Distribution Lines Screen
*!*************************************************************
*! Parameters: The FormSet
*!*************************************************************
*! Returns   : None
*!*************************************************************
FUNCTION LFVREMLINE
LPARAMETERS LOFORMSET
LOCAL LCFILT

SELECT(LOFORMSET.LCTMPDIST)

IF GFMODALGEN("QRM00007B00007","ALERT") = 1

  SELECT(LOFORMSET.LCTMPDIST)
  LCFILT = FILTER()
  SET FILTER TO
  LNSAVRECNO = 0
  LOFORMSET.LNDISTAMNT = LOFORMSET.LNDISTAMNT - NAPDAMNT

  DO CASE
  CASE CSTATUS = 'A'
    REPLACE CSTATUS WITH 'S'
    DELETE
    IF LOFORMSET.LNLINENO > 0 .AND. !EOF()
      SKIP
      LNSAVRECNO = RECNO()
      REPLACE REST NAPDLINNO WITH NAPDLINNO - 1,;
        CUPDSERNO WITH IIF(LOFORMSET.ACTIVEMODE="E" .AND. CSTATUS $ 'MS','M',' ')
    ENDIF

  CASE CSTATUS = 'S'
    REPLACE CAPDSTAT WITH 'V',;
      CSTATUS  WITH 'M'

    SCATTER MEMVAR MEMO
    m.LAPDPOST = .F.
    m.CBATCHNO = ' '
    m.CTRNSLEDN= ' '
    m.CAPSESSNO= LOFORMSET.LCSEQUENCE
    m.NAPDAMNT = 0 - m.NAPDAMNT
    m.CAPDSTAT = 'V'
    m.CSTATUS  = 'A'
    m.NEQVAMNT = 0 - m.NEQVAMNT

    m.NENTRYNO = 0

    DELETE

    IF LOFORMSET.LNLINENO > 0 .AND. !EOF()
      SKIP
      LNSAVRECNO = RECNO()
      REPLACE REST NAPDLINNO WITH NAPDLINNO - 1,;
        CUPDSERNO WITH IIF(LOFORMSET.ACTIVEMODE="E" .AND. CSTATUS $ 'MS','M',' ')
    ENDIF
    APPEND BLANK
    GATHER MEMVAR MEMO

  CASE CSTATUS = 'M'
    REPLACE CSTATUS WITH 'D'
    DELETE
    IF LOFORMSET.LNLINENO > 0 .AND. !EOF()
      SKIP
      LNSAVRECNO = RECNO()
      REPLACE REST NAPDLINNO WITH NAPDLINNO - 1,;
        CUPDSERNO WITH IIF(LOFORMSET.ACTIVEMODE="E" .AND. CSTATUS $ 'MS','M',' ')
    ENDIF
  ENDCASE

  LOFORMSET.LNLINENO   = LOFORMSET.LNLINENO - 1

  IF LNSAVRECNO <> 0 .AND. LNSAVRECNO <= RECCOUNT()
    GO LNSAVRECNO
  ELSE
    IF !BOF()
      SKIP -1
    ENDIF
  ENDIF

  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	  loFormSet.DistLines.Deactivate
  *!*	  loFormSet.DistLines.Activate
  LOFORMSET.ARIAFORM1.PGFPAYINV.PGDIST.DEACTIVATE
  LOFORMSET.ARIAFORM1.PGFPAYINV.PGDIST.ACTIVATE
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

ENDIF

*Enable the template field only if the" Vendor Invoice Types" is empty
IF LOFORMSET.LNLINENO = 0 .AND. EMPTY(LOFORMSET.LCVENINVTYPES)

  LOFORMSET.LCTMPLATE = 'ENABLE'
  *Old: SHOW GET loFormSet.AriaForm1.kbAutmCode.KeyTextBox.Value ENABLE  &&lower &&Revise
  *Old: SHOW GET ibTemplate ENABLE &&Revise
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *loFormSet.AriaForm1.kbAutmCode.Enabled = .T.
  LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBAUTMCODE.ENABLED = .T.
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[ENd]
ELSE
  LOFORMSET.LCTMPLATE = 'DISABLE'
  *Old: SHOW GET loFormSet.AriaForm1.kbAutmCode.KeyTextBox.Value DISABLE  &&lower &&Revise
  *Old: SHOW GET ibTemplate DISABLE &&Revise
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *loFormSet.AriaForm1.kbAutmCode.Enabled = .F.
  LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBAUTMCODE.ENABLED = .F.
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[ENd]
ENDIF

*SHOW WINDOW ALL REFRESH SAME
*Old: SHOW WINDOW (loFormSet.lcBrowsTtl) REFRESH
*Old: SHOW WINDOW (loFormSet.lcBrowsTtl) TOP IN WINDOW CWRAPDISTR

=LFDISPOBJCT(LOFORMSET)

*Old: =lfvTrapKey()
LFDISTREFRESH(LOFORMSET)

*Old: =lfRefresh()

IF LOFORMSET.LNLINENO = 0 .AND. APINVHDR.CAUTMTYPE = 'R'
  REPLACE APINVHDR.CAUTMTYPE WITH ' ' IN APINVHDR
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *loFormSet.AriaForm1.kbAutmCode.KeyTextBox.Value = '        '
  LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBAUTMCODE.KEYTEXTBOX.VALUE = '        '
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  *Old: SHOW GET loFormSet.AriaForm1.kbAutmCode.KeyTextBox.Value
  *Old: loFormSet.lcLabel = 'Template :'
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *loFormSet.AriaForm1.lblAutmType.Caption = 'Template'
  *N000682,1 MMT 11/20/2012 Globalization Changes[Start]
  *  LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.LBLAUTMTYPE.CAPTION = 'Template'
  *N000682,1 11/20/2012 MMT Globlization changes[Start]
*LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.LBLAUTMTYPE.CAPTION =LANG_APPYINV_TEMPLATE
LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.LBLAUTMTYPE.CAPTION =IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_TEMPLATE,loFormSet.GetHeaderText("LANG_APPYINV_TEMPLATE",loFormSet.HeaderAlias))
*N000682,1 11/20/2012 MMT Globlization changes[End]

  *N000682,1 MMT 11/20/2012 Globalization Changes[End]
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  *Old: =lfRefresh(gcBaseWind)
ENDIF

IF !EOF(LOFORMSET.LCTMPDIST)
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *loFormSet.DistLines.grdDist.SetFocus()
  LOFORMSET.ARIAFORM1.PGFPAYINV.PGDIST.GRDDIST.SETFOCUS()
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[ENd]
  LFDISTREFRESH(LOFORMSET)
ELSE
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *loFormSet.DistLines.cmdNew.SetFocus()
  LOFORMSET.ARIAFORM1.PGFPAYINV.PGDIST.CMDNEW.SETFOCUS()
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
ENDIF

RETURN
*--end of lfvRemLine


*!*************************************************************
*! Name      : lfvClsChld
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 8/8/2004
*! Purpose   : Function called from the Click Event of Close Button of the Distribution Lines Screen
*!*************************************************************
*! Parameters: The FormSet
*!*************************************************************
*! Returns   : None
*!*************************************************************
FUNCTION LFVCLSCHLD
LPARAMETERS LOFORMSET

IF INLIST(LOFORMSET.ACTIVEMODE,"A","E")
  IF LOFORMSET.LNLINENO = 0 .AND. EMPTY(LOFORMSET.LCVENINVTYPES)
    LOFORMSET.LCTMPLATE = 'ENABLE'
  ELSE
    LOFORMSET.LCTMPLATE = 'DISABLE'
  ENDIF
  *Old: SHOW GET loFormSet.AriaForm1.kbAutmCode.KeyTextBox.Value &loFormSet.lcTmplate  &&lower &&Revise
  *Old: SHOW GET ibTemplate &loFormSet.lcTmplate &&Revise
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *  loFormSet.AriaForm1.kbAutmCode.Enabled = (loFormSet.lcTmplate = 'ENABLE')
  LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBAUTMCODE.ENABLED = (LOFORMSET.LCTMPLATE = 'ENABLE')
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
ENDIF

IF INLIST(LOFORMSET.ACTIVEMODE,"A","E")
  *Old: _CUROBJ = OBJNUM(pbSav)&&Old CurObj
ELSE
  *Old: _CUROBJ = OBJNUM(pbCls)&&Old CurObj
ENDIF

*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*RELEASE PAD _BROWSE OF (loFormSet.cHostFormName)
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

*Old: =gfChClose('CWRAPDISTR')
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*loFormSet.DistLines.Visible = .F.
*loFormSet.AriaForm1.pgfpayInv.pgDist.Visible = .F.
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

RETURN
*--end of lfvClsChld


*!*************************************************************
*! Name      : lfDistRefresh
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 8/15/2004
*! Purpose   : Function called from the Refresh Event of the Distribution Lines Screen
*!*************************************************************
*! Parameters: The FormSet
*!*************************************************************
*! Returns   : None
*!*************************************************************
FUNCTION LFDISTREFRESH
LPARAMETERS LOFORMSET

IF !LOFORMSET.ACTIVEMODE="V" .AND. !LOFORMSET.LLLOKPER .AND. EMPTY(LOFORMSET.LCVENINVTYPES)

  IF LOFORMSET.LNDISTAMNT = APINVHDR.NINVAMNT
    *Old: SHOW GET pbNew ENABLE   && New 10/02/1994 &&Revise
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *loFormSet.DistLines.cmdNew.Enabled = .T.
    *!B609857,1 SAB 03/11/2012 Solve Media reported Problems[Start]
    *loFormSet.AriaForm1.pgfpayInv.pgDist.cmdNew.ENABLED = .T.
    LOFORMSET.ARIAFORM1.PGFPAYINV.PGDIST.CMDNEW.ENABLED = !(LOFORMSET.ACTIVEMODE == 'S')
    *!B609857,1 SAB 03/11/2012 Solve Media reported Problems[End]
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    LOFORMSET.LLNEWSTAT = .F.
  ELSE
    *Old: SHOW GET pbNew ENABLE &&Revise

    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *loFormSet.DistLines.cmdNew.Enabled = .T.
    *!B609857,1 SAB 03/11/2012 Solve Media reported Problems[Start]
    *loFormSet.AriaForm1.pgfpayInv.pgDist.cmdNew.ENABLED = .T.
    LOFORMSET.ARIAFORM1.PGFPAYINV.PGDIST.CMDNEW.ENABLED = !(LOFORMSET.ACTIVEMODE == 'S')
    *!B609857,1 SAB 03/11/2012 Solve Media reported Problems[End]
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

    LOFORMSET.LLNEWSTAT = .T.
  ENDIF


  IF LOFORMSET.LNLINENO <> 0
    *Old: SHOW GET pbRemove ENABLE &&Revise
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *loFormSet.DistLines.cmdRemove.Enabled = .T.
    LOFORMSET.ARIAFORM1.PGFPAYINV.PGDIST.CMDREMOVE.ENABLED = .T.
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[ENd]
  ELSE
    *Old: SHOW GET pbRemove DISABLE &&Revise
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *loFormSet.DistLines.cmdRemove.Enabled = .F.
    LOFORMSET.ARIAFORM1.PGFPAYINV.PGDIST.CMDREMOVE.ENABLED = .F.
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  ENDIF
ELSE
  IF LOFORMSET.ACTIVEMODE="V" .OR. LOFORMSET.LLLOKPER
    *Old: SHOW GET loFormSet.DistLines.glAPActCode.Value DISABLE  &&lower &&Revise
    *Old: SHOW GET ibApAcc    DISABLE &&Revise
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *loFormSet.DistLines.glAPActCode.Enabled = .F.
    LOFORMSET.ARIAFORM1.PGFPAYINV.PGDIST.GLAPACTCODE.ENABLED = .F.
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[END]
  ELSE
    *Old: SHOW GET loFormSet.DistLines.glAPActCode.Value ENABLE  &&lower &&Revise
    *Old: SHOW GET ibApAcc    ENABLE &&Revise
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    * loFormSet.DistLines.glAPActCode.Enabled = .T.
    LOFORMSET.ARIAFORM1.PGFPAYINV.PGDIST.GLAPACTCODE.ENABLED = .T.
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  ENDIF

  LOFORMSET.LLNEWSTAT = .F.
  *Old: SHOW GET pbNew DISABLE &&Revise
  *Old: SHOW GET pbRemove DISABLE &&Revise
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	  loFormSet.DistLines.cmdNew.Enabled = .F.
  *!*	  loFormSet.DistLines.cmdRemove.Enabled = .F.
  LOFORMSET.ARIAFORM1.PGFPAYINV.PGDIST.CMDNEW.ENABLED = .F.
  LOFORMSET.ARIAFORM1.PGFPAYINV.PGDIST.CMDREMOVE.ENABLED = .F.
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
ENDIF
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*WITH loFormSet.DistLines
WITH LOFORMSET.ARIAFORM1.PGFPAYINV.PGDIST
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  .GLAPACTCODE.KEYTEXTBOX.REFRESH()
  .TXTINVAMOUNT.REFRESH()
  .TXTUNDIST.REFRESH()
  .TXTLINENO.REFRESH()
  .CBOTAXCODE.REFRESH()
  .GLACTCODE.KEYTEXTBOX.REFRESH()
  .TXTLNAPDAMNT.REFRESH()
  .GRDDIST.REFRESH()
  .TXTAPACTNAME.VALUE = IIF(LOFORMSET.ARIAFORM1.AP1.LLAPGLLINK,ALLTRIM(LOOKUP(LCLINKCHAR.CACCNLDES,;
    .GLAPACTCODE.KEYTEXTBOX.VALUE,LCLINKCHAR.CACCTCODE,"ACCTCODE")),' ')
  .TXTGLACTNAME.VALUE = IIF(LOFORMSET.ARIAFORM1.AP1.LLAPGLLINK,ALLTRIM(LOOKUP(LCLINKCHAR.CACCNLDES,;
    .GLACTCODE.KEYTEXTBOX.VALUE,LCLINKCHAR.CACCTCODE,"ACCTCODE")),' ')
ENDWITH

RETURN
*--end of lfDistRefresh


***ddd***


***sss***

*!*************************************************************
*! Name      : lfFormBeforeSave
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 8/16/2004
*! Purpose   : Procedure called from the Before Save Method of the formSet
*!*************************************************************
*! Parameters: The FormSet
*!*************************************************************
*! Returns   : None
*!*************************************************************
FUNCTION LFFORMBEFORESAVE
LPARAMETERS LOFORMSET

*! E302623,3 MMT 01/03/2010 Convert Payable invoice screen to use SQL tables[Start]
IF LOFORMSET.ACTIVEMODE = 'A'
  IF !USED('APINVHDR_INV')
    =GFOPENTABLE('APINVHDR','VENDINV','SH','APINVHDR_INV')
  ENDIF
  IF GFSEEK(PADR(LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE,LEN(APINVHDR_INV.CVENDCODE))+PADR(LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE,LEN(APINVHDR_INV.CINVNO)),'APINVHDR_INV')
    =GFMODALGEN("TRM04014B00000","DIALOG",LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE)  &&lower
    LLCSAVE = .F.
    RETURN .F.
  ENDIF
ENDIF
*! E302623,3 MMT 01/03/2010 Convert Payable invoice screen to use SQL tables[End]


SELECT (LOFORMSET.LCTMPDIST)
*Get the Period# and Year for both dates invoice & Posting. If the Invoice date
*prior than postinf date give a warning message to the user. [Begin]
PRIVATE LCPSTPRD,LCPSTYER,LCINVPRD,LCINVYER
STORE '' TO LCPSTPRD,LCPSTYER,LCINVPRD,LCINVYER
=LFVLDATE(OARIAAPPLICATION.PRNTCOMPANYID , @LCPSTPRD , @LCPSTYER , LOFORMSET.ARIAFORM1.DTPOSTDATE.VALUE)
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*=lfVlDate(oAriaApplication.PrntCompanyID , @lcInvPrd , @lcInvYer , loFormSet.AriaForm1.DtInvDate.Value)
=LFVLDATE(OARIAAPPLICATION.PRNTCOMPANYID , @LCINVPRD , @LCINVYER , LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.DTINVDATE.VALUE)
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
IF VAL(LCPSTYER) < VAL(LCINVYER)
  *N000682,1 MMT 12/09/2012 Globalization changes[Start]
  IF GFMODALGEN("TRM04197B04012","DIALOG",;
  IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_INVOICESTITLE,LOFORMSET.GetHeaderText("LANG_APPYINV_INVOICESTITLE",LOFORMSET.HeaderAlias))+"|"+LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE) = 1
  *N000682,1 MMT 12/09/2012 Globalization changes[End]
    *Add validation that invoice date could not be after the invoice posted date [end]
    LLCSAVE = .F.
    *-- Return to posting date
    *Old: _CUROBJ = OBJNUM(loFormSet.AriaForm1.DtPostDate.Value)
    LOFORMSET.ARIAFORM1.DTPOSTDATE.SETFOCUS()
    SELECT APINVHDR
    RETURN .F.
  ENDIF

ELSE
  IF VAL(LCPSTYER) = VAL(LCINVYER)
    IF VAL(LCPSTPRD) < VAL(LCINVPRD)
      *N000682,1 MMT 11/22/2012 Globalization changes[Start]
      *IF GFMODALGEN("TRM04197B04012","DIALOG","invoices|"+LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE) = 1
      *N000682,1 11/20/2012 MMT Globlization changes[Start]
*IF GFMODALGEN("TRM04197B04012","DIALOG",LANG_APPYINV_SINVOICES+LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE) = 1
IF GFMODALGEN("TRM04197B04012","DIALOG",IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_SINVOICES,loFormSet.GetHeaderText("LANG_APPYINV_SINVOICES",loFormSet.HeaderAlias))+LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE) = 1
*N000682,1 11/20/2012 MMT Globlization changes[End]

      *N000682,1 MMT 11/22/2012 Globalization changes[END]
        *Add validation that invoice date could not be after the invoice posted date [end]
        LLCSAVE = .F.
        *-- Return to posting date
        *Old: _CUROBJ = OBJNUM(loFormSet.AriaForm1.DtPostDate.Value)
        LOFORMSET.ARIAFORM1.DTPOSTDATE.SETFOCUS()
        SELECT APINVHDR
        RETURN .F.
      ENDIF

    ENDIF
  ENDIF
ENDIF
LOFORMSET.LLCANSAV = .F.
LCSAVEXACT= SET('EXACT')
SET EXACT ON
IF !GFGETMEMVAR('LLMULCURR')  && If not multi currrency.
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value = oAriaApplication.BaseCurrency
  *loFormSet.AriaForm1.txtNexRate.Value = 1
  LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.KEYTEXTBOX.VALUE = OARIAAPPLICATION.BASECURRENCY
  LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTNEXRATE.VALUE = 1
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

  REPLACE APINVHDR.NCURRUNIT WITH 1 IN APINVHDR
ENDIF

*! B128863,1 ASM 08/24/2005 Fix the Bug of Saving Fox Tables even when SQL Gives errors and RollBack [Start]
IF !LFCHECKSQL()
  LLCSAVE = .F.
  SELECT APINVHDR
  RETURN .F.
ENDIF
*! B128863,1 ASM 08/24/2005 Fix the Bug of Saving Fox Tables even when SQL Gives errors and RollBack [End]

IF LOFORMSET.ACTIVEMODE="A" .AND. !SEEK(LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE,'APVENDOR')
  ** MESSAGE : "  not found.         "
  **           "          Ok        "
  **  = 'Vendor name'
  LNOPTION = GFMODALGEN("TRM04002B00000","DIALOG",LOFORMSET.LCTVENDCODE+LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE)
  LLCSAVE     = .F.
  LOFORMSET.LLSAMVENDOR = .F.
  SET EXACT &LCSAVEXACT
  SELECT APINVHDR
  RETURN .F.
ENDIF
*Open files and make necessary relation
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*!*	llopFact = gfOpenFile(oAriaApplication.SysPath+'SYCFACT','CFACCODE','SH')
*!*	llOpVHst = gfOpenFile(oAriaApplication.DataDir+'APVENHST','VENDYEAR','SH')
LLOPFACT = GFOPENTABLE(OARIAAPPLICATION.SYSPATH+'SYCFACT','CFACCODE','SH')
LLOPVHST = GFOPENTABLE('APVENHST','VENDYEAR','SH')
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

=CURSORSETPROP("Buffering",5,'APVENHST')
SELECT APINVHDR
SET RELATION OFF INTO APVENHST
SET RELATION TO APINVHDR.CVENDCODE + APINVHDR.CFISFYEAR INTO APVENHST ADDITIVE

*Check that total approved amount equal total invoice amount when payment method is credit card.
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*!*	IF loFormSet.AriaForm1.cboVendPmeth.Value = 'C' AND !EMPTY(loFormSet.lcVenInvTypes) AND ;
*!*	   loFormSet.lnTAprAmt<>0 AND loFormSet.AriaForm1.txtInvAmount.Value <> loFormSet.lnTAprAmt
IF LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.CBOVENDPMETH.VALUE = 'C' AND !EMPTY(LOFORMSET.LCVENINVTYPES) AND ;
    LOFORMSET.LNTAPRAMT<>0 AND LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTINVAMOUNT.VALUE <> LOFORMSET.LNTAPRAMT
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

  ** MESSAGE : " Credit card payment does not support adjustments. Therefor,"
  **           " the approved invoice amount has to total the invoice amount."
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *  =gfModalGen("TRM04184B00000","DIALOG",IIF(loFormSet.AriaForm1.txtInvAmount.Value > 0,'invoice|invoice','debit memo|debit memo'))
  =GFMODALGEN("TRM04184B00000","DIALOG",IIF(LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTINVAMOUNT.VALUE > 0,'invoice|invoice','debit memo|debit memo'))
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  LLCSAVE     = .F.
  LOFORMSET.LLSAMVENDOR = .F.
  SET EXACT &LCSAVEXACT
  SELECT APINVHDR
  RETURN .F.
ENDIF


*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*IF loFormSet.ActiveMode="A" .AND. !EMPTY(APVENDOR.CFACCODE) .AND. loFormSet.AriaForm1.cboInvRemit.Value <> 'F'
IF LOFORMSET.ACTIVEMODE="A" .AND. !EMPTY(APVENDOR.CFACCODE) .AND. LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.CBOINVREMIT.VALUE <> 'F'
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  ** MESSAGE : " Vendor  is factored, this invoice has not been  "
  **           " remited to the factor.                           "
  **           " <Remit to factor> <Stop saving> <Continue saving>"
  **  = 'Vendor name'
  LNOPTION = GFMODALGEN("TRM04065B04003","DIALOG",LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE)

  DO CASE
  CASE LNOPTION = 1
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *loFormSet.AriaForm1.cboInvRemit.Value  = 'F'
    *loFormSet.AriaForm1.kbFacCode.KeyTextBox.Value = APVENDOR.cFacCode
    *IF SEEK(loFormSet.AriaForm1.kbFacCode.KeyTextBox.Value,'SYCFACT')
    *!*	        loFormSet.AriaForm1.txtOutComp.Value  = SYCFACT.cFacComp
    *!*	        loFormSet.AriaForm1.txtOutAddr1.Value  = SYCFACT.cAddress1
    *!*	        loFormSet.AriaForm1.txtOutAddr2.Value  = SYCFACT.cAddress2
    *!*	        loFormSet.AriaForm1.txtOutAddr3.Value  = lfGetAdr('SYCFACT','CFACCODE')

    LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.CBOINVREMIT.VALUE  = 'F'
    LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBFACCODE.KEYTEXTBOX.VALUE = APVENDOR.CFACCODE
    IF SEEK(LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBFACCODE.KEYTEXTBOX.VALUE,'SYCFACT')
      LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTOUTCOMP.VALUE  = SYCFACT.CFACCOMP
      LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTOUTADDR1.VALUE  = SYCFACT.CADDRESS1
      LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTOUTADDR2.VALUE  = SYCFACT.CADDRESS2
      LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTOUTADDR3.VALUE  = LFGETADR('SYCFACT','CFACCODE')
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      REPLACE APINVHDR.COUTADDR1 WITH GFGETADR('SYCFACT','CFACCODE',.F.,.F.,1) IN APINVHDR
      REPLACE APINVHDR.COUTADDR2 WITH GFGETADR('SYCFACT','CFACCODE',.F.,.F.,2) IN APINVHDR
      REPLACE APINVHDR.COUTADDR3 WITH GFGETADR('SYCFACT','CFACCODE',.F.,.F.,3) IN APINVHDR
      REPLACE APINVHDR.COUTADDR4 WITH GFGETADR('SYCFACT','CFACCODE',.F.,.F.,4) IN APINVHDR
      REPLACE APINVHDR.COUTADDR5 WITH GFGETADR('SYCFACT','CFACCODE',.F.,.F.,5) IN APINVHDR

    ELSE
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *!*	        STORE SPACE(40) TO loFormSet.AriaForm1.txtOutComp.Value, ;
      *!*	          loFormSet.AriaForm1.txtOutAddr1.Value, loFormSet.AriaForm1.txtOutAddr2.Value, ;
      *!*	          loFormSet.AriaForm1.txtOutAddr3.Value
      STORE SPACE(40) TO LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTOUTCOMP.VALUE, ;
        LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTOUTADDR1.VALUE, LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTOUTADDR2.VALUE, ;
        LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTOUTADDR3.VALUE
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      REPLACE APINVHDR.COUTADDR4 WITH SPACE(40)
      REPLACE APINVHDR.COUTADDR5 WITH SPACE(40)
    ENDIF
  CASE LNOPTION = 2
    LOFORMSET.LLCANSAV = .T.
  ENDCASE
ENDIF
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
SELECT APINVHDR
=GFREPLACE("")
=GFREPLACE('minvnote with apinvhdr.minvnote')
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]



*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*IF loFormSet.AriaForm1.cboInvRemit.Value = 'F' .AND. EMPTY(loFormSet.AriaForm1.kbFacCode.KeyTextBox.Value)
IF LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.CBOINVREMIT.VALUE = 'F' .AND. EMPTY(LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBFACCODE.KEYTEXTBOX.VALUE)
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  ** MESSAGE : " You have to enter the ."
  **           "          Ok           "
  **  = 'factor code'
  =GFMODALGEN("TRM04066B00000","DIALOG",LOFORMSET.LCTFACTOR)
  *Old: _CUROBJ = OBJNUM(loFormSet.AriaForm1.kbFacCode.KeyTextBox.Value)
  *Old: SHOW GET loFormSet.AriaForm1.kbFacCode.KeyTextBox.Value  &&lower &&Revise
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *  loFormSet.AriaForm1.kbFacCode.KeyTextBox.SetFocus()
  LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBFACCODE.KEYTEXTBOX.SETFOCUS()
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  LOFORMSET.LLCANSAV = .T.
ENDIF

IF EMPTY(APINVHDR.CFSPPRDID) .OR. EMPTY(APINVHDR.CFISFYEAR)
  LCFISPRD = LOFORMSET.LCFISPRD
  LCFISYER = LOFORMSET.LCFISYER
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *IF lfVDtMsg(oAriaApplication.PrntCompanyID,@lcFisPrd,@lcFisYer,loFormSet.AriaForm1.DtInvDate.Value)
  IF LFVDTMSG(OARIAAPPLICATION.PRNTCOMPANYID,@LCFISPRD,@LCFISYER,LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.DTINVDATE.VALUE)
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    LOFORMSET.LCFISPRD = LCFISPRD
    LOFORMSET.LCFISYER = LCFISYER
    REPLACE APINVHDR.CFSPPRDID WITH LOFORMSET.LCFISPRD IN APINVHDR
    REPLACE APINVHDR.CFISFYEAR WITH LOFORMSET.LCFISYER IN APINVHDR
  ELSE
    *Old: _CUROBJ = OBJNUM(loFormSet.AriaForm1.DtInvDate.Value)  &&lower&&Old CurObj
    *Old: SHOW GET loFormSet.AriaForm1.DtInvDate.Value  &&lower &&Revise
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *loFormSet.AriaForm1.DtInvDate.SetFocus()
    LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.DTINVDATE.SETFOCUS()
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[ENd]
    LOFORMSET.LLCANSAV = .T.
  ENDIF
ENDIF
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*IF loFormSet.AriaForm1.txtInvAmount.Value = 0
IF LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTINVAMOUNT.VALUE = 0
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  ** MESSAGE : " You have to enter the ."
  **           "          Ok           "
  **  = 'invoice amount'
  =GFMODALGEN("TRM04066B00000","DIALOG",LOFORMSET.LCTINVAMONT)
  *Old: _CUROBJ = OBJNUM(loFormSet.AriaForm1.txtInvAmount.Value)  &&lower&&Old CurObj
  *Old: SHOW GET loFormSet.AriaForm1.txtInvAmount.Value  &&lower &&Revise
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *  loFormSet.AriaForm1.txtInvAmount.SetFocus()
  LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTINVAMOUNT.SETFOCUS()
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[END]
  LOFORMSET.LLCANSAV = .T.
ENDIF

*Prevent the user from saving if the company is using multi-currency
*and the currency field is empty [Begin]
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*IF gfGetMemVar('LLMULCURR') .AND. EMPTY(loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value)
IF GFGETMEMVAR('LLMULCURR') .AND. EMPTY(LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.KEYTEXTBOX.VALUE)
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[ENd]
  ** MESSAGE : " You have to enter the ."
  **           "          Ok           "
  **  = 'invoice currency'
  =GFMODALGEN("TRM04066B00000" , "DIALOG" , "invoice currency")

  *Old: _CUROBJ = OBJNUM(loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value)  &&lower&&Old CurObj
  *Old: SHOW GET loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value  &&lower &&Revise
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *loFormSet.AriaForm1.kbCurrCode.KeyTextBox.SetFocus()
  LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.KEYTEXTBOX.SETFOCUS()
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  LOFORMSET.LLCANSAV = .T.
ENDIF

IF LOFORMSET.LLCANSAV
  LLCSAVE = .F.
  SET EXACT &LCSAVEXACT
  SELECT APINVHDR
  RETURN .F.
ENDIF

*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*IF loFormSet.lnDistAmnt <> loFormSet.AriaForm1.txtInvAmount.Value
IF LOFORMSET.LNDISTAMNT <> LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTINVAMOUNT.VALUE
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  ** MESSAGE : " The distribution amount does not "
  **           " total the invoice amount.        "
  **           "                Ok              "
  =GFMODALGEN("TRM04031B00000","DIALOG")
  LLCSAVE = .F.
  SET EXACT &LCSAVEXACT
  SELECT APINVHDR
  RETURN .F.
ENDIF
*Check that total approved to pay amount is not greater than the open approved invoice amount
STORE 0 TO LNOTINVAMT,LNOTAPRAMT
SET EXACT OFF
IF LOFORMSET.ACTIVEMODE="E" AND !EMPTY(LOFORMSET.LCVENINVTYPES)
  SELECT 'APVINVDT'
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	  SET ORDER TO TAG Orgvinv
  *!*	  =SEEK(PADR(loFormSet.AriaForm1.KBVendCode.KeyTextBox.Value,8)+PADR(loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value,12))
  GFSETORDER('Orgvinv')
  =GFSEEK(PADR(LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE,8)+PADR(LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE,12))
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

  SUM REST IIF(CIMTYP $ 'RF',-ROUND(NAPAMNT,2),ROUND(NAPAMNT,2)),;
    IIF(CIMTYP $ 'RF',-ROUND(NAPAPRAMNT,2),ROUND(NAPAPRAMNT,2));
    TO LNOTINVAMT,LNOTAPRAMT ;
    WHILE CVENDCODE+CAPINVNO+CAPVILNO = PADR(LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE,8)+PADR(LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE,12)
ENDIF
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*!*	DO WHILE !EMPTY(loFormSet.lcVenInvTypes) AND loFormSet.llUpdInvLn AND ;
*!*	         IIF(loFormSet.AriaForm1.txtInvAmount.Value > 0,!BETWEEN(apinvhdr.ninvdisap+apinvhdr.ninvamtap+apinvhdr.ninvadjap,0,;
*!*	         loFormSet.AriaForm1.txtInvAmount.Value-apinvhdr.ninvpaid-apinvhdr.ninvdistk-apinvhdr.ninvadj+;
*!*	         (lnOTInvAmt-lnOTAprAmt)-(loFormSet.lnTInvAmt-loFormSet.lnTAprAmt)),;
*!*	         !BETWEEN(apinvhdr.ninvdisap+apinvhdr.ninvamtap+apinvhdr.ninvadjap,;
*!*	         loFormSet.AriaForm1.txtInvAmount.Value-apinvhdr.ninvpaid-apinvhdr.ninvdistk-apinvhdr.ninvadj+;
*!*	         (lnOTInvAmt-lnOTAprAmt)-(loFormSet.lnTInvAmt-loFormSet.lnTAprAmt),0))
DO WHILE !EMPTY(LOFORMSET.LCVENINVTYPES) AND LOFORMSET.LLUPDINVLN AND ;
    IIF(LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTINVAMOUNT.VALUE > 0,!BETWEEN(APINVHDR.NINVDISAP+APINVHDR.NINVAMTAP+APINVHDR.NINVADJAP,0,;
    LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTINVAMOUNT.VALUE-APINVHDR.NINVPAID-APINVHDR.NINVDISTK-APINVHDR.NINVADJ+;
    (LNOTINVAMT-LNOTAPRAMT)-(LOFORMSET.LNTINVAMT-LOFORMSET.LNTAPRAMT)),;
    !BETWEEN(APINVHDR.NINVDISAP+APINVHDR.NINVAMTAP+APINVHDR.NINVADJAP,;
    LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTINVAMOUNT.VALUE-APINVHDR.NINVPAID-APINVHDR.NINVDISTK-APINVHDR.NINVADJ+;
    (LNOTINVAMT-LNOTAPRAMT)-(LOFORMSET.LNTINVAMT-LOFORMSET.LNTAPRAMT),0))
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  ** MESSAGE : " Total approved to pay amount can not be greater than "
  **           " the open approved invoice amount."
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *IF gfModalGen("QRM04183B04011","DIALOG",IIF(loFormSet.AriaForm1.txtInvAmount.Value > 0,'invoice','debit memo'))=2
  *N000682,1 MMT 11/22/2012 Globalization changes[Start]
  *IF GFMODALGEN("QRM04183B04011","DIALOG",IIF(LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTINVAMOUNT.VALUE > 0,'invoice','debit memo'))=2
  *N000682,1 11/20/2012 MMT Globlization changes[Start]
*IF GFMODALGEN("QRM04183B04011","DIALOG",IIF(LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTINVAMOUNT.VALUE > 0,LANG_APPYINV_INVOICE_TEXT,LANG_APPYINV_DEBITMEMO_TEXT))=2
IF GFMODALGEN("QRM04183B04011","DIALOG",IIF(LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTINVAMOUNT.VALUE > 0,IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_INVOICE_TEXT,loFormSet.GetHeaderText("LANG_APPYINV_INVOICE_TEXT",loFormSet.HeaderAlias)),IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_DEBITMEMO_TEXT,loFormSet.GetHeaderText("LANG_APPYINV_DEBITMEMO_TEXT",loFormSet.HeaderAlias))))=2
*N000682,1 11/20/2012 MMT Globlization changes[End]

  *N000682,1 MMT 11/22/2012 Globalization changes[END]
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    LLCSAVE     = .F.
    LOFORMSET.LLSAMVENDOR = .F.
    SET EXACT &LCSAVEXACT
    SELECT APINVHDR
    RETURN .F.
  ENDIF
  *Q2: Shouldn't he here call the invoice lines screen ?
  =LFVAPROVPAY(LOFORMSET)
ENDDO
SELECT APINVHDR
SET EXACT ON
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*!*	IF loFormSet.AriaForm1.cboVendPmeth.Value = 'C'
IF LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.CBOVENDPMETH.VALUE = 'C'
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[ENd]
  IF EMPTY(APINVHDR.CVENCCVEN)
    ** MESSAGE : " You have to enter the credit "
    **           " card .                      "
    **           "              Ok            "
    **  = 'Vendor'
    =GFMODALGEN("TRM04044B00000","DIALOG",LOFORMSET.LCTVENDOR)
    *Old: _CUROBJ = OBJNUM(apinvhdr.cvenccven)  &&lower&&Old CurObj
    *Old: SHOW GET apinvhdr.cvenccven  &&lower &&Revise
    LOFORMSET.LLCANSAV = .T.
    *ASM, Call the Credit Card Screen
    =LFVAPROVPAY(LOFORMSET)
  ELSE
    IF EMPTY(APINVHDR.CVENCCINV)  &&lower
      ** MESSAGE : " You have to enter the credit "
      **           " card .                      "
      **           "              Ok            "
      **  = 'Invoice number'
      =GFMODALGEN("TRM04044B00000","DIALOG",LOFORMSET.LCTINVOICE)
      *Old: _CUROBJ = OBJNUM(apinvhdr.cvenccinv)  &&lower&&Old CurObj
      *Old: SHOW GET apinvhdr.cvenccinv  &&lower &&Revise
      LOFORMSET.LLCANSAV = .T.
      KEYBOARD '{TAB}'
      *ASM, Call the Credit Card Screen
      =LFVAPROVPAY(LOFORMSET)
    ELSE
      IF EMPTY(STRTRAN(STRTRAN(LOFORMSET.LCACCOUNT,'-'),'0'))
        ** MESSAGE : " You have to enter the credit "
        **           " card .                      "
        **           "              Ok            "
        **  = 'A/P account'
        =GFMODALGEN("TRM04044B00000","DIALOG",LOFORMSET.LCTAPACCT)
        *Old: _CUROBJ = OBJNUM(loFormSet.lcAccount)&&Old CurObj
        *Old: SHOW GET loFormSet.lcAccount &&Revise
        LOFORMSET.LLCANSAV = .T.
        KEYBOARD '{TAB}'+'{TAB}'
        *ASM, Call the Credit Card Screen
        =LFVAPROVPAY(LOFORMSET)
      ELSE
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        *IF loFormSet.AriaForm1.txtInvDisof.Value > 0   && The discount offered
        IF LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTINVDISOF.VALUE > 0   && The discount offered
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
          ** We are going to branch to a dialog screen to enter the
          ** discount account.
          LOFORMSET.LCDISACCT = APDIV.CDISCACCT
          IF EMPTY(LOFORMSET.LCDISACCT)
            LOFORMSET.LCDISACCT = APSETUP.CDISCACCT
          ENDIF
          LCOLDGLACC = LOFORMSET.LCDISACCT
          * DO APDISACT.SPR
          *DO (oAriaApplication.ScreenHome + oAriaApplication.ActiveModuleID + '\APDISACT.SPR')
          *DO FORM (OARIAAPPLICATION.SCREENHOME+"\AP\APDISACT.SCX") WITH LOFORMSET.ARIAFORM1

          *! E303029,1 MMT 12/26/2011 correct the calling of non-major programs within the SaaS environemnt[STart]
          *DO FORM (oAriaApplication.ScreenHome+"\AP\APDISACT.SCX") WITH loFormSet.AriaForm1
          LOPARAMLIST = LOFORMSET
          =GFCALLFORM('APDISACT','AP',"loParamList.AriaForm1")
          *! E303029,1 MMT 12/26/2011 correct the calling of non-major programs within the SaaS environemnt[END]
        ENDIF
      ENDIF
    ENDIF
  ENDIF
  IF LOFORMSET.LLCANSAV
    ** MESSAGE : "  process is canceled "
    **           "             Ok             "
    =GFMODALGEN("TRM00103B00000","DIALOG",LOFORMSET.LCTSAVE)
    LLCSAVE = .F.
    SET EXACT &LCSAVEXACT
    LOFORMSET.LCDISACCT = LOFORMSET.ARIAFORM1.AP1.LCEMPTYACC
    SELECT APINVHDR
    RETURN .F.
  ENDIF

  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *  REPLACE apinvhdr.ninvdistk WITH loFormSet.AriaForm1.txtInvDisof.Value IN apinvhdr
  REPLACE APINVHDR.NINVDISTK WITH LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTINVDISOF.VALUE IN APINVHDR
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  ** This variable will be in the distribution screen.
  LOFORMSET.LLINVBYCR  = .T.
ENDIF

*ASM, Enable Buffering for loFormSet.lcTmpDist in order to revert if cancelling the Save
=CURSORSETPROP("Buffering",5,LOFORMSET.LCTMPDIST)

IF LOFORMSET.ACTIVEMODE="E"
  LOFORMSET.LCEXSIN2 = ' '
  LCEXSIN2 = LOFORMSET.LCEXSIN2
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *loFormSet.lcExSin1 = gfGetExSin(@lcExSin2,loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value)
  LOFORMSET.LCEXSIN1 = GFGETEXSIN(@LCEXSIN2,LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.KEYTEXTBOX.VALUE)
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  LOFORMSET.LCEXSIN2 = LCEXSIN2
  SELECT (LOFORMSET.LCTMPDIST)
  GO TOP
  REPLACE ALL CSTATUS WITH 'M' FOR CUPDSERNO = 'M'
ENDIF

*Create the reverse transaction in the APDIST file if the user change the invoice date.

SET EXACT &LCSAVEXACT
SELECT APINVHDR
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*!*	IF loFormSet.ActiveMode="E" .AND. ;
*!*	  IIF(TYPE('APINVHDR.DPOSTDATE')='D',;
*!*	      loFormSet.AriaForm1.DtPostDate.Value <> OLDVAL('APINVHDR.DPOSTDATE'),;
*!*	      loFormSet.AriaForm1.DtInvDate.Value <> OLDVAL('APINVHDR.DINVDATE'))
IF LOFORMSET.ACTIVEMODE="E" .AND. ;
    IIF(TYPE('APINVHDR.DPOSTDATE')='D',;
    LOFORMSET.ARIAFORM1.DTPOSTDATE.VALUE <> OLDVAL('APINVHDR.DPOSTDATE'),;
    LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.DTINVDATE.VALUE <> OLDVAL('APINVHDR.DINVDATE'))
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  * Copy APDIST structures into laFileStru array
  SELECT APDIST
  =AFIELDS(LAFILESTRU)
  LNFILESTRU = ALEN(LAFILESTRU,1)
  DIMENSION LAFILESTRU[lnFileStru+2,18]
  LAFILESTRU[lnFileStru+1,1] = 'CSTATUS'
  LAFILESTRU[lnFileStru+1,2] = 'C'
  LAFILESTRU[lnFileStru+1,3] = 1
  LAFILESTRU[lnFileStru+1,4] = 0
  LAFILESTRU[lnFileStru+2,1] = 'NRECNO'
  LAFILESTRU[lnFileStru+2,2] = 'N'
  LAFILESTRU[lnFileStru+2,3] = 10
  LAFILESTRU[lnFileStru+2,4] = 0

  FOR LNLOOP = 1  TO 2
    STORE '' TO LAFILESTRU[lnFileStru+lnLoop ,7],LAFILESTRU[lnFileStru+lnLoop  ,8],;
      LAFILESTRU[lnFileStru+lnLoop ,9],LAFILESTRU[lnFileStru+lnLoop  ,10],;
      LAFILESTRU[lnFileStru+lnLoop ,11],LAFILESTRU[lnFileStru+lnLoop ,12],;
      LAFILESTRU[lnFileStru+lnLoop ,13],LAFILESTRU[lnFileStru+lnLoop ,14],;
      LAFILESTRU[lnFileStru+lnLoop ,15],LAFILESTRU[lnFileStru+lnLoop ,16]

    STORE 0 TO  LAFILESTRU[lnFileStru+lnLoop ,17],LAFILESTRU[lnFileStru+lnLoop ,18]
  NEXT

  LCTMPCURS = GFTEMPNAME()
  *CREATE TABLE (oAriaApplication.WorkDir+lcTmpCurs) FROM ARRAY laFileStru
  =GFCRTTMP(LCTMPCURS,@LAFILESTRU)
  SELECT APDIST

  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!B609918,1 MMT 05/16/2012 Payable invoice screen updates APDIST incorrectly[Start]
  *=GFSQLRUN("Select * From APDIST Where CINVNO='"+APINVHDR.CINVNO+"' AND CVENDCODE ='"+APINVHDR.CVENDCODE+"' AND CAPDSTAT <> 'V'",'APDIST')
  =gfSeek(PADR(APINVHDR.CINVNO,12)+PADR(APINVHDR.CVENDCODE,8),'APDIST','INVVEND')
  *!B609918,1 MMT 05/16/2012 Payable invoice screen updates APDIST incorrectly[EnD]
  SELECT APDIST
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

  SCAN FOR APINVHDR.CINVNO+APINVHDR.CVENDCODE = APDIST.CINVNO+APDIST.CVENDCODE .AND. CAPDSTAT <> 'V'
    SCATTER MEMVAR MEMO
    m.CSTATUS  = 'A'
    m.CAPDSTAT = 'V'
    m.NRECNO   = 0
    SELECT (LCTMPCURS)
    APPEND BLANK
    GATHER MEMVAR MEMO

    m.NAPDAMNT = -1 * m.NAPDAMNT
    m.NEQVAMNT = -1 * m.NEQVAMNT
    m.LAPDPOST = .F.
    m.CBATCHNO = ' '
    m.CTRNSLEDN= ' '
    m.CAPSESSNO= LOFORMSET.LCSEQUENCE

    m.NENTRYNO = 0

    APPEND BLANK
    GATHER MEMVAR MEMO

    SELECT APDIST
  ENDSCAN
  USE IN (LCTMPCURS)
  SELECT (LOFORMSET.LCTMPDIST)
  APPEND FROM (OARIAAPPLICATION.WORKDIR+LCTMPCURS)
  ERASE (OARIAAPPLICATION.WORKDIR+LCTMPCURS+'.DBF')  && Erase the Temp file.
  SCAN FOR CAPDSTAT <> 'V'
    IF TYPE('APINVHDR.DPOSTDATE') = 'D'
      REPLACE DAPDTRDAT WITH LOFORMSET.ARIAFORM1.DTPOSTDATE.VALUE ,;
        CAPSESSNO WITH LOFORMSET.LCSEQUENCE ,;
        CFISFYEAR WITH LOFORMSET.LCDISTYER  ,;
        CFSPPRDID WITH LOFORMSET.LCDISTPRD  ,;
        LAPDPOST  WITH .F.        ,;
        CSTATUS   WITH IIF(CSTATUS $ 'MS','M',CSTATUS)
    ELSE
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *!*	      REPLACE DAPDTRDAT WITH loFormSet.AriaForm1.DtInvDate.Value ,;
      *!*	              CAPSESSNO WITH loFormSet.lcSequence ,;
      *!*	              CFISFYEAR WITH apinvhdr.cfisfyear ,;
      *!*	              CFSPPRDID WITH apinvhdr.cfspprdid ,;
      *!*	              LAPDPOST  WITH .F.        ,;
      *!*	              CSTATUS   WITH IIF(CSTATUS $ 'MS','M',CSTATUS)
      REPLACE DAPDTRDAT WITH LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.DTINVDATE.VALUE ,;
        CAPSESSNO WITH LOFORMSET.LCSEQUENCE ,;
        CFISFYEAR WITH APINVHDR.CFISFYEAR ,;
        CFSPPRDID WITH APINVHDR.CFSPPRDID ,;
        LAPDPOST  WITH .F.        ,;
        CSTATUS   WITH IIF(CSTATUS $ 'MS','M',CSTATUS)
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    ENDIF

    *Add these line to clear the batch number and transaction
    *number and entry number in the new APDIST records [Begin]
    REPLACE CBATCHNO  WITH '' ,;
      CTRNSLEDN WITH '' ,;
      NENTRYNO  WITH 0

    *Add these line to clear the batch number [End]

  ENDSCAN
ENDIF

*Check if adding a new invoice and link to GL and there is inactive account then do not save.
IF LOFORMSET.ACTIVEMODE="A" AND LOFORMSET.ARIAFORM1.AP1.LLAPGLLINK AND !LFVLDAPACT(LOFORMSET)
  LLCSAVE = .F.
  SET EXACT &LCSAVEXACT
  =TABLEREVERT(.T.,LOFORMSET.LCTMPDIST)
  =CURSORSETPROP("Buffering",1,LOFORMSET.LCTMPDIST)
  SELECT APINVHDR
  RETURN .F.
ENDIF
*Q5: Shouldn't this checking go before updating the lcTmpDist table ?
IF !EMPTY(LOFORMSET.LCVENINVTYPES) .AND. LOFORMSET.LLUPDINVLN .AND. !LFCHCKACST(LOFORMSET)
  LLCSAVE = .F.
  SET EXACT &LCSAVEXACT
  =TABLEREVERT(.T.,LOFORMSET.LCTMPDIST)
  =CURSORSETPROP("Buffering",1,LOFORMSET.LCTMPDIST)
  SELECT APINVHDR
  RETURN .F.
ENDIF

** Begin of adding the currency to the Distribution lines.
SELECT (LOFORMSET.LCTMPDIST)
LNTOTAL = 0

SCAN FOR CAPDSTAT <> 'V'


  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *    lcTemp = 'NAPDAMNT'+loFormSet.lcExSin1+'loFormSet.AriaForm1.txtNexRate.Value'+;
  loFormSet.lcExSin2+'apinvhdr.ncurrunit'

  *!*	  REPLACE CCURRCODE WITH loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value ,;
  *!*	          NEXRATE   WITH loFormSet.AriaForm1.txtNexRate.Value ,;
  *!*	          NCURRUNIT WITH apinvhdr.ncurrunit ,;
  *!*	          NEQVAMNT  WITH ROUND(&lcTemp,2)
  LCTEMP = 'NAPDAMNT'+LOFORMSET.LCEXSIN1+'loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.Value'+;
    LOFORMSET.LCEXSIN2+'apinvhdr.ncurrunit'
  *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][Start]
  TRY
    *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][End]
    REPLACE CCURRCODE WITH LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.KEYTEXTBOX.VALUE ,;
      NEXRATE   WITH LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTNEXRATE.VALUE ,;
      NCURRUNIT WITH APINVHDR.NCURRUNIT ,;
      NEQVAMNT  WITH ROUND(&LCTEMP,2)
    *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][Start]
  CATCH
    REPLACE CCURRCODE WITH LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.KEYTEXTBOX.VALUE ,;
      NEXRATE   WITH LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTNEXRATE.VALUE ,;
      NCURRUNIT WITH APINVHDR.NCURRUNIT ,;
      NEQVAMNT  WITH 0
  ENDTRY
  *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][End]
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

  *Replacing the date and period of the posting date.
  REPLACE DAPDTRDAT WITH LOFORMSET.ARIAFORM1.DTPOSTDATE.VALUE,;
    CFISFYEAR WITH LCPSTYER  ,;
    CFSPPRDID WITH LCPSTPRD

  IF CAPDACTID <> 'A'
    LNTOTAL = LNTOTAL + NEQVAMNT
  ENDIF
ENDSCAN

LOCATE FOR CAPDSTAT <> 'V' .AND. CAPDACTID <> 'A' .AND. CSTATUS $ 'AM'

IF FOUND()
  *Get equivalent amounts

  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	  lcTemp = 'loFormSet.AriaForm1.txtInvAmount.Value'+loFormSet.lcExSin1+;
  *!*	           'loFormSet.AriaForm1.txtNexRate.Value'+loFormSet.lcExSin2+'apinvhdr.ncurrunit'
  LCTEMP = 'loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.Value'+LOFORMSET.LCEXSIN1+;
    'loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.Value'+LOFORMSET.LCEXSIN2+'apinvhdr.ncurrunit'
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][Start]
  TRY
    *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][End]
    REPLACE NEQVAMNT WITH NEQVAMNT+((ROUND(&LCTEMP,2))-LNTOTAL)
    *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][Start]
  CATCH
    REPLACE NEQVAMNT WITH NEQVAMNT+(0-LNTOTAL)
  ENDTRY
  *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][End]
ENDIF
** End of adding the currency to the Distribution lines.


*ASM, This Part was found right after the IF GFLOCK Statment, but I moved it here instead
*of the lfFormSaveFiles [Begin]
IF EMPTY(STRTRAN(STRTRAN(APINVHDR.CCHKGLACC,'-'),'0'))
  REPLACE APINVHDR.CCHKGLACC WITH SPACE(24) IN APINVHDR
ENDIF

*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*!*	IF EMPTY(STRTRAN(STRTRAN(loFormSet.DistLines.glAPActCode.KeyTextBox.Value,'-'),'0'))
*!*	  loFormSet.DistLines.glAPActCode.KeyTextBox.Value = SPACE(24)
IF EMPTY(STRTRAN(STRTRAN(LOFORMSET.ARIAFORM1.PGFPAYINV.PGDIST.GLAPACTCODE.KEYTEXTBOX.VALUE,'-'),'0'))
  LOFORMSET.ARIAFORM1.PGFPAYINV.PGDIST.GLAPACTCODE.KEYTEXTBOX.VALUE = SPACE(24)
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
ENDIF
LOFORMSET.LLSAVE = LFCHCKVOID(LOFORMSET)
IF !LOFORMSET.LLSAVE
  *-- If lcTmpDist is not balanced, invoice cannot be saved.
  =GFMODALGEN('TRM04199B00000','ALERT')
  =GFFLOCK("APINVHDR,APDIST,APVENDOR,APVENHST",.F.)
  *Old: IF WVISIBLE('CWRAPDISTR')
  *Old: =gfChClose('CWRAPDISTR')
  *Old: ENDIF
  *Old: IF USED('APVENHST') .AND. llOpVHst
  *Old: =gfCloseFile('APVENHST')
  *Old: ENDIF
  *Old: IF USED('SYCFACT') .AND. llopFact
  *Old: =gfCloseFile('SYCFACT')
  *Old: ENDIF
  SELECT APINVHDR
  SET EXACT &LCSAVEXACT
  =TABLEREVERT(.T.,LOFORMSET.LCTMPDIST)
  =CURSORSETPROP("Buffering",1,LOFORMSET.LCTMPDIST)
  SELECT APINVHDR
  RETURN .F.
ENDIF
*ASM, This Part was found right after the IF GFLOCK Statment [End]


SET EXACT &LCSAVEXACT
SELECT APINVHDR

RETURN .T.
*-- End of lfFormBeforeSave

*!*************************************************************
*! Name      : lfFormSaveFiles
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 8/16/2004
*! Purpose   : Procedure called from the Save Files Method of the formSet
*!*************************************************************
*! Parameters: The FormSet
*!*************************************************************
*! Returns   : None
*!*************************************************************
FUNCTION LFFORMSAVEFILES
LPARAMETERS LOFORMSET
*ASM, I think here ends the BeforeSave and Starts the SaveFiles Method

LOCAL LOREC, LLREVERT

LCSAVEXACT= SET('EXACT')
SET EXACT ON

*!*	ACTIVATE WINDOW trace
*!*	SUSPEND


IF !LFCHECKSQL()
  LLCSAVE = .F.
  SELECT APINVHDR
  RETURN .F.
ENDIF

** Locking the 4 files ***
*! B128863,1 ASM 08/24/2005 Fix the Bug of Saving Fox Tables even when SQL Gives errors and RollBack [Start]
*IF gfFLOCK("APINVHDR,APDIST,APVENDOR,APVENHST",.T.)
IF GFFLOCK("APINVHDR,APDIST,APVENDOR,APVENHST",.T.) AND LFCHECKSQL()
  *! B128863,1 ASM 08/24/2005 Fix the Bug of Saving Fox Tables even when SQL Gives errors and RollBack [End]

  SELECT APINVHDR

  IF LOFORMSET.ACTIVEMODE="A"
    *Old: APPEND BLANK
  ENDIF

  ** Add the new data to the record.
  *Old: GATHER FROM laData FIELDS &loFormSet.lcScFields MEMO
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	  IF loFormSet.AriaForm1.cboVendPmeth.Value = 'C'
  IF LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.CBOVENDPMETH.VALUE = 'C'
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[END]
    SELECT APINVHDR
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *REPLACE NINVADJ WITH loFormSet.AriaForm1.txtInvAmount.Value - loFormSet.AriaForm1.txtInvDisof.Value
    REPLACE NINVADJ WITH LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTINVAMOUNT.VALUE - LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTINVDISOF.VALUE
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

    *Q8: what does this function do ?
    *! B130111,1 ASM 11/01/2005 Allow the User to Edit an Invoice whose posted date is locked, but make entries on system date [Start]
    IF LOFORMSET.LLLOKPER
      LFCHECKTMPDIST(LOFORMSET)
    ENDIF
    *! B130111,1 ASM 11/01/2005 Allow the User to Edit an Invoice whose posted date is locked, but make entries on system date [End]
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *=gfTmp2Mast('APDIST',loFormSet.lcTmpDist)
    LFTMP2MAST('APDIST',LOFORMSET.LCTMPDIST)
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[END]
    *Only update the cumulative purchase if you are in ADD mode because
    *if you are in Edit mode this means that you changed the payment method
    *to Credit Card and in this case you did not purchase new thing
    SELECT APVENDOR

    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *    lcTemp = 'loFormSet.lnOldInvAmt'+loFormSet.lcExSin1+'loFormSet.AriaForm1.txtNexRate.Value'+;
    loFormSet.lcExSin2+'apinvhdr.ncurrunit'

    *!*	    REPLACE NVENBAL   WITH NVENBAL -ROUND(&lcTemp,2),;
    *!*	            DVENLPURD WITH loFormSet.AriaForm1.DtInvDate.Value
    *!*	    lcTemp = 'loFormSet.AriaForm1.txtInvAmount.Value'+loFormSet.lcExSin1+;
    *!*	             'loFormSet.AriaForm1.txtNexRate.Value'+loFormSet.lcExSin2+'apinvhdr.ncurrunit'
    *!*	    REPLACE NVENLPURA WITH ROUND(&lcTemp,2),;
    *!*	            DVENLPAYD WITH loFormSet.AriaForm1.DtInvDate.Value
    *!*	    lcTemp = '(loFormSet.AriaForm1.txtInvAmount.Value - loFormSet.AriaForm1.txtInvDisof.Value)'+;
    *!*	             loFormSet.lcExSin1+'loFormSet.AriaForm1.txtNexRate.Value'+loFormSet.lcExSin2+'apinvhdr.ncurrunit'

    LCTEMP = 'loFormSet.lnOldInvAmt'+LOFORMSET.LCEXSIN1+'loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.Value'+;
      LOFORMSET.LCEXSIN2+'apinvhdr.ncurrunit'
    *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][Start]
    TRY
      *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][End]
      REPLACE NVENBAL   WITH NVENBAL -ROUND(&LCTEMP,2),;
        DVENLPURD WITH LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.DTINVDATE.VALUE
      *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][Start]
    CATCH
      REPLACE NVENBAL   WITH NVENBAL ,;
        DVENLPURD WITH LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.DTINVDATE.VALUE
    ENDTRY
    *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][End]

    LCTEMP = 'loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.Value'+LOFORMSET.LCEXSIN1+;
      'loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.Value'+LOFORMSET.LCEXSIN2+'apinvhdr.ncurrunit'

    *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][Start]
    TRY
      *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][End]
      REPLACE NVENLPURA WITH ROUND(&LCTEMP,2),;
        DVENLPAYD WITH LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.DTINVDATE.VALUE
      *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][Start]
    CATCH
      REPLACE NVENLPURA WITH 0,;
        DVENLPAYD WITH LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.DTINVDATE.VALUE
    ENDTRY
    *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][End]
    LCTEMP = '(loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.Value - loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvDisof.Value)'+;
      LOFORMSET.LCEXSIN1+'loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.Value'+LOFORMSET.LCEXSIN2+'apinvhdr.ncurrunit'
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][Start]
    TRY
      *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][End]
      REPLACE NVENLPAYA WITH ROUND(&LCTEMP,2)
      *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][Start]
    CATCH
      REPLACE NVENLPAYA WITH 0
    ENDTRY
    *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][End]

    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *!*	    lcTemp = '(loFormSet.AriaForm1.txtInvAmount.Value - loFormSet.AriaForm1.txtInvDisof.Value)'+;
    *!*	             loFormSet.lcExSin1+'loFormSet.AriaForm1.txtNexRate.Value'+loFormSet.lcExSin2+'apinvhdr.ncurrunit'
    LCTEMP = '(loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.Value - loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvDisof.Value)'+;
      LOFORMSET.LCEXSIN1+'loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.Value'+LOFORMSET.LCEXSIN2+'apinvhdr.ncurrunit'
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

    *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][Start]
    TRY
      *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][End]
      REPLACE NVENCPAY  WITH NVENCPAY + ROUND(&LCTEMP,2)
      *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][Start]
    CATCH
      REPLACE NVENCPAY  WITH NVENCPAY
    ENDTRY
    *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][End]

    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    *!*	    lcTemp = 'loFormSet.AriaForm1.txtInvAmount.Value'+loFormSet.lcExSin1+;
    *!*	             'loFormSet.AriaForm1.txtNexRate.Value'+loFormSet.lcExSin2+'apinvhdr.ncurrunit'
    LCTEMP = 'loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.Value'+LOFORMSET.LCEXSIN1+;
      'loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.Value'+LOFORMSET.LCEXSIN2+'apinvhdr.ncurrunit'
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][Start]
    TRY
      *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][End]
      REPLACE NVENCPUR  WITH NVENCPUR +IIF(LOFORMSET.ACTIVEMODE="A",ROUND(&LCTEMP,2),0)
      *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][Start]
    CATCH
    ENDTRY
    *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][End]
    =GFADD_INFO('APVENDOR')

    SELECT APVENHST
    ** Confirm of seek with the content of ladata[1]
    LCNEWPAYFLD  = 'NVNHPAY'+ALLTRIM(STR(INT(VAL(APINVHDR.CFSPPRDID))))

    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *!*	    lcTemp = 'apinvhdr.ninvdistk'+loFormSet.lcExSin1+'loFormSet.AriaForm1.txtNexRate.Value'+;
    *!*	             +loFormSet.lcExSin2+'apinvhdr.ncurrunit'
    LCTEMP = 'apinvhdr.ninvdistk'+LOFORMSET.LCEXSIN1+'loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.Value'+;
      +LOFORMSET.LCEXSIN2+'apinvhdr.ncurrunit'
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][Start]
    TRY
      *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][End]
      REPLACE NVNHDISTKN WITH NVNHDISTKN + ROUND(&LCTEMP,2)
      *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][Start]
    CATCH
    ENDTRY
    *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][End]

    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *!*	    lcTemp = '(loFormSet.AriaForm1.txtInvAmount.Value - apinvhdr.ninvdistk)'+;
    *!*	             loFormSet.lcExSin1+'loFormSet.AriaForm1.txtNexRate.Value'+;
    *!*	             loFormSet.lcExSin2+'apinvhdr.ncurrunit'
    LCTEMP = '(loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.Value - apinvhdr.ninvdistk)'+;
      LOFORMSET.LCEXSIN1+'loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.Value'+;
      LOFORMSET.LCEXSIN2+'apinvhdr.ncurrunit'
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][Start]
    TRY
      *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][End]
      REPLACE NVNHCCPAY  WITH NVNHCCPAY  + ROUND(&LCTEMP,2)
      *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][Start]
    CATCH
    ENDTRY
    *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][End]

    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *!*	    lcTemp = '(loFormSet.AriaForm1.txtInvAmount.Value - apinvhdr.ninvdistk)'+;
    *!*	             loFormSet.lcExSin1+'loFormSet.AriaForm1.txtNexRate.Value'+;
    *!*	             loFormSet.lcExSin2+'apinvhdr.ncurrunit'
    LCTEMP = '(loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.Value - apinvhdr.ninvdistk)'+;
      LOFORMSET.LCEXSIN1+'loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.Value'+;
      LOFORMSET.LCEXSIN2+'apinvhdr.ncurrunit'
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][Start]
    TRY
      *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][End]
      REPLACE NVNHTOTPA  WITH NVNHTOTPA  + ROUND(&LCTEMP,2)
      *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][Start]
    CATCH
    ENDTRY
    *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][End]
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *!*	    lcTemp = '(loFormSet.AriaForm1.txtInvAmount.Value - apinvhdr.ninvdistk)'+;
    *!*	             loFormSet.lcExSin1+'loFormSet.AriaForm1.txtNexRate.Value'+;
    *!*	             loFormSet.lcExSin2+'apinvhdr.ncurrunit'
    LCTEMP = '(loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.Value - apinvhdr.ninvdistk)'+;
      LOFORMSET.LCEXSIN1+'loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.Value'+;
      LOFORMSET.LCEXSIN2+'apinvhdr.ncurrunit'
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][Start]
    TRY
      *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][End]
      REPLACE  &LCNEWPAYFLD WITH EVALUATE(LCNEWPAYFLD) + ROUND(&LCTEMP,2)
      *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][Start]
    CATCH
    ENDTRY
    *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][End]

  ELSE
    *! B130111,1 ASM 11/01/2005 Allow the User to Edit an Invoice whose posted date is locked, but make entries on system date [Start]
    IF LOFORMSET.LLLOKPER
      LFCHECKTMPDIST(LOFORMSET)
    ENDIF
    *! B130111,1 ASM 11/01/2005 Allow the User to Edit an Invoice whose posted date is locked, but make entries on system date [End]

    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *=gfTmp2Mast('APDIST',loFormSet.lcTmpDist)
    LFTMP2MAST('APDIST',LOFORMSET.LCTMPDIST)
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]


    SELECT APVENDOR

    **! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *!*	    lcTemp = '(loFormSet.AriaForm1.txtInvAmount.Value-loFormSet.lnOldInvAmt)'+;
    *!*	             loFormSet.lcExSin1+'loFormSet.AriaForm1.txtNexRate.Value'+;
    *!*	             loFormSet.lcExSin2+'apinvhdr.ncurrunit'
    LCTEMP = '(loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.Value-loFormSet.lnOldInvAmt)'+;
      LOFORMSET.LCEXSIN1+'loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.Value'+;
      LOFORMSET.LCEXSIN2+'apinvhdr.ncurrunit'
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][Start]
    TRY
      *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][End]
      REPLACE NVENBAL   WITH NVENBAL  + ROUND(&LCTEMP,2)
      *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][Start]
    CATCH
    ENDTRY
    *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][End]

    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *!*	    lcTemp = '(loFormSet.AriaForm1.txtInvAmount.Value-loFormSet.lnOldInvAmt)'+;
    *!*	             loFormSet.lcExSin1+'loFormSet.AriaForm1.txtNexRate.Value'+;
    *!*	             loFormSet.lcExSin2+'apinvhdr.ncurrunit'
    *!*	    REPLACE NVENCPUR  WITH NVENCPUR + ROUND(&lcTemp,2), ;
    *!*	            DVENLPURD WITH loFormSet.AriaForm1.DtInvDate.Value
    *!*	    lcTemp = 'loFormSet.AriaForm1.txtInvAmount.Value'+loFormSet.lcExSin1+;
    *!*	             'loFormSet.AriaForm1.txtNexRate.Value'+loFormSet.lcExSin2+'apinvhdr.ncurrunit'
    LCTEMP = '(loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.Value-loFormSet.lnOldInvAmt)'+;
      LOFORMSET.LCEXSIN1+'loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.Value'+;
      LOFORMSET.LCEXSIN2+'apinvhdr.ncurrunit'
    *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][Start]
    TRY
      *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][End]
      REPLACE NVENCPUR  WITH NVENCPUR + ROUND(&LCTEMP,2), ;
        DVENLPURD WITH LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.DTINVDATE.VALUE
      *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][Start]
    CATCH
      REPLACE DVENLPURD WITH LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.DTINVDATE.VALUE
    ENDTRY
    *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][End]


    LCTEMP = 'loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.Value'+LOFORMSET.LCEXSIN1+;
      'loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.Value'+LOFORMSET.LCEXSIN2+'apinvhdr.ncurrunit'
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][Start]
    TRY
      *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][End]
      REPLACE NVENLPURA WITH ROUND(&LCTEMP,2)
      *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][Start]
    CATCH
    ENDTRY
    *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][End]
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *!*	    IF loFormSet.AriaForm1.txtInvAmount.Value < 0
    *!*	      lcTemp = '(loFormSet.lnOldInvAmt - loFormSet.AriaForm1.txtInvAmount.Value)'+;
    *!*	               loFormSet.lcExSin1+'loFormSet.AriaForm1.txtNexRate.Value'+;
    *!*	               loFormSet.lcExSin2+'apinvhdr.ncurrunit'
    IF LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTINVAMOUNT.VALUE < 0
      LCTEMP = '(loFormSet.lnOldInvAmt - loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.Value)'+;
        LOFORMSET.LCEXSIN1+'loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.Value'+;
        LOFORMSET.LCEXSIN2+'apinvhdr.ncurrunit'
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][Start]
      TRY
        *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][End]
        REPLACE NVENOPNDR WITH NVENOPNDR + ROUND(&LCTEMP,2)
        *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][Start]
      CATCH
      ENDTRY
      *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][End]

    ENDIF
    =GFADD_INFO('APVENDOR')
  ENDIF
  SELECT APVENHST
  LCNEWPERFLD  = 'NVNHPUR'+ALLTRIM(STR(INT(VAL(APINVHDR.CFSPPRDID))))

  LCOLDPERFLD  = 'NVNHPUR'+ALLTRIM(STR(INT(VAL(LOFORMSET.LCOLDPERIOD))))

  IF LOFORMSET.LCOLDYEAR = APINVHDR.CFISFYEAR .OR. LOFORMSET.ACTIVEMODE="A"
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *!*	    lcTemp = '(loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvDisof.Value - loFormSet.lnOldDiscOf)'+;
    *!*	             loFormSet.lcExSin1+'loFormSet.AriaForm1.txtNexRate.Value'+;
    *!*	             loFormSet.lcExSin2+'apinvhdr.ncurrunit'
    LCTEMP = '(loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvDisof.Value - loFormSet.lnOldDiscOf)'+;
      LOFORMSET.LCEXSIN1+'loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.Value'+;
      LOFORMSET.LCEXSIN2+'apinvhdr.ncurrunit'
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][Start]
    TRY
      *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][End]
      REPLACE NVNHDISOF WITH NVNHDISOF + ROUND(&LCTEMP,2)
      *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][Start]
    CATCH
    ENDTRY
    *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][End]
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *    lcTemp = '(loFormSet.AriaForm1.txtInvAmount.Value - loFormSet.lnOldInvAmt)'+;
    loFormSet.lcExSin1+'loFormSet.AriaForm1.txtNexRate.Value'+;
    loFormSet.lcExSin2+'apinvhdr.ncurrunit'
    LCTEMP = '(loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.Value - loFormSet.lnOldInvAmt)'+;
      LOFORMSET.LCEXSIN1+'loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.Value'+;
      LOFORMSET.LCEXSIN2+'apinvhdr.ncurrunit'
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[END]
    *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][Start]
    TRY
      *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][End]
      REPLACE NVNHPURCH WITH NVNHPURCH + ROUND(&LCTEMP,2)
      *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][Start]
    CATCH
    ENDTRY
    *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][End]

    =GFADD_INFO('APVENHST')
    IF LOFORMSET.LCOLDPERIOD = APINVHDR.CFSPPRDID .OR. LOFORMSET.ACTIVEMODE="A"

      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *!*	      lcTemp = '(loFormSet.AriaForm1.txtInvAmount.Value - loFormSet.lnOldInvAmt)'+;
      *!*	               loFormSet.lcExSin1+'loFormSet.AriaForm1.txtNexRate.Value'+;
      *!*	               loFormSet.lcExSin2+'apinvhdr.ncurrunit'
      LCTEMP = '(loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.Value - loFormSet.lnOldInvAmt)'+;
        LOFORMSET.LCEXSIN1+'loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.Value'+;
        LOFORMSET.LCEXSIN2+'apinvhdr.ncurrunit'

      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][Start]
      TRY
        *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][End]
        REPLACE &LCNEWPERFLD WITH EVALUATE(LCNEWPERFLD) + ROUND(&LCTEMP,2)
        *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][Start]
      CATCH
        REPLACE &LCNEWPERFLD WITH EVALUATE(LCNEWPERFLD)
      ENDTRY
      *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][End]

    ELSE

      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *!*	      lcTemp = 'loFormSet.lnOldInvAmt'+loFormSet.lcExSin1+;
      *!*	               'loFormSet.AriaForm1.txtNexRate.Value'+loFormSet.lcExSin2+'apinvhdr.ncurrunit'
      LCTEMP = 'loFormSet.lnOldInvAmt'+LOFORMSET.LCEXSIN1+;
        'loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.Value'+LOFORMSET.LCEXSIN2+'apinvhdr.ncurrunit'
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][Start]
      TRY
        *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][End]
        REPLACE &LCOLDPERFLD WITH EVALUATE(LCOLDPERFLD) - ROUND(&LCTEMP,2)
        *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][Start]
      CATCH
        REPLACE &LCOLDPERFLD WITH EVALUATE(LCOLDPERFLD)
      ENDTRY
      *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][End]

      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *!*	      lcTemp = 'loFormSet.AriaForm1.txtInvAmount.Value'+loFormSet.lcExSin1+;
      *!*	                'loFormSet.AriaForm1.txtNexRate.Value'+loFormSet.lcExSin2+'apinvhdr.ncurrunit'
      LCTEMP = 'loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.Value'+LOFORMSET.LCEXSIN1+;
        'loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.Value'+LOFORMSET.LCEXSIN2+'apinvhdr.ncurrunit'
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][Start]
      TRY
        *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][End]
        REPLACE &LCNEWPERFLD WITH EVALUATE(LCNEWPERFLD) + ROUND(&LCTEMP,2)
        *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][Start]
      CATCH
        REPLACE &LCNEWPERFLD WITH EVALUATE(LCNEWPERFLD)
      ENDTRY
      *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][End]
    ENDIF
  ELSE

    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *    lcTemp = 'loFormSet.AriaForm1.txtInvDisof.Value'+loFormSet.lcExSin1+;
    'loFormSet.AriaForm1.txtNexRate.Value'+loFormSet.lcExSin2+'apinvhdr.ncurrunit'
    LCTEMP = 'loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvDisof.Value'+LOFORMSET.LCEXSIN1+;
      'loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.Value'+LOFORMSET.LCEXSIN2+'apinvhdr.ncurrunit'
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][Start]
    TRY
      *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][End]
      REPLACE NVNHDISOF    WITH NVNHDISOF + ROUND(&LCTEMP,2)
      *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][Start]
    CATCH
    ENDTRY
    *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][End]
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *!*	    lcTemp = 'loFormSet.AriaForm1.txtInvAmount.Value'+loFormSet.lcExSin1+;
    *!*	             'loFormSet.AriaForm1.txtNexRate.Value'+loFormSet.lcExSin2+'apinvhdr.ncurrunit'
    LCTEMP = 'loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.Value'+LOFORMSET.LCEXSIN1+;
      'loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.Value'+LOFORMSET.LCEXSIN2+'apinvhdr.ncurrunit'
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][Start]
    TRY
      *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][End]
      REPLACE NVNHPURCH    WITH NVNHPURCH + ROUND(&LCTEMP,2)
      *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][Start]
    CATCH
    ENDTRY
    *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][End]

    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *!*	    lcTemp = 'loFormSet.AriaForm1.txtInvAmount.Value'+loFormSet.lcExSin1+;
    *!*	             'loFormSet.AriaForm1.txtNexRate.Value'+loFormSet.lcExSin2+'apinvhdr.ncurrunit'
    LCTEMP = 'loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.Value'+LOFORMSET.LCEXSIN1+;
      'loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.Value'+LOFORMSET.LCEXSIN2+'apinvhdr.ncurrunit'
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[END]
    *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][Start]
    TRY
      *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][End]
      REPLACE &LCNEWPERFLD WITH EVALUATE(LCNEWPERFLD) + ROUND(&LCTEMP,2)
      *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][Start]
    CATCH
      REPLACE &LCNEWPERFLD WITH EVALUATE(LCNEWPERFLD)
    ENDTRY
    *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][End]

    =GFADD_INFO('APVENHST')
    IF SEEK(LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE+LOFORMSET.LCOLDYEAR)

      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *!*	      lcTemp = 'loFormSet.lnOldDiscOf'+loFormSet.lcExSin1+;
      *!*	               'loFormSet.AriaForm1.txtNexRate.Value'+loFormSet.lcExSin2+'apinvhdr.ncurrunit'
      LCTEMP = 'loFormSet.lnOldDiscOf'+LOFORMSET.LCEXSIN1+;
        'loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.Value'+LOFORMSET.LCEXSIN2+'apinvhdr.ncurrunit'
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][Start]
      TRY
        *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][End]
        REPLACE NVNHDISOF  WITH NVNHDISOF - ROUND(&LCTEMP,2)
        *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][Start]
      CATCH
      ENDTRY
      *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][End]
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *!*	      lcTemp = 'loFormSet.lnOldInvAmt'+loFormSet.lcExSin1+;
      *!*	               'loFormSet.AriaForm1.txtNexRate.Value'+loFormSet.lcExSin2+'apinvhdr.ncurrunit'
      LCTEMP = 'loFormSet.lnOldInvAmt'+LOFORMSET.LCEXSIN1+;
        'loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.Value'+LOFORMSET.LCEXSIN2+'apinvhdr.ncurrunit'
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][Start]
      TRY
        *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][End]
        REPLACE NVNHPURCH  WITH NVNHPURCH - ROUND(&LCTEMP,2)
        *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][Start]
      CATCH
      ENDTRY
      *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][End]
      IF LOFORMSET.ACTIVEMODE="E"

        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        *!*	        lcTemp = 'loFormSet.lnOldInvAmt'+loFormSet.lcExSin1+;
        *!*	                 'loFormSet.AriaForm1.txtNexRate.Value'+loFormSet.lcExSin2+'apinvhdr.ncurrunit'
        LCTEMP = 'loFormSet.lnOldInvAmt'+LOFORMSET.LCEXSIN1+;
          'loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.Value'+LOFORMSET.LCEXSIN2+'apinvhdr.ncurrunit'
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
        *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][Start]
        TRY
          *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][End]
          REPLACE &LCOLDPERFLD WITH EVALUATE(LCOLDPERFLD) - ROUND(&LCTEMP,2)
          *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][Start]
        CATCH
          REPLACE &LCOLDPERFLD WITH EVALUATE(LCOLDPERFLD)
        ENDTRY
        *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][End]
      ENDIF
      =GFADD_INFO('APVENHST')
    ENDIF
  ENDIF

  SELECT APINVHDR
  LOFORMSET.LNINVADJ  = NINVADJ
  LCVENPRIOR= APVENDOR.CVENPRIOR
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	  IF loFormSet.AriaForm1.cboVendPmeth.Value = 'C'
  * laData_15 = loFormSet.AriaForm1.cboTermCode.Value
  *!*	    laData_19 = loFormSet.AriaForm1.txtterdued.Value
  *!*	    laData_16 = loFormSet.AriaForm1.txtTerDiscr.Value
  *!*	    laData_24 = loFormSet.AriaForm1.txtTerDiscd.Value

  IF LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.CBOVENDPMETH.VALUE = 'C'

    LADATA_15 = LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.CBOTERMCODE.VALUE
    LADATA_19 = LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTTERDUED.VALUE
    LADATA_16 = LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTTERDISCR.VALUE
    LADATA_24 = LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTTERDISCD.VALUE
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

    LCOLDDIV  = LOFORMSET.LCDIVISION           && Division

    *Get the creditor data from the vendor file
    SELECT APVENDOR

    LNCR_REC = RECNO()

    SEEK APINVHDR.CVENCCVEN

    *B600597,1 Save the creditor data in temp variables
    LCVENPMETH = CVENPMETH           && Payment method
    LOFORMSET.LCDIVISION = CDIVISION           && Division
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *loFormSet.AriaForm1.cboTermCode.Value = cTermCode           && Term code
    LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.CBOTERMCODE.VALUE = CTERMCODE           && Term code
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

    GOTO LNCR_REC

    *Get the creditor data from the codes file
    DECLARE  LATERMARRY[3,2]
    LATERMARRY[1,1] = 'NTERDISCR'
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *laTermArry[1,2] = 'loFormSet.AriaForm1.txtTerDiscr.Value'
    LATERMARRY[1,2] = 'loFormSet.AriaForm1.pgfpayInv.pgHead.txtTerDiscr.Value'
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

    LATERMARRY[2,1] = 'NTERDUED'

    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *laTermArry[2,2] = 'loFormSet.AriaForm1.txtterdued.Value'
    LATERMARRY[2,2] = 'loFormSet.AriaForm1.pgfpayInv.pgHead.txtterdued.Value'
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

    LATERMARRY[3,1] = 'NTERDISCD'

    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *laTermArry[3,2] = 'loFormSet.AriaForm1.txtTerDiscd.Value'
    LATERMARRY[3,2] = 'loFormSet.AriaForm1.pgfpayInv.pgHead.txtTerDiscd.Value'
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[END]

    *Not calculate the due days from term code if the screen in edit mode
    IF LOFORMSET.ACTIVEMODE="A"
      DIMENSION LATERMARY[ALEN(loFormSet.laTermAry,1),ALEN(loFormSet.laTermAry,2)]
      =ACOPY(LOFORMSET.LATERMARY,LATERMARY)

      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *=gfRltFld(loFormSet.AriaForm1.cboTermCode.Value , @laTermAry , 'CTERMCODE')
      =GFRLTFLD(LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.CBOTERMCODE.VALUE , @LATERMARY , 'CTERMCODE')
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[END]
      =ACOPY(LATERMARY,LOFORMSET.LATERMARY)
    ENDIF



    SELECT APINVHDR


    LNSAVRECNO = RECNO()
    SCATTER NAME LOREC
    APPEND BLANK

    IF TYPE('APINVHDR.DPOSTDATE') = 'D'
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *!*	      REPLACE CVENDCODE WITH loRec.cvenccven,;
      *!*	              CINVNO    WITH loRec.cvenccinv,;
      *!*	              CAPACCT   WITH IIF(EMPTY(STRTRAN(STRTRAN(loFormSet.lcAccount,'-'),'0')),;
      *!*	                                 ' ', loFormSet.lcAccount) ,;
      *!*	              CDIVISION WITH loFormSet.lcDivision,;
      *!*	              DINVDATE  WITH loFormSet.AriaForm1.DtInvDate.Value,;
      *!*	              CFISFYEAR WITH loRec.CFISFYEAR,;
      *!*	              CFSPPRDID WITH loRec.CFSPPRDID,;
      *!*	              CINVREF   WITH loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value ,;
      *!*	              CINVREMIT WITH 'V'       ,;
      *!*	              NINVAMNT  WITH loFormSet.lnInvAdj  ,;
      *!*	              CVENPRIOR WITH lcVenPrior,;
      *!*	              CVENPMETH WITH lcVenPmeth,;
      *!*	              CTERMCODE WITH loFormSet.AriaForm1.cboTermCode.Value,;
      *!*	              NTERDUED  WITH loFormSet.AriaForm1.txtterdued.Value,;
      *!*	              NTERDISCD WITH loFormSet.AriaForm1.txtTerDiscd.Value,;
      *!*	              NTERDISCR WITH loFormSet.AriaForm1.txtTerDiscr.Value,;
      *!*	              DINVDUDAT WITH loFormSet.AriaForm1.dtInvDuDat.Value,;
      *!*	              CVENCCVEN WITH loFormSet.AriaForm1.KBVendCode.KeyTextBox.Value ,;
      *!*	              CVENCCINV WITH loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value,;
      *!*	              CCURRCODE WITH loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value,;
      *!*	              NEXRATE   WITH loFormSet.AriaForm1.txtNexRate.Value,;
      *!*	              NCURRUNIT WITH loRec.NCURRUNIT,;
      *!*	              DPOSTDATE WITH loFormSet.AriaForm1.DtPostDate.Value
      REPLACE CVENDCODE WITH LOREC.CVENCCVEN,;
        CINVNO    WITH LOREC.CVENCCINV,;
        CAPACCT   WITH IIF(EMPTY(STRTRAN(STRTRAN(LOFORMSET.LCACCOUNT,'-'),'0')),;
        ' ', LOFORMSET.LCACCOUNT) ,;
        CDIVISION WITH LOFORMSET.LCDIVISION,;
        DINVDATE  WITH LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.DTINVDATE.VALUE,;
        CFISFYEAR WITH LOREC.CFISFYEAR,;
        CFSPPRDID WITH LOREC.CFSPPRDID,;
        CINVREF   WITH LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE ,;
        CINVREMIT WITH 'V'       ,;
        NINVAMNT  WITH LOFORMSET.LNINVADJ  ,;
        CVENPRIOR WITH LCVENPRIOR,;
        CVENPMETH WITH LCVENPMETH,;
        CTERMCODE WITH LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.CBOTERMCODE.VALUE,;
        NTERDUED  WITH LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTTERDUED.VALUE,;
        NTERDISCD WITH LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTTERDISCD.VALUE,;
        NTERDISCR WITH LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTTERDISCR.VALUE,;
        DINVDUDAT WITH LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.DTINVDUDAT.VALUE,;
        CVENCCVEN WITH LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE ,;
        CVENCCINV WITH LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE,;
        CCURRCODE WITH LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.KEYTEXTBOX.VALUE,;
        NEXRATE   WITH LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTNEXRATE.VALUE,;
        NCURRUNIT WITH LOREC.NCURRUNIT,;
        DPOSTDATE WITH LOFORMSET.ARIAFORM1.DTPOSTDATE.VALUE
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    ELSE
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *!*	      REPLACE CVENDCODE WITH loRec.cvenccven,;
      *!*	              CINVNO    WITH loRec.cvenccinv,;
      *!*	              CAPACCT   WITH IIF(EMPTY(STRTRAN(STRTRAN(loFormSet.lcAccount,'-'),'0')),;
      *!*	                                 ' ', loFormSet.lcAccount) ,;
      *!*	              CDIVISION WITH loFormSet.lcDivision,;
      *!*	              DINVDATE  WITH loFormSet.AriaForm1.DtInvDate.Value,;
      *!*	              CFISFYEAR WITH loRec.CFISFYEAR,;
      *!*	              CFSPPRDID WITH loRec.CFSPPRDID,;
      *!*	              CINVREF   WITH loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value ,;
      *!*	              CINVREMIT WITH 'V'       ,;
      *!*	              NINVAMNT  WITH loFormSet.lnInvAdj  ,;
      *!*	              CVENPRIOR WITH lcVenPrior,;
      *!*	              CVENPMETH WITH lcVenPmeth,;
      *!*	              CTERMCODE WITH loFormSet.AriaForm1.cboTermCode.Value,;
      *!*	              NTERDUED  WITH loFormSet.AriaForm1.txtterdued.Value,;
      *!*	              NTERDISCD WITH loFormSet.AriaForm1.txtTerDiscd.Value,;
      *!*	              NTERDISCR WITH loFormSet.AriaForm1.txtTerDiscr.Value,;
      *!*	              DINVDUDAT WITH loFormSet.AriaForm1.dtInvDuDat.Value,;
      *!*	              CVENCCVEN WITH loFormSet.AriaForm1.KBVendCode.KeyTextBox.Value ,;
      *!*	              CVENCCINV WITH loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value,;
      *!*	              CCURRCODE WITH loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value,;
      *!*	              NEXRATE   WITH loFormSet.AriaForm1.txtNexRate.Value,;
      *!*	              NCURRUNIT WITH loRec.NCURRUNIT
      REPLACE CVENDCODE WITH LOREC.CVENCCVEN,;
        CINVNO    WITH LOREC.CVENCCINV,;
        CAPACCT   WITH IIF(EMPTY(STRTRAN(STRTRAN(LOFORMSET.LCACCOUNT,'-'),'0')),;
        ' ', LOFORMSET.LCACCOUNT) ,;
        CDIVISION WITH LOFORMSET.LCDIVISION,;
        DINVDATE  WITH LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.DTINVDATE.VALUE,;
        CFISFYEAR WITH LOREC.CFISFYEAR,;
        CFSPPRDID WITH LOREC.CFSPPRDID,;
        CINVREF   WITH LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE ,;
        CINVREMIT WITH 'V'       ,;
        NINVAMNT  WITH LOFORMSET.LNINVADJ  ,;
        CVENPRIOR WITH LCVENPRIOR,;
        CVENPMETH WITH LCVENPMETH,;
        CTERMCODE WITH LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.CBOTERMCODE.VALUE,;
        NTERDUED  WITH LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTTERDUED.VALUE,;
        NTERDISCD WITH LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTTERDISCD.VALUE,;
        NTERDISCR WITH LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTTERDISCR.VALUE,;
        DINVDUDAT WITH LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.DTINVDUDAT.VALUE,;
        CVENCCVEN WITH LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE ,;
        CVENCCINV WITH LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE,;
        CCURRCODE WITH LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.KEYTEXTBOX.VALUE,;
        NEXRATE   WITH LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTNEXRATE.VALUE,;
        NCURRUNIT WITH LOREC.NCURRUNIT
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    ENDIF

    =GFADD_INFO('APINVHDR')
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    =GFREPLACE("")
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[END]
    *Save old array data
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *loFormSet.AriaForm1.cboTermCode.Value = laData_15
    *!*	    loFormSet.AriaForm1.txtterdued.Value = laData_19
    *!*	    loFormSet.AriaForm1.txtTerDiscr.Value = laData_16
    *!*	    loFormSet.AriaForm1.txtTerDiscd.Value = laData_24
    LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.CBOTERMCODE.VALUE = LADATA_15
    LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTTERDUED.VALUE = LADATA_19
    LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTTERDISCR.VALUE = LADATA_16
    LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTTERDISCD.VALUE = LADATA_24
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[END]
    LOFORMSET.LCDIVISION  = LCOLDDIV            && Division



    SELECT APDIST
    APPEND BLANK


    IF TYPE('APINVHDR.DPOSTDATE') = 'D'

      **! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *!*	      REPLACE CVENDCODE WITH apinvhdr.cvenccven,;
      *!*	              CINVNO    WITH apinvhdr.cvenccinv,;
      *!*	              DAPDTRDAT WITH loFormSet.AriaForm1.DtPostDate.Value,;
      *!*	              LAPDPOST  WITH .F.       ,;
      *!*	              CAPDREF   WITH loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value ,;
      *!*	              CAPDGLACT WITH loFormSet.DistLines.glAPActCode.KeyTextBox.Value,;
      *!*	              CAPDTRTYP WITH 'I'       ,;
      *!*	              NAPDAMNT  WITH loFormSet.AriaForm1.txtInvAmount.Value,;
      *!*	              CFISFYEAR WITH loFormSet.lcDistYer ,;
      *!*	              CFSPPRDID WITH loFormSet.lcDistPrd ,;
      *!*	              CAPSESSNO WITH loFormSet.lcSequence,;
      *!*	              CCURRCODE WITH loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value,;
      *!*	              NEXRATE   WITH loFormSet.AriaForm1.txtNexRate.Value,;
      *!*	              NCURRUNIT WITH apinvhdr.ncurrunit
      *!*	      lcTemp = 'loFormSet.AriaForm1.txtInvAmount.Value'+loFormSet.lcExSin1+;
      *!*	               'loFormSet.AriaForm1.txtNexRate.Value'+loFormSet.lcExSin2+'apinvhdr.ncurrunit'
      REPLACE CVENDCODE WITH APINVHDR.CVENCCVEN,;
        CINVNO    WITH APINVHDR.CVENCCINV,;
        DAPDTRDAT WITH LOFORMSET.ARIAFORM1.DTPOSTDATE.VALUE,;
        LAPDPOST  WITH .F.       ,;
        CAPDREF   WITH LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE ,;
        CAPDGLACT WITH LOFORMSET.ARIAFORM1.PGFPAYINV.PGDIST.GLAPACTCODE.KEYTEXTBOX.VALUE,;
        CAPDTRTYP WITH 'I'       ,;
        NAPDAMNT  WITH LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTINVAMOUNT.VALUE,;
        CFISFYEAR WITH LOFORMSET.LCDISTYER ,;
        CFSPPRDID WITH LOFORMSET.LCDISTPRD ,;
        CAPSESSNO WITH LOFORMSET.LCSEQUENCE,;
        CCURRCODE WITH LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.KEYTEXTBOX.VALUE,;
        NEXRATE   WITH LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTNEXRATE.VALUE,;
        NCURRUNIT WITH APINVHDR.NCURRUNIT
      LCTEMP = 'loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.Value'+LOFORMSET.LCEXSIN1+;
        'loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.Value'+LOFORMSET.LCEXSIN2+'apinvhdr.ncurrunit'
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][Start]
      TRY
        *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][End]
        REPLACE NEQVAMNT  WITH ROUND(&LCTEMP,2), CAPDACTID WITH 'A'
        *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][Start]
      CATCH
        REPLACE NEQVAMNT  WITH 0, CAPDACTID WITH 'A'
      ENDTRY
      *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][End]
    ELSE
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *!*	      REPLACE CVENDCODE WITH apinvhdr.cvenccven ,;
      *!*	              CINVNO    WITH apinvhdr.cvenccinv ,;
      *!*	              DAPDTRDAT WITH loFormSet.AriaForm1.DtInvDate.Value,;
      *!*	              LAPDPOST  WITH .F.       ,;
      *!*	              CAPDREF   WITH loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value ,;
      *!*	              CAPDGLACT WITH loFormSet.DistLines.glAPActCode.KeyTextBox.Value,;
      *!*	              CAPDTRTYP WITH 'I'       ,;
      *!*	              NAPDAMNT  WITH loFormSet.AriaForm1.txtInvAmount.Value,;
      *!*	              CFISFYEAR WITH apinvhdr.cfisfyear,;
      *!*	              CFSPPRDID WITH apinvhdr.cfspprdid,;
      *!*	              CAPSESSNO WITH loFormSet.lcSequence,;
      *!*	              CCURRCODE WITH loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value,;
      *!*	              NEXRATE   WITH loFormSet.AriaForm1.txtNexRate.Value,;
      *!*	              NCURRUNIT WITH apinvhdr.ncurrunit
      *lcTemp = 'loFormSet.AriaForm1.txtInvAmount.Value'+loFormSet.lcExSin1+;
      'loFormSet.AriaForm1.txtNexRate.Value'+loFormSet.lcExSin2+'apinvhdr.ncurrunit'

      REPLACE CVENDCODE WITH APINVHDR.CVENCCVEN ,;
        CINVNO    WITH APINVHDR.CVENCCINV ,;
        DAPDTRDAT WITH LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.DTINVDATE.VALUE,;
        LAPDPOST  WITH .F.       ,;
        CAPDREF   WITH LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE ,;
        CAPDGLACT WITH LOFORMSET.ARIAFORM1.PGFPAYINV.PGDIST.GLAPACTCODE.KEYTEXTBOX.VALUE,;
        CAPDTRTYP WITH 'I'       ,;
        NAPDAMNT  WITH LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTINVAMOUNT.VALUE,;
        CFISFYEAR WITH APINVHDR.CFISFYEAR,;
        CFSPPRDID WITH APINVHDR.CFSPPRDID,;
        CAPSESSNO WITH LOFORMSET.LCSEQUENCE,;
        CCURRCODE WITH LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.KEYTEXTBOX.VALUE,;
        NEXRATE   WITH LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTNEXRATE.VALUE,;
        NCURRUNIT WITH APINVHDR.NCURRUNIT

      LCTEMP = 'loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.Value'+LOFORMSET.LCEXSIN1+;
        'loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.Value'+LOFORMSET.LCEXSIN2+'apinvhdr.ncurrunit'
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][Start]
      TRY
        *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][End]
        REPLACE NEQVAMNT  WITH ROUND(&LCTEMP,2), CAPDACTID WITH 'A'
        *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][Start]
      CATCH
        REPLACE NEQVAMNT  WITH 0, CAPDACTID WITH 'A'
      ENDTRY
      *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][End]
    ENDIF

    =GFADD_INFO('APDIST')
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    =GFREPLACE("")
    =GFREPLACE('MAPDIST with APDIST.MAPDIST')
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[END]

    APPEND BLANK

    IF TYPE('APINVHDR.DPOSTDATE') = 'D'

      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *!*	      REPLACE CVENDCODE WITH apinvhdr.cvenccven ;
      *!*	              CINVNO    WITH apinvhdr.cvenccinv ;
      *!*	              DAPDTRDAT WITH loFormSet.AriaForm1.DtPostDate.Value,;
      *!*	              LAPDPOST  WITH .F.       ,;
      *!*	              CAPDREF   WITH loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value ,;
      *!*	              CAPDTRTYP WITH 'I'       ,;
      *!*	              CAPDGLACT WITH IIF(EMPTY(STRTRAN(STRTRAN(loFormSet.lcAccount,'-'),'0')),;
      *!*	                                 ' ', loFormSet.lcAccount) ,;
      *!*	              NAPDAMNT  WITH loFormSet.AriaForm1.txtInvDisof.Value - loFormSet.AriaForm1.txtInvAmount.Value;
      *!*	              CFISFYEAR WITH loFormSet.lcDistYer ,;
      *!*	              CFSPPRDID WITH loFormSet.lcDistPrd ,;
      *!*	              CAPSESSNO WITH loFormSet.lcSequence,;
      *!*	              CCURRCODE WITH loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value,;
      *!*	              NEXRATE   WITH loFormSet.AriaForm1.txtNexRate.Value,;
      *!*	              NCURRUNIT WITH apinvhdr.ncurrunit
      *!*	      lcTemp = 'NAPDAMNT'+loFormSet.lcExSin1+'loFormSet.AriaForm1.txtNexRate.Value'+;
      *!*	               loFormSet.lcExSin2+'apinvhdr.ncurrunit'
      REPLACE CVENDCODE WITH APINVHDR.CVENCCVEN ;
        CINVNO    WITH APINVHDR.CVENCCINV ;
        DAPDTRDAT WITH LOFORMSET.ARIAFORM1.DTPOSTDATE.VALUE,;
        LAPDPOST  WITH .F.       ,;
        CAPDREF   WITH LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE ,;
        CAPDTRTYP WITH 'I'       ,;
        CAPDGLACT WITH IIF(EMPTY(STRTRAN(STRTRAN(LOFORMSET.LCACCOUNT,'-'),'0')),;
        ' ', LOFORMSET.LCACCOUNT) ,;
        NAPDAMNT  WITH LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTINVDISOF.VALUE - LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTINVAMOUNT.VALUE;
        CFISFYEAR WITH LOFORMSET.LCDISTYER ,;
        CFSPPRDID WITH LOFORMSET.LCDISTPRD ,;
        CAPSESSNO WITH LOFORMSET.LCSEQUENCE,;
        CCURRCODE WITH LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.KEYTEXTBOX.VALUE,;
        NEXRATE   WITH LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTNEXRATE.VALUE,;
        NCURRUNIT WITH APINVHDR.NCURRUNIT

      LCTEMP = 'NAPDAMNT'+LOFORMSET.LCEXSIN1+'loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.Value'+;
        LOFORMSET.LCEXSIN2+'apinvhdr.ncurrunit'
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][Start]
      TRY
        *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][End]
        REPLACE NEQVAMNT  WITH ROUND(&LCTEMP,2), CAPDACTID WITH 'A'
        *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][Start]
      CATCH
        REPLACE NEQVAMNT  WITH 0, CAPDACTID WITH 'A'
      ENDTRY
      *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][End]
    ELSE
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *!*	      REPLACE CVENDCODE WITH apinvhdr.cvenccven ;
      *!*	              CINVNO    WITH apinvhdr.cvenccinv ;
      *!*	              DAPDTRDAT WITH loFormSet.AriaForm1.DtInvDate.Value,;
      *!*	              LAPDPOST  WITH .F.       ,;
      *!*	              CAPDREF   WITH loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value ,;
      *!*	              CAPDTRTYP WITH 'I'       ,;
      *!*	              CAPDGLACT WITH IIF(EMPTY(STRTRAN(STRTRAN(loFormSet.lcAccount,'-'),'0')),;
      *!*	                                 ' ', loFormSet.lcAccount) ,;
      *!*	              NAPDAMNT  WITH loFormSet.AriaForm1.txtInvDisof.Value - loFormSet.AriaForm1.txtInvAmount.Value,;
      *!*	              CFISFYEAR WITH apinvhdr.cfisfyear,;
      *!*	              CFSPPRDID WITH apinvhdr.cfspprdid,;
      *!*	              CAPSESSNO WITH loFormSet.lcSequence,;
      *!*	              CCURRCODE WITH loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value,;
      *!*	              NEXRATE   WITH loFormSet.AriaForm1.txtNexRate.Value,;
      *!*	              NCURRUNIT WITH apinvhdr.ncurrunit
      *!*	      lcTemp = 'NAPDAMNT'+loFormSet.lcExSin1+'loFormSet.AriaForm1.txtNexRate.Value'+;
      *!*	               loFormSet.lcExSin2+'apinvhdr.ncurrunit'
      REPLACE CVENDCODE WITH APINVHDR.CVENCCVEN ;
        CINVNO    WITH APINVHDR.CVENCCINV ;
        DAPDTRDAT WITH LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.DTINVDATE.VALUE,;
        LAPDPOST  WITH .F.       ,;
        CAPDREF   WITH LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE ,;
        CAPDTRTYP WITH 'I'       ,;
        CAPDGLACT WITH IIF(EMPTY(STRTRAN(STRTRAN(LOFORMSET.LCACCOUNT,'-'),'0')),;
        ' ', LOFORMSET.LCACCOUNT) ,;
        NAPDAMNT  WITH LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTINVDISOF.VALUE - LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTINVAMOUNT.VALUE,;
        CFISFYEAR WITH APINVHDR.CFISFYEAR,;
        CFSPPRDID WITH APINVHDR.CFSPPRDID,;
        CAPSESSNO WITH LOFORMSET.LCSEQUENCE,;
        CCURRCODE WITH LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.KEYTEXTBOX.VALUE,;
        NEXRATE   WITH LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTNEXRATE.VALUE,;
        NCURRUNIT WITH APINVHDR.NCURRUNIT

      LCTEMP = 'NAPDAMNT'+LOFORMSET.LCEXSIN1+'loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.Value'+;
        LOFORMSET.LCEXSIN2+'apinvhdr.ncurrunit'
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][Start]
      TRY
        *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][End]
        REPLACE NEQVAMNT  WITH ROUND(&LCTEMP,2), CAPDACTID WITH 'A'
        *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][Start]
      CATCH
        REPLACE NEQVAMNT  WITH 0, CAPDACTID WITH 'A'
      ENDTRY
      *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][End]
    ENDIF

    =GFADD_INFO('APDIST')
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    =GFREPLACE("")
    =GFREPLACE('MAPDIST with APDIST.MAPDIST')
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

    * Adding new entry of discount account if discount amount is greater than zero.
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *IF loFormSet.AriaForm1.txtInvDisof.Value > 0
    IF LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTINVDISOF.VALUE > 0
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

      APPEND BLANK
      IF TYPE('APINVHDR.DPOSTDATE') = 'D'
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        *!*	        REPLACE CVENDCODE WITH apinvhdr.cvenccven ;
        *!*	                CINVNO    WITH apinvhdr.cvenccinv ;
        *!*	                DAPDTRDAT WITH loFormSet.AriaForm1.DtPostDate.Value,;
        *!*	                LAPDPOST  WITH .F.       ,;
        *!*	                CAPDREF   WITH loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value ,;
        *!*	                CAPDTRTYP WITH 'I'       ,;
        *!*	                cApdActId with 'S'       ,;
        *!*	                CAPDGLACT WITH loFormSet.lcDisAcct ,;
        *!*	                NAPDAMNT  WITH -loFormSet.AriaForm1.txtInvDisof.Value,;
        *!*	                CFISFYEAR WITH loFormSet.lcDistYer ,;
        *!*	                CFSPPRDID WITH loFormSet.lcDistPrd ,;
        *!*	                CAPSESSNO WITH loFormSet.lcSequence,;
        *!*	                CCURRCODE WITH loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value,;
        *!*	                NEXRATE   WITH loFormSet.AriaForm1.txtNexRate.Value,;
        *!*	                NCURRUNIT WITH apinvhdr.ncurrunit
        *!*	        lcTemp = 'NAPDAMNT'+loFormSet.lcExSin1+'loFormSet.AriaForm1.txtNexRate.Value'+;
        *!*	                 loFormSet.lcExSin2+'apinvhdr.ncurrunit'

        REPLACE CVENDCODE WITH APINVHDR.CVENCCVEN ;
          CINVNO    WITH APINVHDR.CVENCCINV ;
          DAPDTRDAT WITH LOFORMSET.ARIAFORM1.DTPOSTDATE.VALUE,;
          LAPDPOST  WITH .F.       ,;
          CAPDREF   WITH LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE ,;
          CAPDTRTYP WITH 'I'       ,;
          CAPDACTID WITH 'S'       ,;
          CAPDGLACT WITH LOFORMSET.LCDISACCT ,;
          NAPDAMNT  WITH -LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTINVDISOF.VALUE,;
          CFISFYEAR WITH LOFORMSET.LCDISTYER ,;
          CFSPPRDID WITH LOFORMSET.LCDISTPRD ,;
          CAPSESSNO WITH LOFORMSET.LCSEQUENCE,;
          CCURRCODE WITH LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.KEYTEXTBOX.VALUE,;
          NEXRATE   WITH LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTNEXRATE.VALUE,;
          NCURRUNIT WITH APINVHDR.NCURRUNIT


        LCTEMP = 'NAPDAMNT'+LOFORMSET.LCEXSIN1+'loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.Value'+;
          LOFORMSET.LCEXSIN2+'apinvhdr.ncurrunit'
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
        *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][Start]
        TRY
          *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][End]
          REPLACE NEQVAMNT  WITH ROUND(&LCTEMP,2)
          *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][Start]
        CATCH
          REPLACE NEQVAMNT  WITH 0
        ENDTRY
        *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][End]
      ELSE
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        *!*	        REPLACE CVENDCODE WITH apinvhdr.cvenccven ;
        *!*	                CINVNO    WITH apinvhdr.cvenccinv ;
        *!*	                DAPDTRDAT WITH loFormSet.AriaForm1.DtInvDate.Value,;
        *!*	                LAPDPOST  WITH .F.       ,;
        *!*	                CAPDREF   WITH loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value ,;
        *!*	                CAPDTRTYP WITH 'I'       ,;
        *!*	                cApdActId with 'S'       ,;
        *!*	                CAPDGLACT WITH loFormSet.lcDisAcct ,;
        *!*	                NAPDAMNT  WITH -loFormSet.AriaForm1.txtInvDisof.Value;
        *!*	                CFISFYEAR WITH apinvhdr.cfisfyear,;
        *!*	                CFSPPRDID WITH apinvhdr.cfspprdid,;
        *!*	                CAPSESSNO WITH loFormSet.lcSequence,;
        *!*	                CCURRCODE WITH loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value,;
        *!*	                NEXRATE   WITH loFormSet.AriaForm1.txtNexRate.Value,;
        *!*	                NCURRUNIT WITH apinvhdr.ncurrunit
        *!*	        lcTemp = 'NAPDAMNT'+loFormSet.lcExSin1+'loFormSet.AriaForm1.txtNexRate.Value'+;
        *!*	                 loFormSet.lcExSin2+'apinvhdr.ncurrunit'
        REPLACE CVENDCODE WITH APINVHDR.CVENCCVEN ;
          CINVNO    WITH APINVHDR.CVENCCINV ;
          DAPDTRDAT WITH LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.DTINVDATE.VALUE,;
          LAPDPOST  WITH .F.       ,;
          CAPDREF   WITH LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE ,;
          CAPDTRTYP WITH 'I'       ,;
          CAPDACTID WITH 'S'       ,;
          CAPDGLACT WITH LOFORMSET.LCDISACCT ,;
          NAPDAMNT  WITH -LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTINVDISOF.VALUE;
          CFISFYEAR WITH APINVHDR.CFISFYEAR,;
          CFSPPRDID WITH APINVHDR.CFSPPRDID,;
          CAPSESSNO WITH LOFORMSET.LCSEQUENCE,;
          CCURRCODE WITH LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.KEYTEXTBOX.VALUE,;
          NEXRATE   WITH LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTNEXRATE.VALUE,;
          NCURRUNIT WITH APINVHDR.NCURRUNIT

        LCTEMP = 'NAPDAMNT'+LOFORMSET.LCEXSIN1+'loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.Value'+;
          LOFORMSET.LCEXSIN2+'apinvhdr.ncurrunit'
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
        *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][Start]
        TRY
          *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][End]
          REPLACE NEQVAMNT  WITH ROUND(&LCTEMP,2)
          *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][Start]
        CATCH
          REPLACE NEQVAMNT  WITH 0
        ENDTRY
        *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][End]

      ENDIF
      =GFADD_INFO('APDIST')

      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      =GFREPLACE("")
      =GFREPLACE('MAPDIST with APDIST.MAPDIST')
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

    ENDIF

    ** Update the Vendor & the Vendor History files **
    *Q8: Why ? will this reposition the record pointer in APVENDOR & APVENHST
    LCOLDATA1 = LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE
    LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE = APINVHDR.CVENCCVEN

    SELECT APINVHDR
    IF !EOF()
      GO RECNO()
    ENDIF

    SELECT APVENDOR

    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *!*	    REPLACE NVENBAL   WITH NVENBAL + ROUND((loFormSet.AriaForm1.txtInvAmount.Value - loFormSet.AriaForm1.txtInvDisof.Value) * loFormSet.AriaForm1.txtNexRate.Value/apinvhdr.ncurrunit,2) ,;
    *!*	            NVENCPUR  WITH NVENCPUR + ROUND((loFormSet.AriaForm1.txtInvAmount.Value-loFormSet.AriaForm1.txtInvDisof.Value) * loFormSet.AriaForm1.txtNexRate.Value/apinvhdr.ncurrunit,2),;
    *!*	            DVENLPURD WITH loFormSet.AriaForm1.DtInvDate.Value,;
    *!*	            NVENLPURA WITH ROUND((loFormSet.AriaForm1.txtInvAmount.Value - loFormSet.AriaForm1.txtInvDisof.Value) * loFormSet.AriaForm1.txtNexRate.Value/apinvhdr.ncurrunit,2)
    REPLACE NVENBAL   WITH NVENBAL + ROUND((LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTINVAMOUNT.VALUE - LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTINVDISOF.VALUE) * LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTNEXRATE.VALUE/APINVHDR.NCURRUNIT,2) ,;
            NVENCPUR  WITH NVENCPUR + ROUND((LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTINVAMOUNT.VALUE-LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTINVDISOF.VALUE) * LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTNEXRATE.VALUE/APINVHDR.NCURRUNIT,2),;
      DVENLPURD WITH LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.DTINVDATE.VALUE,;
      NVENLPURA WITH ROUND((LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTINVAMOUNT.VALUE - LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTINVDISOF.VALUE) * LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTNEXRATE.VALUE/APINVHDR.NCURRUNIT,2)

    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    =GFADD_INFO('APVENDOR')

    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    =GFREPLACE("")
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]


    SELECT APVENHST

    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *!*	    REPLACE NVNHPURCH    WITH NVNHPURCH + ROUND((loFormSet.AriaForm1.txtInvAmount.Value - loFormSet.AriaForm1.txtInvDisof.Value) * loFormSet.AriaForm1.txtNexRate.Value/apinvhdr.ncurrunit,2) ,;
    *!*	            &lcNewPerFld WITH EVALUATE(lcNewPerFld) + ROUND((loFormSet.AriaForm1.txtInvAmount.Value - loFormSet.AriaForm1.txtInvDisof.Value) * loFormSet.AriaForm1.txtNexRate.Value/apinvhdr.ncu
    REPLACE NVNHPURCH    WITH NVNHPURCH + ROUND((LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTINVAMOUNT.VALUE - LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTINVDISOF.VALUE) * LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTNEXRATE.VALUE/APINVHDR.NCURRUNIT,2) ,;
      &LCNEWPERFLD WITH EVALUATE(LCNEWPERFLD) + ROUND((LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTINVAMOUNT.VALUE - LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTINVDISOF.VALUE) * LOFORMSET.ARIAFORM1.PGFPAYINV
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

    =GFADD_INFO('APVENHST')

    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    =GFREPLACE("")
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

    LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE = LCOLDATA1

    SELECT APINVHDR
    GO LNSAVRECNO
    *Old: SHOW GET pbEdt DISABLE &&Revise
    LOFORMSET.LLEDITBUTTON = .F.
  ENDIF
  *Make adjutment if invoice amount does not total approved amount
  =IIF(EMPTY(LOFORMSET.LCVENINVTYPES) OR !LOFORMSET.LLUPDINVLN,.T.,LFINVADJUST(LOFORMSET))

  =GFFLOCK("APINVHDR,APDIST,APVENDOR,APVENHST",.F.)

  *Update Invoice Details File

  *Update costing files if invoice lines called

  =IIF(EMPTY(LOFORMSET.LCVENINVTYPES) OR !LOFORMSET.LLUPDINVLN,.T.,LFUPDFILES(LOFORMSET))

  *B128863,1 ASM Fix the Bug of Saving Fox Tables even when SQL Gives errors and RollBack [Start]
  *=gfAdd_Info('APINVHDR')
  *lnRecno=RECNO('apinvhdr')
  *REPLACE llok_stat WITH .F.
  *=TABLEUPDATE(.T.,.T.,'APINVHDR')
  *IF lnRecno>0
  *GO lnRecno IN APINVHDR
  *ENDIF
  *=TABLEUPDATE(.T.,.T.,'APVENDOR')
  *=TABLEUPDATE(.T.,.T.,'APVENHST')
  *=TABLEUPDATE(.T.,.T.,'APDIST')
  *=TABLEUPDATE(.T.,.T.,'APINVAHD')
  *IF !EMPTY(loFormSet.lcVenInvTypes) .AND. loFormSet.llUpdInvLn
  *=TABLEUPDATE(.T.,.T.,'APVINVDT')
  *=TABLEUPDATE(.T.,.T.,'APINVTKT')
  *=TABLEUPDATE(.T.,.T.,'ApPaymnt')
  *lcTranCode = oAriaApplication.RemoteCompanyData.BeginTran(oAriaApplication.ActiveCompanyConStr,3,'')
  *IF TYPE('lcTranCode') = 'N'
  *=oAriaApplication.RemoteCompanyData.CheckRetResult("BeginTran",lcTranCode,.T.)
  *RETURN .F.
  *ENDIF
  *IF lfUpdateSql(loFormSet,lcTranCode)
  *=oAriaApplication.RemoteCompanyData.CommitTran(lcTranCode)
  *WAIT WINDOW 'Sql Updated Successfully'
  *ELSE
  *=oAriaApplication.RemoteCompanyData.RollBackTran(lcTranCode)
  *ENDIF
  *ENDIF
  *=TABLEUPDATE(.T.,.T.,loFormSet.lcTmpDist)
  *=CURSORSETPROP("Buffering",1,loFormSet.lcTmpDist)
  *! C200957,1 MHM 03/02/2008 T20070920.0001  Add register No. for All UK customers.[Start]
  IF ASCAN(LOFORMSET.LAEVNTTRIG,PADR('ADDAPREG',10),1,ALEN(LOFORMSET.LAEVNTTRIG,1),1) > 0
    =LOFORMSET.MDOTRIGGER(PADR('ADDAPREG',10))
  ENDIF
  *! C200957,1 MHM 03/02/2008 [END]

  =GFADD_INFO('APINVHDR')
  LNRECNO=RECNO('apinvhdr')
  REPLACE LLOK_STAT WITH .F.
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  =GFREPLACE("")
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

  LLREVERT = .F.

  IF !EMPTY(LOFORMSET.LCVENINVTYPES) .AND. LOFORMSET.LLUPDINVLN
    LCTRANCODE = OARIAAPPLICATION.REMOTECOMPANYDATA.BEGINTRAN(OARIAAPPLICATION.ACTIVECOMPANYCONSTR,3,'')
    *B128863,1 ASM [Strat]
    *IF TYPE('lcTranCode') = 'N'
    IF TYPE('lcTranCode') <> 'C'
      *B128863,1 ASM [End]
      =OARIAAPPLICATION.REMOTECOMPANYDATA.CHECKRETRESULT("BeginTran",LCTRANCODE,.T.)
      RETURN .F.
    ENDIF
    IF LFUPDATESQL(LOFORMSET,LCTRANCODE)
      =OARIAAPPLICATION.REMOTECOMPANYDATA.COMMITTRAN(LCTRANCODE)
      LLREVERT = .F.
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *!*	     =TABLEUPDATE(.T.,.T.,'APVINVDT')
      *!*	     =TABLEUPDATE(.T.,.T.,'APINVTKT')
      *!*	     =TABLEUPDATE(.T.,.T.,'ApPaymnt')
      SELECT APVINVDT
      =GFTABLEUPDATE()
      SELECT APINVTKT
      =GFTABLEUPDATE()
      SELECT APPAYMNT
      =GFTABLEUPDATE()
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      *WAIT WINDOW 'Sql Updated Successfully'
    ELSE
      =OARIAAPPLICATION.REMOTECOMPANYDATA.ROLLBACKTRAN(LCTRANCODE)
      LLREVERT = .T.
      =LFREVERTSQL(LOFORMSET)
      =TABLEREVERT(.T.,'APVINVDT')
      =TABLEREVERT(.T.,'APINVTKT')
      =TABLEREVERT(.T.,'ApPaymnt')
    ENDIF
  ENDIF

  IF !LLREVERT
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *=TABLEUPDATE(.T.,.T.,'APINVHDR')
    SELECT APINVHDR
    =GFTABLEUPDATE()
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    IF LNRECNO>0
      GO LNRECNO IN APINVHDR
    ENDIF
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *!*	    =TABLEUPDATE(.T.,.T.,'APVENDOR')
    *!*	    =TABLEUPDATE(.T.,.T.,'APVENHST')
    *!*	    =TABLEUPDATE(.T.,.T.,'APDIST')
    *!*	    =TABLEUPDATE(.T.,.T.,'APINVAHD')
    SELECT APVENDOR
    =GFTABLEUPDATE()
    SELECT APVENHST
    =GFTABLEUPDATE()
    SELECT APDIST
    =GFTABLEUPDATE()
    SELECT APINVAHD
    =GFTABLEUPDATE()
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    =TABLEUPDATE(.T.,.T.,LOFORMSET.LCTMPDIST)
    =CURSORSETPROP("Buffering",1,LOFORMSET.LCTMPDIST)
  ELSE
    =TABLEREVERT(.T.,'APINVHDR')
    IF LNRECNO>0
      GO LNRECNO IN APINVHDR
    ENDIF
    =TABLEREVERT(.T.,'APVENDOR')
    =TABLEREVERT(.T.,'APVENHST')
    =TABLEREVERT(.T.,'APDIST')
    =TABLEREVERT(.T.,'APINVAHD')
    =TABLEREVERT(.T.,LOFORMSET.LCTMPDIST)
    =CURSORSETPROP("Buffering",1,LOFORMSET.LCTMPDIST)
    =GFMODALGEN("TRM04204B00000","DIALOG")
  ENDIF
  *B128863,1 ASM Fix the Bug of Saving Fox Tables even when SQL Gives errors and RollBack [End]

ELSE
  =GFFLOCK("APINVHDR,APDIST,APVENDOR,APVENHST",.F.)

  *Add this line to update the flag llCSave and give the user
  *          message that the saving process is canceled [Begin]
  LLCSAVE = .F.
  =GFMODALGEN("TRM00103B00000","DIALOG",'Saving')
  *Add this line to update the flag llCSave [End]
  =LFREVERTSQL(LOFORMSET)
  *WAIT WINDOW 'Sql Reverted'
  =TABLEREVERT(.T.,LOFORMSET.LCTMPDIST)
  =CURSORSETPROP("Buffering",1,LOFORMSET.LCTMPDIST)

ENDIF

*Old: IF WVISIBLE('CWRAPDISTR')
*Old: =gfChClose('CWRAPDISTR')
*Old: ENDIF
*Old: IF USED('APVENHST') .AND. llOpVHst
*Old: =gfCloseFile('APVENHST')
*USE IN APVENHST
*Old: ENDIF
*Old: IF USED('SYCFACT') .AND. llopFact
*Old: =gfCloseFile('SYCFACT')
*USE IN SYCFACT
*Old: ENDIF
SELECT APINVHDR
SET EXACT &LCSAVEXACT


RETURN
*-- End of lfFormSaveFiles


*!*************************************************************
*! Name      : lfFormDelete
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 8/16/2004
*! Purpose   : Procedure called from the Delete Method of the FormSet
*!*************************************************************
*! Parameters: The FormSet
*!*************************************************************
*! Returns   : None
*!*************************************************************
FUNCTION LFFORMDELETE
LPARAMETERS LOFORMSET
LOCAL LOREC

IF GFMODALGEN("QRM00002B00006","ALERT",'Void') <> 1
  RETURN .F.
ENDIF

*Define 2 variable to deal with new posting date screen [Begin]
PRIVATE LNDATEWDTH
LNDATEWDTH = IIF('ON'$SET('CENT'),10,8)*(FONTME(7,'MS SANS SERIF',9)/9)
STORE .F. TO LOFORMSET.LLVOIDDATE , LOFORMSET.LLENTERSCR
LOFORMSET.LDVOIDDATE  = {}

*-- If Period is locked , cannot proceed
*B609565,1 WAM 04/10/2011 Read posting date when void invoice
*IF !lfLockPerd(loFormSet) AND loFormSet.llEnterScr
IF !LFLOCKPERD(LOFORMSET)
  *B609565,1 WAM 04/10/2011 (End)

  =GFOBJ_LOCK(.F.)
  RETURN .F.
ENDIF
*Define 2 variable to deal with new posting date screen [End]

LLCANCEL     = .F.
LLISNTALMENT = .F.
IF APINVHDR.NINVPAID+APINVHDR.NINVDISTK+APINVHDR.NINVADJ <> 0
  ** MESSAGE : " You can not void partially or fully paid  "
  **           " invoice.                                  "
  **           "                     Ok                  "
  =GFMODALGEN("TRM04032B00000","DIALOG")
  =GFOBJ_LOCK(.F.)
  RETURN .F.
ENDIF
SELECT APINVTKT
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*SET ORDER TO TAG Lncont
*=SEEK(PADR(loFormSet.AriaForm1.KBVendCode.KeyTextBox.Value,8)+PADR(loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value,12))
=GFSETORDER('Lncont')
=GFSEEK(PADR(LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE,8)+PADR(LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE,12))
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
LOCATE REST WHILE CVENDCODE+CAPINVNO+CAPVILNO+CRSESSION = ;
  PADR(LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE,8)+PADR(LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE,12)
IF FOUND()
  *E300798,1 Message : 04178
  *E300798,1 Vendor xxx\Invoice xxx is applied againest one or more receipts. Canot void.
  *E300798,1 Button : 00000
  *E300798,1 Ok
  =GFMODALGEN("TRM04178B00000","DIALOG",LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE+'|'+LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE)
  =GFOBJ_LOCK(.F.)
  SELECT APINVHDR  &&Boho
  RETURN .F.
ENDIF


LCSAVEXACT= SET('EXACT')
SET EXACT ON

LOFORMSET.LCEXSIN2 = ' '
LCEXSIN2 = LOFORMSET.LCEXSIN2
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*loFormSet.lcExSin1 = gfGetExSin(@lcExSin2,loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value)
LOFORMSET.LCEXSIN1 = GFGETEXSIN(@LCEXSIN2,LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.KEYTEXTBOX.VALUE)
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
LOFORMSET.LCEXSIN2 = LCEXSIN2
*Open file and make necessary relation
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*llOpVHst = gfOpenFile(oAriaApplication.DataDir+'APVENHST','VENDYEAR','SH')
LLOPVHST = GFOPENTABLE('APVENHST','VENDYEAR','SH')
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
=CURSORSETPROP("Buffering",5,'APVENHST')
SELECT APINVHDR
SET RELATION OFF INTO APVENHST
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*SET RELATION TO APINVHDR.CVENDCODE + APINVHDR.CFISFYEAR INTO APVENHST ADDITIVE
=GFSEEK(APINVHDR.CVENDCODE,'APVENDOR')
=GFSEEK(APINVHDR.CINVNO+APINVHDR.CVENDCODE,'APDIST')
=GFSEEK(APINVHDR.CDIVISION,'APDIV')
=GFSEEK(APINVHDR.CVENDCODE + APINVHDR.CFISFYEAR,'APVENHST')
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]


IF !EMPTY(APINVHDR.CVENCCVEN)
  ** MESSAGE : " Voiding this invoice will reopen "
  **           " invoice  for vendor  .         "
  **           "      < Void >      < Cancel >    "
  LNOPTION = GFMODALGEN("TRM04033B04001","DIALOG",ALLTRIM(APINVHDR.CVENCCINV)+"|"+ALLTRIM(APINVHDR.CVENCCVEN))

  IF LNOPTION = 1
    IF GFFLOCK("APINVHDR,APDIST,APVENDOR,APVENHST",.T.)
      SELECT APINVHDR
      LNSAVRECNO = RECNO()
      SCATTER NAME LOREC
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *IF SEEK(loRec.cvenccven+loRec.cvenccinv)
      IF GFSEEK(LOREC.CVENCCVEN+LOREC.CVENCCINV)
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
        LCNEWPAYFLD  = 'NVNHPAY'+ALLTRIM(STR(INT(VAL(APINVHDR.CFSPPRDID))))
        SELECT APVENHST

        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        *lcTemp = 'APINVHDR.NINVADJ'+loFormSet.lcExSin1+'loFormSet.AriaForm1.txtNexRate.Value'+;
        +loFormSet.lcExSin2+'loRec.ncurrunit'

        *REPLACE NVNHCCPAY    WITH NVNHCCPAY  - ROUND(&lcTemp,2)
        *    lcTemp = 'APINVHDR.NINVDISTK'+loFormSet.lcExSin1+;
        'loFormSet.AriaForm1.txtNexRate.Value'+loFormSet.lcExSin2+'loRec.ncurrunit'

        *        REPLACE NVNHDISTKN   WITH NVNHDISTKN - ROUND(&lcTemp,2)
        * lcTemp = 'APINVHDR.NINVADJ'+loFormSet.lcExSin1+'loFormSet.AriaForm1.txtNexRate.Value'+;
        +loFormSet.lcExSin2+'loRec.ncurrunit'

        *REPLACE NVNHTOTPA    WITH NVNHTOTPA  - ROUND(&lcTemp,2)
        * lcTemp = 'APINVHDR.NINVADJ'+loFormSet.lcExSin1+'loFormSet.AriaForm1.txtNexRate.Value'+;
        +loFormSet.lcExSin2+'loRec.ncurrunit'

        *REPLACE &lcNewPayFld WITH EVALUATE(lcNewPayFld) - ROUND(&lcTemp,2)
        LCTEMP = 'APINVHDR.NINVADJ'+LOFORMSET.LCEXSIN1+'loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.Value'+;
          +LOFORMSET.LCEXSIN2+'loRec.ncurrunit'
        *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][Start]
        TRY
          *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][End]
          GFREPLACE("NVNHCCPAY    WITH NVNHCCPAY  - ROUND(&lcTemp,2)")
          *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][Start]
        CATCH
        ENDTRY
        *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][End]
        LCTEMP = 'APINVHDR.NINVDISTK'+LOFORMSET.LCEXSIN1+;
          'loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.Value'+LOFORMSET.LCEXSIN2+'loRec.ncurrunit'
        *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][Start]
        TRY
          *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][End]
          GFREPLACE("NVNHDISTKN   WITH NVNHDISTKN - ROUND(&lcTemp,2)")
          *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][Start]
        CATCH
        ENDTRY
        *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][Start]


        LCTEMP = 'APINVHDR.NINVADJ'+LOFORMSET.LCEXSIN1+'loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.Value'+;
          +LOFORMSET.LCEXSIN2+'loRec.ncurrunit'
        *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][Start]
        TRY
          *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][End]
          GFREPLACE("NVNHTOTPA    WITH NVNHTOTPA  - ROUND(&lcTemp,2)")
          *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][Start]
        CATCH
        ENDTRY
        *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][End]

        LCTEMP = 'APINVHDR.NINVADJ'+LOFORMSET.LCEXSIN1+'loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.Value'+;
          +LOFORMSET.LCEXSIN2+'loRec.ncurrunit'
        *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][Start]
        TRY
          *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][End]
          GFREPLACE("&lcNewPayFld WITH EVALUATE(lcNewPayFld) - ROUND(&lcTemp,2)")
          *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][Start]
        CATCH
          GFREPLACE("&lcNewPayFld WITH EVALUATE(lcNewPayFld)")
        ENDTRY
        *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][End]
        =GFADD_INFO('APVENHST')

        =GFREPLACE("")
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[END]
      ENDIF

      SELECT APVENDOR
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *IF SEEK(loRec.cvenccven)
      *lcTemp = 'APINVHDR.NINVAMNT'+loFormSet.lcExSin1+'loFormSet.AriaForm1.txtNexRate.Value'+;
      +loFormSet.lcExSin2+'loRec.ncurrunit'

      *REPLACE NVENBAL  WITH NVENBAL  + ROUND(&lcTemp,2)
      *lcTemp = '(APINVHDR.NINVAMNT-APINVHDR.NINVDISOF)'+loFormSet.lcExSin1+;
      'loFormSet.AriaForm1.txtNexRate.Value'+loFormSet.lcExSin2+'loRec.ncurrunit'

      *REPLACE NVENCPAY WITH NVENCPAY - ROUND(&lcTemp,2)

      IF GFSEEK(LOREC.CVENCCVEN)

        LCTEMP = 'APINVHDR.NINVAMNT'+LOFORMSET.LCEXSIN1+'loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.Value'+;
          +LOFORMSET.LCEXSIN2+'loRec.ncurrunit'
        *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][Start]
        TRY
          *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][End]
          GFREPLACE("NVENBAL  WITH NVENBAL  + ROUND(&lcTemp,2)")
          *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][Start]
        CATCH
        ENDTRY
        *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][End]

        LCTEMP = '(APINVHDR.NINVAMNT-APINVHDR.NINVDISOF)'+LOFORMSET.LCEXSIN1+;
          'loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.Value'+LOFORMSET.LCEXSIN2+'loRec.ncurrunit'
        *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][Start]
        TRY
          *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][End]
          GFREPLACE("NVENCPAY WITH NVENCPAY - ROUND(&lcTemp,2)")
          *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][Start]
        CATCH
        ENDTRY
        *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][End]

        =GFADD_INFO('APVENDOR')


        =GFREPLACE("")
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[END]
      ENDIF

      SELECT APINVHDR
      REPLACE NINVDISTK WITH 0,;
        NINVADJ   WITH 0,;
        CVENPMETH WITH IIF(APVENDOR.CVENPMETH <> 'C',APVENDOR.CVENPMETH,'P'),;
        CVENCCINV WITH ' ',;
        CVENCCVEN WITH ' '
      =GFADD_INFO('APINVHDR')
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      =GFREPLACE('')
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      GO LNSAVRECNO
    ENDIF
  ELSE
    LLCANCEL = .T.
  ENDIF
  =GFFLOCK("APINVHDR,APDIST,APVENDOR,APVENHST",.F.)
ENDIF

SELECT APINVAHD
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*!*	lcSavOrder = SET('ORDER')
*!*	SET ORDER TO TAG TVENDINV
*!*	IF SEEK('I'+loFormSet.AriaForm1.KBVendCode.KeyTextBox.Value+loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value)
LCSAVORDER = ORDER()
=GFSETORDER('TVENDINV')
IF GFSEEK('I'+LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE+LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE)
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  ** MESSAGE : " This invoice has corresponding instalment "
  **           " record.  .                               "
  **           "           Procced     < Cancel >        "

  IF GFMODALGEN("TRM04120B00012","DIALOG",LOFORMSET.LCTDELCOR) = 2
    LLCANCEL = .T.
  ELSE
    =GFOBJ_LOCK(.T.)
    LLISNTALMENT = .T.
  ENDIF
ENDIF
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*SET ORDER TO &lcSavOrder
GFSETORDER(LCSAVORDER)
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
SET EXACT &LCSAVEXACT

SELECT APINVHDR

IF LLCANCEL
  ** MESSAGE : "  process is canceled "
  **           "             Ok             "
  =GFMODALGEN("TRM00103B00000","DIALOG",LOFORMSET.LCTVOID)
  =GFOBJ_LOCK(.F.)
  =TABLEREVERT(.T.,'APINVHDR')
  =TABLEREVERT(.T.,'APVENDOR')
  =TABLEREVERT(.T.,'APVENHST')
  SELECT APINVHDR  &&Boho
  SET EXACT &LCSAVEXACT
  RETURN .F.
ELSE
  SELECT APINVHDR
  IF !EOF()
    GO RECNO()
  ENDIF

  IF GFFLOCK("APINVHDR,APDIST,APVENDOR,APVENHST",.T.)

    IF LLISNTALMENT
      SELECT APINVAHD
      =GFOBJ_LOCK(.F.)
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *DELETE
      =GFDELETE()
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[ENd]
    ENDIF


    SELECT APDIST
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *=SEEK(loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value + loFormSet.AriaForm1.KBVendCode.KeyTextBox.Value)
    =GFSEEK(LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE + LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE)
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    SCAN REST WHILE CINVNO + CVENDCODE = LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE + LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE;
        FOR CAPDSTAT <> 'V'
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *REPLACE CAPDSTAT WITH 'V'
      GFREPLACE("CAPDSTAT WITH 'V'")
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      SCATTER MEMVAR MEMO
      m.NAPDAMNT = -1 * m.NAPDAMNT
      m.CBATCHNO = ' '
      m.LAPDPOST = .F.
      m.CTRNSLEDN= ' '
      m.CAPSESSNO= LOFORMSET.LCSEQUENCE
      m.LAPDPOST = .F.
      m.NEQVAMNT = -1 * m.NEQVAMNT

      IF LOFORMSET.LLVOIDDATE
        m.CFISFYEAR = LOFORMSET.LCDISTYER
        m.CFSPPRDID = LOFORMSET.LCDISTPRD
        m.DAPDTRDAT = LOFORMSET.LDVOIDDATE
      ENDIF
      *if posting date is changed [End]


      m.NENTRYNO = 0

      SELECT (LOFORMSET.LCTEMPSAVE)
      APPEND BLANK
      GATHER MEMVAR MEMO
      =GFADD_INFO(LOFORMSET.LCTEMPSAVE)

      SELECT APDIST

    ENDSCAN


    SELECT (LOFORMSET.LCTEMPSAVE)

    IF RECCOUNT() > 0
      SELECT APDIST
      APPEND FROM (OARIAAPPLICATION.WORKDIR+LOFORMSET.LCTEMPSAVE)
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      SCAN
        SCATTER MEMO MEMVAR
        =GFREPLACE("")
        =GFREPLACE('MAPDIST with APDIST.MAPDIST')
      ENDSCAN
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    ENDIF

    SELECT (LOFORMSET.LCTEMPSAVE)
    ZAP

    LCSAVEXACT= SET('EXACT')
    SELECT APVENDOR
    SET EXACT ON
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *IF SEEK(loFormSet.AriaForm1.KBVendCode.KeyTextBox.Value)
    *!*	          lcTemp = 'loFormSet.AriaForm1.txtInvAmount.Value'+loFormSet.lcExSin1+;
    *!*	               'loFormSet.AriaForm1.txtNexRate.Value'+loFormSet.lcExSin2+'apinvhdr.ncurrunit'
    IF GFSEEK(LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE)
      LCTEMP = 'loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.Value'+LOFORMSET.LCEXSIN1+;
        'loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.Value'+LOFORMSET.LCEXSIN2+'apinvhdr.ncurrunit'
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[ENd]
      *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][Start]
      TRY
        *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][End]

        REPLACE NVENBAL   WITH NVENBAL   - ROUND(&LCTEMP,2)
        *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][Start]
      CATCH
      ENDTRY
      *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][End]
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *!*	      lcTemp = 'loFormSet.AriaForm1.txtInvAmount.Value'+loFormSet.lcExSin1+;
      *!*	               'loFormSet.AriaForm1.txtNexRate.Value'+loFormSet.lcExSin2+'apinvhdr.ncurrunit'
      LCTEMP = 'loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.Value'+LOFORMSET.LCEXSIN1+;
        'loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.Value'+LOFORMSET.LCEXSIN2+'apinvhdr.ncurrunit'
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[ENd]
      *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][Start]
      TRY
        *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][End]

        REPLACE NVENCPUR  WITH NVENCPUR  - ROUND(&LCTEMP,2)
        *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][Start]
      CATCH
      ENDTRY
      *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][End]

      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *!*	      lcTemp = 'MIN(loFormSet.AriaForm1.txtInvAmount.Value,0)'+loFormSet.lcExSin1+;
      *!*	               'loFormSet.AriaForm1.txtNexRate.Value'+loFormSet.lcExSin2+'apinvhdr.ncurrunit'
      LCTEMP = 'MIN(loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.Value,0)'+LOFORMSET.LCEXSIN1+;
        'loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.Value'+LOFORMSET.LCEXSIN2+'apinvhdr.ncurrunit'
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[ENd]
      REPLACE NVENOPNDR WITH NVENOPNDR + ROUND(&LCTEMP,2)
      =GFADD_INFO('APVENDOR')
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      =GFREPLACE("")
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

      SELECT APVENHST

      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *      IF SEEK(loFormSet.AriaForm1.KBVendCode.KeyTextBox.Value+apinvhdr.cfisfyear)
      IF GFSEEK(LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE+APINVHDR.CFISFYEAR)
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

        LCNEWPERFLD  = 'NVNHPUR'+ALLTRIM(STR(INT(VAL(APINVHDR.CFSPPRDID))))
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        *!*	        REPLACE NVNHDISOF    WITH NVNHDISOF - ROUND(loFormSet.AriaForm1.txtInvDisof.Value * loFormSet.AriaForm1.txtNexRate.Value/apinvhdr.ncurrunit,2),;
        *!*	                NVNHPURCH    WITH NVNHPURCH - ROUND(loFormSet.AriaForm1.txtInvAmount.Value * loFormSet.AriaForm1.txtNexRate.Value/apinvhdr.ncurrunit,2),;
        *!*	                &lcNewPerFld WITH EVALUATE(lcNewPerFld) - ROUND(loFormSet.AriaForm1.txtInvAmount.Value * loFormSet.AriaForm1.txtNexRate.Value/apinvhdr.ncurrunit,2)
        *   lcTemp = 'loFormSet.AriaForm1.txtInvDisof.Value'+loFormSet.lcExSin1+;
        'loFormSet.AriaForm1.txtNexRate.Value'+loFormSet.lcExSin2+'apinvhdr.ncurrunit'
        *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][Start]
        TRY
          *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][End]
          REPLACE NVNHDISOF    WITH NVNHDISOF - ROUND(LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTINVDISOF.VALUE * LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTNEXRATE.VALUE/APINVHDR.NCURRUNIT,2),;
            NVNHPURCH    WITH NVNHPURCH - ROUND(LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTINVAMOUNT.VALUE * LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTNEXRATE.VALUE/APINVHDR.NCURRUNIT,2),;
            &LCNEWPERFLD WITH EVALUATE(LCNEWPERFLD) - ROUND(LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTINVAMOUNT.VALUE * LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTNEXRATE.VALUE/APINVHDR.NCURRUNIT,2)
          *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][Start]
        CATCH
        ENDTRY
        *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][End]
        LCTEMP = 'loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvDisof.Value'+LOFORMSET.LCEXSIN1+;
          'loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.Value'+LOFORMSET.LCEXSIN2+'apinvhdr.ncurrunit'
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
        *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][Start]
        TRY
          *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][End]
          REPLACE NVNHDISOF    WITH NVNHDISOF - ROUND(&LCTEMP,2)
          *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][Start]
        CATCH
        ENDTRY
        *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][End]
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        *!*	        lcTemp = 'loFormSet.AriaForm1.txtInvAmount.Value'+loFormSet.lcExSin1+;
        *!*	                 'loFormSet.AriaForm1.txtNexRate.Value'+loFormSet.lcExSin2+'apinvhdr.ncurrunit'
        LCTEMP = 'loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.Value'+LOFORMSET.LCEXSIN1+;
          'loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.Value'+LOFORMSET.LCEXSIN2+'apinvhdr.ncurrunit'
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
        *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][Start]
        TRY
          *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][End]
          REPLACE NVNHPURCH    WITH NVNHPURCH - ROUND(&LCTEMP,2)
          *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][Start]
        CATCH
        ENDTRY
        *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][End]
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        *!*	        REPLACE &lcNewPerFld WITH EVALUATE(lcNewPerFld) - ROUND(loFormSet.AriaForm1.txtInvAmount.Value * loFormSet.AriaForm1.txtNexRate.Value/apinvhdr.ncurrunit,2)
        REPLACE &LCNEWPERFLD WITH EVALUATE(LCNEWPERFLD) - ROUND(LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTINVAMOUNT.VALUE * LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTNEXRATE.VALUE/APINVHDR.NCURRUNIT,2)
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]

        =GFADD_INFO('APVENHST')
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        =GFREPLACE("")
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      ENDIF
    ENDIF

    SELECT APINVHDR
    REPLACE CINVSTAT  WITH 'V',;
      LLOK_STAT WITH .F.,;
      CLOK_USER WITH ' ',;
      DLOK_DATE WITH {} ,;
      CLOK_TIME WITH ' '


    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *!*	    =TABLEUPDATE(.T.,.T.,'APINVHDR')
    *!*	    =TABLEUPDATE(.T.,.T.,'APVENDOR')
    *!*	    =TABLEUPDATE(.T.,.T.,'APVENHST')
    *!*	    =TABLEUPDATE(.T.,.T.,'APDIST')
    *!*	    =TABLEUPDATE(.T.,.T.,'APINVAHD')
    =GFREPLACE("")
    SELECT APINVHDR
    =GFTABLEUPDATE()
    SELECT APVENDOR
    =GFTABLEUPDATE()
    SELECT APVENHST
    =GFTABLEUPDATE()
    SELECT APDIST
    =GFTABLEUPDATE()
    SELECT APINVAHD
    =GFTABLEUPDATE()
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

    ** Change the screen mode to the Select mode.
    LOFORMSET.CHANGEMODE("S")
  ENDIF
  =GFFLOCK("APINVHDR,APDIST,APVENDOR,APVENHST",.F.)
ENDIF

*Old: IF WVISIBLE('CWRAPDISTR')
*Old: =gfChClose('CWRAPDISTR')
*Old: ENDIF
*E301077,71 AMM Close file
IF USED('APVENHST') .AND. LLOPVHST
  *Old: =gfCloseFile('APVENHST')
  *USE IN APVENHST
ENDIF
*E301077,71 AMM end

SELECT APINVHDR
SET EXACT &LCSAVEXACT
=GFOBJ_LOCK(.F.)

RETURN
*-- End of lfFormDelete

*!*************************************************************
*! Name      : lfvldApAct
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 8/16/2004
*! Purpose   : To check if there is inactive account
*!*************************************************************
*! Parameters: The FormSet
*!*************************************************************
*! Returns   : None
*!*************************************************************
FUNCTION LFVLDAPACT
LPARAMETERS LOFORMSET

PRIVATE LNRETVAL

LNRETVAL = .T.

SELECT ('lcLinkChar')
SET ORDER TO TAG ACCTCODE

SELECT (LOFORMSET.LCTMPDIST)
SCAN
  LCAPDGLACT = CAPDGLACT
  SELECT ('lcLinkChar')
  IF SEEK(LCAPDGLACT,'lcLinkChar') AND CSEGACTIV = "I"
    LNRETVAL = .F.
    EXIT
  ENDIF

ENDSCAN

IF !LNRETVAL
  =GFMODALGEN("TRM04203B00000","DIALOG")
ENDIF

RETURN LNRETVAL
*-- End of lfvldApAct


*!*************************************************************
*! Name      : lfChckVoid
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 8/16/2004
*! Purpose   : To Check the balancing in (lcTmpDist) file before saving
*!*************************************************************
*! Parameters: The FormSet
*!*************************************************************
*! Returns   : llSave
*!*************************************************************
FUNCTION LFCHCKVOID
LPARAMETERS LOFORMSET

PRIVATE LNTOTAMNT , LL2RETURN , LCOLDEXT , LNEQVAMNT
STORE 0 TO LNTOTAMNT , LNEQVAMNT

LNOLDALS = SELECT(0)
LCOLDEXT = SET("EXACT")
SET EXACT OFF
SELECT (LOFORMSET.LCTMPDIST)
GO TOP
LL2RETURN = !EOF()
IF LL2RETURN
  *B608685,1 WAM 09/10/2008 Compute equivalent cost when checking balance of APDIST while saving the invoice
  *SUM ALL napdamnt , neqvamnt TO lnTotAmnt , lnEqvAmnt ;
  FOR cVendCode+cInvNo+STR(nApDLinNo,4) = PADR(loFormSet.AriaForm1.KBVendCode.KeyTextBox.Value,8) + PADR(loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value,12);
  .AND. CAPDSTAT <> 'V'
  LCEXSIN1= LOFORMSET.LCEXSIN1
  LCEXSIN2= LOFORMSET.LCEXSIN2
  *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][Start]
  TRY
    *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][End]
    SUM ALL NAPDAMNT , (NAPDAMNT &LCEXSIN1 NEXRATE &LCEXSIN2 NCURRUNIT) TO LNTOTAMNT , LNEQVAMNT ;
      FOR CVENDCODE+CINVNO+STR(NAPDLINNO,4) = PADR(LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE,8) + PADR(LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE,12);
      .AND. CAPDSTAT <> 'V'
    *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][Start]
  CATCH
    SUM ALL NAPDAMNT , 0 TO LNTOTAMNT , LNEQVAMNT ;
      FOR CVENDCODE+CINVNO+STR(NAPDLINNO,4) = PADR(LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE,8) + PADR(LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE,12);
      .AND. CAPDSTAT <> 'V'
  ENDTRY
  *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][End]
  *B608685,1 WAM 09/10/2008 (End)

  LL2RETURN =   (LNTOTAMNT = 0) .AND. (LNEQVAMNT =0)
ENDIF
SELECT (LNOLDALS)
SET EXACT &LCOLDEXT

RETURN LL2RETURN
*-- End of lfChckVoid


*!*************************************************************
*! Name      : lfLockPerd
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 8/16/2004
*! Purpose   : To Check if period is locked or not
*!*************************************************************
*! Parameters: The FormSet
*!*************************************************************
*! Returns   : True if period is locked Or False if period is not
*!*************************************************************
FUNCTION LFLOCKPERD
LPARAMETERS LOFORMSET

*Check posting date if it is in Closed period before Voiding the invoice [Begin]
*B609565,1 WAM 04/10/2011 Read posting date when void invoice in all cases

*!*	lcDistPrd = loFormSet.lcDistPrd
*!*	lcDistYer = loFormSet.lcDistYer
*!*	llLokPer = loFormSet.llLokPer
*!*	=lfVlDate(oAriaApplication.PrntCompanyID , @lcDistPrd , @lcDistYer , loFormSet.AriaForm1.DtPostDate.Value , @llLokPer)
*!*	loFormSet.lcDistPrd = lcDistPrd
*!*	loFormSet.lcDistYer = lcDistYer
*!*	loFormSet.llLokPer = llLokPer
*!*
*!*	*-- Check to see if this period and year is locked
*!*	IF loFormSet.llLokPer
*!*	  *Message : " The posting date falls within a locked period.  "
*!*	  *          " You cannot change invoice status to Void, "
*!*	  *          " unless you enter a voiding date "
*!*	  *          " that falls within an open period. "
*!*	  *Buttons : "                    <    Ok    >                "
*!*	  =gfModalGen("INM04163B00000" , "DIALOG" , 'invoice status to Void, unless you ' + ;
*!*	                                            'enter a voiding date that falls ' +;
*!*	                                            'within an open period')
*B609565,1 WAM 04/10/2011 (End)

LOFORMSET.LDVOIDDATE = OARIAAPPLICATION.SYSTEMDATE  &&lower
*DO (oAriaApplication.ScreenHome + oAriaApplication.ActiveModuleID + '\APVoidDt.SPX')
*DO FORM (OARIAAPPLICATION.SCREENHOME+"\AP\APVoidDt.SCX") WITH LOFORMSET.ARIAFORM1
*! E303029,1 MMT 12/26/2011 correct the calling of non-major programs within the SaaS environemnt[STart]
*DO FORM (oAriaApplication.ScreenHome+"\AP\APVoidDt.SCX") WITH loFormSet.AriaForm1
LOPARAMLIST = LOFORMSET
=GFCALLFORM('APVoidDt','AP',"loParamList.AriaForm1")
*! E303029,1 MMT 12/26/2011 correct the calling of non-major programs within the SaaS environemnt[END]


*B609565,1 WAM 04/10/2011 Read posting date when void invoice
*!*	  loFormSet.llEnterScr = .T.     && Raise flag to ensure that screen was entered
*!*	ENDIF
*B609565,1 WAM 04/10/2011 (End)

RETURN LOFORMSET.LLVOIDDATE
*-- End of lfLockPerd


*!***************************************************************************
*! Name      : lfvOKDate
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 8/22/2004
*! Purpose   : Valid for OK Command button of the APVoidDt Screen
*!*************************************************************
*! Parameters: The FormSet, The Calling Form
*!***************************************************************************
*! Returns   : True or False
*!***************************************************************************
FUNCTION LFVOKDATE
LPARAMETERS LOFORMSET, LOFORM

LOCAL LCDISTPRD, LCDISTYER, LLLOKPER
*-- If date is Empty
IF EMPTY(LOFORMSET.LDVOIDDATE)
  *Message : " You have to select a date. "
  *Buttons : "         <    Ok    >       "
  = GFMODALGEN('INM44078B00000','Dialog')
  LOFORMSET.LDVOIDDATE = OARIAAPPLICATION.SYSTEMDATE  &&lower
  LOFORM.DTVOIDDATE.SETFOCUS()
  RETURN .F.
ENDIF

*B129328,1 WSH 08/15/2005 Update the llLokPer property only if the lfVlDate function returned True. [Start]
*loFormSet.llLokPer = .F.
*B129328,1 WSH 08/15/2005 [End]

LCDISTPRD = LOFORMSET.LCDISTPRD
LCDISTYER = LOFORMSET.LCDISTYER
LLLOKPER = LOFORMSET.LLLOKPER
IF !LFVLDATE(OARIAAPPLICATION.PRNTCOMPANYID, @LCDISTPRD, @LCDISTYER , LOFORMSET.LDVOIDDATE , @LLLOKPER)

  *B129328,1 WSH 08/15/2005 Update the void dates properties only if the lfVlDate function returned True. [Start]
  *loFormSet.lcDistPrd = lcDistPrd
  *loFormSet.lcDistYer = lcDistYer
  *loFormSet.llLokPer = llLokPer
  *B129328,1 WSH 08/15/2005 [End]

  *Message : " The voiding date should be within the posting window. "
  *Buttons : "                      <    Ok    >                     "
  =GFMODALGEN('TRM04113B00000', 'DIALOG', "voiding ")
  LOFORMSET.LDVOIDDATE = OARIAAPPLICATION.SYSTEMDATE  &&lower
  LOFORM.DTVOIDDATE.SETFOCUS()
  RETURN .F.
ENDIF

*B129328,1 WSH 08/15/2005 Update the void dates properties only if the lfVlDate function returned True. [Start]
LOFORMSET.LCDISTPRD = LCDISTPRD
LOFORMSET.LCDISTYER = LCDISTYER
LOFORMSET.LLLOKPER  = LLLOKPER
*B129328,1 WSH 08/15/2005 [End]

*-- if Period and Year is found in Fiscal period file
IF LOFORMSET.LLLOKPER
  *Message : " This date falls in a locked period."
  *Buttons : "            <    Ok    >            "
  = GFMODALGEN('TRM01258B00000','Dialog')
  LOFORMSET.LDVOIDDATE = OARIAAPPLICATION.SYSTEMDATE
  LOFORM.DTVOIDDATE.SETFOCUS()
  RETURN .F.
ELSE
  *-- If either Invoice date or Posting date is greater than the new Date entered
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	  IF loFormSet.AriaForm1.DtInvDate.Value > loFormSet.ldVoidDate OR ;
  *!*	    loFormSet.AriaForm1.DtPostDate.Value > loFormSet.ldVoidDate
  IF LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.DTINVDATE.VALUE > LOFORMSET.LDVOIDDATE OR ;
      LOFORMSET.ARIAFORM1.DTPOSTDATE.VALUE > LOFORMSET.LDVOIDDATE
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    *Message : " The voiding date cannot precede invoice date or posting date."
    *Buttons : "                   <    Ok    >                   "
    =GFMODALGEN("TRM04028B00000","DIALOG",'The voiding |invoice date or posting ')
    LOFORMSET.LDVOIDDATE = OARIAAPPLICATION.SYSTEMDATE  &&lower
    LOFORM.DTVOIDDATE.SETFOCUS()
    RETURN .F.
  ELSE    && invoice date and posting date is less than new date and also period is not locked and date is not empty
    LOFORMSET.LLVOIDDATE = .T.     && new posting date is approved
    *CLEAR READ
  ENDIF
ENDIF

RETURN .T.
*-- End of lfvOKDate

***SS2

*!*************************************************************
*! Name      : lfChckACst
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 8/16/2004
*! Purpose   : To calculate the actual cost and check
*!             that none of the actual cost will have a negative amount
*!*************************************************************
*! Parameters: The FormSet
*!*************************************************************
*! Returns            : .T. If none of the actual cost will have
*!                          a negative amount.
*!                      .F. Otherwise.
*!*************************************************************
FUNCTION LFCHCKACST
LPARAMETERS LOFORMSET

PRIVATE LLRETURN  , LCEXSTATUS , LCFULLSTAT , LCCDXFILE , LCMSSGTEXT ,;
  LCHDRFILE , LCHACTFILD , LCHFACTFLD , LCHKEYVAL , LNACTCSTNO ,;
  LCDETFILE , LCDACTFILD , LCDFACTFLD , LCDKEY    , LCDFORCOND ,;
  LCDKEYVAL , LCDQTYFILD , m.CIMTYP   , LCBOMTYPE , LNAMNTCHNG ,;
  LNCOUNT   , LCCOUNT

LLRETURN = .T.

STORE '' TO LCEXSTATUS , LCFULLSTAT , LCCDXFILE , LCMSSGTEXT

LCFULLSTAT = SET('FULLPATH')
SET FULLPATH ON

*-- Create a temp. file to hold the calculated actual cost for PO and CT
*-- header files.

*B608412,1 WAM 01/20/2008 Include cost 6 & 7 while add invoice lines
*CREATE CURSOR (loFormSet.lcActCstHd) ;
(cIMTyp C(1)        , cTktNo C(6)        , Rec_No C(36)    ,;
nActCost1 N(13,3)  , nActCost2 N(13,3)  , nActCost3 N(13,3) ,;
nActCost4 N(13,3)  , nActCost5 N(13,3)  ,;
nFActCost1 N(13,3) , nFActCost2 N(13,3) , nFActCost3 N(13,3) ,;
nFActCost4 N(13,3) , nFActCost5 N(13,3)) &&Sql1: nRecNo should be C(36)
CREATE CURSOR (LOFORMSET.LCACTCSTHD) ;
  (CIMTYP C(1)        , CTKTNO C(6)        , REC_NO C(36)    ,;
  NACTCOST1 N(13,3)  , NACTCOST2 N(13,3)  , NACTCOST3 N(13,3) ,;
  NACTCOST4 N(13,3)  , NACTCOST5 N(13,3)  , NACTCOST6 N(13,3) , NACTCOST7 N(13,3) ,;
  NFACTCOST1 N(13,3) , NFACTCOST2 N(13,3) , NFACTCOST3 N(13,3) ,;
  NFACTCOST4 N(13,3) , NFACTCOST5 N(13,3) , NFACTCOST6 N(13,3) , NFACTCOST7 N(13,3)) &&Sql1: nRecNo should be C(36)
*B608412,1 WAM 01/20/2008 (End)

ZAP
LCCDXFILE = STRTRAN(DBF() , '.TMP' , '.CDX')
*B609356,1 SMA 07/22/2010 remove of clause to prevent empty *.cdx files from creation.....[BEGIN]
*INDEX ON cIMTyp + cTktNo TAG (loFormSet.lcActCstHd) OF (lcCDXFile)
INDEX ON CIMTYP + CTKTNO TAG (LOFORMSET.LCACTCSTHD)
*B609356,1 SMA 07/22/2010 remove of clause to prevent empty *.cdx files from creation.....[END]

*B608412,1 WAM 01/20/2008 Include cost 6 & 7 while add invoice lines
*CREATE CURSOR (loFormSet.lcActCstDt) ;
(cIMTyp C(1)        , cTktNo C(6)        , Rec_No C(36)    ,;
cRSession C(6)     , cShipNo C(6)       , cItem C(19),  cColor C(6) ,;
cLineNo C(6)       , nTotQty N(10,3)    ,;
nActCost1 N(13,6)  , nActCost2 N(13,6)  , nActCost3 N(13,6) ,;
nActCost4 N(13,6)  , nActCost5 N(13,6)  ,;
nFActCost1 N(13,6) , nFActCost2 N(13,6) , nFActCost3 N(13,6) ,;
nFActCost4 N(13,6) , nFActCost5 N(13,6)) &&Sql2: nRecNo should be C(36) and check cColor
CREATE CURSOR (LOFORMSET.LCACTCSTDT) ;
  (CIMTYP C(1)        , CTKTNO C(6)        , REC_NO C(36)    ,;
  CRSESSION C(6)     , CSHIPNO C(6)       , CITEM C(19),  CCOLOR C(6) ,;
  CLINENO C(6)       , NTOTQTY N(10,3)    ,;
  NACTCOST1 N(13,6)  , NACTCOST2 N(13,6)  , NACTCOST3 N(13,6) ,;
  NACTCOST4 N(13,6)  , NACTCOST5 N(13,6)  , NACTCOST6 N(13,6), NACTCOST7 N(13,6),;
  NFACTCOST1 N(13,6) , NFACTCOST2 N(13,6) , NFACTCOST3 N(13,6) ,;
  NFACTCOST4 N(13,6) , NFACTCOST5 N(13,6) , NFACTCOST6 N(13,6) , NFACTCOST7 N(13,6)) &&Sql2: nRecNo should be C(36) and check cColor
*B608412,1 WAM 01/20/2008 (End)

ZAP
LCCDXFILE = STRTRAN(DBF() , '.TMP' , '.CDX')
*B609356,1 SMA 07/22/2010 remove of clause to prevent empty *.cdx files from creation.....[BEGIN]
*INDEX ON cIMTyp + cRSession + cShipNo + cTKtNo + cItem + cColor + cLineNo ;
TAG (loFormSet.lcActCstDt) OF (lcCDXFile) &&Sql3: Check cColor field
INDEX ON CIMTYP + CRSESSION + CSHIPNO + CTKTNO + CITEM + CCOLOR + CLINENO ;
  TAG (LOFORMSET.LCACTCSTDT)  &&Sql3: Check cColor field
*B609356,1 SMA 07/22/2010 remove of clause to prevent empty *.cdx files from creation.....[END]
SET FULLPATH &LCFULLSTAT

LCEXSTATUS = SET('EXACT')
SET EXACT OFF

*-- Set the needed order tags
IF ('I' $ LOFORMSET.LCVENINVTYPES OR 'R' $ LOFORMSET.LCVENINVTYPES) AND USED("POSHDR")
  *Old: SET ORDER TO TAG POSHDR IN POSHDR
  LOFORMSET.POSHDR.SETORDER('POSHDR') &&Sql4: Check Tag CBUSDOCU+CSTYTYPE+PO (CSTYTYPE+PO)
  *Old: SET ORDER TO TAG POSREC IN POSLN
  LOFORMSET.POSLN.SETORDER('POSREC') &&Sql5: Check Tag ;
  *CBUSDOCU+CSTYTYPE+PO+CRSESSION+SHIPNO+CINVTYPE+STYLE+STR(LINENO,6)+TRANCD+CSTYGRADE ;
  (CSTYTYPE+PO+CRSESSION+SHIPNO+STYLE+STR(LINENO,6)+TRANCD)
ENDIF
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*!*	IF 'MF' $ oAriaApplication.CompanyInstalledModules AND ;
*!*	   loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value = oAriaApplication.BaseCurrency AND ;
*!*	   'M' $ loFormSet.lcVenInvTypes
*! B610205,1 HIA 01/20/2013 Aria4xp - AP - AP Invoice error message + incorrect ncurrunit update[T20130114.0001][Start]
*IF 'MF' $ OARIAAPPLICATION.COMPANYINSTALLEDMODULES AND ;
    LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.KEYTEXTBOX.VALUE = OARIAAPPLICATION.BASECURRENCY AND ;
    'M' $ LOFORMSET.LCVENINVTYPES
IF 'MF' $ OARIAAPPLICATION.COMPANYINSTALLEDMODULES AND ;
    LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.KEYTEXTBOX.VALUE = OARIAAPPLICATION.BASECURRENCY AND ;
    'M' $ LOFORMSET.LCVENINVTYPES AND USED('CUTTKTH')
*! B610205,1 HIA 01/20/2013 Aria4xp - AP - AP Invoice error message + incorrect ncurrunit update[T20130114.0001][End]
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  *Old: SET ORDER TO TAG CUTTKTH IN CUTTKTH
  LOFORMSET.CUTTKTH.SETORDER('POSHDR') &&Sql6: Check Tag CBUSDOCU+CSTYTYPE+PO (CUTTKT)
  *Old: SET ORDER TO TAG CUTREC  IN CUTTKTL
  LOFORMSET.CUTTKTL.SETORDER('POSREC') &&Sql7: Check Tag (CRSESSION+CUTTKT+STYLE+TRANCD)
ENDIF

IF ('L' $ LOFORMSET.LCVENINVTYPES OR 'F' $ LOFORMSET.LCVENINVTYPES) AND USED("POFHDR")
  *Old: SET ORDER TO TAG POFHDR IN POFHDR
  LOFORMSET.POFHDR.SETORDER('POSHDR') &&Sql8: Check Tag CBUSDOCU+CSTYTYPE+PO (CMATTYPE+POMAT)
  *Old: SET ORDER TO TAG POFREC IN POFLN
  LOFORMSET.POFLN.SETORDER('POSREC') &&Sql9: Check Tag (CMATTYPE+POMAT+CRSESSION+FABRIC+COLOR+TRANCD)
ENDIF

*-- Recall the deleted records
SELECT (LOFORMSET.LCAPINVTKT)
RECALL ALL

*-- Recall the deleted records and set the needed order tag
SELECT (LOFORMSET.LCAPVINVDT)
RECALL ALL

*Fix bug when Saving the debit memo againest Return PO [BEGIN]
SELECT (LOFORMSET.LCAPINVTKT)
REPLACE ALL NAPAPLAMNT WITH NAPAPLAMNT * -1,;
  NAPAPLPRIC WITH NAPAPLPRIC * -1 FOR (CIMTYP $ 'RF' AND (NAPAPLAMNT < 0 ))

SELECT (LOFORMSET.LCAPVINVDT)
REPLACE ALL NAPAPRAMNT WITH NAPAPRAMNT * -1,;
  NAPAPRPRIC WITH NAPAPRPRIC * -1,;
  NAPPRICE   WITH NAPPRICE   * -1,;
  NAPAMNT    WITH NAPAMNT    * -1 FOR (CIMTYP $ 'RF' AND (NAPAPRAMNT < 0 ))
*Fix bug when Saving the debit memo againest Return PO [END]
SET ORDER TO TAG ITEM
GO TOP

*-- Do while there is no troubles in the records locking and the end of file
*-- has not been reached yet.
DO WHILE LLRETURN .AND. !EOF()

  *-- lcHdrFile   Variable to hold the name of the header file for the
  *--             current document type.
  *-- lcHActFild  Variable to hold the name of the actual cost field in the
  *--             header file for the current document type.
  *-- lcHFActFld  Variable to hold the name of the actual cost in foreign
  *--             currency field in the header file for the current
  *--             document type.
  *-- lcHKeyVal   Variable to hold the key value to be used while searching
  *--             for the record that will be updated in the header file.
  *-- lcDetFile   Variable to hold the name of the detail file for the
  *--             current document type.
  *-- lcDActFild  Variable to hold the name of the actual cost field in the
  *--             detail file for the current document type.
  *-- lcDFActFld  Variable to hold the name of the actual cost in foreign
  *--             currency field in the detail file for the current
  *--             document type.
  *-- lcDKey      Variable to hold the expression that will be used to get
  *--             the key value that will be used for searching for the
  *--             record that will be updated in the detail file.
  *-- lcDForCond  Variable to hold a string of the expression that will be
  *--             used as the FOR expression while searching for the record
  *--             that will be updated in the detail file.
  *-- lcDQtyFild  Variable to hold the name of the total quantity field in
  *--             the detail file for the current document type.

  STORE '' TO LCHDRFILE  , LCHACTFILD , LCHFACTFLD , LCHKEYVAL  ,;
    LCDETFILE  , LCDACTFILD , LCDFACTFLD , LCDKEY     ,;
    LCDFORCOND , LCDQTYFILD


  *-- lnActCstNo  Variable to hold the number of actual cost fields for the
  *--             current document type.

  STORE 0  TO LNACTCSTNO

  DO CASE
    *-- Case of document type "General Expense"
  CASE CIMTYP = 'G'
    SEEK 'H'
    IF RECNO(0) <> 0
      GO RECNO(0)
    ENDIF
    LOOP

    *-- Case of document types "Style Purchase Order", "Style Purchase
    *-- Order Return" and "Shipment"
  CASE INLIST(CIMTYP , 'I' , 'R' , 'S')


    LCHDRFILE  = 'POSHDR'
    LCHACTFILD = 'nAct_Cost'
    LCHFACTFLD = 'nFActCost'
    LCHKEYVAL  = IIF(CIMTYP = 'R' , 'RP' , 'PP') &&Sql10: Check Key


    *B608412,1 WAM 01/20/2008 Include cost 6 & 7 while add invoice lines
    *lnActCstNo  = 5
    LNACTCSTNO  = 7
    *B608412,1 WAM 01/20/2008 (End)

    LCDETFILE  = 'POSLN'
    LCDACTFILD = 'nAct_Cost'
    LCDFACTFLD = 'nFactCost'

    *(Begin) Assigning the appropriate values
    *and setting the correct index in case
    *of shipment.
    IF CIMTYP <> 'S'
      *CBUSDOCU+CSTYTYPE+PO+CRSESSION+SHIPNO+CINVTYPE+STYLE+STR(LINENO,6)+TRANCD+CSTYGRADE
      LCDKEY     = "IIF(m.cIMTyp = 'R' , 'RP' , 'PP') + cTKtNo + cRSession" &&Sql11: Check Key
    ELSE
      *Old: SET ORDER TO TAG POSHREC IN POSLN
      LOFORMSET.POSLN.SETORDER('POSHREC')  &&Sql12: Check Tag ;
      *SHIPNO+CRSESSION+CBUSDOCU+CSTYTYPE+PO+CINVTYPE+STYLE+STR(LINENO,6)+TRANCD ;
      (SHIPNO+CRSESSION+CSTYTYPE+PO+STYLE+STR(LINENO,6)+TRANCD)
      LCDKEY = "EVALUATE(loFormSet.lcApVInvDt+'.ShipNo') + cRSession + 'PP'" &&Sql13: Check Key
    ENDIF

    IF CIMTYP <> 'S'
      LCDFORCOND = "cInvType='0001' AND Style = EVALUATE(loFormSet.lcAPInvTkt+'.Item') AND "+;
        "STR(LineNo , 6) = STR(EVALUATE(loFormSet.lcAPInvTkt+'.LineNo') , 6)"
    ELSE
      LCDFORCOND = "PO = cTKtNo AND cInvType='0001' AND Style = EVALUATE(loFormSet.lcAPInvTkt+'.Item') AND "+;
        "STR(LineNo , 6) = STR(EVALUATE(loFormSet.lcAPInvTkt+'.LineNo') , 6)"
    ENDIF

    LCDQTYFILD = 'TotQty'

    *-- Case of document type "Cutting Ticket"
  CASE CIMTYP = 'M'
    LCHDRFILE  = 'CUTTKTH'
    LCHACTFILD = 'nAct_Cost'
    LCHKEYVAL  = 'PU' &&Sql14: Check Key
    *B608412,1 WAM 01/20/2008 Include cost 6 & 7 while add invoice lines
    *lnActCstNo = 5
    LNACTCSTNO = 7
    *B608412,1 WAM 01/20/2008 (End)

    LCDETFILE  = 'CUTTKTL'
    LCDACTFILD = 'nAct_Cost'
    *CBUSDOCU+CSTYTYPE+PO+CRSESSION+SHIPNO+CINVTYPE+STYLE+STR(LINENO,6)+TRANCD+CSTYGRADE
    LCDKEY     = "'PU' + cTKtNo + cRSession" &&Sql15: Check Key
    LCDFORCOND = "cInvType='0001' AND Style = EVALUATE(loFormSet.lcAPInvTkt+'.Item') AND "+;
      "STR(LineNo , 6) = STR(EVALUATE(loFormSet.lcAPInvTkt+'.LineNo') , 6)"
    LCDQTYFILD = 'TotQty'

    *-- Case of document types "Material PO" and "Material PO Return"
  CASE INLIST(CIMTYP , 'L' , 'F')
    LCHDRFILE  = 'POFHDR'
    LCHACTFILD = 'nAct_Cost'
    LCHFACTFLD = 'nFActCost'
    LCHKEYVAL  = IIF(CIMTYP = 'L' , 'PM' , 'RM') &&Sql16: Check Key
    LNACTCSTNO = 5
    LCDETFILE  = 'POFLN'
    LCDACTFILD = 'nAct_Cost'
    LCDFACTFLD = 'nFactCost'
    *CBUSDOCU+CSTYTYPE+PO+CRSESSION+SHIPNO+CINVTYPE+STYLE+STR(LINENO,6)+TRANCD+CSTYGRADE
    LCDKEY     = "IIF(cIMTyp = 'L' , 'PM' , 'RM') + cTKtNo + cRSession" &&Sql17: Check Key
    LCDFORCOND = "cInvType='0002' AND Style = lfupditem(EVALUATE(loFormSet.lcAPInvTkt+'.Item'),EVALUATE(loFormSet.lcAPInvTkt+'.Color')) AND "+;
      "STR(LineNo , 6) = STR(EVALUATE(loFormSet.lcAPInvTkt+'.LineNo') , 6)"
    LCDQTYFILD = 'TotQty'

    *Fix the contribution process  to save the invoice [Begin]
  CASE INLIST(CIMTYP , 'T')
    LCALIAS = ALIAS()
    LCHDRFILE  = 'MMFGORDH'
    LCHACTFILD = 'nAct_Cost'
    LCHKEYVAL  = 'PF' &&Sql18: Check Key
    LNACTCSTNO = 5
    LCDETFILE  = 'MMFGORDD'
    LCDACTFILD = 'nAct_Cost'
    *CBUSDOCU+CSTYTYPE+PO+CRSESSION+SHIPNO+CINVTYPE+STYLE+STR(LINENO,6)+TRANCD+CSTYGRADE
    LCDKEY     = "'PF' + cTKtNo + cRSession"
    LCDFORCOND = "cInvType='0002' AND Style = lfupditem(EVALUATE(loFormSet.lcAPInvTkt+'.Item'),EVALUATE(loFormSet.lcAPInvTkt+'.Color')) AND "+;
      "STR(LineNo , 6) = STR(EVALUATE(loFormSet.lcAPInvTkt+'.LineNo') , 6)"
    LCDQTYFILD = 'TotQty'
    *Old: lcDKey     = "cRSession + cTKtNo + SUBSTR(ITEM , 1 , 7) + Color"
    *Old: lcDForCond = ".T."
    *Old: SELECT (lcDetFile)
    *Old: SET ORDER TO TAG Mfgrec
    *!* loFormSet.MMFGORDD.SetOrder('Mfgrec') &&Sql20: Check Tag (CRSESSION+CMFGORDNO+CFABRIC+COLOR+TRANCD)
    SELECT (LCALIAS)
    *Fix the contribution process  to save the invoice [End]
    *Add Adorment order to invoice line [Begin]
  CASE INLIST(CIMTYP , 'A' )
    LCHDRFILE  = 'POSHDR'
    LCHACTFILD = 'nAct_Cost'
    LCHFACTFLD = 'nFActCost'
    LCHKEYVAL  = 'PA' &&Sql21: Check Key
    LNACTCSTNO  = 5
    LCDETFILE  = 'POSLN'
    LCDACTFILD = 'nAct_Cost'
    LCDFACTFLD = 'nFactCost'
    *CBUSDOCU+CSTYTYPE+PO+CRSESSION+SHIPNO+CINVTYPE+STYLE+STR(LINENO,6)+TRANCD+CSTYGRADE
    LCDKEY     = "'PA' + cTKtNo + cRSession" +;
      "EVALUATE(loFormSet.lcApVInvDt+'.ShipNo') + '0001' + EVALUATE(loFormSet.lcAPInvTkt+'.Item') "+;
      "STR(EVALUATE(loFormSet.lcAPInvTkt+'.LineNo') , 6)" &&Sql22: Check Key
    LCDFORCOND = ".T."
    LCDQTYFILD = 'TotQty'

  CASE INLIST(CIMTYP , 'D' )
    LCHDRFILE  = 'POSHDR'
    LCHACTFILD = 'nAct_Cost'
    LCHFACTFLD = 'nFActCost'
    LCHKEYVAL  = 'PD' &&Sql23: Check Key
    LNACTCSTNO  = 5
    LCDETFILE  = 'POSLN'
    LCDACTFILD = 'nAct_Cost'
    LCDFACTFLD = 'nFactCost'
    *CBUSDOCU+CSTYTYPE+PO+CRSESSION+SHIPNO+CINVTYPE+STYLE+STR(LINENO,6)+TRANCD+CSTYGRADE
    LCDKEY     = "'PD' + cTKtNo + cRSession + " +;
      "EVALUATE(loFormSet.lcApVInvDt+'.ShipNo') + '0001' + EVALUATE(loFormSet.lcAPInvTkt+'.Item') "+;
      "STR(EVALUATE(loFormSet.lcAPInvTkt+'.LineNo') , 6)" &&Sql24: Check Key
    LCDFORCOND = ".T."
    LCDQTYFILD = 'TotQty'

  ENDCASE

  m.CIMTYP = CIMTYP

  *-- Scan while there no troubles in the records locking and the document
  *-- type didn't change for the records with status <> same
  *-- Note: The seek() function in the for condition is not used as a
  *--       condition it's used to replace the record pointer on the first
  *--       corresponding record in the file (lcAPInvTkt).
  SCAN WHILE LLRETURN .AND. CIMTYP = m.CIMTYP;
      FOR CSTATUS <> 'S' .AND.;
      SEEK(CVENDCODE + CAPINVNO + CAPVILNO , LOFORMSET.LCAPINVTKT)

    *-- Flag to know if the record has been deleted
    LLDELETED = (CSTATUS='D') OR ((NRECNO = 0) AND (CSTATUS= 'S'))
    *-- Variable to hold the record number of the corresponding record in
    *-- the master file
    LNRECNO   = NRECNO

    *-- Replace the record pointer on the corresponding record in the
    *-- master file.
    IF BETWEEN( LNRECNO ,1, RECCOUNT('APVINVDT'))
      GO LNRECNO IN APVINVDT
    ENDIF

    LCBOMTYPE  = CBOMTYPE

    *-- Get the change that has been made to the applied amount for this
    *-- record
    LNAMNTCHNG = IIF(LLDELETED   , 0 , NAPAPRAMNT) -;
      IIF(LNRECNO = 0 , 0 , APVINVDT.NAPAPRAMNT)

    *(Begin) Adding the IF command to check if
    *invoicing by shimpment the do lfUpdPoHAc()
    *that will update the PosHdr actual cost
    IF CIMTYP = "S"
      *-- This function is used to update the actual cost for the poshdr
      *-- file in case of invoicing by shimpment.
      =LFUPDPOHAC(LOFORMSET)
    ELSE

      *-- If there is a header file that should be updated for the current
      *-- document type.
      IF !EMPTY(LCHDRFILE)

        *-- If there is no records for this document number in the actual
        *-- cost temp. header file
        IF !SEEK(m.CIMTYP + CTKTNO , LOFORMSET.LCACTCSTHD)
          m.CTKTNO = CTKTNO

          *-- Go to the record that will be updated in the header file
          SELECT (LCHDRFILE)
          *(Begin) Changing the seek command to be
          *IF seek in order to don't try to lock the
          *record or update the actual cost in the
          * header file in case of not seek in the
          *header file

          *SEEK lcHKeyVal + m.cTktNo
          *Old: IF SEEK (lcHKeyVal + m.cTktNo)
          IF LOFORMSET.&LCHDRFILE..SEEK (LCHKEYVAL + m.CTKTNO)  &&Sql27: Check Key

            *-- Attempt to lock the record
            IF .T. && gfObj_Lock(.T.) is not needed
              m.REC_NO = REC_NO &&Sql28: Check RowId

              *B608412,1 WAM 01/20/2008 Include cost 6 & 7 while add invoice lines
              *STORE 0 TO m.nActCost1  , m.nActCost2  , m.nActCost3 ,;
              m.nActCost4  , m.nActCost5  ,;
              m.nFActCost1 , m.nFActCost2 , m.nFActCost3 ,;
              m.nFActCost4 , m.nFActCost5
              STORE 0 TO m.NACTCOST1  , m.NACTCOST2  , m.NACTCOST3 ,;
                M.NACTCOST4  , m.NACTCOST5  , m.NACTCOST6, m.NACTCOST7,;
                M.NFACTCOST1 , m.NFACTCOST2 , m.NFACTCOST3 ,;
                M.NFACTCOST4 , m.NFACTCOST5 , m.NFACTCOST6, m.NFACTCOST7
              *B608412,1 WAM 01/20/2008 (End)

              *-- If there is no fields for the actual cost in foreign currency
              IF EMPTY(LCHFACTFLD)
                *-- Get the actual cost
                FOR LNCOUNT = 1 TO LNACTCSTNO
                  LCCOUNT            = ALLTRIM(STR(LNCOUNT))
                  m.NACTCOST&LCCOUNT = &LCHACTFILD.&LCCOUNT
                ENDFOR
              ELSE    && Else [If there is fields for the actual cost in foreign currency]
                *-- Get the actual cost
                FOR LNCOUNT = 1 TO LNACTCSTNO
                  LCCOUNT             = ALLTRIM(STR(LNCOUNT))
                  m.NACTCOST&LCCOUNT  = &LCHACTFILD.&LCCOUNT
                  m.NFACTCOST&LCCOUNT = &LCHFACTFLD.&LCCOUNT
                ENDFOR
              ENDIF

              *-- Add a corresponding record in the temp. file
              INSERT INTO (LOFORMSET.LCACTCSTHD) FROM MEMVAR
            ELSE    && Else [If the attempt to lock the record failed]
              LLRETURN = .F.
              EXIT
            ENDIF    && End of IF gfObj_Lock(.T.)

          ENDIF

        ENDIF    && End of IF !SEEK(m.cIMTyp + cTktNo , loFormSet.lcActCstHd)

        *-- Update total actual cost in the temp. header file
        SELECT (LOFORMSET.LCACTCSTHD)

        LCTEMP = '(lnAmntChng'+LOFORMSET.LCEXSIN1+'loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.Value'+;
          +LOFORMSET.LCEXSIN2+'apinvhdr.ncurrunit)'
        *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][Start]
        TRY
          *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][End]
          REPLACE NACTCOST&LCBOMTYPE WITH NACTCOST&LCBOMTYPE + &LCTEMP
          *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][Start]
        CATCH
        ENDTRY
        *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][End]
        *-- Update total actual cost in foreign currency in the temp. header
        *-- file
        IF !EMPTY(LCHFACTFLD)
          REPLACE NFACTCOST&LCBOMTYPE WITH NFACTCOST&LCBOMTYPE + LNAMNTCHNG
        ENDIF    && End of IF !EMPTY(lcHFActFld)
      ENDIF    && End of IF !EMPTY(lcHdrFile)

    ENDIF
    SELECT (LOFORMSET.LCAPINVTKT)
    *-- Scan the corresponding records in the detail file (lcAPInvTkt) with
    *-- receiving session not empty.

    SCAN REST;
        WHILE CVENDCODE + CAPINVNO + CAPVILNO = EVALUATE(LOFORMSET.LCAPVINVDT+'.cVendCode') +;
        EVALUATE(LOFORMSET.LCAPVINVDT+'.cApInvNo') + EVALUATE(LOFORMSET.LCAPVINVDT+'.cAPVILNo');
        FOR !EMPTY(CRSESSION)

      *-- Flag to know if the record has been deleted
      LLDELETED = (CSTATUS='D') OR ((NRECNO = 0) AND (CSTATUS= 'S'))
      *-- Variable to hold the record number of the corresponding record in
      *-- the master file
      LNRECNO   = NRECNO

      *-- Replace the record pointer on the corresponding record in the
      *-- master file.
      IF BETWEEN(LNRECNO ,1,RECCOUNT('APINVTKT'))
        GO LNRECNO IN APINVTKT
      ENDIF

      *-- Get the change that has been made to the applied amount for this
      *-- record

      LNAMNTCHNG = IIF(LLDELETED   , 0 , NAPAPLAMNT) -;
        IIF(LNRECNO = 0 , 0 , APINVTKT.NAPAPLAMNT)

      *-- If there is no records for this document number in the actual
      *-- cost temp. detail file


      IF !SEEK(CIMTYP + CRSESSION + EVALUATE(LOFORMSET.LCAPVINVDT+'.ShipNo') + CTKTNO + ;
          ITEM + COLOR + STR(LINENO,6) , LOFORMSET.LCACTCSTDT)

        *B608412,1 WAM 01/20/2008 Include cost 6 & 7 while add invoice lines
        *STORE 0 TO m.nActCost1  , m.nActCost2  , m.nActCost3 ,;
        m.nActCost4  , m.nActCost5  ,;
        m.nFActCost1 , m.nFActCost2 , m.nFActCost3 ,;
        m.nFActCost4 , m.nFActCost5
        STORE 0 TO m.NACTCOST1  , m.NACTCOST2  , m.NACTCOST3 ,;
          M.NACTCOST4  , m.NACTCOST5  , m.NACTCOST6, m.NACTCOST7,;
          M.NFACTCOST1 , m.NFACTCOST2 , m.NFACTCOST3 ,;
          M.NFACTCOST4 , m.NFACTCOST5 , m.NFACTCOST6, m.NFACTCOST7
        *B608412,1 WAM 01/20/2008 (End)

        m.CIMTYP    = CIMTYP
        m.CRSESSION = CRSESSION
        m.CSHIPNO   = EVALUATE(LOFORMSET.LCAPVINVDT+'.ShipNo')
        m.CTKTNO    = CTKTNO
        m.CITEM     = ITEM
        m.CCOLOR    = COLOR
        m.CLINENO   = STR(LINENO,6)
        *-- Go to the record that will be updated in the header file
        LCDKEYVAL = EVALUATE(LCDKEY)
        SELECT (LCDETFILE)
        *Old:LLSEEK = SEEK (lcDKeyVal)
        LLSEEK = LOFORMSET.&LCDETFILE..SEEK (LCDKEYVAL)  &&Sql29: Check Key
        *Old: LOCATE REST;
        WHILE EVALUATE(SYS(14,VAL(SYS(21)))) = lcDKeyVal;
        FOR EVALUATE(lcDForCond)
        SELECT (LCDETFILE)
        LOCATE FOR EVALUATE(LCDFORCOND)
        *MESSAGEBOX(lcDKey+CHR(13)+lcDKeyVal+CHR(13)+IIF(EOF(),'Eof','Not Eof')+CHR(13)+lcDetFile+CHR(13)+lcDForCond)
        *GO TOP
        *MESSAGEBOX(PADR(RECCOUNT(),10)+CHR(13)+;
        lfupditem(EVALUATE(loFormSet.lcAPInvTkt+'.Item'),EVALUATE(loFormSet.lcAPInvTkt+'.Color'))+CHR(13)+;
        STR(EVALUATE(loFormSet.lcAPInvTkt+'.LineNo') , 6)+CHR(13)+style+CHR(13)+STR(LineNo,6))
        *-- Attempt to lock the record
        IF !EOF() && gfObj_Lock(.T.) is not needed
          m.REC_NO    = REC_NO &&Sql30: Check RowID
          m.NTOTQTY   = &LCDQTYFILD

          *-- If there is no fields for the actual cost in foreign currency
          IF EMPTY(LCDFACTFLD)

            *-- Get the actual cost
            FOR LNCOUNT = 1 TO LNACTCSTNO
              LCCOUNT            = ALLTRIM(STR(LNCOUNT))
              m.NACTCOST&LCCOUNT = &LCDACTFILD.&LCCOUNT
            ENDFOR    && End of FOR lnCount = 1 TO lnActCstNo
          ELSE    && Else [If there is fields for the actual cost in foreign currency]

            *-- Get the actual cost
            FOR LNCOUNT = 1 TO LNACTCSTNO
              LCCOUNT             = ALLTRIM(STR(LNCOUNT))
              m.NACTCOST&LCCOUNT  = &LCDACTFILD.&LCCOUNT
              m.NFACTCOST&LCCOUNT = &LCDFACTFLD.&LCCOUNT
            ENDFOR    && End of FOR lnCount = 1 TO lnActCstNo
          ENDIF    && End of IF EMPTY(lcDFActFld)

          *-- Add a corresponding record in the temp. file
          INSERT INTO (LOFORMSET.LCACTCSTDT) FROM MEMVAR
        ELSE    && Else [If the attempt to lock the record failed]
          LLRETURN = .F.
          EXIT
        ENDIF    && End of IF gfObj_Lock(.T.)
      ENDIF    && End of IF !SEEK(cIMTyp + cRSession + ...

      SELECT (LOFORMSET.LCACTCSTDT)

      *-- Update total actual cost in the temp. detail file
      LCTEMP = '((IIF(nTotQty=0,0,lnAmntChng / nTotQty)) '+LOFORMSET.LCEXSIN1+;
        'loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.Value'+LOFORMSET.LCEXSIN2+'apinvhdr.ncurrunit)'
      *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][Start]
      TRY
        *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][End]
        REPLACE NACTCOST&LCBOMTYPE WITH NACTCOST&LCBOMTYPE + &LCTEMP
        *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][Start]
      CATCH
      ENDTRY
      *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][End]
      *-- Update total actual cost in foreign currency in the temp. detail
      *-- file
      IF !EMPTY(LCDFACTFLD)
        REPLACE NFACTCOST&LCBOMTYPE WITH NFACTCOST&LCBOMTYPE +;
          (IIF(NTOTQTY=0,0,LNAMNTCHNG / NTOTQTY))

      ENDIF    && End of IF !EMPTY(lcDFActFld)
    ENDSCAN    && End of SCAN REST WHILE cVendCode + cApInvNo + cApVILNo ...

    SELECT (LOFORMSET.LCAPVINVDT)
  ENDSCAN    && End of   SCAN WHILE llReturn .AND. cIMTyp = m.cIMTyp ...
ENDDO    && End of DO WHILE llReturn .AND. !EOF()

*-- If there was no troubles found in the records locking
IF LLRETURN

  *-- Search for a record with negative actual cost in the temp. actual
  *-- cost header file
  SELECT (LOFORMSET.LCACTCSTHD)
  *B608412,1 WAM 01/20/2008 Include cost 6 & 7 while add invoice lines
  *LOCATE FOR nActCost1 < 0 .OR.;
  nActCost2 < 0 .OR.;
  nActCost3 < 0 .OR.;
  nActCost4 < 0 .OR.;
  nActCost5 < 0
  LOCATE FOR NACTCOST1 < 0 .OR.;
    NACTCOST2 < 0 .OR.;
    NACTCOST3 < 0 .OR.;
    NACTCOST4 < 0 .OR.;
    NACTCOST5 < 0 .OR.;
    NACTCOST6 < 0 .OR.;
    NACTCOST7 < 0
  *B608412,1 WAM 01/20/2008 (End)

  *-- If there is a record with negative actual cost in the temp. actual
  *-- cost header file
  IF FOUND()
    LLRETURN  = .F.

    *-- Get the variable part of the error message
    DO CASE
    CASE CIMTYP = 'I'
      LCMSSGTEXT = 'style purchase order'

    CASE CIMTYP = 'R'
      LCMSSGTEXT = 'style purchase order return'

    CASE CIMTYP = 'M'
      LCMSSGTEXT = 'cutting ticket'

    CASE CIMTYP = 'L'
      LCMSSGTEXT = 'material PO'

    CASE CIMTYP = 'F'
      LCMSSGTEXT = 'material PO return'
    CASE CIMTYP = 'T'
      LCMSSGTEXT = 'material MFG order'
    CASE CIMTYP = 'A'
      LCMSSGTEXT = 'Ador P/O'
    CASE CIMTYP = 'D'
      LCMSSGTEXT = 'Dye P/O'

    ENDCASE
    LCMSSGTEXT = LCMSSGTEXT + ' No. ' + CTKTNO

    *-- Message : 04188
    *-- "The debit amount applied to (lcMssgText) will produce a negative "
    *-- "actual cost. Cannot proceed with the saving process.             "
    *-- Button : 00000
    *-- "                          <    Ok    >                           "
    =GFMODALGEN("TRM04188B00000" , "DIALOG" , LCMSSGTEXT)
  ENDIF    && End of IF FOUND()
ENDIF    && End of IF llReturn

*-- If there was no troubles found in the records locking and no records
*-- with negative actual cost found in the temp. actual cost header file.
IF LLRETURN

  *-- Search for a record with negative actual cost in the temp. actual
  *-- cost detail file.
  SELECT (LOFORMSET.LCACTCSTDT)
  *B608412,1 WAM 01/20/2008 Include cost 6 & 7 while add invoice lines
  *LOCATE FOR nActCost1 < 0 .OR.;
  nActCost2 < 0 .OR.;
  nActCost3 < 0 .OR.;
  nActCost4 < 0 .OR.;
  nActCost5 < 0
  LOCATE FOR NACTCOST1 < 0 .OR.;
    NACTCOST2 < 0 .OR.;
    NACTCOST3 < 0 .OR.;
    NACTCOST4 < 0 .OR.;
    NACTCOST5 < 0 .OR.;
    NACTCOST6 < 0 .OR.;
    NACTCOST7 < 0
  *B608412,1 WAM 01/20/2008 Include cost 6 & 7 while add invoice lines

  *-- If there is a record with negative actual cost in the temp. actual
  *-- cost detail file
  IF FOUND()
    LLRETURN  = .F.

    *-- Get the variable part of the error message
    DO CASE
    CASE CIMTYP = 'I'
      *N000682,1 MMT 11/22/2012 Globalization changes[Start]
      *LCMSSGTEXT = 'style purchase order No. ' + CTKTNO +;
        ', receiving session No. ' + CRSESSION +;
        ', line No. ' + ALLTRIM(CLINENO)
      LCMSSGTEXT = IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_STYLEPONO,loFormSet.GetHeaderText("LANG_APPYINV_STYLEPONO",loFormSet.HeaderAlias))  + CTKTNO +;
        IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_RECSESSIONNO,loFormSet.GetHeaderText("LANG_APPYINV_RECSESSIONNO",loFormSet.HeaderAlias)) + CRSESSION +;
IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_LINENO,loFormSet.GetHeaderText("LANG_APPYINV_LINENO",loFormSet.HeaderAlias)) + ALLTRIM(CLINENO)


      *N000682,1 MMT 11/22/2012 Globalization changes[END]
    CASE CIMTYP = 'R'
    *N000682,1 MMT 11/22/2012 Globalization changes[Start]
      *LCMSSGTEXT = 'style purchase order return No. ' + CTKTNO +;
        ', receiving session No. ' + CRSESSION +;
        ', line No. ' + ALLTRIM(CLINENO)
      LCMSSGTEXT = IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_STYLEPORETNO,loFormSet.GetHeaderText("LANG_APPYINV_STYLEPORETNO",loFormSet.HeaderAlias)) + CTKTNO +;
       IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_RECSESSIONNO,loFormSet.GetHeaderText("LANG_APPYINV_RECSESSIONNO",loFormSet.HeaderAlias)) + CRSESSION +;
IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_LINENO,loFormSet.GetHeaderText("LANG_APPYINV_LINENO",loFormSet.HeaderAlias)) + ALLTRIM(CLINENO)

      *N000682,1 MMT 11/22/2012 Globalization changes[END]
    CASE CIMTYP = 'S'
      *N000682,1 MMT 11/22/2012 Globalization changes[Start]
      *LCMSSGTEXT = 'shipment No. ' + CSHIPNO +;
        ', receiving session No. ' + CRSESSION +;
        ', style purchase order No. ' + CTKTNO +;
        ', line No. ' + ALLTRIM(CLINENO)
      LCMSSGTEXT = IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_STYLESHIPNO,loFormSet.GetHeaderText("LANG_APPYINV_STYLESHIPNO",loFormSet.HeaderAlias))  + CSHIPNO +;
        IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_RECSESSIONNO,loFormSet.GetHeaderText("LANG_APPYINV_RECSESSIONNO",loFormSet.HeaderAlias)) + CRSESSION +;
        ', '+IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_STYLEPONO,loFormSet.GetHeaderText("LANG_APPYINV_STYLEPONO",loFormSet.HeaderAlias)) + CTKTNO +;
IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_LINENO,loFormSet.GetHeaderText("LANG_APPYINV_LINENO",loFormSet.HeaderAlias))+ ALLTRIM(CLINENO)


      *N000682,1 MMT 11/22/2012 Globalization changes[END]
    CASE CIMTYP = 'M'
     *N000682,1 MMT 11/22/2012 Globalization changes[Start]
     * LCMSSGTEXT = 'cutting ticket No. ' + CTKTNO +;
        ', receiving session No. ' + CRSESSION +;
        ', line No. ' + ALLTRIM(CLINENO)
      LCMSSGTEXT = IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_STYLECTNO,loFormSet.GetHeaderText("LANG_APPYINV_STYLECTNO",loFormSet.HeaderAlias)) + CTKTNO +;
        IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_RECSESSIONNO,loFormSet.GetHeaderText("LANG_APPYINV_RECSESSIONNO",loFormSet.HeaderAlias)) + CRSESSION +;
IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_LINENO,loFormSet.GetHeaderText("LANG_APPYINV_LINENO",loFormSet.HeaderAlias)) + ALLTRIM(CLINENO)


      *N000682,1 MMT 11/22/2012 Globalization changes[END]
    CASE CIMTYP = 'L'
      *N000682,1 MMT 11/22/2012 Globalization changes[Start]
      *LCMSSGTEXT = 'material PO No. ' + CTKTNO +;
        ', receiving session No. '+ CRSESSION +;
        ', line No. ' + ALLTRIM(CLINENO)
     LCMSSGTEXT = IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_MAEPONO,loFormSet.GetHeaderText("LANG_APPYINV_MAEPONO",loFormSet.HeaderAlias))  + CTKTNO +;
        IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_RECSESSIONNO,loFormSet.GetHeaderText("LANG_APPYINV_RECSESSIONNO",loFormSet.HeaderAlias)) + CRSESSION +;
IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_LINENO,loFormSet.GetHeaderText("LANG_APPYINV_LINENO",loFormSet.HeaderAlias)) + ALLTRIM(CLINENO)


      *N000682,1 MMT 11/22/2012 Globalization changes[END]
    CASE CIMTYP = 'F'
      *N000682,1 MMT 11/22/2012 Globalization changes[Start]
      *LCMSSGTEXT = 'material PO return No. ' + CTKTNO +;
        ', receiving session No. '+ CRSESSION +;
        ', line No. '+ ALLTRIM(CLINENO)
      LCMSSGTEXT = IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_MAPORETNO,loFormSet.GetHeaderText("LANG_APPYINV_MAPORETNO",loFormSet.HeaderAlias))+ CTKTNO +;
        IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_RECSESSIONNO,loFormSet.GetHeaderText("LANG_APPYINV_RECSESSIONNO",loFormSet.HeaderAlias)) + CRSESSION +;
IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_LINENO,loFormSet.GetHeaderText("LANG_APPYINV_LINENO",loFormSet.HeaderAlias)) + ALLTRIM(CLINENO)
      *N000682,1 MMT 11/22/2012 Globalization changes[END]
    CASE CIMTYP = 'T'
      *N000682,1 MMT 11/22/2012 Globalization changes[Start]
      *LCMSSGTEXT = 'material MFG order No. ' + CTKTNO +;
        ', receiving session No. ' + CRSESSION
      LCMSSGTEXT = IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_MAMFGNO,loFormSet.GetHeaderText("LANG_APPYINV_MAMFGNO",loFormSet.HeaderAlias)) + CTKTNO +;
IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_RECSESSIONNO,loFormSet.GetHeaderText("LANG_APPYINV_RECSESSIONNO",loFormSet.HeaderAlias)) + CRSESSION

      *N000682,1 MMT 11/22/2012 Globalization changes[END]
    CASE CIMTYP = 'A'
      *N000682,1 MMT 11/22/2012 Globalization changes[Start]
      *LCMSSGTEXT = 'Adorment order No. ' + CTKTNO +;
        ', receiving session No. '+ CRSESSION +;
        ', line No. ' + ALLTRIM(CLINENO)
      LCMSSGTEXT = IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_ADORNO,loFormSet.GetHeaderText("LANG_APPYINV_ADORNO",loFormSet.HeaderAlias)) +CTKTNO +;
        IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_RECSESSIONNO,loFormSet.GetHeaderText("LANG_APPYINV_RECSESSIONNO",loFormSet.HeaderAlias)) + CRSESSION +;
IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_LINENO,loFormSet.GetHeaderText("LANG_APPYINV_LINENO",loFormSet.HeaderAlias)) + ALLTRIM(CLINENO)



    CASE CIMTYP = 'D'
      *N000682,1 MMT 11/22/2012 Globalization changes[Start]
      *LCMSSGTEXT = 'Dying order No. ' + CTKTNO +;
        ', receiving session No. ' + CRSESSION +;
        ', line No. ' + ALLTRIM(CLINENO)
      LCMSSGTEXT = IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_DYEORDNO,loFormSet.GetHeaderText("LANG_APPYINV_DYEORDNO",loFormSet.HeaderAlias)) + CTKTNO +;
        IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_RECSESSIONNO,loFormSet.GetHeaderText("LANG_APPYINV_RECSESSIONNO",loFormSet.HeaderAlias)) + CRSESSION +;
IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_LINENO,loFormSet.GetHeaderText("LANG_APPYINV_LINENO",loFormSet.HeaderAlias))+ ALLTRIM(CLINENO)

   ENDCASE

    *-- Message : 04188
    *-- "The debit amount applied to (lcMssgText) will produce a negative "
    *-- "actual cost. Cannot proceed with the saving process.             "
    *-- Button : 00000
    *-- "                          <    Ok    >                           "
    =GFMODALGEN("TRM04188B00000" , "DIALOG" , LCMSSGTEXT)
  ENDIF    && End of IF FOUND()
ENDIF    && End of IF llReturn

*-- If troubles where found in the records locking or some of the records
*-- in the temp. actual cost header file or detail file where found.
IF !LLRETURN

  *Fix bug when Saving the debit memo againest Return PO [BEGIN]
  SELECT (LOFORMSET.LCAPINVTKT)
  REPLACE ALL NAPAPLAMNT WITH NAPAPLAMNT * -1,;
    NAPAPLPRIC WITH NAPAPLPRIC * -1 FOR (CIMTYP $ 'RF' AND (NAPAPLAMNT > 0 ))

  SELECT (LOFORMSET.LCAPVINVDT)
  REPLACE ALL NAPAPRAMNT WITH NAPAPRAMNT * -1,;
    NAPAPRPRIC WITH NAPAPRPRIC * -1,;
    NAPPRICE   WITH NAPPRICE   * -1,;
    NAPAMNT    WITH NAPAMNT    * -1 FOR (CIMTYP $ 'RF' AND (NAPAPRAMNT > 0 ))
  *Fix bug when Saving the debit memo againest Return PO [END]

  *-- Delete the records that have status same or deleted from the temp.
  *-- files (loFormSet.lcApVInvDt) and (lcAPInvTkt)
  SELECT (LOFORMSET.LCAPVINVDT)
  DELETE ALL FOR INLIST(CSTATUS,'D','S')
  SELECT (LOFORMSET.LCAPINVTKT)
  DELETE ALL FOR INLIST(CSTATUS,'D','S')

  *-- Unlock the records that had been locked
  =LFUNLCKPOF(LOFORMSET)
ENDIF    && End of IF !llReturn

RETURN LLRETURN
*-- End of lfChckACst


*!*************************************************************
*! Name      : lfInvAdjust
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 8/16/2004
*! Purpose   : To Add invoice adjustment
*!*************************************************************
*! Parameters: The FormSet
*!*************************************************************
*! Returns   : None
*!*************************************************************
FUNCTION LFINVADJUST
LPARAMETERS LOFORMSET

PRIVATE LNALIAS,LLADJUST,LNTOLDAPR,LCINVADJNO,LCCASHACT,LNADJAMNT,LNACCAMNT,;
  LCAPDGLACT,LLADJUSTMENT

LNALIAS = SELECT()
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*=gfOpenFile(oAriaApplication.DataDir+'ApPaymnt','Typmethdoc','SH')
=GFOPENTABLE('ApPaymnt','Typmethdoc','SH')
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[END]
=CURSORSETPROP("Buffering",5,'ApPaymnt')
LCEXSTATUS = SET('EXACT')
SET EXACT OFF

LLADJUST  = .F.
LNTOLDAPR =0
IF LOFORMSET.ACTIVEMODE="E"
  *N000682,1 MMT 11/22/2012 Globalization changes[Start]
  *WAIT 'Checking for Previous adjustments' WINDOW NOWAIT
  *N000682,1 11/20/2012 MMT Globlization changes[Start]
*WAIT LANG_APPYINV_CHECKPREVADJ WINDOW NOWAIT
WAIT IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_CHECKPREVADJ,loFormSet.GetHeaderText("LANG_APPYINV_CHECKPREVADJ",loFormSet.HeaderAlias)) WINDOW NOWAIT
*N000682,1 11/20/2012 MMT Globlization changes[End]

  *N000682,1 MMT 11/22/2012 Globalization changes[END]
  SELECT APVINVDT
  SET ORDER TO TAG ORGVINV
  =SEEK(PADR(LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE,8)+PADR(LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE,12))
  SUM REST IIF(CIMTYP $ 'RF',-NAPAPRAMNT,NAPAPRAMNT) TO LNTOLDAPR ;
    WHILE CVENDCODE+CAPINVNO+CAPVILNO = PADR(LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE,8)+PADR(LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE,12)
  SELECT (LOFORMSET.LCAPVINVDT)
  SCAN
    IF NRECNO > 0  AND BETWEEN(NRECNO,1,RECCOUNT('ApVInvDt'))
      LNRECNO = NRECNO
      GOTO LNRECNO IN 'ApVInvDt'

      *Invoice amount not equal to the old amount (Invoice amount changed). [Begin]
      IF NAPAPRAMNT <> APVINVDT.NAPAPRAMNT OR NAPPRICE <> APVINVDT.NAPPRICE
        *Invoice amount not equal to the old amount (Invoice amount changed). [End]

        LLADJUST = .T.
        EXIT
      ENDIF
    ENDIF
  ENDSCAN
  IF LLADJUST OR (LNTOLDAPR<>0 AND LOFORMSET.LNTAPRAMT <> LNTOLDAPR)
    =LFVADJUST(LOFORMSET)
  ENDIF
  WAIT CLEAR
ENDIF
IF LOFORMSET.LNTAPRAMT=LNTOLDAPR AND !LLADJUST
  SET EXACT &LCEXSTATUS
  SELECT (LNALIAS)
  RETURN
ENDIF
WAIT 'Saving adjustment' WINDOW NOWAIT
LCINVADJNO = LFGETADJNO(LOFORMSET)
DO CASE
CASE !EMPTY(STRTRAN(STRTRAN(APINVHDR.CCHKGLACC,'-'),'0'))
  LCCASHACT = APINVHDR.CCHKGLACC
CASE !EMPTY(APVENDOR.CCASHACCT)
  LCCASHACT = APVENDOR.CCASHACCT
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *  CASE !EMPTY(loFormSet.AriaForm1.cboDivision.Value) .AND. !EMPTY(APDIV.CCASHACCT)
CASE !EMPTY(LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.CBODIVISION.VALUE) .AND. !EMPTY(APDIV.CCASHACCT)
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  LCCASHACT = APDIV.CCASHACCT
OTHERWISE
  LCCASHACT = APSETUP.CCASHACCT
ENDCASE
SELECT (LOFORMSET.LCAPVINVDT)
SET ORDER TO TAG ADJUST
LNADJAMNT = 0
GO TOP
LLADJUSTMENT = .F.
DO WHILE !EOF()
  LCAPDGLACT = CAPDGLACT

  *Do not care with adjustments in deleted records, only sum with new added,modified or selected records
  SUM REST (ROUND(NAPAMNT,2)-ROUND(NAPAPRAMNT,2))*IIF(CIMTYP $ 'RF',-1,1) ;
    TO   LNACCAMNT WHILE CAPDGLACT = LCAPDGLACT ;
    FOR CSTATUS $ 'AMS'
  IF LNACCAMNT <> 0
    SELECT (LOFORMSET.LCTMPDIST)
    APPEND BLANK
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *!*	    REPLACE CVENDCODE WITH loFormSet.AriaForm1.KBVendCode.KeyTextBox.Value  ,;
    *!*	            CINVNO    WITH loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value  ,;
    *!*	            DAPDTRDAT WITH loFormSet.AriaForm1.DtPostDate.Value ,;
    *!*	            LAPDPOST  WITH .F.        ,;
    *!*	            CAPDGLACT WITH lcApDGlAct ,;
    *!*	            CAPDACTID WITH 'J'        ,;
    *!*	            CAPDREF   WITH lcInvAdjNo ,;
    *!*	            CSTATUS   WITH 'A'        ,;
    *!*	            CFISFYEAR WITH loFormSet.lcDistYer  ,;
    *!*	            CFSPPRDID WITH loFormSet.lcDistPrd  ,;
    *!*	            CAPSESSNO WITH loFormSet.lcSequence ,;
    *!*	            CAPDTRTYP WITH 'H'        ,;
    *!*	            CCURRCODE WITH loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value ,;
    *!*	            NEXRATE   WITH loFormSet.AriaForm1.txtNexRate.Value ,;
    *!*	            NCURRUNIT WITH apinvhdr.ncurrunit ,;
    *!*	            NAPDAMNT  WITH -lnAccAmnt
    *!*	    lcTemp = '-lnAccAmnt'+loFormSet.lcExSin1+'loFormSet.AriaForm1.txtNexRate.Value'+;
    *!*	             loFormSet.lcExSin2+'apinvhdr.ncurrunit'
    REPLACE CVENDCODE WITH LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE  ,;
      CINVNO    WITH LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE  ,;
      DAPDTRDAT WITH LOFORMSET.ARIAFORM1.DTPOSTDATE.VALUE ,;
      LAPDPOST  WITH .F.        ,;
      CAPDGLACT WITH LCAPDGLACT ,;
      CAPDACTID WITH 'J'        ,;
      CAPDREF   WITH LCINVADJNO ,;
      CSTATUS   WITH 'A'        ,;
      CFISFYEAR WITH LOFORMSET.LCDISTYER  ,;
      CFSPPRDID WITH LOFORMSET.LCDISTPRD  ,;
      CAPSESSNO WITH LOFORMSET.LCSEQUENCE ,;
      CAPDTRTYP WITH 'H'        ,;
      CCURRCODE WITH LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.KEYTEXTBOX.VALUE ,;
      NEXRATE   WITH LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTNEXRATE.VALUE ,;
      NCURRUNIT WITH APINVHDR.NCURRUNIT ,;
      NAPDAMNT  WITH -LNACCAMNT
    LCTEMP = '-lnAccAmnt'+LOFORMSET.LCEXSIN1+'loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.Value'+;
      LOFORMSET.LCEXSIN2+'apinvhdr.ncurrunit'

    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][Start]
    TRY
      *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][End]
      REPLACE NEQVAMNT  WITH &LCTEMP
      *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][Start]
    CATCH
      REPLACE NEQVAMNT  WITH 0
    ENDTRY
    *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][End]
    =GFADD_INFO(LOFORMSET.LCTMPDIST)
    LLADJUSTMENT = .T.
  ENDIF
  LNADJAMNT = LNADJAMNT + LNACCAMNT
  SELECT (LOFORMSET.LCAPVINVDT)
ENDDO
IF LLADJUSTMENT
  SELECT (LOFORMSET.LCTMPDIST)
  APPEND BLANK
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	  REPLACE CVENDCODE WITH loFormSet.AriaForm1.KBVendCode.KeyTextBox.Value  ,;
  *!*	          CINVNO    WITH loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value  ,;
  *!*	          DAPDTRDAT WITH loFormSet.AriaForm1.DtPostDate.Value ,;
  *!*	          LAPDPOST  WITH .F.        ,;
  *!*	          CAPDGLACT WITH loFormSet.DistLines.glAPActCode.KeyTextBox.Value ,;
  *!*	          CAPDACTID WITH 'A'        ,;
  *!*	          CAPDREF   WITH lcInvAdjNo ,;
  *!*	          CFISFYEAR WITH loFormSet.lcDistYer  ,;
  *!*	          CFSPPRDID WITH loFormSet.lcDistPrd  ,;
  *!*	          CSTATUS   WITH 'A'        ,;
  *!*	          CAPSESSNO WITH loFormSet.lcSequence ,;
  *!*	          CAPDTRTYP WITH 'H'        ,;
  *!*	          CCURRCODE WITH loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value ,;
  *!*	          NEXRATE   WITH loFormSet.AriaForm1.txtNexRate.Value ,;
  *!*	          NCURRUNIT WITH apinvhdr.ncurrunit ,;
  *!*	          NAPDAMNT  WITH lnAdjAmnt
  *!*	  lcTemp = 'lnAdjAmnt'+loFormSet.lcExSin1+'loFormSet.AriaForm1.txtNexRate.Value'+;
  *!*	           loFormSet.lcExSin2+'apinvhdr.ncurrunit'

  REPLACE CVENDCODE WITH LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE  ,;
    CINVNO    WITH LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE  ,;
    DAPDTRDAT WITH LOFORMSET.ARIAFORM1.DTPOSTDATE.VALUE ,;
    LAPDPOST  WITH .F.        ,;
    CAPDGLACT WITH LOFORMSET.ARIAFORM1.PGFPAYINV.PGDIST.GLAPACTCODE.KEYTEXTBOX.VALUE ,;
    CAPDACTID WITH 'A'        ,;
    CAPDREF   WITH LCINVADJNO ,;
    CFISFYEAR WITH LOFORMSET.LCDISTYER  ,;
    CFSPPRDID WITH LOFORMSET.LCDISTPRD  ,;
    CSTATUS   WITH 'A'        ,;
    CAPSESSNO WITH LOFORMSET.LCSEQUENCE ,;
    CAPDTRTYP WITH 'H'        ,;
    CCURRCODE WITH LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.KEYTEXTBOX.VALUE ,;
    NEXRATE   WITH LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTNEXRATE.VALUE ,;
    NCURRUNIT WITH APINVHDR.NCURRUNIT ,;
    NAPDAMNT  WITH LNADJAMNT

  LCTEMP = 'lnAdjAmnt'+LOFORMSET.LCEXSIN1+'loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.Value'+;
    LOFORMSET.LCEXSIN2+'apinvhdr.ncurrunit'
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][Start]
  TRY
    *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][End]
    REPLACE NEQVAMNT  WITH &LCTEMP
    *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][Start]
  CATCH
    REPLACE NEQVAMNT  WITH 0
  ENDTRY
  *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][End]
  =GFADD_INFO(LOFORMSET.LCTMPDIST)
  APPEND BLANK
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	  REPLACE CVENDCODE WITH loFormSet.AriaForm1.KBVendCode.KeyTextBox.Value  ,;
  *!*	          CINVNO    WITH loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value  ,;
  *!*	          DAPDTRDAT WITH loFormSet.AriaForm1.DtPostDate.Value ,;
  *!*	          LAPDPOST  WITH .F.        ,;
  *!*	          CAPDGLACT WITH lcCashAct  ,;
  *!*	          CAPDACTID WITH 'C'        ,;
  *!*	          CSTATUS   WITH 'A'        ,;
  *!*	          CAPDREF   WITH lcInvAdjNo ,;
  *!*	          CFISFYEAR WITH loFormSet.lcDistYer  ,;
  *!*	          CFSPPRDID WITH loFormSet.lcDistPrd  ,;
  *!*	          CAPSESSNO WITH loFormSet.lcSequence ,;
  *!*	          CAPDTRTYP WITH 'H'        ,;
  *!*	          CCURRCODE WITH loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value ,;
  *!*	          NEXRATE   WITH loFormSet.AriaForm1.txtNexRate.Value ,;
  *!*	          NCURRUNIT WITH apinvhdr.ncurrunit ,;
  *!*	          NAPDAMNT  WITH 0          ,;
  *!*	          NEQVAMNT  WITH 0
  REPLACE CVENDCODE WITH LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE  ,;
    CINVNO    WITH LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE  ,;
    DAPDTRDAT WITH LOFORMSET.ARIAFORM1.DTPOSTDATE.VALUE ,;
    LAPDPOST  WITH .F.        ,;
    CAPDGLACT WITH LCCASHACT  ,;
    CAPDACTID WITH 'C'        ,;
    CSTATUS   WITH 'A'        ,;
    CAPDREF   WITH LCINVADJNO ,;
    CFISFYEAR WITH LOFORMSET.LCDISTYER  ,;
    CFSPPRDID WITH LOFORMSET.LCDISTPRD  ,;
    CAPSESSNO WITH LOFORMSET.LCSEQUENCE ,;
    CAPDTRTYP WITH 'H'        ,;
    CCURRCODE WITH LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.KEYTEXTBOX.VALUE ,;
    NEXRATE   WITH LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTNEXRATE.VALUE ,;
    NCURRUNIT WITH APINVHDR.NCURRUNIT ,;
    NAPDAMNT  WITH 0          ,;
    NEQVAMNT  WITH 0
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  =GFADD_INFO(LOFORMSET.LCTMPDIST)

  *! B130111,1 ASM 11/01/2005 Allow the User to Edit an Invoice whose posted date is locked, but make entries on system date [Start]
  IF LOFORMSET.LLLOKPER
    LFCHECKTMPDIST(LOFORMSET)
  ENDIF
  *! B130111,1 ASM 11/01/2005 Allow the User to Edit an Invoice whose posted date is locked, but make entries on system date [End]
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *=gfTmp2Mast('APDIST',loFormSet.lcTmpDist)
  *!*	  INSERT INTO ('ApPaymnt') ;
  *!*	         (cPayType,cPAyMeth,cPayDocNo,cPayStat,dpayDate,cFisFYear,cFspprdid,;
  *!*	          cPayClNo,cPayComp,npayadj,cpayrecst,ccurrcode,ncurrunit,nexrate) VALUES ;
  *!*	         ('P','H',lcInvAdjNo,'',loFormSet.AriaForm1.DtPostDate.Value,loFormSet.lcDistYer,loFormSet.lcDistPrd,;
  *!*	          loFormSet.AriaForm1.KBVendCode.KeyTextBox.Value,ApVendor.cVenComp,lnAdjAmnt,'O',loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value,apinvhdr.ncurrunit,loFormSet.AriaForm1.txtNexRate.Value)
  LFTMP2MAST('APDIST',LOFORMSET.LCTMPDIST)
  =GFSEEK(PADR(LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE,8),'ApVendor')

  INSERT INTO ('ApPaymnt') ;
    (CPAYTYPE,CPAYMETH,CPAYDOCNO,CPAYSTAT,DPAYDATE,CFISFYEAR,CFSPPRDID,;
    CPAYCLNO,CPAYCOMP,NPAYADJ,CPAYRECST,CCURRCODE,NCURRUNIT,NEXRATE) VALUES ;
    ('P','H',LCINVADJNO,'',LOFORMSET.ARIAFORM1.DTPOSTDATE.VALUE,LOFORMSET.LCDISTYER,LOFORMSET.LCDISTPRD,;
    LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE,APVENDOR.CVENCOMP,LNADJAMNT,'O',LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.KEYTEXTBOX.VALUE,APINVHDR.NCURRUNIT,LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTNEXRATE.VALUE)
  =GFADD_INFO('ApPaymnt')
  SELECT APPAYMNT
  =GFREPLACE('')
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]




  SELECT APINVHDR
  =RLOCK()
  REPLACE NINVADJ WITH NINVADJ + LNADJAMNT
  UNLOCK
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  =GFREPLACE('')
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

  SELECT APVENDOR
  =RLOCK()
  REPLACE NVENBAL WITH NVENBAL - LNADJAMNT
  UNLOCK
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  =GFREPLACE('')
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

  SELECT APVENHST
  =SEEK(PADR(LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE,8)+LOFORMSET.LCDISTYER)
  =RLOCK()
  REPLACE NVNHADJ WITH NVNHADJ + LNADJAMNT
  UNLOCK
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  =GFREPLACE('')
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[ENd]
ENDIF
WAIT CLEAR
SET EXACT &LCEXSTATUS
SELECT (LNALIAS)

RETURN
*-- End of lfInvAdjust


*!*************************************************************
*! Name      : lfUpdFiles
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 8/16/2004
*! Purpose   : To Update Master Files
*!*************************************************************
*! Parameters: The FormSet
*!*************************************************************
*! Returns   : None
*!*************************************************************
FUNCTION LFUPDFILES
LPARAMETERS LOFORMSET

PRIVATE LCEXSTATUS

*Add this line to update the actual cost fields in the Style PO,
*Material PO and Cut Ticket header and detail files using the
*temp. files that was created by the function lfChckACst (), to
*calculate the actual cost and check for negative actual cost
*before saving [Begin]
=LFUPDATPOF(LOFORMSET)
*Add this line to update the actual cost fields [End]

LCEXSTATUS = SET('EXACT')
SET EXACT OFF
=LFOPENFILE('BOMCOST','BOMCOST',LOFORMSET) &&Sql Check Tag ;
*CINVTYPE+ITEM+CWARECODE+CDYELOT+CRSESSION+CISESSION ;
(ITEM+ICLR+CWARECODE+CDYELOT+CRSESSION+CISESSION)

=LFOPENFILE('CTKTBOM','CTKTBOM',LOFORMSET) &&Sql Check Tag ;
*CIMTYP+CUTTKT+TYP+CINVTYPE+ITEM+MFGCODE+DYELOT ;
(CIMTYP+CUTTKT+TYP+ITEM+ICLR+MFGCODE+DYELOT)

*Old: SET ORDER TO TAG Bomcstkt IN BOMCOST
LOFORMSET.BOMCOST.SETORDER('Bomcstkt') &&Sql33: Check Tag ;
*CBOMTYPE+CIMTYP+CTKTNO+CINVTYPE+ITEM+MFGCODE+CWARECODE+CDYELOT+CRSESSION+CISESSION ;
(CBOMTYPE+CIMTYP+CTKTNO+ITEM+ICLR+MFGCODE+CWARECODE+CDYELOT+CRSESSION+CISESSION)
*Old: SET ORDER TO TAG CTKTBOM IN CTKTBOM
LOFORMSET.CTKTBOM.SETORDER('CTKTBOM') &&Sql34: Check Tag ;
*CIMTYP+CUTTKT+TYP+CINVTYPE+ITEM+MFGCODE+DYELOT ;
(CIMTYP+CUTTKT+TYP+ITEM+ICLR+MFGCODE+DYELOT)

IF ('I' $ LOFORMSET.LCVENINVTYPES OR 'R' $ LOFORMSET.LCVENINVTYPES ) AND USED("POSHDR")
  *Old: SET ORDER TO TAG POSHDR IN POSHDR
  LOFORMSET.POSHDR.SETORDER('POSHDR') &&Sql35: Check Tag CBUSDOCU+CSTYTYPE+PO (CSTYTYPE+PO)
  *Old: SET ORDER TO TAG POSREC IN POSLN
  LOFORMSET.POSLN.SETORDER('POSREC') &&Sql36: Check Tag ;
  *CBUSDOCU+CSTYTYPE+PO+CRSESSION+SHIPNO+CINVTYPE+STYLE+STR(LINENO,6)+TRANCD+CSTYGRADE ;
  (CSTYTYPE+PO+CRSESSION+SHIPNO+STYLE+STR(LINENO,6)+TRANCD)
ENDIF
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*IF 'MF' $ oAriaApplication.CompanyInstalledModules AND loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value = oAriaApplication.BaseCurrency AND 'M' $ loFormSet.lcVenInvTypes
IF 'MF' $ OARIAAPPLICATION.COMPANYINSTALLEDMODULES AND LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.KEYTEXTBOX.VALUE = OARIAAPPLICATION.BASECURRENCY AND 'M' $ LOFORMSET.LCVENINVTYPES
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  *Old: SET ORDER TO TAG CUTTKTH IN CUTTKTH
  LOFORMSET.CUTTKTH.SETORDER('POSHDR') &&Sql37: Check Tag CBUSDOCU+CSTYTYPE+PO (CUTTKT)
  *Old: SET ORDER TO TAG CUTREC  IN CUTTKTL
  LOFORMSET.CUTTKTL.SETORDER('POSREC') &&Sql38: Check Tag ;
  *CBUSDOCU+CSTYTYPE+PO+CRSESSION+SHIPNO+CINVTYPE+STYLE+STR(LINENO,6)+TRANCD+CSTYGRADE ;
  (CRSESSION+CUTTKT+STYLE+TRANCD)
ENDIF
IF ('L' $ LOFORMSET.LCVENINVTYPES OR 'F' $ LOFORMSET.LCVENINVTYPES) AND USED("POFHDR")
  =LFOPENFILE('MATINVJL','MATINVJL',LOFORMSET)
  *Old: SET ORDER TO TAG POFHDR IN POFHDR
  LOFORMSET.POFHDR.SETORDER('POSHDR') &&Sql39: Check Tag CBUSDOCU+CSTYTYPE+PO (CMATTYPE+POMAT)
  *Old: SET ORDER TO TAG POFREC IN POFLN
  LOFORMSET.POFLN.SETORDER('POSREC') &&Sql40: Check Tag ;
  *CBUSDOCU+CSTYTYPE+PO+CRSESSION+SHIPNO+CINVTYPE+STYLE+STR(LINENO,6)+TRANCD+CSTYGRADE ;
  (CMATTYPE+POMAT+CRSESSION+FABRIC+COLOR+TRANCD)
ENDIF
*Fix the contribution process [Begin]
*Old": SELECT BOMLINE
*Old: SET ORDER TO TAG BOMPOREC IN BOMLINE
LOFORMSET.BOMLINE.SETORDER('BOMPOREC') &&Sql41: Check Tag ;
*CIMTYP+CTYPE+CBOMTYP+MFGCODE+CTKTNO+CRSESSION+SHIPNO+STR(LINENO,6)+CINVTYPE+STYLE+CSTYGRADE ;
(CIMTYP+CTYPE+CBOMTYP+MFGCODE+CTKTNO+CRSESSION+SHIPNO+STR(LINENO,6)+STYLE+SCLR+CSTYGRADE)
*Fix the contribution process [End]
SELECT (LOFORMSET.LCAPINVTKT)
RECALL ALL
SELECT (LOFORMSET.LCAPVINVDT)
RECALL ALL

*Fix bug when Saving the debit memo againest Return PO [BEGIN]
SELECT (LOFORMSET.LCAPINVTKT)
REPLACE ALL NAPAPLAMNT WITH NAPAPLAMNT * -1,;
  NAPAPLPRIC WITH NAPAPLPRIC * -1 FOR (CIMTYP $ 'RF' AND (NAPAPLAMNT < 0 ))

SELECT (LOFORMSET.LCAPVINVDT)
REPLACE ALL NAPAPRAMNT WITH NAPAPRAMNT * -1,;
  NAPAPRPRIC WITH NAPAPRPRIC * -1,;
  NAPPRICE   WITH NAPPRICE   * -1,;
  NAPAMNT    WITH NAPAMNT    * -1 FOR (CIMTYP $ 'RF' AND (NAPAPRAMNT < 0 ))
*Fix bug when Saving the debit memo againest Return PO [END]


SCAN FOR CSTATUS <> 'S' AND SEEK(CVENDCODE+CAPINVNO+CAPVILNO,LOFORMSET.LCAPINVTKT)

  *Spliting the files updates in case of Shipmnet [Begin] .
  IF EVALUATE(LOFORMSET.LCAPVINVDT+'.cIMTyp')= 'S'
    =LFUPDSHIP(LOFORMSET)
    SELECT (LOFORMSET.LCAPVINVDT)
    LOOP
  ENDIF
  *Spliting the files updates in case of Shipmnet [End].

  *We need to update the CTKTBOM and BOMCOST file even if there is no contibution [start]
  * IF EMPTY(&lcAPInvTkt..cRSession) AND &loFormSet.lcApVInvDt..cIMTyp = 'S'
  *    LOOP
  *  ENDIF
  *We need to update the CTKTBOM and BOMCOST file even if there is no contibution [End]



  LLDELETED = (CSTATUS='D') OR (CSTATUS='S' AND EMPTY(NRECNO))
  LNRECNO   = NRECNO

  IF BETWEEN(LNRECNO ,1,RECCOUNT('APVINVDT'))
    SELECT APVINVDT
    GO LNRECNO
  ENDIF

  IF !INLIST(EVALUATE(LOFORMSET.LCAPVINVDT+'.cIMTyp'),'L','F','R')

    *CIMTYP+CUTTKT+TYP+CINVTYPE+ITEM+MFGCODE+DYELOT
    IF LOFORMSET.CTKTBOM.SEEK(IIF(EVALUATE(LOFORMSET.LCAPVINVDT+'.cIMTyp')="S","I",;
        EVALUATE(LOFORMSET.LCAPVINVDT+'.cIMTyp'))+EVALUATE(LOFORMSET.LCAPVINVDT+'.ctktno')+;
        EVALUATE(LOFORMSET.LCAPVINVDT+'.cbomtype')+SPACE(4)+SPACE(19)+;
        EVALUATE(LOFORMSET.LCAPVINVDT+'.cOprCode')+SPACE(10)) &&Sql53: Check Key
      LOFORMSET.CTKTBOM.REPLACE()
      SELECT (LOFORMSET.CTKTBOM.LCCURSORUPDATE)
      REPLACE ISSUE_QTY WITH ISSUE_QTY - IIF(LNRECNO=0,0,APVINVDT.NAPTAPRQTY) + IIF(LLDELETED,0,EVALUATE(LOFORMSET.LCAPVINVDT+'.nApTAprQty')),;
        USED_QTY  WITH USED_QTY  - IIF(LNRECNO=0,0,APVINVDT.NAPTAPRQTY) + IIF(LLDELETED,0,EVALUATE(LOFORMSET.LCAPVINVDT+'.nApTAprQty'))
      SELECT CTKTBOM
    ENDIF

    *Add these lines to update this record of BOMCOST file
    *with the uncontributed amount only, and not with the
    *approved amount [Begin]

    *-- If the Invoice line was deleted or if the uncontributed amount was
    *-- changed.
    IF LLDELETED .OR.;
        (EMPTY(EVALUATE(LOFORMSET.LCAPINVTKT+'.cRSession')) .AND. EVALUATE(LOFORMSET.LCAPINVTKT+'.cStatus') <> 'S')



      IF BETWEEN(EVALUATE(LOFORMSET.LCAPINVTKT+'.nRecNo') ,1,RECCOUNT('APINVTKT'))
        GO EVALUATE(LOFORMSET.LCAPINVTKT+'.nRecNo') IN APINVTKT
      ENDIF
      *Add these lines to update this record of BOMCOST [End]

      *Update BOMCOST file
      SELECT BOMCOST

      LCKEY = EVALUATE(LOFORMSET.LCAPVINVDT+'.cbomtype')+;
        IIF(EVALUATE(LOFORMSET.LCAPVINVDT+'.cIMTyp')="S","I",EVALUATE(LOFORMSET.LCAPVINVDT+'.cIMTyp'))+;
        EVALUATE(LOFORMSET.LCAPVINVDT+'.ctktno')+SPACE(4)+SPACE(19)+;
        EVALUATE(LOFORMSET.LCAPVINVDT+'.cOprCode')+SPACE(6)+SPACE(10)+SPACE(6)+SPACE(6)

      *CBOMTYPE+CIMTYP+CTKTNO+CINVTYPE+ITEM+MFGCODE+CWARECODE+CDYELOT+CRSESSION+CISESSION
      =LOFORMSET.BOMCOST.SEEK(EVALUATE(LOFORMSET.LCAPVINVDT+'.cbomtype')+;
        IIF(EVALUATE(LOFORMSET.LCAPVINVDT+'.cIMTyp')="S","I",EVALUATE(LOFORMSET.LCAPVINVDT+'.cIMTyp'))+;
        EVALUATE(LOFORMSET.LCAPVINVDT+'.ctktno')+SPACE(4)+SPACE(19)+;
        EVALUATE(LOFORMSET.LCAPVINVDT+'.cOprCode')+SPACE(6)+SPACE(10)+SPACE(6)+SPACE(6)) &&Sql54: Check Key
      LOCATE ALL FOR CVENDCODE+CAPINVNO = PADR(LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE,8)+PADR(LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE,12) &&Sql55: ICLR Field not found

      DO CASE

        *Change this condition to update this record of BOMCOST
        *file with the uncontributed amount only, and not with
        *the approved amount [Begin]
      CASE !LLDELETED AND !FOUND() .AND. EVALUATE(LOFORMSET.LCAPINVTKT+'.cStatus') <> 'D'
        *Change this condition to update this record of BOMCOST [End]

        IF !SEEK(IIF(EVALUATE(LOFORMSET.LCAPVINVDT+'.cIMTyp')="S","I",EVALUATE(LOFORMSET.LCAPVINVDT+'.cIMTyp'))+;
            IIF(EVALUATE(LOFORMSET.LCAPVINVDT+'.cIMTyp')="S",EVALUATE(LOFORMSET.LCAPINVTKT+'.ctktno'),EVALUATE(LOFORMSET.LCAPVINVDT+'.ctktno'))+;
            'N'+EVALUATE(LOFORMSET.LCAPVINVDT+'.cbomtype')+SPACE(4)+SPACE(19)+EVALUATE(LOFORMSET.LCAPVINVDT+'.cOprCode')+;
            SPACE(LEN(COPRCODE))+SPACE(LEN(CLOTNO))+SPACE(LEN(CISESSION))+SPACE(LEN(CRSESSION))+;
            PADR(LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE,8)+PADR(LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE,12),;
            LOFORMSET.BOMCOST.LCCURSORUPDATE)

          LOFORMSET.BOMCOST.APPEND('REPLACE CBOMTYPE WITH ""')

        ENDIF

        SELECT (LOFORMSET.BOMCOST.LCCURSORUPDATE)
        *B608489,1 WAM 03/23/2008 Fix updating total quantity in bomcost
        *REPLACE CBOMTYPE  WITH EVALUATE(loFormSet.lcApVInvDt+'.cbomtype') ,;
        CIMTYP    WITH IIF(EVALUATE(loFormSet.lcApVInvDt+'.cIMTyp')="S","I",;
        EVALUATE(loFormSet.lcApVInvDt+'.cIMTyp')),;
        CTKTNO    WITH IIF(EVALUATE(loFormSet.lcApVInvDt+'.cIMTyp')="S",;
        EVALUATE(loFormSet.lcAPInvTkt+'.ctktno'),EVALUATE(loFormSet.lcApVInvDt+'.ctktno')),;
        CINVTYPE  WITH ''                    ,;
        ITEM      WITH ''                    ,;
        MFGCODE   WITH EVALUATE(loFormSet.lcApVInvDt+'.cOprCode') ,;
        CWARECODE WITH ''                    ,;
        CDYELOT   WITH ''                    ,;
        CRSESSION WITH SPACE(6)  ,;
        CVENDCODE WITH loFormSet.AriaForm1.KBVendCode.KeyTextBox.Value ,;
        CAPINVNO  WITH loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value ,;
        CISESSION WITH ''        ,;
        SHIPNO    WITH ''        ,;
        DTRANDATE WITH loFormSet.AriaForm1.DtPostDate.Value,;
        CCOSTTYPE WITH EVALUATE(loFormSet.lcApVInvDt+'.cCostType')  ,;
        NTOTQTY   WITH EVALUATE(loFormSet.lcAPInvTkt+'.nAPTAplQty') -;
        IIF(EVALUATE(loFormSet.lcAPInvTkt+'.nRecNo') = 0 , 0 ,;
        APINVTKT.nAPTAplQty) ,;
        NTOTCST   WITH EVALUATE(loFormSet.lcAPInvTkt+'.nAPAplAmnt') -;
        IIF(EVALUATE(loFormSet.lcAPInvTkt+'.nRecNo') = 0 , 0 ,;
        APINVTKT.nAPAplAmnt) ,;
        NUNITCST  WITH EVALUATE(loFormSet.lcAPInvTkt+'.nAPAplPric') -;
        IIF(EVALUATE(loFormSet.lcAPInvTkt+'.nRecNo') = 0 , 0 ,;
        APINVTKT.nAPAplPric) ,;
        NTOTACST  WITH NTOTCST  ,;
        NUNITACST WITH NUNITCST ,;
        Actualize WITH 'N' &&Sql56: ICLR Field not found
        REPLACE CBOMTYPE  WITH EVALUATE(LOFORMSET.LCAPVINVDT+'.cbomtype') ,;
          CIMTYP    WITH IIF(EVALUATE(LOFORMSET.LCAPVINVDT+'.cIMTyp')="S","I",;
          EVALUATE(LOFORMSET.LCAPVINVDT+'.cIMTyp')),;
          CTKTNO    WITH IIF(EVALUATE(LOFORMSET.LCAPVINVDT+'.cIMTyp')="S",;
          EVALUATE(LOFORMSET.LCAPINVTKT+'.ctktno'),EVALUATE(LOFORMSET.LCAPVINVDT+'.ctktno')),;
          CINVTYPE  WITH ''                    ,;
          ITEM      WITH ''                    ,;
          MFGCODE   WITH EVALUATE(LOFORMSET.LCAPVINVDT+'.cOprCode') ,;
          CWARECODE WITH ''                    ,;
          CDYELOT   WITH ''                    ,;
          CRSESSION WITH SPACE(6)  ,;
          CVENDCODE WITH LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE ,;
          CAPINVNO  WITH LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE ,;
          CISESSION WITH ''        ,;
          SHIPNO    WITH ''        ,;
          DTRANDATE WITH LOFORMSET.ARIAFORM1.DTPOSTDATE.VALUE,;
          CCOSTTYPE WITH EVALUATE(LOFORMSET.LCAPVINVDT+'.cCostType')  ,;
          NTOTQTY   WITH NTOTQTY+EVALUATE(LOFORMSET.LCAPINVTKT+'.nAPTAplQty') -;
          IIF(EVALUATE(LOFORMSET.LCAPINVTKT+'.nRecNo') = 0 , 0 ,;
          APINVTKT.NAPTAPLQTY) ,;
          NTOTCST   WITH NTOTCST+EVALUATE(LOFORMSET.LCAPINVTKT+'.nAPAplAmnt') -;
          IIF(EVALUATE(LOFORMSET.LCAPINVTKT+'.nRecNo') = 0 , 0 ,;
          APINVTKT.NAPAPLAMNT) ,;
          NUNITCST  WITH IIF(NTOTQTY=0,0,NTOTCST/NTOTQTY)  ,;
          NTOTACST  WITH NTOTCST  ,;
          NUNITACST WITH NUNITCST ,;
          ACTUALIZE WITH 'N' &&Sql56: ICLR Field not found
        *B608489,1 WAM 03/23/2008 (End)
        SELECT BOMCOST

      CASE !LLDELETED AND FOUND()

        *Update unit cost in bocost file [Begin]
        *Change this line to update this record of BOMCOST file
        *with the uncontributed amount only, and not with the
        *approved amount [Begin]
        LOFORMSET.BOMCOST.REPLACE()
        SELECT (LOFORMSET.BOMCOST.LCCURSORUPDATE)
        REPLACE NTOTQTY   WITH NTOTQTY +;
          IIF(EVALUATE(LOFORMSET.LCAPINVTKT+'.cStatus') = 'D' , 0 ,;
          EVALUATE(LOFORMSET.LCAPINVTKT+'.nAPTAplQty')) -;
          IIF(EVALUATE(LOFORMSET.LCAPINVTKT+'.nRecNo') = 0 , 0 ,;
          APINVTKT.NAPTAPLQTY) ,;
          NTOTCST   WITH NTOTCST +;
          IIF(EVALUATE(LOFORMSET.LCAPINVTKT+'.cStatus') = 'D' , 0 ,;
          EVALUATE(LOFORMSET.LCAPINVTKT+'.nAPAplAmnt')) -;
          IIF(EVALUATE(LOFORMSET.LCAPINVTKT+'.nRecNo') = 0 , 0 ,;
          APINVTKT.NAPAPLAMNT) ,;
          NUNITCST  WITH IIF(EVALUATE(LOFORMSET.LCAPINVTKT+'.cStatus') = 'D' , 0 ,;
          NTOTCST/NTOTQTY);
          NTOTACST  WITH NTOTCST  ,;
          NUNITACST WITH NUNITCST



        IF (EVALUATE(LOFORMSET.LCAPINVTKT+'.cStatus') = 'D') .OR. (NTOTQTY = 0)
          DELETE
        ENDIF
        SELECT BOMCOST

      CASE LLDELETED AND FOUND()
        *Change this line to update this record of BOMCOST
        *file with the uncontributed amount only, and not with
        *the approved amount
        *Note: Note that this line could hold the uncontributed
        *amount of more than one invoice line [Begin]
        LOFORMSET.BOMCOST.REPLACE()
        SELECT (LOFORMSET.BOMCOST.LCCURSORUPDATE)
        REPLACE NTOTQTY   WITH NTOTQTY -;
          IIF(EVALUATE(LOFORMSET.LCAPINVTKT+'.nRecNo') = 0 , 0 ,;
          APINVTKT.NAPTAPLQTY) ,;
          NTOTCST   WITH NTOTCST -;
          IIF(EVALUATE(LOFORMSET.LCAPINVTKT+'.nRecNo') = 0 , 0 ,;
          APINVTKT.NAPAPLAMNT) ,;
          NUNITCST  WITH NUNITCST -;
          IIF(EVALUATE(LOFORMSET.LCAPINVTKT+'.nRecNo') = 0 , 0 ,;
          APINVTKT.NAPAPLPRIC) ,;
          NTOTACST  WITH NTOTCST  ,;
          NUNITACST WITH NUNITCST

        IF (EVALUATE(LOFORMSET.LCAPINVTKT+'.cStatus') = 'D') .OR. (NTOTQTY = 0)
          DELETE
        ENDIF
        SELECT BOMCOST

      ENDCASE

      *Add this if condition to update this record of BOMCOST file
      *with the uncontributed amount only, and not with the
      *approved amount [Begin]
    ENDIF    && End of IF EMPTY(&loFormSet.lcAPInvTkt..cRSession) .AND. ...
    *Add this if condition to update this record of BOMCOST [End]

    *Update BOMLINE file
    SELECT (LOFORMSET.LCAPINVTKT)
    SCAN REST WHILE CVENDCODE+CAPINVNO+CAPVILNO = ;
        EVALUATE(LOFORMSET.LCAPVINVDT+'.cVendCode')+;
        EVALUATE(LOFORMSET.LCAPVINVDT+'.cApInvNo')+EVALUATE(LOFORMSET.LCAPVINVDT+'.cAPVILNo') ;
        FOR   !EMPTY(CRSESSION)
      LLDELETED = (CSTATUS='D') OR (CSTATUS='S' AND EMPTY(NRECNO))
      LNRECNO = NRECNO

      IF !LLDELETED AND BETWEEN(LNRECNO ,1,RECCOUNT('APINVTKT'))
        SELECT APINVTKT
        GO LNRECNO
      ENDIF
      SELECT BOMLINE
      *CIMTYP+CTYPE+CBOMTYP+MFGCODE+CTKTNO+CRSESSION+SHIPNO+STR(LINENO,6)+CINVTYPE+STYLE+CSTYGRADE
      =LOFORMSET.BOMLINE.SEEK(EVALUATE(LOFORMSET.LCAPVINVDT+'.cIMTyp')+"3"+EVALUATE(LOFORMSET.LCAPVINVDT+'.cBomType')+;
        EVALUATE(LOFORMSET.LCAPVINVDT+'.cOprCode')+EVALUATE(LOFORMSET.LCAPVINVDT+'.ctktno')+;
        EVALUATE(LOFORMSET.LCAPINVTKT+'.cRSession')+EVALUATE(LOFORMSET.LCAPVINVDT+'.shipno')+;
        STR(EVALUATE(LOFORMSET.LCAPINVTKT+'.LineNo'),6)+;
        IIF(EVALUATE(LOFORMSET.LCAPVINVDT+'.cIMTyp')='T','0002','0001')+;
        EVALUATE(LOFORMSET.LCAPINVTKT+'.Item')) &&Sql57: Check Key

      DO CASE
      CASE !LLDELETED AND !FOUND()
        *! B609219,1 MMT 04/22/2010 error while Update in Payable invoice screen if Same PO Line rec. to diff. loc. in Same session[Start]
        SELECT (LOFORMSET.BOMLINE.LCCURSORUPDATE)
        LNNEWLINENO = 0
        SCAN FOR ;
            CIMTYP+CTYPE+CTKTNO+SHIPNO+STR(LINENO,6)+CBOMTYP+CINVTYPE+STYLE+CINVTYPC+ITEM+MFGCODE+CRSESSION+CSTYGRADE+STR(NLINENO,4)=;
            IIF(EVALUATE(LOFORMSET.LCAPVINVDT+'.cIMTyp')="S","I",;
            EVALUATE(LOFORMSET.LCAPVINVDT+'.cIMTyp'))+'3'+IIF(EVALUATE(LOFORMSET.LCAPVINVDT+'.cIMTyp')="S",;
            EVALUATE(LOFORMSET.LCAPINVTKT+'.ctktno'),EVALUATE(LOFORMSET.LCAPVINVDT+'.ctktno'))+EVALUATE(LOFORMSET.LCAPVINVDT+'.shipno')+STR(EVALUATE(LOFORMSET.LCAPINVTKT+'.LineNo'),6)+;
            EVALUATE(LOFORMSET.LCAPVINVDT+'.cBomType')+IIF(EVALUATE(LOFORMSET.LCAPVINVDT+'.cIMTyp')='T','0002','0001') +PADR(IIF(EVALUATE(LOFORMSET.LCAPVINVDT+'.cIMTyp')='T',;
            LFUPDITEM(EVALUATE(LOFORMSET.LCAPINVTKT+'.Item'),EVALUATE(LOFORMSET.LCAPINVTKT+'.Color')),;
            EVALUATE(LOFORMSET.LCAPINVTKT+'.Item')),19)+;
            SPACE(4)+SPACE(19)+EVALUATE(LOFORMSET.LCAPVINVDT+'.cOprCode')+EVALUATE(LOFORMSET.LCAPINVTKT+'.cRSession')+SPACE(1)

          LNNEWLINENO = MAX(IIF(ISNULL(NLINENO),0,NLINENO),LNNEWLINENO)
        ENDSCAN
        LNNEWLINENO = LNNEWLINENO + 1
        *! B609219,1 MMT 04/22/2010 error while Update in Payable invoice screen if Same PO Line rec. to diff. loc. in Same session[End]

        LOFORMSET.BOMLINE.APPEND('REPLACE cimtyp WITH ""')

        SELECT (LOFORMSET.BOMLINE.LCCURSORUPDATE)
        REPLACE CIMTYP    WITH IIF(EVALUATE(LOFORMSET.LCAPVINVDT+'.cIMTyp')="S","I",;
          EVALUATE(LOFORMSET.LCAPVINVDT+'.cIMTyp')) ,;
          CTYPE     WITH '3'                   ,;
          CBOMTYP   WITH EVALUATE(LOFORMSET.LCAPVINVDT+'.cBomType') ,;
          MFGCODE   WITH EVALUATE(LOFORMSET.LCAPVINVDT+'.cOprCode') ,;
          CTKTNO    WITH IIF(EVALUATE(LOFORMSET.LCAPVINVDT+'.cIMTyp')="S",;
          EVALUATE(LOFORMSET.LCAPINVTKT+'.ctktno'),EVALUATE(LOFORMSET.LCAPVINVDT+'.ctktno')),;
          CRSESSION WITH EVALUATE(LOFORMSET.LCAPINVTKT+'.cRSession'),;
          SHIPNO    WITH EVALUATE(LOFORMSET.LCAPVINVDT+'.shipno')   ,;
          LINENO    WITH EVALUATE(LOFORMSET.LCAPINVTKT+'.LineNo')   ,;
          CINVTYPE  WITH IIF(EVALUATE(LOFORMSET.LCAPVINVDT+'.cIMTyp')='T','0002','0001')    ,;
          STYLE     WITH IIF(EVALUATE(LOFORMSET.LCAPVINVDT+'.cIMTyp')='T',;
          LFUPDITEM(EVALUATE(LOFORMSET.LCAPINVTKT+'.Item'),EVALUATE(LOFORMSET.LCAPINVTKT+'.Color')),;
          EVALUATE(LOFORMSET.LCAPINVTKT+'.Item'))     ,;
          CCATGTYP  WITH EVALUATE(LOFORMSET.LCAPVINVDT+'.cCostType'),;
          UNITQTY   WITH  1 ,;
          STYQTY    WITH EVALUATE(LOFORMSET.LCAPINVTKT+'.nApTAplQty') ,;
          ITEMQTY   WITH STYQTY ,;
          ITEMAMT   WITH EVALUATE(LOFORMSET.LCAPINVTKT+'.nApAplAmnt') ,;
          UNITCOST  WITH IIF(ITEMQTY=0,0,ITEMAMT/ITEMQTY) &&Sql58: SCLR Field not found

        *! B609219,1 MMT 04/22/2010 error while Update in Payable invoice screen if Same PO Line rec. to diff. loc. in Same session[Start]
        REPLACE NLINENO WITH LNNEWLINENO
        *! B609219,1 MMT 04/22/2010 error while Update in Payable invoice screen if Same PO Line rec. to diff. loc. in Same session[End]

        * B608833,1 HES 04/01/2009 Add Standared Fields for POMLINE File[T20081001.0001]
        =GFADD_INFO(LOFORMSET.BOMLINE.LCCURSORUPDATE)
        * B608833,1 HES 04/01/2009 Add Standared Fields for POMLINE File[T20081001.0001]

        SELECT BOMLINE

        *add style info to bomline [End]

      CASE !LLDELETED AND FOUND()
        *Fix bug when Saving the debit memo againest Return PO [BEGIN]
        LOFORMSET.BOMLINE.REPLACE()
        SELECT (LOFORMSET.BOMLINE.LCCURSORUPDATE)
        IF LOFORMSET.LLDEBITM AND !(EVALUATE(LOFORMSET.LCAPVINVDT+'.cIMTyp') $'RF')
          REPLACE STYQTY   WITH STYQTY - IIF(LNRECNO=0,0,APINVTKT.NAPTAPLQTY) - ;
            IIF(EVALUATE(LOFORMSET.LCAPINVTKT+'.nApTAplQty') >=STYQTY,0,EVALUATE(LOFORMSET.LCAPINVTKT+'.nApTAplQty')),;
            ITEMQTY  WITH STYQTY ,;
            ITEMAMT  WITH ITEMAMT -IIF(LNRECNO=0,0,APINVTKT.NAPAPLAMNT) + EVALUATE(LOFORMSET.LCAPINVTKT+'.nApAplAmnt') ,;
            UNITCOST WITH IIF(ITEMQTY=0,0,ITEMAMT/ITEMQTY)
        ELSE
          REPLACE STYQTY   WITH STYQTY - IIF(LNRECNO=0,0,APINVTKT.NAPTAPLQTY) + EVALUATE(LOFORMSET.LCAPINVTKT+'.nApTAplQty') ,;
            ITEMQTY  WITH STYQTY ,;
            ITEMAMT  WITH ITEMAMT -IIF(LNRECNO=0,0,APINVTKT.NAPAPLAMNT) + EVALUATE(LOFORMSET.LCAPINVTKT+'.nApAplAmnt') ,;
            UNITCOST WITH IIF(ITEMQTY=0,0,ITEMAMT/ITEMQTY)
        ENDIF
        * B608833,1 HES 04/01/2009 Add Standared Fields for POMLINE File[T20081001.0001]
        =GFADD_INFO(LOFORMSET.BOMLINE.LCCURSORUPDATE)
        * B608833,1 HES 04/01/2009 Add Standared Fields for POMLINE File[T20081001.0001]

        SELECT BOMLINE
        *Fix bug when Saving the debit memo againest Return PO [ENd]

      CASE LLDELETED AND FOUND()
        *Fix bug when Saving the debit memo againest Return PO [BEGIN]

        *Fix the contribution process [Begin]
        *DELETE
        LOFORMSET.BOMLINE.REPLACE()
        SELECT (LOFORMSET.BOMLINE.LCCURSORUPDATE)
        IF LOFORMSET.LLDEBITM AND !(EVALUATE(LOFORMSET.LCAPVINVDT+'.cIMTyp') $'RF')
          REPLACE STYQTY   WITH STYQTY +  IIF(EVALUATE(LOFORMSET.LCAPINVTKT+'.nApTAplQty') >=STYQTY,0,EVALUATE(LOFORMSET.LCAPINVTKT+'.nApTAplQty')) ,;
            ITEMQTY  WITH STYQTY ,;
            ITEMAMT  WITH ITEMAMT - EVALUATE(LOFORMSET.LCAPINVTKT+'.nApAplAmnt') ,;
            UNITCOST WITH IIF(ITEMQTY=0,0,ITEMAMT/ITEMQTY)
        ELSE
          REPLACE STYQTY   WITH STYQTY - EVALUATE(LOFORMSET.LCAPINVTKT+'.nApTAplQty') ,;
            ITEMQTY  WITH STYQTY ,;
            ITEMAMT  WITH ITEMAMT - EVALUATE(LOFORMSET.LCAPINVTKT+'.nApAplAmnt') ,;
            UNITCOST WITH IIF(ITEMQTY=0,0,ITEMAMT/ITEMQTY)
        ENDIF
        * B608833,1 HES 04/01/2009 Add Standared Fields for POMLINE File[T20081001.0001]
        =GFADD_INFO(LOFORMSET.BOMLINE.LCCURSORUPDATE)
        * B608833,1 HES 04/01/2009 Add Standared Fields for POMLINE File[T20081001.0001]

        *Fix bug when Saving the debit memo againest Return PO [ENd]
        IF ITEMQTY = 0
          DELETE
        ENDIF
        SELECT BOMLINE
        *Fix the contribution process [End]
      ENDCASE
      *Update BOMCOST file
      SELECT BOMCOST

      LCKEY = EVALUATE(LOFORMSET.LCAPVINVDT+'.cbomtype')+;
        IIF(EVALUATE(LOFORMSET.LCAPVINVDT+'.cIMTyp')="S","I"+;
        EVALUATE(LCAPINVTKT+'.ctktno'),EVALUATE(LOFORMSET.LCAPVINVDT+'.cIMTyp')+;
        EVALUATE(LOFORMSET.LCAPVINVDT+'.ctktno'))+SPACE(4)+SPACE(19)+;
        EVALUATE(LOFORMSET.LCAPVINVDT+'.cOprCode')+SPACE(6)+SPACE(10)+;
        EVALUATE(LOFORMSET.LCAPINVTKT+'.cRSession')+SPACE(6)

      *CBOMTYPE+CIMTYP+CTKTNO+CINVTYPE+ITEM+MFGCODE+CWARECODE+CDYELOT+CRSESSION+CISESSION
      =LOFORMSET.BOMCOST.SEEK(EVALUATE(LOFORMSET.LCAPVINVDT+'.cbomtype')+;
        IIF(EVALUATE(LOFORMSET.LCAPVINVDT+'.cIMTyp')="S","I"+EVALUATE(LCAPINVTKT+'.ctktno'),;
        EVALUATE(LOFORMSET.LCAPVINVDT+'.cIMTyp')+EVALUATE(LOFORMSET.LCAPVINVDT+'.ctktno'))+;
        SPACE(4)+SPACE(19)+;
        EVALUATE(LOFORMSET.LCAPVINVDT+'.cOprCode')+SPACE(6)+SPACE(10)+;
        EVALUATE(LOFORMSET.LCAPINVTKT+'.cRSession')+SPACE(6)) &&Sql59: Check Key

      LOCATE ALL FOR CVENDCODE+CAPINVNO = PADR(LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE,8)+PADR(LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE,12)

      DO CASE
      CASE !LLDELETED AND !FOUND()
        IF !SEEK(IIF(EVALUATE(LOFORMSET.LCAPVINVDT+'.cIMTyp')="S","I",EVALUATE(LOFORMSET.LCAPVINVDT+'.cIMTyp'))+;
            IIF(EVALUATE(LOFORMSET.LCAPVINVDT+'.cIMTyp')="S", EVALUATE(LOFORMSET.LCAPINVTKT+'.ctktno') ,EVALUATE(LOFORMSET.LCAPVINVDT+'.ctktno') )+;
            'Y'+EVALUATE(LOFORMSET.LCAPVINVDT+'.cbomtype')+SPACE(4)+SPACE(19)+EVALUATE(LOFORMSET.LCAPVINVDT+'.cOprCode')+;
            SPACE(LEN(COPRCODE))+SPACE(LEN(CLOTNO))+SPACE(LEN(CISESSION))+EVALUATE(LOFORMSET.LCAPINVTKT+'.cRSession')+;
            PADR(LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE,8)+PADR(LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE,12), ;
            LOFORMSET.BOMCOST.LCCURSORUPDATE)

          LOFORMSET.BOMCOST.APPEND('REPLACE CBOMTYPE  WITH ""')

        ENDIF

        SELECT (LOFORMSET.BOMCOST.LCCURSORUPDATE)
        *B608489,1 WAM 03/23/2008 Fix updating total quantity in bomcost
        *REPLACE CBOMTYPE  WITH EVALUATE(loFormSet.lcApVInvDt+'.cbomtype') ,;
        CIMTYP    WITH IIF(EVALUATE(loFormSet.lcApVInvDt+'.cIMTyp')="S","I",EVALUATE(loFormSet.lcApVInvDt+'.cIMTyp')) ,;
        CTKTNO    WITH IIF(EVALUATE(loFormSet.lcApVInvDt+'.cIMTyp')="S", EVALUATE(loFormSet.lcApInvTkt+'.ctktno') ,EVALUATE(loFormSet.lcApVInvDt+'.ctktno') ),;
        CINVTYPE  WITH ''  ,;
        ITEM      WITH ''                    ,;
        MFGCODE   WITH EVALUATE(loFormSet.lcApVInvDt+'.cOprCode') ,;
        CWARECODE WITH ''                    ,;
        CDYELOT   WITH ''                    ,;
        CRSESSION WITH EVALUATE(loFormSet.lcAPInvTkt+'.cRSession'),;
        CVENDCODE WITH loFormSet.AriaForm1.KBVendCode.KeyTextBox.Value ,;
        CAPINVNO  WITH loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value ,;
        CISESSION WITH ''        ,;
        SHIPNO    WITH ''        ,;
        DTRANDATE WITH loFormSet.AriaForm1.DtPostDate.Value,;
        CCOSTTYPE WITH EVALUATE(loFormSet.lcApVInvDt+'.cCostType') ,;
        NTOTQTY   WITH EVALUATE(loFormSet.lcAPInvTkt+'.nApTAplQty') ,;
        NTOTCST   WITH EVALUATE(loFormSet.lcAPInvTkt+'.nApAplAmnt') ,;
        NUNITCST  WITH IIF(NTOTQTY=0,0,NTOTCST/NTOTQTY)  ,;
        NTOTACST  WITH NTOTCST  ,;
        NUNITACST WITH NUNITCST ,;
        Actualize WITH 'Y' &&Sql60: ICLR Field not found
        REPLACE CBOMTYPE  WITH EVALUATE(LOFORMSET.LCAPVINVDT+'.cbomtype') ,;
          CIMTYP    WITH IIF(EVALUATE(LOFORMSET.LCAPVINVDT+'.cIMTyp')="S","I",EVALUATE(LOFORMSET.LCAPVINVDT+'.cIMTyp')) ,;
          CTKTNO    WITH IIF(EVALUATE(LOFORMSET.LCAPVINVDT+'.cIMTyp')="S", EVALUATE(LOFORMSET.LCAPINVTKT+'.ctktno') ,EVALUATE(LOFORMSET.LCAPVINVDT+'.ctktno') ),;
          CINVTYPE  WITH ''  ,;
          ITEM      WITH ''                    ,;
          MFGCODE   WITH EVALUATE(LOFORMSET.LCAPVINVDT+'.cOprCode') ,;
          CWARECODE WITH ''                    ,;
          CDYELOT   WITH ''                    ,;
          CRSESSION WITH EVALUATE(LOFORMSET.LCAPINVTKT+'.cRSession'),;
          CVENDCODE WITH LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE ,;
          CAPINVNO  WITH LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE ,;
          CISESSION WITH ''        ,;
          SHIPNO    WITH ''        ,;
          DTRANDATE WITH LOFORMSET.ARIAFORM1.DTPOSTDATE.VALUE,;
          CCOSTTYPE WITH EVALUATE(LOFORMSET.LCAPVINVDT+'.cCostType') ,;
          NTOTQTY   WITH NTOTQTY+EVALUATE(LOFORMSET.LCAPINVTKT+'.nApTAplQty') ,;
          NTOTCST   WITH NTOTCST+EVALUATE(LOFORMSET.LCAPINVTKT+'.nApAplAmnt') ,;
          NUNITCST  WITH IIF(NTOTQTY=0,0,NTOTCST/NTOTQTY)  ,;
          NTOTACST  WITH NTOTCST  ,;
          NUNITACST WITH NUNITCST ,;
          ACTUALIZE WITH 'Y' &&Sql60: ICLR Field not found
        *B608489,1 WAM 03/23/2008 (End)
        SELECT BOMCOST

      CASE !LLDELETED AND FOUND()

        LOFORMSET.BOMCOST.REPLACE()
        SELECT (LOFORMSET.BOMCOST.LCCURSORUPDATE)
        REPLACE NTOTQTY   WITH NTOTQTY - IIF(LNRECNO=0,0,APINVTKT.NAPTAPLQTY) + EVALUATE(LOFORMSET.LCAPINVTKT+'.nApTAplQty') ,;
          NTOTCST   WITH NTOTCST - IIF(LNRECNO=0,0,APINVTKT.NAPAPLAMNT) + EVALUATE(LOFORMSET.LCAPINVTKT+'.nApAplAmnt') ,;
          NUNITCST  WITH IIF(NTOTQTY=0,0,NTOTCST/NTOTQTY)  ,;
          NTOTACST  WITH NTOTCST  ,;
          NUNITACST WITH NUNITCST ,;
          ACTUALIZE WITH 'Y'
        SELECT BOMCOST

      CASE LLDELETED AND FOUND()
        *Fix the contribution process [Begin]
        *DELETE
        LOFORMSET.BOMCOST.REPLACE()
        SELECT (LOFORMSET.BOMCOST.LCCURSORUPDATE)
        REPLACE NTOTQTY   WITH NTOTQTY -  IIF(LNRECNO=0,0,EVALUATE(LOFORMSET.LCAPINVTKT+'.nApTAplQty')) ,;
          NTOTCST   WITH NTOTCST -  IIF(LNRECNO=0,0,EVALUATE(LOFORMSET.LCAPINVTKT+'.nApAplAmnt')) ,;
          NUNITCST  WITH IIF(NTOTQTY=0,0,NTOTCST/NTOTQTY)  ,;
          NTOTACST  WITH NTOTCST  ,;
          NUNITACST WITH NUNITCST ,;
          ACTUALIZE WITH 'Y'
        IF NTOTQTY = 0
          DELETE
        ENDIF
        SELECT BOMCOST
        *Fix the contribution process [End]
      ENDCASE
    ENDSCAN
  ENDIF
ENDSCAN
SELECT (LOFORMSET.LCAPVINVDT)
DELETE ALL FOR INLIST(CSTATUS,'D','S')
SELECT (LOFORMSET.LCAPINVTKT)
DELETE ALL FOR INLIST(CSTATUS,'D','S')
*Update Invoice Details File
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*=gfTmp2Mast('APVINVDT',loFormSet.lcApVInvDt)
=LFTMP2MAST('APVINVDT',LOFORMSET.LCAPVINVDT)
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
*Update Invoice Applied Tickets File
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*=gfTmp2Mast('APINVTKT',loFormSet.lcAPInvTkt)
=LFTMP2MAST('APINVTKT',LOFORMSET.LCAPINVTKT)
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]


*Set the approperiate tag
SET ORDER TO TAG (LOFORMSET.LCAPINVTKT) IN (LOFORMSET.LCAPINVTKT)
SET EXACT &LCEXSTATUS

RETURN
*-- End of lfUpdFiles


*!*************************************************************
*! Name      : lfUpdPoHAC
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 8/16/2004
*! Purpose   : To update the actual cost in the poshdr file in case
*!             of invoicing by shipment.
*!*************************************************************
*! Parameters: The FormSet
*!*************************************************************
*! Returns   : None
*!*************************************************************
FUNCTION LFUPDPOHAC
LPARAMETERS LOFORMSET

PRIVATE LNALIAS

LNALIAS = SELECT()

IF !EMPTY(LCHDRFILE)
  *-- Scan the corresponding records in the detail file (lcAPInvTkt) with
  *-- receiving session not empty.
  SELECT (LOFORMSET.LCAPINVTKT)



  SCAN REST;
      WHILE CVENDCODE + CAPINVNO + CAPVILNO = EVALUATE(LOFORMSET.LCAPVINVDT+'.cVendCode') +;
      EVALUATE(LOFORMSET.LCAPVINVDT+'.cApInvNo') + EVALUATE(LOFORMSET.LCAPVINVDT+'.cAPVILNo')


    *-- Flag to know if the record has been deleted
    LLDELETED = (CSTATUS='D')
    *-- Variable to hold the record number of the corresponding record in
    *-- the master file
    LNRECNO   = NRECNO

    *-- Replace the record pointer on the corresponding record in the
    *-- master file.
    IF BETWEEN(LNRECNO ,1,RECCOUNT('APINVTKT'))
      GO LNRECNO IN APINVTKT
    ENDIF    && End of IF lnRecNo > 0

    LNAMNTCHNG = IIF(LLDELETED   , 0 , NAPAPLAMNT) -;
      IIF(LNRECNO = 0 , 0 , APINVTKT.NAPAPLAMNT)

    *-- If there is no records for this document number in the actual
    *-- cost temp. header file
    IF !SEEK(m.CIMTYP + CTKTNO , LOFORMSET.LCACTCSTHD)
      m.CTKTNO = CTKTNO

      SELECT (LCHDRFILE)
      *Old: IF SEEK (lcHKeyVal + m.cTktNo)
      IF LOFORMSET.&LCHDRFILE..SEEK(LCHKEYVAL + m.CTKTNO) &&Sql25: Check Key
        *-- Attempt to lock the record
        IF .T. && gfObj_Lock(.T.) is not needed
          m.REC_NO = REC_NO  &&Sql26: Check RowID

          *B608412,1 WAM 01/20/2008 Include cost 6 & 7 while add invoice lines
          *STORE 0 TO m.nActCost1  , m.nActCost2  , m.nActCost3 ,;
          m.nActCost4  , m.nActCost5  ,;
          m.nFActCost1 , m.nFActCost2 , m.nFActCost3 ,;
          m.nFActCost4 , m.nFActCost5
          STORE 0 TO m.NACTCOST1 , m.NACTCOST2 , m.NACTCOST3 , m.NACTCOST4 , m.NACTCOST5 , m.NACTCOST6 , m.NACTCOST7 ,;
            M.NFACTCOST1, m.NFACTCOST2, m.NFACTCOST3, m.NFACTCOST4, m.NFACTCOST5, m.NFACTCOST6, m.NFACTCOST7
          *B608412,1 WAM 01/20/2008 (End)

          *-- If there is no fields for the actual cost in foreign currency
          IF EMPTY(LCHFACTFLD)
            *-- Get the actual cost
            FOR LNCOUNT = 1 TO LNACTCSTNO
              LCCOUNT            = ALLTRIM(STR(LNCOUNT))
              m.NACTCOST&LCCOUNT = &LCHACTFILD.&LCCOUNT
            ENDFOR
          ELSE    && Else [If there is fields for the actual cost in foreign currency]
            *-- Get the actual cost
            FOR LNCOUNT = 1 TO LNACTCSTNO
              LCCOUNT             = ALLTRIM(STR(LNCOUNT))
              m.NACTCOST&LCCOUNT  = &LCHACTFILD.&LCCOUNT
              m.NFACTCOST&LCCOUNT = &LCHFACTFLD.&LCCOUNT
            ENDFOR
          ENDIF    && End of IF EMPTY(lcHFActFld)

          *-- Add a corresponding record in the temp. file
          INSERT INTO (LOFORMSET.LCACTCSTHD) FROM MEMVAR
        ELSE    && Else [If the attempt to lock the record failed]
          LLRETURN = .F.
        ENDIF    && End of IF gfObj_Lock(.T.)
      ENDIF
    ENDIF    && End of IF !SEEK(m.cIMTyp + cTktNo , loFormSet.lcActCstHd)

    *-- Update total actual cost in the temp. header file
    SELECT (LOFORMSET.LCACTCSTHD)
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *!*	    lcTemp = '(lnAmntChng'+loFormSet.lcExSin1+'loFormSet.AriaForm1.txtNexRate.Value'+;
    *!*	             loFormSet.lcExSin2+'apinvhdr.ncurrunit)'
    LCTEMP = '(lnAmntChng'+LOFORMSET.LCEXSIN1+'loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.Value'+;
      LOFORMSET.LCEXSIN2+'apinvhdr.ncurrunit)'
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][Start]
    TRY
      *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][End]
      REPLACE NACTCOST&LCBOMTYPE WITH NACTCOST&LCBOMTYPE + &LCTEMP
      *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][Start]
    CATCH
    ENDTRY
    *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][End]
    *-- Update total actual cost in foreign currency in the temp. header
    *-- file
    IF !EMPTY(LCHFACTFLD)
      REPLACE NFACTCOST&LCBOMTYPE WITH NFACTCOST&LCBOMTYPE + LNAMNTCHNG
    ENDIF    && End of IF !EMPTY(lcHFActFld)
  ENDSCAN
ENDIF    && End of IF !EMPTY(lcHdrFile)

SELECT (LOFORMSET.LCAPVINVDT)
=SEEK(CVENDCODE + CAPINVNO + CAPVILNO , LOFORMSET.LCAPINVTKT)

SELECT (LNALIAS)

RETURN
*-- End of lfUpdPoHAC

*!*************************************************************
*! Name      : lfUnLckPOF
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 8/16/2004
*! Purpose   : To unlock the records that we have locked
*!             in the PO files and CT files (POSHDR, POSLN,
*!             CUTTKTH, CUTTKTL, POFHDR and POFLN).
*!*************************************************************
*! Parameters: The FormSet
*!*************************************************************
*! Returns   : None
*!*************************************************************
FUNCTION LFUNLCKPOF
LPARAMETERS LOFORMSET

PRIVATE LCFILE , LCIMTYP , LNRECNO

*-- Unlock the header files [Begin]
SELECT (LOFORMSET.LCACTCSTHD)
GO TOP

DO WHILE !EOF()
  STORE '' TO LCFILE , LCIMTYP

  *-- Get the name of the header file of the current document type to
  *-- unlock the records that had been locked in it
  DO CASE
    *-- Case of document types "Style Purchase Order" and "Style Purchase
    *-- Order Return"

  CASE INLIST(CIMTYP , 'I' , 'R','S')

    LCFILE = 'POSHDR'
    *-- Case of document type "Cutting Ticket"
  CASE CIMTYP = 'M'
    LCFILE = 'CUTTKTH'
    *-- Case of document types "Material PO" and "Material PO Return"
  CASE INLIST(CIMTYP , 'L' , 'F')
    LCFILE = 'POFHDR'
    *Add Adorment order to invoice line [Begin]
  CASE INLIST(CIMTYP , 'A','D')
    LCFILE = 'POSHDR'
    *Add Adorment order to invoice line [end]
    *! B610111,1 MMT 10/11/2012 Modify Payable invoice screen to handle MFG order case[Start]
  CASE CIMTYP = 'T' && MA MFG Order
    LCFILE = 'MMFGORDH'
    *! B610111,1 MMT 10/11/2012 Modify Payable invoice screen to handle MFG order case[End]

  ENDCASE

  LCIMTYP = CIMTYP

  *-- Scan while the document type didn't change
  SCAN WHILE CIMTYP = LCIMTYP

    *-- Unlock the records that had been locked in the master file
    LNRECNO = REC_NO
    SELECT (LCFILE)
    *GO lnRecNo
    LOCATE FOR REC_NO = LNRECNO
    =GFOBJ_LOCK(.F.)
    SELECT (LOFORMSET.LCACTCSTHD)
  ENDSCAN
ENDDO

*-- Erase the actual cost header temp. file
USE

*-- Unlock the header files [End]

*-- Unlock the detail files [Begin]
SELECT (LOFORMSET.LCACTCSTDT)
GO TOP

DO WHILE !EOF()
  STORE '' TO LCFILE , LCIMTYP

  *-- Get the name of the detail file for the current document type to
  *-- unlock the records that had been locked in it
  DO CASE
    *-- Case of document types "Style Purchase Order" and "Style Purchase
    *-- Order Return"
  CASE INLIST(CIMTYP , 'I' , 'R' , 'S')
    LCFILE = 'POSLN'
    *-- Case of document type "Cutting Ticket"
  CASE CIMTYP = 'M'
    LCFILE = 'CUTTKTL'
    *-- Case of document types "Material PO" and "Material PO Return"
  CASE INLIST(CIMTYP , 'L' , 'F')
    LCFILE = 'POFLN'
    *E301995,1 Alb Add Adorment order to invoice line [Begin]
  CASE INLIST(CIMTYP , 'A','D')
    LCFILE = 'POSLN'
    *E301995,1 Alb Add Adorment order to invoice line [end]
    *! B610111,1 MMT 10/11/2012 Modify Payable invoice screen to handle MFG order case[Start]
  CASE CIMTYP = 'T' && MA MFG Order
    LCFILE = 'MMFGORDD'
    *! B610111,1 MMT 10/11/2012 Modify Payable invoice screen to handle MFG order case[End]

  ENDCASE

  LCIMTYP = CIMTYP

  *-- Scan while the document type didn't change
  SCAN WHILE CIMTYP = LCIMTYP

    *-- Unlock the records that had been locked in the master file
    LNRECNO = REC_NO
    SELECT (LCFILE)
    *GO lnRecNo
    LOCATE FOR REC_NO = LNRECNO
    =GFOBJ_LOCK(.F.)
    SELECT (LOFORMSET.LCACTCSTDT)
  ENDSCAN
ENDDO

*-- Erase the actual cost detail temp. file
USE

*-- Unlock the detail files [End]


RETURN
*-- End of lfUnLckPOF


*!*************************************************************
*! Name      : lfVAdjust
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 8/16/2004
*! Purpose   : To Void invoice adjustment
*!*************************************************************
*! Parameters: The FormSet
*!*************************************************************
*! Returns   : None
*!*************************************************************
FUNCTION LFVADJUST
LPARAMETERS LOFORMSET

WAIT 'Voiding Previous adjustment...' WINDOW NOWAIT

*check for Adjustment if Positive or Negative. [Begin]
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*IF ApInvHdr.nInvAdj <> 0 AND SEEK(PADR(loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value,12)+PADR(loFormSet.AriaForm1.KBVendCode.KeyTextBox.Value,8)+'H','APDIST')
IF APINVHDR.NINVADJ <> 0 AND GFSEEK(PADR(LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE,12)+PADR(LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE,8)+'H','APDIST')
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  *check for Adjustment if Positive or Negative. [End]
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *  =SEEK(PADR(loFormSet.AriaForm1.KBVendCode.KeyTextBox.Value,8),'ApVendor')
  =GFSEEK(PADR(LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE,8),'ApVendor')
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  SELECT APDIST
  LOCATE REST WHILE CINVNO+CVENDCODE+CAPDTRTYP = PADR(LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE,12)+PADR(LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE,8)+'H' ;
    FOR   CAPDACTID='C' AND CAPDSTAT <> 'V' AND ;
    NAPDAMNT =0   AND LEFT(CAPDREF,3)='ADJ'
  LCAPDREF = CAPDREF
  SELECT APPAYMNT
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *  =SEEK('P'+ApDIST.cApDTRTYP+APDIST.cApDRef)
  =GFSEEK('P'+APDIST.CAPDTRTYP+APDIST.CAPDREF)
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  LOCATE REST WHILE CPAYTYPE+CPAYMETH+CPAYDOCNO+CBNKCODE+CCHKACCT = ;
    'P'+APDIST.CAPDTRTYP+APDIST.CAPDREF ;
    FOR CPAYCLNO = PADR(LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE,8) AND CPAYSTAT <> 'V' AND NPAYAMNT = 0
  IF FOUND()
    SELECT APDIST
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *=SEEK(PADR(loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value,12)+PADR(loFormSet.AriaForm1.KBVendCode.KeyTextBox.Value,8)+'H')
    =GFSEEK(PADR(LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE,12)+PADR(LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE,8)+'H')
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    SCAN REST WHILE CINVNO+CVENDCODE+CAPDTRTYP = PADR(LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE,12)+PADR(LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE,8)+'H' ;
        FOR   CAPDSTAT <> 'V' AND CAPDREF = LCAPDREF
      =RLOCK()
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *REPLACE cAPDStat WITH 'V'
      GFREPLACE("cAPDStat WITH 'V'")
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      UNLOCK
      SCATTER MEMVAR
      IF m.CAPDACTID='J'
        SELECT APINVHDR
        =RLOCK()
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        * REPLACE nInvAdj WITH nInvAdj + m.nApDAmnt
        GFREPLACE("nInvAdj WITH nInvAdj + m.nApDAmnt")
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
        UNLOCK
        SELECT APVENDOR
        =RLOCK()
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        *REPLACE nVenBal WITH nVenBal - m.nApDAmnt
        GFREPLACE("nVenBal WITH nVenBal - m.nApDAmnt")
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
        UNLOCK
        SELECT APVENHST
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        *=SEEK(PADR(loFormSet.AriaForm1.KBVendCode.KeyTextBox.Value,8)+loFormSet.lcDistYer)
        =GFSEEK(PADR(LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE,8)+LOFORMSET.LCDISTYER)
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
        =RLOCK()
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        *REPLACE nVnHAdj WITH nVnHAdj + m.nApDAmnt
        GFREPLACE('nVnHAdj WITH nVnHAdj + m.nApDAmnt')
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
        UNLOCK
      ENDIF
      m.NAPDAMNT = -m.NAPDAMNT
      m.NEQVAMNT = -m.NEQVAMNT
      m.CSTATUS  = 'A'
      INSERT INTO (LOFORMSET.LCTMPDIST) FROM MEMVAR
      =GFADD_INFO(LOFORMSET.LCTMPDIST)
    ENDSCAN
    SELECT APPAYMNT
    =RLOCK()
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *    REPLACE cPayStat  WITH 'V' ,;
    dPayVDate WITH oAriaApplication.SystemDate
    GFREPLACE("cPayStat  WITH 'V' ,"+;
      "dPayVDate WITH oAriaApplication.SystemDate")
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

    UNLOCK
    *! B130111,1 ASM 11/01/2005 Allow the User to Edit an Invoice whose posted date is locked, but make entries on system date [Start]
    IF LOFORMSET.LLLOKPER
      LFCHECKTMPDIST(LOFORMSET)
    ENDIF
    *! B130111,1 ASM 11/01/2005 Allow the User to Edit an Invoice whose posted date is locked, but make entries on system date [End]
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *=gfTmp2Mast('APDIST',loFormSet.lcTmpDist)
    =LFTMP2MAST('APDIST',LOFORMSET.LCTMPDIST)
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  ENDIF
ENDIF
WAIT CLEAR

RETURN
*-- End of lfVAdjust


*!*************************************************************
*! Name      : lfGetAdjNo
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 8/16/2004
*! Purpose   : To Get next adjustment number
*!*************************************************************
*! Parameters: The FormSet
*!*************************************************************
*! Returns   : None
*!*************************************************************
FUNCTION LFGETADJNO
LPARAMETERS LOFORMSET

PRIVATE LNLASTADJ,LCLASTADJ

SELECT MAX(SUBSTR(CAPDREF,4)),LEFT(CAPDREF,3) AS ADJ FROM APDIST ;
  WHERE CINVNO+CVENDCODE+CAPDTRTYP=PADR(LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE,12)+PADR(LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE,8)+'H' AND;
  LEFT(CAPDREF,3)='ADJ' GROUP BY ADJ INTO ARRAY LCLASTADJ
IF _TALLY = 0
  LCLASTADJ = '0'
ENDIF
LNLASTADJ = INT(VAL(LCLASTADJ))+1
DO WHILE .T.
  SELECT APPAYMNT
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *  =SEEK('P'+ApInvHdr.cVenPMeth+'ADJ'+PADL(lnLastAdj,5,'0'))
  =GFSEEK('P'+APINVHDR.CVENPMETH+'ADJ'+PADL(LNLASTADJ,5,'0'))
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  LOCATE REST WHILE CPAYTYPE+CPAYMETH+CPAYDOCNO+CBNKCODE+CCHKACCT = ;
    'P'+'H'+'ADJ'+PADL(LNLASTADJ,5,'0') ;
    FOR   CPAYCLNO = PADR(LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE,8)
  *Incorect paymnt method in appaymnt file
  IF FOUND()
    LNLASTADJ = LNLASTADJ +1
  ELSE
    EXIT
  ENDIF
ENDDO

RETURN('ADJ'+PADL(LNLASTADJ,5,'0'))
*-- End of lfGetAdjNo


*!*************************************************************
*! Name      : lfUpDatPOF
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 8/16/2004
*! Purpose   : To Update the PO files and CT files
*!             (POSHDR, POSLN, CUTTKTH, CUTTKTL, POFHDR and POFLN).
*!*************************************************************
*! Parameters: The FormSet
*!*************************************************************
*! Returns   : None
*!*************************************************************
FUNCTION LFUPDATPOF
LPARAMETERS LOFORMSET

PRIVATE LCFILE , LCIMTYP , LNRECNO , LCSCATFLDS , LCGATHFLDS , LASCATVAL

*-- Update and unlock the header files [Begin]
SELECT (LOFORMSET.LCACTCSTHD)
GO TOP

DO WHILE !EOF()
  STORE '' TO LCFILE , LCIMTYP , LCSCATFLDS , LCGATHFLDS
  DIMENSION LASCATVAL[1]
  LASCATVAL = 0

  *-- Get the name of the header file, the scatter fields and the gather
  *-- fields for the current document type to update it and unlock the
  *-- records that had been locked.
  DO CASE
    *-- Case of document types "Style Purchase Order" and "Style Purchase
    *-- Order Return" and "Shipment"

  CASE INLIST(CIMTYP , 'I' , 'R','S')

    LCFILE     = 'POSHDR'
    *B608412,1 WAM 01/20/2008 Include cost 6 & 7 while add invoice lines
    *lcScatFlds = 'nActCost1 , nActCost2 , nActCost3 , nActCost4 , nActCost5 , '+;
    'nFActCost1 , nFActCost2 , nFActCost3, nFActCost4 , nFActCost5'
    *lcGathFlds = 'nAct_Cost1 , nAct_Cost2 , nAct_Cost3 , nAct_Cost4 , nAct_Cost5 , '+;
    'nFActCost1 , nFActCost2 , nFActCost3, nFActCost4 , nFActCost5'
    LCSCATFLDS = 'nActCost1, nActCost2, nActCost3, nActCost4, nActCost5, nActCost6, nActCost7,'+;
      'nFActCost1, nFActCost2, nFActCost3, nFActCost4, nFActCost5, nFActCost6, nFActCost7'
    LCGATHFLDS = 'nAct_Cost1, nAct_Cost2, nAct_Cost3, nAct_Cost4, nAct_Cost5, nAct_Cost6, nAct_Cost7,'+;
      'nFActCost1, nFActCost2, nFActCost3, nFActCost4, nFActCost5, nFActCost6, nFActCost7'
    *B608412,1 WAM 01/20/2008 (End)

    *-- Case of document type "Cutting Ticket"
  CASE CIMTYP = 'M'
    LCFILE = 'CUTTKTH'
    *B608412,1 WAM 01/20/2008 Include cost 6 & 7 while add invoice lines
    *lcScatFlds = 'nActCost1 , nActCost2 , nActCost3 , nActCost4 , nActCost5 , '+;
    'nFActCost1 , nFActCost2 , nFActCost3, nFActCost4 , nFActCost5'
    *lcGathFlds = 'nAct_Cost1 , nAct_Cost2 , nAct_Cost3 , nAct_Cost4 , nAct_Cost5 , '+;
    'nFActCost1 , nFActCost2 , nFActCost3, nFActCost4 , nFActCost5'
    LCSCATFLDS = 'nActCost1 , nActCost2 , nActCost3 , nActCost4 , nActCost5 , nActCost6 , nActCost7 , '+;
      'nFActCost1, nFActCost2, nFActCost3, nFActCost4, nFActCost5, nFActCost6, nFActCost7'
    LCGATHFLDS = 'nAct_Cost1, nAct_Cost2, nAct_Cost3, nAct_Cost4, nAct_Cost5, nAct_Cost6, nAct_Cost7,'+;
      'nFActCost1, nFActCost2, nFActCost3, nFActCost4, nFActCost5, nFActCost6, nFActCost7'
    *B608412,1 WAM 01/20/2008 (End)

    *-- Case of document types "Material PO" and "Material PO Return"
  CASE INLIST(CIMTYP , 'L' , 'F')
    LCFILE = 'POFHDR'
    LCSCATFLDS = 'nActCost1 , nActCost2 , nActCost3 , nActCost4 , nActCost5 , '+;
      'nFActCost1 , nFActCost2 , nFActCost3, nFActCost4 , nFActCost5'

    LCGATHFLDS = 'nAct_Cost1 , nAct_Cost2 , nAct_Cost3 , nAct_Cost4 , nAct_Cost5 , '+;
      'nFActCost1 , nFActCost2 , nFActCost3, nFActCost4 , nFActCost5'
    *ALB Fix the contribution process  to save the invoice [Begin]
    *-- Case of document type "Material Cutting Ticket"
  CASE CIMTYP = 'T'
    LCFILE = 'MMFGORDH'
    LCSCATFLDS = 'nActCost1 , nActCost2 , nActCost3 , nActCost4 , nActCost5 , '+;
      'nFActCost1 , nFActCost2 , nFActCost3, nFActCost4 , nFActCost5'

    LCGATHFLDS = 'nAct_Cost1 , nAct_Cost2 , nAct_Cost3 , nAct_Cost4 , nAct_Cost5 , '+;
      'nFActCost1 , nFActCost2 , nFActCost3, nFActCost4 , nFActCost5'
    *Fix the contribution process  to save the invoice [End]
    *Add Adorment order to invoice line [Begin]
  CASE INLIST(CIMTYP , 'A','D')
    LCFILE     = 'POSHDR'
    LCSCATFLDS = 'nActCost1 , nActCost2 , nActCost3 , nActCost4 , nActCost5 , '+;
      'nFActCost1 , nFActCost2 , nFActCost3, nFActCost4 , nFActCost5'

    LCGATHFLDS = 'nAct_Cost1 , nAct_Cost2 , nAct_Cost3 , nAct_Cost4 , nAct_Cost5 , '+;
      'nFActCost1 , nFActCost2 , nFActCost3, nFActCost4 , nFActCost5'
    *Add Adorment order to invoice line [end]
  ENDCASE

  LCIMTYP = CIMTYP
  *-- Scan while the document type didn't change
  SCAN WHILE CIMTYP = LCIMTYP

    *-- Update the records of the master file
    SCATTER FIELDS &LCSCATFLDS TO LASCATVAL
    LCREC_NO = REC_NO
    SELECT (LCFILE)
    *Old: GO lnRecNo
    LOFORMSET.&LCFILE..GOREC(LCREC_NO) &&Sql31: Check RowID
    LOFORMSET.&LCFILE..REPLACE()
    SELECT (LOFORMSET.&LCFILE..LCCURSORUPDATE)
    GATHER FIELDS &LCGATHFLDS FROM LASCATVAL
    SELECT (LCFILE)
    *-- Unlock the records that had been locked in the master file
    =GFOBJ_LOCK(.F.)
    SELECT (LOFORMSET.LCACTCSTHD)
  ENDSCAN
ENDDO

*-- Erase the actual cost header temp. file
USE

*-- Update and unlock the header files [End]


*-- Update and unlock the detail files [Begin]
SELECT (LOFORMSET.LCACTCSTDT)
GO TOP

DO WHILE !EOF()
  STORE '' TO LCFILE , LCIMTYP , LCSCATFLDS , LCGATHFLDS
  DIMENSION LASCATVAL[1]
  LASCATVAL = 0

  *-- Get the name of the detail file, the scatter fields and the gather
  *-- fields for the current document type to update it and unlock the
  *-- records that had been locked.
  DO CASE
    *-- Case of document types "Style Purchase Order" and "Style Purchase
    *-- Order Return" and "Shipment"

  CASE INLIST(CIMTYP , 'I' , 'R','S')
    *B603738,1 KHM 07/20/2000 (End)

    LCFILE     = 'POSLN'
    *B608412,1 WAM 01/20/2008 Include cost 6 & 7 while add invoice lines
    *lcScatFlds = 'nActCost1 , nActCost2 , nActCost3 , nActCost4 , nActCost5 , '+;
    'nFActCost1 , nFActCost2 , nFActCost3, nFActCost4 , nFActCost5'
    *lcGathFlds = 'nAct_Cost1 , nAct_Cost2 , nAct_Cost3 , nAct_Cost4 , nAct_Cost5 , '+;
    'nFActCost1 , nFActCost2 , nFActCost3, nFActCost4 , nFActCost5'

    LCSCATFLDS = 'nActCost1 , nActCost2 , nActCost3 , nActCost4 , nActCost5 , nActCost6 , nActCost7 ,'+;
      'nFActCost1, nFActCost2, nFActCost3, nFActCost4, nFActCost5, nFActCost6, nFActCost7'
    LCGATHFLDS = 'nAct_Cost1, nAct_Cost2, nAct_Cost3, nAct_Cost4, nAct_Cost5, nAct_Cost6, nAct_Cost7,'+;
      'nFActCost1, nFActCost2, nFActCost3, nFActCost4, nFActCost5, nFActCost6, nFActCost7'
    *B608412,1 WAM 01/20/2008 (End)

    *-- Case of document type "Cutting Ticket"
  CASE CIMTYP = 'M'
    LCFILE = 'CUTTKTL'

    *B608412,1 WAM 01/20/2008 Include cost 6 & 7 while add invoice lines
    *lcScatFlds = 'nActCost1 , nActCost2 , nActCost3 , nActCost4 , nActCost5 , '+;
    'nFActCost1 , nFActCost2 , nFActCost3, nFActCost4 , nFActCost5'
    *lcGathFlds = 'nAct_Cost1 , nAct_Cost2 , nAct_Cost3 , nAct_Cost4 , nAct_Cost5 , '+;
    'nFActCost1 , nFActCost2 , nFActCost3, nFActCost4 , nFActCost5'

    LCSCATFLDS = 'nActCost1 , nActCost2 , nActCost3 , nActCost4 , nActCost5 , nActCost6 , nActCost7 ,'+;
      'nFActCost1, nFActCost2, nFActCost3, nFActCost4, nFActCost5, nFActCost6, nFActCost7'
    LCGATHFLDS = 'nAct_Cost1, nAct_Cost2, nAct_Cost3, nAct_Cost4, nAct_Cost5, nAct_Cost6, nAct_Cost7,'+;
      'nFActCost1, nFActCost2, nFActCost3, nFActCost4, nFActCost5, nFActCost6, nFActCost7'
    *B608412,1 WAM 01/20/2008 (End)

    *-- Case of document types "Material PO" and "Material PO Return"
  CASE INLIST(CIMTYP , 'L' , 'F')
    LCFILE = 'POFLN'
    LCSCATFLDS = 'nActCost1 , nActCost2 , nActCost3 , nActCost4 , nActCost5 , '+;
      'nFActCost1 , nFActCost2 , nFActCost3, nFActCost4 , nFActCost5'

    LCGATHFLDS = 'nAct_Cost1 , nAct_Cost2 , nAct_Cost3 , nAct_Cost4 , nAct_Cost5 , '+;
      'nFActCost1 , nFActCost2 , nFActCost3, nFActCost4 , nFActCost5'
    *-- Case of document type "Material Cutting Ticket"
  CASE CIMTYP = 'T'
    LCFILE = 'MMFGORDD'
    LCSCATFLDS = 'nActCost1 , nActCost2 , nActCost3 , nActCost4 , nActCost5 , '+;
      'nFActCost1 , nFActCost2 , nFActCost3, nFActCost4 , nFActCost5'

    LCGATHFLDS = 'nAct_Cost1 , nAct_Cost2 , nAct_Cost3 , nAct_Cost4 , nAct_Cost5 , '+;
      'nFActCost1 , nFActCost2 , nFActCost3, nFActCost4 , nFActCost5'
  CASE INLIST(CIMTYP , 'A','D')
    LCFILE     = 'POSLN'
    LCSCATFLDS = 'nActCost1 , nActCost2 , nActCost3 , nActCost4 , nActCost5 , '+;
      'nFActCost1 , nFActCost2 , nFActCost3, nFActCost4 , nFActCost5'

    LCGATHFLDS = 'nAct_Cost1 , nAct_Cost2 , nAct_Cost3 , nAct_Cost4 , nAct_Cost5 , '+;
      'nFActCost1 , nFActCost2 , nFActCost3, nFActCost4 , nFActCost5'
  ENDCASE

  LCIMTYP = CIMTYP

  *-- Scan while the document type didn't change
  SCAN WHILE CIMTYP = LCIMTYP
    *-- Update the records of the master file
    SCATTER FIELDS &LCSCATFLDS TO LASCATVAL
    LCREC_NO = REC_NO
    SELECT (LCFILE)
    *Old: GO lnRecNo
    LOFORMSET.&LCFILE..GOREC(LCREC_NO) &&Sql32: Check RowID
    LOFORMSET.&LCFILE..REPLACE()
    SELECT (LOFORMSET.&LCFILE..LCCURSORUPDATE)
    GATHER FIELDS &LCGATHFLDS FROM LASCATVAL
    SELECT (LCFILE)

    *-- Unlock the records that had been locked in the master file
    =GFOBJ_LOCK(.F.)
    SELECT (LOFORMSET.LCACTCSTDT)
  ENDSCAN
ENDDO

*-- Erase the actual cost detail temp. file
USE
*-- Update and unlock the detail files [End]

RETURN
*-- End of lfUpDatPOF


*!*************************************************************
*! Name      : lfOpenFile
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 8/16/2004
*! Purpose   : To Open files and store name of files opened
*!*************************************************************
*! Parameters: lcFile, lcTag, loFormSet
*!*************************************************************
*! Returns   : None
*!*************************************************************
FUNCTION LFOPENFILE
PARAMETERS LCFILE, LCTAG, LOFORMSET
LOCAL LCSQL

LCFILE = UPPER(LCFILE)
LCTAG = UPPER(LCTAG)

DO CASE

CASE LCFILE='FABRIC'
  IF TYPE('loFormSet.FABRIC')<>'O'
    LOFORMSET.FABRIC = CREATEOBJECT("RemoteTable",'Item','Style','Fabric')
  ELSE
    LOFORMSET.FABRIC.SETORDER('Style')
  ENDIF

CASE LCFILE='FABDYE'
  IF TYPE('loFormSet.FABDYE')<>'O'
    LOFORMSET.FABDYE = CREATEOBJECT("RemoteTable",'ItemLoc','StyDye','FabDye')
  ELSE
    LOFORMSET.FABDYE.SETORDER('StyDye')
  ENDIF

CASE LCFILE='SHPMTHDR'
  IF TYPE('loFormSet.SHPMTHDR')<>'O'
    LOFORMSET.SHPMTHDR = CREATEOBJECT("RemoteTable",LCFILE,LCTAG,LCFILE)
  ELSE
    LOFORMSET.SHPMTHDR.SETORDER(LCTAG)
  ENDIF

CASE LCFILE='MFGOPRDT'
  IF TYPE('loFormSet.MFGOPRDT')<>'O'
    LOFORMSET.MFGOPRDT = CREATEOBJECT("RemoteTable",LCFILE,LCTAG,LCFILE)
  ELSE
    LOFORMSET.MFGOPRDT.SETORDER(LCTAG)
  ENDIF

CASE LCFILE='POSHDR'
  IF TYPE('loFormSet.POSHDR')<>'O'
    LOFORMSET.POSHDR = CREATEOBJECT("RemoteTable",LCFILE,LCTAG,LCFILE)
  ELSE
    LOFORMSET.POSHDR.SETORDER(LCTAG)
  ENDIF

CASE LCFILE='POSLN'
  IF TYPE('loFormSet.POSLN')<>'O'
    LOFORMSET.POSLN = CREATEOBJECT("RemoteTable",LCFILE,LCTAG,LCFILE)
  ELSE
    LOFORMSET.POSLN.SETORDER(LCTAG)
  ENDIF

CASE LCFILE='CUTTKTH'
  IF TYPE('loFormSet.CUTTKTH')<>'O'
    LOFORMSET.CUTTKTH = CREATEOBJECT("RemoteTable",'POSHDR',LCTAG,'CUTTKTH')
  ELSE
    LOFORMSET.CUTTKTH.SETORDER(LCTAG)
  ENDIF

CASE LCFILE='CUTTKTL'
  IF TYPE('loFormSet.CUTTKTL')<>'O'
    LOFORMSET.CUTTKTL = CREATEOBJECT("RemoteTable",'POSLN',LCTAG,'CUTTKTL')
  ELSE
    LOFORMSET.CUTTKTL.SETORDER(LCTAG)
  ENDIF

CASE LCFILE='POFHDR'
  IF TYPE('loFormSet.POFHDR')<>'O'
    LOFORMSET.POFHDR = CREATEOBJECT("RemoteTable",'POSHDR',LCTAG,'POFHDR')
  ELSE
    LOFORMSET.POFHDR.SETORDER(LCTAG)
  ENDIF

CASE LCFILE='POFLN'
  IF TYPE('loFormSet.POFLN')<>'O'
    LOFORMSET.POFLN = CREATEOBJECT("RemoteTable",'POSLN',LCTAG,'POFLN')
  ELSE
    LOFORMSET.POFLN.SETORDER(LCTAG)
  ENDIF

CASE LCFILE='MMFGORDH'
  IF TYPE('loFormSet.MMFGORDH')<>'O'
    LOFORMSET.MMFGORDH = CREATEOBJECT("RemoteTable",'POSHDR',LCTAG,'MMFGORDH')
  ELSE
    LOFORMSET.MMFGORDH.SETORDER(LCTAG)
  ENDIF

CASE LCFILE='MMFGORDD'
  IF TYPE('loFormSet.MMFGORDD')<>'O'
    LOFORMSET.MMFGORDD = CREATEOBJECT("RemoteTable",'POSLN',LCTAG,'MMFGORDD')
  ELSE
    LOFORMSET.MMFGORDD.SETORDER(LCTAG)
  ENDIF

CASE LCFILE='BOMCOST'
  IF TYPE('loFormSet.BOMCOST')<>'O'
    LOFORMSET.BOMCOST = CREATEOBJECT("RemoteTable",LCFILE,LCTAG,LCFILE)
  ELSE
    LOFORMSET.BOMCOST.SETORDER(LCTAG)
  ENDIF

CASE LCFILE='CTKTBOM'
  IF TYPE('loFormSet.CTKTBOM')<>'O'
    LOFORMSET.CTKTBOM = CREATEOBJECT("RemoteTable",LCFILE,LCTAG,LCFILE)
  ELSE
    LOFORMSET.CTKTBOM.SETORDER(LCTAG)
  ENDIF

CASE LCFILE='BOMLINE'
  IF TYPE('loFormSet.BOMLINE')<>'O'
    LOFORMSET.BOMLINE = CREATEOBJECT("RemoteTable",LCFILE,LCTAG,LCFILE)
  ELSE
    LOFORMSET.BOMLINE.SETORDER(LCTAG)
  ENDIF

OTHERWISE
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *gfOpenFile(oAriaApplication.DataDir+lcFile,lcTag,'SH')
  GFOPENTABLE(LCFILE,LCTAG,'SH')
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
ENDCASE

RETURN
*-- End of lfOpenFile

*!*************************************************************
*! Name      : lfUpdShip
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 8/16/2004
*! Purpose   : To Update cTktBom,BomCost and BomLine in case of Shipment
*!*************************************************************
*! Parameters: The FormSet
*!*************************************************************
*! Returns   : None
*!*************************************************************
FUNCTION LFUPDSHIP
LPARAMETERS LOFORMSET

PRIVATE LCINVDTKEY , LNRECNO , LLDELETED , LCORDER

SELECT BOMLINE
LCORDER =  ORDER()
*Old: SET ORDER TO (lcOrder)
*Old: SET ORDER TO TAG Bomshrec
LOFORMSET.BOMLINE.SETORDER('Bomshrec') &&Sql42: Check Tag ;
*CIMTYP+CTYPE+CBOMTYP+MFGCODE+SHIPNO+CRSESSION+CTKTNO+STR(LINENO,6)+CINVTYPE+STYLE+CSTYGRADE ;
(CIMTYP+CTYPE+CBOMTYP+MFGCODE+SHIPNO+CRSESSION+CTKTNO+STR(LINENO,6)+STYLE+SCLR+CSTYGRADE)

LCINVDTKEY= EVALUATE(LOFORMSET.LCAPVINVDT+'.cVendCode')+EVALUATE(LOFORMSET.LCAPVINVDT+'.cApInvNo')+;
  EVALUATE(LOFORMSET.LCAPVINVDT+'.cAPVILNo')
LLDELETED = (EVALUATE(LOFORMSET.LCAPVINVDT+'.cStatus')='D')
LNRECNO   = EVALUATE(LOFORMSET.LCAPVINVDT+'.nRecNo')

SELECT (LOFORMSET.LCAPVINVDT)
IF LNRECNO > 0  AND BETWEEN( LNRECNO , 1 , RECCOUNT('APVINVDT'))
  SELECT APVINVDT
  GO LNRECNO
ENDIF

SELECT (LOFORMSET.LCAPINVTKT)
=SEEK(LCINVDTKEY)
SCAN REST  WHILE CVENDCODE+CAPINVNO+CAPVILNO= LCINVDTKEY FOR EVALUATE(LOFORMSET.LCAPINVTKT+'.cStatus') <> 'S'
  SELECT (LOFORMSET.LCAPINVTKT)
  LLDELETED = (EVALUATE(LOFORMSET.LCAPVINVDT+'.cStatus')='D')
  LNRECNO   =  EVALUATE(LOFORMSET.LCAPVINVDT+'.nRecNo')

  * Go to the corresponding record in master file in case of deleted line.
  IF BETWEEN(EVALUATE(LOFORMSET.LCAPINVTKT+'.nRecNo'),1,RECCOUNT('APInvTkt'))
    GO EVALUATE(LOFORMSET.LCAPINVTKT+'.nRecNo') IN APINVTKT
  ENDIF
  *CIMTYP+CUTTKT+TYP+CINVTYPE+ITEM+MFGCODE+DYELOT
  IF LOFORMSET.CTKTBOM.SEEK("I"+EVALUATE(LOFORMSET.LCAPINVTKT+'.ctktno')+EVALUATE(LOFORMSET.LCAPVINVDT+'.cbomtype')+;
      SPACE(4)+SPACE(19)+EVALUATE(LOFORMSET.LCAPVINVDT+'.cOprCode')+SPACE(10)) &&Sql43: Check Key

    SELECT CTKTBOM
    DO CASE
    CASE EVALUATE(LOFORMSET.LCAPINVTKT+'.cStatus') ='D' AND EVALUATE(LOFORMSET.LCAPINVTKT+'.nRecNo') <> 0
      IF BETWEEN(EVALUATE(LOFORMSET.LCAPINVTKT+'.nRecNo'),1,RECCOUNT('APInvTkt'))
        GO EVALUATE(LOFORMSET.LCAPINVTKT+'.nRecNo') IN APINVTKT
        LOFORMSET.CTKTBOM.REPLACE()
        SELECT (LOFORMSET.CTKTBOM.LCCURSORUPDATE)
        REPLACE ISSUE_QTY WITH  MAX(ISSUE_QTY-APINVTKT.NAPTAPLQTY,0 ),;
          USED_QTY  WITH  MAX(ISSUE_QTY-APINVTKT.NAPTAPLQTY,0 )
        SELECT CTKTBOM
      ENDIF
    CASE EVALUATE(LOFORMSET.LCAPINVTKT+'.cStatus') ='M' AND EVALUATE(LOFORMSET.LCAPINVTKT+'.nRecNo') <> 0
      IF BETWEEN(EVALUATE(LOFORMSET.LCAPINVTKT+'.nRecNo'),1,RECCOUNT('APInvTkt'))
        GO EVALUATE(LOFORMSET.LCAPINVTKT+'.nRecNo') IN APINVTKT
        LOFORMSET.CTKTBOM.REPLACE()
        SELECT (LOFORMSET.CTKTBOM.LCCURSORUPDATE)
        REPLACE ISSUE_QTY WITH (ISSUE_QTY - APINVTKT.NAPTAPLQTY )+ EVALUATE(LOFORMSET.LCAPINVTKT+'.nApTAplQty'),;
          USED_QTY  WITH (USED_QTY  - APINVTKT.NAPTAPLQTY )+ EVALUATE(LOFORMSET.LCAPINVTKT+'.nApTAplQty')
        SELECT CTKTBOM
      ENDIF
    OTHERWISE
      **&lcAPInvTkt..cStatus ='A'
      LOFORMSET.CTKTBOM.REPLACE()
      SELECT (LOFORMSET.CTKTBOM.LCCURSORUPDATE)
      REPLACE ISSUE_QTY WITH ISSUE_QTY +  EVALUATE(LOFORMSET.LCAPINVTKT+'.nApTAplQty'),;
        USED_QTY  WITH USED_QTY  +  EVALUATE(LOFORMSET.LCAPINVTKT+'.nApTAplQty')
      SELECT CTKTBOM
    ENDCASE
  ENDIF
  *-- If the Invoice line was deleted or if the uncontributed amount was
  *-- changed.
  IF LLDELETED .OR. (EMPTY(EVALUATE(LOFORMSET.LCAPINVTKT+'.cRSession')) .AND. EVALUATE(LOFORMSET.LCAPINVTKT+'.cStatus') <> 'S')
    SELECT BOMCOST

    *CBOMTYPE+CIMTYP+CTKTNO+CINVTYPE+ITEM+MFGCODE+CWARECODE+CDYELOT+CRSESSION+CISESSION
    =LOFORMSET.BOMCOST.SEEK(EVALUATE(LOFORMSET.LCAPVINVDT+'.cbomtype')+"I"+EVALUATE(LOFORMSET.LCAPINVTKT+'.ctktno')+;
      SPACE(4)+SPACE(19)+EVALUATE(LOFORMSET.LCAPVINVDT+'.cOprCode')+SPACE(6)+SPACE(10)+;
      SPACE(6)+SPACE(6)) &&Sql44: Check Key

    LOCATE ALL FOR CVENDCODE+CAPINVNO = PADR(LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE,8)+PADR(LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE,12) &&Sql45: ICLR Field does not exist

    DO CASE
    CASE !LLDELETED AND !FOUND() .AND. EVALUATE(LOFORMSET.LCAPINVTKT+'.cStatus') <> 'D'
      IF !SEEK("I"+EVALUATE(LOFORMSET.LCAPINVTKT+'.ctktno')+'N'+EVALUATE(LOFORMSET.LCAPVINVDT+'.cbomtype')+;
          SPACE(4)+SPACE(19)+EVALUATE(LOFORMSET.LCAPVINVDT+'.cOprCode')+SPACE(LEN(COPRCODE))+;
          SPACE(LEN(CLOTNO))+SPACE(LEN(CISESSION))+SPACE(LEN(CRSESSION))+;
          PADR(LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE,8)+PADR(LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE,12), ;
          LOFORMSET.BOMCOST.LCCURSORUPDATE)

        LOFORMSET.BOMCOST.APPEND('REPLACE CBOMTYPE  WITH ""')

      ENDIF
      SELECT (LOFORMSET.BOMCOST.LCCURSORUPDATE)
      *B608651,1 WAM 08/11/2008 Accumulate cost in BOMCOST
      *REPLACE CBOMTYPE  WITH EVALUATE(loFormSet.lcApVInvDt+'.cbomtype') ,;
      CIMTYP    WITH "I"                   ,;
      CTKTNO    WITH EVALUATE(loFormSet.lcAPInvTkt+'.ctktno')   ,;
      CINVTYPE  WITH ''                    ,;
      ITEM      WITH ''                    ,;
      MFGCODE   WITH EVALUATE(loFormSet.lcApVInvDt+'.cOprCode') ,;
      CWARECODE WITH ''                    ,;
      CDYELOT   WITH ''                    ,;
      CRSESSION WITH SPACE(6)  ,;
      CVENDCODE WITH loFormSet.AriaForm1.KBVendCode.KeyTextBox.Value ,;
      CAPINVNO  WITH loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value ,;
      CISESSION WITH ''        ,;
      SHIPNO    WITH ''        ,;
      DTRANDATE WITH loFormSet.AriaForm1.DtPostDate.Value,;
      CCOSTTYPE WITH EVALUATE(loFormSet.lcApVInvDt+'.cCostType')  ,;
      NTOTQTY   WITH EVALUATE(loFormSet.lcAPInvTkt+'.nAPTAplQty') -;
      IIF(EVALUATE(loFormSet.lcAPInvTkt+'.nRecNo') = 0 , 0 ,;
      APINVTKT.nAPTAplQty) ,;
      NTOTCST   WITH EVALUATE(loFormSet.lcAPInvTkt+'.nAPAplAmnt') -;
      IIF(EVALUATE(loFormSet.lcAPInvTkt+'.nRecNo') = 0 , 0 ,;
      APINVTKT.nAPAplAmnt) ,;
      NUNITCST  WITH EVALUATE(loFormSet.lcAPInvTkt+'.nAPAplPric') -;
      IIF(EVALUATE(loFormSet.lcAPInvTkt+'.nRecNo') = 0 , 0 ,;
      APINVTKT.nAPAplPric) ,;
      NTOTACST  WITH NTOTCST  ,;
      NUNITACST WITH NUNITCST ,;
      Actualize WITH 'N' &&Sql46: ICLR Field does not exist

      REPLACE CBOMTYPE  WITH EVALUATE(LOFORMSET.LCAPVINVDT+'.cbomtype') ,;
        CIMTYP    WITH "I"                   ,;
        CTKTNO    WITH EVALUATE(LOFORMSET.LCAPINVTKT+'.ctktno')   ,;
        CINVTYPE  WITH ''                    ,;
        ITEM      WITH ''                    ,;
        MFGCODE   WITH EVALUATE(LOFORMSET.LCAPVINVDT+'.cOprCode') ,;
        CWARECODE WITH ''                    ,;
        CDYELOT   WITH ''                    ,;
        CRSESSION WITH SPACE(6)  ,;
        CVENDCODE WITH LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE ,;
        CAPINVNO  WITH LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE ,;
        CISESSION WITH ''        ,;
        SHIPNO    WITH ''        ,;
        DTRANDATE WITH LOFORMSET.ARIAFORM1.DTPOSTDATE.VALUE,;
        CCOSTTYPE WITH EVALUATE(LOFORMSET.LCAPVINVDT+'.cCostType')  ,;
        NTOTQTY   WITH NTOTQTY + EVALUATE(LOFORMSET.LCAPINVTKT+'.nAPTAplQty') -;
        IIF(EVALUATE(LOFORMSET.LCAPINVTKT+'.nRecNo') = 0 , 0 ,;
        APINVTKT.NAPTAPLQTY) ,;
        NTOTCST   WITH NTOTCST + EVALUATE(LOFORMSET.LCAPINVTKT+'.nAPAplAmnt') -;
        IIF(EVALUATE(LOFORMSET.LCAPINVTKT+'.nRecNo') = 0 , 0 ,;
        APINVTKT.NAPAPLAMNT) ,;
        NUNITCST  WITH IIF(NTOTQTY=0,0,NTOTCST/NTOTQTY) ,;
        NTOTACST  WITH NTOTCST  ,;
        NUNITACST WITH NUNITCST ,;
        ACTUALIZE WITH 'N' &&Sql46: ICLR Field does not exist
      *B608651,1 WAM 08/11/2008 (End)

      SELECT BOMCOST
    CASE !LLDELETED AND FOUND()

      LOFORMSET.BOMCOST.REPLACE()
      SELECT (LOFORMSET.BOMCOST.LCCURSORUPDATE)

      REPLACE NTOTQTY   WITH NTOTQTY +;
        IIF(EVALUATE(LOFORMSET.LCAPINVTKT+'.cStatus') = 'D' , 0 ,;
        EVALUATE(LOFORMSET.LCAPINVTKT+'.nAPTAplQty')) -;
        IIF(EVALUATE(LOFORMSET.LCAPINVTKT+'.nRecNo') = 0 , 0 ,;
        APINVTKT.NAPTAPLQTY) ,;
        NTOTCST   WITH NTOTCST +;
        IIF(EVALUATE(LOFORMSET.LCAPINVTKT+'.cStatus') = 'D' , 0 ,;
        EVALUATE(LOFORMSET.LCAPINVTKT+'.nAPAplAmnt')) -;
        IIF(EVALUATE(LOFORMSET.LCAPINVTKT+'.nRecNo') = 0 , 0 ,;
        APINVTKT.NAPAPLAMNT) ,;
        NUNITCST  WITH NUNITCST +;
        IIF(EVALUATE(LOFORMSET.LCAPINVTKT+'.cStatus ')= 'D' , 0 ,;
        EVALUATE(LOFORMSET.LCAPINVTKT+'.nAPAplPric')) -;
        IIF(EVALUATE(LOFORMSET.LCAPINVTKT+'.nRecNo') = 0 , 0 ,;
        APINVTKT.NAPAPLPRIC) ,;
        NTOTACST  WITH NTOTCST  ,;
        NUNITACST WITH NUNITCST
      IF NTOTQTY = 0
        DELETE
      ENDIF
      SELECT BOMCOST

    CASE LLDELETED AND FOUND()
      LOFORMSET.BOMCOST.REPLACE()
      SELECT (LOFORMSET.BOMCOST.LCCURSORUPDATE)
      REPLACE NTOTQTY   WITH NTOTQTY -;
        IIF(EVALUATE(LOFORMSET.LCAPINVTKT+'.nRecNo') = 0 , 0 ,;
        APINVTKT.NAPTAPLQTY) ,;
        NTOTCST   WITH NTOTCST -;
        IIF(EVALUATE(LOFORMSET.LCAPINVTKT+'.nRecNo') = 0 , 0 ,;
        APINVTKT.NAPAPLAMNT) ,;
        NUNITCST  WITH NUNITCST -;
        IIF(EVALUATE(LOFORMSET.LCAPINVTKT+'.nRecNo') = 0 , 0 ,;
        APINVTKT.NAPAPLPRIC) ,;
        NTOTACST  WITH NTOTCST  ,;
        NUNITACST WITH NUNITCST

      IF NTOTQTY = 0
        DELETE
      ENDIF
      SELECT BOMCOST
    ENDCASE
  ENDIF    && End of IF EMPTY(&loFormSet.lcAPInvTkt..cRSession) .AND. ...

  SELECT (LOFORMSET.LCAPINVTKT)
  IF !EMPTY(EVALUATE(LOFORMSET.LCAPINVTKT+'.cRSession'))
    LLDELETED = (CSTATUS='D')
    LNRECNO = NRECNO
    IF !LLDELETED AND BETWEEN(LNRECNO ,1, RECCOUNT('APINVTKT'))
      SELECT APINVTKT
      GO LNRECNO
    ENDIF

    SELECT BOMLINE
    *CIMTYP+CTYPE+CBOMTYP+MFGCODE+SHIPNO+CRSESSION+CTKTNO+STR(LINENO,6)+CINVTYPE+STYLE+CSTYGRADE
    =LOFORMSET.BOMLINE.SEEK("I"+"3"+EVALUATE(LOFORMSET.LCAPVINVDT+'.cBomType')+EVALUATE(LOFORMSET.LCAPVINVDT+'.cOprCode')+;
      EVALUATE(LOFORMSET.LCAPVINVDT+'.shipno')+EVALUATE(LOFORMSET.LCAPINVTKT+'.cRSession')+;
      EVALUATE(LOFORMSET.LCAPINVTKT+'.ctktno')+;
      STR(EVALUATE(LOFORMSET.LCAPINVTKT+'.LineNo'),6)+;
      '0001'+EVALUATE(LOFORMSET.LCAPINVTKT+'.Item')) &&Sql47: Check Key

    DO CASE
    CASE !LLDELETED AND !FOUND()
      LOFORMSET.BOMLINE.APPEND('REPLACE cimtyp    WITH "I"')
      SELECT (LOFORMSET.BOMLINE.LCCURSORUPDATE)
      REPLACE CIMTYP    WITH "I"                   ,;
        CTYPE     WITH '3'                   ,;
        CBOMTYP   WITH EVALUATE(LOFORMSET.LCAPVINVDT+'.cBomType') ,;
        MFGCODE   WITH EVALUATE(LOFORMSET.LCAPVINVDT+'.cOprCode') ,;
        CTKTNO    WITH EVALUATE(LOFORMSET.LCAPINVTKT+'.ctktno')   ,;
        CRSESSION WITH EVALUATE(LOFORMSET.LCAPINVTKT+'.cRSession'),;
        SHIPNO    WITH EVALUATE(LOFORMSET.LCAPVINVDT+'.shipno')   ,;
        LINENO    WITH EVALUATE(LOFORMSET.LCAPINVTKT+'.LineNo')   ,;
        CINVTYPE  WITH '0001'    ,;
        STYLE     WITH EVALUATE(LOFORMSET.LCAPINVTKT+'.Item')     ,;
        CCATGTYP  WITH EVALUATE(LOFORMSET.LCAPVINVDT+'.cCostType'),;
        UNITQTY   WITH  1 ,;
        STYQTY    WITH EVALUATE(LOFORMSET.LCAPINVTKT+'.nApTAplQty') ,;
        ITEMQTY   WITH STYQTY ,;
        ITEMAMT   WITH EVALUATE(LOFORMSET.LCAPINVTKT+'.nApAplAmnt') ,;
        UNITCOST  WITH IIF(ITEMQTY=0,0,ITEMAMT/ITEMQTY) &&Sql48: SCLR Field does not exist

      * B608833,1 HES 04/01/2009 Add Standared Fields for POMLINE File[T20081001.0001]
      =GFADD_INFO(LOFORMSET.BOMLINE.LCCURSORUPDATE)
      * B608833,1 HES 04/01/2009 Add Standared Fields for POMLINE File[T20081001.0001]

      SELECT BOMLINE

    CASE !LLDELETED AND FOUND()
      LOFORMSET.BOMLINE.REPLACE()
      SELECT (LOFORMSET.BOMLINE.LCCURSORUPDATE)
      REPLACE STYQTY   WITH STYQTY - IIF(LNRECNO=0,0,APINVTKT.NAPTAPLQTY) + EVALUATE(LOFORMSET.LCAPINVTKT+'.nApTAplQty') ,;
        ITEMQTY  WITH STYQTY ,;
        ITEMAMT  WITH ITEMAMT -IIF(LNRECNO=0,0,APINVTKT.NAPAPLAMNT) + EVALUATE(LOFORMSET.LCAPINVTKT+'.nApAplAmnt') ,;
        UNITCOST WITH IIF(ITEMQTY=0,0,ITEMAMT/ITEMQTY)

      * B608833,1 HES 04/01/2009 Add Standared Fields for POMLINE File[T20081001.0001]
      =GFADD_INFO(LOFORMSET.BOMLINE.LCCURSORUPDATE)
      * B608833,1 HES 04/01/2009 Add Standared Fields for POMLINE File[T20081001.0001]

      SELECT BOMLINE
    CASE LLDELETED AND FOUND()
      *SELECT (loFormSet.BomLine.lcCursorUpdate)
      *DELETE
      LOFORMSET.BOMLINE.DELETE()

    ENDCASE

    SELECT BOMCOST
    *CBOMTYPE+CIMTYP+CTKTNO+CINVTYPE+ITEM+MFGCODE+CWARECODE+CDYELOT+CRSESSION+CISESSION
    =LOFORMSET.BOMCOST.SEEK(EVALUATE(LOFORMSET.LCAPVINVDT+'.cbomtype')+"I"+EVALUATE(LOFORMSET.LCAPINVTKT+'.ctktno')+;
      SPACE(4)+SPACE(19)+EVALUATE(LOFORMSET.LCAPVINVDT+'.cOprCode')+;
      SPACE(6)+SPACE(10)+EVALUATE(LOFORMSET.LCAPINVTKT+'.cRSession')+SPACE(6)) &&Sql49: Check Key
    LOCATE ALL FOR CVENDCODE+CAPINVNO = PADR(LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE,8)+PADR(LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE,12) &&Sql50: ICLR Field not found

    DO CASE
    CASE !LLDELETED AND !FOUND()
      IF !SEEK("I"+EVALUATE(LOFORMSET.LCAPINVTKT+'.ctktno')+'Y'+EVALUATE(LOFORMSET.LCAPVINVDT+'.cbomtype')+;
          SPACE(4)+SPACE(19)+EVALUATE(LOFORMSET.LCAPVINVDT+'.cOprCode')+SPACE(LEN(COPRCODE))+;
          SPACE(LEN(CLOTNO))+SPACE(LEN(CISESSION))+EVALUATE(LOFORMSET.LCAPINVTKT+'.cRSession')+;
          PADR(LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE,8)+PADR(LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE,12),;
          LOFORMSET.BOMCOST.LCCURSORUPDATE)
        LOFORMSET.BOMCOST.APPEND('REPLACE CBOMTYPE  WITH ""')
      ENDIF

      SELECT (LOFORMSET.BOMCOST.LCCURSORUPDATE)
      *B608651,1 WAM 08/11/2008 Accumulate cost in BOMCOST
      *REPLACE CBOMTYPE  WITH EVALUATE(loFormSet.lcApVInvDt+'.cbomtype') ,;
      CIMTYP    WITH "I"                   ,;
      CTKTNO    WITH EVALUATE(loFormSet.lcApInvTkt+'.ctktno')   ,;
      CINVTYPE  WITH ''                    ,;
      ITEM      WITH ''                    ,;
      MFGCODE   WITH EVALUATE(loFormSet.lcApVInvDt+'.cOprCode') ,;
      CWARECODE WITH ''                    ,;
      CDYELOT   WITH ''                    ,;
      CRSESSION WITH EVALUATE(loFormSet.lcAPInvTkt+'.cRSession'),;
      CVENDCODE WITH loFormSet.AriaForm1.KBVendCode.KeyTextBox.Value ,;
      CAPINVNO  WITH loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value ,;
      CISESSION WITH ''        ,;
      SHIPNO    WITH ''        ,;
      DTRANDATE WITH loFormSet.AriaForm1.DtPostDate.Value,;
      CCOSTTYPE WITH EVALUATE(loFormSet.lcApVInvDt+'.cCostType') ,;
      NTOTQTY   WITH EVALUATE(loFormSet.lcAPInvTkt+'.nApTAplQty') ,;
      NTOTCST   WITH EVALUATE(loFormSet.lcAPInvTkt+'.nApAplAmnt') ,;
      NUNITCST  WITH IIF(NTOTQTY=0,0,NTOTCST/NTOTQTY)  ,;
      NTOTACST  WITH NTOTCST  ,;
      NUNITACST WITH NUNITCST ,;
      Actualize WITH 'Y' &&Sql51: ICLR Field not found

      REPLACE CBOMTYPE  WITH EVALUATE(LOFORMSET.LCAPVINVDT+'.cbomtype') ,;
        CIMTYP    WITH "I"                   ,;
        CTKTNO    WITH EVALUATE(LOFORMSET.LCAPINVTKT+'.ctktno')   ,;
        CINVTYPE  WITH ''                    ,;
        ITEM      WITH ''                    ,;
        MFGCODE   WITH EVALUATE(LOFORMSET.LCAPVINVDT+'.cOprCode') ,;
        CWARECODE WITH ''                    ,;
        CDYELOT   WITH ''                    ,;
        CRSESSION WITH EVALUATE(LOFORMSET.LCAPINVTKT+'.cRSession'),;
        CVENDCODE WITH LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE ,;
        CAPINVNO  WITH LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE ,;
        CISESSION WITH ''        ,;
        SHIPNO    WITH ''        ,;
        DTRANDATE WITH LOFORMSET.ARIAFORM1.DTPOSTDATE.VALUE,;
        CCOSTTYPE WITH EVALUATE(LOFORMSET.LCAPVINVDT+'.cCostType') ,;
        NTOTQTY   WITH NTOTQTY + EVALUATE(LOFORMSET.LCAPINVTKT+'.nApTAplQty') ,;
        NTOTCST   WITH NTOTCST + EVALUATE(LOFORMSET.LCAPINVTKT+'.nApAplAmnt') ,;
        NUNITCST  WITH IIF(NTOTQTY=0,0,NTOTCST/NTOTQTY)  ,;
        NTOTACST  WITH NTOTCST  ,;
        NUNITACST WITH NUNITCST ,;
        ACTUALIZE WITH 'Y' &&Sql51: ICLR Field not found

      *B608651,1 WAM 08/11/2008 (End)
      SELECT BOMCOST
      *B605493,1 SSH 10/Feb/2002 Incorrect update for BOMCOST.DTRANDATE.
    CASE !LLDELETED AND FOUND()
      LOFORMSET.BOMCOST.REPLACE()
      SELECT (LOFORMSET.BOMCOST.LCCURSORUPDATE)
      REPLACE NTOTQTY   WITH NTOTQTY - IIF(LNRECNO=0,0,APINVTKT.NAPTAPLQTY) + EVALUATE(LOFORMSET.LCAPINVTKT+'.nApTAplQty') ,;
        NTOTCST   WITH NTOTCST - IIF(LNRECNO=0,0,APINVTKT.NAPAPLAMNT) + EVALUATE(LOFORMSET.LCAPINVTKT+'.nApAplAmnt') ,;
        NUNITCST  WITH IIF(NTOTQTY=0,0,NTOTCST/NTOTQTY)  ,;
        NTOTACST  WITH NTOTCST  ,;
        NUNITACST WITH NUNITCST ,;
        ACTUALIZE WITH 'Y'

      SELECT BOMCOST
    CASE LLDELETED AND FOUND()
      *SELECT (loFormSet.BOMCOST.lcCursorUpdate)
      *DELETE
      LOFORMSET.BOMCOST.DELETE()
    ENDCASE
  ENDIF   && End of If !EMPTY(&loFormSet.lcAPInvTkt..cRSession)
ENDSCAN


SELECT BOMLINE
*Old: SET ORDER TO (lcOrder)
LOFORMSET.BOMLINE.SETORDER(LCORDER) &&Sql52: Check Tag

SELECT (LOFORMSET.LCAPVINVDT)

RETURN
*-- End of lfUpdShip


***SS2

***sss***

***LLL***

*!*************************************************************
*! Name      : lfvInvLines
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 8/30/2004
*! Purpose   : Called from the Click Event of the cmdInvLines Button.
*!*************************************************************
*! Parameters: loFormSet
*!*************************************************************
*! Returns   : None
*!*************************************************************
FUNCTION LFVINVLINES
LPARAMETERS LOFORMSET
*Prevent the user from entering the
*          "Invoice Detail" screen if the company is using multi-currency
*          and the currency field is empty
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*IF gfGetMemVar('LLMULCURR') .AND. EMPTY(loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value)
IF GFGETMEMVAR('LLMULCURR') .AND. EMPTY(LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.KEYTEXTBOX.VALUE)
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  ** MESSAGE : " You have to enter the ."
  **           "          Ok           "
  **  = 'invoice currency'
  =GFMODALGEN("TRM04066B00000" , "DIALOG" , "invoice currency")

  *Old: _CUROBJ = OBJNUM(loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value)
  *Old: SHOW GET loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value  &&lower &&Revise
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *loFormSet.AriaForm1.kbCurrCode.KeyTextBox.SetFocus()
  LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.KEYTEXTBOX.SETFOCUS()
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[END]
ELSE
  *DO FORM (OARIAAPPLICATION.SCREENHOME+"\AP\APINVDT.SCX") WITH LOFORMSET.ARIAFORM1
  *! E303029,1 MMT 12/26/2011 correct the calling of non-major programs within the SaaS environemnt[STart]
  *DO FORM (oAriaApplication.ScreenHome+"\AP\APINVDT.SCX") WITH loFormSet.AriaForm1
  LOPARAMLIST = LOFORMSET
  =GFCALLFORM('APINVDT','AP',"loParamList.AriaForm1")
  *! E303029,1 MMT 12/26/2011 correct the calling of non-major programs within the SaaS environemnt[END]


ENDIF
RETURN
*-- End of lfvInvLines

*!*************************************************************
*! Name      : lfInvDtInit
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 8/30/2004
*! Purpose   : Called from the Init Event of the APINVDT Screen.
*!*************************************************************
*! Parameters: The FormSet of APPYINV.SCX, The Form of APINVDT.SCX
*!*************************************************************
*! Returns   : True or False
*!*************************************************************
FUNCTION LFINVDTINIT
LPARAMETERS LOFORMSET, LOFORM
LOCAL LNL, LNC
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*!*	RELEASE PAD _INQUIRY OF (loFormSet.cHostFormName)
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
*ASM, Add Properties to the form [Start]
LCALLVAR = 'lcCstType,lcTktType,lcOprCode,laOprLots,llDefQtyDt,llDefAuApr,llDefEdApr,'+;
  'lcAutoMode,lcScrMode,lcDetMode,lcInvQTot,lcInvQDet,lcAprQDet,lcAprQty,'+;
  'lcAprPri,lcWIPStat,laTktType,lnAlias'

DIMENSION LAALLVAR[1,1]
STORE '' TO LAALLVAR
=GFSUBSTR(LCALLVAR,@LAALLVAR,',')

LOCAL LNI
FOR LNI = 1 TO ALEN(LAALLVAR,1)
  IF LOWER(LEFT(LAALLVAR[lnI,1],2)) <> 'la'
    PRIVATE &LAALLVAR[lnI,1].
  ENDIF
ENDFOR
DIMENSION LAOPRLOTS[1], LATKTTYPE[1,3]

=LFADDPRO(LOFORM)
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*loForm.AddProperty('loRec')
IF LOFORMSET.ACTIVEMODE = 'S'
  RETURN
ENDIF
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
*ASM, Add Properties to the form [End]

*Old: PRIVATE lnAlias

STORE .F. TO LOFORMSET.LLZOOMINVD   && Zoom Invoice Detail Browse
LOFORM.LCCSTTYPE  = ''
LOFORM.LCOPRCODE  = ''
LOFORMSET.LCCODEFILT = ''
LOFORM.LNALIAS = SELECT()
STORE '' TO LCBROWSETL,LCLINKCODE
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*!*	DECLARE laBrowArr[1],loForm.laOprLots[1]
*!*	STORE 'N/A' TO loForm.laOprLots[1]
DECLARE LABROWARR[1],LOFORMSET.LAOPRLOTS[1]
*N000682,1 MMT 12/09/2012 Globalization changes[Start]
*STORE 'N/A' TO LOFORMSET.LAOPRLOTS[1]
STORE IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_NOTAPPLICABLE,loformset.GetHeaderText("LANG_APPYINV_NOTAPPLICABLE",loformset.HeaderAlias)) TO LOFORMSET.LAOPRLOTS[1]
*N000682,1 MMT 12/09/2012 Globalization changes[End]
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

*Old: lcSize1 = 'Size1'
*Old: lcSize2 = 'Size2'
*Old: lcSize3 = 'Size3'
*Old: lcSize4 = 'Size4'
*Old: lcSize5 = 'Size5'
*Old: lcSize6 = 'Size6'
*Old: lcSize7 = 'Size7'
*Old: lcSize8 = 'Size8'

STORE 1 TO LOFORM.CBOCOSTTYPE.VALUE
*Old: STORE 0 TO lnMarker
LOFORM.LCTKTTYPE = 'M'
*N000682,1 MMT 11/22/2012 Globalization changes[Start]
*LCINVDTBR = 'Invoice Details'
*LCINVZOOM = 'Zoom Invoice Details'
*N000682,1 11/20/2012 MMT Globlization changes[Start]
*LCINVDTBR = LANG_APPYINV_INVOICE_DETAILS
LCINVDTBR = IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_INVOICE_DETAILS,loFormSet.GetHeaderText("LANG_APPYINV_INVOICE_DETAILS",loFormSet.HeaderAlias))
*N000682,1 11/20/2012 MMT Globlization changes[End]

*N000682,1 11/20/2012 MMT Globlization changes[Start]
*LCINVZOOM = LANG_APPYINV_ZOOM_INVOICE_DETAILS
LCINVZOOM = IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_ZOOM_INVOICE_DETAILS,loFormSet.GetHeaderText("LANG_APPYINV_ZOOM_INVOICE_DETAILS",loFormSet.HeaderAlias))
*N000682,1 11/20/2012 MMT Globlization changes[End]

*N000682,1 MMT 11/22/2012 Globalization changes[END]
LCSTYHDR   = GFITEMMASK("HI")
LNSTYLNGTH = LEN(LCSTYHDR)

SELECT CODES
*Old :loFormSet.lcCodeFilt = SET('FILTER')
*Old :SET FILTER TO
*Invoice lines called
LOFORMSET.LLUPDINVLN = .T.
*Update exchange rate and unit signs.
LCEXSIN2=LOFORMSET.LCEXSIN2
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*loFormSet.lcExSin1   = gfGetExSin(@lcExSin2,loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value)
LOFORMSET.LCEXSIN1   = GFGETEXSIN(@LCEXSIN2,LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.KEYTEXTBOX.VALUE)
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
LOFORMSET.LCEXSIN2=LCEXSIN2

STORE 1 TO LOFORM.CBOTKTTYPE.VALUE,LOFORM.CBOLOTNO.VALUE
=LFOPENFILE('Style','Style',LOFORMSET)
*Set GL_LINK approperiate tag
=IIF(LOFORMSET.LASETUPS[3,2]='Y',LFOPENFILE('GL_LINK','GL_LINK',LOFORMSET),.T.)
*Q1: Was StyDye Table Changed ?
=IIF(LOFORMSET.LASETUPS[1,2]='Y',LFOPENFILE('STYDYE','STYDYE',LOFORMSET),.T.)
=LFOPENFILE('Scale','Scale',LOFORMSET)
=LFOPENFILE('BOMLINE','BOMLINE',LOFORMSET)
SELECT STYLE
*ASM, No need to set relation into scale because we will use scale with the material
*SET RELATION TO 'S'+Scale INTO Scale
DECLARE LOFORMSET.LACOSTTYPE[1]
STORE '' TO LOFORMSET.LACOSTTYPE, LCOLDVALUE, LOFORM.KBINVTKTNO.KEYTEXTBOX.VALUE
LNTKTNO = 0
IF 'G' $ LOFORMSET.LCVENINVTYPES
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	  DECLARE loForm.laTktType[1,3]
  *!*	  loForm.laTktType[1,1]='General Expense'
  *!*	  loForm.laTktType[1,2]='G'
  *!*	  loForm.laTktType[1,3]='Document#'
  DECLARE LOFORMSET.LATKTTYPE[1,3]
  *N000682,1 MMT 11/22/2012 Globalization changes[Start]
  *LOFORMSET.LATKTTYPE[1,1]='General Expense'
  *N000682,1 11/20/2012 MMT Globlization changes[Start]
*LOFORMSET.LATKTTYPE[1,1] = LANG_APPYINV_GENERALEXPENSE
LOFORMSET.LATKTTYPE[1,1] = IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_GENERALEXPENSE,loFormSet.GetHeaderText("LANG_APPYINV_GENERALEXPENSE",loFormSet.HeaderAlias))
*N000682,1 11/20/2012 MMT Globlization changes[End]

  *N000682,1 MMT 11/22/2012 Globalization changes[END]
  LOFORMSET.LATKTTYPE[1,2]='G'
  *N000682,1 MMT 11/22/2012 Globalization changes[Start]
  *LOFORMSET.LATKTTYPE[1,3]='Document#'
  *N000682,1 11/20/2012 MMT Globlization changes[Start]
*LOFORMSET.LATKTTYPE[1,3] = LANG_APPYINV_DOCNO
LOFORMSET.LATKTTYPE[1,3] = IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_DOCNO,loFormSet.GetHeaderText("LANG_APPYINV_DOCNO",loFormSet.HeaderAlias))
*N000682,1 11/20/2012 MMT Globlization changes[End]

  *N000682,1 MMT 11/22/2012 Globalization changes[END]
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  LNTKTNO = 1
ENDIF
*If Style Purchase Orders Module is Installed
*! B609956,1 HIA 06/10/2012 Can not add detail lines, to invoice [T20120515.0013][Begin]
*IF ('PO' $ OARIAAPPLICATION.COMPANYINSTALLEDMODULES AND INLIST(LOFORMSET.LCVENINVTYPES,'I','S','R','A','D'))
IF (('PO' $ OARIAAPPLICATION.COMPANYINSTALLEDMODULES) AND ('I' $ LOFORMSET.LCVENINVTYPES OR 'S' $ LOFORMSET.LCVENINVTYPES OR 'R' $ LOFORMSET.LCVENINVTYPES OR 'A' $ LOFORMSET.LCVENINVTYPES OR 'D' $ LOFORMSET.LCVENINVTYPES ))
  *! B609956,1 HIA 06/10/2012 Can not add detail lines, to invoice [T20120515.0013][End]

  =LFOPENFILE('POSHDR','POSHDR',LOFORMSET) &&Sql Check Tag CBUSDOCU+CSTYTYPE+PO (CSTYTYPE+PO)
  =LFOPENFILE('POSLN','POSLN',LOFORMSET) &&Sql Check Tag ;
  *CBUSDOCU+CSTYTYPE+PO+CINVTYPE+STYLE+STR(LINENO,6)+TRANCD ;
  (CSTYTYPE+PO+STYLE+STR(LINENO,6)+TRANCD)
  =LFOPENFILE('MFGOPRDT','MFGOPRDT',LOFORMSET) &&Sql ChecK Tag ;
  *CIMTYP+CTKTNO+COPRCODE+CLOTNO+TRANCD ;
  (CIMTYP+CTKTNO+COPRCODE+CLOTNO+TRANCD)
  *Adjust Ticket Types Popup
  IF 'I' $ LOFORMSET.LCVENINVTYPES
    LNTKTNO = LNTKTNO + 1
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *!*	    DIMENSION loForm.laTktType[lnTktNo,3]
    *!*	    loForm.laTktType[lnTktNo,1]='Style Purchase Order'
    *!*	    loForm.laTktType[lnTktNo,2]='I'
    *!*	    loForm.laTktType[lnTktNo,3]='Style PO#'
    DIMENSION LOFORMSET.LATKTTYPE[lnTktNo,3]
    *N000682,1 MMT 11/22/2012 Globalization changes[Start]
    *LOFORMSET.LATKTTYPE[lnTktNo,1]='Style Purchase Order'
    *LOFORMSET.LATKTTYPE[lnTktNo,2]='I'
    *LOFORMSET.LATKTTYPE[lnTktNo,3]='Style PO#'
    *N000682,1 11/20/2012 MMT Globlization changes[Start]
*LOFORMSET.LATKTTYPE[lnTktNo,1]=LANG_APPYINV_STYLEPURCHASEORDER
LOFORMSET.LATKTTYPE[lnTktNo,1]=IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_STYLEPURCHASEORDER,loFormSet.GetHeaderText("LANG_APPYINV_STYLEPURCHASEORDER",loFormSet.HeaderAlias))
*N000682,1 11/20/2012 MMT Globlization changes[End]

    LOFORMSET.LATKTTYPE[lnTktNo,2]='I'
    *N000682,1 11/20/2012 MMT Globlization changes[Start]
*LOFORMSET.LATKTTYPE[lnTktNo,3]=LANG_APPYINV_STYLEPO_NO
LOFORMSET.LATKTTYPE[lnTktNo,3]=IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_STYLEPO_NO,loFormSet.GetHeaderText("LANG_APPYINV_STYLEPO_NO",loFormSet.HeaderAlias))
*N000682,1 11/20/2012 MMT Globlization changes[End]

    *N000682,1 MMT 11/22/2012 Globalization changes[END]
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  ENDIF
  IF 'R' $ LOFORMSET.LCVENINVTYPES
    LNTKTNO = LNTKTNO + 1
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *!*	    DIMENSION loForm.laTktType[lnTktNo,3]
    *!*	    loForm.laTktType[lnTktNo,1]='Style Purchase Order Return'
    *!*	    loForm.laTktType[lnTktNo,2]='R'
    *!*	    loForm.laTktType[lnTktNo,3]='Style PO Return#'
    DIMENSION LOFORMSET.LATKTTYPE[lnTktNo,3]
    *N000682,1 MMT 11/22/2012 Globalization changes[Start]
    *LOFORMSET.LATKTTYPE[lnTktNo,1]='Style Purchase Order Return'
    *LOFORMSET.LATKTTYPE[lnTktNo,2]='R'
    *LOFORMSET.LATKTTYPE[lnTktNo,3]='Style PO Return#'
    *N000682,1 11/20/2012 MMT Globlization changes[Start]
*LOFORMSET.LATKTTYPE[lnTktNo,1]=LANG_APPYINV_STYLEPURCHASEORDERRETURN
LOFORMSET.LATKTTYPE[lnTktNo,1]=IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_STYLEPURCHASEORDERRETURN,loFormSet.GetHeaderText("LANG_APPYINV_STYLEPURCHASEORDERRETURN",loFormSet.HeaderAlias))
*N000682,1 11/20/2012 MMT Globlization changes[End]

    LOFORMSET.LATKTTYPE[lnTktNo,2]='R'
    *N000682,1 11/20/2012 MMT Globlization changes[Start]
*LOFORMSET.LATKTTYPE[lnTktNo,3]=LANG_APPYINV_STYLEPO_RETURNNO
LOFORMSET.LATKTTYPE[lnTktNo,3]=IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_STYLEPO_RETURNNO,loFormSet.GetHeaderText("LANG_APPYINV_STYLEPO_RETURNNO",loFormSet.HeaderAlias))
*N000682,1 11/20/2012 MMT Globlization changes[End]

    *N000682,1 MMT 11/22/2012 Globalization changes[END]
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  ENDIF
  IF 'S' $ LOFORMSET.LCVENINVTYPES
    =LFOPENFILE('SHPMTHDR','SHPMTHDR',LOFORMSET) &&Sql Check Tag CBUSDOCU+CSHPTYPE+SHIPNO (SHIPNO)
    LNTKTNO = LNTKTNO + 1
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *!*	    DIMENSION loForm.laTktType[lnTktNo,3]
    *!*	    loForm.laTktType[lnTktNo,1]='Shipment'
    *!*	    loForm.laTktType[lnTktNo,2]='S'
    *!*	    loForm.laTktType[lnTktNo,3]='Shipment#'
    DIMENSION LOFORMSET.LATKTTYPE[lnTktNo,3]
    *N000682,1 MMT 11/22/2012 Globalization changes[Start]
    *LOFORMSET.LATKTTYPE[lnTktNo,1]='Shipment'
    *LOFORMSET.LATKTTYPE[lnTktNo,2]='S'
    *LOFORMSET.LATKTTYPE[lnTktNo,3]='Shipment#'
    *N000682,1 11/20/2012 MMT Globlization changes[Start]
*LOFORMSET.LATKTTYPE[lnTktNo,1]= LANG_APPYINV_SHIPMENT
LOFORMSET.LATKTTYPE[lnTktNo,1]= IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_SHIPMENT,loFormSet.GetHeaderText("LANG_APPYINV_SHIPMENT",loFormSet.HeaderAlias))
*N000682,1 11/20/2012 MMT Globlization changes[End]

    LOFORMSET.LATKTTYPE[lnTktNo,2]='S'
    *N000682,1 11/20/2012 MMT Globlization changes[Start]
*LOFORMSET.LATKTTYPE[lnTktNo,3]= LANG_APPYINV_SHIPMENT_NO
LOFORMSET.LATKTTYPE[lnTktNo,3]= IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_SHIPMENT_NO,loFormSet.GetHeaderText("LANG_APPYINV_SHIPMENT_NO",loFormSet.HeaderAlias))
*N000682,1 11/20/2012 MMT Globlization changes[End]

    *N000682,1 MMT 11/22/2012 Globalization changes[END]
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  ENDIF
ENDIF
*If Style Manufacturing Module is Installed and invoicing with base currency
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*!*	IF 'MF' $ oAriaApplication.CompanyInstalledModules AND ;
*!*	  loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value = oAriaApplication.BaseCurrency AND ;
*!*	  'M' $ loFormSet.lcVenInvTypes
IF 'MF' $ OARIAAPPLICATION.COMPANYINSTALLEDMODULES AND ;
    LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.KEYTEXTBOX.VALUE = OARIAAPPLICATION.BASECURRENCY AND ;
    'M' $ LOFORMSET.LCVENINVTYPES
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  =LFOPENFILE('CUTTKTH','POSHDR',LOFORMSET) &&Sql61: Check Tag  CBUSDOCU+CSTYTYPE+PO (CUTTKT)
  =LFOPENFILE('CUTTKTL','POSLN',LOFORMSET) &&Sql62: Check Tag ;
  *CBUSDOCU+CSTYTYPE+PO+CINVTYPE+STYLE+STR(LINENO,6)+TRANCD ;
  (CUTTKT+STYLE+DYELOT+TRANCD)
  =LFOPENFILE('MFGOPRDT','MFGOPRDT',LOFORMSET) &&Sql62: Check Tag ;
  *CIMTYP+CTKTNO+COPRCODE+CLOTNO+TRANCD (CIMTYP+CTKTNO+COPRCODE+CLOTNO+TRANCD)

  *Adjust Ticket Types Popup
  LNTKTNO = LNTKTNO + 1
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	  DIMENSION loForm.laTktType[lnTktNo,3]
  *!*	  loForm.laTktType[lnTktNo,1]='Cutting Ticket'
  *!*	  loForm.laTktType[lnTktNo,2]='M'
  *!*	  loForm.laTktType[lnTktNo,3]='Cutting Ticket#'
  DIMENSION LOFORMSET.LATKTTYPE[lnTktNo,3]
  *N000682,1 MMT 11/22/2012 Globalization changes[Start]
  *LOFORMSET.LATKTTYPE[lnTktNo,1]='Cutting Ticket'
  *LOFORMSET.LATKTTYPE[lnTktNo,2]='M'
  *LOFORMSET.LATKTTYPE[lnTktNo,3]='Cutting Ticket#'
  *N000682,1 11/20/2012 MMT Globlization changes[Start]
*LOFORMSET.LATKTTYPE[lnTktNo,1]=LANG_APPYINV_CUT_TKT
LOFORMSET.LATKTTYPE[lnTktNo,1]=IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_CUT_TKT,loFormSet.GetHeaderText("LANG_APPYINV_CUT_TKT",loFormSet.HeaderAlias))
*N000682,1 11/20/2012 MMT Globlization changes[End]

  LOFORMSET.LATKTTYPE[lnTktNo,2]='M'
  *N000682,1 11/20/2012 MMT Globlization changes[Start]
*LOFORMSET.LATKTTYPE[lnTktNo,3]=LANG_APPYINV_CT_TKT_NO
LOFORMSET.LATKTTYPE[lnTktNo,3]=IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_CT_TKT_NO,loFormSet.GetHeaderText("LANG_APPYINV_CT_TKT_NO",loFormSet.HeaderAlias))
*N000682,1 11/20/2012 MMT Globlization changes[End]

  *N000682,1 MMT 11/22/2012 Globalization changes[END]
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  IF 'A' $ LOFORMSET.LCVENINVTYPES
    LNTKTNO = LNTKTNO + 1
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *!*	    DIMENSION loForm.laTktType[lnTktNo,3]
    *!*	    loForm.laTktType[lnTktNo,1]='Adornment Order'
    *!*	    loForm.laTktType[lnTktNo,2]='A'
    *!*	    loForm.laTktType[lnTktNo,3]='Ador P/O#'
    DIMENSION LOFORMSET.LATKTTYPE[lnTktNo,3]
    *N000682,1 MMT 11/22/2012 Globalization changes[Start]
    *LOFORMSET.LATKTTYPE[lnTktNo,1]='Adornment Order'
    *LOFORMSET.LATKTTYPE[lnTktNo,2]='A'
    *LOFORMSET.LATKTTYPE[lnTktNo,3]='Ador P/O#'
    *N000682,1 11/20/2012 MMT Globlization changes[Start]
*LOFORMSET.LATKTTYPE[lnTktNo,1]=LANG_APPYINV_ADORORDER
LOFORMSET.LATKTTYPE[lnTktNo,1]=IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_ADORORDER,loFormSet.GetHeaderText("LANG_APPYINV_ADORORDER",loFormSet.HeaderAlias))
*N000682,1 11/20/2012 MMT Globlization changes[End]

    LOFORMSET.LATKTTYPE[lnTktNo,2]='A'
    *N000682,1 11/20/2012 MMT Globlization changes[Start]
*LOFORMSET.LATKTTYPE[lnTktNo,3]=LANG_APPYINV_ADORPRDER_NO
LOFORMSET.LATKTTYPE[lnTktNo,3]=IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_ADORPRDER_NO,loFormSet.GetHeaderText("LANG_APPYINV_ADORPRDER_NO",loFormSet.HeaderAlias))
*N000682,1 11/20/2012 MMT Globlization changes[End]

    *N000682,1 MMT 11/22/2012 Globalization changes[END]
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  ENDIF
  IF 'D' $ LOFORMSET.LCVENINVTYPES
    LNTKTNO = LNTKTNO + 1
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *!*	    DIMENSION loForm.laTktType[lnTktNo,3]
    *!*	    loForm.laTktType[lnTktNo,1]='Dying Order'
    *!*	    loForm.laTktType[lnTktNo,2]='D'
    *!*	    loForm.laTktType[lnTktNo,3]='Dye P/O#'
    DIMENSION LOFORMSET.LATKTTYPE[lnTktNo,3]
    *N000682,1 MMT 11/22/2012 Globalization changes[Start]
    *LOFORMSET.LATKTTYPE[lnTktNo,1]='Dying Order'
    *LOFORMSET.LATKTTYPE[lnTktNo,2]='D'
    *LOFORMSET.LATKTTYPE[lnTktNo,3]='Dye P/O#'
    *N000682,1 11/20/2012 MMT Globlization changes[Start]
*LOFORMSET.LATKTTYPE[lnTktNo,1]=LANG_APPYINV_DYEORDER
LOFORMSET.LATKTTYPE[lnTktNo,1]=IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_DYEORDER,loFormSet.GetHeaderText("LANG_APPYINV_DYEORDER",loFormSet.HeaderAlias))
*N000682,1 11/20/2012 MMT Globlization changes[End]

    LOFORMSET.LATKTTYPE[lnTktNo,2]='D'
    *N000682,1 11/20/2012 MMT Globlization changes[Start]
*LOFORMSET.LATKTTYPE[lnTktNo,3]=LANG_APPYINV_DYE_NO
LOFORMSET.LATKTTYPE[lnTktNo,3]=IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_DYE_NO,loFormSet.GetHeaderText("LANG_APPYINV_DYE_NO",loFormSet.HeaderAlias))
*N000682,1 11/20/2012 MMT Globlization changes[End]

    *N000682,1 MMT 11/22/2012 Globalization changes[END]
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  ENDIF

ENDIF
*If Material Module is Installed
IF 'MA' $ OARIAAPPLICATION.COMPANYINSTALLEDMODULES AND ;
    ('L' $ LOFORMSET.LCVENINVTYPES OR 'T' $ LOFORMSET.LCVENINVTYPES OR 'F' $ LOFORMSET.LCVENINVTYPES)
  =LFOPENFILE('Fabric','Style',LOFORMSET) &&Sql Check Tag CINVTYPE+STYLE (FABRIC+COLOR)
  =IIF(LOFORMSET.LASETUPS[2,2]='Y',LFOPENFILE('FabDye','StyDye',LOFORMSET),.T.) &&Sql Check Tag ;
  *CINVTYPE+STYLE+CWARECODE+DYELOT (FABRIC+COLOR+CWARECODE+DYELOT)
  =LFOPENFILE('POFHDR','POSHDR',LOFORMSET) &&Sql63: Check Tag CBUSDOCU+CSTYTYPE+PO (CMATTYPE+POMAT)
  =LFOPENFILE('POFLN','POSLN',LOFORMSET) &&Sql64: Check Tag ;
  *CBUSDOCU+CSTYTYPE+PO+CINVTYPE+STYLE+STR(LINENO,6)+TRANCD ;
  (CMATTYPE+POMAT+FABRIC+COLOR+TRANCD)
  =LFOPENFILE('MFGOPRDT','MFGOPRDT',LOFORMSET)&&Sql64: Check Tag ;
  *CIMTYP+CTKTNO+COPRCODE+CLOTNO+TRANCD (CIMTYP+CTKTNO+COPRCODE+CLOTNO+TRANCD)
  IF 'L' $ LOFORMSET.LCVENINVTYPES
    *Adjust Ticket Types Popup
    LNTKTNO = LNTKTNO + 1
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *!*	    DIMENSION loForm.laTktType[lnTktNo,3]
    *!*	    loForm.laTktType[lnTktNo,1]='Material PO'
    *!*	    loForm.laTktType[lnTktNo,2]='L'
    *!*	    loForm.laTktType[lnTktNo,3]='Material PO#'
    DIMENSION LOFORMSET.LATKTTYPE[lnTktNo,3]
    *N000682,1 MMT 11/22/2012 Globalization changes[Start]
    *LOFORMSET.LATKTTYPE[lnTktNo,1]='Material PO'
    *LOFORMSET.LATKTTYPE[lnTktNo,2]='L'
    *LOFORMSET.LATKTTYPE[lnTktNo,3]='Material PO#'
    *N000682,1 11/20/2012 MMT Globlization changes[Start]
*LOFORMSET.LATKTTYPE[lnTktNo,1]=LANG_APPYINV_MAPO
LOFORMSET.LATKTTYPE[lnTktNo,1]=IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_MAPO,loFormSet.GetHeaderText("LANG_APPYINV_MAPO",loFormSet.HeaderAlias))
*N000682,1 11/20/2012 MMT Globlization changes[End]

    LOFORMSET.LATKTTYPE[lnTktNo,2]='L'
    *N000682,1 11/20/2012 MMT Globlization changes[Start]
*LOFORMSET.LATKTTYPE[lnTktNo,3]=LANG_APPYINV_MAPO_NO
LOFORMSET.LATKTTYPE[lnTktNo,3]=IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_MAPO_NO,loFormSet.GetHeaderText("LANG_APPYINV_MAPO_NO",loFormSet.HeaderAlias))
*N000682,1 11/20/2012 MMT Globlization changes[End]

    *N000682,1 MMT 11/22/2012 Globalization changes[END]
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[END]
  ENDIF
  IF 'F' $ LOFORMSET.LCVENINVTYPES
    *Adjust Ticket Types Popup
    LNTKTNO = LNTKTNO + 1
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *!*	    DIMENSION loForm.laTktType[lnTktNo,3]
    *!*	    loForm.laTktType[lnTktNo,1]='Material PO Return'
    *!*	    loForm.laTktType[lnTktNo,2]='F'
    *!*	    loForm.laTktType[lnTktNo,3]='Material PO Return#'
    DIMENSION LOFORMSET.LATKTTYPE[lnTktNo,3]
    *N000682,1 MMT 11/22/2012 Globalization changes[Start]
    *LOFORMSET.LATKTTYPE[lnTktNo,1]='Material PO Return'
    *LOFORMSET.LATKTTYPE[lnTktNo,2]='F'
    *LOFORMSET.LATKTTYPE[lnTktNo,3]='Material PO Return#'
    *N000682,1 11/20/2012 MMT Globlization changes[Start]
*LOFORMSET.LATKTTYPE[lnTktNo,1]=LANG_APPYINV_MAPO_RETURN
LOFORMSET.LATKTTYPE[lnTktNo,1]=IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_MAPO_RETURN,loFormSet.GetHeaderText("LANG_APPYINV_MAPO_RETURN",loFormSet.HeaderAlias))
*N000682,1 11/20/2012 MMT Globlization changes[End]

    LOFORMSET.LATKTTYPE[lnTktNo,2]='F'
    *N000682,1 11/20/2012 MMT Globlization changes[Start]
*LOFORMSET.LATKTTYPE[lnTktNo,3]=LANG_APPYINV_MAPO_RETURNNO
LOFORMSET.LATKTTYPE[lnTktNo,3]=IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_MAPO_RETURNNO,loFormSet.GetHeaderText("LANG_APPYINV_MAPO_RETURNNO",loFormSet.HeaderAlias))
*N000682,1 11/20/2012 MMT Globlization changes[End]

    *N000682,1 MMT 11/22/2012 Globalization changes[END]
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  ENDIF
  *Only when invoicing with base currency
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *  IF 'T' $ loFormSet.lcVenInvTypes AND ;
  *loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value = oAriaApplication.BaseCurrency

  *! B610120,1 HIA 17/10/2012 T20121005.0001 - Aria4xp - AP - Error message applying invoice to Material Manufacturing order [Begin]
  *IF 'T' $ LOFORMSET.LCVENINVTYPES AND ;
  *    LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.KEYTEXTBOX.VALUE = OARIAAPPLICATION.BASECURRENCY
  IF 'T' $ loFormSet.lcVENINVTYPES
    *! B610120,1 HIA 17/10/2012 T20121005.0001 - Aria4xp - AP - Error message applying invoice to Material Manufacturing order [End]

    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    =LFOPENFILE('MMFGORDH','POSHDR',LOFORMSET) &&Sql65: Check Tag CBUSDOCU+CSTYTYPE+PO (CMFGORDNO)
    =LFOPENFILE('MMFGORDD','POSLN',LOFORMSET) &&Sql66: Check Tag ;
    *CBUSDOCU+CSTYTYPE+PO+CINVTYPE+STYLE+STR(LINENO,6)+TRANCD ;
    (CMFGORDNO+CFABRIC+COLOR+DYELOT+TRANCD)
    LNTKTNO = LNTKTNO + 1
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *!*	    DIMENSION loForm.laTktType[lnTktNo,3]
    *!*	    loForm.laTktType[lnTktNo,1]='Material MFG Order'
    *!*	    loForm.laTktType[lnTktNo,2]='T'
    *!*	    loForm.laTktType[lnTktNo,3]='Order#'
    DIMENSION LOFORMSET.LATKTTYPE[lnTktNo,3]
    *N000682,1 MMT 11/22/2012 Globalization changes[Start]
    *LOFORMSET.LATKTTYPE[lnTktNo,1]='Material MFG Order'
    *LOFORMSET.LATKTTYPE[lnTktNo,2]='T'
    *LOFORMSET.LATKTTYPE[lnTktNo,3]='Order#'
    *N000682,1 11/20/2012 MMT Globlization changes[Start]
*LOFORMSET.LATKTTYPE[lnTktNo,1]=LANG_APPYINV_MAMFGORDER
LOFORMSET.LATKTTYPE[lnTktNo,1]=IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_MAMFGORDER,loFormSet.GetHeaderText("LANG_APPYINV_MAMFGORDER",loFormSet.HeaderAlias))
*N000682,1 11/20/2012 MMT Globlization changes[End]

    LOFORMSET.LATKTTYPE[lnTktNo,2]='T'
    *N000682,1 11/20/2012 MMT Globlization changes[Start]
*LOFORMSET.LATKTTYPE[lnTktNo,3]=LANG_APPYINV_MAMFGORDERNO
LOFORMSET.LATKTTYPE[lnTktNo,3]=IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_MAMFGORDERNO,loFormSet.GetHeaderText("LANG_APPYINV_MAMFGORDERNO",loFormSet.HeaderAlias))
*N000682,1 11/20/2012 MMT Globlization changes[End]

    *N000682,1 MMT 11/22/2012 Globalization changes[eND]
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  ENDIF
ENDIF

*Restore Screen Defaults
STORE .T. TO LLDEFQTYDT, LLDEFAUAPR, LLDEFEDAPR
LCRESDIR = ADDBS(ALLTRIM(OARIAAPPLICATION.RESOURCEHOME)+ALLTRIM(OARIAAPPLICATION.USER_ID))
IF FILE(LCRESDIR+"APVINVDT.MEM")
  RESTORE ADDITIVE FROM (LCRESDIR+"APVINVDT.MEM")
ENDIF
LOFORM.LLDEFQTYDT = LLDEFQTYDT
LOFORM.LLDEFAUAPR = LLDEFAUAPR
LOFORM.LLDEFEDAPR = LLDEFEDAPR
*STORE '' TO lcFabric,lcFabClr,lcFabDye,lcFabDesc,lcStyle,lcStyDye,lcStyDesc
*Q2: Is This Correct Replacment for the Previous Line ?
STORE '' TO LOFORM.CNTITEM.VALUE, LOFORM.KBDYELOT.KEYTEXTBOX.VALUE, LOFORM.TXTSTYDESC.VALUE

IF LOFORMSET.ACTIVEMODE="V"

  SELECT 'APVINVDT'
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *SET ORDER TO TAG Orgvinv
  GFSETORDER('Orgvinv')
  =GFSEEK(PADR(LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE,8)+ ;
    PADR(LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE,12))
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  *!*    lcFilt = KEY()+"='"+PADR(loFormSet.AriaForm1.KBVendCode.KeyTextBox.Value,8)+;
  *!*             PADR(loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value,12)+"'"
  *!*    SET FILTER TO &lcFilt
  SELECT * FROM APVINVDT WHERE CVENDCODE+CAPINVNO+CAPVILNO = ;
    PADR(LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE,8)+ ;
    PADR(LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE,12) ;
    ORDER BY CVENDCODE, CAPINVNO, CAPVILNO INTO CURSOR APVINVDT2
  SELECT APVINVDT2
  INDEX ON CVENDCODE+CAPINVNO+CAPVILNO TAG ORGVINV
ELSE
  SELECT (LOFORMSET.LCAPVINVDT)
  SET ORDER TO TAG (LOFORMSET.LCAPVINVDT)
ENDIF
=SEEK(PADR(LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE,8)+PADR(LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE,12))
SUM REST IIF(CIMTYP $ 'RF' AND LOFORMSET.ACTIVEMODE="V",-ROUND(NAPAMNT,2),ROUND(NAPAMNT,2)),;
  IIF(CIMTYP $ 'RF' AND LOFORMSET.ACTIVEMODE="V",-ROUND(NAPAPRAMNT,2),ROUND(NAPAPRAMNT,2)) TO LOFORMSET.LNTINVAMT,LOFORMSET.LNTAPRAMT ;
  WHILE CVENDCODE+CAPINVNO+CAPVILNO = PADR(LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE,8)+PADR(LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE,12)

=SEEK(PADR(LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE,8)+PADR(LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE,12))
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*SCATTER NAME loForm.loRec
SCATTER NAME LOFORMSET.LOREC
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[END]

LOFORM.LCAUTOMODE= IIF(LOFORMSET.ACTIVEMODE="V" OR LOFORMSET.LCVENINVTYPES=='G','DISABLE','ENABLE')
LOFORM.LCSCRMODE = IIF(LOFORMSET.ACTIVEMODE="V",'DISABLE','ENABLE')
LOFORM.LCDETMODE = IIF(LOFORMSET.ACTIVEMODE="V" OR EOF(),'DISABLE','ENABLE')
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*!*	loForm.lcInvQTot = IIF(loFormSet.ActiveMode="V" OR EOF() OR (loForm.llDefQtyDt AND INLIST(loForm.loRec.cIMTyp,'I','S','M','R','A','D')),'DISABLE','ENABLE')
*!*	loForm.lcInvQDet = IIF(loFormSet.ActiveMode="V" OR EOF() OR !INLIST(loForm.loRec.cIMTyp,'I','S','M','R','A','D') OR !loForm.llDefQtyDt,'DISABLE','ENABLE')
*!*	loForm.lcAprQDet = IIF(loFormSet.ActiveMode="V" OR EOF() OR !INLIST(loForm.loRec.cIMTyp,'I','S','M','R','A','D') OR !loForm.llDefQtyDt OR !loForm.llDefEdApr,'DISABLE','ENABLE')
*!*	loForm.lcAprQty  = IIF(loFormSet.ActiveMode="V" OR EOF() OR !loForm.llDefEdApr OR (loForm.llDefQtyDt AND INLIST(loForm.loRec.cIMTyp,'I','S','M','R','A','D')),'DISABLE','ENABLE')
LOFORM.LCINVQTOT = IIF(LOFORMSET.ACTIVEMODE="V" OR EOF() OR (LOFORM.LLDEFQTYDT AND INLIST(LOFORMSET.LOREC.CIMTYP,'I','S','M','R','A','D')),'DISABLE','ENABLE')
LOFORM.LCINVQDET = IIF(LOFORMSET.ACTIVEMODE="V" OR EOF() OR !INLIST(LOFORMSET.LOREC.CIMTYP,'I','S','M','R','A','D') OR !LOFORM.LLDEFQTYDT,'DISABLE','ENABLE')
LOFORM.LCAPRQDET = IIF(LOFORMSET.ACTIVEMODE="V" OR EOF() OR !INLIST(LOFORMSET.LOREC.CIMTYP,'I','S','M','R','A','D') OR !LOFORM.LLDEFQTYDT OR !LOFORM.LLDEFEDAPR,'DISABLE','ENABLE')
LOFORM.LCAPRQTY  = IIF(LOFORMSET.ACTIVEMODE="V" OR EOF() OR !LOFORM.LLDEFEDAPR OR (LOFORM.LLDEFQTYDT AND INLIST(LOFORMSET.LOREC.CIMTYP,'I','S','M','R','A','D')),'DISABLE','ENABLE')
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
LOFORM.LCAPRPRI  = IIF(LOFORMSET.ACTIVEMODE="V" OR EOF() OR !LOFORM.LLDEFEDAPR,'DISABLE','ENABLE')
LOFORM.LCWIPSTAT = IIF(LOFORMSET.ACTIVEMODE="V" OR EOF(),'DISABLE','ENABLE')

*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*loForm.lblGlAct.Caption= IIF(loForm.loRec.cIMTyp='G','GL Account','WIP Account')
*IF lnTktNo = 0
*N000682,1 MMT 11/22/2012 Globalization changes[Start]
*LOFORM.LBLGLACT.CAPTION= IIF(LOFORMSET.LOREC.CIMTYP='G','GL Account','WIP Account')
*N000682,1 11/20/2012 MMT Globlization changes[Start]
*LOFORM.LBLGLACT.CAPTION= IIF(LOFORMSET.LOREC.CIMTYP='G',LANG_APPYINV_GL_ACCOUNT,LANG_APPYINV_WIP_ACCOUNT)
LOFORM.LBLGLACT.CAPTION= IIF(LOFORMSET.LOREC.CIMTYP='G',IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_GL_ACCOUNT,loFormSet.GetHeaderText("LANG_APPYINV_GL_ACCOUNT",loFormSet.HeaderAlias)),IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_WIP_ACCOUNT,loFormSet.GetHeaderText("LANG_APPYINV_WIP_ACCOUNT",loFormSet.HeaderAlias)))
*N000682,1 11/20/2012 MMT Globlization changes[End]

*N000682,1 MMT 11/22/2012 Globalization changes[END]
IF LNTKTNO = 0
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  *Message : 04182
  *Vendor  has no access to use Detailed Invoices.
  *You may only use Distribution Lines option instead.
  *Button : 00000
  *Ok*
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	    =gfModalGen("TRM04182B00000","DIALOG",loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE)
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  *Old: SHOW GET pbAPVInvDt DISABLE &&Revise
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *loFormSet.AriaForm1.cmdInvLines.Enabled = .F.
  LOFORMSET.ARIAFORM1.PGFPAYINV.PGDET.ENABLED = .F.
  LOFORMSET.ARIAFORM1.PGFPAYINV.ACTIVEPAGE = 1
  LOFORMSET.LLSHOWMSG = .T.
  RETURN .F.
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  LOFORMSET.LCVENINVTYPES =''
ELSE
  *! B609956,1 HIA 06/10/2012 Can not add detail lines, to invoice [T20120515.0013][Begin]
  LOFORMSET.ARIAFORM1.PGFPAYINV.PGDET.ENABLED = .T.
  *! B609956,1 HIA 06/10/2012 Can not add detail lines, to invoice [T20120515.0013][End]
  *ASM, Hide Tax Code Accoring To Vendor
  STORE (APVENDOR.CTAXTYPE <> 'T') TO LOFORM.LBLTAXCODE.VISIBLE, LOFORM.LBLTAXCOLON.VISIBLE, ;
    LOFORM.CBOTAXCODE.VISIBLE
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  LOFORMSET.LLITEMPOS = .T.
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  *ASM, Reposition the cntItem and txtItem controls
  LOFORM.CNTITEM.TOP = LOFORM.CNTSTYLE.TOP
  LOFORM.CNTITEM.LEFT = LOFORM.CNTSTYLE.LEFT

  WITH LOFORM.GRDINVDTLINES
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    .RECORDSOURCE = ''
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[ENd]
    .COLUMNCOUNT = 0
    .RECORDSOURCE = IIF(LOFORMSET.ACTIVEMODE="V",'APVINVDT2',LOFORMSET.LCAPVINVDT)
    .COLUMNCOUNT = 7

    .COLUMN1.WIDTH = 110
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *.column1.ControlSource = "IIF(EMPTY(cBomType),'',lfCostDesc(ThisFormSet.CallingForm.Parent))"
    .COLUMN1.CONTROLSOURCE = "IIF(EMPTY(cBomType),'',lfCostDesc(ThisFormSet))"
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    *N000682,1 MMT 11/20/2012 Globalization Changes[Start]
    *    .COLUMN1.HEADER1.CAPTION = 'Cost Type'
    *N000682,1 11/20/2012 MMT Globlization changes[Start]
*.COLUMN1.HEADER1.CAPTION =LANG_APPYINV_COST_TYPE
.COLUMN1.HEADER1.CAPTION =IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_COST_TYPE,loFormSet.GetHeaderText("LANG_APPYINV_COST_TYPE",loFormSet.HeaderAlias))
*N000682,1 11/20/2012 MMT Globlization changes[End]

    *N000682,1 11/20/2012 MMT Globlization changes[End]


    .COLUMN2.WIDTH = 90
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *.column2.ControlSource = "IIF(CIMTYP $ 'RF' AND ThisFormSet.CallingForm.Parent.ActiveMode='V' ,-nApTotQty,nApTotQty)"
    .COLUMN2.CONTROLSOURCE = "IIF(CIMTYP $ 'RF' AND ThisFormSet.ActiveMode='V' ,-nApTotQty,nApTotQty)"
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    *N000682,1 MMT 11/20/2012 Globalization Changes[Start]
    *    .COLUMN2.HEADER1.CAPTION = 'Inv. Qty.'
    *N000682,1 11/20/2012 MMT Globlization changes[Start]
*.COLUMN2.HEADER1.CAPTION = LANG_APPYINV_INV_QTY
.COLUMN2.HEADER1.CAPTION = IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_INV_QTY,loFormSet.GetHeaderText("LANG_APPYINV_INV_QTY",loFormSet.HeaderAlias))
*N000682,1 11/20/2012 MMT Globlization changes[End]

    *N000682,1 11/20/2012 MMT Globlization changes[End]


    .COLUMN3.WIDTH = 90
    .COLUMN3.CONTROLSOURCE = "nApPrice"
     *N000682,1 MMT 11/20/2012 Globalization Changes[Start]
     *    .COLUMN3.HEADER1.CAPTION = 'Inv. Price'
    *N000682,1 11/20/2012 MMT Globlization changes[Start]
*.COLUMN3.HEADER1.CAPTION =LANG_APPYINV_INV_PRICE
.COLUMN3.HEADER1.CAPTION =IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_INV_PRICE,loFormSet.GetHeaderText("LANG_APPYINV_INV_PRICE",loFormSet.HeaderAlias))
*N000682,1 11/20/2012 MMT Globlization changes[End]

    *N000682,1 11/20/2012 MMT Globlization changes[End]


    .COLUMN4.WIDTH = 90
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *.column4.ControlSource = "ROUND(IIF(CIMTYP $ 'RF' AND ThisFormSet.CallingForm.Parent.ActiveMode='V',-nApAmnt,nApAmnt),2)"
    .COLUMN4.CONTROLSOURCE = "ROUND(IIF(CIMTYP $ 'RF' AND ThisFormSet.ActiveMode='V',-nApAmnt,nApAmnt),2)"
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    *N000682,1 MMT 11/20/2012 Globalization Changes[Start]
    *    .COLUMN4.HEADER1.CAPTION = 'Inv. Amount'
    *N000682,1 11/20/2012 MMT Globlization changes[Start]
*.COLUMN4.HEADER1.CAPTION =LANG_APPYINV_INV_AMOUNT
.COLUMN4.HEADER1.CAPTION =IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_INV_AMOUNT,loFormSet.GetHeaderText("LANG_APPYINV_INV_AMOUNT",loFormSet.HeaderAlias))
*N000682,1 11/20/2012 MMT Globlization changes[End]

    *N000682,1 11/20/2012 MMT Globlization changes[End]


    .COLUMN5.WIDTH = 90
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *.column5.ControlSource = "IIF(CIMTYP $ 'RF' AND ThisFormSet.CallingForm.Parent.ActiveMode='V',-nApTAprQty,nApTAprQty)"
    .COLUMN5.CONTROLSOURCE = "IIF(CIMTYP $ 'RF' AND ThisFormSet.ActiveMode='V',-nApTAprQty,nApTAprQty)"
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    *N000682,1 MMT 11/20/2012 Globalization Changes[Start]
    *    .COLUMN5.HEADER1.CAPTION = 'Appr. Qty.'
    *N000682,1 11/20/2012 MMT Globlization changes[Start]
*.COLUMN5.HEADER1.CAPTION =LANG_APPYINV_APPR_QTY
.COLUMN5.HEADER1.CAPTION =IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_APPR_QTY,loFormSet.GetHeaderText("LANG_APPYINV_APPR_QTY",loFormSet.HeaderAlias))
*N000682,1 11/20/2012 MMT Globlization changes[End]

    *N000682,1 11/20/2012 MMT Globlization changes[End]


    .COLUMN6.WIDTH = 90
    .COLUMN6.CONTROLSOURCE = "nApAprPric"
    *N000682,1 MMT 11/20/2012 Globalization Changes[Start]
    *    .COLUMN6.HEADER1.CAPTION = 'Appr. Price'
    *N000682,1 11/20/2012 MMT Globlization changes[Start]
*.COLUMN6.HEADER1.CAPTION =LANG_APPYINV_APPR_PRICE
.COLUMN6.HEADER1.CAPTION =IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_APPR_PRICE,loFormSet.GetHeaderText("LANG_APPYINV_APPR_PRICE",loFormSet.HeaderAlias))
*N000682,1 11/20/2012 MMT Globlization changes[End]

    *N000682,1 11/20/2012 MMT Globlization changes[End]


    .COLUMN7.WIDTH = 90
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *.column7.ControlSource = "ROUND(IIF(CIMTYP $ 'RF' AND ThisFormSet.CallingForm.Parent.ActiveMode='V',-nApAprAmnt,nApAprAmnt),2)"
    .COLUMN7.CONTROLSOURCE = "ROUND(IIF(CIMTYP $ 'RF' AND ThisFormSet.ActiveMode='V',-nApAprAmnt,nApAprAmnt),2)"
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    *N000682,1 11/20/2012 MMT Globlization changes[Start]
    *    .COLUMN7.HEADER1.CAPTION = 'Appr. Amount'
    *N000682,1 11/20/2012 MMT Globlization changes[Start]
*.COLUMN7.HEADER1.CAPTION =LANG_APPYINV_APPR_AMOUNT
.COLUMN7.HEADER1.CAPTION =IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_APPR_AMOUNT,loFormSet.GetHeaderText("LANG_APPYINV_APPR_AMOUNT",loFormSet.HeaderAlias))
*N000682,1 11/20/2012 MMT Globlization changes[End]

    *N000682,1 11/20/2012 MMT Globlization changes[End]


  ENDWITH

ENDIF
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
LOFORM.GRDINVDTLINES.REFRESH
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[ENd]

RETURN LNTKTNO > 0
*-- End of lfInvDtInit

*!*************************************************************
*! Name      : lfCostDesc
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 8/30/2004
*! Purpose   : Get Cost Type Description
*!*************************************************************
*!Parameters :  The FormSet of APPYINV.SCX
*!*************************************************************
*! Returns            :  Cost Type Description
*!*************************************************************
FUNCTION LFCOSTDESC
LPARAMETERS LOFORMSET
LOCAL LCARYNAME

LCARYNAME = 'loFormSet.la'+IIF(INLIST(CIMTYP,'S','R'),'I',IIF(CIMTYP='F','L',IIF(CIMTYP='D','M',CIMTYP)))+'CSTTYPE'
RETURN EVAL(LCARYNAME+"[ASUBSCRIPT("+LCARYNAME+",ASCAN("+LCARYNAME+",cBomType),1),1]")
*-- End of lfCostDesc

*!*************************************************************
*! Name      : lfInvDtDestroty
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 8/30/2004
*! Purpose   : Called from the Destroy Event of the APINVDT Screen.
*!*************************************************************
*! Parameters: The FormSet of APPYINV.SCX, The Form of APINVDT.SCX
*!*************************************************************
*! Returns   : None
*!*************************************************************
FUNCTION LFINVDTDESTROTY
LPARAMETERS LOFORMSET, LOFORM

*Rebuild the TmpDist file in case there is Shipmnet [Start]
IF LOFORMSET.ACTIVEMODE="E" OR LOFORMSET.ACTIVEMODE="A"
  =LFUPDDIST(LOFORMSET, LOFORM)
ENDIF
*Rebuild the TmpDist file in case there is Shipmnet [END]

*Save Screen Defaults
LLDEFQTYDT = LOFORM.LLDEFQTYDT
LLDEFAUAPR = LOFORM.LLDEFAUAPR
LLDEFEDAPR = LOFORM.LLDEFEDAPR

LCRESDIR = ADDBS(ALLTRIM(OARIAAPPLICATION.RESOURCEHOME)+ALLTRIM(OARIAAPPLICATION.USER_ID))
SAVE ALL LIKE LLDEF* TO (LCRESDIR+"APVINVDT.MEM")
SELECT STYLE
*ASM, no need to set relation into Scale because we will use it with the material
*SET RELATION OFF INTO Scale
*Restore Previous Options Menu Pad.
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*=loFormSet.mOptionMenu()
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
*Old: SELECT CODES
*Old: SET FILTER TO &loFormSet.lcCodeFilt
SELECT (LOFORM.LNALIAS)

RETURN
*-- End of lfInvDtDestroty


*!*************************************************************
*! Name      : lfgrdInvDtAfterRowCol
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 8/30/2004
*! Purpose   : Called from the AfterRowCol Event of the Grid in the APINVDT Screen.
*!*************************************************************
*! Parameters: The FormSet of APPYINV.SCX, The Form of APINVDT.SCX
*!*************************************************************
*! Returns   : None
*!*************************************************************
FUNCTION LFGRDINVDTAFTERROWCOL
LPARAMETERS LOFORMSET, LOFORM

IF LOFORMSET.ACTIVEMODE="E" AND !EMPTY(EVALUATE(LOFORMSET.LCAPVINVDT+'.CTKTNO'))
  LOFORMSET.LLCLOSED = LFVCHECK(LOFORMSET,LOFORM)
ENDIF
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*=SEEK(cVendCode+cApInvNo+cAPVILNo,IIF(loFormSet.ActiveMode="V",'APDIST',loFormSet.lcTmpDist))
SELECT(IIF(LOFORMSET.ACTIVEMODE="V",'APVINVDT2',LOFORMSET.LCAPVINVDT))
IF LOFORMSET.ACTIVEMODE="V"
  =GFSEEK(CVENDCODE+CAPINVNO+CAPVILNO,'APDIST')
ELSE
  =SEEK(CVENDCODE+CAPINVNO+CAPVILNO,LOFORMSET.LCTMPDIST)
ENDIF
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[END]
LCEXSTAT=SET('EXACT')
SET EXACT ON

*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*loForm.cboTktType.Value = IIF(EMPTY(cIMTyp),1,ASUBSCRIPT(loForm.laTktType,ASCAN(loForm.laTktType,cImTyp),1))
LOFORM.CBOTKTTYPE.VALUE = IIF(EMPTY(CIMTYP),1,ASUBSCRIPT(LOFORMSET.LATKTTYPE,ASCAN(LOFORMSET.LATKTTYPE,CIMTYP),1))
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

SET EXACT &LCEXSTAT
*Old: lnMarker = RECNO()
*Old:IF loFormSet.llZoomInvD
*SHOW WINDOW (lcInvZoom) REFRESH SAME
*Old:ELSE
*Old:SCATTER MEMVAR
*Old:  =lfShowWind()
*SHOW WINDOW (lcInvDtBr) REFRESH
*Old:ENDIF
IF EOF()
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *SCATTER NAME loForm.loRec BLANK
  SCATTER NAME LOFORMSET.LOREC BLANK
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[END]
  STORE 0 TO LOFORMSET.LNTAPRAMT, LOFORMSET.LNTINVAMT
ELSE
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *SCATTER NAME loForm.loRec
  SCATTER NAME LOFORMSET.LOREC
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
ENDIF
=LFSHOWWIND(LOFORMSET,LOFORM)
LOFORM.REFRESH()

RETURN
*-- End of lfgrdInvDtAfterRowCol


*:*************************************************************
*: Name      : lfvCheck
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 8/30/2004
*: Purpose   : Disable the Invoice detail screen for closed PO
*!*************************************************************
*! Parameters: The FormSet of APPYINV.SCX, The Form of APINVDT.SCX
*:*************************************************************
*: Returns            : llClosed
*!*************************************************************
FUNCTION LFVCHECK
LPARAMETERS LOFORMSET, LOFORM


S=SECONDS()

LCTEMP = LOFORMSET.LCAPVINVDT

LNOLDALS = SELECT(0)
DO CASE
  *-- Style PO and Style Return PO
CASE INLIST(&LCTEMP..CIMTYP,'I','R')
  =LOFORMSET.POSHDR.SEEK(IIF(&LCTEMP..CIMTYP='I','PP','RP')+&LCTEMP..CTKTNO) &&Sql67: Check Key
  LOFORMSET.LLCLOSED = (POSHDR.STATUS = 'S')

  *-- Shipment
CASE INLIST(&LCTEMP..CIMTYP,'S')
  =LOFORMSET.POSHDR.SEEK('PP'+&LCTEMP..CTKTNO) &&Sql68: Check Key
  LOFORMSET.LLCLOSED = (POSHDR.STATUS = 'S')

  *-- Material PO and Return Material PO
CASE INLIST(&LCTEMP..CIMTYP,'L','F')
  =LOFORMSET.POFHDR.SEEK(IIF(&LCTEMP..CIMTYP='L','PM','RM')+&LCTEMP..CTKTNO) &&Sql69: Check Key
  LOFORMSET.LLCLOSED = (POFHDR.STATUS = 'L')

  *-- Cutting Ticket
CASE INLIST(&LCTEMP..CIMTYP,'M')
  =LOFORMSET.CUTTKTH.SEEK('PU'+&LCTEMP..CTKTNO) &&Sql70: Check Key
  LOFORMSET.LLCLOSED = (CUTTKTH.STATUS = 'S')
  *-- Material MFG
CASE INLIST(&LCTEMP..CIMTYP,'T')
  =LOFORMSET.MMFGORDH.SEEK('PF'+&LCTEMP..CTKTNO) &&Sql71: Check Key
  LOFORMSET.LLCLOSED = (MMFGORDH.STATUS = 'S')
ENDCASE

LOFORM.LCAUTOMODE= IIF(LOFORMSET.LLCLOSED,'DISABLE','ENABLE')
LOFORM.LCSCRMODE = IIF(LOFORMSET.LLCLOSED,'DISABLE','ENABLE')
LOFORM.LCDETMODE = IIF(LOFORMSET.LLCLOSED,'DISABLE','ENABLE')
LOFORM.LCINVQTOT = IIF(LOFORMSET.LLCLOSED,'DISABLE','ENABLE')
LOFORM.LCINVQDET = IIF(LOFORMSET.LLCLOSED,'DISABLE','ENABLE')
LOFORM.LCAPRQDET = IIF(LOFORMSET.LLCLOSED,'DISABLE','ENABLE')
LOFORM.LCAPRQTY  = IIF(LOFORMSET.LLCLOSED,'DISABLE','ENABLE')
LOFORM.LCAPRPRI  = IIF(LOFORMSET.LLCLOSED,'DISABLE','ENABLE')
LOFORM.LCWIPSTAT = IIF(LOFORMSET.LLCLOSED,'DISABLE','ENABLE')

SELECT (LNOLDALS)

RETURN LOFORMSET.LLCLOSED
*-- End of lfvCheck

*!*************************************************************
*! Name      : lfShowWind
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 8/30/2004
*! Purpose   : Refresh Controls of the APINVDT Screen.
*!*************************************************************
*! Parameters: The FormSet of APPYINV.SCX, The Form of APINVDT.SCX
*!*************************************************************
*! Returns   : None
*!*************************************************************
FUNCTION LFSHOWWIND
*N000682,1 MMT 12/09/2012 Globalization changes[Start]
*LPARAMETERS LOFORMSET, LOFORM
PARAMETERS LOFORMSET, LOFORM
*N000682,1 MMT 12/09/2012 Globalization changes[End]
SELECT (IIF(LOFORMSET.ACTIVEMODE="V",'APVINVDT2',LOFORMSET.LCAPVINVDT))

LOFORM.LCDETMODE = IIF(LOFORMSET.ACTIVEMODE="V" OR EOF() OR LOFORMSET.LLCLOSED,'DISABLE','ENABLE')

LOFORM.LCINVQTOT = IIF(LOFORMSET.ACTIVEMODE="V" OR EOF() OR LOFORMSET.LLCLOSED OR (LOFORM.LLDEFQTYDT AND INLIST(CIMTYP,'I','S','M','R','A','D') AND !EMPTY(ITEM)),'DISABLE','ENABLE')
*loForm.lcInvQDet = IIF(loFormSet.ActiveMode="V" OR EOF() OR loFormSet.llClosed OR !INLIST(cIMTyp,'I','S','M','R','A','D') OR !loForm.llDefQtyDt,'DISABLE','ENABLE')
*loForm.lcAprQDet = IIF(loFormSet.ActiveMode="V" OR EOF() OR loFormSet.llClosed OR !INLIST(cIMTyp,'I','S','M','R','A','D') OR !loForm.llDefQtyDt OR !loForm.llDefEdApr,'DISABLE','ENABLE')
LOFORM.LCINVQDET = IIF(LOFORMSET.ACTIVEMODE="V" OR EOF() OR LOFORMSET.LLCLOSED OR !INLIST(CIMTYP,'I','S','M','R','A','D','T','L','F') OR !LOFORM.LLDEFQTYDT,'DISABLE','ENABLE')
LOFORM.LCAPRQDET = IIF(LOFORMSET.ACTIVEMODE="V" OR EOF() OR LOFORMSET.LLCLOSED OR !INLIST(CIMTYP,'I','S','M','R','A','D','T','L','F') OR !LOFORM.LLDEFQTYDT OR !LOFORM.LLDEFEDAPR,'DISABLE','ENABLE')
LOFORM.LCAPRQTY  = IIF(LOFORMSET.ACTIVEMODE="V" OR EOF() OR !LOFORM.LLDEFEDAPR OR LOFORMSET.LLCLOSED OR (LOFORM.LLDEFQTYDT AND INLIST(CIMTYP,'I','S','M','R','A','D')  AND !EMPTY(ITEM)),'DISABLE','ENABLE')

LOFORM.LCAPRPRI  = IIF(LOFORMSET.ACTIVEMODE="V" OR EOF() OR !LOFORM.LLDEFEDAPR OR LOFORMSET.LLCLOSED,'DISABLE','ENABLE')
LOFORM.LCWIPSTAT = IIF(LOFORMSET.ACTIVEMODE="V" OR EOF() OR LOFORMSET.LLCLOSED,'DISABLE','ENABLE')


*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*loForm.lblGlAct.Caption= IIF(loForm.loRec.cIMTyp='G','GL Account','WIP Account')
*!*	IF loFormSet.llZoomInvD
*!*	  loForm.grdInvDtLines.Height = loForm.cnt12.Top - (loForm.grdInvDtLines.Top+5)
*!*	ELSE
*!*	  loForm.grdInvDtLines.Height = loForm.cnt13.Top - (loForm.grdInvDtLines.Top+5)
*!*	ENDIF
*N000682,1 MMT 11/22/2012 Globalization changes[Start]
*LOFORM.LBLGLACT.CAPTION= IIF(LOFORMSET.LOREC.CIMTYP='G','GL Account','WIP Account')
*N000682,1 11/20/2012 MMT Globlization changes[Start]
*LOFORM.LBLGLACT.CAPTION= IIF(LOFORMSET.LOREC.CIMTYP='G',LANG_APPYINV_GL_ACCOUNT,LANG_APPYINV_WIP_ACCOUNT)
LOFORM.LBLGLACT.CAPTION= IIF(LOFORMSET.LOREC.CIMTYP='G',IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_GL_ACCOUNT,loFormSet.GetHeaderText("LANG_APPYINV_GL_ACCOUNT",loFormSet.HeaderAlias)),IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_WIP_ACCOUNT,loFormSet.GetHeaderText("LANG_APPYINV_WIP_ACCOUNT",loFormSet.HeaderAlias)))
*N000682,1 11/20/2012 MMT Globlization changes[End]

*N000682,1 MMT 11/22/2012 Globalization changes[End]
IF LOFORMSET.LLZOOMINVD
  LOFORM.GRDINVDTLINES.HEIGHT = LOFORM.CNT12.TOP +  LOFORM.CNT12.HEIGHT
  WITH LOFORM
    STORE .F. TO  .LBLAPREXRAT.VISIBLE,.LBLCOLON3.VISIBLE, .CBOTKTTYPE.VISIBLE, .ARIALABEL14.VISIBLE,;
      .ARIALABEL15.VISIBLE,.CBOCOSTTYPE.VISIBLE,.ARIALABEL12.VISIBLE,.ARIALABEL13.VISIBLE,;
      .CBOMFGOPR.VISIBLE,.LBLTKTTYPE.VISIBLE,.KBINVTKTNO.VISIBLE,.ARIALABEL11.VISIBLE,;
      .CBOLOTNO.VISIBLE,.TXTTINVAMT.VISIBLE,.ARIASHAPE1.VISIBLE,.CNT13.VISIBLE,;
      .CNT21.VISIBLE,.CNTSTYLE.VISIBLE,.LBLDYELOT.VISIBLE,.KBDYELOT.VISIBLE,;
      .ARIASHAPE2.VISIBLE,.CMDNEW.VISIBLE,.CMDAUTO.VISIBLE,.CMDREMOVE.VISIBLE,;
      .CMDCONTRIBUTE.VISIBLE,.CMDMULTIAPPROVE.VISIBLE,.TXTITEM.VISIBLE,.TXTSTYDESC.VISIBLE,;
      .LBLTAXCODE.VISIBLE,.LBLTAXCOLON.VISIBLE,.CBOTAXCODE.VISIBLE,.LBLGLACT.VISIBLE,;
      .ARIALABEL16.VISIBLE,.CNT11.VISIBLE,.GLAPDGLACT.VISIBLE,.TXTACTNAME.VISIBLE,.CNT22.VISIBLE,;
      .CNT12.VISIBLE,.ARIALABEL4.VISIBLE,.ARIALABEL5.VISIBLE,.ARIALABEL10.VISIBLE,.LBLREQ_QTY.VISIBLE,;
      .LBLUSED_QTY.VISIBLE,.LBL1.VISIBLE,.LBL2.VISIBLE,.TXTAPPRICE.VISIBLE,.TXTAPTOTQTY.VISIBLE,;
      .TXTAPTAPRQTY.VISIBLE,.TXTAPAMNT.VISIBLE,.TXTAPAPRAMNT.VISIBLE,.TXTAPAPRPRIC.VISIBLE,.CNTAP_QTY.VISIBLE,;
      .CNTAPAPR_QTY.VISIBLE,.LBLITEM.VISIBLE,.CNTITEM.VISIBLE,.TXTTAPRAMT.VISIBLE
  ENDWITH
ELSE
  LOFORM.GRDINVDTLINES.HEIGHT = LOFORM.CNT13.TOP -  5
  WITH LOFORM
    STORE .T. TO  .LBLAPREXRAT.VISIBLE,.LBLCOLON3.VISIBLE, .CBOTKTTYPE.VISIBLE, .ARIALABEL14.VISIBLE,;
      .ARIALABEL15.VISIBLE,.CBOCOSTTYPE.VISIBLE,.ARIALABEL12.VISIBLE,.ARIALABEL13.VISIBLE,;
      .CBOMFGOPR.VISIBLE,.LBLTKTTYPE.VISIBLE,.KBINVTKTNO.VISIBLE,.ARIALABEL11.VISIBLE,;
      .CBOLOTNO.VISIBLE,.TXTTINVAMT.VISIBLE,.ARIASHAPE1.VISIBLE,.CNT13.VISIBLE,;
      .CNT21.VISIBLE,.CNTSTYLE.VISIBLE,.LBLDYELOT.VISIBLE,.KBDYELOT.VISIBLE,;
      .ARIASHAPE2.VISIBLE,.CMDNEW.VISIBLE,.CMDAUTO.VISIBLE,.CMDREMOVE.VISIBLE,;
      .CMDCONTRIBUTE.VISIBLE,.CMDMULTIAPPROVE.VISIBLE,.TXTITEM.VISIBLE,.TXTSTYDESC.VISIBLE,;
      .LBLTAXCODE.VISIBLE,.LBLTAXCOLON.VISIBLE,.CBOTAXCODE.VISIBLE,.LBLGLACT.VISIBLE,;
      .ARIALABEL16.VISIBLE,.CNT11.VISIBLE,.GLAPDGLACT.VISIBLE,.TXTACTNAME.VISIBLE,.CNT22.VISIBLE,;
      .CNT12.VISIBLE,.ARIALABEL4.VISIBLE,.ARIALABEL5.VISIBLE,.ARIALABEL10.VISIBLE,.LBLREQ_QTY.VISIBLE,;
      .LBLUSED_QTY.VISIBLE,.LBL1.VISIBLE,.LBL2.VISIBLE,.TXTAPPRICE.VISIBLE,.TXTAPTOTQTY.VISIBLE,;
      .TXTAPTAPRQTY.VISIBLE,.TXTAPAMNT.VISIBLE,.TXTAPAPRAMNT.VISIBLE,.TXTAPAPRPRIC.VISIBLE,.CNTAP_QTY.VISIBLE,;
      .CNTAPAPR_QTY.VISIBLE,.LBLITEM.VISIBLE,.CNTITEM.VISIBLE,.TXTTAPRAMT.VISIBLE
  ENDWITH
ENDIF

*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
=LFGETCSTELE(LOFORMSET, LOFORM)
*Fix problem in AP Invoice lines that tax code applies to all lines [Begin]
*Q3: Should I use the aria combobox instead of ariacodes ?
DIMENSION LACODES[ALEN(loFormSet.laCodes,1),ALEN(loFormSet.laCodes,2)]
=ACOPY(LOFORMSET.LACODES,LACODES)
*! B608409,1 SSH 01/16/2008 Incorect Taxes in distribution line screen
*IF EMPTY(EVALUATE(loFormSet.lcAPVInvDt+'.CTAXCODE'))
LACODES[2,7] = IIF(LOFORMSET.ACTIVEMODE="V",'APVINVDT2',LOFORMSET.LCAPVINVDT)
LACODES[2,8] = IIF(LOFORMSET.ACTIVEMODE="V",'Orgvinv',LOFORMSET.LCAPVINVDT)
IF EMPTY(CTAXCODE)
  *! B608409,1 SSH 01/16/2008 Incorect Taxes in distribution line screen
  =GFWCODEPOP(@LACODES,'CTAXCODE','N')
ELSE
  =GFWCODEPOP(@LACODES,'CTAXCODE','T')
ENDIF
=ACOPY(LACODES,LOFORMSET.LACODES)

*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*IF loForm.loRec.cCostType = 'M'
IF LOFORMSET.LOREC.CCOSTTYPE = 'M'
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  *Display the cost title in Invoice line in edit and view mode [Begin]
  =GFWCODEPOP(@LACODES,'MFGCODE','T')
  =ACOPY(LACODES,LOFORMSET.LACODES)
  *Display the cost title in Invoice line in edit and view mode [End]
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *=lfRefLot(loForm.loRec.cLotNo,loForm)
  =LFREFLOT(LOFORMSET,LOFORMSET.LOREC.CLOTNO,LOFORM)
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[END]
ELSE
  *=gfwCodePop(@laCodes,'MFGCODE','N')
ENDIF
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*loForm.kbInvTktNo.KeyTextBox.Value = IIF(loForm.loRec.cIMTyp='S',loForm.loRec.ShipNo,loForm.loRec.cTktNo)
LOFORM.KBINVTKTNO.KEYTEXTBOX.VALUE = IIF(LOFORMSET.LOREC.CIMTYP='S',LOFORMSET.LOREC.SHIPNO,LOFORMSET.LOREC.CTKTNO)
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[END]
*Old: SHOW GETS WINDOW 'APINVD13' DISABLE ONLY &&Revise
=LFCNTSHOWGET(LOFORM,13,'Enabled',.F.)
*Old: SHOW GET ibInvDet     ENABLE &&Revise
*Old: SHOW GET m.nAPPrice   &loForm.lcDetMode &&Revise
LOFORM.TXTAPPRICE.ENABLED = (LOFORM.LCDETMODE='ENABLE')

*-- If the document type is Material PO, Material PO Return or Material
*-- MFG Order.
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*IF INLIST(loForm.loRec.cImTyp,'T','L','F')
IF INLIST(LOFORMSET.LOREC.CIMTYP,'T','L','F')
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

  *-- Disable the Get Field that has no decimal points.
  *Old: SHOW OBJECT OBJNUM(m.nAPTotQty) + 1 DISABLE
  *-- Use the Get Field that has decimal points.
  *Old: loFormSet.lnQtyObj = OBJNUM(m.nAPTotQty)
  *Old: SHOW OBJECT loFormSet.lnQtyObj &loForm.lcInvQTot
  LOFORM.TXTAPTOTQTY.INPUTMASK = "9999999.999"
  LOFORM.TXTAPTOTQTY.ENABLED = (LOFORM.LCINVQTOT='ENABLE')

ELSE    && Else (If the document type is anything but Material PO, Material PO Return and Material MFG Order.)

  *-- Disable the Get Field that has decimal points.
  *Old: SHOW OBJECT OBJNUM(m.nAPTotQty) DISABLE
  *-- Use the Get Field that has no decimal points.
  *Old: loFormSet.lnQtyObj = OBJNUM(m.nAPTotQty) + 1
  *Old: SHOW OBJECT loFormSet.lnQtyObj &loForm.lcInvQTot
  LOFORM.TXTAPTOTQTY.INPUTMASK = "9999999"
  LOFORM.TXTAPTOTQTY.ENABLED = (LOFORM.LCINVQTOT='ENABLE')

ENDIF

*Old: SHOW GET m.nApAmnt    &loForm.lcDetMode
LOFORM.TXTAPAMNT.ENABLED = (LOFORM.LCDETMODE='ENABLE')
*Show Approved Amount
*Old: SHOW GET m.nAPAprPric &loForm.lcAprPri
LOFORM.TXTAPAPRPRIC.ENABLED = (LOFORM.LCAPRPRI='ENABLE')

*-- If the document type is Material PO, Material PO Return or Material
*-- MFG Order.
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*IF INLIST(loForm.loRec.cImTyp,'T','L','F')
IF INLIST(LOFORMSET.LOREC.CIMTYP,'T','L','F')
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

  *-- Disable the Get Field that has no decimal points.
  *Old: SHOW OBJECT OBJNUM(m.nApTAprQty) + 1 DISABLE
  *-- Use the Get Field that has decimal points.
  *Old: loFormSet.lnApQtyObj = OBJNUM(m.nApTAprQty)
  *Old: SHOW OBJECT loFormSet.lnApQtyObj &loForm.lcAprQty
  LOFORM.TXTAPTAPRQTY.INPUTMASK = "9999999.999"
  LOFORM.TXTAPTAPRQTY.ENABLED = (LOFORM.LCAPRQTY='ENABLE')

ELSE    && Else (If the document type is anything but Material PO, Material PO Return and Material MFG Order.)

  *-- Disable the Get Field that has decimal points.
  *Old: SHOW OBJECT OBJNUM(m.nApTAprQty) DISABLE
  *-- Use the Get Field that has no decimal points.
  *Old: loFormSet.lnApQtyObj = OBJNUM(m.nApTAprQty) + 1
  *Old: SHOW OBJECT loFormSet.lnApQtyObj &loForm.lcAprQty  &&lower
  LOFORM.TXTAPTAPRQTY.INPUTMASK = "9999999"
  LOFORM.TXTAPTAPRQTY.ENABLED = (LOFORM.LCAPRQTY='ENABLE')

ENDIF    && End of IF INLIST(m.cImTyp,'T','L','F')

*Old: SHOW GET m.nAPAprAmnt &loForm.lcAprPri &&Revise
LOFORM.TXTAPAPRAMNT.ENABLED = (LOFORM.LCAPRPRI='ENABLE')
DO CASE
  *Free Format Invoice
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *CASE INLIST(loForm.loRec.cIMTyp,'G',' ')
CASE INLIST(LOFORMSET.LOREC.CIMTYP,'G',' ')
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  *HIDE WINDOW 'APINVD21','APINVD22','APINVD23' SAME
  *Old: SHOW GETS WINDOW 'APINVD21' DISABLE ONLY &&Revise
  =LFCNTSHOWGET(LOFORM,21,'Visible',.F.)
  =LFCNTSHOWGET(LOFORM,21,'Enabled',.F.)
  *Old: SHOW GETS WINDOW 'APINVD22' DISABLE ONLY &&Revise
  =LFCNTSHOWGET(LOFORM,22,'Visible',.F.)
  =LFCNTSHOWGET(LOFORM,22,'Enabled',.F.)
  *Old: SHOW GETS WINDOW 'APINVD23' DISABLE ONLY &&Revise
  =LFCNTSHOWGET(LOFORM,23,'Visible',.F.)
  =LFCNTSHOWGET(LOFORM,23,'Enabled',.F.)
  *SHOW WINDOW 'APINVD24' TOP
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  IF !(LOFORMSET.ACTIVEMODE $ "EA" AND LOFORMSET.LLZOOMINVD)
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    =LFCNTSHOWGET(LOFORM,24,'Visible',.T.)
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  ENDIF
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[END]
  *Old: SHOW GETS WINDOW 'APINVD24' &loForm.lcDetMode ONLY &&Revise
  =LFCNTSHOWGET(LOFORM,24,'Enabled',(LOFORM.LCDETMODE='ENABLE'))
  IF APVENDOR.CTAXTYPE<>'T'
    *=gfwCodePop(@laCodes,'CTAXCODE','T'),.T.)
    *Fix problem in AP Invoice lines that tax code applies to all lines [Begin]
    DIMENSION LACODES[ALEN(loFormSet.laCodes,1),ALEN(loFormSet.laCodes,2)]
    =ACOPY(LOFORMSET.LACODES,LACODES)
    =GFWCODEPOP(@LACODES,'CTAXCODE','L')
    =ACOPY(LACODES,LOFORMSET.LACODES)
    IF LOFORMSET.ACTIVEMODE="V"
      IF !EMPTY(APVINVDT.CTAXCODE)
        *loFormSet.lnTaxCode = ASUBSCRIPT(loFormSet.laTaxCode,ASCAN(loFormSet.laTaxCode,APVInvDt.CTAXCODE),1)
        LOFORMSET.LNTAXCODE = ASUBSCRIPT(LOFORMSET.LATAXCODE,ASCAN(LOFORMSET.LATAXCODE,APVINVDT2.CTAXCODE),1)
        *Old: SHOW GET loFormSet.lnTaxCode &&Revise
        LOFORM.CBOTAXCODE.VISIBLE = .T.
        LOFORM.CBOTAXCODE.REFRESH()
      ENDIF
    ENDIF
    *Fix problem in AP Invoice lines that tax code applies to all lines [End]
    LOFORM.LCWIPSTAT = IIF(LOFORMSET.ACTIVEMODE="V" OR EOF() OR ;
      !EMPTY(EVALUATE(LOFORMSET.LCTMPDIST+'.CTAXCODE')),'DISABLE','ENABLE')
  ENDIF


  *Invoice Applied To Style PO, Shipments or Cutting Tickets
  *Add Adorment/Dying/MMFG order to invoice line
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *CASE INLIST(loForm.loRec.cIMTyp,'I','S','M','R','A','D')
CASE INLIST(LOFORMSET.LOREC.CIMTYP,'I','S','M','R','A','D')
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[ENd]
  *HIDE WINDOW 'APINVD23','APINVD24' SAME
  =LFCNTSHOWGET(LOFORM,23,'Visible',.F.)
  =LFCNTSHOWGET(LOFORM,24,'Visible',.F.)
  *Old: SHOW GETS WINDOW 'APINVD23' DISABLE ONLY &&Revise
  *Old: SHOW GETS WINDOW 'APINVD24' DISABLE ONLY &&Revise
  =LFCNTSHOWGET(LOFORM,23,'Enabled',.F.)
  =LFCNTSHOWGET(LOFORM,24,'Enabled',.F.)
  *SHOW WINDOW 'APINVD21' TOP
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  IF !(LOFORMSET.ACTIVEMODE $ "EA" AND LOFORMSET.LLZOOMINVD)
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    =LFCNTSHOWGET(LOFORM,21,'Visible',.T.)
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  ENDIF
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  STORE ITEM     TO LOFORM.CNTSTYLE.VALUE
  STORE CDYELOT  TO LOFORM.KBDYELOT.KEYTEXTBOX.VALUE
  STORE CAPVIDES TO LOFORM.TXTSTYDESC.VALUE
  *Old: SHOW GETS WINDOW 'APINVD21' &loForm.lcScrMode ONLY  &&lower &&Revise
  =LFCNTSHOWGET(LOFORM,21,'Enabled',(LOFORM.LCSCRMODE='ENABLE'))

  *B606054,1 ALB Control the Style [Begin]
  *Old: SHOW GET ibStyle    DISABLE &&Revise
  *Old: SHOW GET lcStyle    DISABLE &&Revise
  *Old: SHOW GET lcStyDye   DISABLE &&Revise
  *Old: SHOW GET ibStyDye   DISABLE &&Revise
  *Old: SHOW GET lcFabric   DISABLE &&Revise
  *Old: SHOW GET lcFabClr   DISABLE &&Revise
  *Old: SHOW GET ibFabric   DISABLE &&Revise
  *Old: SHOW GET ibFabClr   DISABLE &&Revise
  STORE .F. TO LOFORM.CNTSTYLE.ENABLED, LOFORM.CNTITEM.ENABLED, LOFORM.KBDYELOT.ENABLED

  *Get the correct WIP account with shipment ticket [Begin]
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *loForm.lcWIPStat = IIF(EMPTY(loForm.loRec.cAPDGLAct),'DISABLE','ENABLE')
  *loForm.glApDGlAct.Enabled = (loForm.lcWIPStat='ENABLE')
  LOFORM.LCWIPSTAT = IIF(EMPTY(LOFORMSET.LOREC.CAPDGLACT) ,'DISABLE','ENABLE')
  *Old: SHOW GET m.cAPDGLAct &loForm.lcWIPStat.  &&Revise
  LOFORM.GLAPDGLACT.ENABLED = (LOFORM.LCWIPSTAT='ENABLE') AND LOFORMSET.ACTIVEMODE $'EA'
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  *Get the correct WIP account with shipment ticket [end]

  IF !SEEK(LOFORM.CNTSTYLE.VALUE,'Style') OR STYLE.CDYE_FLG <> 'Y'
    *Old: SHOW GET lcStyDye DISABLE &&Revise
    LOFORM.KBDYELOT.ENABLED = .F.
  ENDIF
  IF LOFORM.LLDEFQTYDT
    *Show Quantity per size
    *SHOW WINDOW 'APINVD22' TOP
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    IF  !(LOFORMSET.ACTIVEMODE $ "EA" AND LOFORMSET.LLZOOMINVD)
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      =LFCNTSHOWGET(LOFORM,22,'Visible',.T.)
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    ENDIF
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    *=lfRefresh('APINVD22')
    *Old: SHOW GET m.nAPQty1  &loForm.lcInvQDet  &&Revise
    *Old: SHOW GET m.nAPQty2  &loForm.lcInvQDet  &&Revise
    *Old: SHOW GET m.nAPQty3  &loForm.lcInvQDet  &&Revise
    *Old: SHOW GET m.nAPQty4  &loForm.lcInvQDet  &&Revise
    *Old: SHOW GET m.nAPQty5  &loForm.lcInvQDet  &&Revise
    *Old: SHOW GET m.nAPQty6  &loForm.lcInvQDet  &&Revise
    *Old: SHOW GET m.nAPQty7  &loForm.lcInvQDet  &&Revise
    *Old: SHOW GET m.nAPQty8  &loForm.lcInvQDet  &&Revise
    LOFORM.CNTAP_QTY.ENABLED = (LOFORM.LCINVQDET='ENABLE')
    *Old: SHOW GET m.nAPAprQty1 &loForm.lcAprQDet  &&Revise
    *Old: SHOW GET m.nAPAprQty2 &loForm.lcAprQDet  &&Revise
    *Old: SHOW GET m.nAPAprQty3 &loForm.lcAprQDet  &&Revise
    *Old: SHOW GET m.nAPAprQty4 &loForm.lcAprQDet  &&Revise
    *Old: SHOW GET m.nAPAprQty5 &loForm.lcAprQDet  &&Revise
    *Old: SHOW GET m.nAPAprQty6 &loForm.lcAprQDet  &&Revise
    *Old: SHOW GET m.nAPAprQty7 &loForm.lcAprQDet  &&Revise
    *Old: SHOW GET m.nAPAprQty8 &loForm.lcAprQDet  &&Revise
    LOFORM.CNTAPAPR_QTY.ENABLED = (LOFORM.LCAPRQDET='ENABLE')
  ELSE
    *Hide Quantity per size
    *HIDE WINDOW 'APINVD22' SAME
    =LFCNTSHOWGET(LOFORM,22,'Visible',.F.)
    *Old: SHOW GETS WINDOW 'APINVD22' DISABLE ONLY &&Revise
    =LFCNTSHOWGET(LOFORM,22,'Enabled',.F.)
  ENDIF
  *Invoice Applied To Material PO or Material MFG Orders
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *CASE INLIST(loForm.loRec.cImTyp,'T','L','F')
CASE INLIST(LOFORMSET.LOREC.CIMTYP,'T','L','F')
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  *HIDE WINDOW 'APINVD21','APINVD22','APINVD24' SAME
  =LFCNTSHOWGET(LOFORM,21,'Visible',.F.)
  *=lfcntShowGet(loForm,22,'Visible',.F.) &&Boho
  =LFCNTSHOWGET(LOFORM,24,'Visible',.F.)
  *Old: SHOW GETS WINDOW 'APINVD21' DISABLE ONLY &&Revise
  *Old: SHOW GETS WINDOW 'APINVD22' DISABLE ONLY &&Revise
  *Old: SHOW GETS WINDOW 'APINVD24' DISABLE ONLY &&Revise
  =LFCNTSHOWGET(LOFORM,21,'Enabled',.F.)
  *=lfcntShowGet(loForm,22,'Enabled',.F.) &&Boho
  =LFCNTSHOWGET(LOFORM,24,'Enabled',.F.)
  *STORE SUBSTR(Item,1,7) TO lcFabric
  *STORE Color    TO lcFabClr
  *STORE cDyelot  TO lcFabDye
  *STORE cApVIDes TO lcFabDesc
  *Q4: is this replacment ok ?
  STORE LFUPDITEM(ITEM,COLOR) TO LOFORM.CNTITEM.VALUE
  STORE CDYELOT  TO LOFORM.KBDYELOT.KEYTEXTBOX.VALUE
  STORE CAPVIDES TO LOFORM.TXTSTYDESC.VALUE
  *Control the cut tickit [Begin]
  *SHOW GET ibTktNo    &lcScrMode
  *SHOW GET lcInvTktNo &lcScrMode
  LOFORM.KBINVTKTNO.ENABLED = (LOFORM.LCSCRMODE='ENABLE')
  *B606054,1 ALB Control the cut tickit [End]
  *SHOW WINDOW 'APINVD23' TOP
  *Old: SHOW GETS WINDOW 'APINVD23' &loForm.lcScrMode ONLY  &&Revise
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  IF !(LOFORMSET.ACTIVEMODE $ "EA" AND LOFORMSET.LLZOOMINVD)
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    =LFCNTSHOWGET(LOFORM,23,'Visible',.T.)
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  ENDIF
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[END]
  =LFCNTSHOWGET(LOFORM,23,'Enabled',(LOFORM.LCSCRMODE='ENABLE'))
  *Q5: What will we do Here ?
  *adalb IF EMPTY(lcFabric)
  *Old: SHOW GET ibFabClr DISABLE &&Revise
  *Old: SHOW GET lcFabClr DISABLE &&Revise
  *Old: SHOW GET ibFabric DISABLE &&Revise
  *Old: SHOW GET lcFabric DISABLE &&Revise
  *ENDIF
  *Q6: What will we do Here ?
  *CINVTYPE+STYLE
  IF !LOFORMSET.FABRIC.SEEK('0002'+LOFORM.CNTITEM.VALUE) OR FABRIC.CDYE_FLG <> 'Y'  &&Sql73: Check Key
    *Old: SHOW GET ibFabDye DISABLE &&Revise
    *Old: SHOW GET lcFabDye DISABLE &&Revise
    LOFORM.KBDYELOT.ENABLED = .F.
  ENDIF
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *IF loForm.llDefQtyDt
  IF LOFORM.LLDEFQTYDT AND !(LOFORMSET.ACTIVEMODE $ "EA" AND LOFORMSET.LLZOOMINVD)
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    =LFCNTSHOWGET(LOFORM,22,'Visible',.T.)
    LOFORM.CNTAP_QTY.ENABLED = (LOFORM.LCINVQDET='ENABLE')
    LOFORM.CNTAPAPR_QTY.ENABLED = (LOFORM.LCAPRQDET='ENABLE')
  ELSE
    =LFCNTSHOWGET(LOFORM,22,'Visible',.F.)
    =LFCNTSHOWGET(LOFORM,22,'Enabled',.F.)
  ENDIF

ENDCASE

*Old: SHOW GET ibWIPAcnt   &loForm.lcWIPStat   &&Revise
*Old: SHOW GET m.cApDGlAct &loForm.lcWIPStat   &&Revise
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*loForm.glApDGlAct.Enabled = (loForm.lcWIPStat='ENABLE')
LOFORM.GLAPDGLACT.ENABLED = (LOFORM.LCWIPSTAT='ENABLE')AND LOFORMSET.ACTIVEMODE $'EA'
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
*SHOW GET pbNewLine   &lcScrMode
IF LOFORMSET.ACTIVEMODE="E"
  *Old: SHOW GET pbNewLine ENABLE &&Revise
  LOFORM.CMDNEW.ENABLED = .T.
ELSE
  *Old: SHOW GET pbNewLine &loForm.lcScrMode  &&Revise
  LOFORM.CMDNEW.ENABLED = (LOFORM.LCSCRMODE='ENABLE')
ENDIF
*=lfRefresh('APINVDT1')

IF LOFORMSET.LCVENINVTYPES=='G'
  *Old: SHOW GET pbAuto DISABLE &&Revise
  LOFORM.CMDAUTO.ENABLED = .F.
ELSE
  *SHOW GET pbAuto &lcScrMode
  LOFORM.CMDAUTO.ENABLED = (LOFORM.LCSCRMODE='ENABLE')
  IF LOFORMSET.ACTIVEMODE="E"
    *Old: SHOW GET pbAuto ENABLE &&Revise
    LOFORM.CMDAUTO.ENABLED = .T.
  ELSE
    *Old: SHOW GET pbAuto &loForm.lcScrMode &&Revise
    LOFORM.CMDAUTO.ENABLED = (LOFORM.LCSCRMODE='ENABLE')
  ENDIF
ENDIF
*Old: SHOW GET pbRemLine &loForm.lcDetMode  &&lower &&Revise
LOFORM.CMDREMOVE.ENABLED = (LOFORM.LCDETMODE='ENABLE')

*Change this IF condition to give the user the capability to add
*          debit memo lines, compare the absolute values [Begin]
*IF !EMPTY(lcInvTktNo) AND nApAprAmnt > 0 AND m.cImTyp <> 'G'
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*IF !EMPTY(loForm.kbInvTktNo.KeyTextBox.Value) AND ABS(nApAprAmnt) > 0 AND loForm.loRec.cImTyp <> 'G'
IF !EMPTY(LOFORM.KBINVTKTNO.KEYTEXTBOX.VALUE) AND ABS(NAPAPRAMNT) > 0 AND LOFORMSET.LOREC.CIMTYP <> 'G'
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  *Change this IF condition to give the user the capability [End]

  *Old: SHOW GET pbContrib ENABLE &&Revise
  LOFORM.CMDCONTRIBUTE.ENABLED = .T.
ELSE
  *Old: SHOW GET pbContrib DISABLE &&Revise
  LOFORM.CMDCONTRIBUTE.ENABLED = .F.
ENDIF
*Old: SHOW GET pbApprove &loForm.lcDetMode &&Revise
LOFORM.CMDMULTIAPPROVE.ENABLED = (LOFORM.LCDETMODE='ENABLE')
*Old: SHOW GET pbClose ENABLE &&Revise
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*loForm.cmdClose.Enabled = .T.
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[end]
*! B610111,1 MMT 10/11/2012 Modify Payable invoice screen to handle MFG order case[Start]
loform.cboTktType.REQUERY ()
*! B610111,1 MMT 10/11/2012 Modify Payable invoice screen to handle MFG order case[End]
RETURN
*-- End of lfShowWind


*!*************************************************************
*! Name      : lfcntShowGet
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 8/30/2004
*! Purpose   : To Change a Property (Enabled or Visible) of a group of Controls
*!             that are logically on the same container.
*!*************************************************************
*! Parameters: The Form of APINVDT.SCX, The Container No., Property Name, Property Value
*!*************************************************************
*! Returns   : None
*!*************************************************************
FUNCTION LFCNTSHOWGET
LPARAMETERS LOFORM, LNCNTNO, LCPROPERTY, LLVALUE
DO CASE
CASE LNCNTNO=13
  LOFORM.CBOTKTTYPE.&LCPROPERTY.=LLVALUE
  LOFORM.CBOCOSTTYPE.&LCPROPERTY.=LLVALUE
  LOFORM.CBOMFGOPR.&LCPROPERTY.=LLVALUE
  LOFORM.KBINVTKTNO.&LCPROPERTY.=LLVALUE
  LOFORM.CBOLOTNO.&LCPROPERTY.=LLVALUE
CASE LNCNTNO=21
  LOFORM.CNTSTYLE.&LCPROPERTY.=LLVALUE
  LOFORM.KBDYELOT.&LCPROPERTY.=LLVALUE
  LOFORM.LBLDYELOT.&LCPROPERTY.=LLVALUE
  LOFORM.TXTSTYDESC.&LCPROPERTY.=LLVALUE
CASE LNCNTNO=22
  LOFORM.CNTAP_QTY.&LCPROPERTY.=LLVALUE
  LOFORM.CNTAPAPR_QTY.&LCPROPERTY.=LLVALUE
CASE LNCNTNO=23
  LOFORM.CNTITEM.&LCPROPERTY.=LLVALUE
  LOFORM.KBDYELOT.&LCPROPERTY.=LLVALUE
  LOFORM.LBLDYELOT.&LCPROPERTY.=LLVALUE
  LOFORM.TXTSTYDESC.&LCPROPERTY.=LLVALUE
CASE LNCNTNO=24
  LOFORM.LBLITEM.&LCPROPERTY.=LLVALUE
  LOFORM.TXTITEM.&LCPROPERTY.=LLVALUE
  LOFORM.LBLTAXCODE.&LCPROPERTY.=LLVALUE
  LOFORM.LBLTAXCOLON.&LCPROPERTY.=LLVALUE
  LOFORM.CBOTAXCODE.&LCPROPERTY.=LLVALUE
  LOFORM.TXTSTYDESC.&LCPROPERTY.=LLVALUE
ENDCASE

RETURN
*-- End of lfcntShowGet


*!*************************************************************
*! Name      : lfRefLot
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 08/30/2004
*! Purpose   : Refresh Operation Lot
*!*************************************************************
*! Parameters:  lcLot, The Form of APINVDT.SCX
*!*************************************************************
*! Returns   :  None
*!*************************************************************
FUNCTION LFREFLOT
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*PARAMETERS lcLot, loForm
PARAMETERS LOFORMSET,LCLOT, LOFORM
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
LOCAL LCSQLSTATEMENT, LNRESULT, LCALIAS
LCALIAS = ALIAS()
*CIMTYP+CTKTNO+COPRCODE+CLOTNO+TRANCD
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*!*	lcSqlStatement = "SELECT DISTINCT cLotNo FROM MFGOPRDT (INDEX=MFGOPRDT) WHERE "+;
*!*	                 "CIMTYP='"+loForm.loRec.cIMTyp+"' AND CTKTNO='"+loForm.loRec.cTktNo+"' "+;
*!*	                 "AND COPRCODE='"+loForm.loRec.cOprCode+"'"
*!*	lnResult=oAriaApplication.remotecompanydata.sqlrun(lcSqlStatement,'Lots','MFGOPRDT',;
oAriaApplication.ActiveCompanyConStr,3,'SAVE',loForm.DataSessionID)

LCSQLSTATEMENT = "SELECT DISTINCT cLotNo FROM MFGOPRDT (INDEX=MFGOPRDT) WHERE "+;
  "CIMTYP='"+LOFORMSET.LOREC.CIMTYP+"' AND CTKTNO='"+LOFORMSET.LOREC.CTKTNO+"' "+;
  "AND COPRCODE='"+LOFORMSET.LOREC.COPRCODE+"'"
LNRESULT=OARIAAPPLICATION.REMOTECOMPANYDATA.SQLRUN(LCSQLSTATEMENT,'Lots','MFGOPRDT',;
  OARIAAPPLICATION.ACTIVECOMPANYCONSTR,3,'SAVE',LOFORMSET.DATASESSIONID)

*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
IF LNRESULT<1
  OARIAAPPLICATION.REMOTECOMPANYDATA.CHECKRETRESULT("execute",LNRESULT,.T.)
  IF !EMPTY(LCALIAS)
    SELECT (LCALIAS)
  ENDIF
  *AIT WINDOW LINENO()
  RETURN .F.
ENDIF
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*SELECT cLotNo FROM Lots INTO ARRAY loForm.laOprLots &&Sql74: Must use SqlRun
SELECT CLOTNO FROM LOTS INTO ARRAY LOFORMSET.LAOPRLOTS &&Sql74: Must use SqlRun
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
USE IN LOTS
IF !EMPTY(LCALIAS)
  SELECT (LCALIAS)
ENDIF
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*loForm.cboLotNo.Value = ASCAN(loForm.laOprLots,lcLot)
LOFORM.CBOLOTNO.VALUE = ASCAN(LOFORMSET.LAOPRLOTS,LCLOT)
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[ENd]


RETURN
*-- End of lfRefLot


*!*************************************************************
*! Name      : lfLots
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 08/30/2004
*! Purpose   : Get Operation Lots
*!*************************************************************
*! Parameters:  The Form of APINVDT.SCX
*!*************************************************************
*! Returns   :  None
*!*************************************************************
FUNCTION LFLOTS
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*LPARAMETERS loForm
LPARAMETERS LOFORMSET,LOFORM
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
PRIVATE LNLOTS

LOCAL LCSQLSTATEMENT, LNRESULT, LCALIAS
LCALIAS = ALIAS()
*CIMTYP+CTKTNO+COPRCODE+CLOTNO+TRANCD
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*!*	lcSqlStatement = "SELECT DISTINCT cLotNo FROM MFGOPRDT (INDEX=MFGOPRDT) WHERE "+;
*!*	                 "CIMTYP='"+loForm.loRec.cIMTyp+"' AND CTKTNO='"+loForm.loRec.cTktNo+"' "+;
*!*	                 "AND COPRCODE='"+loForm.loRec.cOprCode+"'"
*!*	lnResult=oAriaApplication.remotecompanydata.sqlrun(lcSqlStatement,'Lots','MFGOPRDT',;
*!*	         oAriaApplication.ActiveCompanyConStr,3,'SAVE',loForm.DataSessionID)
LCSQLSTATEMENT = "SELECT DISTINCT cLotNo FROM MFGOPRDT (INDEX=MFGOPRDT) WHERE "+;
  "CIMTYP='"+LOFORMSET.LOREC.CIMTYP+"' AND CTKTNO='"+LOFORMSET.LOREC.CTKTNO+"' "+;
  "AND COPRCODE='"+LOFORMSET.LOREC.COPRCODE+"'"
LNRESULT=OARIAAPPLICATION.REMOTECOMPANYDATA.SQLRUN(LCSQLSTATEMENT,'Lots','MFGOPRDT',;
  OARIAAPPLICATION.ACTIVECOMPANYCONSTR,3,'SAVE',LOFORMSET.DATASESSIONID)
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
IF LNRESULT<1
  OARIAAPPLICATION.REMOTECOMPANYDATA.CHECKRETRESULT("execute",LNRESULT,.T.)
  IF !EMPTY(LCALIAS)
    SELECT (LCALIAS)
  ENDIF
  *AIT WINDOW LINENO()
  RETURN .F.
ENDIF

*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*SELECT DISTINCT cLotNo FROM Lots INTO ARRAY loForm.laOprLots  &&Sql75: Must use SqlRun
SELECT DISTINCT CLOTNO FROM LOTS INTO ARRAY LOFORMSET.LAOPRLOTS  &&Sql75: Must use SqlRun
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
USE IN LOTS
IF !EMPTY(LCALIAS)
  SELECT (LCALIAS)
ENDIF
LNLOTS = _TALLY
DO CASE
CASE LNLOTS = 0
  LOFORM.CBOLOTNO.VALUE = 0
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *loForm.loRec.cLotNo = SPACE(2)
  LOFORMSET.LOREC.CLOTNO = SPACE(2)
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
OTHERWISE
  LOFORM.CBOLOTNO.VALUE = 1
  *B608159,1 WAM 07/12/2007 Rebuild lots popup after collecting operation lots
  LOFORM.CBOLOTNO.REQUERY
  *B608159,1 WAM 07/12/2007 (End)
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *loForm.loRec.cLotNo = loForm.laOprLots[1]
  LOFORMSET.LOREC.CLOTNO = LOFORMSET.LAOPRLOTS[1]
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
ENDCASE
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*!*	REPLACE cStatus WITH IIF(cStatus='S' AND cLotNo <> loForm.loRec.cLotNo,'M',cStatus) ,;
*!*	        cLotNo  WITH loForm.loRec.cLotNo
REPLACE CSTATUS WITH IIF(CSTATUS='S' AND CLOTNO <> LOFORMSET.LOREC.CLOTNO,'M',CSTATUS) ,;
  CLOTNO  WITH LOFORMSET.LOREC.CLOTNO
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
RETURN(LNLOTS > 1)
*-- End of lfLots

*!*************************************************************
*! Name      : lfGetCstEle
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 08/30/2004
*! Purpose   : Get Available Cost Elements for selected Ticket
*!*************************************************************
*! Parameters:  The FormSet of APPYINV.SCX, The Form of APINVDT.SCX
*!*************************************************************
*! Returns   :  None
*!*************************************************************
FUNCTION LFGETCSTELE
LPARAMETERS LOFORMSET, LOFORM

LOCAL LCARY, LNL, LNC


DECLARE LOFORMSET.LACOSTTYPE[1]
*N000682,1 MMT 12/09/2012 Globalization changes[Start]
*STORE 'N/A' TO LOFORMSET.LACOSTTYPE
STORE IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_NOTAPPLICABLE,loformset.GetHeaderText("LANG_APPYINV_NOTAPPLICABLE",loformset.HeaderAlias)) TO LOFORMSET.LACOSTTYPE
*N000682,1 MMT 12/09/2012 Globalization changes[Start]
DO CASE
  *Invoice Applied To Style PO, Shipments or Cutting Tickets
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	  CASE INLIST(loForm.loRec.cIMTyp,'I','S','M','R')
  *!*	    lcAry=IIF(loForm.loRec.cIMTyp='M','loFormSet.laMCstType','loFormSet.laICstType')
CASE INLIST(LOFORMSET.LOREC.CIMTYP,'I','S','M','R')
  LCARY=IIF(LOFORMSET.LOREC.CIMTYP='M','loFormSet.laMCstType','loFormSet.laICstType')
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  DECLARE LOFORMSET.LACOSTTYPE[ALEN(&lcAry,1),3]
  =ACOPY(&LCARY,LOFORMSET.LACOSTTYPE)
  LOFORM.CBOCOSTTYPE.REQUERY()
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *loForm.cboCostType.Value=IIF(EMPTY(loForm.loRec.cBomType),1,ASUBSCRIPT(loFormSet.laCostType,ASCAN(loFormSet.laCostType,loForm.loRec.cBomType),1))
  LOFORM.CBOCOSTTYPE.VALUE=IIF(EMPTY(LOFORMSET.LOREC.CBOMTYPE),1,ASUBSCRIPT(LOFORMSET.LACOSTTYPE,ASCAN(LOFORMSET.LACOSTTYPE,LOFORMSET.LOREC.CBOMTYPE),1))
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  *Invoice Applied To Material PO or Material MFG Orders
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	  CASE INLIST(loForm.loRec.cImTyp,'T','L','F')
  *!*	    lcAry=IIF(loForm.loRec.cIMTyp='T','loFormSet.laTCstType','loFormSet.laLCstType')
CASE INLIST(LOFORMSET.LOREC.CIMTYP,'T','L','F')
  LCARY=IIF(LOFORMSET.LOREC.CIMTYP='T','loFormSet.laTCstType','loFormSet.laLCstType')
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  DECLARE LOFORMSET.LACOSTTYPE[ALEN(&lcAry,1),3]
  =ACOPY(&LCARY,LOFORMSET.LACOSTTYPE)
  LOFORM.CBOCOSTTYPE.REQUERY()
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *loForm.cboCostType.Value=IIF(EMPTY(loForm.loRec.cBomType),1,ASUBSCRIPT(loFormSet.laCostType,ASCAN(loFormSet.laCostType,loForm.loRec.cBomType),1))
  *!*	  CASE INLIST(loForm.loRec.cIMTyp,'A')
  *!*	    lcAry=IIF(loForm.loRec.cIMTyp='A','loFormSet.laACstType','loFormSet.laICstType')
  LOFORM.CBOCOSTTYPE.VALUE=IIF(EMPTY(LOFORMSET.LOREC.CBOMTYPE),1,ASUBSCRIPT(LOFORMSET.LACOSTTYPE,ASCAN(LOFORMSET.LACOSTTYPE,LOFORMSET.LOREC.CBOMTYPE),1))
CASE INLIST(LOFORMSET.LOREC.CIMTYP,'A')
  LCARY=IIF(LOFORMSET.LOREC.CIMTYP='A','loFormSet.laACstType','loFormSet.laICstType')
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  DECLARE LOFORMSET.LACOSTTYPE[ALEN(&lcAry,1),3]
  =ACOPY(&LCARY,LOFORMSET.LACOSTTYPE)
  LOFORM.CBOCOSTTYPE.REQUERY()
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *loForm.cboCostType.Value=IIF(EMPTY(loForm.loRec.cBomType),1,ASUBSCRIPT(loFormSet.laCostType,ASCAN(loFormSet.laCostType,loForm.loRec.cBomType),1))
  *!*	  CASE INLIST(loForm.loRec.cIMTyp,'D')
  *!*	    lcAry=IIF(loForm.loRec.cIMTyp='D','loFormSet.laMCstType','loFormSet.laICstType')
  LOFORM.CBOCOSTTYPE.VALUE=IIF(EMPTY(LOFORMSET.LOREC.CBOMTYPE),1,ASUBSCRIPT(LOFORMSET.LACOSTTYPE,ASCAN(LOFORMSET.LACOSTTYPE,LOFORMSET.LOREC.CBOMTYPE),1))
CASE INLIST(LOFORMSET.LOREC.CIMTYP,'D')
  LCARY=IIF(LOFORMSET.LOREC.CIMTYP='D','loFormSet.laMCstType','loFormSet.laICstType')
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  DECLARE LOFORMSET.LACOSTTYPE[ALEN(&lcAry,1),3]
  =ACOPY&LCARY,LOFORMSET.LACOSTTYPE)
  LOFORM.CBOCOSTTYPE.REQUERY()
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	    loForm.cboCostType.Value=IIF(EMPTY(loForm.loRec.cBomType),1,ASUBSCRIPT(loFormSet.laCostType,ASCAN(loFormSet.laCostType,loForm.loRec.cBomType),1))
  LOFORM.CBOCOSTTYPE.VALUE=IIF(EMPTY(LOFORMSET.LOREC.CBOMTYPE),1,ASUBSCRIPT(LOFORMSET.LACOSTTYPE,ASCAN(LOFORMSET.LACOSTTYPE,LOFORMSET.LOREC.CBOMTYPE),1))
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[ENd]

ENDCASE

RETURN
*-- End of lfGetCstEle


*!*************************************************************
*! Name      : lfUpdDist
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 08/30/2004
*! Purpose   : Update Temporary AP Distribution file in case of Shipment.
*!*************************************************************
*! Parameters: The FormSet of APPYINV.SCX, The Form of APINVDT.SCX
*!*************************************************************
*! Returns   : None
*!*************************************************************
*Amin, If the invoice line detail is contributed we should update the Apdist with
*line for each contirbuted account. This should be per vendor+invoice in case of
*Shipmnet only   [start]
FUNCTION LFUPDDIST
LPARAMETERS LOFORMSET, LOFORM

PRIVATE LNALIAS , LCINVLINENO , LCAPDLINNO , LCGLACCOUNT , LNAMOUNT, LNTOTCNTAMT
STORE '' TO LNALIAS , LCINVLINENO , LCAPDLINNO , LCGLACCOUNT
STORE 0  TO LNAMOUNT , LNTOTCNTAMT
LNALIAS = SELECT()
*Add Adorment order to invoice line [Begin]
SELECT (LOFORMSET.LCAPINVTKT)
* No need to rebuild the TmpDist file if there is no contributed Shipment.
*LOCATE FOR cImTyp = "S"  AND !EMPTY(cRsession)
*IF EOF()
* Nothing do to with this invoice. The TempDist file should be ok
*  RETURN
*ENDIF
*E301995,1 Alb Add Adorment order to invoice line [end]

* Before rebuilding the Temp.Dist file we should zap it.
SELECT (LOFORMSET.LCTMPDIST)
ZAP
APPEND BLANK
GFADD_INFO(LOFORMSET.LCTMPDIST)
*ASM, Fix the bug that he stores blank in capacct [Start]

*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*REPLACE apinvhdr.capacct WITH ;
IIF(!EMPTY(APVENDOR.cAPAcct) , APVENDOR.cAPAcct ,;
IIF(SEEK(loFormSet.AriaForm1.cboDivision.Value , 'APDIV') .AND.;
!EMPTY(APDIV.cAPAcct) , APDIV.cAPAcct ,APSETUP.cAPAcct)) IN apinvhdr
*loFormSet.DistLines.glAPActCode.KeyTextBox.Value = apinvhdr.capacct
SELECT  APINVHDR
GFREPLACE("capacct WITH '"+;
  IIF(!EMPTY(APVENDOR.CAPACCT) , APVENDOR.CAPACCT ,;
  IIF(GFSEEK(LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.CBODIVISION.VALUE , 'APDIV') .AND.;
  !EMPTY(APDIV.CAPACCT) , APDIV.CAPACCT ,APSETUP.CAPACCT))+"'")
SELECT (LOFORMSET.LCTMPDIST)
LOFORMSET.ARIAFORM1.PGFPAYINV.PGDIST.GLAPACTCODE.KEYTEXTBOX.VALUE = APINVHDR.CAPACCT
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
*ASM, Fix the bug that he stores blank in capacct [End]

*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*!*	REPLACE CVENDCODE WITH loFormSet.AriaForm1.KBVendCode.KeyTextBox.Value  ,;
*!*	        CINVNO    WITH loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value  ,;
*!*	        DAPDTRDAT WITH loFormSet.AriaForm1.DtPostDate.Value ,;
*!*	        LAPDPOST  WITH .F.        ,;
*!*	        CAPDGLACT WITH loFormSet.DistLines.glAPActCode.KeyTextBox.Value ,;
*!*	        CAPDACTID WITH 'A'        ,;
*!*	        CAPDREF   WITH loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value  ,;
*!*	        CFISFYEAR WITH loFormSet.lcDistYer  ,;
*!*	        CFSPPRDID WITH loFormSet.lcDistPrd  ,;
*!*	        CAPSESSNO WITH loFormSet.lcSequence ,;
*!*	        NAPDLINNO WITH 0          ,;
*!*	        CAPDTRTYP WITH 'I'        ,;
*!*	        CSTATUS   WITH 'A'        ,;
*!*	        CCURRCODE WITH loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value ,;
*!*	        NEXRATE   WITH loFormSet.AriaForm1.txtNexRate.Value ,;
*!*	        NCURRUNIT WITH apinvhdr.ncurrunit ,;
*!*	        NAPDAMNT WITH -loFormSet.AriaForm1.txtInvAmount.Value
*!*	lcTemp = '-loFormSet.AriaForm1.txtInvAmount.Value'+loFormSet.lcExSin1+;
*!*	  'loFormSet.AriaForm1.txtNexRate.Value'+loFormSet.lcExSin2+'apinvhdr.ncurrunit'
REPLACE CVENDCODE WITH LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE  ,;
  CINVNO    WITH LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE  ,;
  DAPDTRDAT WITH LOFORMSET.ARIAFORM1.DTPOSTDATE.VALUE ,;
  LAPDPOST  WITH .F.        ,;
  CAPDGLACT WITH LOFORMSET.ARIAFORM1.PGFPAYINV.PGDIST.GLAPACTCODE.KEYTEXTBOX.VALUE ,;
  CAPDACTID WITH 'A'        ,;
  CAPDREF   WITH LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE  ,;
  CFISFYEAR WITH LOFORMSET.LCDISTYER  ,;
  CFSPPRDID WITH LOFORMSET.LCDISTPRD  ,;
  CAPSESSNO WITH LOFORMSET.LCSEQUENCE ,;
  NAPDLINNO WITH 0          ,;
  CAPDTRTYP WITH 'I'        ,;
  CSTATUS   WITH 'A'        ,;
  CCURRCODE WITH LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.KEYTEXTBOX.VALUE ,;
  NEXRATE   WITH LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTNEXRATE.VALUE ,;
  NCURRUNIT WITH APINVHDR.NCURRUNIT ,;
  NAPDAMNT WITH -LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTINVAMOUNT.VALUE

LCTEMP = '-loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.Value'+LOFORMSET.LCEXSIN1+;
  'loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.Value'+LOFORMSET.LCEXSIN2+'apinvhdr.ncurrunit'
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

*!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][Start]
*REPLACE NEQVAMNT WITH EVALUATE(lcTemp)
IF (LOFORMSET.LCEXSIN1 = '/' .AND. LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTINVAMOUNT.VALUE = 0) .OR. ;
    (LOFORMSET.LCEXSIN2 = '/' .AND. LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTNEXRATE.VALUE = 0)
  REPLACE NEQVAMNT WITH 0
ELSE
  REPLACE NEQVAMNT WITH EVALUATE(LCTEMP)
ENDIF
*!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][End]

SELECT (LOFORMSET.LCAPVINVDT)
SCAN
  LCINVLINENO = EVALUATE(LOFORMSET.LCAPVINVDT+'.cAPVILNo')
  LNTOTCNTAMT = 0
  SELECT (LOFORMSET.LCAPINVTKT)
  *If there is Contributed Shipmnet, update TmpDist with the lines from invoicetkt
  IF SEEK(PADR(LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE,8)+PADR(LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE,12)+LCINVLINENO)  AND ;
      EVALUATE(LOFORMSET.LCAPINVTKT+'.cImTyp') = "S"  AND !EMPTY(EVALUATE(LOFORMSET.LCAPINVTKT+'.cRsession')) AND ;
      !EMPTY(EVALUATE(LOFORMSET.LCAPINVTKT+'.cTktNo'))

    SCAN REST WHILE CVENDCODE+CAPINVNO+CAPVILNO= PADR(LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE,8)+PADR(LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE,12)+LCINVLINENO ;
        FOR EVALUATE(LOFORMSET.LCAPINVTKT+'.cImTyp') = "S" AND !EMPTY(EVALUATE(LOFORMSET.LCAPINVTKT+'.cRsession')) AND  !EMPTY(EVALUATE(LOFORMSET.LCAPINVTKT+'.cTktNo'))
      *Fix the contribution process  to save the invoice [Begin]
      LNTOTCNTAMT = LNTOTCNTAMT + ROUND(EVALUATE(LOFORMSET.LCAPINVTKT+'.nApaplAmnt'),2)
      *ALB Fix the contribution process  to save the invoice [End]
      LNAMOUNT    = EVALUATE(LOFORMSET.LCAPINVTKT+'.nApaplAmnt')

      *Refresh the WIP account when changing
      LCGLACCOUNT = EVALUATE(LOFORMSET.LCAPINVTKT+'.cApdGlAct')

      LCAPDLINNO = EVALUATE(LOFORMSET.LCAPINVTKT+'.cApdLinNo')
      SELECT (LOFORMSET.LCTMPDIST)
      IF !SEEK(PADR(LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE,8)+PADR(LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE,12)+LCAPDLINNO)
        IF LNAMOUNT <> 0
          APPEND BLANK
          GFADD_INFO(LOFORMSET.LCTMPDIST)
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
          *!*	          REPLACE CVENDCODE WITH loFormSet.AriaForm1.KBVendCode.KeyTextBox.Value  ,;
          *!*	                  CINVNO    WITH loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value  ,;
          *!*	                  DAPDTRDAT WITH loFormSet.AriaForm1.DtPostDate.Value ,;
          *!*	                  LAPDPOST  WITH .F.        ,;
          *!*	                  CAPDACTID WITH 'D'        ,;
          *!*	                  CAPDREF   WITH loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value  ,;
          *!*	                  CFISFYEAR WITH loFormSet.lcDistYer  ,;
          *!*	                  CFSPPRDID WITH loFormSet.lcDistPrd  ,;
          *!*	                  CAPSESSNO WITH loFormSet.lcSequence ,;
          *!*	                  CAPDTRTYP WITH 'I'        ,;
          *!*	                  CSTATUS   WITH 'A'        ,;
          *!*	                  NAPDLINNO WITH VAL(lcApdLinNo) ,;
          *!*	                  CCURRCODE WITH loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value ,;
          *!*	                  NEXRATE   WITH loFormSet.AriaForm1.txtNexRate.Value ,;
          *!*	                  NCURRUNIT WITH apinvhdr.ncurrunit ,;
          *!*	                  CAPDGLACT WITH lcGlAccount,;
          *!*	                  NAPDAMNT  WITH lnAmount
          *!*	          lcTemp = 'lnAmount'+loFormSet.lcExSin1+'loFormSet.AriaForm1.txtNexRate.Value'+loFormSet.lcExSin2+'apinvhdr.ncurrunit'
          *!*	          REPLACE NEQVAMNT  WITH EVALUATE(lcTemp),;
          *!*	                  CTAXCODE  WITH IIF(ApVendor.cTaxType<>'T',;
          *!*	                  IIF(loForm.laTktType[loForm.cboTktType.Value,2]='G' AND !loFormSet.llAutoScr,loFormSet.laTaxCode[loFormSet.lnTaxCode,2],''),'')
          REPLACE CVENDCODE WITH LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE  ,;
            CINVNO    WITH LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE  ,;
            DAPDTRDAT WITH LOFORMSET.ARIAFORM1.DTPOSTDATE.VALUE ,;
            LAPDPOST  WITH .F.        ,;
            CAPDACTID WITH 'D'        ,;
            CAPDREF   WITH LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE  ,;
            CFISFYEAR WITH LOFORMSET.LCDISTYER  ,;
            CFSPPRDID WITH LOFORMSET.LCDISTPRD  ,;
            CAPSESSNO WITH LOFORMSET.LCSEQUENCE ,;
            CAPDTRTYP WITH 'I'        ,;
            CSTATUS   WITH 'A'        ,;
            NAPDLINNO WITH VAL(LCAPDLINNO) ,;
            CCURRCODE WITH LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.KEYTEXTBOX.VALUE ,;
            NEXRATE   WITH LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTNEXRATE.VALUE ,;
            NCURRUNIT WITH APINVHDR.NCURRUNIT ,;
            CAPDGLACT WITH LCGLACCOUNT,;
            NAPDAMNT  WITH LNAMOUNT


          LCTEMP = 'lnAmount'+LOFORMSET.LCEXSIN1+'loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.Value'+LOFORMSET.LCEXSIN2+'apinvhdr.ncurrunit'
          *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][Start]
          TRY
            *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][End]
            REPLACE NEQVAMNT  WITH EVALUATE(LCTEMP),;
              CTAXCODE  WITH IIF(APVENDOR.CTAXTYPE<>'T',;
              IIF(LOFORMSET.LATKTTYPE[loForm.cboTktType.Value,2]='G' AND !LOFORMSET.LLAUTOSCR,LOFORMSET.LATAXCODE[loFormSet.lnTaxCode,2],''),'')
            *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][Start]
          CATCH
            REPLACE NEQVAMNT  WITH 0,;
              CTAXCODE  WITH IIF(APVENDOR.CTAXTYPE<>'T',;
              IIF(LOFORMSET.LATKTTYPE[loForm.cboTktType.Value,2]='G' AND !LOFORMSET.LLAUTOSCR,LOFORMSET.LATAXCODE[loFormSet.lnTaxCode,2],''),'')
          ENDTRY
          *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][End]
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

          REPLACE CTAXCODE WITH IIF(APVENDOR.CTAXTYPE<>'T',;
            IIF(EVALUATE(LOFORMSET.LCAPVINVDT+'.CIMTYP')='G' AND !LOFORMSET.LLAUTOSCR,EVALUATE(LOFORMSET.LCAPVINVDT+'.CTaxCode'),''),'')
        ENDIF    && End of IF lnAmount <> 0
      ELSE
        * The following part is to handle the old records that were created thru old version.
        * That is becasue the new fields NAPDLINNO and CAPDGLACT were created and updated thru the new version
        * and it replaced with the value of APINVDTL.cAPVILNo and APINVDTL.cApdGlAct respectively.
        IF LNAMOUNT <> 0
          IF LCGLACCOUNT = EVALUATE(LOFORMSET.LCTMPDIST+'.cApdGlAct')
            LCFLD = LOFORMSET.LCTMPDIST+'.NAPDAMNT'
            REPLACE &LCFLD  WITH EVALUATE(LOFORMSET.LCTMPDIST+'.NAPDAMNT')  + LNAMOUNT
            LCFLD = LOFORMSET.LCTMPDIST+'.NEQVAMNT'
            *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
            *!*	            lcTemp='lnAmount'+loFormSet.lcExSin1+'loFormSet.AriaForm1.txtNexRate.Value'+loFormSet.lcExSin2+'apinvhdr.ncurrunit'
            LCTEMP='lnAmount'+LOFORMSET.LCEXSIN1+'loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.Value'+LOFORMSET.LCEXSIN2+'apinvhdr.ncurrunit'
            *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
            *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][Start]
            TRY
              *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][End]
              REPLACE &LCFLD WITH EVALUATE(LOFORMSET.LCTMPDIST+'.NEQVAMNT')  + EVALUATE(LCTEMP)
              *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][Start]
            CATCH
            ENDTRY
            *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][End]
            GFADD_INFO(LOFORMSET.LCTMPDIST)
          ELSE
            APPEND BLANK
            GFADD_INFO(LOFORMSET.LCTMPDIST)
            *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
            *!*	            REPLACE CVENDCODE WITH loFormSet.AriaForm1.KBVendCode.KeyTextBox.Value  ,;
            *!*	                    CINVNO    WITH loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value  ,;
            *!*	                    DAPDTRDAT WITH loFormSet.AriaForm1.DtPostDate.Value ,;
            *!*	                    LAPDPOST  WITH .F.        ,;
            *!*	                    CAPDACTID WITH 'D'        ,;
            *!*	                    CAPDREF   WITH loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value  ,;
            *!*	                    CFISFYEAR WITH loFormSet.lcDistYer  ,;
            *!*	                    CFSPPRDID WITH loFormSet.lcDistPrd  ,;
            *!*	                    CAPSESSNO WITH loFormSet.lcSequence ,;
            *!*	                    CAPDTRTYP WITH 'I'        ,;
            *!*	                    CSTATUS   WITH 'A'        ,;
            *!*	                    NAPDLINNO WITH VAL(lcApdLinNo) ,;
            *!*	                    CCURRCODE WITH loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value ,;
            *!*	                    NEXRATE   WITH loFormSet.AriaForm1.txtNexRate.Value ,;
            *!*	                    NCURRUNIT WITH apinvhdr.ncurrunit ,;
            *!*	                    CAPDGLACT WITH lcGlAccount,;
            *!*	                    NAPDAMNT  WITH lnAmount
            *!*	            lcTemp = 'lnAmount'+loFormSet.lcExSin1+'loFormSet.AriaForm1.txtNexRate.Value'+loFormSet.lcExSin2+'apinvhdr.ncurrunit'
            *!*	            REPLACE NEQVAMNT  WITH EVALUATE(lcTemp),;
            *!*	                    CTAXCODE  WITH IIF(ApVendor.cTaxType<>'T',;
            *!*	                    IIF(loForm.laTktType[loForm.cboTktType.Value,2]='G' AND !loFormSet.llAutoScr,loFormSet.laTaxCode[loFormSet.lnTaxCode,2],''),'')
            REPLACE CVENDCODE WITH LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE  ,;
              CINVNO    WITH LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE  ,;
              DAPDTRDAT WITH LOFORMSET.ARIAFORM1.DTPOSTDATE.VALUE ,;
              LAPDPOST  WITH .F.        ,;
              CAPDACTID WITH 'D'        ,;
              CAPDREF   WITH LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE  ,;
              CFISFYEAR WITH LOFORMSET.LCDISTYER  ,;
              CFSPPRDID WITH LOFORMSET.LCDISTPRD  ,;
              CAPSESSNO WITH LOFORMSET.LCSEQUENCE ,;
              CAPDTRTYP WITH 'I'        ,;
              CSTATUS   WITH 'A'        ,;
              NAPDLINNO WITH VAL(LCAPDLINNO) ,;
              CCURRCODE WITH LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.KEYTEXTBOX.VALUE ,;
              NEXRATE   WITH LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTNEXRATE.VALUE ,;
              NCURRUNIT WITH APINVHDR.NCURRUNIT ,;
              CAPDGLACT WITH LCGLACCOUNT,;
              NAPDAMNT  WITH LNAMOUNT
            LCTEMP = 'lnAmount'+LOFORMSET.LCEXSIN1+'loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.Value'+LOFORMSET.LCEXSIN2+'apinvhdr.ncurrunit'
            *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][Start]
            TRY
              *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][End]
              REPLACE NEQVAMNT  WITH EVALUATE(LCTEMP),;
                CTAXCODE  WITH IIF(APVENDOR.CTAXTYPE<>'T',;
                IIF(LOFORMSET.LATKTTYPE[loForm.cboTktType.Value,2]='G' AND !LOFORMSET.LLAUTOSCR,LOFORMSET.LATAXCODE[loFormSet.lnTaxCode,2],''),'')
              *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][Start]
            CATCH
              REPLACE NEQVAMNT  WITH 0,;
                CTAXCODE  WITH IIF(APVENDOR.CTAXTYPE<>'T',;
                IIF(LOFORMSET.LATKTTYPE[loForm.cboTktType.Value,2]='G' AND !LOFORMSET.LLAUTOSCR,LOFORMSET.LATAXCODE[loFormSet.lnTaxCode,2],''),'')

            ENDTRY
            *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][End]
            *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
            REPLACE CTAXCODE WITH IIF(APVENDOR.CTAXTYPE<>'T',;
              IIF(EVALUATE(LOFORMSET.LCAPVINVDT+'.CIMTYP')='G' AND !LOFORMSET.LLAUTOSCR,EVALUATE(LOFORMSET.LCAPVINVDT+'.CTaxCode'),''),'')
          ENDIF   && End of IF lcGlAccount = &loFormSet.lcTmpDist..cApdGlAct
        ENDIF    && End of IF lnAmount <> 0
      ENDIF      &&End of IF !SEEK(PADR(loFormSet.AriaForm1.KBVendCode.KeyTextBox.Value,8)+PADR(loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value,12)+lcApdLinNo)
    ENDSCAN
    * If the total contribued amount is not equal to the invoice amount. add new line with the
    * difference.
    IF LNTOTCNTAMT <> 0 .AND. LNTOTCNTAMT <> EVALUATE(LOFORMSET.LCAPVINVDT+'.nAPAMnt')
      LNAMOUNT    =  ABS(EVALUATE(LOFORMSET.LCAPVINVDT+'.nAPAMnt')) - ABS(LNTOTCNTAMT)

      SELECT (LOFORMSET.LCTMPDIST)
      *fIX THE APDIST TO ADD THE DIFF. AT THE END OF THE RECORD [BEGIN]
      *APPEND BLANK
      *REPLACE CVENDCODE WITH laData[1]  ,;
      CINVNO    WITH loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value  ,;
      DAPDTRDAT WITH loFormSet.AriaForm1.DtPostDate.Value ,;
      LAPDPOST  WITH .F.        ,;
      CAPDACTID WITH 'D'        ,;
      CAPDREF   WITH loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value  ,;
      CFISFYEAR WITH loFormSet.lcDistYer  ,;
      CFSPPRDID WITH loFormSet.lcDistPrd  ,;
      CAPSESSNO WITH loFormSet.lcSequence ,;
      CAPDTRTYP WITH 'I'        ,;
      CSTATUS   WITH 'A'        ,;
      NAPDLINNO WITH 0          ,;
      CCURRCODE WITH loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value ,;
      NEXRATE   WITH loFormSet.AriaForm1.txtNexRate.Value ,;
      NCURRUNIT WITH apinvhdr.ncurrunit ,;
      CAPDGLACT WITH &loFormSet.lcAPvInvDt..cApdGlAct,;
      NAPDAMNT  WITH lnAmount    ,;
      NEQVAMNT  WITH lnAmount &loFormSet.lcExSin1 loFormSet.AriaForm1.txtNexRate.Value &loFormSet.lcExSin2 apinvhdr.ncurrunit,;
      CTAXCODE  WITH IIF(ApVendor.cTaxType<>'T',;
      IIF(loForm.laTktType[loForm.cboTktType.Value,2]='G' AND !loFormSet.llAutoScr,loFormSet.laTaxCode[loFormSet.lnTaxCode,2],''),'')
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *!*	      lcTemp = 'lnAmount'+loFormSet.lcExSin1+'loFormSet.AriaForm1.txtNexRate.Value'+loFormSet.lcExSin2+'apinvhdr.ncurrunit'
      LCTEMP = 'lnAmount'+LOFORMSET.LCEXSIN1+'loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.Value'+LOFORMSET.LCEXSIN2+'apinvhdr.ncurrunit'
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][Start]
      TRY
        *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][End]
        REPLACE NAPDAMNT  WITH NAPDAMNT + LNAMOUNT    ,;
          NEQVAMNT  WITH NEQVAMNT + EVALUATE(LCTEMP)
        *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][Start]
      CATCH
        REPLACE NAPDAMNT  WITH NAPDAMNT + LNAMOUNT    ,;
          NEQVAMNT  WITH NEQVAMNT
      ENDTRY
      *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][End]
      GFADD_INFO(LOFORMSET.LCTMPDIST)
      *fIX THE APDIST TO ADD THE DIFF. AT THE END OF THE RECORD [END]
    ENDIF   &&End of IF lnTotCntAmt <> 0 .AND. lnTotCntAmt <> &loFormSet.lcAPvInvDt..nAPAMnt
  ELSE
    *Fix bug when Saving the debit memo againest Return PO [BEGIN]
    LNAMOUNT    = EVALUATE(LOFORMSET.LCAPVINVDT+'.nAPAMnt')
    *lnAmount    = &lcAPvInvDt..nAPAMnt * IIF(&lcAPvInvDt..CIMTYP $'RF',-1,1)
    *Fix bug when Saving the debit memo againest Return PO [END]

    LCGLACCOUNT = EVALUATE(LOFORMSET.LCAPVINVDT+'.cApdGlAct')
    LCINVLINENO = EVALUATE(LOFORMSET.LCAPVINVDT+'.cAPVILNo')
    SELECT (LOFORMSET.LCTMPDIST)
    **! B608492,1 SSH Allow Zero record in case of General Exp.
    *IF !SEEK(PADR(loFormSet.AriaForm1.KBVendCode.KeyTextBox.Value,8)+PADR(loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value,12)+lcInvLineNo) AND lnAmount <> 0
    IF !SEEK(PADR(LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE,8)+PADR(LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE,12)+LCINVLINENO)

      IF EVALUATE(LOFORMSET.LCAPVINVDT+'.cImTyp') = "G" OR (LNAMOUNT <> 0)
        **! B608492,1 SSH Allow Zero record in case of General Exp.
        APPEND BLANK
        GFADD_INFO(LOFORMSET.LCTMPDIST)
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        *!*	        REPLACE CVENDCODE WITH loFormSet.AriaForm1.KBVendCode.KeyTextBox.Value  ,;
        *!*	                CINVNO    WITH loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value  ,;
        *!*	                DAPDTRDAT WITH loFormSet.AriaForm1.DtPostDate.Value ,;
        *!*	                LAPDPOST  WITH .F.        ,;
        *!*	                CAPDACTID WITH 'D'        ,;
        *!*	                CAPDREF   WITH loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value  ,;
        *!*	                CFISFYEAR WITH loFormSet.lcDistYer  ,;
        *!*	                CFSPPRDID WITH loFormSet.lcDistPrd  ,;
        *!*	                CAPSESSNO WITH loFormSet.lcSequence ,;
        *!*	                CAPDTRTYP WITH 'I'        ,;
        *!*	                CSTATUS   WITH 'A'        ,;
        *!*	                NAPDLINNO WITH VAL(lcInvLineNo),;
        *!*	                CCURRCODE WITH loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value ,;
        *!*	                NEXRATE   WITH loFormSet.AriaForm1.txtNexRate.Value ,;
        *!*	                NCURRUNIT WITH apinvhdr.ncurrunit ,;
        *!*	                CAPDGLACT WITH lcGlAccount,;
        *!*	                NAPDAMNT  WITH lnAmount
        *!*	        lcTemp = 'lnAmount'+loFormSet.lcExSin1+'loFormSet.AriaForm1.txtNexRate.Value'+loFormSet.lcExSin2+'apinvhdr.ncurrunit'
        *!*	        REPLACE NEQVAMNT  WITH EVALUATE(lcTemp),;
        *!*	                CTAXCODE  WITH IIF(ApVendor.cTaxType<>'T',;
        *!*	                IIF(loForm.laTktType[loForm.cboTktType.Value,2]='G',loFormSet.laTaxCode[loFormSet.lnTaxCode,2],''),'')
        REPLACE CVENDCODE WITH LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE  ,;
          CINVNO    WITH LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE  ,;
          DAPDTRDAT WITH LOFORMSET.ARIAFORM1.DTPOSTDATE.VALUE ,;
          LAPDPOST  WITH .F.        ,;
          CAPDACTID WITH 'D'        ,;
          CAPDREF   WITH LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE  ,;
          CFISFYEAR WITH LOFORMSET.LCDISTYER  ,;
          CFSPPRDID WITH LOFORMSET.LCDISTPRD  ,;
          CAPSESSNO WITH LOFORMSET.LCSEQUENCE ,;
          CAPDTRTYP WITH 'I'        ,;
          CSTATUS   WITH 'A'        ,;
          NAPDLINNO WITH VAL(LCINVLINENO),;
          CCURRCODE WITH LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.KEYTEXTBOX.VALUE ,;
          NEXRATE   WITH LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTNEXRATE.VALUE ,;
          NCURRUNIT WITH APINVHDR.NCURRUNIT ,;
          CAPDGLACT WITH LCGLACCOUNT,;
          NAPDAMNT  WITH LNAMOUNT
        LCTEMP = 'lnAmount'+LOFORMSET.LCEXSIN1+'loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.Value'+LOFORMSET.LCEXSIN2+'apinvhdr.ncurrunit'
        *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][Start]
        TRY
          *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][End]
          REPLACE NEQVAMNT  WITH EVALUATE(LCTEMP),;
            CTAXCODE  WITH IIF(APVENDOR.CTAXTYPE<>'T',;
            IIF(LOFORMSET.LATKTTYPE[loForm.cboTktType.Value,2]='G',LOFORMSET.LATAXCODE[loFormSet.lnTaxCode,2],''),'')
          *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][Start]
        CATCH
          REPLACE NEQVAMNT  WITH 0,;
            CTAXCODE  WITH IIF(APVENDOR.CTAXTYPE<>'T',;
            IIF(LOFORMSET.LATKTTYPE[loForm.cboTktType.Value,2]='G',LOFORMSET.LATAXCODE[loFormSet.lnTaxCode,2],''),'')

        ENDTRY
        *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][End]
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
        *Fix problem in AP Invoice lines that tax code applies to all lines [Begin]
        REPLACE CTAXCODE WITH IIF(APVENDOR.CTAXTYPE<>'T',;
          IIF(EVALUATE(LOFORMSET.LCAPVINVDT+'.CIMTYP')='G' AND !LOFORMSET.LLAUTOSCR,EVALUATE(LOFORMSET.LCAPVINVDT+'.CTaxCode'),''),'')
        *Fix problem in AP Invoice lines that tax code applies to all lines [End]
      ENDIF
    ENDIF
  ENDIF
ENDSCAN

*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*SELECT *,SPACE(60) AS 'CDISCRIP',;
'S' AS 'cStatus',;
SPACE(1) AS 'cUpdSerNo',;
RECNO() AS 'NRECNO';
FROM (oAriaApplication.DataDir+'APDIST') ;
WHERE CINVNO + CVENDCODE + cAPDTrTyp = loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value + loFormSet.AriaForm1.KBVendCode.KeyTextBox.Value + "I"  ;
AND CAPDSTAT <> 'V';
INTO DBF (oAriaApplication.WorkDir+loFormSet.lcTmpDist2)
*!B609918,1 MMT 05/16/2012 Payable invoice screen updates APDIST incorrectly[Start]
*!*	=GFSQLRUN("SELECT * From APDIST Where CINVNO = '"+;
*!*	  LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE +;
*!*	  "' AND CVENDCODE ='"+ LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE +"' AND cAPDTrTyp ='I' AND CAPDSTAT <> 'V'",'APDIST',.F.,'APDST_Tmp')

*!*	SELECT *,SPACE(60) AS 'CDISCRIP',;
*!*	  'S' AS 'cStatus',;
*!*	  SPACE(1) AS 'cUpdSerNo',;
*!*	  RECNO() AS 'NRECNO';
*!*	  FROM APDST_TMP ;
*!*	  WHERE CINVNO + CVENDCODE + CAPDTRTYP = LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE + LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE + "I"  ;
*!*	  AND CAPDSTAT <> 'V';
*!*	  INTO DBF (OARIAAPPLICATION.WORKDIR+LOFORMSET.LCTMPDIST2)
=gfSeek(PADR(loFormSet.AriaForm1.kbInvNo.KeyTextBox.VALUE,12)+PADR(loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE ,8),'APDIST','INVVEND')
SELECT *,SPACE(60) AS 'CDISCRIP',;
  'S' AS 'cStatus',;
  SPACE(1) AS 'cUpdSerNo',;
  RECNO() AS 'NRECNO';
  FROM APDIST;
  WHERE CINVNO + CVENDCODE + cAPDTrTyp = loFormSet.AriaForm1.kbInvNo.KeyTextBox.VALUE + loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE + "I"  ;
  AND CAPDSTAT <> 'V';
  INTO DBF (oAriaApplication.WorkDir+loFormSet.lcTmpDist2)
*!B609918,1 MMT 05/16/2012 Payable invoice screen updates APDIST incorrectly[END]
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

SELECT (LOFORMSET.LCTMPDIST2)
REPLACE ALL CAPDSTAT  WITH 'V' ,;
  CSTATUS   WITH 'M'



SELECT (LOFORMSET.LCTMPDIST2)
* Void all records in the TmpDist file
**! B608492,1 SSH Allow Zero record in case of General Exp.
SCAN &&FOR nApdAmnt <> 0

  SELECT (LOFORMSET.LCTMPDIST2)
  SCATTER MEMVAR MEMO

  SELECT (LOFORMSET.LCTMPDIST)
  APPEND BLANK
  GATHER MEMVAR MEMO

  * Add reverse line.
  m.CSTATUS   = 'V'
  m.CBATCHNO  = ' '
  m.CTRNSLEDN = ' '
  m.CSTATUS   = 'A'
  m.NENTRYNO  = 0
  m.LAPDPOST  = .F.
  m.NAPDAMNT  = -1 * m.NAPDAMNT
  m.NEQVAMNT  = -1 * m.NEQVAMNT
  m.CAPSESSNO = LOFORMSET.LCSEQUENCE
  APPEND BLANK
  GATHER MEMVAR MEMO
ENDSCAN

SELECT (LNALIAS)
RETURN
*-- End of lfUpdDist


***LLL***


***NNN***


*!*************************************************************
*! Name      : lfvNInvLine
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 09/02/2004
*! Purpose   : Called form the Click Evenet of the New Button in APINVDT.SCX
*!*************************************************************
*! Parameters:  The FormSet of APPYINV.SCX, The Form of APINVDT.SCX
*!*************************************************************
*! Returns   :  None
*!*************************************************************
FUNCTION LFVNINVLINE
LPARAMETERS LOFORMSET, LOFORM

*?AMIN
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*SCATTER NAME loForm.loRec BLANK
SELECT(IIF(LOFORMSET.ACTIVEMODE="V",'APVINVDT2',LOFORMSET.LCAPVINVDT))
SCATTER NAME LOFORMSET.LOREC BLANK
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
*Old: SHOW GETS DISABLE ONLY &&Revise
WITH LOFORM
  STORE .F. TO .CBOCOSTTYPE.ENABLED, .CBOMFGOPR.ENABLED, .KBINVTKTNO.ENABLED, .CBOLOTNO.ENABLED, ;
    .CNTSTYLE.ENABLED, .CNTITEM.ENABLED, .KBDYELOT.ENABLED, .TXTITEM.ENABLED, .TXTSTYDESC.ENABLED, ;
    .GLAPDGLACT.ENABLED, .CNTAP_QTY.ENABLED, .CNTAPAPR_QTY.ENABLED, .CMDAUTO.ENABLED, ;
    .CMDREMOVE.ENABLED, .CMDCONTRIBUTE.ENABLED, .CMDMULTIAPPROVE.ENABLED
ENDWITH
LOFORM.REFRESH()
*Old: SHOW GET loForm.cboTktType.Value ENABLE  &&lower &&Revise
LOFORM.CBOTKTTYPE.ENABLED = .T.
*Old: _CUROBJ = OBJNUM(loForm.cboTktType.Value)  &&lower&&Old CurObj
LOFORM.CBOTKTTYPE.SETFOCUS()
RETURN
*-- End of lfvNInvLine


*!*************************************************************
*! Name      : lfvTktType
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 09/02/2004
*! Purpose   : Validate applied ticket type (cboTktType) in APINVDT.SCX
*!*************************************************************
*! Parameters:  The FormSet of APPYINV.SCX, The Form of APINVDT.SCX
*!*************************************************************
*! Returns   :  None
*!*************************************************************
FUNCTION LFVTKTTYPE
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*LPARAMETERS loFormSet, loForm
PARAMETERS LOFORMSET, LOFORM
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*SCATTER NAME loForm.loRec BLANK
SELECT(IIF(LOFORMSET.ACTIVEMODE="V",'APVINVDT2',LOFORMSET.LCAPVINVDT))
SCATTER NAME LOFORMSET.LOREC BLANK
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
LOFORM.REFRESH()

DIMENSION LACODES[ALEN(loFormSet.laCodes,1),ALEN(loFormSet.laCodes,2)]
=ACOPY(LOFORMSET.LACODES,LACODES)
=GFWCODEPOP(@LACODES,'MFGCODE','N')
=ACOPY(LACODES,LOFORMSET.LACODES)

=IIF(APVENDOR.CTAXTYPE<>'T',GFWCODEPOP(@LACODES,'CTAXCODE','N'),.T.)
=ACOPY(LACODES,LOFORMSET.LACODES)
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*loForm.loRec.cIMTyp = loForm.laTktType[loForm.cboTktType.Value,2]
*IF loForm.loRec.cIMTyp = 'G'
LOFORMSET.LOREC.CIMTYP = LOFORMSET.LATKTTYPE[loForm.cboTktType.Value,2]
IF LOFORMSET.LOREC.CIMTYP = 'G'
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  *Add this line to refresh the default Expense Account [Begin]

  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *  loFormSet.lcDistAcct = IIF(!EMPTY(APVENDOR.cExpAcct) , APVENDOR.cExpAcct ,;
  IIF(SEEK(loFormSet.AriaForm1.cboDivision.Value , 'APDIV') .AND.;
  !EMPTY(APDIV.cExpAcct) , APDIV.cExpAcct ,;
  APSETUP.cExpAcct))
  LOFORMSET.LCDISTACCT = IIF(!EMPTY(APVENDOR.CEXPACCT) , APVENDOR.CEXPACCT ,;
    IIF(GFSEEK(LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.CBODIVISION.VALUE , 'APDIV') .AND.;
    !EMPTY(APDIV.CEXPACCT) , APDIV.CEXPACCT ,;
    APSETUP.CEXPACCT))
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  *Add this line to refresh the default Expense Account [End]

  *Get the next sequence line no. [Start]
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *REPLACE apinvhdr.nlastvilno WITH lfGetMaxLin(loFormSet, loForm) IN apinvhdr
  SELECT APINVHDR
  GFREPLACE("nlastvilno WITH lfGetMaxLin(loFormSet, loForm)")
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  *Get the next sequence line no. [End]
  SELECT (LOFORMSET.LCAPVINVDT)
  REPLACE APINVHDR.NLASTVILNO WITH APINVHDR.NLASTVILNO + 1 IN APINVHDR
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	  *loForm.loRec.cStatus   = 'A'
  *!*	  loForm.loRec.cVendCode = loFormSet.AriaForm1.KBVendCode.KeyTextBox.Value
  *!*	  loForm.loRec.cAPInvNo  = loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value
  *!*	  loForm.loRec.cApVILNo  = STR(apinvhdr.nlastvilno,4)
  *!*	  loForm.loRec.cApDGlAct = loFormSet.lcDistAcct
  LOFORMSET.LOREC.CSTATUS   = 'A'
  LOFORMSET.LOREC.CVENDCODE = LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE
  LOFORMSET.LOREC.CAPINVNO  = LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE
  LOFORMSET.LOREC.CAPVILNO  = STR(APINVHDR.NLASTVILNO,4)
  LOFORMSET.LOREC.CAPDGLACT = LOFORMSET.LCDISTACCT
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[ENd]

  =IIF(APVENDOR.CTAXTYPE<>'T',GFWCODEPOP(@LACODES,'CTAXCODE','D'),.T.)
  =ACOPY(LACODES,LOFORMSET.LACODES)

  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	  INSERT INTO (loFormSet.lcAPvInvDt) FROM NAME loForm.loRec
  *!*	  =lfUpdApDist(loFormSet,loForm,loForm.loRec.cApVILNo,0,loForm.loRec.cApDGlAct,loForm.loRec.cIMTyp)
  INSERT INTO (LOFORMSET.LCAPVINVDT) FROM NAME LOFORMSET.LOREC
  =LFUPDAPDIST(LOFORMSET,LOFORM,LOFORMSET.LOREC.CAPVILNO,0,LOFORMSET.LOREC.CAPDGLACT,LOFORMSET.LOREC.CIMTYP)
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

  LFGRDINVDTAFTERROWCOL(LOFORMSET,LOFORM)
  *B608528,1 MHM 04/21/2008 Invoice Lines-cannot amend the GL account for General Expense Item[Start]
  LOFORM.GLAPDGLACT.ENABLED = .T.
  IF APVENDOR.CTAXTYPE = 'T'
    LOFORM.CBOTAXCODE.VISIBLE= .F.
    LOFORM.LBLTAXCODE.VISIBLE = .F.
    LOFORM.LBLTAXCOLON.VISIBLE = .F.
  ENDIF
  * B608528,1 MHM 04/21/2008 Invoice Lines-cannot amend the GL account for General Expense Item[END]
ELSE
  =LFGETCSTELE(LOFORMSET, LOFORM)
  *Old: =lfRefresh('APINVD13')
  *Old: SHOW GET loForm.cboCostType.Value ENABLE  &&Revise
  LOFORM.CBOCOSTTYPE.ENABLED = .T.
  LOFORM.REFRESH()
ENDIF
RETURN 1
*-- End of lfvTktType


*!*************************************************************
*! Name      : lfvCostType
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 09/02/2004
*! Purpose   : Validate Invoiced Cost type (cboCostType) in APINVDT.SCX
*!*************************************************************
*! Parameters:  The FormSet of APPYINV.SCX, The Form of APINVDT.SCX
*!*************************************************************
*! Returns   :  None
*!*************************************************************
FUNCTION LFVCOSTTYPE
*N000682,1 MMT 12/09/2012 Globalization changes[Start]
*LPARAMETERS LOFORMSET, LOFORM
PARAMETERS LOFORMSET, LOFORM
*N000682,1 MMT 12/09/2012 Globalization changes[eND]
*Get the next sequence line no. [Start]
REPLACE APINVHDR.NLASTVILNO WITH LFGETMAXLIN(LOFORMSET, LOFORM) IN APINVHDR
*Get the next sequence line no. [End]
SELECT (LOFORMSET.LCAPVINVDT)
REPLACE APINVHDR.NLASTVILNO WITH APINVHDR.NLASTVILNO + 1 IN APINVHDR
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*!*	loForm.loRec.cStatus   = 'A'
*!*	loForm.loRec.cVendCode = loFormSet.AriaForm1.KBVendCode.KeyTextBox.Value
*!*	loForm.loRec.cAPInvNo  = loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value
*!*	loForm.loRec.cApVILNo  = STR(apinvhdr.nlastvilno,4)
*!*	loForm.loRec.cIMTyp    = loForm.laTktType[loForm.cboTktType.Value,2]
*!*	loForm.loRec.cBomType  = loFormSet.laCostType[loForm.cboCostType.Value,2]
*!*	loForm.loRec.cCostType = loFormSet.laCostType[loForm.cboCostType.Value,3]
*!*	loForm.loRec.cApDGlAct = loFormSet.lcDistAcct
*!*	IF loForm.loRec.cCostType = 'M'
LOFORMSET.LOREC.CSTATUS   = 'A'
LOFORMSET.LOREC.CVENDCODE = LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE
LOFORMSET.LOREC.CAPINVNO  = LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE
LOFORMSET.LOREC.CAPVILNO  = STR(APINVHDR.NLASTVILNO,4)
LOFORMSET.LOREC.CIMTYP    = LOFORMSET.LATKTTYPE[loForm.cboTktType.Value,2]
LOFORMSET.LOREC.CBOMTYPE  = LOFORMSET.LACOSTTYPE[loForm.cboCostType.Value,2]
LOFORMSET.LOREC.CCOSTTYPE = LOFORMSET.LACOSTTYPE[loForm.cboCostType.Value,3]
LOFORMSET.LOREC.CAPDGLACT = LOFORMSET.LCDISTACCT
IF LOFORMSET.LOREC.CCOSTTYPE = 'M'
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  DIMENSION LACODES[ALEN(loFormSet.laCodes,1),ALEN(loFormSet.laCodes,2)]
  =ACOPY(LOFORMSET.LACODES,LACODES)
  =GFWCODEPOP(@LACODES,'MFGCODE','D')
  =ACOPY(LACODES,LOFORMSET.LACODES)
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *  loForm.loRec.cOprCode = loFormSet.laMfgCode[loFormSet.lnMfgOpr,2]
  LOFORMSET.LOREC.COPRCODE = LOFORMSET.LAMFGCODE[loFormSet.lnMfgOpr,2]
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  *Old: SHOW GET loFormSet.lnMfgOpr ENABLE &&Revise
  LOFORM.CBOMFGOPR.REQUERY()
  LOFORM.CBOMFGOPR.ENABLED = .T.
ELSE
  DIMENSION LACODES[ALEN(loFormSet.laCodes,1),ALEN(loFormSet.laCodes,2)]
  =ACOPY(LOFORMSET.LACODES,LACODES)
  =GFWCODEPOP(@LACODES,'MFGCODE','N')
  =ACOPY(LACODES,LOFORMSET.LACODES)
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	  loForm.loRec.cOprCode = REPLICATE(IIF(loForm.loRec.cCostType='P','*',;
  *!*	      IIF(loForm.loRec.cCostType='D','#',' ')),6)
  *!*	  INSERT INTO (loFormSet.lcAPvInvDt) FROM NAME loForm.loRec
  LOFORMSET.LOREC.COPRCODE = REPLICATE(IIF(LOFORMSET.LOREC.CCOSTTYPE='P','*',;
    IIF(LOFORMSET.LOREC.CCOSTTYPE='D','#',' ')),6)
  INSERT INTO (LOFORMSET.LCAPVINVDT) FROM NAME LOFORMSET.LOREC
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  LFGRDINVDTAFTERROWCOL(LOFORMSET,LOFORM)
  *Control the cut tickit and style [Begin]
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *IF INLIST(loForm.loRec.cIMTyp,'I','S','M','A','D','R')
  IF INLIST(LOFORMSET.LOREC.CIMTYP,'I','S','M','A','D','R')
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    *Old: SHOW GET ibStyle    ENABLE &&Revise
    *Old: SHOW GET lcStyle    ENABLE &&Revise
    *Old: SHOW GET ibStyDye   ENABLE &&Revise
    *Old: SHOW GET lcStyDye   ENABLE &&Revise
    STORE .F. TO LOFORM.CNTITEM.VISIBLE, LOFORM.TXTITEM.VISIBLE
    STORE .T. TO LOFORM.CNTSTYLE.VISIBLE, LOFORM.CNTSTYLE.ENABLED
    LOFORM.KBDYELOT.ENABLED = .T.
  ELSE
    *Old: SHOW GET lcFabric   ENABLE &&Revise
    *Old: SHOW GET lcFabClr   ENABLE &&Revise
    *Old: SHOW GET ibFabric   ENABLE &&Revise
    *Old: SHOW GET ibFabClr   ENABLE &&Revise
    *Old: SHOW GET ibFabDye   ENABLE &&Revise
    *Old: SHOW GET lcFabDye   ENABLE &&Revise
    STORE .F. TO LOFORM.CNTSTYLE.VISIBLE, LOFORM.TXTITEM.VISIBLE
    STORE .T. TO LOFORM.CNTITEM.VISIBLE, LOFORM.CNTITEM.ENABLED
    LOFORM.KBDYELOT.ENABLED = .T.
  ENDIF
  *Old: SHOW GET ibTktNo    ENABLE &&Revise
  *Old: SHOW GET loForm.kbInvTktNo.KeyTextBox.Value ENABLE&&Revise
  LOFORM.KBINVTKTNO.ENABLED = .T.
  *Control the cut tickit and style [End]

ENDIF
LOFORM.REFRESH()
SELECT (LOFORMSET.LCAPVINVDT)

RETURN 1
*-- End of lfvCostType


*!*************************************************************
*! Name      : lfvMfgOpr
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 09/02/2004
*! Purpose   : Validate MFG Operation (cboMFGOpr) in APINVDT.SCX
*!*************************************************************
*! Parameters:  The FormSet of APPYINV.SCX, The Form of APINVDT.SCX
*!*************************************************************
*! Returns   :  None
*!*************************************************************
FUNCTION LFVMFGOPR
LPARAMETERS LOFORMSET, LOFORM
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*loForm.loRec.cOprCode = loFormSet.laMfgCode[loFormSet.lnMfgOpr,2]
LOFORMSET.LOREC.COPRCODE = LOFORMSET.LAMFGCODE[loFormSet.lnMfgOpr,2]
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[ENd]
DIMENSION LAMFGRFLD[ALEN(loFormSet.laMfgRFld,1),ALEN(loFormSet.laMfgRFld,2)]
=ACOPY(LOFORMSET.LAMFGRFLD,LAMFGRFLD)

*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*=gfRltFld(loForm.loRec.cOprCode,@laMfgRFld,'MFGCODE')
=GFRLTFLD(LOFORMSET.LOREC.COPRCODE,@LAMFGRFLD,'MFGCODE')
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[ENd]

=ACOPY(LAMFGRFLD,LOFORMSET.LAMFGRFLD)
IF !EMPTY(LOFORMSET.LCMFGGLACNT)
  *Message : 04152
  *MFG Code has been setup to be applied directly through the
  *cost sheet program
  *Button : 00000
  *Ok
  =GFMODALGEN("TRM04152B00000","DIALOG",LOFORMSET.LAMFGCODE[loFormSet.lnMfgOpr,1])

  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *loForm.loRec.cOprCode = cOprCode
  LOFORMSET.LOREC.COPRCODE = COPRCODE
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

  *Old: SHOW GET loFormSet.lnMfgOpr &&Revise
  LOFORM.CBOMFGOPR.REFRESH()
  LOFORM.REFRESH()
  RETURN 0
ENDIF

*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*INSERT INTO (loFormSet.lcAPvInvDt) FROM NAME loForm.loRec
INSERT INTO (LOFORMSET.LCAPVINVDT) FROM NAME LOFORMSET.LOREC
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

LFGRDINVDTAFTERROWCOL(LOFORMSET,LOFORM)
*Control the cut tickit and style [Begin]
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*IF INLIST(loForm.loRec.cIMTyp,'I','S','M','D')
IF INLIST(LOFORMSET.LOREC.CIMTYP,'I','S','M','D')
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  *E301995,1 Alb Add Adorment/Dying/MMFG order to invoice line [END]
  *Old: SHOW GET ibStyle    ENABLE &&Revise
  *Old: SHOW GET lcStyle    ENABLE &&Revise
  *Old: SHOW GET ibStyDye   ENABLE &&Revise
  *Old: SHOW GET lcStyDye   ENABLE &&Revise
  STORE .F. TO LOFORM.CNTITEM.VISIBLE, LOFORM.TXTITEM.VISIBLE
  STORE .T. TO LOFORM.CNTSTYLE.VISIBLE, LOFORM.CNTSTYLE.ENABLED
  LOFORM.KBDYELOT.ENABLED = .T.
ELSE
  *Old: SHOW GET lcFabric   ENABLE &&Revise
  *Old: SHOW GET lcFabClr   ENABLE &&Revise
  *Old: SHOW GET ibFabric   ENABLE &&Revise
  *Old: SHOW GET ibFabClr   ENABLE &&Revise
  *Old: SHOW GET ibFabDye   ENABLE &&Revise
  *Old: SHOW GET lcFabDye   ENABLE &&Revise
  STORE .F. TO LOFORM.CNTSTYLE.VISIBLE, LOFORM.TXTITEM.VISIBLE
  STORE .T. TO LOFORM.CNTITEM.VISIBLE, LOFORM.CNTITEM.ENABLED
  LOFORM.KBDYELOT.ENABLED = .T.
ENDIF
*Old: SHOW GET ibTktNo    ENABLE &&Revise
*Old: SHOW GET loForm.kbInvTktNo.KeyTextBox.Value ENABLE  &&lower &&Revise
LOFORM.KBINVTKTNO.ENABLED = .T.
*Control the cut tickit and style [End]
LOFORM.REFRESH()
SELECT (LOFORMSET.LCAPVINVDT)
RETURN 1
*-- End of lfvMfgOpr

*!*************************************************************
*! Name      : lfvAplTkt
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 09/02/2004
*! Purpose   : Validate Ticket Applied to Invoice Line (kbInvTktNo) in APINVDT.SCX
*!*************************************************************
*! Parameters:  The FormSet of APPYINV.SCX, The Form of APINVDT.SCX
*!*************************************************************
*! Returns   :  None
*!*************************************************************
FUNCTION LFVAPLTKT
LPARAMETERS LOFORMSET, LOFORM


LOFORMSET.LLBROWSE = LOFORM.KBINVTKTNO.SELECTEDFROMBROWSE
*Store the exist value of cTktNo.
LOFORMSET.LCCUTTKTNO = CTKTNO

PRIVATE LCBRFIELDS,LCLINKCODE
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*!*	IF loForm.kbInvTktNo.KeyTextBox.Value <> IIF(loForm.loRec.cIMTyp='S',ShipNO,cTktNo) AND ;
*!*	    lfIsContrib(loFormSet, loForm)
IF LOFORM.KBINVTKTNO.KEYTEXTBOX.VALUE <> IIF(LOFORMSET.LOREC.CIMTYP='S',SHIPNO,CTKTNO) AND ;
    LFISCONTRIB(LOFORMSET, LOFORM)
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  LOFORMSET.LLBROWSE = .F.
  LOFORM.KBINVTKTNO.SELECTEDFROMBROWSE = .F.
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *loForm.kbInvTktNo.KeyTextBox.Value = IIF(loForm.loRec.cIMTyp='S',ShipNo,cTktNo)
  LOFORM.KBINVTKTNO.KEYTEXTBOX.VALUE = IIF(LOFORMSET.LOREC.CIMTYP='S',SHIPNO,CTKTNO)
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  LOFORM.REFRESH()
  RETURN
ENDIF
LCLINKCODE = SPACE(6)
KBINVTKTNO = LOFORM.KBINVTKTNO.KEYTEXTBOX.VALUE
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*=lfvTicket(loFormSet,loForm,loForm.laTktType[loForm.cboTktType.Value,2],@kbInvTktNo,@lcLinkCode,loForm.loRec.cCostType)
=LFVTICKET(LOFORMSET,LOFORM,LOFORMSET.LATKTTYPE[loForm.cboTktType.Value,2],@KBINVTKTNO,@LCLINKCODE,LOFORMSET.LOREC.CCOSTTYPE)
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
LOFORM.KBINVTKTNO.KEYTEXTBOX.VALUE = KBINVTKTNO

*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*IF loForm.kbInvTktNo.KeyTextBox.Value <> IIF(loForm.loRec.cIMTyp='S',ShipNO,cTktNo)
IF LOFORM.KBINVTKTNO.KEYTEXTBOX.VALUE <> IIF(LOFORMSET.LOREC.CIMTYP='S',SHIPNO,CTKTNO)
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

  *Assign the new Ticket no to cTktNo [Begin]
  IF !EMPTY(LOFORM.KBINVTKTNO.KEYTEXTBOX.VALUE)

    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *loForm.loRec.cTktNo = loForm.kbInvTktNo.KeyTextBox.Value
    LOFORMSET.LOREC.CTKTNO = LOFORM.KBINVTKTNO.KEYTEXTBOX.VALUE
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

  ELSE
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *loForm.loRec.cTktNo = loFormSet.lcCutTktNo
    LOFORMSET.LOREC.CTKTNO = LOFORMSET.LCCUTTKTNO
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  ENDIF


  *If Item has been entered, Check if this Item exists in the select Ticket
  IF !EMPTY(LOFORM.KBINVTKTNO.KEYTEXTBOX.VALUE) AND !EMPTY(ITEM)

    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *!*	    IF !lfItemQty(loFormSet,loForm,loForm.loRec.cIMTyp,loForm.kbInvTktNo.KeyTextBox.Value,loForm.loRec.cLotNo,;
    *!*	       loForm.loRec.cBomType,loForm.loRec.cOprCode,loForm.loRec.Item,loForm.loRec.Color,;
    *!*	       loForm.loRec.cDyelot)
    *!*	      loForm.kbInvTktNo.KeyTextBox.Value = IIF(loForm.loRec.cIMTyp='S',ShipNo,cTktNo)
    IF !LFITEMQTY(LOFORMSET,LOFORM,LOFORMSET.LOREC.CIMTYP,LOFORM.KBINVTKTNO.KEYTEXTBOX.VALUE,LOFORMSET.LOREC.CLOTNO,;
        LOFORMSET.LOREC.CBOMTYPE,LOFORMSET.LOREC.COPRCODE,LOFORMSET.LOREC.ITEM,LOFORMSET.LOREC.COLOR,;
        LOFORMSET.LOREC.CDYELOT)
      LOFORM.KBINVTKTNO.KEYTEXTBOX.VALUE = IIF(LOFORMSET.LOREC.CIMTYP='S',SHIPNO,CTKTNO)
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      LOFORM.REFRESH()
      RETURN
    ENDIF
    =LFSHOWWIND(LOFORMSET, LOFORM)
  ENDIF
  IF LOFORMSET.LASETUPS[3,2]='Y'
    IF !SEEK(LCLINKCODE+'013','GL_LINK')
      =SEEK('DEFDEF'+'013','GL_LINK')
    ENDIF
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *STORE GL_Link.GlAcnt TO loForm.loRec.cApDGlAct
    STORE GL_LINK.GLACNT TO LOFORMSET.LOREC.CAPDGLACT
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  ELSE
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *        STORE loFormSet.lcDistAcct TO loForm.loRec.cApDGlAct
    STORE LOFORMSET.LCDISTACCT TO LOFORMSET.LOREC.CAPDGLACT
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  ENDIF
  *Change the defaulte WIP Account to LFNM Account (ENGLAND)[Begin]
  *IF ASCAN(laEvntTrig , PADR('UPDTAPGL',10)) <> 0
  *=gfDoTriger('APPYINV',PADR('UPDTAPGL',10))
  *ENDIF
  *Change the defaulte WIP Account to LFNM Account (ENGLAND)[end]
  SELECT (LOFORMSET.LCAPVINVDT)
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	  REPLACE cTktNo    WITH IIF(loForm.loRec.cIMTyp='S','',loForm.kbInvTktNo.KeyTextBox.Value) ,;
  *!*	          ShipNO    WITH IIF(loForm.loRec.cIMTyp='S',loForm.kbInvTktNo.KeyTextBox.Value,'') ,;
  *!*	          cApDGlAct WITH loForm.loRec.cApDGlAct ,;
  *!*	          cStatus   WITH IIF(cStatus='S','M',cStatus)
  *!*	  loForm.loRec.cTktNo = cTKtNo
  *!*	  loForm.loRec.ShipNo = ShipNo
  *!*	  IF !EMPTY(loForm.kbInvTktNo.KeyTextBox.Value) AND loForm.loRec.cCostType='M' AND lfLots(loForm)
  REPLACE CTKTNO    WITH IIF(LOFORMSET.LOREC.CIMTYP='S','',LOFORM.KBINVTKTNO.KEYTEXTBOX.VALUE) ,;
    SHIPNO    WITH IIF(LOFORMSET.LOREC.CIMTYP='S',LOFORM.KBINVTKTNO.KEYTEXTBOX.VALUE,'') ,;
    CAPDGLACT WITH LOFORMSET.LOREC.CAPDGLACT ,;
    CSTATUS   WITH IIF(CSTATUS='S','M',CSTATUS)
  LOFORMSET.LOREC.CTKTNO = CTKTNO
  LOFORMSET.LOREC.SHIPNO = SHIPNO
  IF !EMPTY(LOFORM.KBINVTKTNO.KEYTEXTBOX.VALUE) AND LOFORMSET.LOREC.CCOSTTYPE='M' AND LFLOTS(LOFORMSET,LOFORM)
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    *Old: SHOW GET loForm.cboLotNo.Value ENABLE  &&lower &&Revise
    LOFORM.CBOLOTNO.ENABLED = .T.
  ELSE
    *Old: SHOW GET loForm.cboLotNo.Value DISABLE  &&lower &&Revise
    LOFORM.CBOLOTNO.ENABLED = .F.
  ENDIF
  IF EMPTY(LOFORM.KBINVTKTNO.KEYTEXTBOX.VALUE)
    *Old: SHOW GET ibWIPAcnt   DISABLE &&Revise
    *Old: SHOW GET m.cApDGlAct DISABLE &&Revise
    LOFORM.GLAPDGLACT.ENABLED = .F.
  ELSE
    =LFUPDAPLTKT(LOFORMSET, LOFORM)
    *Old: SHOW GET ibWIPAcnt   ENABLE &&Revise
    *Old: SHOW GET m.cApDGlAct ENABLE &&Revise
    LOFORM.GLAPDGLACT.ENABLED = .T.
    *Old: SHOW GET ibTktNo    DISABLE &&Revise
    *Old: SHOW GET loForm.kbInvTktNo.KeyTextBox.Value DISABLE  &&lower &&Revise
    LOFORM.KBINVTKTNO.ENABLED = .F.
  ENDIF
ENDIF
LOFORMSET.LLBROWSE = .F.
LOFORM.KBINVTKTNO.SELECTEDFROMBROWSE = .F.

LOFORM.REFRESH()

RETURN
*-- End of lfvAplTkt


*!*************************************************************
*! Name      : lfIsContrib
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 09/02/2004
*! Purpose   : Check if this invoice line has been contrinuted
*!*************************************************************
*! Parameters:  The FormSet of APPYINV.SCX, The Form of APINVDT.SCX
*!*************************************************************
*! Returns   :  True/Flase
*!*************************************************************
FUNCTION LFISCONTRIB
LPARAMETERS LOFORMSET, LOFORM

PRIVATE LNALIAS
LNALIAS = SELECT()
SELECT (LOFORMSET.LCAPINVTKT)
LCTEMP = LOFORMSET.LCAPVINVDT+'.cVendCode+'+LOFORMSET.LCAPVINVDT+'.cApInvNo+'+;
  LOFORMSET.LCAPVINVDT+'.cApVILNo'
=SEEK(EVALUATE(LCTEMP))
LOCATE REST WHILE CVENDCODE+CAPINVNO+CAPVILNO=EVALUATE(LCTEMP) FOR !EMPTY(CRSESSION)
IF FOUND()
  *Message : 04174
  *This Invoice line has been contributed. Cannot Modify.
  *Button : 00000
  * Ok
  =GFMODALGEN("TRM04174B00000","DIALOG")
ENDIF
SELECT (LNALIAS)
RETURN (FOUND(LOFORMSET.LCAPINVTKT))
*-- End of lfIsContrib


*!*************************************************************
*! Name      : lfvLotNo
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 09/02/2004
*! Purpose   : Validate Operation Lot #
*!*************************************************************
*! Parameters:  The FormSet of APPYINV.SCX, The Form of APINVDT.SCX
*!*************************************************************
*! Returns   :  None
*!*************************************************************
FUNCTION LFVLOTNO
LPARAMETERS LOFORMSET, LOFORM

*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*!*	loForm.loRec.cLotNo = loForm.laOprLots[loForm.cboLotNo.Value]
*!*	IF loForm.loRec.cLotNo <> cLotNo
*!*	  REPLACE cLotNo  WITH loForm.loRec.cLotNo ,;
*!*	          cStatus WITH IIF(cStatus='S','M',cStatus)
LOFORMSET.LOREC.CLOTNO = LOFORMSET.LAOPRLOTS[loForm.cboLotNo.Value]
IF LOFORMSET.LOREC.CLOTNO <> CLOTNO
  REPLACE CLOTNO  WITH LOFORMSET.LOREC.CLOTNO ,;
    CSTATUS WITH IIF(CSTATUS='S','M',CSTATUS)
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
ENDIF
LOFORM.REFRESH()
RETURN
*-- End of lfvLotNo


*!*************************************************************
*! Name      : lfvTicket
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 09/02/2004
*! Purpose   : Validate Tickets
*!*************************************************************
*! Parameters:  The FormSet of APPYINV.SCX, The Form of APINVDT.SCX,
*!              lcType     : Ticket Type
*!                                   'S' : Shipment
*!                                   'I' : Style PO
*!                                   'R' : Style PO Return
*!                                   'M' : Style Cutting Ticket
*!                                   'L' : Material PO
*!                                   'F' : Material PO Return
*!                                   'T' : Material MFG Order
*!              lcTicket   : Ticket #
*!              lcLinkCode : WIP Link Code
*!              lcCstType  : Cost Type
*!*************************************************************
*! Returns   :  None
*!*************************************************************
FUNCTION LFVTICKET
PARAMETERS LOFORMSET, LOFORM, LCTYPE, LCTICKET, LCLINKCODE, LCCSTTYPE

PRIVATE LCBRFIELDS, LNALIAS, LCBUSDOC, LCWORKORDER, LCBROWSECURSOR, LCBROWSETITLE, ;
  LCBROWSETABLENAME, LCBROWSEINDEXEXPRESSION, LCBROWSEINDEXFIELDS, LCBROWSEINDEXNAME, ;
  LCBROWSEKEY, LCBROWSEALIASNAME, LCBROWSEFIELDS


LNALIAS = SELECT()
*Fix problem in AP Invoice lines that tax code applies to all lines[Begin]
LNVENDRECNO = RECNO('APVENDOR')
*Fix problem in AP Invoice lines that tax code applies to all lines[End]
DO CASE
  *Style Purchase Order
CASE INLIST(LCTYPE,'A','D','I','R')
  LCBUSDOC = IIF(LCTYPE='R','R','P')
  LCWORKORDER=IIF(INLIST(LCTYPE,'A','D'),LCTYPE,'P')
  LCBROWSECURSOR = LOFORMSET.POSHDR.LCCURSORVIEW
  *N000682,1 MMT 11/22/2012 Globalization changes[Start]
  *LCBROWSETITLE  = 'PO'
  LCBROWSETITLE  = IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_PO_TITLE,loFormSet.GetHeaderText("LANG_APPYINV_PO_TITLE",loFormSet.HeaderAlias))
  *N000682,1 11/20/2012 MMT Globlization changes[End]

  *N000682,1 MMT 11/22/2012 Globalization changes[END]
  LCBROWSETABLENAME = "POSHDR"
  LCBROWSEINDEXEXPRESSION = "CBUSDOCU+CSTYTYPE+PO"
  LCBROWSEINDEXFIELDS     = "CBUSDOCU,CSTYTYPE,PO"
  LCBROWSEINDEXNAME       = "POSHDR"
  LCBROWSEKEY             = LCBUSDOC + LCWORKORDER
  LCBROWSEALIASNAME       = LOFORMSET.POSHDR.LCCURSORVIEW
  *N000682,1 MMT 11/22/2012 Globalization changes[Start]
  *LCBROWSEFIELDS = "PO        :R:10:H='PO #' ,"+;
    "Status    :R: 3:H='S' ,"+;
    "Vendor    :R:10:H='Vendor' ,"+;
    "Entered   :R:12:H='Entered' ,"+;
    "Complete  :R:12:H='Complete' ,"+;
    "nStyOrder :R:10:H='Total Qty.' ,"+;
    "POTotal   :R:15:H='Amount' ,"+;
    "Receive   :R:10:H='Receive' ,"+;
    "Open      :R:10:H='Open' "
  LCBROWSEFIELDS = "PO        :R:10:H='"+IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_PO_NUMBER,loFormSet.GetHeaderText("LANG_APPYINV_PO_NUMBER",loFormSet.HeaderAlias))+"' ,"+;
    "Status    :R: 3:H='"+IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_S_PO,loFormSet.GetHeaderText("LANG_APPYINV_S_PO",loFormSet.HeaderAlias))+"' ,"+;
    "Vendor    :R:10:H='"+IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_S_VENDOR,loFormSet.GetHeaderText("LANG_APPYINV_S_VENDOR",loFormSet.HeaderAlias))+"' ,"+;
    "Entered   :R:12:H='"+IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_ENTERED,loFormSet.GetHeaderText("LANG_APPYINV_ENTERED",loFormSet.HeaderAlias))+"' ,"+;
    "Complete  :R:12:H='"+IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_COMPLETE,loFormSet.GetHeaderText("LANG_APPYINV_COMPLETE",loFormSet.HeaderAlias))+"' ,"+;
    "nStyOrder :R:10:H='"+IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_TOTALQTY,loFormSet.GetHeaderText("LANG_APPYINV_TOTALQTY",loFormSet.HeaderAlias))+"' ,"+;
    "POTotal   :R:15:H='"+IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_AMOUNT,loFormSet.GetHeaderText("LANG_APPYINV_AMOUNT",loFormSet.HeaderAlias))+"' ,"+;
    "Receive   :R:10:H='"+IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_RECEIVE,loFormSet.GetHeaderText("LANG_APPYINV_RECEIVE",loFormSet.HeaderAlias))+"' ,"+;
    "Open      :R:10:H='"+IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_OPEN,loFormSet.GetHeaderText("LANG_APPYINV_OPEN",loFormSet.HeaderAlias))+"' "


  *N000682,1 MMT 11/22/2012 Globalization changes[END]
  *Style Shipments
CASE LCTYPE = 'S'
  LCBUSDOC = 'P'
  LCWORKORDER='P'
  LCBROWSECURSOR = LOFORMSET.SHPMTHDR.LCCURSORVIEW
  *N000682,1 MMT 11/22/2012 Globalization changes[Start]
  *LCBROWSETITLE  = 'Shipment'
  LCBROWSETITLE  = IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_SHIPMENT,loFormSet.GetHeaderText("LANG_APPYINV_SHIPMENT",loFormSet.HeaderAlias))
  *N000682,1 11/20/2012 MMT Globlization changes[End]

  *N000682,1 MMT 11/22/2012 Globalization changes[END]
  LCBROWSETABLENAME = "SHPMTHDR"
  LCBROWSEINDEXEXPRESSION = "CBUSDOCU+CSHPTYPE+SHIPNO"
  LCBROWSEINDEXFIELDS     = "CBUSDOCU,CSHPTYPE,SHIPNO"
  LCBROWSEINDEXNAME       = "SHPMTHDR"
  LCBROWSEKEY             = LCBUSDOC + LCWORKORDER
  LCBROWSEALIASNAME       = LOFORMSET.SHPMTHDR.LCCURSORVIEW
  *N000682,1 MMT 11/22/2012 Globalization changes[Start]
  *LCBROWSEFIELDS = "ShipNo:H='Shipment #', Status, Entered:13, Cartons,"+;
    "AirWayB:H='Air-way Bill#', ETA:H='E.T.A.':13,"+;
    "TotQtyHdr:H='In-Transit', Recv_Stk:H='Received',"+;
    "Recv_Dam:H='Damaged', Recv_Can:H='Canceled',"+;
    "cVessel:h='Airline / Vessel' ,Reference"
  LCBROWSEFIELDS = "ShipNo:H='"+;
    IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_SHIPMENT_NO,loFormSet.GetHeaderText("LANG_APPYINV_SHIPMENT_NO",loFormSet.HeaderAlias))+;
	"', Status:H='"+;
	IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_STATUS,loFormSet.GetHeaderText("LANG_APPYINV_STATUS",loFormSet.HeaderAlias))+"', Entered:13:H='"+;
	IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_ENTERED,loFormSet.GetHeaderText("LANG_APPYINV_ENTERED",loFormSet.HeaderAlias))+"', Cartons:H='"+;
	IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_CARTONS,loFormSet.GetHeaderText("LANG_APPYINV_CARTONS",loFormSet.HeaderAlias))+"',"+;
    "AirWayB:H='"+IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_AIRWAYBIL,loFormSet.GetHeaderText("LANG_APPYINV_AIRWAYBIL",loFormSet.HeaderAlias))+;
	"', ETA:H='"+IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_ETA,loFormSet.GetHeaderText("LANG_APPYINV_ETA",loFormSet.HeaderAlias))+"':13,"+;
    "TotQtyHdr:H='"+IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_INTRANSIT,loFormSet.GetHeaderText("LANG_APPYINV_INTRANSIT",loFormSet.HeaderAlias))+;
	"', Recv_Stk:H='"+IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_RECEIVED,loFormSet.GetHeaderText("LANG_APPYINV_RECEIVED",loFormSet.HeaderAlias))+;
	"',"+;
    "Recv_Dam:H='"+IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_DAMAGED,loFormSet.GetHeaderText("LANG_APPYINV_DAMAGED",loFormSet.HeaderAlias))+;
	"', Recv_Can:H='"+IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_CANCELLED,loFormSet.GetHeaderText("LANG_APPYINV_CANCELLED",loFormSet.HeaderAlias))+"',"+;
"cVessel:h='"+IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_AIRLINEVESSEL,loFormSet.GetHeaderText("LANG_APPYINV_AIRLINEVESSEL",loFormSet.HeaderAlias))+"' ,Reference"


  *N000682,1 MMT 11/22/2012 Globalization changes[END]
  *Style Cutting Tickets
CASE LCTYPE = 'M'
  LCBUSDOC = 'P'
  LCWORKORDER='U'
  LCBROWSECURSOR = LOFORMSET.CUTTKTH.LCCURSORVIEW
  *N000682,1 MMT 11/22/2012 Globalization changes[Start]
  *LCBROWSETITLE  = 'PO'
  *N000682,1 11/20/2012 MMT Globlization changes[Start]
*LCBROWSETITLE  = LANG_APPYINV_CUTKT
LCBROWSETITLE  = IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_CUTKT,loFormSet.GetHeaderText("LANG_APPYINV_CUTKT",loFormSet.HeaderAlias))
*N000682,1 11/20/2012 MMT Globlization changes[End]

  *N000682,1 MMT 11/22/2012 Globalization changes[END]
  LCBROWSETABLENAME = "POSHDR"
  LCBROWSEINDEXEXPRESSION = "CBUSDOCU+CSTYTYPE+PO"
  LCBROWSEINDEXFIELDS     = "CBUSDOCU,CSTYTYPE,PO"
  LCBROWSEINDEXNAME       = "POSHDR"
  LCBROWSEKEY             = LCBUSDOC + LCWORKORDER
  LCBROWSEALIASNAME       = LOFORMSET.CUTTKTH.LCCURSORVIEW
  *N000682,1 MMT 11/22/2012 Globalization changes[Start]
  *LCBROWSEFIELDS = "PO  :H='Cutkt'   ,"+;
    "Style   :H='Style'   ,"+;
    "Status  :H='S'       ,"+;
    "Entered :H='Issue'   ,"+;
    "Complete:H='Complete',"+;
    "Season  :H='Se'      ,"+;
    "cDivision:H='Di'     ,"+;
    "NSTYORDER :H='Budget':P='999999',"+;
    "RECEIVE :H='Recvd' :P='999999',"+;
    "DAMAGE :H='Damged':P='999999',"+;
    "OPEN :H='Open'  :P='999999' "
  LCBROWSEFIELDS = "PO  :H='"+IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_CUTKT,loFormSet.GetHeaderText("LANG_APPYINV_CUTKT",loFormSet.HeaderAlias))+"'   ,"+;
    "Style   :H='"+IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_STYLENO,loFormSet.GetHeaderText("LANG_APPYINV_STYLENO",loFormSet.HeaderAlias))+"'   ,"+;
    "Status  :H='"+IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_S_PO,loFormSet.GetHeaderText("LANG_APPYINV_S_PO",loFormSet.HeaderAlias))+"'       ,"+;
    "Entered :H='"+IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_ISSUE,loFormSet.GetHeaderText("LANG_APPYINV_ISSUE",loFormSet.HeaderAlias)) +"'   ,"+;
    "Complete:H='"+IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_COMPLETE,loFormSet.GetHeaderText("LANG_APPYINV_COMPLETE",loFormSet.HeaderAlias))+"',"+;
    "Season  :H='"+IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_SE,loFormSet.GetHeaderText("LANG_APPYINV_SE",loFormSet.HeaderAlias))+"'      ,"+;
    "cDivision:H='"+IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_DI,loFormSet.GetHeaderText("LANG_APPYINV_DI",loFormSet.HeaderAlias))+"'     ,"+;
    "NSTYORDER :H='"+IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_BUDGET,loFormSet.GetHeaderText("LANG_APPYINV_BUDGET",loFormSet.HeaderAlias))+"':P='999999',"+;
    "RECEIVE :H='"+IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_RECVD,loFormSet.GetHeaderText("LANG_APPYINV_RECVD",loFormSet.HeaderAlias))+"' :P='999999',"+;
    "DAMAGE :H='"+IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_DAMGED,loFormSet.GetHeaderText("LANG_APPYINV_DAMGED",loFormSet.HeaderAlias))+"':P='999999',"+;
    "OPEN :H='"+IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_OPEN,loFormSet.GetHeaderText("LANG_APPYINV_OPEN",loFormSet.HeaderAlias))+"'  :P='999999' "


  *N000682,1 MMT 11/22/2012 Globalization changes[END]
  *Material Purchase Orders
CASE INLIST(LCTYPE,'L','F')
  LCBUSDOC = IIF(LCTYPE='F','R','P')
  LCWORKORDER='M'
  LCBROWSECURSOR = LOFORMSET.POFHDR.LCCURSORVIEW
  *N000682,1 MMT 11/22/2012 Globalization changes[Start]
  *LCBROWSETITLE  = 'PO'
  *N000682,1 11/20/2012 MMT Globlization changes[Start]
*LCBROWSETITLE  = LANG_APPYINV_PO_TITLE
LCBROWSETITLE  = IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_PO_TITLE,loFormSet.GetHeaderText("LANG_APPYINV_PO_TITLE",loFormSet.HeaderAlias))
*N000682,1 11/20/2012 MMT Globlization changes[End]

  *N000682,1 MMT 11/22/2012 Globalization changes[END]
  LCBROWSETABLENAME = "POSHDR"
  LCBROWSEINDEXEXPRESSION = "CBUSDOCU+CSTYTYPE+PO"
  LCBROWSEINDEXFIELDS     = "CBUSDOCU,CSTYTYPE,PO"
  LCBROWSEINDEXNAME       = "POSHDR"
  LCBROWSEKEY             = LCBUSDOC + LCWORKORDER
  LCBROWSEALIASNAME       = LOFORMSET.POFHDR.LCCURSORVIEW
  *N000682,1 MMT 11/22/2012 Globalization changes[Start]
  *LCBROWSEFIELDS = "PO        :R:10:H='PO #' ,"+;
    "Status    :R: 3:H='S' ,"+;
    "Vendor    :R:10:H='Vendor' ,"+;
    "Complete  :R:12:H='Complete' ,"+;
    "NSTYORDER :R:10:H='Total Qty.' ,"+;
    "POTotal   :R:15:H='Amount' ,"+;
    "Receive   :R:10:H='Receive' ,"+;
    "Open      :R:10:H='Open' "
  LCBROWSEFIELDS = "PO        :R:10:H='"+IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_PO_NUMBER,loFormSet.GetHeaderText("LANG_APPYINV_PO_NUMBER",loFormSet.HeaderAlias))+"' ,"+;
    "Status    :R: 3:H='"+IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_S_PO,loFormSet.GetHeaderText("LANG_APPYINV_S_PO",loFormSet.HeaderAlias))+"' ,"+;
    "Vendor    :R:10:H='"+IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_S_VENDOR,loFormSet.GetHeaderText("LANG_APPYINV_S_VENDOR",loFormSet.HeaderAlias))+"' ,"+;
    "Complete  :R:12:H='"+IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_COMPLETE,loFormSet.GetHeaderText("LANG_APPYINV_COMPLETE",loFormSet.HeaderAlias))+"' ,"+;
    "NSTYORDER :R:10:H='"+IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_TOTALQTY,loFormSet.GetHeaderText("LANG_APPYINV_TOTALQTY",loFormSet.HeaderAlias))+"' ,"+;
    "POTotal   :R:15:H='"+IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_AMOUNT,loFormSet.GetHeaderText("LANG_APPYINV_AMOUNT",loFormSet.HeaderAlias))+"' ,"+;
    "Receive   :R:10:H='"+IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_RECEIVED,loFormSet.GetHeaderText("LANG_APPYINV_RECEIVED",loFormSet.HeaderAlias))+"' ,"+;
   "Open      :R:10:H='"+IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_OPEN,loFormSet.GetHeaderText("LANG_APPYINV_OPEN",loFormSet.HeaderAlias))+"' "

*N000682,1 MMT 11/22/2012 Globalization changes[END]
  *Material MFG Orders
CASE LCTYPE = 'T'
  LCBUSDOC = 'P'
  LCWORKORDER='F'
  LCBROWSECURSOR = LOFORMSET.MMFGORDH.LCCURSORVIEW
  *N000682,1 MMT 11/22/2012 Globalization changes[Start]
  *LCBROWSETITLE  = 'PO'
  *N000682,1 11/20/2012 MMT Globlization changes[Start]
*LCBROWSETITLE  = LANG_APPYINV_PO_TITLE
LCBROWSETITLE  = IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_PO_TITLE,loFormSet.GetHeaderText("LANG_APPYINV_PO_TITLE",loFormSet.HeaderAlias))
*N000682,1 11/20/2012 MMT Globlization changes[End]

  *N000682,1 MMT 11/22/2012 Globalization changes[END]
  LCBROWSETABLENAME = "POSHDR"
  LCBROWSEINDEXEXPRESSION = "CBUSDOCU+CSTYTYPE+PO"
  LCBROWSEINDEXFIELDS     = "CBUSDOCU,CSTYTYPE,PO"
  LCBROWSEINDEXNAME       = "POSHDR"
  LCBROWSEKEY             = LCBUSDOC + LCWORKORDER
  LCBROWSEALIASNAME       = LOFORMSET.MMFGORDH.LCCURSORVIEW
  *N000682,1 MMT 11/22/2012 Globalization changes[Start]
  *LCBROWSEFIELDS = "PO:H='Order#',"+;
    "Style  :H='"+GFITEMMASK('HM','','0002')+"',"+;
    IIF(GFGETMEMVAR('M_WareHouse') = 'Y',;
    "cWareCode:H='Warehouse',","")+;
    "Status   :H='S',"+;
    "Entered  :H='Entered',"+;
    "Complete :H='Complete'"
  LCBROWSEFIELDS = "PO:H='"+IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_MAMFGORDERNO,loFormSet.GetHeaderText("LANG_APPYINV_MAMFGORDERNO",loFormSet.HeaderAlias))+"',"+;
    "Style  :H='"+GFITEMMASK('HM','','0002')+"',"+;
    IIF(GFGETMEMVAR('M_WareHouse') = 'Y',;
    "cWareCode:H='"+IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_WAREHOUSE,loFormSet.GetHeaderText("LANG_APPYINV_WAREHOUSE",loFormSet.HeaderAlias))+"',","")+;
    "Status   :H='"+IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_S_PO,loFormSet.GetHeaderText("LANG_APPYINV_S_PO",loFormSet.HeaderAlias))+"',"+;
    "Entered  :H='"+IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_ENTERED,loFormSet.GetHeaderText("LANG_APPYINV_ENTERED",loFormSet.HeaderAlias)) +"',"+;
    "Complete :H='"+IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_COMPLETE,loFormSet.GetHeaderText("LANG_APPYINV_COMPLETE",loFormSet.HeaderAlias))+"'"
*N000682,1 11/20/2012 MMT Globlization changes[End]

  *N000682,1 MMT 11/22/2012 Globalization changes[END]
ENDCASE

IF EMPTY(LCTICKET) OR ALLTRIM(LCTICKET)=='?' OR !LOFORMSET.&LCBROWSECURSOR..SEEK(LCBUSDOC+LCWORKORDER+LCTICKET)
  PRIVATE LLSELECTED
  SELECT (LCBROWSECURSOR)
  LLSELECTED = .F.
  LCSTR="DO FORM BROWSE WITH lcbrowsefields, lcbrowsetitle, lcBusDoc+lcWorkOrder, .F.,"+;
    ".F., .T., .F., .F., .F., .F., .F., .F., .F., .F., .F., .F., .F., lcBrowseTableName,"+;
    "'SQL', lcBrowseTableName, .F., lcBusDoc+lcWorkOrder+ALLTRIM(lcTicket)"+;
    "TO llSelected"
  GFEXECUTE(LCSTR)
  IF LLSELECTED
    LCTICKET = IIF(LCTYPE='S',EVALUATE(LCBROWSECURSOR+'.SHIPNO'),EVALUATE(LCBROWSECURSOR+'.PO'))
  ELSE
    LCTICKET = ""
  ENDIF
ENDIF

IF LCTYPE='S'
  LCLINKCODE = IIF(EMPTY(LCTICKET),SPACE(6),SUBSTR(LFGETGLLNK(LCTICKET,LOFORM.CNTSTYLE.VALUE,''),1,6))
ELSE
  LCLINKCODE = IIF(EMPTY(LCTICKET),SPACE(6),&LCBROWSECURSOR..LINK_CODE)
ENDIF

LCTICKET=IIF(LFCHKCSTCUR(LOFORMSET,LOFORM,LCTYPE,LCTICKET,LCCSTTYPE),LCTICKET,LOFORMSET.LCCUTTKTNO)

*Fix problem in AP Invoice lines that tax code applies to all lines[Begin]
SELECT APVENDOR
IF BETWEEN(LNVENDRECNO,1,RECCOUNT())
  GOTO (LNVENDRECNO)
ENDIF
*Fix problem in AP Invoice lines that tax code applies to all lines[End]

SELECT (LNALIAS)
RETURN
*-- End of lfvTicket


*!*************************************************************
*! Name      : lfChkCstCur
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 09/02/2004
*! Purpose   : Check Ticket Currency againest Invoice Currency
*!*************************************************************
*! Parameters: The FormSet of APPYINV.SCX, The Form of APINVDT.SCX,
*!                      lcTktType  : Ticket Type
*!                                   'S' : Shipment
*!                                   'I' : Style PO
*!                                   'R' : Style PO Return
*!                                   'M' : Style Cutting Ticket
*!                                   'L' : Material PO
*!                                   'F' : Material PO Return
*!                                   'T' : Material MFG Order
*!                                   'A' : Adorment Order
*!                                   'D' : Dying Order
*!                       lcTicket   : Ticket #
*!                       lcCstType  : Cost Type
*!*************************************************************
*! Returns   :  None
*!*************************************************************
FUNCTION LFCHKCSTCUR
LPARAMETERS LOFORMSET, LOFORM, LCTKTTYPE, LCTICKET, LCCSTTYPE
LOCAL LCSQLSTATEMENT, LNRESULT, LCALIAS
LCALIAS = ALIAS()

DO CASE
CASE INLIST(LCTKTTYPE,'S') AND !EMPTY(LCTICKET)
  IF LCCSTTYPE $ 'PD'
    *CBUSDOCU+CSTYTYPE+PO &&POSHDR
    *CBUSDOCU+CSTYTYPE+PO+CRSESSION+SHIPNO+CINVTYPE+STYLE+STR(LINENO,6)+TRANCD+CSTYGRADE &&POSREC
    LCSQLSTATEMENT = "SELECT POSHDR.* FROM POSHDR (INDEX=POSHDR), POSLN (INDEX=POSREC) WHERE "+;
      "POSHDR.CBUSDOCU='P' AND POSHDR.CSTYTYPE='P' AND "+;
      "POSLN.CBUSDOCU='P' AND POSLN.CSTYTYPE='P' AND POSHDR.PO=POSLN.PO AND "+;
      "POSLN.shipno='"+LCTICKET+"'"
    *-MT
    *lnResult=oAriaApplication.remotecompanydata.sqlrun(lcSqlStatement,'PoCursor','',;
    oAriaApplication.ActiveCompanyConStr,3,'SAVE',loForm.DATASESSIONID)
    LNRESULT=OARIAAPPLICATION.REMOTECOMPANYDATA.SQLRUN(LCSQLSTATEMENT,'PoCursor','',;
      OARIAAPPLICATION.ACTIVECOMPANYCONSTR,3,'SAVE',LOFORMSET.DATASESSIONID)
    *-MT
    IF LNRESULT<1
      OARIAAPPLICATION.REMOTECOMPANYDATA.CHECKRETRESULT("execute",LNRESULT,.T.)
      IF !EMPTY(LCALIAS)
        SELECT (LCALIAS)
      ENDIF
      *AIT WINDOW LINENO()
      RETURN .F.
    ENDIF

    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *!*	      SELECT * FROM PoCursor ;
    *!*	         WHERE IIF(lcCstType = 'P',cpricecur,cdutycur) <> loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value ;
    *!*	         INTO ARRAY laDummyArr &&Sql76: Must use SqlRun
    SELECT * FROM POCURSOR ;
      WHERE IIF(LCCSTTYPE = 'P',CPRICECUR,CDUTYCUR) <> LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.KEYTEXTBOX.VALUE ;
      INTO ARRAY LADUMMYARR &&Sql76: Must use SqlRun
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

    USE IN POCURSOR
    IF !EMPTY(LCALIAS)
      SELECT (LCALIAS)
    ENDIF
    IF _TALLY > 0
      *N000682,1 MMT 11/22/2012 Globalization changes[Start]
      *=GFMODALGEN(.F.,'DIALOG',.F.,.F.,;
        'Placing an invoice for a shipment that includes Purchase Orders with several currencies'+;
        'is not allowed. Please use the option to invoice by Purchase Orders.')
      =GFMODALGEN(.F.,'DIALOG',.F.,.F.,;
        IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_PLACINGINVOICE,loFormSet.GetHeaderText("LANG_APPYINV_PLACINGINVOICE",loFormSet.HeaderAlias))+;
IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_ALLOWED,loFormSet.GetHeaderText("LANG_APPYINV_ALLOWED",loFormSet.HeaderAlias)))
      *N000682,1 MMT 11/22/2012 Globalization changes[END]
      RETURN(.F.)
    ENDIF
  ENDIF

CASE INLIST(LCTKTTYPE,'I','R') AND !EMPTY(LCTICKET) AND LOFORMSET.POSHDR.SEEK(IIF(LCTKTTYPE='I','PP','RP')+LCTICKET) &&Sql77: Check Key
  IF POSHDR.STATUS = 'B'
    *Message : 04177
    *Purchase Order# 9999 has a 'BID' Status. Invoicing is not allowed
    *Button : 00000
    *Ok
    *N000682,1 MMT 11/22/2012 Globalization changes[Start]
    *=GFMODALGEN("TRM04177B00000","DIALOG",'Purchase Order')
    *N000682,1 11/20/2012 MMT Globlization changes[Start]
*=GFMODALGEN("TRM04177B00000","DIALOG",LANG_APPYINV_MSG_PO)
=GFMODALGEN("TRM04177B00000","DIALOG",IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_MSG_PO,loFormSet.GetHeaderText("LANG_APPYINV_MSG_PO",loFormSet.HeaderAlias)))
*N000682,1 11/20/2012 MMT Globlization changes[End]

    *N000682,1 MMT 11/22/2012 Globalization changes[END]
    RETURN(.F.)
  ENDIF
  IF LCTKTTYPE = 'I' AND POSHDR.STATUS = 'H'
    *Message : 04169
    *Cost Sheet has not been generated for Purchase Order.
    *Button : 00000
    *Ok
    *N000682,1 MMT 11/22/2012 Globalization changes[Start]
    *=GFMODALGEN("TRM04169B00000","DIALOG",'Purchase Order')
    *N000682,1 11/20/2012 MMT Globlization changes[Start]
*=GFMODALGEN("TRM04169B00000","DIALOG",LANG_APPYINV_MSG_PO)
=GFMODALGEN("TRM04169B00000","DIALOG",IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_MSG_PO,loFormSet.GetHeaderText("LANG_APPYINV_MSG_PO",loFormSet.HeaderAlias)))
*N000682,1 11/20/2012 MMT Globlization changes[End]

    *N000682,1 MMT 11/22/2012 Globalization changes[END]
    RETURN(.F.)
  ENDIF
  *Message : 04176
  *Purchase Order has been canceled.
  *Button : 00000
  *Ok
  *N000682,1 MMT 11/22/2012 Globalization changes[Start]
  *IF (POSHDR.STATUS='X' AND GFMODALGEN("TRM04176B00000","DIALOG",'Purchase Order|canceled')=1) OR ;
      (POSHDR.STATUS='S' AND GFMODALGEN("TRM04176B00000","DIALOG",'Purchase Order|closed')=1)
  IF (POSHDR.STATUS='X' AND GFMODALGEN("TRM04176B00000","DIALOG",IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_MSG_PO,loFormSet.GetHeaderText("LANG_APPYINV_MSG_PO",loFormSet.HeaderAlias))+'|'+IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_2_CANCELLED,loFormSet.GetHeaderText("LANG_APPYINV_2_CANCELLED",loFormSet.HeaderAlias)))=1) OR ;
(POSHDR.STATUS='S' AND GFMODALGEN("TRM04176B00000","DIALOG",IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_MSG_PO,loFormSet.GetHeaderText("LANG_APPYINV_MSG_PO",loFormSet.HeaderAlias))+'|'+IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_CLOSED,loFormSet.GetHeaderText("LANG_APPYINV_CLOSED",loFormSet.HeaderAlias)))=1)
*N000682,1 11/20/2012 MMT Globlization changes[End]

  *N000682,1 MMT 11/22/2012 Globalization changes[End]
    RETURN(.F.)
  ENDIF

  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *    IF lcCstType ='P' AND PADR(loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value,3) <> POSHDR.cPriceCur
  IF LCCSTTYPE ='P' AND PADR(LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.KEYTEXTBOX.VALUE,3) <> POSHDR.CPRICECUR
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    *Message : 04168
    *Only Purchase Orders with Price in xxxx are allowed.
    *Button : 00000
    *Ok
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *=gfModalGen("TRM04168B00000","DIALOG",'Purchase Orders|Price|'+loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value)
    *N000682,1 MMT 11/22/2012 Globalization changes[Start]
    *=GFMODALGEN("TRM04168B00000","DIALOG",'Purchase Orders|Price|'+LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.KEYTEXTBOX.VALUE)
    *N000682,1 11/20/2012 MMT Globlization changes[Start]
*=GFMODALGEN("TRM04168B00000","DIALOG",LANG_APPYINV_PO_M+'|'+LANG_APPYINV_PRICE+'|'+LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.KEYTEXTBOX.VALUE)
=GFMODALGEN("TRM04168B00000","DIALOG",IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_PO_M,loFormSet.GetHeaderText("LANG_APPYINV_PO_M",loFormSet.HeaderAlias))+'|'+IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_PRICE,loFormSet.GetHeaderText("LANG_APPYINV_PRICE",loFormSet.HeaderAlias))+'|'+LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.KEYTEXTBOX.VALUE)
*N000682,1 11/20/2012 MMT Globlization changes[End]

    *N000682,1 MMT 11/22/2012 Globalization changes[END]
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    RETURN(.F.)
  ENDIF
  *B608489,1 WAM 03/23/2008 Don't compare duty currency from POSHDR. Currency is saved in the BOMLINE table
  *!*	    IF lcCstType ='D' AND PADR(loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value,3) <> POSHDR.cDutyCur
  *!*	      *Message : 04168
  *!*	      *Only Purchase Orders with Duty in xxxx are allowed.
  *!*	      *Button : 00000
  *!*	      *Ok
  *!*	      =gfModalGen("TRM04168B00000","DIALOG",'Purchase Orders|Duty|'+loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value)
  *!*	      RETURN(.F.)
  *!*	    ENDIF
  *!*
  *!*	    *(Begin) Adding the checking of the invoice
  *!*	    *currency with the duty currency when selecting
  *!*	    *Misc. as the Misc. currency will be treated
  *!*	    *as the duty currency.
  *!*	    IF lcCstType ='M' AND PADR(loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value,3) <> POSHDR.cDutyCur
  *!*	      *-- Only Purchase Orders with Misc. in xxxx are allowed.
  *!*	      =gfModalGen("TRM04168B00000","DIALOG",'Purchase Orders|Misc.|'+loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value)
  *!*	      RETURN(.F.)
  *!*	    ENDIF
  *!*	    *Adding the checking of the invoice (End)
  *B608489,1 WAM 03/23/2008 (End)

  *! B610120,1 HIA 17/10/2012 T20121005.0001 - Aria4xp - AP - Error message applying invoice to Material Manufacturing order [Begin]
  IF lcCstType ='D'
    lcSQLSTATEMENT = "SELECT CCURRCODE FROM BOMLINE (INDEX=BOMLINE) WHERE "+;
                     "CIMTYP='"+LCTKTTYPE + "'  AND CTKTNO='"+LCTICKET+"' "+" AND CCATGTYP ='D'"

    lnRESULT = OARIAAPPLICATION.REMOTECOMPANYDATA.SQLRUN(LCSQLSTATEMENT,'BomLCurr','BOMLINE',;
      OARIAAPPLICATION.ACTIVECOMPANYCONSTR,3,'SAVE',LOFORMSET.DATASESSIONID)

    IF LNRESULT<1
      OARIAAPPLICATION.REMOTECOMPANYDATA.CHECKRETRESULT("execute",LNRESULT,.T.)
      RETURN .F.
    ENDIF

    SELECT 'BomLCurr'
    LOCATE
    IF EOF()
      RETURN .F.
    ENDIF
    IF BomLCurr.CCURRCODE <> PADR(LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.KEYTEXTBOX.VALUE,3)
      *N000682,1 MMT 11/22/2012 Globalization changes[Start]
      *=gfModalGen("TRM04168B00000","DIALOG",'Purchase Orders|Duty|'+PADR(LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.KEYTEXTBOX.VALUE,3))
      *N000682,1 11/20/2012 MMT Globlization changes[Start]
*=gfModalGen("TRM04168B00000","DIALOG",LANG_APPYINV_PO_M+'|'+LANG_APPYINV_DUTY+'|'+PADR(LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.KEYTEXTBOX.VALUE,3))
=gfModalGen("TRM04168B00000","DIALOG",IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_PO_M,loFormSet.GetHeaderText("LANG_APPYINV_PO_M",loFormSet.HeaderAlias))+'|'+IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_DUTY,loFormSet.GetHeaderText("LANG_APPYINV_DUTY",loFormSet.HeaderAlias))+'|'+PADR(LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.KEYTEXTBOX.VALUE,3))
*N000682,1 11/20/2012 MMT Globlization changes[End]

      *N000682,1 MMT 11/22/2012 Globalization changes[END]
      RETURN .F.
    ENDIF
  ENDIF
  *! B610120,1 HIA 17/10/2012 T20121005.0001 - Aria4xp - AP - Error message applying invoice to Material Manufacturing order [End]

CASE LCTKTTYPE ='M' AND !EMPTY(LCTICKET) AND LOFORMSET.CUTTKTH.SEEK('PU'+LCTICKET) &&Sql78: Check Key
  *Message : 04176
  *Cutting Ticket has been canceled.
  *Button : 00000
  *Ok
  *N000682,1 MMT 11/22/2012 Globalization changes[Start]
  *IF (CUTTKTH.STATUS='X' AND GFMODALGEN("TRM04176B00000","DIALOG",'Cutting Ticket|canceled')=1) OR ;
      (CUTTKTH.STATUS='S' AND GFMODALGEN("TRM04176B00000","DIALOG",'Cutting Ticket|closed')=1)
  IF (CUTTKTH.STATUS='X' AND GFMODALGEN("TRM04176B00000","DIALOG",IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_CUT_TKT,loFormSet.GetHeaderText("LANG_APPYINV_CUT_TKT",loFormSet.HeaderAlias)) +'|'+IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_2_CANCELLED,loFormSet.GetHeaderText("LANG_APPYINV_2_CANCELLED",loFormSet.HeaderAlias)))=1) OR ;
 (CUTTKTH.STATUS='S' AND GFMODALGEN("TRM04176B00000","DIALOG",IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_CUT_TKT,loFormSet.GetHeaderText("LANG_APPYINV_CUT_TKT",loFormSet.HeaderAlias)) +'|'+IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_CLOSED,loFormSet.GetHeaderText("LANG_APPYINV_CLOSED",loFormSet.HeaderAlias)) )=1)
*N000682,1 11/20/2012 MMT Globlization changes[End]

  *N000682,1 MMT 11/22/2012 Globalization changes[END]
    RETURN(.F.)
  ENDIF
  IF CUTTKTH.STATUS = 'H'
    *Message : 04169
    *Cost Sheet has not been generated for Cutting Ticket.
    *Button : 00000
    *Ok
    *N000682,1 MMT 11/22/2012 Globalization changes[Start]
    *=GFMODALGEN("TRM04169B00000","DIALOG",'Cutting Ticket')
    *N000682,1 11/20/2012 MMT Globlization changes[Start]
*=GFMODALGEN("TRM04169B00000","DIALOG",LANG_APPYINV_CUT_TKT)
=GFMODALGEN("TRM04169B00000","DIALOG",IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_CUT_TKT,loFormSet.GetHeaderText("LANG_APPYINV_CUT_TKT",loFormSet.HeaderAlias)))
*N000682,1 11/20/2012 MMT Globlization changes[End]

    *N000682,1 MMT 11/22/2012 Globalization changes[END]
    RETURN(.F.)
  ENDIF
CASE LCTKTTYPE ='T' AND !EMPTY(LCTICKET) AND LOFORMSET.MMFGORDH.SEEK('PF'+LCTICKET) &&Sql79: Check Key
  *Message : 04176
  *Material MFG Order has been canceled.
  *Button : 00000
  *Ok
  *N000682,1 MMT 11/22/2012 Globalization changes[Start]
  *IF (MMFGORDH.STATUS='X' AND GFMODALGEN("TRM04176B00000","DIALOG",'Material MFG Order'+'|'+'canceled')=1) OR ;
      (MMFGORDH.STATUS='S' AND GFMODALGEN("TRM04176B00000","DIALOG",'Material MFG Order|closed')=1)
  IF (MMFGORDH.STATUS='X' AND GFMODALGEN("TRM04176B00000","DIALOG",IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_MAMFGORDER,loFormSet.GetHeaderText("LANG_APPYINV_MAMFGORDER",loFormSet.HeaderAlias))+'|'+IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_2_CANCELLED,loFormSet.GetHeaderText("LANG_APPYINV_2_CANCELLED",loFormSet.HeaderAlias)))=1) OR ;
(MMFGORDH.STATUS='S' AND GFMODALGEN("TRM04176B00000","DIALOG",IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_MAMFGORDER,loFormSet.GetHeaderText("LANG_APPYINV_MAMFGORDER",loFormSet.HeaderAlias))+'|'+IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_CLOSED,loFormSet.GetHeaderText("LANG_APPYINV_CLOSED",loFormSet.HeaderAlias)))=1)


  *N000682,1 MMT 11/22/2012 Globalization changes[END]
    RETURN(.F.)
  ENDIF
  IF MMFGORDH.STATUS = 'H'
    *Message : 04169
    *Cost Sheet has not been generated for Material MFG Order.
    *Button : 00000
    *Ok
    *N000682,1 MMT 11/22/2012 Globalization changes[Start]
    *=GFMODALGEN("TRM04169B00000","DIALOG",'Material MFG Order')
    *N000682,1 11/20/2012 MMT Globlization changes[Start]
*=GFMODALGEN("TRM04169B00000","DIALOG",LANG_APPYINV_MAMFGORDER)
=GFMODALGEN("TRM04169B00000","DIALOG",IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_MAMFGORDER,loFormSet.GetHeaderText("LANG_APPYINV_MAMFGORDER",loFormSet.HeaderAlias)))
*N000682,1 11/20/2012 MMT Globlization changes[End]

    *N000682,1 MMT 11/22/2012 Globalization changes[END]
    RETURN(.F.)
  ENDIF
CASE INLIST(LCTKTTYPE,'L','F') AND !EMPTY(LCTICKET) AND LOFORMSET.POFHDR.SEEK(IIF(LCTKTTYPE='L','PM','RM')+LCTICKET) &&Sql80: Check Key
  IF POFHDR.STATUS = 'B'
    *Message : 04177
    *Purchase Order# 9999 has a 'BID' Status. Invoicing is not allowed
    *Button : 00000
    *Ok
    *N000682,1 MMT 11/22/2012 Globalization changes[Start]
    *=GFMODALGEN("TRM04177B00000","DIALOG",'Purchase Order')
    *N000682,1 11/20/2012 MMT Globlization changes[Start]
*=GFMODALGEN("TRM04177B00000","DIALOG",LANG_APPYINV_MSG_PO)
=GFMODALGEN("TRM04177B00000","DIALOG",IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_MSG_PO,loFormSet.GetHeaderText("LANG_APPYINV_MSG_PO",loFormSet.HeaderAlias)))
*N000682,1 11/20/2012 MMT Globlization changes[End]

    *N000682,1 MMT 11/22/2012 Globalization changes[END]
    RETURN(.F.)
  ENDIF
  *Message : 04176
  *Material Purchase Order has been canceled.
  *Button : 00000
  *Ok
  *N000682,1 MMT 11/22/2012 Globalization changes[Start]
  *IF (POFHDR.STATUS='X' AND GFMODALGEN("TRM04176B00000","DIALOG",'Material Purchase Order|canceled')=1) OR ;
      (POFHDR.STATUS='S' AND GFMODALGEN("TRM04176B00000","DIALOG",'Material Purchase Order|closed')=1)
  IF (POFHDR.STATUS='X' AND GFMODALGEN("TRM04176B00000","DIALOG",IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_MA_PO_ORDER,loFormSet.GetHeaderText("LANG_APPYINV_MA_PO_ORDER",loFormSet.HeaderAlias))+'|'+IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_2_CANCELLED,loFormSet.GetHeaderText("LANG_APPYINV_2_CANCELLED",loFormSet.HeaderAlias)))=1) OR ;
     (POFHDR.STATUS='S' AND GFMODALGEN("TRM04176B00000","DIALOG",IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_MA_PO_ORDER,loFormSet.GetHeaderText("LANG_APPYINV_MA_PO_ORDER",loFormSet.HeaderAlias))+'|'+IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_CLOSED,loFormSet.GetHeaderText("LANG_APPYINV_CLOSED",loFormSet.HeaderAlias)))=1)
*N000682,1 11/20/2012 MMT Globlization changes[End]

   *N000682,1 MMT 11/22/2012 Globalization changes[END]
    RETURN(.F.)
  ENDIF

  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *    IF lcCstType ='P' AND PADR(loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value,3) <> POFHDR.cPriceCur
  IF LCCSTTYPE ='P' AND PADR(LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.KEYTEXTBOX.VALUE,3) <> POFHDR.CPRICECUR
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    *Message : 04168
    *Only Purchase Orders with Price in xxxx are allowed.
    *Button : 00000
    *Ok
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *=gfModalGen("TRM04168B00000","DIALOG",'Purchase Orders|Price|'+loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value)
    *N000682,1 MMT 11/22/2012 Globalization changes[Start]
    *=GFMODALGEN("TRM04168B00000","DIALOG",'Purchase Orders|Price|'+LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.KEYTEXTBOX.VALUE)
    *N000682,1 11/20/2012 MMT Globlization changes[Start]
*=GFMODALGEN("TRM04168B00000","DIALOG",LANG_APPYINV_PO_M +'|'+LANG_APPYINV_PRICE+'|'+LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.KEYTEXTBOX.VALUE)
=GFMODALGEN("TRM04168B00000","DIALOG",IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_PO_M,loFormSet.GetHeaderText("LANG_APPYINV_PO_M",loFormSet.HeaderAlias)) +'|'+IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_PRICE,loFormSet.GetHeaderText("LANG_APPYINV_PRICE",loFormSet.HeaderAlias))+'|'+LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.KEYTEXTBOX.VALUE)
*N000682,1 11/20/2012 MMT Globlization changes[End]

    *N000682,1 MMT 11/22/2012 Globalization changes[END]
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    RETURN(.F.)
  ENDIF

  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *IF lcCstType ='D' AND PADR(loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value,3) <> POFHDR.cDutyCur
  IF LCCSTTYPE ='D' AND PADR(LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.KEYTEXTBOX.VALUE,3) <> POFHDR.CDUTYCUR
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    *Message : 04168
    *Only Purchase Orders with Duty in xxxx are allowed.
    *Button : 00000
    *Ok
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *=gfModalGen("TRM04168B00000","DIALOG",'Purchase Orders|Duty|'+loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value)
    *N000682,1 MMT 11/22/2012 Globalization changes[Start]
    *=GFMODALGEN("TRM04168B00000","DIALOG",'Purchase Orders|Duty|'+LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.KEYTEXTBOX.VALUE)
    *N000682,1 11/20/2012 MMT Globlization changes[Start]
*=GFMODALGEN("TRM04168B00000","DIALOG",LANG_APPYINV_PO_M+'|'+LANG_APPYINV_DUTY+'|'+LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.KEYTEXTBOX.VALUE)
=GFMODALGEN("TRM04168B00000","DIALOG",IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_PO_M,loFormSet.GetHeaderText("LANG_APPYINV_PO_M",loFormSet.HeaderAlias))+'|'+IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_DUTY,loFormSet.GetHeaderText("LANG_APPYINV_DUTY",loFormSet.HeaderAlias))+'|'+LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.KEYTEXTBOX.VALUE)
*N000682,1 11/20/2012 MMT Globlization changes[End]

    *N000682,1 MMT 11/22/2012 Globalization changes[END]
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    RETURN(.F.)
  ENDIF
  *(Begin) Adding the checking of the invoice
  *currency with the duty currency when selecting
  *Misc. as the Misc. currency will be treated
  *as the duty currency.
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *IF lcCstType ='M' AND PADR(loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value,3) <> POFHDR.cDutyCur
  IF LCCSTTYPE ='M' AND PADR(LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.KEYTEXTBOX.VALUE,3) <> POFHDR.CDUTYCUR
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    *-- Only Purchase Orders with Misc. in xxxx are allowed.
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *=gfModalGen("TRM04168B00000","DIALOG",'Purchase Orders|Misc.|'+loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value)
    *N000682,1 MMT 11/22/2012 Globalization changes[Start]
    *=GFMODALGEN("TRM04168B00000","DIALOG",'Purchase Orders|Misc.|'+LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.KEYTEXTBOX.VALUE)
    *N000682,1 11/20/2012 MMT Globlization changes[Start]
*=GFMODALGEN("TRM04168B00000","DIALOG",LANG_APPYINV_PO_M+'|'+LANG_APPYINV_MISC+'|'+LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.KEYTEXTBOX.VALUE)
=GFMODALGEN("TRM04168B00000","DIALOG",IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_PO_M,loFormSet.GetHeaderText("LANG_APPYINV_PO_M",loFormSet.HeaderAlias))+'|'+IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_MISC,loFormSet.GetHeaderText("LANG_APPYINV_MISC",loFormSet.HeaderAlias))+'|'+LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.KEYTEXTBOX.VALUE)
*N000682,1 11/20/2012 MMT Globlization changes[End]

    *N000682,1 MMT 11/22/2012 Globalization changes[END]
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    RETURN(.F.)
  ENDIF
  * Adding the checking of the invoice (End)

CASE INLIST(LCTKTTYPE,'D','A') AND !EMPTY(LCTICKET) AND LOFORMSET.POSHDR.SEEK('P'+LCTKTTYPE+LCTICKET) &&Sql81: Check Key
  LCDESC = IIF(LCTKTTYPE = 'D','Dying','Adorment')
  IF POSHDR.STATUS = 'B'
    *Message : 04177
    *Dying Order# 9999 has a 'BID' Status. Invoicing is not allowed
    *Button : 00000
    *Ok
    *N000682,1 MMT 11/22/2012 Globalization changes[Start]
    * =GFMODALGEN("TRM04177B00000","DIALOG",'Dying Order')
    *N000682,1 11/20/2012 MMT Globlization changes[Start]
*=GFMODALGEN("TRM04177B00000","DIALOG",LANG_APPYINV_DYEORDER)
=GFMODALGEN("TRM04177B00000","DIALOG",IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_DYEORDER,loFormSet.GetHeaderText("LANG_APPYINV_DYEORDER",loFormSet.HeaderAlias)))
*N000682,1 11/20/2012 MMT Globlization changes[End]

    *N000682,1 MMT 11/22/2012 Globalization changes[END]
    RETURN(.F.)
  ENDIF
  IF POSHDR.STATUS = 'H'
    *Message : 04169
    *Cost Sheet has not been generated for Dying Order.
    *Button : 00000
    *Ok
    *N000682,1 MMT 11/22/2012 Globalization changes[Start]
    *=GFMODALGEN("TRM04169B00000","DIALOG",LCDESC +' Order')
    *N000682,1 11/20/2012 MMT Globlization changes[Start]
*=GFMODALGEN("TRM04169B00000","DIALOG",LCDESC +LANG_APPYINV_S_ORDER)
=GFMODALGEN("TRM04169B00000","DIALOG",LCDESC +IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_S_ORDER,loFormSet.GetHeaderText("LANG_APPYINV_S_ORDER",loFormSet.HeaderAlias)))
*N000682,1 11/20/2012 MMT Globlization changes[End]

    *N000682,1 MMT 11/22/2012 Globalization changes[END]
    RETURN(.F.)
  ENDIF
  *Message : 04176
  *Dying Order has been canceled.
  *Button : 00000
  *Ok
  *N000682,1 MMT 11/22/2012 Globalization changes[Start]
  *IF (POSHDR.STATUS='X' AND GFMODALGEN("TRM04176B00000","DIALOG",LCDESC +' Order|canceled')=1) OR ;
  *    (POSHDR.STATUS='S' AND GFMODALGEN("TRM04176B00000","DIALOG",LCDESC +' Order|closed')=1)
  IF (POSHDR.STATUS='X' AND GFMODALGEN("TRM04176B00000","DIALOG",LCDESC +IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_S_ORDER,loFormSet.GetHeaderText("LANG_APPYINV_S_ORDER",loFormSet.HeaderAlias))+'|'+IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_2_CANCELLED,loFormSet.GetHeaderText("LANG_APPYINV_2_CANCELLED",loFormSet.HeaderAlias)))=1) OR ;
(POSHDR.STATUS='S' AND GFMODALGEN("TRM04176B00000","DIALOG",LCDESC +IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_S_ORDER,loFormSet.GetHeaderText("LANG_APPYINV_S_ORDER",loFormSet.HeaderAlias))+'|'+IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_CLOSED,loFormSet.GetHeaderText("LANG_APPYINV_CLOSED",loFormSet.HeaderAlias)))=1)
*N000682,1 11/20/2012 MMT Globlization changes[End]

  *N000682,1 MMT 11/22/2012 Globalization changes[end]
    RETURN(.F.)
  ENDIF
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *IF lcCstType ='P' AND PADR(loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value,3) <> POSHDR.cPriceCur
  IF LCCSTTYPE ='P' AND PADR(LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.KEYTEXTBOX.VALUE,3) <> POSHDR.CPRICECUR
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    *Message : 04168
    *Only Purchase Orders with Price in xxxx are allowed.
    *Button : 00000
    *Ok
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *=gfModalGen("TRM04168B00000","DIALOG",lcDesc +' Orders|Price|'+loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value)
    *N000682,1 MMT 11/22/2012 Globalization changes[Start]
    *=GFMODALGEN("TRM04168B00000","DIALOG",LCDESC +' Orders|Price|'+LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.KEYTEXTBOX.VALUE)
    *N000682,1 11/20/2012 MMT Globlization changes[Start]
*=GFMODALGEN("TRM04168B00000","DIALOG",LCDESC +LANG_APPYINV_S_ORDER+'|'+LANG_APPYINV_PRICE+'|'+LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.KEYTEXTBOX.VALUE)
=GFMODALGEN("TRM04168B00000","DIALOG",LCDESC +IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_S_ORDER,loFormSet.GetHeaderText("LANG_APPYINV_S_ORDER",loFormSet.HeaderAlias))+'|'+IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_PRICE,loFormSet.GetHeaderText("LANG_APPYINV_PRICE",loFormSet.HeaderAlias))+'|'+LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.KEYTEXTBOX.VALUE)
*N000682,1 11/20/2012 MMT Globlization changes[End]

    *N000682,1 MMT 11/22/2012 Globalization changes[END]
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    RETURN(.F.)
  ENDIF
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *IF lcCstType ='D' AND PADR(loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value,3) <> POSHDR.cDutyCur
  IF LCCSTTYPE ='D' AND PADR(LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.KEYTEXTBOX.VALUE,3) <> POSHDR.CDUTYCUR
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    *Message : 04168
    *Only Purchase Orders with Duty in xxxx are allowed.
    *Button : 00000
    *Ok
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *=gfModalGen("TRM04168B00000","DIALOG",lcDesc +' Orders|Duty|'+loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value)
    *N000682,1 MMT 11/22/2012 Globalization changes[Start]
    *=GFMODALGEN("TRM04168B00000","DIALOG",LCDESC +' Orders|Duty|'+LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.KEYTEXTBOX.VALUE)
    *N000682,1 11/20/2012 MMT Globlization changes[Start]
*=GFMODALGEN("TRM04168B00000","DIALOG",LCDESC +LANG_APPYINV_S_ORDER+'|'+LANG_APPYINV_DUTY +'|'+LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.KEYTEXTBOX.VALUE)
=GFMODALGEN("TRM04168B00000","DIALOG",LCDESC +IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_S_ORDER,loFormSet.GetHeaderText("LANG_APPYINV_S_ORDER",loFormSet.HeaderAlias))+'|'+IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_DUTY,loFormSet.GetHeaderText("LANG_APPYINV_DUTY",loFormSet.HeaderAlias)) +'|'+LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.KEYTEXTBOX.VALUE)
*N000682,1 11/20/2012 MMT Globlization changes[End]

    *N000682,1 MMT 11/22/2012 Globalization changes[end]
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    RETURN(.F.)
  ENDIF
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *IF lcCstType ='M' AND PADR(loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value,3) <> POSHDR.cDutyCur
  IF LCCSTTYPE ='M' AND PADR(LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.KEYTEXTBOX.VALUE,3) <> POSHDR.CDUTYCUR
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    *-- Only Dying Orders with Misc. in xxxx are allowed.
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *=gfModalGen("TRM04168B00000","DIALOG",lcDesc +' Orders|Misc.|'+loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value)
    *N000682,1 MMT 11/22/2012 Globalization changes[Start]
    *=GFMODALGEN("TRM04168B00000","DIALOG",LCDESC +' Orders|Misc.|'+LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.KEYTEXTBOX.VALUE)
    *N000682,1 11/20/2012 MMT Globlization changes[Start]
*=GFMODALGEN("TRM04168B00000","DIALOG",LCDESC +LANG_APPYINV_S_ORDER+'|'+LANG_APPYINV_MISC +'|'+LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.KEYTEXTBOX.VALUE)
=GFMODALGEN("TRM04168B00000","DIALOG",LCDESC +IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_S_ORDER,loFormSet.GetHeaderText("LANG_APPYINV_S_ORDER",loFormSet.HeaderAlias))+'|'+IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_MISC,loFormSet.GetHeaderText("LANG_APPYINV_MISC",loFormSet.HeaderAlias)) +'|'+LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.KEYTEXTBOX.VALUE)
*N000682,1 11/20/2012 MMT Globlization changes[End]

    *N000682,1 MMT 11/22/2012 Globalization changes[END]
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    RETURN(.F.)
  ENDIF
ENDCASE

RETURN
*-- End of lfChkCstCur


*!*************************************************************
*! Name      : lfvInvPrice
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 09/02/2004
*! Purpose   : Invoice Price
*!*************************************************************
*! Parameters:  The FormSet of APPYINV.SCX, The Form of APINVDT.SCX
*!*************************************************************
*! Returns   :  None
*!*************************************************************
FUNCTION LFVINVPRICE
LPARAMETERS LOFORMSET, LOFORM
*Fix bug when Saving the debit memo againest Return PO [BEGIN]
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*!*	IF (loForm.loRec.cIMTyp $ 'RF' OR loFormSet.llDebitM) AND (loForm.loRec.nAPPrice > 0)
*!*	  loForm.loRec.nAPPrice = loForm.loRec.nAPPrice * -1
IF (LOFORMSET.LOREC.CIMTYP $ 'RF' OR LOFORMSET.LLDEBITM) AND (LOFORMSET.LOREC.NAPPRICE > 0)
  LOFORMSET.LOREC.NAPPRICE = LOFORMSET.LOREC.NAPPRICE * -1
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
ENDIF
*Fix bug when Saving the debit memo againest Return PO [END]
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*IF loForm.loRec.nAPPrice <> nAPPrice
SELECT(IIF(LOFORMSET.ACTIVEMODE="V",'APVINVDT2',LOFORMSET.LCAPVINVDT))
IF LOFORMSET.LOREC.NAPPRICE <> NAPPRICE
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  *Add these lines to make sure that the "Invoice Unit Cost" and
  *the "Approved Unit Cost" have the same sign [Begin]

  *-- If the "Invoice Unit Cost" and the "Approved Unit Cost" have
  *-- different signs
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	  IF SIGN(loForm.loRec.nAPPrice) <> 0 .AND. SIGN(loForm.loRec.nAPAprPric) <> 0 .AND.;
  *!*	     SIGN(loForm.loRec.nAPPrice) <> SIGN(loForm.loRec.nAPAprPric)
  IF SIGN(LOFORMSET.LOREC.NAPPRICE) <> 0 .AND. SIGN(LOFORMSET.LOREC.NAPAPRPRIC) <> 0 .AND.;
      SIGN(LOFORMSET.LOREC.NAPPRICE) <> SIGN(LOFORMSET.LOREC.NAPAPRPRIC)
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    *-- Message : 04187
    *-- "Invoice unit cost and approved unit cost must have the same sign."
    *-- Button : 00000
    *-- "                          <    Ok    >                           "
    =GFMODALGEN('TRM04187B00000' , 'ALERT')
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *loForm.loRec.nAPPrice = nAPPrice        && Restore the old value
    LOFORMSET.LOREC.NAPPRICE = NAPPRICE        && Restore the old value
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    RETURN
  ENDIF
  *Add these lines to make sure that the "Invoice Unit Cost" [End]
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	  loForm.loRec.nAPAprPric = IIF(loForm.llDefAuApr,loForm.loRec.nAPPrice,loForm.loRec.nAPAprPric)
  *!*	  loForm.loRec.nAPAprPric = IIF(lfChkAplTkt(loFormSet,loForm,''),loForm.loRec.nAPAprPric,nAPAprPric)
  *!*	  loForm.loRec.nApAmnt    = loForm.loRec.nAPTotQty*loForm.loRec.nAPPrice
  *!*	  loForm.loRec.nAPAprAmnt = loForm.loRec.nApTAprQty*loForm.loRec.nAPAprPric
  LOFORMSET.LOREC.NAPAPRPRIC = IIF(LOFORM.LLDEFAUAPR,LOFORMSET.LOREC.NAPPRICE,LOFORMSET.LOREC.NAPAPRPRIC)
  LOFORMSET.LOREC.NAPAPRPRIC = IIF(LFCHKAPLTKT(LOFORMSET,LOFORM,''),LOFORMSET.LOREC.NAPAPRPRIC,NAPAPRPRIC)
  LOFORMSET.LOREC.NAPAMNT    = LOFORMSET.LOREC.NAPTOTQTY*LOFORMSET.LOREC.NAPPRICE
  LOFORMSET.LOREC.NAPAPRAMNT = LOFORMSET.LOREC.NAPTAPRQTY*LOFORMSET.LOREC.NAPAPRPRIC
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

  *Fix bug when Saving the debit memo againest Return PO [BEGIN]

  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	  loFormSet.lnTInvAmt = loFormSet.lnTInvAmt + (ROUND(loForm.loRec.nApAmnt,2) - ROUND(nAPAMnt,2))
  *!*	  loFormSet.lnTAprAmt = loFormSet.lnTAprAmt + (ROUND(loForm.loRec.nAPAprAmnt,2)- ROUND(nApAprAmnt,2))
  LOFORMSET.LNTINVAMT = LOFORMSET.LNTINVAMT + (ROUND(LOFORMSET.LOREC.NAPAMNT,2) - ROUND(NAPAMNT,2))
  LOFORMSET.LNTAPRAMT = LOFORMSET.LNTAPRAMT + (ROUND(LOFORMSET.LOREC.NAPAPRAMNT,2)- ROUND(NAPAPRAMNT,2))
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

  *Fix bug when Saving the debit memo againest Return PO [END]

  *=lfRefresh('APINVD10')
  *Fix bug when Saving the debit memo againest Return PO [BEGIN]
  PRIVATE LNDIFFAMNT

  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	  lnDiffAmnt =  (ROUND(loForm.loRec.nApAmnt,2) - ROUND(nAPAMnt,2)) * IIF((loForm.loRec.cIMTyp $ 'RF'),1,IIF(loFormSet.llDebitM,-1,1))
  *!*	  =lfUpdApDist(loFormSet,loForm,cApVILNo,lnDiffAmnt,cApDGlAct,loForm.loRec.cIMTyp)
  LNDIFFAMNT =  (ROUND(LOFORMSET.LOREC.NAPAMNT,2) - ROUND(NAPAMNT,2)) * IIF((LOFORMSET.LOREC.CIMTYP $ 'RF'),1,IIF(LOFORMSET.LLDEBITM,-1,1))
  =LFUPDAPDIST(LOFORMSET,LOFORM,CAPVILNO,LNDIFFAMNT,CAPDGLACT,LOFORMSET.LOREC.CIMTYP)
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

  *Fix bug when Saving the debit memo againest Return PO [END]

  =IIF(LOFORM.LLDEFAUAPR,LFUPDAPLTKT(LOFORMSET, LOFORM),.T.)

  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	  REPLACE nAPPrice   WITH loForm.loRec.nAPPrice   ,;
  *!*	          nAPAprPric WITH loForm.loRec.nAPAprPric ,;
  *!*	          nApAmnt    WITH loForm.loRec.nApAmnt    ,;
  *!*	          nAPAprAmnt WITH loForm.loRec.nAPAprAmnt ,;
  *!*	          cStatus  WITH IIF(cStatus='S','M',cStatus)
  REPLACE NAPPRICE   WITH LOFORMSET.LOREC.NAPPRICE   ,;
    NAPAPRPRIC WITH LOFORMSET.LOREC.NAPAPRPRIC ,;
    NAPAMNT    WITH LOFORMSET.LOREC.NAPAMNT    ,;
    NAPAPRAMNT WITH LOFORMSET.LOREC.NAPAPRAMNT ,;
    CSTATUS  WITH IIF(CSTATUS='S','M',CSTATUS)
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  *Old: SHOW GET loForm.loRec.nApAmnt ENABLE &&Revise
  LOFORM.TXTAPAMNT.ENABLED = .T.
  IF LOFORM.LLDEFEDAPR  &&lower
    *Old: SHOW GET loForm.loRec.nAPAprPric ENABLE &&Revise
    *Old: SHOW GET loForm.loRec.nAPAprAmnt ENABLE &&Revise
    STORE .T. TO LOFORM.TXTAPAPRPRIC.ENABLED, LOFORM.TXTAPAPRAMNT.ENABLED
  ELSE
    *Old: SHOW GET loForm.loRec.nAPAprPric DISABLE &&Revise
    *Old: SHOW GET loForm.loRec.nAPAprAmnt DISABLE &&Revise
    STORE .F. TO LOFORM.TXTAPAPRPRIC.ENABLED, LOFORM.TXTAPAPRAMNT.ENABLED
  ENDIF
ENDIF
LOFORM.REFRESH()

RETURN
*-- End of lfvInvPrice


*!*************************************************************
*! Name      : lfvAprPrice
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 09/02/2004
*! Purpose   : Invoice Approved Price
*!*************************************************************
*! Parameters:  The FormSet of APPYINV.SCX, The Form of APINVDT.SCX
*!*************************************************************
*! Returns   :  None
*!*************************************************************
FUNCTION LFVAPRPRICE
LPARAMETERS LOFORMSET, LOFORM

*Fix bug when Saving the debit memo againest Return PO [BEGIN]
*! E302623,3 MMT 01/03/2010 Convert Payable invoice screen to use SQL tables[Start]
SELECT(IIF(LOFORMSET.ACTIVEMODE="V",'APVINVDT2',LOFORMSET.LCAPVINVDT))
*! E302623,3 MMT 01/03/2010 Convert Payable invoice screen to use SQL tables[End]
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*!*	IF (loForm.loRec.cIMTyp $ 'RF' OR loFormSet.llDebitM) AND (loForm.loRec.nAPAprPric > 0)
*!*	  loForm.loRec.nAPAprPric = loForm.loRec.nAPAprPric * -1
IF (LOFORMSET.LOREC.CIMTYP $ 'RF' OR LOFORMSET.LLDEBITM) AND (LOFORMSET.LOREC.NAPAPRPRIC > 0)
  LOFORMSET.LOREC.NAPAPRPRIC = LOFORMSET.LOREC.NAPAPRPRIC * -1
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
ENDIF
*Fix bug when Saving the debit memo againest Return PO [END]

*Fix bug when Saving the debit memo againest Return PO [BEGIN]

*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*IF ABS((loForm.loRec.nAPAprPric * loForm.loRec.nApTAprQty)) > ABS(loForm.loRec.nApAmnt)
IF ABS((LOFORMSET.LOREC.NAPAPRPRIC * LOFORMSET.LOREC.NAPTAPRQTY)) > ABS(LOFORMSET.LOREC.NAPAMNT)
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

  =GFMODALGEN(.F.,'DIALOG',.F.,.F.,'The approved amount should be less than or equal to the invoice amount')
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *loForm.loRec.nAPAprPric = nAPAprPric
  LOFORMSET.LOREC.NAPAPRPRIC = NAPAPRPRIC
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[END]
  RETURN
ENDIF
*Fix bug when Saving the debit memo againest Return PO [END]

*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*loForm.loRec.nAPAprPric = IIF(lfChkAplTkt(loFormSet,loForm,''),loForm.loRec.nAPAprPric,nAPAprPric)
*IF loForm.loRec.nAPAprPric <> nAPAprPric
LOFORMSET.LOREC.NAPAPRPRIC = IIF(LFCHKAPLTKT(LOFORMSET,LOFORM,''),LOFORMSET.LOREC.NAPAPRPRIC,NAPAPRPRIC)
IF LOFORMSET.LOREC.NAPAPRPRIC <> NAPAPRPRIC
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  *Add these lines to make sure that the "Invoice Unit Cost" and
  *          the "Approved Unit Cost" have the same sign [Begin]

  *-- If the "Invoice Unit Cost" and the "Approved Unit Cost" have
  *-- different signs
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	  IF SIGN(loForm.loRec.nAPPrice) <> 0 .AND. SIGN(loForm.loRec.nAPAprPric) <> 0 .AND.;
  *!*	     SIGN(loForm.loRec.nAPPrice) <> SIGN(loForm.loRec.nAPAprPric)
  IF SIGN(LOFORMSET.LOREC.NAPPRICE) <> 0 .AND. SIGN(LOFORMSET.LOREC.NAPAPRPRIC) <> 0 .AND.;
      SIGN(LOFORMSET.LOREC.NAPPRICE) <> SIGN(LOFORMSET.LOREC.NAPAPRPRIC)
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[END]
    *-- Message : 04187
    *-- "Invoice unit cost and approved unit cost must have the same sign."
    *-- Button : 00000
    *-- "                          <    Ok    >                           "
    =GFMODALGEN('TRM04187B00000' , 'ALERT')
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    * loForm.loRec.nAPAprPric = nAPAprPric        && Restore the old value
    LOFORMSET.LOREC.NAPAPRPRIC = NAPAPRPRIC        && Restore the old value
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    RETURN
  ENDIF
  *Add these lines to make sure that the "Invoice Unit Cost" [End]
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	  loForm.loRec.nAPAprAmnt = loForm.loRec.nApTAprQty*loForm.loRec.nAPAprPric
  *!*	  loFormSet.lnTAprAmt    = loFormSet.lnTAprAmt  + (ROUND(loForm.loRec.nAPAprAmnt,2) - ROUND(nApAprAmnt,2))
  LOFORMSET.LOREC.NAPAPRAMNT = LOFORMSET.LOREC.NAPTAPRQTY*LOFORMSET.LOREC.NAPAPRPRIC
  LOFORMSET.LNTAPRAMT    = LOFORMSET.LNTAPRAMT  + (ROUND(LOFORMSET.LOREC.NAPAPRAMNT,2) - ROUND(NAPAPRAMNT,2))
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

  *=lfRefresh('APINVD10')
  =LFUPDAPLTKT(LOFORMSET, LOFORM)

  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	  REPLACE nAPAprPric WITH loForm.loRec.nAPAprPric ,;
  *!*	          nAPAprAmnt WITH loForm.loRec.nAPAprAmnt ,;
  *!*	          cStatus  WITH IIF(cStatus='S','M',cStatus)
  REPLACE NAPAPRPRIC WITH LOFORMSET.LOREC.NAPAPRPRIC ,;
    NAPAPRAMNT WITH LOFORMSET.LOREC.NAPAPRAMNT ,;
    CSTATUS  WITH IIF(CSTATUS='S','M',CSTATUS)
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  *Old: SHOW GET loForm.loRec.nAPAprAmnt ENABLE &&Revise
  LOFORM.TXTAPAPRAMNT.ENABLED = .T.
  *SHOW WINDOW (lcInvDtBr) REFRESH SAME
ENDIF
LOFORM.REFRESH()

RETURN
*-- End of lfvAprPrice


*!*************************************************************
*! Name      : lfvInvTQty
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 09/02/2004
*! Purpose   : Invoice line total Quantity
*!*************************************************************
*! Parameters:  The FormSet of APPYINV.SCX, The Form of APINVDT.SCX
*!*************************************************************
*! Returns   :  None
*!*************************************************************
FUNCTION LFVINVTQTY
LPARAMETERS LOFORMSET, LOFORM

*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*!*	IF loForm.loRec.nAPTotQty <> nAPTotQty
*!*	  loForm.loRec.nApTAprQty = IIF(loForm.llDefAuApr,loForm.loRec.nAPTotQty,loForm.loRec.nApTAprQty)
*!*	  loForm.loRec.nApTAprQty = IIF(lfChkAplTkt(loFormSet,loForm,''),loForm.loRec.nApTAprQty,nApTAprQty)
*!*	  loForm.loRec.nApAmnt    = loForm.loRec.nAPTotQty*loForm.loRec.nAPPrice
*!*	  loForm.loRec.nAPAprAmnt = loForm.loRec.nApTAprQty*loForm.loRec.nAPAprPric
*!*	  loFormSet.lnTInvAmt = loFormSet.lnTInvAmt + (ROUND(loForm.loRec.nApAmnt,2) - ROUND(nAPAMnt,2))*IIF(loForm.loRec.cIMTyp $ 'RF',-1,1)
*!*	  loFormSet.lnTAprAmt = loFormSet.lnTAprAmt + (ROUND(loForm.loRec.nAPAprAmnt,2)- ROUND(nApAprAmnt,2))*IIF(loForm.loRec.cIMTyp $ 'RF',-1,1)

*! E302623,3 MMT 01/03/2010 Convert Payable invoice screen to use SQL tables[Start]
SELECT(IIF(LOFORMSET.ACTIVEMODE="V",'APVINVDT2',LOFORMSET.LCAPVINVDT))
*! E302623,3 MMT 01/03/2010 Convert Payable invoice screen to use SQL tables[End]
IF LOFORMSET.LOREC.NAPTOTQTY <> NAPTOTQTY
  LOFORMSET.LOREC.NAPTAPRQTY = IIF(LOFORM.LLDEFAUAPR,LOFORMSET.LOREC.NAPTOTQTY,LOFORMSET.LOREC.NAPTAPRQTY)
  LOFORMSET.LOREC.NAPTAPRQTY = IIF(LFCHKAPLTKT(LOFORMSET,LOFORM,''),LOFORMSET.LOREC.NAPTAPRQTY,NAPTAPRQTY)
  LOFORMSET.LOREC.NAPAMNT    = LOFORMSET.LOREC.NAPTOTQTY*LOFORMSET.LOREC.NAPPRICE
  LOFORMSET.LOREC.NAPAPRAMNT = LOFORMSET.LOREC.NAPTAPRQTY*LOFORMSET.LOREC.NAPAPRPRIC
  LOFORMSET.LNTINVAMT = LOFORMSET.LNTINVAMT + (ROUND(LOFORMSET.LOREC.NAPAMNT,2) - ROUND(NAPAMNT,2))*IIF(LOFORMSET.LOREC.CIMTYP $ 'RF',-1,1)
  LOFORMSET.LNTAPRAMT = LOFORMSET.LNTAPRAMT + (ROUND(LOFORMSET.LOREC.NAPAPRAMNT,2)- ROUND(NAPAPRAMNT,2))*IIF(LOFORMSET.LOREC.CIMTYP $ 'RF',-1,1)
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

  *=lfRefresh('APINVD10')
  PRIVATE LNDIFFAMNT
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	  lnDiffAmnt =  (ROUND(loForm.loRec.nApAmnt,2) - ROUND(nAPAMnt,2)) * IIF((loForm.loRec.cIMTyp $ 'RF'),1,IIF(loFormSet.llDebitM,-1,1))
  *!*	  =lfUpdApDist(loFormSet,loForm,cApVILNo,lnDiffAmnt,cApDGlAct,loForm.loRec.cIMTyp)
  LNDIFFAMNT =  (ROUND(LOFORMSET.LOREC.NAPAMNT,2) - ROUND(NAPAMNT,2)) * IIF((LOFORMSET.LOREC.CIMTYP $ 'RF'),1,IIF(LOFORMSET.LLDEBITM,-1,1))
  =LFUPDAPDIST(LOFORMSET,LOFORM,CAPVILNO,LNDIFFAMNT,CAPDGLACT,LOFORMSET.LOREC.CIMTYP)
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

  =IIF(LOFORM.LLDEFAUAPR,LFUPDAPLTKT(LOFORMSET, LOFORM),.T.)
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	  REPLACE nAPTotQty  WITH loForm.loRec.nAPTotQty  ,;
  *!*	          nApTAprQty WITH loForm.loRec.nApTAprQty ,;
  *!*	          nApAmnt    WITH loForm.loRec.nApAmnt    ,;
  *!*	          nAPAprAmnt WITH loForm.loRec.nAPAprAmnt ,;
  *!*	          cStatus  WITH IIF(cStatus='S','M',cStatus)
  REPLACE NAPTOTQTY  WITH LOFORMSET.LOREC.NAPTOTQTY  ,;
    NAPTAPRQTY WITH LOFORMSET.LOREC.NAPTAPRQTY ,;
    NAPAMNT    WITH LOFORMSET.LOREC.NAPAMNT    ,;
    NAPAPRAMNT WITH LOFORMSET.LOREC.NAPAPRAMNT ,;
    CSTATUS  WITH IIF(CSTATUS='S','M',CSTATUS)
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  *Old: SHOW GET loForm.loRec.nApAmnt ENABLE &&Revise
  LOFORM.TXTAPAMNT.ENABLED = .T.
  IF LOFORM.LLDEFEDAPR

    *B602830,1 Change this line because we are going to switch between 2 Get
    *          Fields for the "Approve Quantity" to be able to add the
    *          decimal points to the "Approve Quantity" in the case of
    *          document types Material PO, Material PO Return and
    *          Material MFG Order [Begin]
    *SHOW GET loForm.loRec.nApTAprQty ENABLE
    LOFORM.TXTAPTAPRQTY.ENABLED = .T.
    *SHOW OBJECT loFormSet.lnApQtyObj ENABLE
    *B602830,1 Change this line because we are going to switch between 2 [End]

    *Old: SHOW GET loForm.loRec.nAPAprAmnt ENABLE &&Revise
    LOFORM.TXTAPAPRAMNT.ENABLED = .T.
  ELSE

    *B602830,1 Change this line because we are going to switch between 2 Get
    *          Fields for the "Approve Quantity" to be able to add the
    *          decimal points to the "Approve Quantity" in the case of
    *          document types Material PO, Material PO Return and
    *          Material MFG Order [Begin]
    *SHOW GET loForm.loRec.nApTAprQty DISABLE
    LOFORM.TXTAPTAPRQTY.ENABLED = .F.
    *SHOW OBJECT loFormSet.lnApQtyObj DISABLE
    *B602830,1 Change this line because we are going to switch between 2 [End]

    *Old: SHOW GET loForm.loRec.nAPAprAmnt DISABLE &&Revise
    LOFORM.TXTAPAPRAMNT.ENABLED = .F.
  ENDIF
ENDIF
LOFORM.REFRESH()

RETURN
*-- End of lfvInvTQty


*!*************************************************************
*! Name      : lfvAprTQty
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 09/02/2004
*! Purpose   : Invoice line total Approved Quantity
*!*************************************************************
*! Parameters:  The FormSet of APPYINV.SCX, The Form of APINVDT.SCX
*!*************************************************************
*! Returns   :  None
*!*************************************************************
FUNCTION LFVAPRTQTY
LPARAMETERS LOFORMSET, LOFORM

*The Approved Amount in invoice line should be <= the inv. amount [Begin]
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*!*	IF (loForm.loRec.nAPAprPric * loForm.loRec.nApTAprQty) > loForm.loRec.nApAmnt
*!*	  =gfModalGen(.F.,'DIALOG',.F.,.F.,'The approved amount should be less than or equal invoice amount')
*!*	  loForm.loRec.nApTAprQty = nApTAprQty
*! E302623,3 MMT 01/03/2010 Convert Payable invoice screen to use SQL tables[Start]
SELECT(IIF(LOFORMSET.ACTIVEMODE="V",'APVINVDT2',LOFORMSET.LCAPVINVDT))
*! E302623,3 MMT 01/03/2010 Convert Payable invoice screen to use SQL tables[End]
IF (LOFORMSET.LOREC.NAPAPRPRIC * LOFORMSET.LOREC.NAPTAPRQTY) > LOFORMSET.LOREC.NAPAMNT
  *N000682,1 MMT 11/22/2012 Globalization changes[Start]
  *=GFMODALGEN(.F.,'DIALOG',.F.,.F.,'The approved amount should be less than or equal invoice amount')
  *N000682,1 11/20/2012 MMT Globlization changes[Start]
*=GFMODALGEN(.F.,'DIALOG',.F.,.F.,LANG_APPYINV_APPROVED_AMOUNT_LESS)
=GFMODALGEN(.F.,'DIALOG',.F.,.F.,IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_APPROVED_AMOUNT_LESS,loFormSet.GetHeaderText("LANG_APPYINV_APPROVED_AMOUNT_LESS",loFormSet.HeaderAlias)))
*N000682,1 11/20/2012 MMT Globlization changes[End]

  *N000682,1 MMT 11/22/2012 Globalization changes[END]
  LOFORMSET.LOREC.NAPTAPRQTY = NAPTAPRQTY
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  RETURN
ENDIF
*The Approved Amount in invoice line should be <= the inv. amount [end]

*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*!*	loForm.loRec.nApTAprQty = IIF(lfChkAplTkt(loFormSet,loForm,''),loForm.loRec.nApTAprQty,nApTAprQty)
*!*	IF loForm.loRec.nApTAprQty <> nApTAprQty
*!*	  loForm.loRec.nAPAprAmnt = loForm.loRec.nApTAprQty*loForm.loRec.nAPAprPric
*!*	  loFormSet.lnTAprAmt = loFormSet.lnTAprAmt +(ROUND(loForm.loRec.nAPAprAmnt,2)- ROUND(nApAprAmnt,2))*IIF(loForm.loRec.cIMTyp $ 'RF',-1,1)
LOFORMSET.LOREC.NAPTAPRQTY = IIF(LFCHKAPLTKT(LOFORMSET,LOFORM,''),LOFORMSET.LOREC.NAPTAPRQTY,NAPTAPRQTY)
IF LOFORMSET.LOREC.NAPTAPRQTY <> NAPTAPRQTY
  LOFORMSET.LOREC.NAPAPRAMNT = LOFORMSET.LOREC.NAPTAPRQTY*LOFORMSET.LOREC.NAPAPRPRIC
  LOFORMSET.LNTAPRAMT = LOFORMSET.LNTAPRAMT +(ROUND(LOFORMSET.LOREC.NAPAPRAMNT,2)- ROUND(NAPAPRAMNT,2))*IIF(LOFORMSET.LOREC.CIMTYP $ 'RF',-1,1)
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  *=lfRefresh('APINVD10')
  =LFUPDAPLTKT(LOFORMSET, LOFORM)
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	  REPLACE nApTAprQty WITH loForm.loRec.nApTAprQty ,;
  *!*	          nAPAprAmnt WITH loForm.loRec.nAPAprAmnt ,;
  *!*	          cStatus  WITH IIF(cStatus='S','M',cStatus)
  REPLACE NAPTAPRQTY WITH LOFORMSET.LOREC.NAPTAPRQTY ,;
    NAPAPRAMNT WITH LOFORMSET.LOREC.NAPAPRAMNT ,;
    CSTATUS  WITH IIF(CSTATUS='S','M',CSTATUS)
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  *Old: SHOW GET loForm.loRec.nAPAprAmnt ENABLE &&Revise
  LOFORM.TXTAPAPRAMNT.ENABLED = .T.
ENDIF
LOFORM.REFRESH()

RETURN
*-- End of lfvAprTQty


*!*************************************************************
*! Name      : lfvInvAmnt
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 09/02/2004
*! Purpose   : Invoice line total Amount
*!*************************************************************
*! Parameters:  The FormSet of APPYINV.SCX, The Form of APINVDT.SCX
*!*************************************************************
*! Returns   :  None
*!*************************************************************
FUNCTION LFVINVAMNT
LPARAMETERS LOFORMSET, LOFORM
*Fix bug when Saving the debit memo againest Return PO [BEGIN]
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*!*	IF (loForm.loRec.cIMTyp $ 'RF' OR loFormSet.llDebitM) AND (loForm.loRec.nApAmnt > 0)
*!*	  loForm.loRec.nApAmnt = loForm.loRec.nApAmnt * -1
*! E302623,3 MMT 01/03/2010 Convert Payable invoice screen to use SQL tables[Start]
IF LOFORMSET.ACTIVEMODE="V"
  RETURN
ENDIF
SELECT(IIF(LOFORMSET.ACTIVEMODE="V",'APVINVDT2',LOFORMSET.LCAPVINVDT))
*! E302623,3 MMT 01/03/2010 Convert Payable invoice screen to use SQL tables[End]
IF (LOFORMSET.LOREC.CIMTYP $ 'RF' OR LOFORMSET.LLDEBITM) AND (LOFORMSET.LOREC.NAPAMNT > 0)
  LOFORMSET.LOREC.NAPAMNT = LOFORMSET.LOREC.NAPAMNT * -1
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
ENDIF
*Fix bug when Saving the debit memo againest Return PO [END]
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*IF loForm.loRec.nApAmnt <> nApAmnt
IF LOFORMSET.LOREC.NAPAMNT <> NAPAMNT
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  * Add these lines to make sure that the "Invoice Amount" and
  *          the "Approved Amount" have the same sign [Begin]

  *-- If the "Invoice Amount" and the "Approved Amount" have
  *-- different signs
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	  IF SIGN(loForm.loRec.nApAmnt) <> 0 .AND. SIGN(loForm.loRec.nAPAprAmnt) <> 0 .AND.;
  *!*	     SIGN(loForm.loRec.nApAmnt) <> SIGN(loForm.loRec.nAPAprAmnt)
  IF SIGN(LOFORMSET.LOREC.NAPAMNT) <> 0 .AND. SIGN(LOFORMSET.LOREC.NAPAPRAMNT) <> 0 .AND.;
      SIGN(LOFORMSET.LOREC.NAPAMNT) <> SIGN(LOFORMSET.LOREC.NAPAPRAMNT)
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

    *-- Message : 04186
    *-- "Invoice amount and approved amount must have the same sign."
    *-- Button : 00000
    *-- "                          <    Ok    >                     "
    =GFMODALGEN('TRM04186B00000' , 'ALERT')

    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *loForm.loRec.nApAmnt = nApAmnt        && Restore the old value
    LOFORMSET.LOREC.NAPAMNT = NAPAMNT        && Restore the old value
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

    RETURN
  ENDIF
  *Add these lines to make sure that the "Invoice Amount" [End]

  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	  loForm.loRec.nAPTotQty  = IIF(loForm.loRec.nAPTotQty=0,1,loForm.loRec.nAPTotQty)
  *!*	  *MAN Added the following line
  *!*	  loForm.loRec.nApAmnt = loForm.loRec.nApAmnt * 1.000
  *!*	  loForm.loRec.nAPPrice   = loForm.loRec.nApAmnt/loForm.loRec.nAPTotQty
  LOFORMSET.LOREC.NAPTOTQTY  = IIF(LOFORMSET.LOREC.NAPTOTQTY=0,1,LOFORMSET.LOREC.NAPTOTQTY)
  *MAN Added the following line
  LOFORMSET.LOREC.NAPAMNT = LOFORMSET.LOREC.NAPAMNT * 1.000
  LOFORMSET.LOREC.NAPPRICE   = LOFORMSET.LOREC.NAPAMNT/LOFORMSET.LOREC.NAPTOTQTY
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  *Change these lines to make sure that the "Approved Amount" could
  *          not be less than the "Contributed Amount" [Begin]
  *loForm.loRec.nAPAprAmnt = IIF(llDefAuApr,loForm.loRec.nApAmnt,loForm.loRec.nAPAprAmnt)
  *loForm.loRec.nApTAprQty = IIF(llDefAuApr AND loForm.loRec.nApTAprQty=0,1,loForm.loRec.nApTAprQty)
  *loForm.loRec.nAPAprPric = IIF(loForm.loRec.nApTAprQty=0,0,loForm.loRec.nAPAprAmnt/loForm.loRec.nApTAprQty)

  *-- If Automatic Approve
  IF LOFORM.LLDEFAUAPR

    *-- If there is no "Approved Amount" (there is no "Contributed Amount")
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *!*	    IF loForm.loRec.nAPAprAmnt = 0
    *!*	      *-- Default the "Approved Amount" with the "Invoice Amount"
    *!*	      loForm.loRec.nAPAprAmnt = loForm.loRec.nApAmnt
    *!*	      *-- Default the "Approved Quantity" with 1 if it's empty otherwise
    *!*	      *-- live it as it is
    *!*	      loForm.loRec.nApTAprQty = IIF(loForm.loRec.nApTAprQty = 0 , 1 , loForm.loRec.nApTAprQty)
    *!*	      *-- Calculate the "Approved Unit Cost"
    *!*	      loForm.loRec.nAPAprPric = loForm.loRec.nAPAprAmnt / loForm.loRec.nApTAprQty
    IF LOFORMSET.LOREC.NAPAPRAMNT = 0
      *-- Default the "Approved Amount" with the "Invoice Amount"
      LOFORMSET.LOREC.NAPAPRAMNT = LOFORMSET.LOREC.NAPAMNT
      *-- Default the "Approved Quantity" with 1 if it's empty otherwise
      *-- live it as it is
      LOFORMSET.LOREC.NAPTAPRQTY = IIF(LOFORMSET.LOREC.NAPTAPRQTY = 0 , 1 , LOFORMSET.LOREC.NAPTAPRQTY)
      *-- Calculate the "Approved Unit Cost"
      LOFORMSET.LOREC.NAPAPRPRIC = LOFORMSET.LOREC.NAPAPRAMNT / LOFORMSET.LOREC.NAPTAPRQTY
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    ELSE    && Else (If there is an "Approved Amount")
      *-- Calculate the "Approved Unit Cost" using the "Invoice Amount"
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *loForm.loRec.nAPAprPric = loForm.loRec.nApAmnt / loForm.loRec.nApTAprQty
      LOFORMSET.LOREC.NAPAPRPRIC = LOFORMSET.LOREC.NAPAMNT / LOFORMSET.LOREC.NAPTAPRQTY
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      *-- If the new "Approved Unit Cost" - that was calculated using the
      *-- "Invoice Amount" - produced an "Approved Amount" greater than
      *-- the "Contributed Amount"
      IF !LFCHKAPLTKT(LOFORMSET,LOFORM,'')
        *-- Restore the old "Approved Unit Cost"
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        *loForm.loRec.nAPAprPric = nAPAprPric
        LOFORMSET.LOREC.NAPAPRPRIC = NAPAPRPRIC
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      ELSE
        *-- Default the "Approved Amount" with the "Invoice Amount"
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        *loForm.loRec.nAPAprAmnt = loForm.loRec.nApAmnt
        LOFORMSET.LOREC.NAPAPRAMNT = LOFORMSET.LOREC.NAPAMNT
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      ENDIF
    ENDIF
  ENDIF
  *Change these lines to make sure that the "Approved Amount" [End]

  *Fix bug when Saving the debit memo againest Return PO [BEGIN]
  *lnTInvAmt = lnTInvAmt + (ROUND(loForm.loRec.nApAmnt,2)- ROUND(nAPAMnt,2))*IIF(loForm.loRec.cIMTyp $ 'RF',-1,1)
  *lnTAprAmt = lnTAprAmt + (ROUND(loForm.loRec.nAPAprAmnt,2)- ROUND(nApAprAmnt,2))*IIF(loForm.loRec.cIMTyp $ 'RF',-1,1)
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	  loFormSet.lnTInvAmt = loFormSet.lnTInvAmt + (ROUND(loForm.loRec.nApAmnt,2)- ROUND(nAPAMnt,2))
  *!*	  loFormSet.lnTAprAmt = loFormSet.lnTAprAmt + (ROUND(loForm.loRec.nAPAprAmnt,2)- ROUND(nApAprAmnt,2))
  LOFORMSET.LNTINVAMT = LOFORMSET.LNTINVAMT + (ROUND(LOFORMSET.LOREC.NAPAMNT,2)- ROUND(NAPAMNT,2))
  LOFORMSET.LNTAPRAMT = LOFORMSET.LNTAPRAMT + (ROUND(LOFORMSET.LOREC.NAPAPRAMNT,2)- ROUND(NAPAPRAMNT,2))
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  *Fix bug when Saving the debit memo againest Return PO [END]

  *=lfRefresh('APINVD10')
  *Fix bug when Saving the debit memo againest Return PO [BEGIN]
  PRIVATE LNDIFFAMNT
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	  lnDiffAmnt =  (ROUND(loForm.loRec.nApAmnt,2) - ROUND(nAPAMnt,2)) * IIF((loForm.loRec.cIMTyp $ 'RF'),1,IIF(loFormSet.llDebitM,-1,1))
  *!*	  =lfUpdApDist(loFormSet,loForm,cApVILNo,lnDiffAmnt,cApDGlAct,loForm.loRec.cIMTyp)
  LNDIFFAMNT =  (ROUND(LOFORMSET.LOREC.NAPAMNT,2) - ROUND(NAPAMNT,2)) * IIF((LOFORMSET.LOREC.CIMTYP $ 'RF'),1,IIF(LOFORMSET.LLDEBITM,-1,1))
  =LFUPDAPDIST(LOFORMSET,LOFORM,CAPVILNO,LNDIFFAMNT,CAPDGLACT,LOFORMSET.LOREC.CIMTYP)
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  *Fix bug when Saving the debit memo againest Return PO [END]

  =IIF(LOFORM.LLDEFAUAPR,LFUPDAPLTKT(LOFORMSET, LOFORM),.T.)
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	  REPLACE nAPPrice   WITH loForm.loRec.nAPPrice   ,;
  *!*	          nAPTotQty  WITH loForm.loRec.nAPTotQty  ,;
  *!*	          nApAmnt    WITH loForm.loRec.nApAmnt    ,;
  *!*	          nAPAprPric WITH loForm.loRec.nAPAprPric ,;
  *!*	          nApTAprQty WITH loForm.loRec.nApTAprQty ,;
  *!*	          nAPAprAmnt WITH loForm.loRec.nAPAprAmnt ,;
  *!*	          cStatus  WITH IIF(cStatus='S','M',cStatus)

  REPLACE NAPPRICE   WITH LOFORMSET.LOREC.NAPPRICE   ,;
    NAPTOTQTY  WITH LOFORMSET.LOREC.NAPTOTQTY  ,;
    NAPAMNT    WITH LOFORMSET.LOREC.NAPAMNT    ,;
    NAPAPRPRIC WITH LOFORMSET.LOREC.NAPAPRPRIC ,;
    NAPTAPRQTY WITH LOFORMSET.LOREC.NAPTAPRQTY ,;
    NAPAPRAMNT WITH LOFORMSET.LOREC.NAPAPRAMNT ,;
    CSTATUS  WITH IIF(CSTATUS='S','M',CSTATUS)
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  *Old: SHOW GET loForm.loRec.nAPPrice  ENABLE &&Revise
  LOFORM.TXTAPPRICE.ENABLED = .T.

  *Change this line because we are going to switch between 2 Get
  *          Fields for the "Invoice Quantity" to be able to add the
  *          decimal points to the "Invoice Quantity" in the case of
  *          document types Material PO, Material PO Return and
  *          Material MFG Order [Begin]
  *SHOW GET loForm.loRec.nAPTotQty &lcInvQTot
  LOFORM.TXTAPTOTQTY.ENABLED = (LOFORM.LCINVQTOT='ENABLE')
  *SHOW OBJECT loFormSet.lnQtyObj &loForm.lcInvQTot
  *Change this line because we are going to switch between 2 [End]

  IF LOFORM.LLDEFEDAPR
    *Old: SHOW GET loForm.loRec.nAPAprPric ENABLE &&Revise
    LOFORM.TXTAPAPRPRIC.ENABLED = .T.

    *Change this line because we are going to switch between 2 Get
    *          Fields for the "Approve Quantity" to be able to add the
    *          decimal points to the "Approve Quantity" in the case of
    *          document types Material PO, Material PO Return and
    *          Material MFG Order [Begin]
    *SHOW GEt loForm.loRec.nApTAprQty &lcAprQty
    LOFORM.TXTAPTAPRQTY.ENABLED = (LOFORM.LCAPRQTY='ENABLE')
    *SHOW OBJECT loFormSet.lnApQtyObj &loForm.lcAprQty
    *Change this line because we are going to switch between 2 [End]

    *Old: SHOW GET loForm.loRec.nAPAprAmnt ENABLE &&Revise
    LOFORM.TXTAPAPRAMNT.ENABLED = .T.
  ELSE
    *Old: SHOW GET loForm.loRec.nAPAprPric DISABLE &&Revise
    LOFORM.TXTAPAPRPRIC.ENABLED = .F.

    *Change this line because we are going to switch between 2 Get
    *          Fields for the "Approve Quantity" to be able to add the
    *          decimal points to the "Approve Quantity" in the case of
    *          document types Material PO, Material PO Return and
    *          Material MFG Order [Begin]
    *SHOW GEt loForm.loRec.nApTAprQty DISABLE
    LOFORM.TXTAPTAPRQTY.ENABLED = .F.
    *SHOW OBJECT loFormSet.lnApQtyObj DISABLE
    *Change this line because we are going to switch between 2 [End]

    *Old: SHOW GET loForm.loRec.nAPAprAmnt DISABLE &&Revise
    LOFORM.TXTAPAPRAMNT.ENABLED = .F.
  ENDIF
ENDIF
LOFORM.REFRESH()

RETURN
*-- End of lfvInvAmnt


*!*************************************************************
*! Name      : lfvAprAmnt
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 09/02/2004
*! Purpose   : Invoice line total Approved Amount
*!*************************************************************
*! Parameters:  The FormSet of APPYINV.SCX, The Form of APINVDT.SCX
*!*************************************************************
*! Returns   :  None
*!*************************************************************
FUNCTION LFVAPRAMNT
LPARAMETERS LOFORMSET, LOFORM

*Fix bug when Saving the debit memo againest Return PO [BEGIN]
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*!*	IF (loForm.loRec.cIMTyp $ 'RF'OR loFormSet.llDebitM) AND (loForm.loRec.nAPAprAmnt > 0)
*!*	  loForm.loRec.nAPAprAmnt = loForm.loRec.nAPAprAmnt * -1
*! E302623,3 MMT 01/03/2010 Convert Payable invoice screen to use SQL tables[Start]
SELECT(IIF(LOFORMSET.ACTIVEMODE="V",'APVINVDT2',LOFORMSET.LCAPVINVDT))
*! E302623,3 MMT 01/03/2010 Convert Payable invoice screen to use SQL tables[End]
IF (LOFORMSET.LOREC.CIMTYP $ 'RF'OR LOFORMSET.LLDEBITM) AND (LOFORMSET.LOREC.NAPAPRAMNT > 0)
  LOFORMSET.LOREC.NAPAPRAMNT = LOFORMSET.LOREC.NAPAPRAMNT * -1
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
ENDIF
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*IF ABS(loForm.loRec.nAPAprAmnt) > ABS(loForm.loRec.nApAmnt)
IF ABS(LOFORMSET.LOREC.NAPAPRAMNT) > ABS(LOFORMSET.LOREC.NAPAMNT)
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  =GFMODALGEN(.F.,'DIALOG',.F.,.F.,'The approved amount should be less than or equal invoice amount')
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *loForm.loRec.nAPAprAmnt = nAPAprAmnt
  LOFORMSET.LOREC.NAPAPRAMNT = NAPAPRAMNT
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  RETURN
ENDIF
*Fix bug when Saving the debit memo againest Return PO [END]

*MAN
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*loForm.loRec.nAPAprAmnt = IIF(lfChkAplTkt(loFormSet,loForm,''),loForm.loRec.nAPAprAmnt,nAPAprAmnt)
*IF loForm.loRec.nAPAprAmnt <> nAPAprAmnt
LOFORMSET.LOREC.NAPAPRAMNT = IIF(LFCHKAPLTKT(LOFORMSET,LOFORM,''),LOFORMSET.LOREC.NAPAPRAMNT,NAPAPRAMNT)
IF LOFORMSET.LOREC.NAPAPRAMNT <> NAPAPRAMNT
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  *Add these lines to make sure that the "Invoice Amount" and
  *          the "Approved Amount" have the same sign [Begin]

  *-- If the "Invoice Amount" and the "Approved Amount" have
  *-- different signs
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	  IF SIGN(loForm.loRec.nApAmnt) <> 0 .AND. SIGN(loForm.loRec.nAPAprAmnt) <> 0 .AND.;
  *!*	     SIGN(loForm.loRec.nApAmnt) <> SIGN(loForm.loRec.nAPAprAmnt)
  IF SIGN(LOFORMSET.LOREC.NAPAMNT) <> 0 .AND. SIGN(LOFORMSET.LOREC.NAPAPRAMNT) <> 0 .AND.;
      SIGN(LOFORMSET.LOREC.NAPAMNT) <> SIGN(LOFORMSET.LOREC.NAPAPRAMNT)
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[END]
    *-- Message : 04186
    *-- "Invoice amount and approved amount must have the same sign."
    *-- Button : 00000
    *-- "                          <    Ok    >                     "
    =GFMODALGEN('TRM04186B00000' , 'ALERT')
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *loForm.loRec.nAPAprAmnt = nAPAprAmnt        && Restore the old value
    LOFORMSET.LOREC.NAPAPRAMNT = NAPAPRAMNT        && Restore the old value
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[END]
    RETURN
  ENDIF
  *Add these lines to make sure that the "Invoice Amount" [End]

  *MAN Added the following line
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	  loForm.loRec.nAPAprAmnt = loForm.loRec.nAPAprAmnt * 1.000
  *!*	  loForm.loRec.nApTAprQty = IIF(loForm.loRec.nApTAprQty=0,1,loForm.loRec.nApTAprQty)
  *!*	  loForm.loRec.nAPAprPric = loForm.loRec.nAPAprAmnt/loForm.loRec.nApTAprQty
  *!*	  loFormSet.lnTAprAmt = loFormSet.lnTAprAmt + (ROUND(loForm.loRec.nAPAprAmnt,2)- ROUND(nApAprAmnt,2))
  LOFORMSET.LOREC.NAPAPRAMNT = LOFORMSET.LOREC.NAPAPRAMNT * 1.000
  LOFORMSET.LOREC.NAPTAPRQTY = IIF(LOFORMSET.LOREC.NAPTAPRQTY=0,1,LOFORMSET.LOREC.NAPTAPRQTY)
  LOFORMSET.LOREC.NAPAPRPRIC = LOFORMSET.LOREC.NAPAPRAMNT/LOFORMSET.LOREC.NAPTAPRQTY
  LOFORMSET.LNTAPRAMT = LOFORMSET.LNTAPRAMT + (ROUND(LOFORMSET.LOREC.NAPAPRAMNT,2)- ROUND(NAPAPRAMNT,2))
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[END]
  *=lfRefresh('APINVD10')
  =LFUPDAPLTKT(LOFORMSET, LOFORM)
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	  REPLACE nAPAprPric WITH loForm.loRec.nAPAprPric ,;
  *!*	          nApTAprQty WITH loForm.loRec.nApTAprQty ,;
  *!*	          nAPAprAmnt WITH loForm.loRec.nAPAprAmnt ,;
  *!*	          cStatus  WITH IIF(cStatus='S','M',cStatus)
  REPLACE NAPAPRPRIC WITH LOFORMSET.LOREC.NAPAPRPRIC ,;
    NAPTAPRQTY WITH LOFORMSET.LOREC.NAPTAPRQTY ,;
    NAPAPRAMNT WITH LOFORMSET.LOREC.NAPAPRAMNT ,;
    CSTATUS  WITH IIF(CSTATUS='S','M',CSTATUS)
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  *Old: SHOW GET loForm.loRec.nAPAprPric ENABLE &&Revise
  LOFORM.TXTAPAPRPRIC.ENABLED = .T.

  *Change this line because we are going to switch between 2 Get
  *          Fields for the "Approve Quantity" to be able to add the
  *          decimal points to the "Approve Quantity" in the case of
  *          document types Material PO, Material PO Return and
  *          Material MFG Order [Begin]
  *SHOW GEt loForm.loRec.nApTAprQty &lcAprQty
  LOFORM.TXTAPTAPRQTY.ENABLED = (LOFORM.LCAPRQTY='ENABLE')
  *SHOW OBJECT loFormSet.lnApQtyObj &loForm.lcAprQty  &&lower
  *Change this line because we are going to switch between 2 [End]

ENDIF
LOFORM.REFRESH()

RETURN
*-- End of lfvAprAmnt

*!*************************************************************
*! Name      : lfvStyle
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 09/02/2004
*! Purpose   : Validate styles
*!*************************************************************
*! Parameters:  The FormSet of APPYINV.SCX, The Form of APINVDT.SCX
*!*************************************************************
*! Returns   :  None
*!*************************************************************
FUNCTION LFVSTYLE
LPARAMETERS LOFORMSET, LOFORM, LLBROWSE, LNITEMPART, LCVALUE, LCOLDVALUE, LCSTYLEVAL
LOCAL LCEMPTYITEM

LCEMPTYITEM=STRTRAN(GFITEMMASK("PI"),'X',' ')
LOFORMSET.LLBROWSE = LLBROWSE
IF !LOFORMSET.LLBROWSE AND LOFORM.CNTSTYLE.TXTITEM.VALUE=LCEMPTYITEM
  RETURN
ENDIF
LOFORM.CNTSTYLE.VALUE = LOFORM.CNTSTYLE.TXTITEM.VALUE

IF LFISCONTRIB(LOFORMSET, LOFORM)
  LOFORM.CNTSTYLE.VALUE=ITEM
  LOFORMSET.LLBROWSE = .F.
  *loForm.cntStyle.SelectedFromBrowse = .F.
  LOFORM.REFRESH()
  RETURN
ENDIF
IF EMPTY(LOFORM.KBINVTKTNO.KEYTEXTBOX.VALUE)
  IF LOFORMSET.LLBROWSE .OR. (!LOFORM.CNTSTYLE.VALUE=LCEMPTYITEM AND !SEEK(LOFORM.CNTSTYLE.VALUE,'STYLE'))
    LOFORM.CNTSTYLE.VALUE = LOFORM.CNTSTYLE.MSTYLEBROW('I',LOFORM.CNTSTYLE.VALUE)
    LOFORM.CNTSTYLE.VALUE = IIF(LOFORM.CNTSTYLE.VALUE=LCEMPTYITEM,ITEM,LOFORM.CNTSTYLE.VALUE)
  ENDIF
  LOFORMSET.LLBROWSE = .F.
  *loForm.cntStyle.SelectedFromBrowse = .F.
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *IF loForm.cntStyle.Value = loForm.loRec.Item
  IF LOFORM.CNTSTYLE.VALUE = LOFORMSET.LOREC.ITEM
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    LOFORM.REFRESH()
    RETURN
  ENDIF
  =SEEK(LOFORM.CNTSTYLE.VALUE,'Style') &&ASM, Make sure Sytle table is correctly positioned
  IF !LOFORM.CNTSTYLE.VALUE=LCEMPTYITEM
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *  IF loForm.loRec.cIMTyp='M' AND !Style.Make
    IF LOFORMSET.LOREC.CIMTYP='M' AND !STYLE.MAKE
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      *Message : 04173
      *Only Manufacturing Styles are allowed
      *Button : 00000
      *Ok
      *N000682,1 MMT 11/22/2012 Globalization changes[Start]
      *=GFMODALGEN("TRM04173B00000","DIALOG",'Manufacturing Styles')
      *N000682,1 11/20/2012 MMT Globlization changes[Start]
*=GFMODALGEN("TRM04173B00000","DIALOG",LANG_APPYINV_MANF_STYLES)
=GFMODALGEN("TRM04173B00000","DIALOG",IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_MANF_STYLES,loFormSet.GetHeaderText("LANG_APPYINV_MANF_STYLES",loFormSet.HeaderAlias)))
*N000682,1 11/20/2012 MMT Globlization changes[End]

      *N000682,1 MMT 11/22/2012 Globalization changes[END]
      LOFORM.CNTSTYLE.VALUE = ITEM
      LOFORM.REFRESH()
      RETURN
    ENDIF
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *IF INLIST(loForm.loRec.cIMTyp,'I','S','R') AND Style.Make
    IF INLIST(LOFORMSET.LOREC.CIMTYP,'I','S','R') AND STYLE.MAKE
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      *Message : 04173
      *Only Importing Styles are allowed
      *Button : 00000
      *Ok
      *N000682,1 MMT 11/22/2012 Globalization changes[Start]
      *=GFMODALGEN("TRM04173B00000","DIALOG",'Importing Styles')
      *N000682,1 11/20/2012 MMT Globlization changes[Start]
*=GFMODALGEN("TRM04173B00000","DIALOG",LANG_APPYINV_IMPR_STYLES)
=GFMODALGEN("TRM04173B00000","DIALOG",IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_IMPR_STYLES,loFormSet.GetHeaderText("LANG_APPYINV_IMPR_STYLES",loFormSet.HeaderAlias)))
*N000682,1 11/20/2012 MMT Globlization changes[End]

      *N000682,1 MMT 11/22/2012 Globalization changes[END]
      LOFORM.CNTSTYLE.VALUE = ITEM
      LOFORM.REFRESH()
      RETURN
    ENDIF
  ENDIF
ELSE
  LOFORM.CNTSTYLE.VALUE = IIF(LOFORMSET.LLBROWSE,'?',LOFORM.CNTSTYLE.VALUE)
  LOFORMSET.LLBROWSE = .F.
  *loForm.cntStyle.SelectedFromBrowse = .F.
  LCSTYLE = LOFORM.CNTSTYLE.VALUE
  LCSTYDYE = LOFORM.KBDYELOT.KEYTEXTBOX.VALUE
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	  IF !lfItemQty(loFormSet,loForm,loForm.loRec.cIMTyp,loForm.kbInvTktNo.KeyTextBox.Value,loForm.loRec.cLotNo,;
  *!*	      loForm.loRec.cBomType,loForm.loRec.cOprCode,@lcStyle,SPACE(6),@lcStyDye)
  IF !LFITEMQTY(LOFORMSET,LOFORM,LOFORMSET.LOREC.CIMTYP,LOFORM.KBINVTKTNO.KEYTEXTBOX.VALUE,LOFORMSET.LOREC.CLOTNO,;
      LOFORMSET.LOREC.CBOMTYPE,LOFORMSET.LOREC.COPRCODE,@LCSTYLE,SPACE(6),@LCSTYDYE)
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    LOFORM.CNTSTYLE.VALUE = LCSTYLE
    LOFORM.KBDYELOT.KEYTEXTBOX.VALUE = LCSTYDYE
    LOFORM.CNTSTYLE.VALUE = ITEM
    LOFORM.REFRESH()
    RETURN
  ELSE
    LOFORM.CNTSTYLE.VALUE = LCSTYLE
    LOFORM.KBDYELOT.KEYTEXTBOX.VALUE = LCSTYDYE
  ENDIF
ENDIF
=SEEK(LOFORM.CNTSTYLE.VALUE,'Style')
LOFORM.TXTSTYDESC.VALUE = STYLE.DESC1
IF EMPTY(LOFORM.CNTSTYLE.VALUE) OR STYLE.CDYE_FLG <> 'Y'
  STORE SPACE(10) TO LOFORM.KBDYELOT.KEYTEXTBOX.VALUE
ENDIF

*Get the correct WIP account with shipment ticket [Begin]
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*IF !EMPTY(loForm.cntStyle.Value) AND loForm.loRec.cIMTyp = 'S'
IF !EMPTY(LOFORM.CNTSTYLE.VALUE) AND LOFORMSET.LOREC.CIMTYP = 'S'
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  LCLINKCODE = IIF(EMPTY(LOFORM.KBINVTKTNO.KEYTEXTBOX.VALUE),SPACE(6),;
    SUBSTR(LFGETGLLNK(LOFORM.KBINVTKTNO.KEYTEXTBOX.VALUE,LOFORM.CNTSTYLE.VALUE,''),1,6))
  IF !SEEK(LCLINKCODE+'013','GL_LINK')
    =SEEK('DEFDEF'+'013','GL_LINK')
  ENDIF
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *  STORE GL_Link.GlAcnt TO loForm.loRec.cApDGlAct
  STORE GL_LINK.GLACNT TO LOFORMSET.LOREC.CAPDGLACT
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  SELECT (LOFORMSET.LCAPVINVDT)
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	  IF cApDGlAct <> loForm.loRec.cApDGlAct
  *!*	    =lfUpdApDist(loFormSet,loForm,cApVILNo,0,loForm.loRec.cApDGlAct,loForm.loRec.cIMTyp)
  *!*	    REPLACE cApDGlAct WITH loForm.loRec.cApDGlAct ,;
  *!*	            cStatus   WITH IIF(cStatus='S','M',cStatus)
  IF CAPDGLACT <> LOFORMSET.LOREC.CAPDGLACT
    =LFUPDAPDIST(LOFORMSET,LOFORM,CAPVILNO,0,LOFORMSET.LOREC.CAPDGLACT,LOFORMSET.LOREC.CIMTYP)
    REPLACE CAPDGLACT WITH LOFORMSET.LOREC.CAPDGLACT ,;
      CSTATUS   WITH IIF(CSTATUS='S','M',CSTATUS)
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  ENDIF
ENDIF
*Get the correct WIP account with shipment ticket [end]

*=lfRefresh('APINVD10')
SELECT (LOFORMSET.LCAPVINVDT)
REPLACE ITEM     WITH LOFORM.CNTSTYLE.VALUE   ,;
  CDYELOT  WITH LOFORM.KBDYELOT.KEYTEXTBOX.VALUE  ,;
  CAPVIDES WITH LOFORM.TXTSTYDESC.VALUE ,;
  CSTATUS  WITH IIF(CSTATUS='S','M',CSTATUS)

*?Amin
*update MFgOper with proper value   [Start]
IF EVALUATE(LOFORMSET.LCAPVINVDT+'.cOprCode') = REPLICATE('*',6)
  REPLACE COPRCODE WITH IIF(!STYLE.LDETCOST,PADR('*'+EVALUATE(LOFORMSET.LCAPVINVDT+'.cBomType'),6),;
    EVALUATE(LOFORMSET.LCAPVINVDT+'.cOprCode'))
ENDIF
IF EVALUATE(LOFORMSET.LCAPVINVDT+'.cOprCode')  =REPLICATE('#',6)
  REPLACE COPRCODE WITH IIF(!STYLE.LDETCOST,PADR('*'+EVALUATE(LOFORMSET.LCAPVINVDT+'.cBomType'),6),;
    EVALUATE(LOFORMSET.LCAPVINVDT+'.cOprCode'))
ENDIF
*update MFgOper with proper value   [End]

=LFSHOWWIND(LOFORMSET,LOFORM)
LOFORM.REFRESH()

RETURN
*-- End of lfvStyle


*!*************************************************************
*! Name      : lfvStyDye
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 09/02/2004
*! Purpose   : Validate style Dyelots
*!*************************************************************
*! Parameters:  The FormSet of APPYINV.SCX, The Form of APINVDT.SCX
*!*************************************************************
*! Returns   :  None
*!*************************************************************
FUNCTION LFVSTYDYE
LPARAMETERS LOFORMSET, LOFORM

LOFORMSET.LLBROWSE = LOFORM.KBDYELOT.SELECTEDFROMBROWSE

IF !EMPTY(LOFORM.KBINVTKTNO.KEYTEXTBOX.VALUE)
  LOFORM.KBDYELOT.KEYTEXTBOX.VALUE = IIF(LOFORMSET.LLBROWSE,'?',LOFORM.KBDYELOT.KEYTEXTBOX.VALUE)
  LOFORMSET.LLBROWSE = .F.
  LOFORM.KBDYELOT.SELECTEDFROMBROWSE = .F.
  LCSTYLE = LOFORM.CNTSTYLE.VALUE
  LCSTYDYE = LOFORM.KBDYELOT.KEYTEXTBOX.VALUE
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	  IF !lfItemQty(loFormSet,loForm,loForm.loRec.cIMTyp,loForm.kbInvTktNo.KeyTextBox.Value,loForm.loRec.cLotNo,loForm.loRec.cBomType,loForm.loRec.cOprCode,;
  *!*	               @lcStyle,SPACE(6),@lcStyDye)
  IF !LFITEMQTY(LOFORMSET,LOFORM,LOFORMSET.LOREC.CIMTYP,LOFORM.KBINVTKTNO.KEYTEXTBOX.VALUE,LOFORMSET.LOREC.CLOTNO,LOFORMSET.LOREC.CBOMTYPE,LOFORMSET.LOREC.COPRCODE,;
      @LCSTYLE,SPACE(6),@LCSTYDYE)
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    LCSTYDYE = CDYELOT
    LOFORM.CNTSTYLE.VALUE = LCSTYLE
    LOFORM.KBDYELOT.KEYTEXTBOX.VALUE = LCSTYDYE
    LOFORM.REFRESH()
    RETURN
  ELSE
    LOFORM.CNTSTYLE.VALUE = LCSTYLE
    LOFORM.KBDYELOT.KEYTEXTBOX.VALUE = LCSTYDYE
  ENDIF
ENDIF
=SEEK(LLOFORM.CNTSTYLE.VALUE,'Style')
LOFORM.TXTSTYDESC.VALUE = STYLE.DESC1
*Old: SHOW GET lcStyDesc &&Revise
*=lfRefresh('APINVD10')
SELECT (LOFORMSET.LCAPVINVDT)
REPLACE ITEM     WITH LOFORM.CNTSTYLE.VALUE   ,;
  CDYELOT  WITH LOFORM.KBDYELOT.KEYTEXTBOX.VALUE  ,;
  CAPVIDES WITH LOFORM.TXTSTYDESC.VALUE ,;
  CSTATUS  WITH IIF(CSTATUS='S','M',CSTATUS)

=LFSHOWWIND(LOFORMSET,LOFORM)
LOFORM.REFRESH()

RETURN
*-- End of lfvStyDye


*!*************************************************************
*! Name      : lfvFabric
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 09/02/2004
*! Purpose   : Validate Fabrics
*!*************************************************************
*! Parameters:  The FormSet of APPYINV.SCX, The Form of APINVDT.SCX
*!*************************************************************
*! Returns   :  None
*!*************************************************************
FUNCTION LFVFABRIC
LPARAMETERS LOFORMSET, LOFORM, LLBROWSE, LNITEMPART, LCVALUE, LCOLDVALUE, LCSTYLEVAL

LOFORM.CNTITEM.VALUE = LOFORM.CNTITEM.TXTITEM.VALUE

LOFORMSET.LLBROWSE = LLBROWSE
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*IF !loFormSet.llBrowse AND loForm.cntItem.Value=lfupditem(loForm.loRec.Item,loForm.loRec.Color)
IF !LOFORMSET.LLBROWSE AND LOFORM.CNTITEM.VALUE=LFUPDITEM(LOFORMSET.LOREC.ITEM,LOFORMSET.LOREC.COLOR)
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  RETURN
ENDIF
IF LFISCONTRIB(LOFORMSET, LOFORM)
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *  loForm.cntItem.Value = lfupditem(loForm.loRec.Item,loForm.loRec.Color)
  LOFORM.CNTITEM.VALUE = LFUPDITEM(LOFORMSET.LOREC.ITEM,LOFORMSET.LOREC.COLOR)
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  LOFORMSET.LLBROWSE = .F.
  *loForm.cntItem.SelectedFromBrowse = .F.
  LOFORM.REFRESH()
  RETURN
ENDIF
IF EMPTY(LOFORM.KBINVTKTNO.KEYTEXTBOX.VALUE)
  **CINVTYPE+STYLE
  IF LOFORMSET.LLBROWSE .OR. !LOFORMSET.FABRIC.SEEK('0002'+LOFORM.CNTITEM.VALUE) &&Sql82: Check Key
    LOFORM.CNTITEM.VALUE = LOFORM.CNTITEM.MSTYLEBROW('I',LOFORM.CNTITEM.VALUE)
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *loForm.cntItem.Value = IIF(EMPTY(loForm.cntItem.Value),lfupditem(loForm.loRec.Item,loForm.loRec.Color),loForm.cntItem.Value)
    LOFORM.CNTITEM.VALUE = IIF(EMPTY(LOFORM.CNTITEM.VALUE),LFUPDITEM(LOFORMSET.LOREC.ITEM,LOFORMSET.LOREC.COLOR),LOFORM.CNTITEM.VALUE)
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[ENd]
  ENDIF
  SELECT (LOFORMSET.LCAPVINVDT)
  LOFORMSET.LLBROWSE = .F.
  *loForm.cntItem.SelectedFromBrowse = .F.
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *IF loForm.cntItem.Value = lfupditem(loForm.loRec.Item,loForm.loRec.Color)
  IF LOFORM.CNTITEM.VALUE = LFUPDITEM(LOFORMSET.LOREC.ITEM,LOFORMSET.LOREC.COLOR)
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    LOFORM.REFRESH()
    RETURN
  ENDIF
  **CINVTYPE+STYLE
  =LOFORMSET.FABRIC.SEEK('0002'+LOFORM.CNTITEM.VALUE) &&Sql83: Check Key
  IF !EMPTY(LOFORM.CNTITEM.VALUE)
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *  IF INLIST(loForm.loRec.cIMTyp,'L','F') AND Fabric.Make
    IF INLIST(LOFORMSET.LOREC.CIMTYP,'L','F') AND FABRIC.MAKE
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      *Message : 04173
      *Only Importing Materials are allowed
      *Button : 00000
      *Ok
      *N000682,1 MMT 11/22/2012 Globalization changes[Start]
      *=GFMODALGEN("TRM04173B00000","DIALOG",'Importing Materials')
      *N000682,1 11/20/2012 MMT Globlization changes[Start]
*=GFMODALGEN("TRM04173B00000","DIALOG",LANG_APPYINV_IMPR_MA)
=GFMODALGEN("TRM04173B00000","DIALOG",IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_IMPR_MA,loFormSet.GetHeaderText("LANG_APPYINV_IMPR_MA",loFormSet.HeaderAlias)))
*N000682,1 11/20/2012 MMT Globlization changes[End]

      *N000682,1 MMT 11/22/2012 Globalization changes[END]
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *loForm.cntItem.Value = lfupditem(loForm.loRec.Item,loForm.loRec.Color)
      LOFORM.CNTITEM.VALUE = LFUPDITEM(LOFORMSET.LOREC.ITEM,LOFORMSET.LOREC.COLOR)
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      LOFORM.REFRESH()
      RETURN
    ENDIF
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *IF loForm.loRec.cIMTyp = 'T' AND !Fabric.Make
    IF LOFORMSET.LOREC.CIMTYP = 'T' AND !FABRIC.MAKE
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      *Message : 04173
      *Only Manufacturing Materials are allowed
      *Button : 00000
      *Ok
      *N000682,1 MMT 11/22/2012 Globalization changes[Start]
      *=GFMODALGEN("TRM04173B00000","DIALOG",'Manufacturing Materials')
      *N000682,1 11/20/2012 MMT Globlization changes[Start]
*=GFMODALGEN("TRM04173B00000","DIALOG",LANG_APPYINV_MANF_MA)
=GFMODALGEN("TRM04173B00000","DIALOG",IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_MANF_MA,loFormSet.GetHeaderText("LANG_APPYINV_MANF_MA",loFormSet.HeaderAlias)))
*N000682,1 11/20/2012 MMT Globlization changes[End]

      *N000682,1 MMT 11/22/2012 Globalization changes[END]
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *loForm.cntItem.Value = lfupditem(loForm.loRec.Item,loForm.loRec.Color)
      LOFORM.CNTITEM.VALUE = LFUPDITEM(LOFORMSET.LOREC.ITEM,LOFORMSET.LOREC.COLOR)
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      LOFORM.REFRESH()
      RETURN
    ENDIF
  ENDIF
ELSE
  LOFORM.CNTITEM.VALUE = IIF(LOFORMSET.LLBROWSE,'?',LOFORM.CNTITEM.VALUE)
  LCFABRIC = LOFORM.CNTITEM.CMAJOR
  LCFABCLR = LOFORM.CNTITEM.CNONMAJOR
  LCFABDYE = LOFORM.KBDYELOT.KEYTEXTBOX.VALUE
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	  IF !lfItemQty(loFormSet,loForm,loForm.loRec.cIMTyp,loForm.kbInvTktNo.KeyTextBox.Value,loForm.loRec.cLotNo,;
  *!*	       loForm.loRec.cBomType,loForm.loRec.cOprCode,@lcFabric, @lcFabClr,@lcFabDye)
  *!*	    loForm.cntItem.Value = lfupditem(loForm.loRec.Item,loForm.loRec.Color)
  IF !LFITEMQTY(LOFORMSET,LOFORM,LOFORMSET.LOREC.CIMTYP,LOFORM.KBINVTKTNO.KEYTEXTBOX.VALUE,LOFORMSET.LOREC.CLOTNO,;
      LOFORMSET.LOREC.CBOMTYPE,LOFORMSET.LOREC.COPRCODE,@LCFABRIC, @LCFABCLR,@LCFABDYE)
    LOFORM.CNTITEM.VALUE = LFUPDITEM(LOFORMSET.LOREC.ITEM,LOFORMSET.LOREC.COLOR)
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    LOFORM.KBDYELOT.KEYTEXTBOX.VALUE = LCFABDYE
  ELSE
    LOFORM.CNTITEM.VALUE = LFUPDITEM(LCFABRIC, LCFABCLR)
    LOFORM.KBDYELOT.KEYTEXTBOX.VALUE = LCFABDYE
  ENDIF
ENDIF
*CINVTYPE+STYLE
=LOFORMSET.FABRIC.SEEK('0002'+LOFORM.CNTITEM.VALUE) &&Sql84: Check Key
LOFORM.KBDYELOT.KEYTEXTBOX.VALUE = IIF(FABRIC.CDYE_FLG='Y',LOFORM.KBDYELOT.KEYTEXTBOX.VALUE,SPACE(10))
LOFORM.TXTSTYDESC.VALUE = FABRIC.DESC
*Old: SHOW GET lcFabDesc &&Revise
*Old: SHOW GET lcFabric &&Revise
REPLACE ITEM     WITH LOFORM.CNTITEM.CMAJOR  ,;
  COLOR    WITH LOFORM.CNTITEM.CNONMAJOR  ,;
  CDYELOT  WITH LOFORM.KBDYELOT.KEYTEXTBOX.VALUE  ,;
  CAPVIDES WITH LOFORM.TXTSTYDESC.VALUE ,;
  CSTATUS  WITH IIF(CSTATUS='S','M',CSTATUS)
*=lfRefresh('APINVD10')
*=lfShowWind()
=LFSHOWWIND(LOFORMSET,LOFORM)
LOFORM.REFRESH()

RETURN
*-- End of lfvFabric


*!***************************************************************************************
*! Name      : lfvFabDye
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 09/02/2004
*! Purpose   : Validate Fabric/Color/Dyelots
*!*************************************************************
*! Parameters:  The FormSet of APPYINV.SCX, The Form of APINVDT.SCX
*!*************************************************************
*! Returns   :  None
*!*************************************************************
FUNCTION LFVFABDYE
LPARAMETERS LOFORMSET, LOFORM

LOFORMSET.LLBROWSE = LOFORM.KBDYELOT.SELECTEDFROMBROWSE

IF EMPTY(LOFORM.KBINVTKTNO.KEYTEXTBOX.VALUE)
  SELECT FABDYE
  *CINVTYPE+STYLE+CWARECODE+DYELOT
  =LOFORMSET.FABDYE.SEEK('0002'+LOFORM.CNTITEM.VALUE)  &&Sql85: Check Key
  LOCATE REST WHILE STYLE+CWARECODE+DYELOT = LOFORM.CNTITEM.VALUE FOR DYELOT = LOFORM.KBDYELOT.KEYTEXTBOX.VALUE
  IF LOFORMSET.LLBROWSE OR !FOUND()
    LCFABDYE = LOFORM.KBDYELOT.KEYTEXTBOX.VALUE
    =FDYEBROW(LOFORM.CNTITEM.CMAJOR,LOFORM.CNTITEM.CNONMAJOR,@LCFABDYE,.T.)
    LOFORM.KBDYELOT.KEYTEXTBOX.VALUE = LCFABDYE
  ENDIF
  LOFORMSET.LLBROWSE = .F.
  LOFORM.KBDYELOT.SELECTEDFROMBROWSE = .F.
ELSE
  LOFORM.KBDYELOT.KEYTEXTBOX.VALUE = IIF(LOFORMSET.LLBROWSE,'?',LOFORM.KBDYELOT.KEYTEXTBOX.VALUE)
  LOFORMSET.LLBROWSE = .F.
  LOFORM.KBDYELOT.SELECTEDFROMBROWSE = .F.
  LCFABRIC = LOFORM.CNTITEM.CMAJOR
  LCFABCLR = LOFORM.CNTITEM.CNONMAJOR
  LCFABDYE = LOFORM.KBDYELOT.KEYTEXTBOX.VALUE
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	  IF !lfItemQty(loFormSet,loForm,loForm.loRec.cIMTyp,loForm.kbInvTktNo.KeyTextBox.Value,loForm.loRec.cLotNo,;
  *!*	     loForm.loRec.cBomType,loForm.loRec.cOprCode,@lcFabric,@lcFabClr,@lcFabDye)
  IF !LFITEMQTY(LOFORMSET,LOFORM,LOFORMSET.LOREC.CIMTYP,LOFORM.KBINVTKTNO.KEYTEXTBOX.VALUE,LOFORMSET.LOREC.CLOTNO,;
      LOFORMSET.LOREC.CBOMTYPE,LOFORMSET.LOREC.COPRCODE,@LCFABRIC,@LCFABCLR,@LCFABDYE)
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    LCFABDYE = CDYELOT
    LOFORM.CNTITEM.VALUE = LFUPDITEM(LCFABRIC,LCFABCLR)
    LOFORM.KBDYELOT.KEYTEXTBOX.VALUE = LCFABDYE
    LOFORM.REFRESH()
    RETURN
  ELSE
    LOFORM.CNTITEM.VALUE = LFUPDITEM(LCFABRIC,LCFABCLR)
    LOFORM.KBDYELOT.KEYTEXTBOX.VALUE = LCFABDYE
  ENDIF
ENDIF
*CINVTYPE+STYLE
=LOFORMSET.FABRIC.SEEK('0002'+LOFORM.CNTITEM.VALUE) &&Sql86: Check Key
LOFORM.TXTSTYDESC.VALUE = FABRIC.DESC
*Old: SHOW GET lcFabDesc &&Revise
*Old: SHOW GET lcFabric &&Revise
SELECT (LOFORMSET.LCAPVINVDT)
REPLACE ITEM     WITH LOFORM.CNTITEM.CMAJOR  ,;
  COLOR    WITH LOFORM.CNTITEM.CNONMAJOR  ,;
  CDYELOT  WITH LOFORM.KBDYELOT.KEYTEXTBOX.VALUE  ,;
  CAPVIDES WITH LOFORM.TXTSTYDESC.VALUE ,;
  CSTATUS  WITH IIF(CSTATUS='S','M',CSTATUS)
*=lfRefresh('APINVD10')
=LFSHOWWIND(LOFORMSET,LOFORM)
LOFORM.REFRESH()

RETURN
*-- End of lfvFabDye


*!*************************************************************
*! Name      : lfvItem
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 09/02/2004
*! Purpose   : Validate Free Formate Invoice item
*!*************************************************************
*! Parameters:  The FormSet of APPYINV.SCX, The Form of APINVDT.SCX
*!*************************************************************
*! Returns   :  None
*!*************************************************************
FUNCTION LFVITEM
LPARAMETERS LOFORMSET, LOFORM
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*!*	IF Item <> loForm.loRec.Item
*!*	  REPLACE Item WITH loForm.loRec.Item ,;
*!*	          cStatus WITH IIF(cStatus='S','M',cStatus)
SELECT(IIF(LOFORMSET.ACTIVEMODE="V",'APVINVDT2',LOFORMSET.LCAPVINVDT))
IF ITEM <> LOFORMSET.LOREC.ITEM
  REPLACE ITEM WITH LOFORMSET.LOREC.ITEM ,;
    CSTATUS WITH IIF(CSTATUS='S','M',CSTATUS)
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
ENDIF

RETURN
*-- End of lfvItem


*!*************************************************************
*! Name      : lfvItemDesc
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 09/02/2004
*! Purpose   : Validate Free Formate Invoice item Description
*!*************************************************************
*! Parameters:  The FormSet of APPYINV.SCX, The Form of APINVDT.SCX
*!*************************************************************
*! Returns   :  None
*!*************************************************************
FUNCTION LFVITEMDESC
LPARAMETERS LOFORMSET, LOFORM

*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*!*	IF cAPVIDes <> loForm.loRec.cAPVIDes
*!*	  REPLACE cAPVIDes WITH loForm.loRec.cAPVIDes ,;
*!*	          cStatus  WITH IIF(cStatus='S','M',cStatus)
SELECT(IIF(LOFORMSET.ACTIVEMODE="V",'APVINVDT2',LOFORMSET.LCAPVINVDT))
IF CAPVIDES <> LOFORMSET.LOREC.CAPVIDES
  REPLACE CAPVIDES WITH LOFORMSET.LOREC.CAPVIDES ,;
    CSTATUS  WITH IIF(CSTATUS='S','M',CSTATUS)
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
ENDIF

RETURN
*-- End of lfvItemDesc


*!*************************************************************
*! Name      : lfWLTaxCode
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 09/02/2004
*! Purpose   : Called From the When Event of Invoice Line Tax Code in APINVDT.SCX
*!*************************************************************
*! Parameters:  The FormSet of APPYINV.SCX, The Form of APINVDT.SCX
*!*************************************************************
*! Returns   :  None
*!*************************************************************
FUNCTION LFWLTAXCODE
*N000682,1 MMT 12/09/2012 Globalization changes[Start]
*LPARAMETERS LOFORMSET, LOFORM
PARAMETERS LOFORMSET, LOFORM
*N000682,1 MMT 12/09/2012 Globalization changes[eND]
DIMENSION LACODES[ALEN(loFormSet.laCodes,1),ALEN(loFormSet.laCodes,2)]
=ACOPY(LOFORMSET.LACODES,LACODES)
GFWCODEPOP(@LACODES,'CTAXCODE','L')
=ACOPY(LACODES,LOFORMSET.LACODES)
LOFORM.CBOTAXCODE.REQUERY()

RETURN
*-- End of lfWLTaxCode


*!*************************************************************
*! Name      : lfvLTaxCode
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 09/02/2004
*! Purpose   : Validate Invoice Line Tax Code (cboTaxCode) in APINVDT.SCX
*!*************************************************************
*! Parameters:  The FormSet of APPYINV.SCX, The Form of APINVDT.SCX
*!*************************************************************
*! Returns   :  None
*!*************************************************************
FUNCTION LFVLTAXCODE
*N000682,1 MMT 12/09/2012 Globalization changes[Start]
*LPARAMETERS LOFORMSET, LOFORM
PARAMETERS LOFORMSET, LOFORM
*N000682,1 MMT 12/09/2012 Globalization changes[End]
*LPARAMETERS loFormSet, loForm

=SEEK(CVENDCODE+CAPINVNO+CAPVILNO,LOFORMSET.LCTMPDIST)
*B608574,1 05/28/2008 AKA,  Fix the problem adding tax code on AP invoice lines [start]
*IF EVALUATE(loFormSet.lcTmpDist+'.CTAXCODE') <> loFormSet.laTaxCode[loFormSet.lnTaxCode,2]
*N000682,1 MMT 12/09/2012 Globalization changes[Start]
*IF (ALLTRIM(LOFORMSET.LATAXCODE[loFormSet.lnTaxCode,1]) <>"N/A")
IF (ALLTRIM(LOFORMSET.LATAXCODE[loFormSet.lnTaxCode,1]) <>IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_NOTAPPLICABLE,loformset.GetHeaderText("LANG_APPYINV_NOTAPPLICABLE",loformset.HeaderAlias)))
*N000682,1 MMT 12/09/2012 Globalization changes[End]
  *B608574,1 05/28/2008 AKA,  Fix the problem adding tax code on AP invoice lines [End]
  *! B608409,1 SSH 01/16/2008 Incorect Taxes in distribution line screen
  *!*	  DIMENSION laTaxAry[ALEN(loFormSet.laTaxAry,1),ALEN(loFormSet.laTaxAry,2)]
  *!*	  =ACOPY(loFormSet.laTaxAry,laTaxAry)

  PRIVATE CTEMPRETVAL
  DIMENSION LATAXARY[1,2]
  CTEMPRETVAL=""
  LATAXARY[1,1]="CGLINPACCT"
  LATAXARY[1,2]="cTempRetVal"
  =GFRLTFLD(LOFORMSET.LATAXCODE[loFormSet.lnTaxCode,2],@LATAXARY,'CTAXCODE')
  LOFORMSET.LCAPDGLACT=CTEMPRETVAL
  *!*	   =ACOPY(laTaxAry,loFormSet.laTaxAry)
  *! B608409,1 SSH 01/16/2008 Incorect Taxes in distribution line screen
  LOFORMSET.LCAPDGLACT = IIF(!EMPTY(STRTRAN(STRTRAN(LOFORMSET.LCAPDGLACT,'-'),'0')),;
    SUBSTR(LOFORMSET.LCAPDGLACT,1,LEN(ALLTRIM(LOFORMSET.ARIAFORM1.AP1.LCEMPTYACC))), LOFORMSET.ARIAFORM1.AP1.LCEMPTYACC)

  *Message : 04091
  *G/L Input Account xxxx for tax xxxx is not found in the chart of
  *account. You cannot select this tax code
  *Button : 00000
  *Ok
  IF LOFORMSET.ARIAFORM1.AP1.LLAPGLLINK .AND. !SEEK(LOFORMSET.LCAPDGLACT, 'lcLinkChar')
    =GFMODALGEN("TRM04091B00000","DIALOG",ALLTRIM(LOFORMSET.LCAPDGLACT)+'|'+ALLTRIM(LOFORMSET.LATAXCODE[loFormSet.lnTaxCode,1]))
    DIMENSION LACODES[ALEN(loFormSet.laCodes,1),ALEN(loFormSet.laCodes,2)]
    =ACOPY(LOFORMSET.LACODES,LACODES)
    =GFWCODEPOP(@LACODES,'CTAXCODE','T')
    =ACOPY(LACODES,LOFORMSET.LACODES)
    RETURN
  ENDIF
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *loForm.loRec.cApDGlAct = loFormSet.lcApdGLAct
  LOFORMSET.LOREC.CAPDGLACT = LOFORMSET.LCAPDGLACT
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  SELECT (LOFORMSET.LCAPVINVDT)
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	  IF cApDGlAct <> loForm.loRec.cApDGlAct
  *!*	    REPLACE cApDGlAct WITH loForm.loRec.cApDGlAct ,;
  *!*	            cStatus   WITH IIF(cStatus='S','M',cStatus)
  IF CAPDGLACT <> LOFORMSET.LOREC.CAPDGLACT
    REPLACE CAPDGLACT WITH LOFORMSET.LOREC.CAPDGLACT ,;
      CSTATUS   WITH IIF(CSTATUS='S','M',CSTATUS)
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  ENDIF
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *=lfUpdApDist(loFormSet,loForm,cApVILNo,0,cApDGlAct,loForm.loRec.cIMTyp)
  =LFUPDAPDIST(LOFORMSET,LOFORM,CAPVILNO,0,CAPDGLACT,LOFORMSET.LOREC.CIMTYP)
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
ENDIF

SELECT (LOFORMSET.LCAPVINVDT)
REPLACE CTAXCODE  WITH ALLTRIM(LOFORMSET.LATAXCODE[loFormSet.lnTaxCode,2])
IF EMPTY(LOFORMSET.LATAXCODE[loFormSet.lnTaxCode,2])
  IF LOFORMSET.LASETUPS[3,2]='Y'
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *!*	    STORE loFormSet.lcDistAcct TO loForm.loRec.cApDGlAct
    *!*	    IF cApDGlAct <> loForm.loRec.cApDGlAct
    *!*	      REPLACE cApDGlAct WITH loForm.loRec.cApDGlAct ,;
    *!*	              cStatus   WITH IIF(cStatus='S','M',cStatus)
    STORE LOFORMSET.LCDISTACCT TO LOFORMSET.LOREC.CAPDGLACT
    IF CAPDGLACT <> LOFORMSET.LOREC.CAPDGLACT
      REPLACE CAPDGLACT WITH LOFORMSET.LOREC.CAPDGLACT ,;
        CSTATUS   WITH IIF(CSTATUS='S','M',CSTATUS)
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    ENDIF
  ENDIF
  *Old: SHOW GET ibWIPAcnt   ENABLE &&Revise
  *Old: SHOW GET m.cApDGlAct ENABLE &&Revise
  LOFORM.GLAPDGLACT.ENABLED = .T.
ELSE
  *Old: SHOW GET ibWIPAcnt   DISABLE &&Revise
  *Old: SHOW GET m.cApDGlAct DISABLE &&Revise
  LOFORM.GLAPDGLACT.ENABLED = .F.
ENDIF
LOFORM.REFRESH()

RETURN
*-- End of lfvLTaxCode


*!*************************************************************
*! Name      : lfvInvQty
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 09/02/2004
*! Purpose   : Validate Invoice Size Quantity (cntAP_Qty) in APINVDT.SCX
*!*************************************************************
*! Parameters:  The FormSet of APPYINV.SCX, The Form of APINVDT.SCX, lnSize : Style Size Number
*!*************************************************************
*! Returns   :  None
*!*************************************************************
FUNCTION LFVINVQTY
LPARAMETERS LOFORMSET, LOFORM, LNSIZE
PRIVATE LCSIZE

IF !BETWEEN(LNSIZE,1,8)
  RETURN
ENDIF

LCSIZE = STR(LNSIZE,1)
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*!*	IF loForm.loRec.nAPQty&lcSize <> nAPQty&lcSize
*!*	  loForm.loRec.nAPAprQty&lcSize = IIF(loForm.llDefAuApr,loForm.loRec.nAPQty&lcSize,loForm.loRec.nAPAprQty&lcSize)
*!*	  loForm.loRec.nAPAprQty&lcSize = IIF(lfChkAplTkt(loFormSet,loForm,lcSize),loForm.loRec.nAPAprQty&lcSize,nAPAprQty&lcSize)
*!*	  loForm.loRec.nApTAprQty= loForm.loRec.nAPAprQty1+loForm.loRec.nAPAprQty2+loForm.loRec.nAPAprQty3+;
*!*	     loForm.loRec.nAPAprQty4+loForm.loRec.nAPAprQty5+loForm.loRec.nAPAprQty6+;
*!*	     loForm.loRec.nAPAprQty7+loForm.loRec.nAPAprQty8
*!*	  loForm.loRec.nAPTotQty = loForm.loRec.nAPQty1+loForm.loRec.nAPQty2+loForm.loRec.nAPQty3+;
*!*	     loForm.loRec.nAPQty4+loForm.loRec.nAPQty5+loForm.loRec.nAPQty6+loForm.loRec.nAPQty7+;
*!*	     loForm.loRec.nAPQty8

*!*	  loForm.loRec.nApAmnt   = loForm.loRec.nAPTotQty*loForm.loRec.nAPPrice
*!*	  loForm.loRec.nAPAprAmnt= loForm.loRec.nApTAprQty*loForm.loRec.nAPAprPric
*!*	  loFormSet.lnTInvAmt = loFormSet.lnTInvAmt + (ROUND(loForm.loRec.nApAmnt,2)- ROUND(nAPAMnt,2))
*!*	  loFormSet.lnTAprAmt = loFormSet.lnTAprAmt + (ROUND(loForm.loRec.nAPAprAmnt,2)- ROUND(nApAprAmnt,2))
SELECT (LOFORMSET.LCAPVINVDT)
IF LOFORMSET.LOREC.NAPQTY&LCSIZE <> NAPQTY&LCSIZE
  LOFORMSET.LOREC.NAPAPRQTY&LCSIZE = IIF(LOFORM.LLDEFAUAPR,LOFORMSET.LOREC.NAPQTY&LCSIZE,LOFORMSET.LOREC.NAPAPRQTY&LCSIZE)
  LOFORMSET.LOREC.NAPAPRQTY&LCSIZE = IIF(LFCHKAPLTKT(LOFORMSET,LOFORM,LCSIZE),LOFORMSET.LOREC.NAPAPRQTY&LCSIZE,NAPAPRQTY&LCSIZE)
  LOFORMSET.LOREC.NAPTAPRQTY= LOFORMSET.LOREC.NAPAPRQTY1+LOFORMSET.LOREC.NAPAPRQTY2+LOFORMSET.LOREC.NAPAPRQTY3+;
    LOFORMSET.LOREC.NAPAPRQTY4+LOFORMSET.LOREC.NAPAPRQTY5+LOFORMSET.LOREC.NAPAPRQTY6+;
    LOFORMSET.LOREC.NAPAPRQTY7+LOFORMSET.LOREC.NAPAPRQTY8
  LOFORMSET.LOREC.NAPTOTQTY = LOFORMSET.LOREC.NAPQTY1+LOFORMSET.LOREC.NAPQTY2+LOFORMSET.LOREC.NAPQTY3+;
    LOFORMSET.LOREC.NAPQTY4+LOFORMSET.LOREC.NAPQTY5+LOFORMSET.LOREC.NAPQTY6+LOFORMSET.LOREC.NAPQTY7+;
    LOFORMSET.LOREC.NAPQTY8

  LOFORMSET.LOREC.NAPAMNT   = LOFORMSET.LOREC.NAPTOTQTY*LOFORMSET.LOREC.NAPPRICE
  LOFORMSET.LOREC.NAPAPRAMNT= LOFORMSET.LOREC.NAPTAPRQTY*LOFORMSET.LOREC.NAPAPRPRIC
  LOFORMSET.LNTINVAMT = LOFORMSET.LNTINVAMT + (ROUND(LOFORMSET.LOREC.NAPAMNT,2)- ROUND(NAPAMNT,2))
  LOFORMSET.LNTAPRAMT = LOFORMSET.LNTAPRAMT + (ROUND(LOFORMSET.LOREC.NAPAPRAMNT,2)- ROUND(NAPAPRAMNT,2))
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  *=lfRefresh('APINVD10')

  PRIVATE LNDIFFAMNT
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	  lnDiffAmnt =  (ROUND(loForm.loRec.nApAmnt,2) - ROUND(nAPAMnt,2)) * IIF((loForm.loRec.cIMTyp $ 'RF'),IIF(loFormSet.llDebitM,1,1),IIF(loFormSet.llDebitM,-1,1))
  *!*	  =lfUpdApDist(loFormSet,loForm,cApVILNo,lnDiffAmnt,cApDGlAct,loForm.loRec.cIMTyp)
  LNDIFFAMNT =  (ROUND(LOFORMSET.LOREC.NAPAMNT,2) - ROUND(NAPAMNT,2)) * IIF((LOFORMSET.LOREC.CIMTYP $ 'RF'),IIF(LOFORMSET.LLDEBITM,1,1),IIF(LOFORMSET.LLDEBITM,-1,1))
  =LFUPDAPDIST(LOFORMSET,LOFORM,CAPVILNO,LNDIFFAMNT,CAPDGLACT,LOFORMSET.LOREC.CIMTYP)
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  =IIF(LOFORM.LLDEFAUAPR,LFUPDAPLTKT(LOFORMSET, LOFORM),.T.)
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	  REPLACE nAPQty&lcSize    WITH loForm.loRec.nAPQty&lcSize  ,;
  *!*	          nAPAprQty&lcSize WITH loForm.loRec.nAPAprQty&lcSize ,;
  *!*	          nAPTotQty  WITH loForm.loRec.nAPTotQty  ,;
  *!*	          nApTAprQty WITH loForm.loRec.nApTAprQty ,;
  *!*	          nApAmnt    WITH loForm.loRec.nApAmnt    ,;
  *!*	          nAPAprAmnt WITH loForm.loRec.nAPAprAmnt ,;
  *!*	          cStatus   WITH IIF(cStatus='S','M',cStatus)
  REPLACE NAPQTY&LCSIZE    WITH LOFORMSET.LOREC.NAPQTY&LCSIZE  ,;
    NAPAPRQTY&LCSIZE WITH LOFORMSET.LOREC.NAPAPRQTY&LCSIZE ,;
    NAPTOTQTY  WITH LOFORMSET.LOREC.NAPTOTQTY  ,;
    NAPTAPRQTY WITH LOFORMSET.LOREC.NAPTAPRQTY ,;
    NAPAMNT    WITH LOFORMSET.LOREC.NAPAMNT    ,;
    NAPAPRAMNT WITH LOFORMSET.LOREC.NAPAPRAMNT ,;
    CSTATUS   WITH IIF(CSTATUS='S','M',CSTATUS)
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  *Change this line because we are going to switch between 2 Get
  *          Fields for the "Invoice Quantity" to be able to add the
  *          decimal points to the "Invoice Quantity" in the case of
  *          document types Material PO, Material PO Return and
  *          Material MFG Order [Begin]
  *SHOW GET loForm.loRec.nAPTotQty  DISABLE
  LOFORM.TXTAPTOTQTY.ENABLED = .F.
  *SHOW OBJECT loFormSet.lnQtyObj DISABLE
  *Change this line because we are going to switch between 2 [End]

  *Old: SHOW GET loForm.loRec.nApAmnt    ENABLE &&Revise
  LOFORM.TXTAPAMNT.ENABLED = .T.

  *Change this line because we are going to switch between 2 Get
  *          Fields for the "Approve Quantity" to be able to add the
  *          decimal points to the "Approve Quantity" in the case of
  *          document types Material PO, Material PO Return and
  *          Material MFG Order [Begin]
  *SHOW GET loForm.loRec.nApTAprQty DISABLE
  LOFORM.TXTAPTAPRQTY.ENABLED = .F.
  *SHOW OBJECT loFormSet.lnApQtyObj DISABLE
  *Change this line because we are going to switch between 2 [End]

  IF LOFORM.LLDEFEDAPR
    *Old: SHOW GET m.nAPAprQty&lcSize ENABLE &&Revise
    LOFORM.CNTAPAPR_QTY.TXTQTY&LCSIZE..ENABLED = .T.
    *Old: SHOW GET loForm.loRec.nAPAprAmnt ENABLE &&Revise
    LOFORM.TXTAPAPRAMNT.ENABLED = .T.
  ELSE
    *Old: SHOW GET m.nAPAprQty&lcSize DISABLE &&Revise
    LOFORM.CNTAPAPR_QTY.TXTQTY&LCSIZE..ENABLED = .F.
    *Old: SHOW GET loForm.loRec.nAPAprAmnt DISABLE &&Revise
    LOFORM.TXTAPAPRAMNT.ENABLED = .F.
  ENDIF
  *SHOW WINDOW (lcInvDtBr) REFRESH SAME
ENDIF
LOFORM.REFRESH()

RETURN
*-- End of lfvInvQty


*!*************************************************************
*! Name      : lfvAprQty
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 09/02/2004
*! Purpose   : Validate Invoice Approved Size Quantity (cntAPApr_Qty) in APINVDT.SCX
*!*************************************************************
*! Parameters:  The FormSet of APPYINV.SCX, The Form of APINVDT.SCX, lnSize : Style Size Number
*!*************************************************************
*! Returns   :  None
*!*************************************************************
FUNCTION LFVAPRQTY
LPARAMETERS LOFORMSET, LOFORM, LNSIZE
PRIVATE LCSIZE

IF !BETWEEN(LNSIZE,1,8)
  RETURN
ENDIF

LCSIZE = STR(LNSIZE,1)
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*!*	loForm.loRec.nAPAprQty&lcSize = IIF(lfChkAplTkt(loFormSet,loForm,lcSize),loForm.loRec.nAPAprQty&lcSize,nAPAprQty&lcSize)
*!*	IF loForm.loRec.nAPAprQty&lcSize <> nAPAprQty&lcSize
*!*	  loForm.loRec.nApTAprQty = loForm.loRec.nAPAprQty1+loForm.loRec.nAPAprQty2+;
*!*	    loForm.loRec.nAPAprQty3+loForm.loRec.nAPAprQty4+loForm.loRec.nAPAprQty5+;
*!*	    loForm.loRec.nAPAprQty6+loForm.loRec.nAPAprQty7+loForm.loRec.nAPAprQty8
*!*	  loForm.loRec.nAPAprAmnt = loForm.loRec.nApTAprQty*loForm.loRec.nAPAprPric
*!*	  loFormSet.lnTAprAmt = loFormSet.lnTAprAmt  + (ROUND(loForm.loRec.nAPAprAmnt,2)- ROUND(nApAprAmnt,2))*IIF(loForm.loRec.cIMTyp $ 'RF',-1,1)
LOFORMSET.LOREC.NAPAPRQTY&LCSIZE = IIF(LFCHKAPLTKT(LOFORMSET,LOFORM,LCSIZE),LOFORMSET.LOREC.NAPAPRQTY&LCSIZE,NAPAPRQTY&LCSIZE)
IF LOFORMSET.LOREC.NAPAPRQTY&LCSIZE <> NAPAPRQTY&LCSIZE
  LOFORMSET.LOREC.NAPTAPRQTY = LOFORMSET.LOREC.NAPAPRQTY1+LOFORMSET.LOREC.NAPAPRQTY2+;
    LOFORMSET.LOREC.NAPAPRQTY3+LOFORMSET.LOREC.NAPAPRQTY4+LOFORMSET.LOREC.NAPAPRQTY5+;
    LOFORMSET.LOREC.NAPAPRQTY6+LOFORMSET.LOREC.NAPAPRQTY7+LOFORMSET.LOREC.NAPAPRQTY8
  LOFORMSET.LOREC.NAPAPRAMNT = LOFORMSET.LOREC.NAPTAPRQTY*LOFORMSET.LOREC.NAPAPRPRIC
  LOFORMSET.LNTAPRAMT = LOFORMSET.LNTAPRAMT  + (ROUND(LOFORMSET.LOREC.NAPAPRAMNT,2)- ROUND(NAPAPRAMNT,2))*IIF(LOFORMSET.LOREC.CIMTYP $ 'RF',-1,1)
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  *=lfRefresh('APINVD10')
  =LFUPDAPLTKT(LOFORMSET, LOFORM)
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	  REPLACE nAPAprQty&lcSize WITH loForm.loRec.nAPAprQty&lcSize ,;
  *!*	          nApTAprQty WITH loForm.loRec.nApTAprQty ,;
  *!*	          nAPAprAmnt WITH loForm.loRec.nAPAprAmnt ,;
  *!*	          cStatus   WITH IIF(cStatus='S','M',cStatus)
  REPLACE NAPAPRQTY&LCSIZE WITH LOFORMSET.LOREC.NAPAPRQTY&LCSIZE ,;
    NAPTAPRQTY WITH LOFORMSET.LOREC.NAPTAPRQTY ,;
    NAPAPRAMNT WITH LOFORMSET.LOREC.NAPAPRAMNT ,;
    CSTATUS   WITH IIF(CSTATUS='S','M',CSTATUS)
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  *Change this line because we are going to switch between 2 Get
  *          Fields for the "Approve Quantity" to be able to add the
  *          decimal points to the "Approve Quantity" in the case of
  *          document types Material PO, Material PO Return and
  *          Material MFG Order [Begin]
  *SHOW GET loForm.loRec.nApTAprQty DISABLE
  LOFORM.TXTAPTAPRQTY.ENABLED = .F.
  *SHOW OBJECT loFormSet.lnApQtyObj DISABLE
  *Change this line because we are going to switch between 2 [End]

  *Old: SHOW GET loForm.loRec.nAPAprAmnt ENABLE &&Revise
  LOFORM.TXTAPAPRAMNT.ENABLED = .T.
  *SHOW WINDOW (lcInvDtBr) REFRESH SAME
ENDIF
LOFORM.REFRESH()

RETURN
*-- End of lfvAprQty


*!*************************************************************
*! Name      : lfvWipAcnt
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 09/02/2004
*! Purpose   : Validate GL Account
*!*************************************************************
*! Parameters:  The FormSet of APPYINV.SCX, The Form of APINVDT.SCX
*!*************************************************************
*! Returns   :  None
*!*************************************************************
FUNCTION LFVWIPACNT
LPARAMETERS LOFORMSET, LOFORM

LOFORMSET.LLBROWSE = LOFORM.GLAPDGLACT.SELECTEDFROMBROWSE

*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*!*	IF EMPTY(STRTRAN(STRTRAN(loForm.loRec.cApDGlAct,'-'),'0'))
*!*	  loForm.loRec.cApDGlAct = cApDGlAct
IF EMPTY(STRTRAN(STRTRAN(LOFORMSET.LOREC.CAPDGLACT,'-'),'0'))
  LOFORMSET.LOREC.CAPDGLACT = CAPDGLACT
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
ENDIF
LOFORMSET.LLBROWSE=.F.
LOFORM.GLAPDGLACT.SELECTEDFROMBROWSE = .F.

SELECT (LOFORMSET.LCAPVINVDT)
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*!*	IF cApDGlAct <> loForm.loRec.cApDGlAct
*!*	  =lfUpdApDist(loFormSet,loForm,cApVILNo,0,loForm.loRec.cApDGlAct,loForm.loRec.cIMTyp)
*!*	  REPLACE cApDGlAct WITH loForm.loRec.cApDGlAct ,;
*!*	          cStatus   WITH IIF(cStatus='S','M',cStatus)
IF CAPDGLACT <> LOFORMSET.LOREC.CAPDGLACT
  =LFUPDAPDIST(LOFORMSET,LOFORM,CAPVILNO,0,LOFORMSET.LOREC.CAPDGLACT,LOFORMSET.LOREC.CIMTYP)
  REPLACE CAPDGLACT WITH LOFORMSET.LOREC.CAPDGLACT ,;
    CSTATUS   WITH IIF(CSTATUS='S','M',CSTATUS)
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
ENDIF
*Update InvoiceTkt with GL account and Dist. line [Start]
=IIF(LOFORM.LLDEFAUAPR,LFUPDAPLTKT(LOFORMSET, LOFORM),.T.)
*Update InvoiceTkt with GL account and Dist. line [End]

SELECT (LOFORMSET.LCAPVINVDT)
LOFORM.REFRESH()

RETURN
*-- End of lfvWipAcnt


*!*************************************************************
*! Name      : lfvRInvLine
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 09/02/2004
*! Purpose   : Remove Invoice Line
*!*************************************************************
*! Parameters:  The FormSet of APPYINV.SCX, The Form of APINVDT.SCX
*!*************************************************************
*! Returns   :  None
*!*************************************************************
FUNCTION LFVRINVLINE
LPARAMETERS LOFORMSET, LOFORM

IF GFMODALGEN("QRM00007B00007","ALERT") = 1
  LOFORMSET.LNTINVAMT = LOFORMSET.LNTINVAMT - ROUND(EVALUATE(LOFORMSET.LCAPVINVDT+'.nApAmnt'),2)
  LOFORMSET.LNTAPRAMT = LOFORMSET.LNTAPRAMT - ROUND(EVALUATE(LOFORMSET.LCAPVINVDT+'.nApAprAmnt'),2)

  IF SEEK(EVALUATE(LOFORMSET.LCAPVINVDT+'.cVendCode')+EVALUATE(LOFORMSET.LCAPVINVDT+'.cApInvNo')+;
      EVALUATE(LOFORMSET.LCAPVINVDT+'.cAPVILNo'),LOFORMSET.LCAPINVTKT)

    SELECT (LOFORMSET.LCAPINVTKT)
    SCAN REST WHILE CVENDCODE+CAPINVNO+CAPVILNO = ;
        EVALUATE(LOFORMSET.LCAPVINVDT+'.cVendCode')+EVALUATE(LOFORMSET.LCAPVINVDT+'.cApInvNo')+;
        EVALUATE(LOFORMSET.LCAPVINVDT+'.cAPVILNo')
      REPLACE CSTATUS WITH IIF(!EMPTY(NRECNO),'D','S')
      DELETE
    ENDSCAN
  ENDIF
  PRIVATE LNAMAMUNT
  LNAMAMUNT = ROUND(EVALUATE(LOFORMSET.LCAPVINVDT+'.nAPAMnt'),2) * IIF(LOFORMSET.LLDEBITM ,1,-1) * ;
    IIF(EVALUATE(LOFORMSET.LCAPVINVDT+'.CIMTYP') $ 'RF' AND LOFORMSET.LLDEBITM,-1,1)
  =LFUPDAPDIST(LOFORMSET,LOFORM,EVALUATE(LOFORMSET.LCAPVINVDT+'.cApVILNo'),LNAMAMUNT,;
    EVALUATE(LOFORMSET.LCAPVINVDT+'.cApDGlAct'),EVALUATE(LOFORMSET.LCAPVINVDT+'.cIMTyp'))

  SELECT (LOFORMSET.LCAPVINVDT)
  REPLACE CSTATUS WITH IIF(CSTATUS='A','S','D')
  DELETE
  SKIP
  IF EOF()
    *Old: SHOW GET pbRemLine DISABLE &&Revise
    LOFORM.CMDREMOVE.ENABLED = .F.
    GO TOP
  ENDIF
  LFGRDINVDTAFTERROWCOL(LOFORMSET,LOFORM)
  *=lfRefresh('APINVD10')
ENDIF
LOFORM.REFRESH()

RETURN
*-- End of lfvRInvLine


*!*************************************************************
*! Name      : lfGetMaxLin
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 09/02/2004
*! Purpose   : Get the maximum line no from invoicetkt and update LaData[52]
*!*************************************************************
*! Parameters:  The FormSet of APPYINV.SCX, The Form of APINVDT.SCX
*!*************************************************************
*! Returns   :  None
*!*************************************************************
FUNCTION LFGETMAXLIN
LPARAMETERS LOFORMSET, LOFORM
*! B129626,1 ASM 04/24/2005 AP Invoice Error message if line with zero exists [Start]
LOCAL ARRAY LAMAXDISTLN[1]
*! B129626,1 ASM 04/24/2005 AP Invoice Error message if line with zero exists [End]

PRIVATE LCSUMSTR, LCSUMKEY , LNDISTLNNO  , LNRECNO , LNGENTYPE , LCAREA

LCAREA = SELECT()
LNDISTLNNO = 0
LNGENTYPE  = 0
LCSUMKEY = "cVendCode+cApInvNo"
LCSUMSTR = ALLTRIM(LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE) +ALLTRIM(LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE)

SET DELETE OFF
*! B129626,1 ASM 04/24/2005 AP Invoice Error message if line with zero exists [Start]
LAMAXDISTLN = .F.
*! B129626,1 ASM 04/24/2005 AP Invoice Error message if line with zero exists [End]
SELECT MAX(VAL(CAPDLINNO)) FROM (LOFORMSET.LCAPINVTKT) WHERE ALLTRIM(CVENDCODE)+ALLTRIM(CAPINVNO) = LCSUMSTR  ;
  INTO ARRAY LAMAXDISTLN
SET DELETE ON

IF _TALLY <> 0  AND LAMAXDISTLN[1] > 0
  LNDISTLNNO = LAMAXDISTLN[1]
ENDIF

SELECT (LOFORMSET.LCAPVINVDT)
LNRECNO = RECNO()
*! B129626,1 ASM 04/24/2005 AP Invoice Error message if line with zero exists [Start]
SET DELETE OFF
*! B129626,1 ASM 04/24/2005 AP Invoice Error message if line with zero exists [End]
COUNT TO LNGENTYPE FOR CIMTYP = 'G'
*! B129626,1 ASM 04/24/2005 AP Invoice Error message if line with zero exists [Start]
SET DELETE ON
*! B129626,1 ASM 04/24/2005 AP Invoice Error message if line with zero exists [End]
IF BETWEEN (LNRECNO , 1 , RECCOUNT())
  GOTO LNRECNO
ENDIF

SELECT (LCAREA)
RETURN LNDISTLNNO + LNGENTYPE
*-- End of lfGetMaxLin


*!*************************************************************
*! Name      : lfUpdApDist
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 09/02/2004
*! Purpose   : Update AP Distribution
*!*************************************************************
*! Parameters:  The FormSet of APPYINV.SCX, The Form of APINVDT.SCX
*!                       lcInvLineNo : Invoice Line#
*!                       lnAmount    : Amount
*!                       lcGlAccount : Gl Account
*!                       llRemvLine  : .T., Remove the line.
*!                                     Otherwise, Add or Edit the line.
*!*************************************************************
*! Returns   :  None
*!*************************************************************
FUNCTION LFUPDAPDIST
LPARAMETERS LOFORMSET, LOFORM, LCINVLINENO, LNAMOUNT, LCGLACCOUNT, LCTYPE
*!*	ACTIVATE WINDOW trace
*!*	susp
PRIVATE LNALIAS
LNALIAS = SELECT()
PRIVATE LNOAPDAMNT
LNOAPDAMNT  = 0

LNAMOUNT = LNAMOUNT * IIF(LOFORMSET.LLDEBITM AND !(LCTYPE $ 'RF') ,-1,1)

SELECT (LOFORMSET.LCTMPDIST)
IF !SEEK(PADR(LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE,8)+PADR(LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE,12)+STR(0,4))
  APPEND BLANK
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	  REPLACE CVENDCODE WITH loFormSet.AriaForm1.KBVendCode.KeyTextBox.Value  ,;
  *!*	          CINVNO    WITH loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value  ,;
  *!*	          DAPDTRDAT WITH loFormSet.AriaForm1.DtPostDate.Value ,;
  *!*	          LAPDPOST  WITH .F.        ,;
  *!*	          CAPDGLACT WITH loFormSet.DistLines.glAPActCode.KeyTextBox.Value ,;
  *!*	          CAPDACTID WITH 'A'        ,;
  *!*	          CAPDREF   WITH loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value  ,;
  *!*	          CFISFYEAR WITH loFormSet.lcDistYer  ,;
  *!*	          CFSPPRDID WITH loFormSet.lcDistPrd  ,;
  *!*	          CAPSESSNO WITH loFormSet.lcSequence ,;
  *!*	          CAPDTRTYP WITH 'I'        ,;
  *!*	          CSTATUS   WITH 'A'        ,;
  *!*	          CCURRCODE WITH loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value ,;
  *!*	          NEXRATE   WITH loFormSet.AriaForm1.txtNexRate.Value ,;
  *!*	          NCURRUNIT WITH apinvhdr.ncurrunit ,;
  *!*	          NAPDAMNT WITH -loFormSet.AriaForm1.txtInvAmount.Value
  *!*	  lcTemp = '-loFormSet.AriaForm1.txtInvAmount.Value'+loFormSet.lcExSin1+;
  *!*	     'loFormSet.AriaForm1.txtNexRate.Value'+loFormSet.lcExSin2+'apinvhdr.ncurrunit'
  REPLACE CVENDCODE WITH LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE  ,;
    CINVNO    WITH LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE  ,;
    DAPDTRDAT WITH LOFORMSET.ARIAFORM1.DTPOSTDATE.VALUE ,;
    LAPDPOST  WITH .F.        ,;
    CAPDGLACT WITH LOFORMSET.ARIAFORM1.PGFPAYINV.PGDIST.GLAPACTCODE.KEYTEXTBOX.VALUE ,;
    CAPDACTID WITH 'A'        ,;
    CAPDREF   WITH LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE  ,;
    CFISFYEAR WITH LOFORMSET.LCDISTYER  ,;
    CFSPPRDID WITH LOFORMSET.LCDISTPRD  ,;
    CAPSESSNO WITH LOFORMSET.LCSEQUENCE ,;
    CAPDTRTYP WITH 'I'        ,;
    CSTATUS   WITH 'A'        ,;
    CCURRCODE WITH LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.KEYTEXTBOX.VALUE ,;
    NEXRATE   WITH LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTNEXRATE.VALUE ,;
    NCURRUNIT WITH APINVHDR.NCURRUNIT ,;
    NAPDAMNT WITH -LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTINVAMOUNT.VALUE
  LCTEMP = '-loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.Value'+LOFORMSET.LCEXSIN1+;
    'loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.Value'+LOFORMSET.LCEXSIN2+'apinvhdr.ncurrunit'
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][Start]
  TRY
    *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][End]
    REPLACE NEQVAMNT WITH EVALUATE(LCTEMP)
    *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][Start]
  CATCH
    REPLACE NEQVAMNT WITH 0
  ENDTRY
  *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][End]
ENDIF
IF !SEEK(PADR(LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE,8)+PADR(LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE,12)+LCINVLINENO)
  *  IF lnAmount <> 0

  APPEND BLANK
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	    REPLACE CVENDCODE WITH loFormSet.AriaForm1.KBVendCode.KeyTextBox.Value  ,;
  *!*	            CINVNO    WITH loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value  ,;
  *!*	            DAPDTRDAT WITH loFormSet.AriaForm1.DtPostDate.Value ,;
  *!*	            LAPDPOST  WITH .F.        ,;
  *!*	            CAPDACTID WITH 'D'        ,;
  *!*	            CAPDREF   WITH loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value  ,;
  *!*	            CFISFYEAR WITH loFormSet.lcDistYer  ,;
  *!*	            CFSPPRDID WITH loFormSet.lcDistPrd  ,;
  *!*	            CAPSESSNO WITH loFormSet.lcSequence ,;
  *!*	            CAPDTRTYP WITH 'I'        ,;
  *!*	            CSTATUS   WITH 'A'        ,;
  *!*	            NAPDLINNO WITH VAL(lcInvLineNo) ,;
  *!*	            CCURRCODE WITH loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value ,;
  *!*	            NEXRATE   WITH loFormSet.AriaForm1.txtNexRate.Value ,;
  *!*	            NCURRUNIT WITH apinvhdr.ncurrunit ,;
  *!*	            CAPDGLACT WITH lcGlAccount,;
  *!*	            NAPDAMNT  WITH lnAmount
  *!*	    lcTemp = 'lnAmount'+loFormSet.lcExSin1+'loFormSet.AriaForm1.txtNexRate.Value'+;
  *!*	       loFormSet.lcExSin2+'apinvhdr.ncurrunit'
  *    REPLACE NEQVAMNT  WITH EVALUATE(lcTemp), ;
  CTAXCODE  WITH IIF(ApVendor.cTaxType<>'T',;
  IIF(loForm.laTktType[loForm.cboTktType.Value,2]='G' AND !loFormSet.llAutoScr,loFormSet.laTaxCode[loFormSet.lnTaxCode,2],''),'')
  REPLACE CVENDCODE WITH LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE  ,;
    CINVNO    WITH LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE  ,;
    DAPDTRDAT WITH LOFORMSET.ARIAFORM1.DTPOSTDATE.VALUE ,;
    LAPDPOST  WITH .F.        ,;
    CAPDACTID WITH 'D'        ,;
    CAPDREF   WITH LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE  ,;
    CFISFYEAR WITH LOFORMSET.LCDISTYER  ,;
    CFSPPRDID WITH LOFORMSET.LCDISTPRD  ,;
    CAPSESSNO WITH LOFORMSET.LCSEQUENCE ,;
    CAPDTRTYP WITH 'I'        ,;
    CSTATUS   WITH 'A'        ,;
    NAPDLINNO WITH VAL(LCINVLINENO) ,;
    CCURRCODE WITH LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.KEYTEXTBOX.VALUE ,;
    NEXRATE   WITH LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.TXTNEXRATE.VALUE ,;
    NCURRUNIT WITH APINVHDR.NCURRUNIT ,;
    CAPDGLACT WITH LCGLACCOUNT,;
    NAPDAMNT  WITH LNAMOUNT
  LCTEMP = 'lnAmount'+LOFORMSET.LCEXSIN1+'loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.Value'+;
    LOFORMSET.LCEXSIN2+'apinvhdr.ncurrunit'
  *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][Start]
  TRY
    *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][End]
    REPLACE NEQVAMNT  WITH EVALUATE(LCTEMP), ;
      CTAXCODE  WITH IIF(APVENDOR.CTAXTYPE<>'T',;
      IIF(LOFORMSET.LATKTTYPE[loForm.cboTktType.Value,2]='G' AND !LOFORMSET.LLAUTOSCR,LOFORMSET.LATAXCODE[loFormSet.lnTaxCode,2],''),'')
    *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][Start]
  CATCH
    REPLACE NEQVAMNT  WITH 0, ;
      CTAXCODE  WITH IIF(APVENDOR.CTAXTYPE<>'T',;
      IIF(LOFORMSET.LATKTTYPE[loForm.cboTktType.Value,2]='G' AND !LOFORMSET.LLAUTOSCR,LOFORMSET.LATAXCODE[loFormSet.lnTaxCode,2],''),'')
  ENDTRY
  *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][End]
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  *  ENDIF

ELSE
  LOCATE REST WHILE CVENDCODE+CINVNO+STR(NAPDLINNO,4) = ;
    PADR(LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE,8)+PADR(LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE,12)+LCINVLINENO FOR CAPDSTAT <> 'V'
  LNOAPDAMNT = NAPDAMNT

  IF CSTATUS = 'A'
    REPLACE CAPDGLACT WITH LCGLACCOUNT,;
      NAPDAMNT  WITH NAPDAMNT + LNAMOUNT
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *!*	    lcTemp = 'lnAmount'+loFormSet.lcExSin1+'loFormSet.AriaForm1.txtNexRate.Value'+;
    *!*	      loFormSet.lcExSin2+'apinvhdr.ncurrunit'
    *!*	    REPLACE NEQVAMNT  WITH NEQVAMNT + EVALUATE(lcTemp),;
    *!*	            CTAXCODE  WITH IIF(ApVendor.cTaxType<>'T',;
    *!*	            IIF(loForm.laTktType[loForm.cboTktType.Value,2]='G' AND !loFormSet.llAutoScr,loFormSet.laTaxCode[loFormSet.lnTaxCode,2],''),'')
    LCTEMP = 'lnAmount'+LOFORMSET.LCEXSIN1+'loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.Value'+;
      LOFORMSET.LCEXSIN2+'apinvhdr.ncurrunit'
    *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][Start]
    TRY
      *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][End]
      REPLACE NEQVAMNT  WITH NEQVAMNT + EVALUATE(LCTEMP),;
        CTAXCODE  WITH IIF(APVENDOR.CTAXTYPE<>'T',;
        IIF(LOFORMSET.LATKTTYPE[loForm.cboTktType.Value,2]='G' AND !LOFORMSET.LLAUTOSCR,LOFORMSET.LATAXCODE[loFormSet.lnTaxCode,2],''),'')
      *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][Start]
    CATCH
      REPLACE NEQVAMNT  WITH NEQVAMNT + 0,;
        CTAXCODE  WITH IIF(APVENDOR.CTAXTYPE<>'T',;
        IIF(LOFORMSET.LATKTTYPE[loForm.cboTktType.Value,2]='G' AND !LOFORMSET.LLAUTOSCR,LOFORMSET.LATAXCODE[loFormSet.lnTaxCode,2],''),'')
    ENDTRY
    *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][End]
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[END]
    IF NAPDAMNT=0
      REPLACE CSTATUS WITH 'S'
      DELETE
    ENDIF
  ELSE
    *Void Modified Line
    REPLACE CAPDSTAT  WITH 'V' ,;
      CSTATUS   WITH 'M' ,;
      CAPSESSNO WITH LOFORMSET.LCSEQUENCE
    SCATTER MEMVAR MEMO
    m.CSTATUS   = 'A'
    m.CBATCHNO  = ' '
    m.CTRNSLEDN = ' '
    m.NENTRYNO  = 0
    m.LAPDPOST  = .F.
    m.NAPDAMNT  = -1 * m.NAPDAMNT
    m.NEQVAMNT  = -1 * m.NEQVAMNT
    APPEND BLANK
    GATHER MEMVAR MEMO

    *Add New Line
    m.CAPDGLACT = LCGLACCOUNT
    m.CAPDSTAT  = ' '
    m.NAPDAMNT  = -1 * m.NAPDAMNT + LNAMOUNT
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *!*	    lcTemp = 'lnAmount'+loFormSet.lcExSin1+'loFormSet.AriaForm1.txtNexRate.Value'+;
    *!*	     loFormSet.lcExSin2+'apinvhdr.ncurrunit'
    LCTEMP = 'lnAmount'+LOFORMSET.LCEXSIN1+'loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.Value'+;
      LOFORMSET.LCEXSIN2+'apinvhdr.ncurrunit'
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][Start]
    TRY
      *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][End]
      m.NEQVAMNT  = -1 * m.NEQVAMNT + EVALUATE(LCTEMP)
      *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][Start]
    CATCH
      m.NEQVAMNT  = -1 * m.NEQVAMNT
    ENDTRY
    *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][End]
    **! B608492,1 SSH Allow Zero amount.
    IF .T. &&m.nApdAmnt <> 0
      APPEND BLANK
      GATHER MEMVAR MEMO
    ELSE
      LNOAPDAMNT = 0
    ENDIF
  ENDIF
ENDIF
LOFORMSET.LNDISTAMNT = LOFORMSET.LNDISTAMNT + NAPDAMNT - LNOAPDAMNT

SELECT (LNALIAS)

RETURN
*-- End of lfUpdApDist


*!*************************************************************
*! Name      : lfItemQty
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 09/02/2004
*! Purpose   : Default Invoice line quantity and amount with ticket budget
*!             quantity after deducting invoices applied to this ticket
*!*************************************************************
*! Parameters:  The FormSet of APPYINV.SCX, The Form of APINVDT.SCX,
*!                       lcTktType  : Ticket Type
*!                       lcTicketNo : Ticket#
*!                       lcLotNo    : Lot#
*!                       lcCostType : Cost Type
*!                       lcMfgCode  : MFG Operation
*!                       lcItem     : Item
*!                       lcColor    : Color
*!                       lcDyelot   : Dyelot
*!*************************************************************
*! Return     : None
*!*************************************************************
FUNCTION LFITEMQTY
LPARAMETERS LOFORMSET ,LOFORM ,LCTKTTYPE ,LCTICKETNO ,LCLOTNO ,LCCOSTTYPE ,LCMFGCODE ,;
  LCITEM, LCCOLOR, LCDYELOT
PRIVATE LCINVLINENO, LCBRFIELDS

LCINVLINENO = EVALUATE(LOFORMSET.LCAPVINVDT+'.cApVILNo')
IF !LFGENINVLN(LOFORMSET,LOFORM,LCTKTTYPE,LCTICKETNO,LCMFGCODE,LCLOTNO,SPACE(6),LCCOSTTYPE,;
    LCITEM,LCCOLOR,LCDYELOT)
  =LFGENINVLN(LOFORMSET,LOFORM,LCTKTTYPE,LCTICKETNO,LCMFGCODE,LCLOTNO,SPACE(6),LCCOSTTYPE,'','','')
  SELECT (LOFORMSET.LCAUTOINV)
  *N000682,1 MMT 12/09/2012 Globalization changes[Start]
  *LCBRFIELDS = "nTktQty :H='Bud. Qty',nTktCst :H= 'Bud. Cost',nTktAmnt :H='Bud. Amnt',"
  *LCBRFIELDS = LCBRFIELDS+"nInvQty :H='Inv. Qty.',nInvCst=IIF(nInvQty=0,0,nInvAmnt/nInvQty) :P='999999999.999' :H='Inv. Cost',nInvAmnt :H='Inv. Amnt.',"
  *LCBRFIELDS = LCBRFIELDS+"nAplQty :H='Apl. Qty.',nAplCst=IIF(nAplQty =0,0,nAplAmnt/nAplQty ) :P='999999999.999' :H='Inv. Cost',nAplAmnt :H='Apl. Amnt.'"
  LCBRFIELDS = "nTktQty :H='"+;
  IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_BUD_QTY,loformset.GetHeaderText("LANG_APPYINV_BUD_QTY",loformset.HeaderAlias))+"',nTktCst :H= '"+;
  IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_BUD_COST,loformset.GetHeaderText("LANG_APPYINV_BUD_COST",loformset.HeaderAlias))+"',nTktAmnt :H='"+;
  IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_BUD_AMNT,loformset.GetHeaderText("LANG_APPYINV_BUD_AMNT",loformset.HeaderAlias))+"',"
  LCBRFIELDS = LCBRFIELDS+"nInvQty :H='"+;
  IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_INV_QTY,loformset.GetHeaderText("LANG_APPYINV_INV_QTY",loformset.HeaderAlias))+"',nInvCst=IIF(nInvQty=0,0,nInvAmnt/nInvQty) :P='999999999.999' :H='"+;
  IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_INV_COST,loformset.GetHeaderText("LANG_APPYINV_INV_COST",loformset.HeaderAlias))+"',nInvAmnt :H='"+;
  IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_INV_AMNT,loformset.GetHeaderText("LANG_APPYINV_INV_AMNT",loformset.HeaderAlias))+"',"
  LCBRFIELDS = LCBRFIELDS+"nAplQty :H='"+;
  IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_APL_QTY,loformset.GetHeaderText("LANG_APPYINV_APL_QTY",loformset.HeaderAlias))+"',nAplCst=IIF(nAplQty =0,0,nAplAmnt/nAplQty ) :P='999999999.999' :H='"+;
  IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_INV_COST,loformset.GetHeaderText("LANG_APPYINV_INV_COST",loformset.HeaderAlias))+"',nAplAmnt :H='"+;
  IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_APL_AMNT,loformset.GetHeaderText("LANG_APPYINV_APL_AMNT",loformset.HeaderAlias))+"'"
  *N000682,1 MMT 12/09/2012 Globalization changes[End]
  IF INLIST(LCTKTTYPE,'S','I','M','R','A','D')
    *N000682,1 MMT 12/09/2012 Globalization changes[Start]
    *LCBRFIELDS = "Item :H='"+LOFORM.CNTSTYLE.LBLITEMHEADER.CAPTION+"',"+;
      IIF(LOFORMSET.LASETUPS[1,2]='Y',"cDyelot :H='Dyelot',",'')+LCBRFIELDS
    LCBRFIELDS = "Item :H='"+LOFORM.CNTSTYLE.LBLITEMHEADER.CAPTION+"',"+;
      IIF(LOFORMSET.LASETUPS[1,2]='Y',"cDyelot :H='"+;
	  IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_DYELOT,loformset.GetHeaderText("LANG_APPYINV_DYELOT",loformset.HeaderAlias))+"',",'')+LCBRFIELDS  
   *N000682,1 MMT 12/09/2012 Globalization changes[End]
  ELSE
    *N000682,1 MMT 12/09/2012 Globalization changes[Start]
    *LCBRFIELDS = "cItem=SUBSTR(Item,1,"+ALLTRIM(STR(LOFORMSET.LNFABMAJLEN))+") :H='Fabric',Color :H='Color',"+;
      IIF(LOFORMSET.LASETUPS[2,2]='Y',"cDyelot :H='Dyelot',",'')+LCBRFIELDS
    LCBRFIELDS = "cItem=SUBSTR(Item,1,"+ALLTRIM(STR(LOFORMSET.LNFABMAJLEN))+") :H='"+;
	             IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_FABRIC,loformset.GetHeaderText("LANG_APPYINV_FABRIC",loformset.HeaderAlias))+"',Color :H='"+;
				 IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_COLOR,loformset.GetHeaderText("LANG_APPYINV_COLOR",loformset.HeaderAlias))+"',"+;
      IIF(LOFORMSET.LASETUPS[2,2]='Y',"cDyelot :H='"+;
	  IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_DYELOT,loformset.GetHeaderText("LANG_APPYINV_DYELOT",loformset.HeaderAlias))+"',",'')+LCBRFIELDS
    *N000682,1 MMT 12/09/2012 Globalization changes[Start]
  ENDIF
  *N000682,1 MMT 12/09/2012 Globalization changes[Start]
  *IF !ARIABROW('','Ticket Items',GNBRHSROW1,;
      GNBRHSCOL1,GNBRHSROW2,GNBRHSCOL2,'','','Item','laBrowArr')
  IF !ARIABROW('',IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_BRTICKETITEMS,loformset.GetHeaderText("LANG_APPYINV_BRTICKETITEMS",loformset.HeaderAlias)),GNBRHSROW1,;
      GNBRHSCOL1,GNBRHSROW2,GNBRHSCOL2,'','','Item','laBrowArr')
  *N000682,1 MMT 12/09/2012 Globalization changes[End]
    SELECT (LOFORMSET.LCAPVINVDT)
    =SEEK(PADR(LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE,8)+PADR(LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE,12)+LCINVLINENO)
    RETURN(.F.)
  ENDIF
ENDIF
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*!*	STORE EVALUATE(loFormSet.lcAutoInv+'.Item')    TO lcItem, loForm.loRec.Item
*!*	STORE EVALUATE(loFormSet.lcAutoInv+'.Color')   TO lcColor, loForm.loRec.Color
*!*	STORE EVALUATE(loFormSet.lcAutoInv+'.cDyelot') TO lcDyelot, loForm.loRec.cDyelot
STORE EVALUATE(LOFORMSET.LCAUTOINV+'.Item')    TO LCITEM, LOFORMSET.LOREC.ITEM
STORE EVALUATE(LOFORMSET.LCAUTOINV+'.Color')   TO LCCOLOR, LOFORMSET.LOREC.COLOR
STORE EVALUATE(LOFORMSET.LCAUTOINV+'.cDyelot') TO LCDYELOT, LOFORMSET.LOREC.CDYELOT
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

SELECT (LOFORMSET.LCAPVINVDT)
=SEEK(PADR(LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE,8)+PADR(LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE,12)+LCINVLINENO)
IF LCITEM+LCCOLOR+LCDYELOT = EVALUATE(LOFORMSET.LCAPVINVDT+'.Item')+;
    EVALUATE(LOFORMSET.LCAPVINVDT+'.Color')+EVALUATE(LOFORMSET.LCAPVINVDT+'.cDyelot')
  RETURN(.F.)
ENDIF

*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*!*	STORE EVALUATE(loFormSet.lcAutoInv+'.nInvQty')  TO loForm.loRec.nAPTotQty
*!*	STORE EVALUATE(loFormSet.lcAutoInv+'.nInvAmnt') TO loForm.loRec.nApAmnt
*!*	STORE EVALUATE(loFormSet.lcAutoInv+'.LineNo')  TO loForm.loRec.LineNo
*!*	STORE IIF(loForm.loRec.nAPTotQty=0,0,loForm.loRec.nApAmnt/loForm.loRec.nAPTotQty) TO ;
*!*	   loForm.loRec.nAPPrice
STORE EVALUATE(LOFORMSET.LCAUTOINV+'.nInvQty')  TO LOFORMSET.LOREC.NAPTOTQTY
STORE EVALUATE(LOFORMSET.LCAUTOINV+'.nInvAmnt') TO LOFORMSET.LOREC.NAPAMNT
STORE EVALUATE(LOFORMSET.LCAUTOINV+'.LineNo')  TO LOFORMSET.LOREC.LINENO
STORE IIF(LOFORMSET.LOREC.NAPTOTQTY=0,0,LOFORMSET.LOREC.NAPAMNT/LOFORMSET.LOREC.NAPTOTQTY) TO ;
  LOFORMSET.LOREC.NAPPRICE
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
IF INLIST(LCTKTTYPE,'I','S','M','R','A','D')
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	  STORE EVALUATE(loFormSet.lcAutoInv+'.nInvQty1') TO loForm.loRec.nAPQty1
  *!*	  STORE EVALUATE(loFormSet.lcAutoInv+'.nInvQty2') TO loForm.loRec.nAPQty2
  *!*	  STORE EVALUATE(loFormSet.lcAutoInv+'.nInvQty3') TO loForm.loRec.nAPQty3
  *!*	  STORE EVALUATE(loFormSet.lcAutoInv+'.nInvQty4') TO loForm.loRec.nAPQty4
  *!*	  STORE EVALUATE(loFormSet.lcAutoInv+'.nInvQty5') TO loForm.loRec.nAPQty5
  *!*	  STORE EVALUATE(loFormSet.lcAutoInv+'.nInvQty6') TO loForm.loRec.nAPQty6
  *!*	  STORE EVALUATE(loFormSet.lcAutoInv+'.nInvQty7') TO loForm.loRec.nAPQty7
  *!*	  STORE EVALUATE(loFormSet.lcAutoInv+'.nInvQty8') TO loForm.loRec.nAPQty8
  STORE EVALUATE(LOFORMSET.LCAUTOINV+'.nInvQty1') TO LOFORMSET.LOREC.NAPQTY1
  STORE EVALUATE(LOFORMSET.LCAUTOINV+'.nInvQty2') TO LOFORMSET.LOREC.NAPQTY2
  STORE EVALUATE(LOFORMSET.LCAUTOINV+'.nInvQty3') TO LOFORMSET.LOREC.NAPQTY3
  STORE EVALUATE(LOFORMSET.LCAUTOINV+'.nInvQty4') TO LOFORMSET.LOREC.NAPQTY4
  STORE EVALUATE(LOFORMSET.LCAUTOINV+'.nInvQty5') TO LOFORMSET.LOREC.NAPQTY5
  STORE EVALUATE(LOFORMSET.LCAUTOINV+'.nInvQty6') TO LOFORMSET.LOREC.NAPQTY6
  STORE EVALUATE(LOFORMSET.LCAUTOINV+'.nInvQty7') TO LOFORMSET.LOREC.NAPQTY7
  STORE EVALUATE(LOFORMSET.LCAUTOINV+'.nInvQty8') TO LOFORMSET.LOREC.NAPQTY8
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
ENDIF
IF LOFORM.LLDEFAUAPR
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	  STORE loForm.loRec.nAPTotQty TO loForm.loRec.nApTAprQty
  *!*	  STORE loForm.loRec.nAPPrice  TO loForm.loRec.nAPAprPric
  *!*	  STORE loForm.loRec.nApAmnt   TO loForm.loRec.nAPAprAmnt
  STORE LOFORMSET.LOREC.NAPTOTQTY TO LOFORMSET.LOREC.NAPTAPRQTY
  STORE LOFORMSET.LOREC.NAPPRICE  TO LOFORMSET.LOREC.NAPAPRPRIC
  STORE LOFORMSET.LOREC.NAPAMNT   TO LOFORMSET.LOREC.NAPAPRAMNT
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  IF INLIST(LCTKTTYPE,'I','S','M','R','A','D')
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *!*	    STORE loForm.loRec.nAPQty1 TO loForm.loRec.nAPAprQty1
    *!*	    STORE loForm.loRec.nAPQty2 TO loForm.loRec.nAPAprQty2
    *!*	    STORE loForm.loRec.nAPQty3 TO loForm.loRec.nAPAprQty3
    *!*	    STORE loForm.loRec.nAPQty4 TO loForm.loRec.nAPAprQty4
    *!*	    STORE loForm.loRec.nAPQty5 TO loForm.loRec.nAPAprQty5
    *!*	    STORE loForm.loRec.nAPQty6 TO loForm.loRec.nAPAprQty6
    *!*	    STORE loForm.loRec.nAPQty7 TO loForm.loRec.nAPAprQty7
    *!*	    STORE loForm.loRec.nAPQty8 TO loForm.loRec.nAPAprQty8
    STORE LOFORMSET.LOREC.NAPQTY1 TO LOFORMSET.LOREC.NAPAPRQTY1
    STORE LOFORMSET.LOREC.NAPQTY2 TO LOFORMSET.LOREC.NAPAPRQTY2
    STORE LOFORMSET.LOREC.NAPQTY3 TO LOFORMSET.LOREC.NAPAPRQTY3
    STORE LOFORMSET.LOREC.NAPQTY4 TO LOFORMSET.LOREC.NAPAPRQTY4
    STORE LOFORMSET.LOREC.NAPQTY5 TO LOFORMSET.LOREC.NAPAPRQTY5
    STORE LOFORMSET.LOREC.NAPQTY6 TO LOFORMSET.LOREC.NAPAPRQTY6
    STORE LOFORMSET.LOREC.NAPQTY7 TO LOFORMSET.LOREC.NAPAPRQTY7
    STORE LOFORMSET.LOREC.NAPQTY8 TO LOFORMSET.LOREC.NAPAPRQTY8
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[end]
  ENDIF
ENDIF
*B607416,1 ALB Fix bug when Saving the debit memo againest Return PO [BEGIN]
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*!*	loForm.loRec.nAPPrice   = loForm.loRec.nAPPrice   * IIF((loForm.loRec.cIMTyp $ 'RF') OR loFormSet.llDebitM ,-1,1)
*!*	loForm.loRec.nApAmnt    = loForm.loRec.nApAmnt    * IIF((loForm.loRec.cIMTyp $ 'RF') OR loFormSet.llDebitM ,-1,1)
*!*	loForm.loRec.nAPAprPric = loForm.loRec.nAPAprPric * IIF((loForm.loRec.cIMTyp $ 'RF') OR loFormSet.llDebitM ,-1,1)
*!*	loForm.loRec.nAPAprAmnt = loForm.loRec.nAPAprAmnt * IIF((loForm.loRec.cIMTyp $ 'RF') OR loFormSet.llDebitM ,-1,1)
*!*	loFormSet.lnTInvAmt = loFormSet.lnTInvAmt + (ROUND(loForm.loRec.nApAmnt,2)- ROUND(nAPAMnt,2))
*!*	loFormSet.lnTAprAmt = loFormSet.lnTAprAmt + (ROUND(loForm.loRec.nAPAprAmnt,2)- ROUND(nApAprAmnt,2))
LOFORMSET.LOREC.NAPPRICE   = LOFORMSET.LOREC.NAPPRICE   * IIF((LOFORMSET.LOREC.CIMTYP $ 'RF') OR LOFORMSET.LLDEBITM ,-1,1)
LOFORMSET.LOREC.NAPAMNT    = LOFORMSET.LOREC.NAPAMNT    * IIF((LOFORMSET.LOREC.CIMTYP $ 'RF') OR LOFORMSET.LLDEBITM ,-1,1)
LOFORMSET.LOREC.NAPAPRPRIC = LOFORMSET.LOREC.NAPAPRPRIC * IIF((LOFORMSET.LOREC.CIMTYP $ 'RF') OR LOFORMSET.LLDEBITM ,-1,1)
LOFORMSET.LOREC.NAPAPRAMNT = LOFORMSET.LOREC.NAPAPRAMNT * IIF((LOFORMSET.LOREC.CIMTYP $ 'RF') OR LOFORMSET.LLDEBITM ,-1,1)
LOFORMSET.LNTINVAMT = LOFORMSET.LNTINVAMT + (ROUND(LOFORMSET.LOREC.NAPAMNT,2)- ROUND(NAPAMNT,2))
LOFORMSET.LNTAPRAMT = LOFORMSET.LNTAPRAMT + (ROUND(LOFORMSET.LOREC.NAPAPRAMNT,2)- ROUND(NAPAPRAMNT,2))
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[ENd]
PRIVATE LNDIFFAMNT
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*!*	lnDiffAmnt =  (ROUND(loForm.loRec.nApAmnt,2) - ROUND(nAPAMnt,2)) * IIF((loForm.loRec.cIMTyp $ 'RF'),1,IIF(loFormSet.llDebitM,-1,1))
LNDIFFAMNT =  (ROUND(LOFORMSET.LOREC.NAPAMNT,2) - ROUND(NAPAMNT,2)) * IIF((LOFORMSET.LOREC.CIMTYP $ 'RF'),1,IIF(LOFORMSET.LLDEBITM,-1,1))
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
=LFUPDAPDIST(LOFORMSET,LOFORM,CAPVILNO,LNDIFFAMNT,CAPDGLACT,LCTKTTYPE)

=LFUPDAPLTKT(LOFORMSET, LOFORM)
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*GATHER NAME loForm.loRec
GATHER NAME LOFORMSET.LOREC
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[ENd]
RETURN
*-- End of lfItemQty


*!*************************************************************
*! Name      : lfUpdAplTkt
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 09/02/2004
*! Purpose   : Update Ticket Applied Quantity & Amount
*!*************************************************************
*! Parameters:  The FormSet of APPYINV.SCX, The Form of APINVDT.SCX
*!*************************************************************
*! Returns   :  None
*!*************************************************************
FUNCTION LFUPDAPLTKT
LPARAMETERS LOFORMSET, LOFORM

PRIVATE LNALIAS

*?AMIN
IF EMPTY(EVALUATE(LOFORMSET.LCAPVINVDT+'.cTktNo')) AND ;
    EMPTY(EVALUATE(LOFORMSET.LCAPVINVDT+'.ShipNo'))
  RETURN
ENDIF

PRIVATE LNCURALS,LCPINVLNO,LACONTTOT, LLUPDTKTL
LCPINVLNO = EVALUATE(LOFORMSET.LCAPVINVDT+'.cApVILNo')
LNCURALS  = SELECT(0)
SELECT COUNT(*),SUM(IIF(!EMPTY(CRSESSION),NAPAPLAMNT,0)) ;
  FROM (LOFORMSET.LCAPINVTKT)             ;
  WHERE CVENDCODE         + CAPINVNO           + CAPVILNO  + CRSESSION= ;
  PADR(LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE,8) + PADR(LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE,12) + LCPINVLNO + ""  ;
  INTO ARRAY LACONTTOT

IF _TALLY <> 0 AND LACONTTOT[1] = 1 AND ;
    SEEK(PADR(LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE,8)+;
    PADR(LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE,12)+;
    EVALUATE(LOFORMSET.LCAPVINVDT+'.cApVILNo'),LOFORMSET.LCAPINVTKT) AND ;
    !EMPTY(EVALUATE(LOFORMSET.LCAPINVTKT+'.cRSession')) AND ;
    !(EVALUATE(LOFORMSET.LCAPINVTKT+'.nApAplAmnt') = 0 )
  LLUPDTKTL = .F.
ELSE
  LLUPDTKTL = .T.
ENDIF

IF LLUPDTKTL
  LNALIAS = SELECT()
  SELECT (LOFORMSET.LCAPINVTKT)

  *Add these lines to restore the old uncontributed record, if there
  *          is one.
  *          Note: we will restore the old record for 2 purposes.
  *          1 - To minimize the size of the file
  *          2 - To be able to add the uncontributed record from the
  *          "Contribution" screen easily by restoring the old one. [Begin]
  LCSETDELET = SET('DELETED')        && Save the SET DELETED status
  SET DELETED OFF
  *Add these lines to restore the old uncontributed record [End]

  IF !SEEK(PADR(LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE,8)+;
      PADR(LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE,12)+;
      EVALUATE(LOFORMSET.LCAPVINVDT+'.cApVILNo')+SPACE(6))

    INSERT INTO (LOFORMSET.LCAPINVTKT) (CVENDCODE,CAPINVNO,CAPVILNO,CSTATUS,CIMTYP,CTKTNO) VALUES  ;
      (LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE,;
      LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE,;
      EVALUATE(LOFORMSET.LCAPVINVDT+'.cApVILNo'),'A',;
      EVALUATE(LOFORMSET.LCAPVINVDT+'.cIMTyp'),EVALUATE(LOFORMSET.LCAPVINVDT+'.cTktNo'))

    *Add the else condition to restore the old uncontributed record,
    *          if there is one.
    *          Note: we will restore the old record for 2 purposes.
    *          1 - To minimize the size of the file
    *          2 - To be able to add the uncontributed record from the
    *          "Contribution" screen easily by restoring the old one. [Begin]
  ELSE    && Else (if there is uncontribitued amount line)
    *-- if the uncontribitued amount line is deleted
    IF DELETED()
      RECALL        && Recall the deleted record
      REPLACE CSTATUS WITH IIF(NRECNO = 0 , 'A' , 'M')
    ENDIF    && End of IF DELETED()
    *Add the else condition to restore the old uncontributed [End]

  ENDIF

  *Add this line to restore the old uncontributed record, if there
  *          is one.
  *          Note: we will restore the old record for 2 purposes.
  *          1 - To minimize the size of the file
  *          2 - To be able to add the uncontributed record from the
  *          "Contribution" screen easily by restoring the old one. [Begin]
  SET DELETED &LCSETDELET        && Restore the old SET DELETED status
  *Add this lines to restore the old uncontributed record [End]

  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	  REPLACE LineNo     WITH loForm.loRec.LineNo     ,;
  *!*	          Item       WITH loForm.loRec.Item       ,;
  *!*	          Color      WITH loForm.loRec.Color      ,;
  *!*	          cDyelot    WITH loForm.loRec.cDyelot    ,;
  *!*	          nApAplQty1 WITH nApAplQty1 - EVALUATE(loFormSet.lcAPvInvDt+'.nApAprQty1') + loForm.loRec.nApAprQty1 ,;
  *!*	          nApAplQty2 WITH nApAplQty2 - EVALUATE(loFormSet.lcAPvInvDt+'.nApAprQty2') + loForm.loRec.nApAprQty2 ,;
  *!*	          nApAplQty3 WITH nApAplQty3 - EVALUATE(loFormSet.lcAPvInvDt+'.nApAprQty3') + loForm.loRec.nApAprQty3 ,;
  *!*	          nApAplQty4 WITH nApAplQty4 - EVALUATE(loFormSet.lcAPvInvDt+'.nApAprQty4') + loForm.loRec.nApAprQty4 ,;
  *!*	          nApAplQty5 WITH nApAplQty5 - EVALUATE(loFormSet.lcAPvInvDt+'.nApAprQty5') + loForm.loRec.nApAprQty5 ,;
  *!*	          nApAplQty6 WITH nApAplQty6 - EVALUATE(loFormSet.lcAPvInvDt+'.nApAprQty6') + loForm.loRec.nApAprQty6 ,;
  *!*	          nApAplQty7 WITH nApAplQty7 - EVALUATE(loFormSet.lcAPvInvDt+'.nApAprQty7') + loForm.loRec.nApAprQty7 ,;
  *!*	          nApAplQty8 WITH nApAplQty8 - EVALUATE(loFormSet.lcAPvInvDt+'.nApAprQty8') + loForm.loRec.nApAprQty8 ,;
  *!*	          nApTAplQty WITH nApTAplQty - EVALUATE(loFormSet.lcAPvInvDt+'.nApTAprQty') + loForm.loRec.nApTAprQty ,;
  *!*	          nApAPlPric WITH loForm.loRec.nAPAprPric ,;
  *!*	          nApAplAmnt WITH nApAplAmnt - EVALUATE(loFormSet.lcAPvInvDt+'.nApApRAmnt') + loForm.loRec.nAPAprPric*loForm.loRec.nApTAprQty,;
  *!*	          cStatus    WITH IIF(cStatus='S','M',cStatus)
  REPLACE LINENO     WITH LOFORMSET.LOREC.LINENO     ,;
    ITEM       WITH LOFORMSET.LOREC.ITEM       ,;
    COLOR      WITH LOFORMSET.LOREC.COLOR      ,;
    CDYELOT    WITH LOFORMSET.LOREC.CDYELOT    ,;
    NAPAPLQTY1 WITH NAPAPLQTY1 - EVALUATE(LOFORMSET.LCAPVINVDT+'.nApAprQty1') + LOFORMSET.LOREC.NAPAPRQTY1 ,;
    NAPAPLQTY2 WITH NAPAPLQTY2 - EVALUATE(LOFORMSET.LCAPVINVDT+'.nApAprQty2') + LOFORMSET.LOREC.NAPAPRQTY2 ,;
    NAPAPLQTY3 WITH NAPAPLQTY3 - EVALUATE(LOFORMSET.LCAPVINVDT+'.nApAprQty3') + LOFORMSET.LOREC.NAPAPRQTY3 ,;
    NAPAPLQTY4 WITH NAPAPLQTY4 - EVALUATE(LOFORMSET.LCAPVINVDT+'.nApAprQty4') + LOFORMSET.LOREC.NAPAPRQTY4 ,;
    NAPAPLQTY5 WITH NAPAPLQTY5 - EVALUATE(LOFORMSET.LCAPVINVDT+'.nApAprQty5') + LOFORMSET.LOREC.NAPAPRQTY5 ,;
    NAPAPLQTY6 WITH NAPAPLQTY6 - EVALUATE(LOFORMSET.LCAPVINVDT+'.nApAprQty6') + LOFORMSET.LOREC.NAPAPRQTY6 ,;
    NAPAPLQTY7 WITH NAPAPLQTY7 - EVALUATE(LOFORMSET.LCAPVINVDT+'.nApAprQty7') + LOFORMSET.LOREC.NAPAPRQTY7 ,;
    NAPAPLQTY8 WITH NAPAPLQTY8 - EVALUATE(LOFORMSET.LCAPVINVDT+'.nApAprQty8') + LOFORMSET.LOREC.NAPAPRQTY8 ,;
    NAPTAPLQTY WITH NAPTAPLQTY - EVALUATE(LOFORMSET.LCAPVINVDT+'.nApTAprQty') + LOFORMSET.LOREC.NAPTAPRQTY ,;
    NAPAPLPRIC WITH LOFORMSET.LOREC.NAPAPRPRIC ,;
    NAPAPLAMNT WITH NAPAPLAMNT - EVALUATE(LOFORMSET.LCAPVINVDT+'.nApApRAmnt') + LOFORMSET.LOREC.NAPAPRPRIC*LOFORMSET.LOREC.NAPTAPRQTY,;
    CSTATUS    WITH IIF(CSTATUS='S','M',CSTATUS)
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  *Amin Update the InvoiceTkt with the Gl account and the Dist. line [Start]
  REPLACE CAPDGLACT  WITH EVALUATE(LOFORMSET.LCAPVINVDT+'.cApDGlAct') ,;
    CAPDLINNO  WITH EVALUATE(LOFORMSET.LCAPVINVDT+'.cApVILNo')
  *Amin Update the InvoiceTkt with the Gl account and the Dist. line [End]

  *Add this line to delete the uncontributed record if the whole
  *          amount was contributed [Begin]
  IF NAPAPLAMNT = 0
    DELETE
    REPLACE CSTATUS WITH IIF(NRECNO = 0 , 'S' , 'D')
  ENDIF
  *Add this line to delete the uncontributed record [End]

  SELECT (LNALIAS)
ENDIF
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*!*	IF ABS(loForm.loRec.nAPAprAmnt) > 0 AND ;
*!*	   IIF(EVALUATE(loFormSet.lcAPvInvDt+'.cIMTyp') = 'S' , !EMPTY(EVALUATE(loFormSet.lcAPvInvDt+'.ShipNO')) ,;
*!*	       !EMPTY(EVALUATE(loFormSet.lcAPvInvDt+'.cTktNo')))
IF ABS(LOFORMSET.LOREC.NAPAPRAMNT) > 0 AND ;
    IIF(EVALUATE(LOFORMSET.LCAPVINVDT+'.cIMTyp') = 'S' , !EMPTY(EVALUATE(LOFORMSET.LCAPVINVDT+'.ShipNO')) ,;
    !EMPTY(EVALUATE(LOFORMSET.LCAPVINVDT+'.cTktNo')))
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  *Old: SHOW GET pbContrib ENABLE &&Revise
  LOFORM.CMDCONTRIBUTE.ENABLED = .T.
ELSE
  *Old: SHOW GET pbContrib DISABLE &&Revise
  LOFORM.CMDCONTRIBUTE.ENABLED = .F.
ENDIF

RETURN
*-- End of lfUpdAplTkt


*:********************************************************************
*: Name      : lfGetGlLnk
*: Developer : Ahmad Shoukry Mohammed (ASM)
*: Date      : 09/02/2004
*: Purpose   : Return the Due Date
*:********************************************************************
*: Returns   : lcGl_Link
*:********************************************************************
*:B607278,1 ALB Get the correct WIP account with shipment ticket

FUNCTION LFGETGLLNK
PARAMETER LCSHIPNO,LCSTYLECODE,LCRESESS
PRIVATE LCGL_LINK

LOCAL LCSQLSTATEMENT, LNRESULT, LCALIAS
LCALIAS = ALIAS()
*CBUSDOCU+CSTYTYPE+PO &&POSHDR
*CBUSDOCU+CSTYTYPE+PO+CRSESSION+SHIPNO+CINVTYPE+STYLE+STR(LINENO,6)+TRANCD+CSTYGRADE &&POSREC
LCSQLSTATEMENT = "SELECT POSHDR.LINK_CODE, POSLN.STYLE FROM POSHDR (INDEX=POSHDR), POSLN (INDEX=POSREC) WHERE "+;
  "POSHDR.CBUSDOCU='P' AND POSHDR.CSTYTYPE='P' AND "+;
  "POSLN.CBUSDOCU='P' AND POSLN.CSTYTYPE='P' AND POSHDR.PO=POSLN.PO AND "+;
  "POSLN.shipno='"+LCSHIPNO+"' AND CRSESSION='"+LCRESESS+"'"
LNRESULT=OARIAAPPLICATION.REMOTECOMPANYDATA.SQLRUN(LCSQLSTATEMENT,'ShipCursor','',;
  OARIAAPPLICATION.ACTIVECOMPANYCONSTR,3,'SAVE',SET("Datasession"))
IF LNRESULT<1
  OARIAAPPLICATION.REMOTECOMPANYDATA.CHECKRETRESULT("execute",LNRESULT,.T.)
  IF !EMPTY(LCALIAS)
    SELECT (LCALIAS)
  ENDIF
  *AIT WINDOW LINENO()
  RETURN .F.
ENDIF


STORE ' ' TO LCGL_LINK

SELECT LINK_CODE FROM SHIPCURSOR ;
  WHERE IIF(EMPTY(LCSTYLECODE),.T.,STYLE= LCSTYLECODE) ;
  GROUP BY 1 INTO ARRAY LAGL_LINK &&Sql87: Must use SqlRun
USE IN SHIPCURSOR
IF !EMPTY(LCALIAS)
  SELECT (LCALIAS)
ENDIF

IF _TALLY > 0
  LCGL_LINK = LAGL_LINK[1,1]+ALLTRIM(STR(_TALLY))
ENDIF
RETURN LCGL_LINK
*-- End of lfGetGlLnk


*!*************************************************************
*! Name      : lfChkAplTkt
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 09/02/2004
*! Purpose   : Check Approved Quantity/Amount againest Contributed Quantity/Amount
*!*************************************************************
*! Parameters: The FormSet of APPYINV.SCX, The Form of APINVDT.SCX, lcSize
*!*************************************************************
*! Returns   :  None
*!*************************************************************
FUNCTION LFCHKAPLTKT
LPARAMETERS LOFORMSET, LOFORM, LCSIZE

PRIVATE LNCURALS,LCPINVLNO,LACONTTOT
LCPINVLNO = EVALUATE(LOFORMSET.LCAPVINVDT+'.cApVILNo')
LNCURALS  = SELECT(0)
SELECT COUNT(*),SUM(NAPAPLQTY1),SUM(NAPAPLQTY2),SUM(NAPAPLQTY3),SUM(NAPAPLQTY4),;
  SUM(NAPAPLQTY5),SUM(NAPAPLQTY6),SUM(NAPAPLQTY7),SUM(NAPAPLQTY8),;
  SUM(NAPAPLAMNT),SUM(IIF(!EMPTY(CRSESSION),NAPAPLAMNT,0)) ;
  FROM (LOFORMSET.LCAPINVTKT)             ;
  WHERE CVENDCODE         + CAPINVNO           + CAPVILNO  + CRSESSION= ;
  PADR(LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE,8) + PADR(LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE,12) + LCPINVLNO + ""         ;
  INTO ARRAY LACONTTOT

*-- No Contribution
IF _TALLY = 0 OR LACONTTOT[11] = 0 OR ISNULL(LACONTTOT[11])
  RETURN
ENDIF
SELECT (LOFORMSET.LCAPINVTKT)
*-- If there is only one contributed line update the contribution generated
*-- from the automatic option.
IF LACONTTOT[1] = 1 AND SEEK(PADR(LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE,8)+;
    PADR(LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE,12)+;
    EVALUATE(LOFORMSET.LCAPVINVDT+'.cApVILNo')) ;
    AND !EMPTY(EVALUATE(LOFORMSET.LCAPINVTKT+'.cRSession'))

  SELECT (LOFORMSET.LCAPINVTKT)
  *-- Update the contribution.
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	  REPLACE nApAplQty1 WITH loForm.loRec.nApAprQty1, nApAplQty2 WITH loForm.loRec.nApAprQty2,;
  *!*	          nApAplQty3 WITH loForm.loRec.nApAprQty3, nApAplQty4 WITH loForm.loRec.nApAprQty4,;
  *!*	          nApAplQty5 WITH loForm.loRec.nApAprQty5, nApAplQty6 WITH loForm.loRec.nApAprQty6,;
  *!*	          nApAplQty7 WITH loForm.loRec.nApAprQty7, nApAplQty8 WITH loForm.loRec.nApAprQty8,;
  *!*	          nApTAplQty WITH loForm.loRec.nApTAprQty, nApAplPric WITH loForm.loRec.nAPAprPric,;
  *!*	          nApAplAmnt WITH loForm.loRec.nApTAprQty * loForm.loRec.nAPAprPric               ,;
  *!*	          cStatus    WITH IIF(cStatus='S','M',cStatus)
  REPLACE NAPAPLQTY1 WITH LOFORMSET.LOREC.NAPAPRQTY1, NAPAPLQTY2 WITH LOFORMSET.LOREC.NAPAPRQTY2,;
    NAPAPLQTY3 WITH LOFORMSET.LOREC.NAPAPRQTY3, NAPAPLQTY4 WITH LOFORMSET.LOREC.NAPAPRQTY4,;
    NAPAPLQTY5 WITH LOFORMSET.LOREC.NAPAPRQTY5, NAPAPLQTY6 WITH LOFORMSET.LOREC.NAPAPRQTY6,;
    NAPAPLQTY7 WITH LOFORMSET.LOREC.NAPAPRQTY7, NAPAPLQTY8 WITH LOFORMSET.LOREC.NAPAPRQTY8,;
    NAPTAPLQTY WITH LOFORMSET.LOREC.NAPTAPRQTY, NAPAPLPRIC WITH LOFORMSET.LOREC.NAPAPRPRIC,;
    NAPAPLAMNT WITH LOFORMSET.LOREC.NAPTAPRQTY * LOFORMSET.LOREC.NAPAPRPRIC               ,;
    CSTATUS    WITH IIF(CSTATUS='S','M',CSTATUS)
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  SELECT (LNCURALS)
  RETURN
ENDIF
SELECT (LNCURALS)


IF SEEK(PADR(LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE,8)+;
    PADR(LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE,12)+;
    EVALUATE(LOFORMSET.LCAPVINVDT+'.cApVILNo')+SPACE(6),LOFORMSET.LCAPINVTKT)

  *Add these lines to make sure that the "Approved Amount" and
  *          the "Applied Amount" have the same sign [Begin]

  *-- Calculate the new approved amount
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	  lnNAprAmnt = IIF(EMPTY(lcSize) , loForm.loRec.nApTAprQty * loForm.loRec.nAPAprPric ,;
  *!*	                   loForm.loRec.nAPAprAmnt - (nAPAprQty&lcSize * loForm.loRec.nAPAprPric) +;
  *!*	                   (loForm.loRec.nAPAprQty&lcSize * loForm.loRec.nAPAprPric))
  LNNAPRAMNT = IIF(EMPTY(LCSIZE) , LOFORMSET.LOREC.NAPTAPRQTY * LOFORMSET.LOREC.NAPAPRPRIC ,;
    LOFORMSET.LOREC.NAPAPRAMNT - (NAPAPRQTY&LCSIZE * LOFORMSET.LOREC.NAPAPRPRIC) +;
    (LOFORMSET.LOREC.NAPAPRQTY&LCSIZE * LOFORMSET.LOREC.NAPAPRPRIC))
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  *-- If the "Approved Amount" and the "Applied Amount" have
  *-- different signs.
  *-- Note that the "Applied Amount" have the same sign as the old
  *-- "Approved Amount".
  IF SIGN(LNNAPRAMNT) <> 0 .AND.;
      SIGN(LNNAPRAMNT) <> SIGN(NAPAPRAMNT)

    *-- Message : 04185
    *-- "Invoice amount and approved amount must have the same sign."
    *-- Button : 00000
    *-- "                          <    Ok    >                     "
    =GFMODALGEN('TRM04185B00000' , 'ALERT')

    RETURN (.F.)
  ENDIF    && End of IF SIGN(lnNAprAmnt) <> 0 .AND. ...
  *Add these lines to make sure that the "Approved Amount" [End]
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	  IF !EMPTY(lcSize) AND loForm.loRec.nApAprQty&lcSize < ;
  *!*	     nApAprQty&lcSize-EVALUATE(loFormSet.lcAPInvTkt+'.nApAplQty'+lcSize)
  IF !EMPTY(LCSIZE) AND LOFORMSET.LOREC.NAPAPRQTY&LCSIZE < ;
      NAPAPRQTY&LCSIZE-EVALUATE(LOFORMSET.LCAPINVTKT+'.nApAplQty'+LCSIZE)
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    *Message : 04167
    *Approved Quantity Cannot be less than Contributed Quantity
    *Button : 00000
    *Ok
    *N000682,1 MMT 11/22/2012 Globalization changes[Start]
    *=GFMODALGEN("TRM04167B00000","DIALOG",'quantity')
    *N000682,1 11/20/2012 MMT Globlization changes[Start]
*=GFMODALGEN("TRM04167B00000","DIALOG",LANG_QUANTITY)
=GFMODALGEN("TRM04167B00000","DIALOG",IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_QUANTITY,loFormSet.GetHeaderText("LANG_QUANTITY",loFormSet.HeaderAlias)))
*N000682,1 11/20/2012 MMT Globlization changes[End]

    *N000682,1 MMT 11/22/2012 Globalization changes[end]
    RETURN (.F.)
  ENDIF
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *  IF loForm.loRec.nApTAprQty < nApTAprQty-EVALUATE(loFormSet.lcAPInvTkt+'.nApTAplQty')
  IF LOFORMSET.LOREC.NAPTAPRQTY < NAPTAPRQTY-EVALUATE(LOFORMSET.LCAPINVTKT+'.nApTAplQty')
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    *Message : 04167
    *Approved Quantity Cannot be less than Contributed Quantity
    *Button : 00000
    *Ok
    *N000682,1 MMT 11/22/2012 Globalization changes[Start]
    *=GFMODALGEN("TRM04167B00000","DIALOG",'quantity')
    *N000682,1 11/20/2012 MMT Globlization changes[Start]
*=GFMODALGEN("TRM04167B00000","DIALOG",LANG_QUANTITY)
=GFMODALGEN("TRM04167B00000","DIALOG",IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_QUANTITY,loFormSet.GetHeaderText("LANG_QUANTITY",loFormSet.HeaderAlias)))
*N000682,1 11/20/2012 MMT Globlization changes[End]

    *N000682,1 MMT 11/22/2012 Globalization changes[END]
    RETURN (.F.)
  ENDIF
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	  IF ABS(loForm.loRec.nApTAprQty * loForm.loRec.nAPAprPric) < ABS(nApTAprQty * nApAprPric -;
  *!*	     EVALUATE(loFormSet.lcAPInvTkt+'.nApTAplQty') * EVALUATE(loFormSet.lcAPInvTkt+'.nApAPlPric'))
  IF ABS(LOFORMSET.LOREC.NAPTAPRQTY * LOFORMSET.LOREC.NAPAPRPRIC) < ABS(NAPTAPRQTY * NAPAPRPRIC -;
      EVALUATE(LOFORMSET.LCAPINVTKT+'.nApTAplQty') * EVALUATE(LOFORMSET.LCAPINVTKT+'.nApAPlPric'))
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    *Message : 04167
    *Approved amount Cannot be less than Contributed amount.
    *Button : 00000
    *Ok

    *Change this line to add the second variable part of the
    *          message [Begin]
    *=gfModalGen("TRM04167B00000","DIALOG",'amount')
    *N000682,1 MMT 11/22/2012 Globalization changes[Start]
    *=GFMODALGEN("TRM04167B00000" , "DIALOG" , 'amount|amount')
    *N000682,1 11/20/2012 MMT Globlization changes[Start]
*=GFMODALGEN("TRM04167B00000" , "DIALOG" , LANG_AMOUNT_S+'|'+LANG_AMOUNT_S)
=GFMODALGEN("TRM04167B00000" , "DIALOG" , IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_AMOUNT_S,loFormSet.GetHeaderText("LANG_AMOUNT_S",loFormSet.HeaderAlias))+'|'+IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_AMOUNT_S,loFormSet.GetHeaderText("LANG_AMOUNT_S",loFormSet.HeaderAlias)))
*N000682,1 11/20/2012 MMT Globlization changes[End]

    *N000682,1 MMT 11/22/2012 Globalization changes[END]
    *Change this line to add the second variable part [End]

    RETURN (.F.)
  ENDIF
  *-- MAN Added the else condition
  *-- If there is no record with empty rec. session that means that amount is fully
  *-- contributed, therefore we have to check if the new approved amount is less
  *-- than the current approved amount which match the contributed amount.
ELSE

  *Add this line to calculate the new approved amount [Begin]
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	  lnNAprAmnt = IIF(EMPTY(lcSize) , loForm.loRec.nApTAprQty * loForm.loRec.nAPAprPric ,;
  *!*	                   loForm.loRec.nAPAprAmnt - (nAPAprQty&lcSize * loForm.loRec.nAPAprPric) +;
  *!*	                   (loForm.loRec.nAPAprQty&lcSize * loForm.loRec.nAPAprPric))
  LNNAPRAMNT = IIF(EMPTY(LCSIZE) , LOFORMSET.LOREC.NAPTAPRQTY * LOFORMSET.LOREC.NAPAPRPRIC ,;
    LOFORMSET.LOREC.NAPAPRAMNT - (NAPAPRQTY&LCSIZE * LOFORMSET.LOREC.NAPAPRPRIC) +;
    (LOFORMSET.LOREC.NAPAPRQTY&LCSIZE * LOFORMSET.LOREC.NAPAPRPRIC))
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  *Add this line to compare the new approved amount [Begin]

  *Add these lines to make sure that the "Approved Amount" and
  *          the "Applied Amount" have the same sign [Begin]

  *-- If the "Approved Amount" and the "Applied Amount" have
  *-- different signs.
  *-- Note that the "Applied Amount" have the same sign as the old
  *-- "Approved Amount".
  IF SIGN(LNNAPRAMNT) <> 0 .AND.;
      SIGN(LNNAPRAMNT) <> SIGN(NAPAPRAMNT)

    *-- Message : 04185
    *-- "Invoice amount and approved amount must have the same sign."
    *-- Button : 00000
    *-- "                          <    Ok    >                     "
    =GFMODALGEN('TRM04185B00000' , 'ALERT')

    RETURN (.F.)
  ENDIF    && End of IF SIGN(lnNAprAmnt) <> 0 .AND. ...
  *Add these lines to make sure that the "Approved Amount" [End]

  IF ABS(LNNAPRAMNT) < ABS(NAPAPRAMNT)

    *B602830,1 Change this line to add the second variable part of the
    *          message [Begin]
    *=gfModalGen("TRM04167B00000","DIALOG",'amount')
    *N000682,1 MMT 11/22/2012 Globalization changes[Start]
    *=GFMODALGEN("TRM04167B00000","DIALOG",'amount|amount')
    *N000682,1 11/20/2012 MMT Globlization changes[Start]
*=GFMODALGEN("TRM04167B00000","DIALOG",LANG_AMOUNT_S+'|'+LANG_AMOUNT_S)
=GFMODALGEN("TRM04167B00000","DIALOG",IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_AMOUNT_S,loFormSet.GetHeaderText("LANG_AMOUNT_S",loFormSet.HeaderAlias))+'|'+IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_AMOUNT_S,loFormSet.GetHeaderText("LANG_AMOUNT_S",loFormSet.HeaderAlias)))
*N000682,1 11/20/2012 MMT Globlization changes[End]

    *N000682,1 MMT 11/22/2012 Globalization changes[END]
    *B602830,1 Change this line to add the second variable part [End]

    RETURN (.F.)
  ENDIF
ENDIF

RETURN
*-- End of lfChkAplTkt


*!*************************************************************
*! Name      : lfGenInvLn
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 09/02/2004
*! Purpose   : Select Document Lines to Invoice.
*!*************************************************************
*! Parameters:  The FormSet of APPYINV.SCX, The Form of APINVDT.SCX,
*!                       lcTktType    : Ticket Type
*!                       lcTicket     : Ticket#
*!                       lcOperation : MFG Operation
*!                       lcLotNo      : Lot#
*!                       lcRSession   : Session#
*!                       lcCostType   : Cost Type
*!                       lcItem       : Item
*!                       lcColor      : Color
*!                       lcDyelot     : Dyelot
*!                       llDetails    : Shipment Details
*!*************************************************************
*! Returns   :  None
*!*************************************************************
FUNCTION LFGENINVLN
LPARAMETERS LOFORMSET, LOFORM, LCTKTTYPE, LCTICKET, LCOPERATION, LCLOTNO, LCRSESSION, ;
  LCCOSTTYPE, LCITEM, LCCOLOR, LCDYELOT, LLDETAILS

LCCOSTTYPE = ALLTRIM(LCCOSTTYPE)

PRIVATE    LNALIAS,LCTKTFILE,LCTKTITEM,LCTKTCOLOR,LCTKTDYELOT,LCTKTTOTQTY,;
  LNAPQTY1,LNAPQTY2,LNAPQTY3,LNAPQTY4,LNAPQTY5,LNAPQTY6,LNAPQTY7,;
  LNAPQTY8,LNAPTOTQTY,LNAPAMOUNT,LNUNITCOST,LCMFGCODE
*Old: SET ORDER TO TAG BOMPOREC IN BOMLINE
LOFORMSET.BOMLINE.SETORDER('BOMPOREC') &&Sql87: Check Tag ;
*CIMTYP+CTYPE+CBOMTYP+MFGCODE+CTKTNO+CRSESSION+SHIPNO+STR(LINENO,6)+CINVTYPE+STYLE+CSTYGRADE ;
(CIMTYP+CTYPE+CBOMTYP+MFGCODE+CTKTNO+CRSESSION+SHIPNO+STR(LINENO,6)+STYLE+SCLR+CSTYGRADE)
LNALIAS = SELECT()
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*SET ORDER TO TAG ITEM IN APVINVDT
SELECT APVINVDT
GFSETORDER('ITEM')
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
LCRSESSION = PADR(LCRSESSION,6)
*B608100,1 WAM 05/28/2007 Get Fabric color code
LCFABITEM = ''
*B608100,1 WAM 05/28/2007 (End)

DO CASE
CASE INLIST(LCTKTTYPE,'A','D')
  LCTKTFILE   = 'POSLN'
  LCFILETAG   = 'POSREC' &&Sql88: Check Tag ;
  *CBUSDOCU+CSTYTYPE+PO+CRSESSION+SHIPNO+CINVTYPE+STYLE+STR(LINENO,6)+TRANCD+CSTYGRADE ;
  (CSTYTYPE+PO+CRSESSION+SHIPNO+STYLE+STR(LINENO,6)+TRANCD)
  LCTKTIDX    = 'CBUSDOCU+CSTYTYPE+PO+CRSESSION+SHIPNO+CINVTYPE+STYLE+STR(LINENO,6)+TRANCD'
  LCTKTKEY    = 'P'+LCTKTTYPE+LCTICKET+LCRSESSION+SPACE(6)+IIF(EMPTY(LCITEM),'','0001'+ALLTRIM(LCITEM)) &&Sql89: Check Key
  LOFORMSET.LCFORCOND   = IIF(EMPTY(LCRSESSION),"TranCd='1'","TranCd $ '24'")
  LCTKTITEM   = 'POSLN.Style'
  LCTKTCOLOR  = 'SPACE(6)'
  LCTKTDYELOT = 'POSLN.Dyelot'
  LCTKTTOTQTY = 'POSLN.TotQty'
  LCTKTLINE   = 'STR(POSLN.LINENO,6)'
  LCGRADE     = 'POSLN.cStyGrade'

CASE INLIST(LCTKTTYPE,'I','R')  && Style PO & Style PO Returns
  LCTKTFILE   = 'POSLN'
  LCFILETAG   = 'POSREC' &&Sql90: Check Tag ;
  *CBUSDOCU+CSTYTYPE+PO+CRSESSION+SHIPNO+CINVTYPE+STYLE+STR(LINENO,6)+TRANCD+CSTYGRADE ;
  (CSTYTYPE+PO+CRSESSION+SHIPNO+STYLE+STR(LINENO,6)+TRANCD)
  LCTKTIDX    = 'CBUSDOCU+CSTYTYPE+PO+CRSESSION+SHIPNO+CINVTYPE+STYLE+STR(LINENO,6)+TRANCD'
  LCTKTKEY    = IIF(LCTKTTYPE='I','PP','RP')+LCTICKET+LCRSESSION &&Sql91: Check Key
  LOFORMSET.LCFORCOND   = IIF(EMPTY(LCRSESSION),"TranCd='1'","TranCd $ '24'")
  LOFORMSET.LCFORCOND   = LOFORMSET.LCFORCOND+IIF(EMPTY(LCITEM),""," AND CINVTYPE ='0001'AND Style=lcItem")
  LCTKTITEM   = 'POSLN.Style'
  LCTKTCOLOR  = 'SPACE(6)'
  LCTKTDYELOT = 'POSLN.Dyelot'
  LCTKTTOTQTY = 'POSLN.TotQty'
  LCTKTLINE   = 'STR(POSLN.LINENO,6)'
  LCGRADE     = 'POSLN.cStyGrade'
CASE LCTKTTYPE= 'S'              && Shipments
  LCTKTFILE   = 'POSLN'
  LCFILETAG   = 'POSHREC' &&Sql92: Check Tag ;
  *SHIPNO+CRSESSION+CBUSDOCU+CSTYTYPE+PO+CINVTYPE+STYLE+STR(LINENO,6)+TRANCD ;
  (SHIPNO+CRSESSION+CSTYTYPE+PO+STYLE+STR(LINENO,6)+TRANCD)
  LCTKTIDX    = 'SHIPNO+CRSESSION+CBUSDOCU+CSTYTYPE+PO+CINVTYPE+STYLE+STR(LINENO,6)+TRANCD'
  LCTKTKEY    = LCTICKET+IIF(EMPTY(LCRSESSION),'',LCRSESSION+'PP') &&Sql93: Check Key

  *B608730,1 WAM 10/23/2008 Don't include cancel lines
  *loFormSet.lcForCond   = '.T.' && IIF(EMPTY(lcRSession),"TranCd='3'","TranCd $ '24'")
  LOFORMSET.LCFORCOND   = IIF(EMPTY(LCRSESSION),".T.","TranCd $ '24'")
  *B608730,1 WAM 10/23/2008 (End)

  LOFORMSET.LCFORCOND   = LOFORMSET.LCFORCOND+IIF(EMPTY(LCITEM),""," AND CINVTYPE ='0001'AND Style=lcItem")
  LCTKTITEM   = 'POSLN.Style'
  LCTKTCOLOR  = 'SPACE(6)'
  LCTKTDYELOT = 'POSLN.Dyelot'
  LCTKTTOTQTY = 'POSLN.TotQty'
  LCTKTLINE   = 'STR(POSLN.LINENO,6)'
  LCGRADE     = 'POSLN.cStyGrade'
CASE LCTKTTYPE= 'M'               && Cutting Tickets
  LCTKTFILE   = 'CUTTKTL'
  LCFILETAG   = 'POSREC' &&Sql94: Check Tag ;
  *CBUSDOCU+CSTYTYPE+PO+CRSESSION+SHIPNO+CINVTYPE+STYLE+STR(LINENO,6)+TRANCD+CSTYGRADE ;
  (CRSESSION+CUTTKT+STYLE+TRANCD)
  LCTKTIDX    = 'CBUSDOCU+CSTYTYPE+PO+CRSESSION+SHIPNO+CINVTYPE+STYLE+STR(LINENO,6)+TRANCD'
  LCTKTKEY    = 'PU'+LCTICKET+LCRSESSION+SPACE(6)+IIF(EMPTY(LCITEM),'','0001'+ALLTRIM(LCITEM))
  LOFORMSET.LCFORCOND   = "Dyelot=ALLTRIM(lcDyelot) AND "+IIF(EMPTY(LCRSESSION),"TranCd='1'","TranCd $ '24'") &&Sql95: Check Key
  LCTKTITEM   = 'CUTTKTL.Style'
  LCTKTCOLOR  = 'SPACE(6)'
  LCTKTDYELOT = 'CUTTKTL.Dyelot'
  LCTKTTOTQTY = 'CUTTKTL.TotQty'
  LCTKTLINE   = 'STR(CUTTKTL.LINENO,6)'
  LCGRADE     = 'CUTTKTL.cStyGrade'

CASE LCTKTTYPE= 'T'                && Material Orders

  LCTKTFILE   = 'MMFGORDD'
  LCFILETAG   = 'POSREC' &&Sql96: Check Tag ;
  *CBUSDOCU+CSTYTYPE+PO+CRSESSION+SHIPNO+CINVTYPE+STYLE+STR(LINENO,6)+TRANCD+CSTYGRADE ;
  (CRSESSION+CMFGORDNO+CFABRIC+COLOR+TRANCD)
  LCTKTIDX    = 'CBUSDOCU+CSTYTYPE+PO+CRSESSION+SHIPNO+CINVTYPE+STYLE+STR(LINENO,6)+TRANCD'
  LCTKTKEY    =  'PF'+LCTICKET+LCRSESSION+SPACE(6)+IIF(EMPTY(LCITEM),"",'0002'+LFUPDITEM(SUBSTR(LCITEM,1,LOFORMSET.LNFABMAJLEN),ALLTRIM(LCCOLOR))) &&Sql97: Check Key
  LOFORMSET.LCFORCOND   = "Dyelot=ALLTRIM(lcDyelot) AND "+IIF(EMPTY(LCRSESSION),"TranCd='1'","TranCd $ '24'")

  *B608100,1 WAM 05/28/2007 Get Fabric color code
  *lcTktItem   = 'MMFGORDD.Style'
  *lcTktColor  = 'SPACE(6)'
  LCFABITEM   = 'MMFGORDD.Style'
  *! B610111,1 MMT 10/11/2012 Modify Payable invoice screen to handle MFG order case[Start]
  *LCTKTITEM   = 'LEFT(MMFGORDD.Style,loFormSet.lnFabMajLen)'
  LCTKTITEM   =  'MMFGORDD.Style'
  *! B610111,1 MMT 10/11/2012 Modify Payable invoice screen to handle MFG order case[End]
  LCTKTCOLOR  = 'SUBSTR(MMFGORDD.Style,loFormSet.lnFabClrStart,loFormSet.lnFabClrLen)'
  *B608100,1 WAM 05/28/2007 (End)

  LCTKTDYELOT = 'MMFGORDD.Dyelot'
  LCTKTTOTQTY = 'MMFGORDD.TotQty'
  LCTKTLINE   = 'STR(0,6)'

  LCGRADE     = 'MMFGORDD.cStyGrade'
CASE INLIST(LCTKTTYPE,'L','F')     && Material PO & Material PO Retuns
  LCTKTFILE   = 'POFLN'
  LCFILETAG   = 'POSREC' &&Sql98: Check Tag ;
  *CBUSDOCU+CSTYTYPE+PO+CRSESSION+SHIPNO+CINVTYPE+STYLE+STR(LINENO,6)+TRANCD+CSTYGRADE ;
  (CMATTYPE+POMAT+CRSESSION+FABRIC+COLOR+TRANCD)
  LCTKTIDX    = 'CBUSDOCU+CSTYTYPE+PO+CRSESSION+SHIPNO+CINVTYPE+STYLE+STR(LINENO,6)+TRANCD'
  LCTKTKEY    =  IIF(LCTKTTYPE='L','PM','RM')+LCTICKET+LCRSESSION+SPACE(6)+IIF(EMPTY(LCITEM),'',;
    '0002'+LFUPDITEM(SUBSTR(LCITEM,1,LOFORMSET.LNFABMAJLEN),ALLTRIM(LCCOLOR))) &&Sql99: Check Key
  LOFORMSET.LCFORCOND   = "Dyelot=ALLTRIM(lcDyelot) AND "+IIF(EMPTY(LCRSESSION),"TranCd='1'","TranCd $ '24'")

  *B608100,1 WAM 05/28/2007 Get Fabric color code
  *lcTktItem   = 'POFLN.Style'
  *lcTktColor  = 'SPACE(6)'
  LCFABITEM   = 'POFLN.Style'
  LCTKTITEM   = 'LEFT(POFLN.Style,loFormSet.lnFabMajLen)'
  LCTKTCOLOR  = 'SUBSTR(POFLN.Style,loFormSet.lnFabClrStart,loFormSet.lnFabClrLen)'
  *B608100,1 WAM 05/28/2007 (End)

  LCTKTDYELOT = 'POFLN.Dyelot'
  LCTKTTOTQTY = 'POFLN.TotQty'
  LCTKTLINE   = 'STR(POFLN.LINENO,6)'
  LCGRADE     = 'POFLN.cStyGrade'
ENDCASE

SELECT (LOFORMSET.LCAUTOINV)
DELETE ALL
IF EMPTY(LCLOTNO)
  *Old: SET ORDER TO TAG (lcFileTag)
  LOFORMSET.&LCTKTFILE..SETORDER(LCFILETAG)
  *=SEEK(lcTktKey)
  LOFORMSET.&LCTKTFILE..SEEK(LCTKTKEY)
  SELECT (LCTKTFILE)
  SCAN REST WHILE &LCTKTIDX = LCTKTKEY FOR EVALUATE(LOFORMSET.LCFORCOND)
    *Get invoiced amount applied againest this item
    SELECT APVINVDT
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *!*	    =SEEK(lcTktType+lcTicket+lcLotNo+EVAL(lcTktLine)+lcCostType+lcOperation+;
    *!*	          PADR(EVAL(lcTktItem),19)+EVAL(lcTktColor)+EVAL(lcTktDyelot))
    =GFSEEK(LCTKTTYPE+LCTICKET+LCLOTNO+EVAL(LCTKTLINE)+LCCOSTTYPE+LCOPERATION+;
      PADR(EVAL(LCTKTITEM),19)+EVAL(LCTKTCOLOR)+EVAL(LCTKTDYELOT))
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    IF EMPTY(LCRSESSION)
      SUM REST IIF(NAPPRICE>0,NAPQTY1,-NAPQTY1),IIF(NAPPRICE>0,NAPQTY2,-NAPQTY2),IIF(NAPPRICE>0,NAPQTY3,-NAPQTY3),;
        IIF(NAPPRICE>0,NAPQTY4,-NAPQTY4),IIF(NAPPRICE>0,NAPQTY5,-NAPQTY5),IIF(NAPPRICE>0,NAPQTY6,-NAPQTY6),;
        IIF(NAPPRICE>0,NAPQTY7,-NAPQTY7),IIF(NAPPRICE>0,NAPQTY8,-NAPQTY8),IIF(NAPPRICE>0,NAPTOTQTY,-NAPTOTQTY),;
        NAPTOTQTY*NAPPRICE TO LNAPQTY1,LNAPQTY2,LNAPQTY3,LNAPQTY4,LNAPQTY5,LNAPQTY6,LNAPQTY7,LNAPQTY8,LNAPTOTQTY,LNAPAMOUNT;
        WHILE CIMTYP+CTKTNO+CLOTNO+CBOMTYPE+COPRCODE+ITEM+COLOR+CDYELOT= ;
        LCTKTTYPE+LCTICKET+SPACE(2)+LCCOSTTYPE+LCOPERATION+;
        PADR(EVAL(LCTKTITEM),19)+EVAL(LCTKTCOLOR)+EVAL(LCTKTDYELOT)
    ELSE && !EMPTY(lcRSession)
      STORE 0 TO LNAPQTY1,LNAPQTY2,LNAPQTY3,LNAPQTY4,LNAPQTY5,LNAPQTY6,;
        LNAPQTY7,LNAPQTY8,LNAPTOTQTY,LNAPAMOUNT
      SCAN REST WHILE CIMTYP+CTKTNO+CLOTNO+STR(LINENO,6)+CBOMTYPE+COPRCODE+ITEM+COLOR+CDYELOT= ;
          LCTKTTYPE+LCTICKET+SPACE(2)+EVAL(LCTKTLINE)+LCCOSTTYPE+LCOPERATION+;
          PADR(EVAL(LCTKTITEM),19)+EVAL(LCTKTCOLOR)+EVAL(LCTKTDYELOT)

        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        *        IF SEEK(cVendCode+cApInvNo+cApVILNo+lcRSession,'APINVTKT')
        IF GFSEEK(CVENDCODE+CAPINVNO+CAPVILNO+LCRSESSION,'APINVTKT')
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
          SELECT APINVTKT
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
          *!*	            SCAN REST WHILE cVendCode+cApInvNo+cApVILNo+cRSession = ;
          *!*	                EVALUATE(loFormSet.lcAPvInvDt+'.cVendCode')+;
          *!*	                EVALUATE(loFormSet.lcAPvInvDt+'.cApInvNo')+;
          *!*	                EVALUATE(loFormSet.lcAPvInvDt+'.cApVILNo')+lcRSession
          SCAN REST WHILE CVENDCODE+CAPINVNO+CAPVILNO+CRSESSION+CIMTYP+CTKTNO+STR(LINENO,6)= ;
              EVALUATE(LOFORMSET.LCAPVINVDT+'.cVendCode')+;
              EVALUATE(LOFORMSET.LCAPVINVDT+'.cApInvNo')+;
              EVALUATE(LOFORMSET.LCAPVINVDT+'.cApVILNo')+LCRSESSION
            *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
            LNAPQTY1   = LNAPQTY1   + NAPAPLQTY1
            LNAPQTY2   = LNAPQTY2   + NAPAPLQTY2
            LNAPQTY3   = LNAPQTY3   + NAPAPLQTY3
            LNAPQTY4   = LNAPQTY4   + NAPAPLQTY4
            LNAPQTY5   = LNAPQTY5   + NAPAPLQTY5
            LNAPQTY6   = LNAPQTY6   + NAPAPLQTY6
            LNAPQTY7   = LNAPQTY7   + NAPAPLQTY7
            LNAPQTY8   = LNAPQTY8   + NAPAPLQTY8
            LNAPTOTQTY = LNAPTOTQTY + NAPTAPLQTY
            LNAPAMOUNT = LNAPAMOUNT + NAPAPLAMNT
          ENDSCAN
        ENDIF
      ENDSCAN
    ENDIF &&EMPTY(lcRSession)
    *Get Ticket estimated amount or session received amount
    DO CASE
    CASE INLIST(LCTKTTYPE,'L','F')
      LNAMOUNT = IIF(EMPTY(LCRSESSION),;
        EVAL('POFLN.nFCost'+LCCOSTTYPE),;
        EVAL('POFLN.nFLanCost'+LCCOSTTYPE))*&LCTKTTOTQTY
    CASE INLIST(LCTKTTYPE,'A','D')
      LNAMOUNT = IIF(EMPTY(LCRSESSION),;
        EVAL('POSLN.nFCost'+LCCOSTTYPE),;
        EVAL('POSLN.nFLanCost'+LCCOSTTYPE))*&LCTKTTOTQTY
    CASE LCTKTTYPE='R'
      LNAMOUNT = IIF(EMPTY(LCRSESSION),;
        EVAL('POSLN.nFCost'+LCCOSTTYPE),;
        EVAL('POSLN.nFLanCost'+LCCOSTTYPE))*&LCTKTTOTQTY
    OTHERWISE

      LCMFGCODE=LCOPERATION
      IF INLIST(LCTKTTYPE,'S','I','M') AND LCOPERATION=REPLICATE('*',6)
        =SEEK(PADR(&LCTKTITEM,19),'STYLE')
        IF EOF('Style')
          *WAIT WINDOW PADR(&lcTktItem,19)+'Not Found 1'
          *N000682,1 MMT 11/22/2012 Globalization changes[Start]
          *MESSAGEBOX('Style '+PADR(&LCTKTITEM,19)+' not found in the Styles Table'+CHR(13)+'You can not Contribution this style.')
          *N000682,1 11/20/2012 MMT Globlization changes[Start]
*MESSAGEBOX(LANG_STYLE_S+PADR(&LCTKTITEM,19)+LANG_NOTFOUNDSTYLES+CHR(13)+LANG_CANNOTCONTRIBUTE)
MESSAGEBOX(IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_STYLE_S,loFormSet.GetHeaderText("LANG_STYLE_S",loFormSet.HeaderAlias))+PADR(&LCTKTITEM,19)+IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_NOTFOUNDSTYLES,loFormSet.GetHeaderText("LANG_NOTFOUNDSTYLES",loFormSet.HeaderAlias))+CHR(13)+IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_CANNOTCONTRIBUTE,loFormSet.GetHeaderText("LANG_CANNOTCONTRIBUTE",loFormSet.HeaderAlias)))
*N000682,1 11/20/2012 MMT Globlization changes[End]

          *N000682,1 MMT 11/22/2012 Globalization changes[END]
        ENDIF
        LCMFGCODE=IIF(!STYLE.LDETCOST,PADR('*1',6),LCOPERATION)
      ENDIF
      IF INLIST(LCTKTTYPE,'S','I','M') AND LCOPERATION=REPLICATE('#',6)
        =SEEK(PADR(&LCTKTITEM,19),'STYLE')
        LCMFGCODE=IIF(!STYLE.LDETCOST,PADR('*2',6),LCOPERATION)
        IF EOF('Style')
          *WAIT WINDOW PADR(&lcTktItem,19)+'Not Found 2'
          *N000682,1 MMT 11/22/2012 Globalization changes[Start]
          *MESSAGEBOX('Style '+PADR(&LCTKTITEM,19)+' not found in the Styles Table'+CHR(13)+'You can not Contribution this style.')
          *N000682,1 11/20/2012 MMT Globlization changes[Start]
*MESSAGEBOX(LANG_STYLE_S+PADR(&LCTKTITEM,19)+LANG_NOTFOUNDSTYLES+CHR(13)+LANG_CANNOTCONTRIBUTE)
MESSAGEBOX(IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_STYLE_S,loFormSet.GetHeaderText("LANG_STYLE_S",loFormSet.HeaderAlias))+PADR(&LCTKTITEM,19)+IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_NOTFOUNDSTYLES,loFormSet.GetHeaderText("LANG_NOTFOUNDSTYLES",loFormSet.HeaderAlias))+CHR(13)+IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_CANNOTCONTRIBUTE,loFormSet.GetHeaderText("LANG_CANNOTCONTRIBUTE",loFormSet.HeaderAlias)))
*N000682,1 11/20/2012 MMT Globlization changes[End]

          *N000682,1 MMT 11/22/2012 Globalization changes[END]
        ENDIF
      ENDIF
      SELECT BOMLINE
      *CIMTYP+CTYPE+CBOMTYP+MFGCODE+CTKTNO+CRSESSION+SHIPNO+STR(LINENO,6)+CINVTYPE+STYLE+CSTYGRADE

      *B608730,1 WAM 10/23/2008 Fix cost calculation when assign PO to invoice by Auto option
      *lcTemp = IIF(lcTktType='S','I',lcTktType)+IIF(EMPTY(lcRSession),'1','2')+;
      lcCostType+lcMfgCode+IIF(lcTktType='S',POSLN.PO,lcTicket)+lcRSession+;
      IIF(lcTktType='S' AND !EMPTY(lcRSession),lcTicket,SPACE(6))+;
      IIF(INLIST(lcTktType,'M','I','S','T'),STR(&lcTktFile..LineNo,6),SPACE(6))+;
      IIF(INLIST(lcTktType,'L','F','T'),'0002','0001')+PADR(EVALUATE(lcTktItem),19)
      LCTEMP = IIF(LCTKTTYPE='S','I',LCTKTTYPE)+IIF(EMPTY(LCRSESSION),'1','2')+;
        LCCOSTTYPE+LCMFGCODE+IIF(LCTKTTYPE='S',POSLN.PO,LCTICKET)+LCRSESSION+;
        IIF(EMPTY(LCRSESSION), SPACE(6),IIF(LCTKTTYPE='S',LCTICKET,POSLN.SHIPNO))+;
        IIF(INLIST(LCTKTTYPE,'M','I','S','T'),STR(&LCTKTFILE..LINENO,6),SPACE(6))+;
        IIF(INLIST(LCTKTTYPE,'L','F','T'),'0002','0001')+PADR(EVALUATE(LCTKTITEM),19)
      *B608730,1 WAM 10/23/2008 (End)


      =LOFORMSET.BOMLINE.SEEK(LCTEMP)
      SELECT BOMLINE
      *B608730,1 WAM 10/23/2008 Fix cost calculation when assign PO to invoice by Auto option
      *SUM REST UnitCost*UnitQty*&lcTktTotQty TO lnAmount WHILE ;
      cimtyp+ctype+cbomtyp+mfgcode+ctktno+crsession+shipno+STR(lineno,6)+cinvtype+style+cstygrade=;
      IIF(lcTktType='S','I',lcTktType)+IIF(EMPTY(lcRSession),'1','2')+;
      lcCostType+lcMfgCode+IIF(lcTktType='S',POSLN.PO,lcTicket)+;
      lcRSession+IIF(lcTktType='S' AND !EMPTY(lcRSession),lcTicket,SPACE(6))+;
      IIF(INLIST(lcTktType,'M','I','S','T'),STR(&lcTktFile..LineNo,6),SPACE(6))+;
      IIF(INLIST(lcTktType,'L','F','T'),'0002','0001')+PADR(EVALUATE(lcTktItem),19)+IIF(lcTktType='T','','1')

      SUM REST UNITCOST*UNITQTY*&LCTKTTOTQTY TO LNAMOUNT WHILE ;
        CIMTYP+CTYPE+CBOMTYP+MFGCODE+CTKTNO+CRSESSION+SHIPNO+STR(LINENO,6)+CINVTYPE+STYLE+CSTYGRADE=;
        IIF(LCTKTTYPE='S','I',LCTKTTYPE)+IIF(EMPTY(LCRSESSION),'1','2')+;
        LCCOSTTYPE+LCMFGCODE+IIF(LCTKTTYPE='S',POSLN.PO,LCTICKET)+;
        LCRSESSION+IIF(EMPTY(LCRSESSION), SPACE(6),IIF(LCTKTTYPE='S',LCTICKET,POSLN.SHIPNO))+;
        IIF(INLIST(LCTKTTYPE,'M','I','S','T'),STR(&LCTKTFILE..LINENO,6),SPACE(6))+;
        IIF(INLIST(LCTKTTYPE,'L','F','T'),'0002','0001')+PADR(EVALUATE(LCTKTITEM),19)+IIF(LCTKTTYPE='T','','1')
      *B608730,1 WAM 10/23/2008 (End)

      *B121306,1 NNA 01/22/2004  (End)
      *E301995,1 Alb Add Adorment/Dying/MMFG order to invoice line [END]
      *B607161,1 ASH 04/14/2003 (End)
      *B607341,1 ALB Fix Bug happend by bug# B607161,1 and fix the original bug [END]

    ENDCASE
    SELECT (LOFORMSET.LCAUTOINV)
    *B608599,1 WAM 07/01/2008 Use the proper index
    *IF !SEEK(&lcTktItem+&lcTktFile..cWareCode+&lcTktDyelot+IIF(lcTktType='S' AND llDetails,POSLN.PO,SPACE(6)))
    IF !SEEK(&LCTKTITEM+&LCTKTFILE..CWARECODE+&LCTKTDYELOT+IIF(LCTKTTYPE='S' AND LLDETAILS,POSLN.PO,SPACE(6)),LOFORMSET.LCAUTOINV,LOFORMSET.LCAUTOINV)
      *B608599,1 WAM 07/01/2008 (End)

      APPEND BLANK
      *B999999,1 ASM Fix error that showed when trying to select item/color for shipment 4545 [Start]
      *REPLACE cSelect   WITH IIF(lcTktType= 'S' .AND. loFormSet.POSHDR.SEEK("PP"+POSLN.PO) .AND. POSHDR.Status="S","",""),;
      cTktNo    WITH IIF(lcTktType='S' AND llDetails,POSLN.PO,'') ,;
      cRecvType WITH IIF(EMPTY(lcRSession),'',IIF(&lcTktFile..TranCd='2','R',IIF(&lcGrade='2','S','D'))) ,;
      Item      WITH IIF(INLIST(lcTktType,'L','F','T'),LEFT(&lcTktItem,12),PADR(&lcTktItem,19))   ,;
      Color     WITH IIF(INLIST(lcTktType,'L','F','T'),SUBSTR(&lcTktItem,14),'')  ,;
      cDyelot   WITH &lcTktDyelot ,;
      cWareCode WITH &lcTktFile..cWareCode ,;
      LineNo    WITH IIF(lcTktType='T',0,EVALUATE(lcTktFile+'.LineNo'))

      *B608100,1 WAM 05/28/2007 fix bug or wrong browse ticket items when adding invoice lines
      *REPLACE cSelect   WITH IIF(lcTktType= 'S' .AND. loFormSet.POSHDR.SEEK("PP"+POSLN.PO) .AND. POSHDR.Status="S","",""),;
      cTktNo    WITH IIF(lcTktType='S' AND llDetails,POSLN.PO,'') ,;
      cRecvType WITH IIF(EMPTY(lcRSession),'',IIF(EVALUATE(lcTktFile+'.TranCd')='2','R',IIF(EVALUATE(lcGrade)='2','S','D'))), ;
      Item      WITH IIF(INLIST(lcTktType,'L','F','T'),LEFT(EVALUATE(lcTktItem),12),PADR(EVALUATE(lcTktItem),19))   ,;
      Color     WITH IIF(INLIST(lcTktType,'L','F','T'),SUBSTR(EVALUATE(lcTktItem),14),'')  ,;
      cDyelot   WITH EVALUATE(lcTktDyelot) ,;
      cWareCode WITH EVALUATE(lcTktFile+'.cWareCode') ,;
      LineNo    WITH IIF(lcTktType='T',0,EVALUATE(lcTktFile+'.LineNo'))
      *! B610111,1 MMT 10/11/2012 Modify Payable invoice screen to handle MFG order case[Start]
      *REPLACE CSELECT   WITH IIF(LCTKTTYPE= 'S' .AND. LOFORMSET.POSHDR.SEEK("PP"+POSLN.PO) .AND. POSHDR.STATUS="S","",""),;
      CTKTNO    WITH IIF(LCTKTTYPE='S' AND LLDETAILS,POSLN.PO,'') ,;
      CRECVTYPE WITH IIF(EMPTY(LCRSESSION),'',IIF(EVALUATE(LCTKTFILE+'.TranCd')='2','R',IIF(EVALUATE(LCGRADE)='2','S','D'))), ;
      ITEM      WITH IIF(INLIST(LCTKTTYPE,'L','F','T'),EVALUATE(LCFABITEM),EVALUATE(LCTKTITEM)) ,;
      COLOR     WITH EVALUATE(LCTKTCOLOR) ,;
      CDYELOT   WITH EVALUATE(LCTKTDYELOT) ,;
      CWARECODE WITH EVALUATE(LCTKTFILE+'.cWareCode') ,;
      LINENO    WITH IIF(LCTKTTYPE='T',0,EVALUATE(LCTKTFILE+'.LineNo'))
      REPLACE CSELECT   WITH IIF(LCTKTTYPE= 'S' .AND. LOFORMSET.POSHDR.SEEK("PP"+POSLN.PO) .AND. POSHDR.STATUS="S","",""),;
        CTKTNO    WITH IIF(LCTKTTYPE='S' AND LLDETAILS,POSLN.PO,'') ,;
        CRECVTYPE WITH IIF(EMPTY(LCRSESSION),'',IIF(EVALUATE(LCTKTFILE+'.TranCd')='2','R',IIF(EVALUATE(LCGRADE)='2','S','D'))), ;
        ITEM      WITH IIF(INLIST(LCTKTTYPE,'L','F','T'),EVALUATE(LCFABITEM),EVALUATE(LCTKTITEM)) ,;
        COLOR     WITH EVALUATE(LCTKTCOLOR) ,;
        CDYELOT   WITH EVALUATE(LCTKTDYELOT) ,;
        CWARECODE WITH EVALUATE(LCTKTFILE+'.cWareCode') ,;
        LINENO    WITH EVALUATE(LCTKTFILE+'.LineNo')
      *! B610111,1 MMT 10/11/2012 Modify Payable invoice screen to handle MFG order case[End]
      *B608100,1 WAM 05/28/2007 (End)
      *B999999,1 ASM Fix error that showed when trying to select item/color for shipment 4545 [End]
      IF LCTKTTYPE='S' AND !EMPTY(CTKTNO)
        SELECT POSHDR
        LCPOSHDR = ORDER()
        LNPOSRCNO = REC_NO &&Sql101: Check Row_ID
        *Old: SET ORDER TO TAG Poshdr
        LOFORMSET.POSHDR.SETORDER('Poshdr') &&Sql102:  CBUSDOCU+CSTYTYPE+PO (CSTYTYPE+PO)
        IF LOFORMSET.POSHDR.SEEK('PP'+POSLN.PO) &&Sql102: Check Key
          LCTEMP = LOFORMSET.LCAUTOINV+'.cWIPAcct'
          REPLACE &LCTEMP WITH ;
            IIF(!EMPTY(LOFORMSET.LCAPDGLACT),;
            LOFORMSET.LCAPDGLACT,LFVAASACT(POSHDR.LINK_CODE,"013")) IN (LOFORMSET.LCAUTOINV)
        ENDIF
        SELECT POSHDR
        *Old: SET ORDER TO (lcPosHdr)
        LOFORMSET.POSHDR.SETORDER(LCPOSHDR)
        *Old: IF BETWEEN(lnPosRcNo , 1, RECCOUNT() )
        *Old: GOTO lnPosRcNo
        *Old: ENDIF
        IF !EMPTY(LNPOSRCNO)
          LOFORMSET.POSHDR.GOREC(LNPOSRCNO)
        ENDIF
        SELECT (LOFORMSET.LCAUTOINV)
      ENDIF
    ENDIF
    REPLACE NTKTQTY   WITH NTKTQTY + &LCTKTTOTQTY ,;
      NTKTAMNT  WITH NTKTAMNT+ LNAMOUNT,;
      NTKTCST   WITH IIF(NTKTQTY=0,0,NTKTAMNT/NTKTQTY) ,;
      NAPLQTY   WITH NAPLQTY+LNAPTOTQTY ,;
      NAPLAMNT  WITH NAPLAMNT+LNAPAMOUNT ,;
      NINVQTY   WITH NINVQTY+MAX(&LCTKTTOTQTY-LNAPTOTQTY,0),;
      NINVAMNT  WITH NINVAMNT+MAX(LNAMOUNT-LNAPAMOUNT,0)
    IF INLIST(LCTKTTYPE,'I','S','M','R','A','D')
      REPLACE NTKTQTY1 WITH NTKTQTY1+&LCTKTFILE..QTY1 ,;
        NTKTQTY2 WITH NTKTQTY2+&LCTKTFILE..QTY2 ,;
        NTKTQTY3 WITH NTKTQTY3+&LCTKTFILE..QTY3 ,;
        NTKTQTY4 WITH NTKTQTY4+&LCTKTFILE..QTY4 ,;
        NTKTQTY5 WITH NTKTQTY5+&LCTKTFILE..QTY5 ,;
        NTKTQTY6 WITH NTKTQTY6+&LCTKTFILE..QTY6 ,;
        NTKTQTY7 WITH NTKTQTY7+&LCTKTFILE..QTY7 ,;
        NTKTQTY8 WITH NTKTQTY8+&LCTKTFILE..QTY8 ,;
        NAPLQTY1 WITH NAPLQTY1+LNAPQTY1  ,;
        NAPLQTY2 WITH NAPLQTY2+LNAPQTY2  ,;
        NAPLQTY3 WITH NAPLQTY3+LNAPQTY3  ,;
        NAPLQTY4 WITH NAPLQTY4+LNAPQTY4  ,;
        NAPLQTY5 WITH NAPLQTY5+LNAPQTY5  ,;
        NAPLQTY6 WITH NAPLQTY6+LNAPQTY6  ,;
        NAPLQTY7 WITH NAPLQTY7+LNAPQTY7  ,;
        NAPLQTY8 WITH NAPLQTY8+LNAPQTY8
      REPLACE NINVQTY1 WITH NINVQTY1+MAX(&LCTKTFILE..QTY1-LNAPQTY1,0),;
        NINVQTY2 WITH NINVQTY2+MAX(&LCTKTFILE..QTY2-LNAPQTY2,0),;
        NINVQTY3 WITH NINVQTY3+MAX(&LCTKTFILE..QTY3-LNAPQTY3,0),;
        NINVQTY4 WITH NINVQTY4+MAX(&LCTKTFILE..QTY4-LNAPQTY4,0),;
        NINVQTY5 WITH NINVQTY5+MAX(&LCTKTFILE..QTY5-LNAPQTY5,0),;
        NINVQTY6 WITH NINVQTY6+MAX(&LCTKTFILE..QTY6-LNAPQTY6,0),;
        NINVQTY7 WITH NINVQTY7+MAX(&LCTKTFILE..QTY7-LNAPQTY7,0),;
        NINVQTY8 WITH NINVQTY8+MAX(&LCTKTFILE..QTY8-LNAPQTY8,0)
    ENDIF
  ENDSCAN
ELSE && !EMPTY(lcLotNo)
  SELECT MFGOPRDT
  *CIMTYP+CTKTNO+COPRCODE+CLOTNO+TRANCD
  LOFORMSET.MFGOPRDT.SEEK(LCTKTTYPE+LCTICKET+LCOPERATION+LCLOTNO+'1') &&Sql103: Check Key
  *! B039743,1 ASM 09/26/2005 Invoice screen gives error messege When Choosing Lines with lcLots [Start]
  *SCAN REST WHILE cIMTyp+cTktNo+cOprCode+cLotNo+TranCd = ;
  lcTktType+lcTicket+lcOperation+lcLotNo+'1' ;
  FOR style = lfupditem(lcItem,lcColor)

  *B608100,1 WAM 05/28/2007 fix bug or wrong browse ticket items when adding invoice lines
  *SCAN REST WHILE cIMTyp+cTktNo+cOprCode+cLotNo+TranCd = ;
  lcTktType+lcTicket+lcOperation+lcLotNo+'1' ;
  FOR Item = lfupditem(lcItem,lcColor)
  SCAN REST WHILE CIMTYP+CTKTNO+COPRCODE+CLOTNO+TRANCD = ;
      LCTKTTYPE+LCTICKET+LCOPERATION+LCLOTNO+'1' ;
      FOR IIF(EMPTY(LCITEM),.T.,IIF(INLIST(LCTKTTYPE,'L','F','T'),ITEM = LFUPDITEM(LCITEM,LCCOLOR),ITEM = LCITEM))
    *B608100,1 WAM 05/28/2007 (End)

    *! B039743,1 ASM 09/26/2005 Invoice screen gives error messege When Choosing Lines with lcLots [End]
    SELECT APVINVDT
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *=SEEK(lcTktType+lcTicket+lcLotNo)
    =GFSEEK(LCTKTTYPE+LCTICKET+LCLOTNO)
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

    *B608100,1 WAM 05/28/2007 fix bug or wrong browse ticket items when adding invoice lines
    *SUM REST nApQty1,nApQty2,nApQty3,nApQty4,nApQty5,nApQty6,nApQty7,nApQty8,nApTotQty,nApTotQty*nApPrice;
    TO lnApQTy1,lnApQTy2,lnApQTy3,lnApQTy4,lnApQTy5,lnApQTy6,lnApQTy7,lnApQTy8,lnApTotQty,lnApAmount;
    WHILE cIMTyp+cTktNO+cLotNo+STR(LineNO,6)+cBomType+cOprCode+Item+Color+cDyelot= ;
    lcTktType+lcTicket+lcLotNo ;
    FOR cBomType+cOprCode+Item+Color =;
    lcCostType+lcOperation+PADR(left(MFGOPRDT.Style,12),19)+SUBSTR(MFGOPRDT.Style,14)
    SUM REST NAPQTY1,NAPQTY2,NAPQTY3,NAPQTY4,NAPQTY5,NAPQTY6,NAPQTY7,NAPQTY8,NAPTOTQTY,NAPTOTQTY*NAPPRICE;
      TO LNAPQTY1,LNAPQTY2,LNAPQTY3,LNAPQTY4,LNAPQTY5,LNAPQTY6,LNAPQTY7,LNAPQTY8,LNAPTOTQTY,LNAPAMOUNT;
      WHILE CIMTYP+CTKTNO+CLOTNO+STR(LINENO,6)+CBOMTYPE+COPRCODE+ITEM+COLOR+CDYELOT= ;
      LCTKTTYPE+LCTICKET+LCLOTNO ;
      FOR CBOMTYPE+COPRCODE+ITEM+COLOR =;
      LCCOSTTYPE+LCOPERATION+IIF(INLIST(LCTKTTYPE,'L','F','T'),PADR(LEFT(MFGOPRDT.ITEM,LOFORMSET.LNFABMAJLEN),19),PADR(MFGOPRDT.ITEM,19))+;
      IIF(INLIST(LCTKTTYPE,'L','F','T'),SUBSTR(MFGOPRDT.ITEM,LOFORMSET.LNFABCLRSTART,LOFORMSET.LNFABCLRLEN),'')
    *B608100,1 WAM 05/28/2007 (End)

    LCMFGCODE=LCOPERATION
    IF INLIST(LCTKTTYPE,'S','I','M','A','D') AND LCOPERATION=REPLICATE('*',6)
      =SEEK(PADR(&LCTKTITEM,19),'STYLE')
      LCMFGCODE=IIF(!STYLE.LDETCOST,PADR('*1',6),LCOPERATION)
    ENDIF
    IF INLIST(LCTKTTYPE,'S','I','M','A','D') AND LCOPERATION=REPLICATE('#',6)
      =SEEK(PADR(&LCTKTITEM,19),'STYLE')
      LCMFGCODE=IIF(!STYLE.LDETCOST,PADR('*2',6),LCOPERATION)
    ENDIF
    SELECT BOMLINE
    **CIMTYP+CTYPE+CBOMTYP+MFGCODE+CTKTNO+CRSESSION+SHIPNO+STR(LINENO,6)+CINVTYPE+STYLE+CSTYGRADE
    LOFORMSET.BOMLINE.SEEK(LCTKTTYPE+'1'+LCCOSTTYPE+LCMFGCODE+LCTICKET+LCRSESSION+SPACE(6)) &&Sql104: Check Key
    *! B039743,1 ASM 09/26/2005 Invoice screen gives error messege When Choosing Lines with lcLots [Start]
    *LOCATE REST WHILE ;
    cIMTyp+cType+cBomTyp+MfgCode+cTktNo+cRSession+ShipNo+STR(LineNo,6)+Style=;
    lcTktType+'1'+lcCostType+lcMfgCode+lcTicket+lcRSession+SPACE(6) ;
    FOR Style = MFGOPRDT.Style
    LOCATE REST WHILE ;
      CIMTYP+CTYPE+CBOMTYP+MFGCODE+CTKTNO+CRSESSION+SHIPNO+STR(LINENO,6)+STYLE=;
      LCTKTTYPE+'1'+LCCOSTTYPE+LCMFGCODE+LCTICKET+LCRSESSION+SPACE(6) ;
      FOR STYLE = MFGOPRDT.ITEM
    *! B039743,1 ASM 09/26/2005 Invoice screen gives error messege When Choosing Lines with lcLots [End]
    SELECT (LOFORMSET.LCAUTOINV)
    APPEND BLANK


    *B608100,1 WAM 05/28/2007 fix bug or wrong browse ticket items when adding invoice lines
    *REPLACE cSelect  WITH IIF(lcTktType= 'S' .AND. loFormSet.POSHDR.SEEK("PP"+MFGOPRDT.cTktNo) .AND. POSHDR.Status="S","",""),; &&sql Check Key
    ITEM     WITH LEFT(MFGOPRDT.STYLE,12),;
      COLOR    WITH SUBSTR(MFGOPRDT.COLOR,14),;
      NTKTQTY1 WITH MFGOPRDT.NLOTQTY1,;
      NTKTQTY2 WITH MFGOPRDT.NLOTQTY2,;
      NTKTQTY3 WITH MFGOPRDT.NLOTQTY3,;
      NTKTQTY4 WITH MFGOPRDT.NLOTQTY4,;
      NTKTQTY5 WITH MFGOPRDT.NLOTQTY5,;
      NTKTQTY6 WITH MFGOPRDT.NLOTQTY6,;
      NTKTQTY7 WITH MFGOPRDT.NLOTQTY7,;
      NTKTQTY8 WITH MFGOPRDT.NLOTQTY8,;
      NTKTQTY  WITH MFGOPRDT.NLOTTOTQTY,;
      NTKTCST  WITH BOMLINE.UNITCOST ,;
      NTKTAMNT WITH MFGOPRDT.NLOTTOTQTY*BOMLINE.UNITCOST,;
      NAPLQTY1 WITH LNAPQTY1  ,;
      NAPLQTY2 WITH LNAPQTY2  ,;
      NAPLQTY3 WITH LNAPQTY3  ,;
      NAPLQTY4 WITH LNAPQTY4  ,;
      NAPLQTY5 WITH LNAPQTY5  ,;
      NAPLQTY6 WITH LNAPQTY6  ,;
      NAPLQTY7 WITH LNAPQTY7  ,;
      NAPLQTY8 WITH LNAPQTY8  ,;
      NAPLQTY  WITH LNAPTOTQTY ,;
      NAPLAMNT WITH LNAPAMOUNT ,;
      NINVQTY1 WITH MAX(MFGOPRDT.NLOTQTY1-LNAPQTY1,0),;
      NINVQTY2 WITH MAX(MFGOPRDT.NLOTQTY2-LNAPQTY2,0),;
      NINVQTY3 WITH MAX(MFGOPRDT.NLOTQTY3-LNAPQTY3,0),;
      NINVQTY4 WITH MAX(MFGOPRDT.NLOTQTY4-LNAPQTY4,0),;
      NINVQTY5 WITH MAX(MFGOPRDT.NLOTQTY5-LNAPQTY5,0),;
      NINVQTY6 WITH MAX(MFGOPRDT.NLOTQTY6-LNAPQTY6,0),;
      NINVQTY7 WITH MAX(MFGOPRDT.NLOTQTY7-LNAPQTY7,0),;
      NINVQTY8 WITH MAX(MFGOPRDT.NLOTQTY8-LNAPQTY8,0),;
      NINVQTY  WITH MAX(MFGOPRDT.NLOTTOTQTY-LNAPTOTQTY,0),;
      NINVAMNT WITH MAX(MFGOPRDT.NLOTTOTQTY*BOMLINE.UNITCOST-LNAPAMOUNT,0)

    REPLACE CSELECT  WITH IIF(LCTKTTYPE= 'S' .AND. LOFORMSET.POSHDR.SEEK("PP"+MFGOPRDT.CTKTNO) .AND. POSHDR.STATUS="S","",""),; &&sql Check Key
    ITEM     WITH MFGOPRDT.ITEM   ,;
      COLOR    WITH IIF(INLIST(LCTKTTYPE,'L','F','T'),SUBSTR(MFGOPRDT.ITEM,LOFORMSET.LNFABCLRSTART,LOFORMSET.LNFABCLRLEN),'')  ,;
      NTKTQTY1 WITH MFGOPRDT.NLOTQTY1,;
      NTKTQTY2 WITH MFGOPRDT.NLOTQTY2,;
      NTKTQTY3 WITH MFGOPRDT.NLOTQTY3,;
      NTKTQTY4 WITH MFGOPRDT.NLOTQTY4,;
      NTKTQTY5 WITH MFGOPRDT.NLOTQTY5,;
      NTKTQTY6 WITH MFGOPRDT.NLOTQTY6,;
      NTKTQTY7 WITH MFGOPRDT.NLOTQTY7,;
      NTKTQTY8 WITH MFGOPRDT.NLOTQTY8,;
      NTKTQTY  WITH MFGOPRDT.NLOTTOTQTY,;
      NTKTCST  WITH BOMLINE.UNITCOST ,;
      NTKTAMNT WITH MFGOPRDT.NLOTTOTQTY*BOMLINE.UNITCOST,;
      NAPLQTY1 WITH LNAPQTY1  ,;
      NAPLQTY2 WITH LNAPQTY2  ,;
      NAPLQTY3 WITH LNAPQTY3  ,;
      NAPLQTY4 WITH LNAPQTY4  ,;
      NAPLQTY5 WITH LNAPQTY5  ,;
      NAPLQTY6 WITH LNAPQTY6  ,;
      NAPLQTY7 WITH LNAPQTY7  ,;
      NAPLQTY8 WITH LNAPQTY8  ,;
      NAPLQTY  WITH LNAPTOTQTY ,;
      NAPLAMNT WITH LNAPAMOUNT ,;
      NINVQTY1 WITH MAX(MFGOPRDT.NLOTQTY1-LNAPQTY1,0),;
      NINVQTY2 WITH MAX(MFGOPRDT.NLOTQTY2-LNAPQTY2,0),;
      NINVQTY3 WITH MAX(MFGOPRDT.NLOTQTY3-LNAPQTY3,0),;
      NINVQTY4 WITH MAX(MFGOPRDT.NLOTQTY4-LNAPQTY4,0),;
      NINVQTY5 WITH MAX(MFGOPRDT.NLOTQTY5-LNAPQTY5,0),;
      NINVQTY6 WITH MAX(MFGOPRDT.NLOTQTY6-LNAPQTY6,0),;
      NINVQTY7 WITH MAX(MFGOPRDT.NLOTQTY7-LNAPQTY7,0),;
      NINVQTY8 WITH MAX(MFGOPRDT.NLOTQTY8-LNAPQTY8,0),;
      NINVQTY  WITH MAX(MFGOPRDT.NLOTTOTQTY-LNAPTOTQTY,0),;
      NINVAMNT WITH MAX(MFGOPRDT.NLOTTOTQTY*BOMLINE.UNITCOST-LNAPAMOUNT,0)

    *B608100,1 WAM 05/28/2007 (End)
  ENDSCAN
ENDIF
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
SELECT APVINVDT
GFSETORDER('Orgvinv')
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
GO TOP IN (LOFORMSET.LCAUTOINV)
SELECT (LNALIAS)

RETURN(!EOF(LOFORMSET.LCAUTOINV))
*-- End of lfGenInvLn


*!*************************************************************
*! Name      : lfvAASAct
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 09/02/2004
*! Purpose   : To get the WIP account based on Gl link.
*!*************************************************************
*! Parameters: The FormSet of APPYINV.SCX, The Form of APINVDT.SCX, lcLinkCode, lcCatKey
*!*************************************************************
*B603827,1 AKA 10/23/2001
*!*************************************************************
FUNCTION LFVAASACT
LPARAMETERS LOFORMSET, LOFORM, LCLINKCODE, LCCATKEY

PRIVATE LCGLACNT
LCGLACNT= ''
IF LOFORMSET.ARIAFORM1.AP1.LLAPGLLINK
  IF SEEK(LCLINKCODE+LCCATKEY,'GL_LINK')
    LCGLACNT = GL_LINK.GLACNT
    IF !SEEK(LCGLACNT,'lcLinkChar')
      LCGLACNT = ''
    ENDIF
  ELSE
    =SEEK('DEFDEF','GL_LINK')
    LCGLACNT = GL_LINK.GLACNT
  ENDIF
ELSE
  STORE LOFORMSET.LCDISTACCT TO LCGLACNT
ENDIF

RETURN LCGLACNT
*-- End of lfvAASAct

***NNN***



***AAA***

*!*************************************************************
*! Name      : lfAutoInit
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 09/12/2004
*! Purpose   : Called From theInit Event of the Auto Button of APInvDt.SCx
*!*************************************************************
*! Parameters: The FormSet of APPYINV.SCX, The Form of APINVDT.SCX, The Form of APAINVD.SCX
*!*************************************************************
*! Returns   :  None
*!*************************************************************
FUNCTION LFAUTOINIT
LPARAMETERS LOFORMSET, LOFORM, LOAUTOFORM

*ASM, Add Properties to the form [Start]
LCALLVAR = "llFirst,laAplCst,laTickets,laAplLots,lcMfgCode,lcAplLotNo,lcWIPAcnt"

DIMENSION LAALLVAR[1,1]
STORE '' TO LAALLVAR
=GFSUBSTR(LCALLVAR,@LAALLVAR,',')

LOCAL LNI
FOR LNI = 1 TO ALEN(LAALLVAR,1)
  IF LOWER(LEFT(LAALLVAR[lnI,1],2)) <> 'la'
    PRIVATE &LAALLVAR[lnI,1].
  ENDIF
ENDFOR
DECLARE LAAPLCST[1,3], LATICKETS[1,3], LAAPLLOTS[1]

=LFADDPRO(LOAUTOFORM)

*ASM, Add Properties to the form [End]

LOAUTOFORM.LLFIRST = .T.
LCAINVDTBR = 'Document Lines'
STORE 0         TO LOAUTOFORM.CBOLOTNO.VALUE
STORE SPACE(24) TO LOAUTOFORM.GLAPDGLACT.KEYTEXTBOX.VALUE
STORE SPACE(6)  TO LOAUTOFORM.KBINVTKTNO.KEYTEXTBOX.VALUE
STORE 1         TO LOAUTOFORM.CBOTKTTYPE.VALUE, LOAUTOFORM.CBOCOSTTYPE.VALUE, LOAUTOFORM.CBOMFGOPR.VALUE
STORE ''        TO LOAUTOFORM.LAAPLCST, LOAUTOFORM.LCMFGCODE, LOAUTOFORM.KBRSESSION.KEYTEXTBOX.VALUE, LOAUTOFORM.LCWIPACNT
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*STORE 'N/A'     TO loForm.laOprLots[1]
*N000682,1 MMT 12/09/2012 Globalization changes[Start]
*STORE 'N/A'     TO LOFORMSET.LAOPRLOTS[1]
STORE IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_NOTAPPLICABLE,loformset.GetHeaderText("LANG_APPYINV_NOTAPPLICABLE",loformset.HeaderAlias))    TO LOFORMSET.LAOPRLOTS[1]
*N000682,1 MMT 12/09/2012 Globalization changes[End]
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
STORE SPACE(2)  TO LOAUTOFORM.LCAPLLOTNO
*N000682,1 MMT 11/22/2012 Globalization changes[Start]
*LOAUTOFORM.LATICKETS[1,1] = 'Select Document Type'
*N000682,1 11/20/2012 MMT Globlization changes[Start]
*LOAUTOFORM.LATICKETS[1,1] = LANG_APPYINV_SELECTDOCTYPE
LOAUTOFORM.LATICKETS[1,1] = IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_SELECTDOCTYPE,loFormSet.GetHeaderText("LANG_APPYINV_SELECTDOCTYPE",loFormSet.HeaderAlias))
*N000682,1 11/20/2012 MMT Globlization changes[End]

*N000682,1 MMT 11/22/2012 Globalization changes[END]
LOAUTOFORM.LATICKETS[1,2] = ' '
*N000682,1 MMT 11/22/2012 Globalization changes[Start]
*LOAUTOFORM.LATICKETS[1,3] = 'Document#'
*LOAUTOFORM.LAAPLCST[1,1]  = 'Select Cost Type'
*N000682,1 11/20/2012 MMT Globlization changes[Start]
*LOAUTOFORM.LATICKETS[1,3] = LANG_APPYINV_DOCNO
LOAUTOFORM.LATICKETS[1,3] = IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_DOCNO,loFormSet.GetHeaderText("LANG_APPYINV_DOCNO",loFormSet.HeaderAlias))
*N000682,1 11/20/2012 MMT Globlization changes[End]

*N000682,1 11/20/2012 MMT Globlization changes[Start]
*LOAUTOFORM.LAAPLCST[1,1]  = LANG_APPYINV_SELCOSTTYPE
LOAUTOFORM.LAAPLCST[1,1]  = IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_SELCOSTTYPE,loFormSet.GetHeaderText("LANG_APPYINV_SELCOSTTYPE",loFormSet.HeaderAlias))
*N000682,1 11/20/2012 MMT Globlization changes[End]

*N000682,1 MMT 11/22/2012 Globalization changes[END]
LOAUTOFORM.LAAPLCST[1,2]  = ' '
LOAUTOFORM.LAAPLCST[1,3]  = ' '
*Old: SET ORDER TO TAG BOMPOREC IN BOMLINE
LOFORMSET.BOMLINE.SETORDER('BOMPOREC') &&Sql105: Check Tag ;
*CIMTYP+CTYPE+CBOMTYP+MFGCODE+CTKTNO+CRSESSION+SHIPNO+STR(LINENO,6)+CINVTYPE+STYLE+CSTYGRADE ;
(CIMTYP+CTYPE+CBOMTYP+MFGCODE+CTKTNO+CRSESSION+SHIPNO+STR(LINENO,6)+STYLE+SCLR+CSTYGRADE)
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
LOFORMSET.LACODES[1,2] = "_Screen.ActiveForm.Parent.CallingFormSet.laMfgCode"
LOFORMSET.LACODES[1,3] = "_Screen.ActiveForm.cboMFGOpr.Value"
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
SELECT (LOFORMSET.LCAUTOINV)
ZAP

*ASM, Initally Disable the Controls [Begin]
WITH LOAUTOFORM
  STORE .F. TO .CBOTKTTYPE.ENABLED, .KBINVTKTNO.ENABLED, .CBOCOSTTYPE.ENABLED, ;
    .CBOMFGOPR.ENABLED, .KBRSESSION.ENABLED, .CBOLOTNO.ENABLED, .GLAPDGLACT.ENABLED, ;
    .CMDGENERATE.ENABLED, .CMDCLEAR.ENABLED
  STORE .F. TO .CMDSELECT.ENABLED, .CMDSELALL.ENABLED, .CMDSELNONE.ENABLED, .CMDINVERT.ENABLED, ;
    .CMDPROCEED.ENABLED, .CMDCLOSE.ENABLED
ENDWITH
STORE .T. TO LOAUTOFORM.CBOTKTTYPE.ENABLED, LOAUTOFORM.CMDCLOSE.ENABLED
*ASM, Initally Disable the Controls [End]

*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
LOFORMSET.LAMFGRFLD[1,2] = '_Screen.ActiveForm.Parent.CallingFormSet.lcMfgGlAcnt'
*loFormSet.laMfgRFld[1,2] = '_Screen.ActiveForm.Parent.lcMfgGlAcnt'
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]


SET ENGINEBEHAVIOR 70

*Raise Flag to .T. while we are in this screen
LOFORMSET.LLAUTOSCR = .T.

RETURN
*-- End of lfAutoInit


*!*************************************************************
*! Name      : lfAutoDestroy
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 09/12/2004
*! Purpose   : Called From the Destroy Event of APAINVD.SCx
*!*************************************************************
*! Parameters: The FormSet of APPYINV.SCX, The Form of APINVDT.SCX, The Form of APAINVD.SCX
*!*************************************************************
*! Returns   :  None
*!*************************************************************
FUNCTION LFAUTODESTROY
LPARAMETERS LOFORMSET, LOFORM, LOAUTOFORM

LOFORMSET.LLAUTOSCR = .F.

SELECT(LOFORMSET.LCAPVINVDT)
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*!*	loFormSet.laCodes[1,2] = "_Screen.ActiveForm.Parent.CallingForm.Parent.laMfgCode"
*!*	loFormSet.laCodes[1,3] = "_Screen.ActiveForm.Parent.CallingForm.Parent.lnMfgOpr"
*!*	loFormSet.laMfgRFld[1,2] = '_Screen.ActiveForm.Parent.CallingForm.Parent.lcMfgGlAcnt'
LOFORMSET.LACODES[1,2] = "_Screen.ActiveForm.Parent.laMfgCode"
LOFORMSET.LACODES[1,3] = "_Screen.ActiveForm.Parent.lnMfgOpr"
LOFORMSET.LAMFGRFLD[1,2] = '_Screen.ActiveForm.Parent.lcMfgGlAcnt'
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
*=lfwInvDt(loFormSet, loForm, loAutoForm)
*=lfRefresh('APINVD10')

RETURN
*-- End of lfvAutoDestroy


*!*************************************************************
*! Name      : lfAInvBrow
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 09/12/2004
*! Purpose   : Browse Ticket lines to invoice in APAINVD.SCX
*!*************************************************************
*! Parameters: The FormSet of APPYINV.SCX, The Form of APINVDT.SCX, The Form of APAINVD.SCX
*!*************************************************************
*! Returns   :  None
*!*************************************************************
FUNCTION LFAINVBROW
LPARAMETERS LOFORMSET, LOFORM, LOAUTOFORM
LOCAL LNCOL

SELECT (LOFORMSET.LCAUTOINV)
WITH LOAUTOFORM.GRDAUTOLINES

  .COLUMNCOUNT = 0
  .RECORDSOURCE = LOFORMSET.LCAUTOINV
  LNCOL='0'
  LNCOL = ALLTRIM(STR(VAL(LNCOL)+1))
  .COLUMNCOUNT = VAL(LNCOL)
  .COLUMN&LNCOL..CONTROLSOURCE = "CSELECT"
  .COLUMN&LNCOL..HEADER1.CAPTION = ' '
  .COLUMN&LNCOL..WIDTH = 15

  DO CASE
  CASE EMPTY(LOAUTOFORM.LATICKETS[1,2])
    LNCOL = ALLTRIM(STR(VAL(LNCOL)+1))
    .COLUMNCOUNT = VAL(LNCOL)
    .COLUMN&LNCOL..CONTROLSOURCE = "Item"
    *N000682,1 MMT 11/20/2012 Globalization Changes[Start]
    *    .COLUMN&LNCOL..HEADER1.CAPTION = 'Item'
    *N000682,1 11/20/2012 MMT Globlization changes[Start]
*.COLUMN&LNCOL..HEADER1.CAPTION =LANG_APPYINV_ITEM
.COLUMN&LNCOL..HEADER1.CAPTION =IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_ITEM,loFormSet.GetHeaderText("LANG_APPYINV_ITEM",loFormSet.HeaderAlias))
*N000682,1 11/20/2012 MMT Globlization changes[End]

    *N000682,1 MMT 11/20/2012 Globalization Changes[End]



    .COLUMN&LNCOL..WIDTH = 100
  CASE INLIST(LOAUTOFORM.LATICKETS[loAutoForm.cboTktType.Value,2],'T','L','F')
    LNCOL = ALLTRIM(STR(VAL(LNCOL)+1))
    .COLUMNCOUNT = VAL(LNCOL)
    .COLUMN&LNCOL..CONTROLSOURCE = "SUBSTR(Item,1,"+ALLTRIM(STR(LOFORMSET.LNFABMAJLEN))+")"
    *N000682,1 MMT 11/20/2012 Globalization Changes[Start]
    *    .COLUMN&LNCOL..HEADER1.CAPTION = 'Fabric'
    *N000682,1 11/20/2012 MMT Globlization changes[Start]
*.COLUMN&LNCOL..HEADER1.CAPTION =LANG_APPYINV_FABRIC
.COLUMN&LNCOL..HEADER1.CAPTION =IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_FABRIC,loFormSet.GetHeaderText("LANG_APPYINV_FABRIC",loFormSet.HeaderAlias))
*N000682,1 11/20/2012 MMT Globlization changes[End]

    *N000682,1 MMT 11/20/2012 Globalization Changes[End]

    .COLUMN&LNCOL..WIDTH = 70
    LNCOL = ALLTRIM(STR(VAL(LNCOL)+1))
    .COLUMNCOUNT = VAL(LNCOL)
    .COLUMN&LNCOL..CONTROLSOURCE = "Color"
    *N000682,1 MMT 11/20/2012 Globalization Changes[Start]
    *    .COLUMN&LNCOL..HEADER1.CAPTION = 'Color'
    *N000682,1 11/20/2012 MMT Globlization changes[Start]
    *.COLUMN&LNCOL..HEADER1.CAPTION =LANG_APPYINV_COLOR
    .COLUMN&LNCOL..HEADER1.CAPTION =IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_COLOR,loFormSet.GetHeaderText("LANG_APPYINV_COLOR",loFormSet.HeaderAlias))
   *N000682,1 11/20/2012 MMT Globlization changes[End]

    *N000682,1 MMT 11/20/2012 Globalization Changes[End]

    IF LOFORMSET.LASETUPS[2,2]='Y'
      LNCOL = ALLTRIM(STR(VAL(LNCOL)+1))
      .COLUMNCOUNT = VAL(LNCOL)
      .COLUMN&LNCOL..CONTROLSOURCE = "cDyelot"
      *N000682,1 MMT 11/20/2012 Globalization Changes[Start]
      *      .COLUMN&LNCOL..HEADER1.CAPTION = 'Dyelot'
      *N000682,1 11/20/2012 MMT Globlization changes[Start]
*.COLUMN&LNCOL..HEADER1.CAPTION =LANG_APPYINV_DYELOT
.COLUMN&LNCOL..HEADER1.CAPTION =IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_DYELOT,loFormSet.GetHeaderText("LANG_APPYINV_DYELOT",loFormSet.HeaderAlias))
*N000682,1 11/20/2012 MMT Globlization changes[End]

      *N000682,1 MMT 11/20/2012 Globalization Changes[End]
      .COLUMN&LNCOL..WIDTH = 30
    ENDIF
  CASE INLIST(LOAUTOFORM.LATICKETS[loAutoForm.cboTktType.Value,2],'S','I','M','R','A','D')
    IF LOAUTOFORM.LATICKETS[loAutoForm.cboTktType.Value,2]='S'
      LNCOL = ALLTRIM(STR(VAL(LNCOL)+1))
      .COLUMNCOUNT = VAL(LNCOL)
      .COLUMN&LNCOL..CONTROLSOURCE = "cTktNo"
      *N000682,1 MMT 11/20/2012 Globalization Changes[Start]
      *      .COLUMN&LNCOL..HEADER1.CAPTION = 'PO#'
      *N000682,1 11/20/2012 MMT Globlization changes[Start]
      *.COLUMN&LNCOL..HEADER1.CAPTION =LANG_APPYINV_PO
      .COLUMN&LNCOL..HEADER1.CAPTION =IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_PO,loFormSet.GetHeaderText("LANG_APPYINV_PO",loFormSet.HeaderAlias))
      *N000682,1 11/20/2012 MMT Globlization changes[End]

      *N000682,1 MMT 11/20/2012 Globalization Changes[End]
      LNCOL = ALLTRIM(STR(VAL(LNCOL)+1))
      .COLUMNCOUNT = VAL(LNCOL)
      .COLUMN&LNCOL..CONTROLSOURCE = "cWIPAcct"
      *N000682,1 MMT 11/20/2012 Globalization Changes[Start]
      *      .COLUMN&LNCOL..HEADER1.CAPTION = 'WIP A/C'
      .COLUMN&LNCOL..HEADER1.CAPTION =IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_WIP_AC,loFormSet.GetHeaderText("LANG_APPYINV_WIP_AC",loFormSet.HeaderAlias))
      *N000682,1 11/20/2012 MMT Globlization changes[End]
    ENDIF
    LNCOL = ALLTRIM(STR(VAL(LNCOL)+1))
    .COLUMNCOUNT = VAL(LNCOL)
    .COLUMN&LNCOL..CONTROLSOURCE = "Item"
    .COLUMN&LNCOL..HEADER1.CAPTION = LOFORM.CNTSTYLE.LBLITEMHEADER.CAPTION
    .COLUMN&LNCOL..WIDTH = 100
    IF LOFORMSET.LASETUPS[1,2]='Y'
      LNCOL = ALLTRIM(STR(VAL(LNCOL)+1))
      .COLUMNCOUNT = VAL(LNCOL)
      .COLUMN&LNCOL..CONTROLSOURCE = "cDyelot"
      *N000682,1 MMT 11/20/2012 Globalization Changes[Start]
      *      .COLUMN&LNCOL..HEADER1.CAPTION = 'Dyelot'
      *N000682,1 11/20/2012 MMT Globlization changes[Start]
*.COLUMN&LNCOL..HEADER1.CAPTION =LANG_APPYINV_DYELOT
.COLUMN&LNCOL..HEADER1.CAPTION =IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_DYELOT,loFormSet.GetHeaderText("LANG_APPYINV_DYELOT",loFormSet.HeaderAlias))
*N000682,1 11/20/2012 MMT Globlization changes[End]

      *N000682,1 MMT 11/20/2012 Globalization Changes[End]
    ENDIF
  ENDCASE

  IF EMPTY(LOAUTOFORM.KBRSESSION.KEYTEXTBOX.VALUE)
    LNCOL = ALLTRIM(STR(VAL(LNCOL)+1))
    .COLUMNCOUNT = VAL(LNCOL)
    .COLUMN&LNCOL..CONTROLSOURCE = "nTktQty"
    *N000682,1 MMT 11/20/2012 Globalization Changes[Start]
    *    .COLUMN&LNCOL..HEADER1.CAPTION = 'Bud. Qty.'
    *N000682,1 11/20/2012 MMT Globlization changes[Start]
*.COLUMN&LNCOL..HEADER1.CAPTION =LANG_APPYINV_BUD_QTY
.COLUMN&LNCOL..HEADER1.CAPTION =IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_BUD_QTY,loFormSet.GetHeaderText("LANG_APPYINV_BUD_QTY",loFormSet.HeaderAlias))
*N000682,1 11/20/2012 MMT Globlization changes[End]

    *N000682,1 MMT 11/20/2012 Globalization Changes[End]

    LNCOL = ALLTRIM(STR(VAL(LNCOL)+1))
    .COLUMNCOUNT = VAL(LNCOL)
    .COLUMN&LNCOL..CONTROLSOURCE = "nTktCst"
    *N000682,1 MMT 11/20/2012 Globalization Changes[Start]
    *    .COLUMN&LNCOL..HEADER1.CAPTION = 'Bud. Cost'
    *N000682,1 11/20/2012 MMT Globlization changes[Start]
*.COLUMN&LNCOL..HEADER1.CAPTION =LANG_APPYINV_BUD_COST
.COLUMN&LNCOL..HEADER1.CAPTION =IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_BUD_COST,loFormSet.GetHeaderText("LANG_APPYINV_BUD_COST",loFormSet.HeaderAlias))
*N000682,1 11/20/2012 MMT Globlization changes[End]

    *N000682,1 MMT 11/20/2012 Globalization Changes[End]

    LNCOL = ALLTRIM(STR(VAL(LNCOL)+1))
    .COLUMNCOUNT = VAL(LNCOL)
    .COLUMN&LNCOL..CONTROLSOURCE = "nTktAmnt"
    *N000682,1 MMT 11/20/2012 Globalization Changes[Start]
    *    .COLUMN&LNCOL..HEADER1.CAPTION = 'Bud. Amnt.'
    *N000682,1 11/20/2012 MMT Globlization changes[Start]
*.COLUMN&LNCOL..HEADER1.CAPTION =LANG_APPYINV_BUD_AMNT
.COLUMN&LNCOL..HEADER1.CAPTION =IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_BUD_AMNT,loFormSet.GetHeaderText("LANG_APPYINV_BUD_AMNT",loFormSet.HeaderAlias))
*N000682,1 11/20/2012 MMT Globlization changes[End]

    *N000682,1 MMT 11/20/2012 Globalization Changes[End]

  ELSE
    LNCOL = ALLTRIM(STR(VAL(LNCOL)+1))
    .COLUMNCOUNT = VAL(LNCOL)
    .COLUMN&LNCOL..CONTROLSOURCE = "IIF(cRecvType='R','Receive',IIF(cRecvType='S','Sec Qlty.','Damaged'))"
    *N000682,1 MMT 11/20/2012 Globalization Changes[Start]
    *    .COLUMN&LNCOL..HEADER1.CAPTION = 'Type'
    *N000682,1 11/20/2012 MMT Globlization changes[Start]
*.COLUMN&LNCOL..HEADER1.CAPTION =LANG_APPYINV_TYPE
.COLUMN&LNCOL..HEADER1.CAPTION =IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_TYPE,loFormSet.GetHeaderText("LANG_APPYINV_TYPE",loFormSet.HeaderAlias))
*N000682,1 11/20/2012 MMT Globlization changes[End]

    *N000682,1 MMT 11/20/2012 Globalization Changes[End]

    LNCOL = ALLTRIM(STR(VAL(LNCOL)+1))
    .COLUMNCOUNT = VAL(LNCOL)
    .COLUMN&LNCOL..CONTROLSOURCE = "nTktQty"
    *N000682,1 MMT 11/20/2012 Globalization Changes[Start]
    *    .COLUMN&LNCOL..HEADER1.CAPTION = 'Rec. Qty.'
    *N000682,1 11/20/2012 MMT Globlization changes[Start]
*.COLUMN&LNCOL..HEADER1.CAPTION =LANG_APPYINV_REC_QTY
.COLUMN&LNCOL..HEADER1.CAPTION =IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_REC_QTY,loFormSet.GetHeaderText("LANG_APPYINV_REC_QTY",loFormSet.HeaderAlias))
*N000682,1 11/20/2012 MMT Globlization changes[End]

    *N000682,1 MMT 11/20/2012 Globalization Changes[End]

    LNCOL = ALLTRIM(STR(VAL(LNCOL)+1))
    .COLUMNCOUNT = VAL(LNCOL)
    .COLUMN&LNCOL..CONTROLSOURCE = "nTktCst"
    *N000682,1 MMT 11/20/2012 Globalization Changes[Start]
    *    .COLUMN&LNCOL..HEADER1.CAPTION = 'Rec. Cost'
    *N000682,1 11/20/2012 MMT Globlization changes[Start]
*.COLUMN&LNCOL..HEADER1.CAPTION =LANG_APPYINV_REC_COST
.COLUMN&LNCOL..HEADER1.CAPTION =IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_REC_COST,loFormSet.GetHeaderText("LANG_APPYINV_REC_COST",loFormSet.HeaderAlias))
*N000682,1 11/20/2012 MMT Globlization changes[End]

    *N000682,1 MMT 11/20/2012 Globalization Changes[End]

    LNCOL = ALLTRIM(STR(VAL(LNCOL)+1))
    .COLUMNCOUNT = VAL(LNCOL)
    .COLUMN&LNCOL..CONTROLSOURCE = "ROUND(nTktAmnt,2)"
    *N000682,1 MMT 11/20/2012 Globalization Changes[Start]
     *    .COLUMN&LNCOL..HEADER1.CAPTION = 'Rec. Amnt.'
    *N000682,1 11/20/2012 MMT Globlization changes[Start]
*.COLUMN&LNCOL..HEADER1.CAPTION =LANG_APPYINV_REC_AMNT
.COLUMN&LNCOL..HEADER1.CAPTION =IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_REC_AMNT,loFormSet.GetHeaderText("LANG_APPYINV_REC_AMNT",loFormSet.HeaderAlias))
*N000682,1 11/20/2012 MMT Globlization changes[End]

    *N000682,1 11/20/2012 MMT Globlization changes[End]


    LOFORM.LCTKTTYPE = LOAUTOFORM.LATICKETS[loAutoForm.cboTktType.Value,2]
    IF LOFORM.LCTKTTYPE $ 'RF'
      LNCOL = ALLTRIM(STR(VAL(LNCOL)+1))
      .COLUMNCOUNT = VAL(LNCOL)
      *N000682,1 MMT 11/20/2012 Globalization Changes[Start]
      *.COLUMN&LNCOL..CONTROLSOURCE = "IIF(cRecvType='R','Receive',IIF(cRecvType='S','Sec Qlty.','Damaged'))"
      *      .COLUMN&LNCOL..HEADER1.CAPTION = 'Type'
      *N000682,1 11/20/2012 MMT Globlization changes[Start]
*.COLUMN&LNCOL..CONTROLSOURCE = "IIF(cRecvType='R',LANG_APPYINV_RECEIVE,IIF(cRecvType='S',LANG_SCNDQLTY,LANG_APPYINV_DAMAGED))"
.COLUMN&LNCOL..CONTROLSOURCE = "IIF(cRecvType='R',IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_RECEIVE,loFormSet.GetHeaderText("LANG_APPYINV_RECEIVE",loFormSet.HeaderAlias)),IIF(cRecvType='S',IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_SCNDQLTY,loFormSet.GetHeaderText("LANG_SCNDQLTY",loFormSet.HeaderAlias)),IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_DAMAGED,loFormSet.GetHeaderText("LANG_APPYINV_DAMAGED",loFormSet.HeaderAlias))))"
*N000682,1 11/20/2012 MMT Globlization changes[End]

      *N000682,1 11/20/2012 MMT Globlization changes[Start]
*.COLUMN&LNCOL..HEADER1.CAPTION =LANG_APPYINV_TYPE
.COLUMN&LNCOL..HEADER1.CAPTION =IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_TYPE,loFormSet.GetHeaderText("LANG_APPYINV_TYPE",loFormSet.HeaderAlias))
*N000682,1 11/20/2012 MMT Globlization changes[End]

      *N000682,1 11/20/2012 MMT Globlization changes[End]

      LNCOL = ALLTRIM(STR(VAL(LNCOL)+1))
      .COLUMNCOUNT = VAL(LNCOL)
      .COLUMN&LNCOL..CONTROLSOURCE = "nTktQty"
      *N000682,1 MMT 11/20/2012 Globalization Changes[Start]
      *      .COLUMN&LNCOL..HEADER1.CAPTION = 'Issue Qty.'
      *N000682,1 11/20/2012 MMT Globlization changes[Start]
*.COLUMN&LNCOL..HEADER1.CAPTION =LANG_APPYINV_ISSUE_QTY
.COLUMN&LNCOL..HEADER1.CAPTION =IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_ISSUE_QTY,loFormSet.GetHeaderText("LANG_APPYINV_ISSUE_QTY",loFormSet.HeaderAlias))
*N000682,1 11/20/2012 MMT Globlization changes[End]

      *N000682,1 MMT 11/20/2012 Globalization Changes[End]

      LNCOL = ALLTRIM(STR(VAL(LNCOL)+1))
      .COLUMNCOUNT = VAL(LNCOL)
      .COLUMN&LNCOL..CONTROLSOURCE = "nTktCst"
      *N000682,1 MMT 11/20/2012 Globalization Changes[Start]
      *      .COLUMN&LNCOL..HEADER1.CAPTION = 'Issue Cost'
      *N000682,1 11/20/2012 MMT Globlization changes[Start]
*.COLUMN&LNCOL..HEADER1.CAPTION =LANG_APPYINV_ISSUE_COST
.COLUMN&LNCOL..HEADER1.CAPTION =IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_ISSUE_COST,loFormSet.GetHeaderText("LANG_APPYINV_ISSUE_COST",loFormSet.HeaderAlias))
*N000682,1 11/20/2012 MMT Globlization changes[End]

      *N000682,1 11/20/2012 MMT Globlization changes[End]

      LNCOL = ALLTRIM(STR(VAL(LNCOL)+1))
      .COLUMNCOUNT = VAL(LNCOL)
      .COLUMN&LNCOL..CONTROLSOURCE = "ROUND(nTktAmnt,2)"
      *N000682,1 MMT 11/20/2012 Globalization Changes[Start]
      *      .COLUMN&LNCOL..HEADER1.CAPTION = 'Issue Amnt.'
      *N000682,1 11/20/2012 MMT Globlization changes[Start]
*.COLUMN&LNCOL..HEADER1.CAPTION =LANG_APPYINV_ISSUE_AMNT
.COLUMN&LNCOL..HEADER1.CAPTION =IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_ISSUE_AMNT,loFormSet.GetHeaderText("LANG_APPYINV_ISSUE_AMNT",loFormSet.HeaderAlias))
*N000682,1 11/20/2012 MMT Globlization changes[End]

      *N000682,1 MMT 11/20/2012 Globalization Changes[End]

    ENDIF
  ENDIF

  LNCOL = ALLTRIM(STR(VAL(LNCOL)+1))
  .COLUMNCOUNT = VAL(LNCOL)
  .COLUMN&LNCOL..CONTROLSOURCE = "nInvQty"
  *N000682,1 MMT 11/20/2012 Globalization Changes[Start]
  *  .COLUMN&LNCOL..HEADER1.CAPTION = 'Inv. Qty.'
  *N000682,1 11/20/2012 MMT Globlization changes[Start]
*.COLUMN&LNCOL..HEADER1.CAPTION =LANG_APPYINV_INV_QTY
.COLUMN&LNCOL..HEADER1.CAPTION =IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_INV_QTY,loFormSet.GetHeaderText("LANG_APPYINV_INV_QTY",loFormSet.HeaderAlias))
*N000682,1 11/20/2012 MMT Globlization changes[End]

  *N000682,1 MMT 11/20/2012 Globalization Changes[End]

  LNCOL = ALLTRIM(STR(VAL(LNCOL)+1))
  .COLUMNCOUNT = VAL(LNCOL)
  .COLUMN&LNCOL..CONTROLSOURCE = "IIF(nInvQty=0,0,nInvAmnt/nInvQty)"
  *N000682,1 MMT 11/20/2012 Globalization Changes[Start]
  *  .COLUMN&LNCOL..HEADER1.CAPTION = 'Inv. Cost'
  *N000682,1 11/20/2012 MMT Globlization changes[Start]
*.COLUMN&LNCOL..HEADER1.CAPTION =LANG_APPYINV_INV_COST
.COLUMN&LNCOL..HEADER1.CAPTION =IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_INV_COST,loFormSet.GetHeaderText("LANG_APPYINV_INV_COST",loFormSet.HeaderAlias))
*N000682,1 11/20/2012 MMT Globlization changes[End]

  *N000682,1 MMT 11/20/2012 Globalization Changes[End]
  .COLUMN&LNCOL..INPUTMASK='999999999.999'
  LNCOL = ALLTRIM(STR(VAL(LNCOL)+1))
  .COLUMNCOUNT = VAL(LNCOL)
  .COLUMN&LNCOL..CONTROLSOURCE = "ROUND(nInvAmnt,2)"
  *N000682,1 MMT 11/20/2012 Globalization Changes[Start]
  *  .COLUMN&LNCOL..HEADER1.CAPTION = 'Inv. Amnt.'
  *N000682,1 11/20/2012 MMT Globlization changes[Start]
*.COLUMN&LNCOL..HEADER1.CAPTION =LANG_APPYINV_INV_AMOUNT
.COLUMN&LNCOL..HEADER1.CAPTION =IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_INV_AMOUNT,loFormSet.GetHeaderText("LANG_APPYINV_INV_AMOUNT",loFormSet.HeaderAlias))
*N000682,1 11/20/2012 MMT Globlization changes[End]

  *N000682,1 MMT 11/20/2012 Globalization Changes[End]

  LNCOL = ALLTRIM(STR(VAL(LNCOL)+1))
  .COLUMNCOUNT = VAL(LNCOL)
  .COLUMN&LNCOL..CONTROLSOURCE = "nAplQty"
  *N000682,1 MMT 11/20/2012 Globalization Changes[Start]
  *  .COLUMN&LNCOL..HEADER1.CAPTION = 'Apl. Qty.'
  *N000682,1 11/20/2012 MMT Globlization changes[Start]
*.COLUMN&LNCOL..HEADER1.CAPTION =LANG_APPYINV_APL_QTY
.COLUMN&LNCOL..HEADER1.CAPTION =IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_APL_QTY,loFormSet.GetHeaderText("LANG_APPYINV_APL_QTY",loFormSet.HeaderAlias))
*N000682,1 11/20/2012 MMT Globlization changes[End]

  *N000682,1 MMT 11/20/2012 Globalization Changes[End]

  LNCOL = ALLTRIM(STR(VAL(LNCOL)+1))
  .COLUMNCOUNT = VAL(LNCOL)
  .COLUMN&LNCOL..CONTROLSOURCE = "IIF(nAplQty=0,0,nAplAmnt/nAplQty)"
  *N000682,1 MMT 11/20/2012 Globalization Changes[Start]
  *  .COLUMN&LNCOL..HEADER1.CAPTION = 'Apl. Cost'
  *N000682,1 11/20/2012 MMT Globlization changes[Start]
*.COLUMN&LNCOL..HEADER1.CAPTION =LANG_APPYINV_APL_COST
.COLUMN&LNCOL..HEADER1.CAPTION =IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_APL_COST,loFormSet.GetHeaderText("LANG_APPYINV_APL_COST",loFormSet.HeaderAlias))
*N000682,1 11/20/2012 MMT Globlization changes[End]

  *N000682,1 MMT 11/20/2012 Globalization Changes[End]

  LNCOL = ALLTRIM(STR(VAL(LNCOL)+1))
  .COLUMNCOUNT = VAL(LNCOL)
  .COLUMN&LNCOL..CONTROLSOURCE = "ROUND(nAplAmnt,2)"
  *N000682,1 MMT 11/20/2012 Globalization Changes[Start]
  *  .COLUMN&LNCOL..HEADER1.CAPTION = 'Apl. Amnt.'
  *N000682,1 11/20/2012 MMT Globlization changes[Start]
*.COLUMN&LNCOL..HEADER1.CAPTION =LANG_APPYINV_APL_AMNT
.COLUMN&LNCOL..HEADER1.CAPTION =IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_APL_AMNT,loFormSet.GetHeaderText("LANG_APPYINV_APL_AMNT",loFormSet.HeaderAlias))
*N000682,1 11/20/2012 MMT Globlization changes[End]

  *N000682,1 MMT 11/20/2012 Globalization Changes[End]

  IF INLIST(LOAUTOFORM.LATICKETS[loAutoForm.cboTktType.Value,2],'S','I','M','R','A','D')

    FOR LNC=1 TO 8
      LNCOL = ALLTRIM(STR(VAL(LNCOL)+1))
      .COLUMNCOUNT = VAL(LNCOL)
      .COLUMN&LNCOL..CONTROLSOURCE = "nTktQty"+ALLTRIM(STR(LNC))
      *N000682,1 MMT 11/20/2012 Globalization Changes[Start]
      *      .COLUMN&LNCOL..HEADER1.CAPTION = 'Doc Qty'+ALLTRIM(STR(LNC))
      *N000682,1 11/20/2012 MMT Globlization changes[Start]
      *.COLUMN&LNCOL..HEADER1.CAPTION =LANG_APPYINV_DOC_QTY +ALLTRIM(STR(LNC)
     .COLUMN&LNCOL..HEADER1.CAPTION =IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_DOC_QTY,loFormSet.GetHeaderText("LANG_APPYINV_DOC_QTY",loFormSet.HeaderAlias)) +ALLTRIM(STR(LNC))
     *N000682,1 11/20/2012 MMT Globlization changes[End]

      *N000682,1 11/20/2012 MMT Globlization changes[End]

    NEXT

    FOR LNC=1 TO 8
      LNCOL = ALLTRIM(STR(VAL(LNCOL)+1))
      .COLUMNCOUNT = VAL(LNCOL)
      .COLUMN&LNCOL..CONTROLSOURCE = "nInvQty"+ALLTRIM(STR(LNC))
      *N000682,1 MMT 11/20/2012 Globalization Changes[Start]
      *      .COLUMN&LNCOL..HEADER1.CAPTION = 'Inv Qty'+ALLTRIM(STR(LNC))
      *N000682,1 11/20/2012 MMT Globlization changes[Start]
*.COLUMN&LNCOL..HEADER1.CAPTION =LANG_APPYINV_INV_QTY+ALLTRIM(STR(LNC)
.COLUMN&LNCOL..HEADER1.CAPTION =IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_INV_QTY,loFormSet.GetHeaderText("LANG_APPYINV_INV_QTY",loFormSet.HeaderAlias))+ALLTRIM(STR(LNC))
*N000682,1 11/20/2012 MMT Globlization changes[End]

      *N000682,1 MMT 11/20/2012 Globalization Changes[End]

    NEXT

    FOR LNC=1 TO 8
      LNCOL = ALLTRIM(STR(VAL(LNCOL)+1))
      .COLUMNCOUNT = VAL(LNCOL)
      .COLUMN&LNCOL..CONTROLSOURCE = "nAplQty"+ALLTRIM(STR(LNC))
      *N000682,1 MMT 11/20/2012 Globalization Changes[Start]
      *      .COLUMN&LNCOL..HEADER1.CAPTION = 'Apl Qty'+ALLTRIM(STR(LNC))
      *N000682,1 11/20/2012 MMT Globlization changes[Start]
*.COLUMN&LNCOL..HEADER1.CAPTION =LANG_APPYINV_APL_QTY+ALLTRIM(STR(LNC)
.COLUMN&LNCOL..HEADER1.CAPTION =IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_APL_QTY,loFormSet.GetHeaderText("LANG_APPYINV_APL_QTY",loFormSet.HeaderAlias))+ALLTRIM(STR(LNC))
*N000682,1 11/20/2012 MMT Globlization changes[End]

      *N000682,1 MMT 11/20/2012 Globalization Changes[End]

    NEXT

  ENDIF

ENDWITH

RETURN
*-- End of lfAInvBrow



*!*************************************************************
*! Name      : lfwAInvDt
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 09/12/2004
*! Purpose   : Called from the AfterRowColChange Event of the grid in APAINVD.SCX
*!*************************************************************
*! Parameters: The FormSet of APPYINV.SCX, The Form of APINVDT.SCX, The Form of APAINVD.SCX
*!*************************************************************
*! Returns   :  None
*!*************************************************************
FUNCTION LFWAINVDT
LPARAMETERS LOFORMSET, LOFORM, LOAUTOFORM

IF CSELECT = SPACE(1)
  *Old: SHOW GET pbSelect,1 PROMPT '\<Select' &&Revise
  *N000682,1 MMT 11/20/2012 Globalization Changes[Start]
  *  LOAUTOFORM.CMDSELECT.CAPTION='\<Select'
  *N000682,1 11/20/2012 MMT Globlization changes[Start]
*LOAUTOFORM.CMDSELECT.CAPTION=LANG_APPYINV_SELECT
LOAUTOFORM.CMDSELECT.CAPTION=IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_SELECT,loFormSet.GetHeaderText("LANG_APPYINV_SELECT",loFormSet.HeaderAlias))
*N000682,1 11/20/2012 MMT Globlization changes[End]

  *N000682,1 MMT 11/20/2012 Globalization Changes[End]



ELSE
  *Old: SHOW GET pbSelect,1 PROMPT 'Un\<Select' &&Revise
  *N000682,1 MMT 11/20/2012 Globalization Changes[Start]
  *  LOAUTOFORM.CMDSELECT.CAPTION='Un\<Select'
  *N000682,1 11/20/2012 MMT Globlization changes[Start]
*LOAUTOFORM.CMDSELECT.CAPTION=LANG_APPYINV_UNSELECT
LOAUTOFORM.CMDSELECT.CAPTION=IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_UNSELECT,loFormSet.GetHeaderText("LANG_APPYINV_UNSELECT",loFormSet.HeaderAlias))
*N000682,1 11/20/2012 MMT Globlization changes[End]

  *N000682,1 MMT 11/20/2012 Globalization Changes[End]



ENDIF


*Do not edit any invoices which have a closed PO in case of Auto Contr Shipment case
*IF loAutoForm.laTickets[loAutoForm.cboTktType.Value,2] = "S"  .AND. SEEK("P"+CtktNo,"POSHDR") .AND. ;
POSHDR.Status = "S"
IF LOAUTOFORM.LATICKETS[loAutoForm.cboTktType.Value,2] = "S"  .AND. ;
    LOFORMSET.POSHDR.SEEK("PP"+CTKTNO) .AND. POSHDR.STATUS = "S"
  REPLACE CSELECT WITH IIF(CSELECT <> SPACE(1) ,SPACE(1),CSELECT)
  *Old: SHOW GET pbSelect  DISABLE &&Revise
  *Old: SHOW GET pbSelAll  DISABLE &&Revise
  *Old: SHOW GET pbSelNone DISABLE &&Revise
  *Old: SHOW GET pbInvert  DISABLE &&Revise
  STORE .F. TO LOAUTOFORM.CMDSELECT.ENABLED, LOAUTOFORM.CMDSELALL.ENABLED, ;
    LOAUTOFORM.CMDSELNONE.ENABLED, LOAUTOFORM.CMDINVERT.ENABLED
ELSE
  *Old: SHOW GET pbSelect  ENABLE &&Revise
  *Old: SHOW GET pbSelAll  ENABLE &&Revise
  *Old: SHOW GET pbSelNone ENABLE &&Revise
  *Old: SHOW GET pbInvert  ENABLE &&Revise
  STORE .T. TO LOAUTOFORM.CMDSELECT.ENABLED, LOAUTOFORM.CMDSELALL.ENABLED, ;
    LOAUTOFORM.CMDSELNONE.ENABLED, LOAUTOFORM.CMDINVERT.ENABLED
ENDIF

RETURN
*-- End of lfwAInvDt


*!*************************************************************
*! Name      : lfwATktType
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 09/12/2004
*! Purpose   : Create Array with available Document Types. Called from the When event
*!             of cboTktType in APAINVD.SCX
*!*************************************************************
*! Parameters: The FormSet of APPYINV.SCX, The Form of APINVDT.SCX, The Form of APAINVD.SCX
*!*************************************************************
*! Returns   :  None
*!*************************************************************
FUNCTION LFWATKTTYPE
LPARAMETERS LOFORMSET, LOFORM, LOAUTOFORM

IF LOAUTOFORM.LLFIRST
  LOAUTOFORM.LLFIRST = .F.
  RETURN(.F.)
ENDIF
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*IF loForm.laTktType[1,2]='G'
*!*	  DECLARE loAutoForm.laTickets[ALEN(loForm.laTktType,1)-1,3]
*!*	  =ACOPY(loForm.laTktType,loAutoForm.laTickets,4)
IF LOFORMSET.LATKTTYPE[1,2]='G'
  DECLARE LOAUTOFORM.LATICKETS[ALEN(loFormSet.laTktType,1)-1,3]
  =ACOPY(LOFORMSET.LATKTTYPE,LOAUTOFORM.LATICKETS,4)
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
ELSE
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	  DECLARE loAutoForm.laTickets[ALEN(loForm.laTktType,1),3]
  *!*	  =ACOPY(loForm.laTktType,loAutoForm.laTickets)
  DECLARE LOAUTOFORM.LATICKETS[ALEN(loFormSet.laTktType,1),3]
  =ACOPY(LOFORMSET.LATKTTYPE,LOAUTOFORM.LATICKETS)
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
ENDIF
*Old: SHOW GET loAutoForm.cboTktType  &&Revise
LOAUTOFORM.CBOTKTTYPE.REQUERY()

RETURN
*-- End of lfwATktType



*!*************************************************************
*! Name      : lfvATktType
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 09/12/2004
*! Purpose   : Validate Selected Document Types. Called from the Valid event
*!             of cboTktType in APAINVD.SCX
*!*************************************************************
*! Parameters: The FormSet of APPYINV.SCX, The Form of APINVDT.SCX, The Form of APAINVD.SCX
*!*************************************************************
*! Returns   :  None
*!*************************************************************
FUNCTION LFVATKTTYPE
LPARAMETERS LOFORMSET, LOFORM, LOAUTOFORM

*=lfRefresh('APAINVD0')
*Old: SHOW GET loAutoForm.cboTktType DISABLE  &&Revise
*Old: SHOW GET ibTktNo  ENABLE &&Revise
*Old: SHOW GET loAutoForm.kbInvTktNo  ENABLE  &&Revise
*SHOW GET lnAplCst ENABLE
LOAUTOFORM.CBOTKTTYPE.ENABLED = .F.
LOAUTOFORM.KBINVTKTNO.ENABLED = .T.

RETURN 1
*-- End of lfvATktType



*!*************************************************************
*! Name      : lfvAutoTkt
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 09/12/2004
*! Purpose   : Validate Selected Document #. Called from the Valid event
*!             of kbInvTktNo in APAINVD.SCX
*!*************************************************************
*! Parameters: The FormSet of APPYINV.SCX, The Form of APINVDT.SCX, The Form of APAINVD.SCX
*!*************************************************************
*! Returns   :  None
*!*************************************************************
FUNCTION LFVAUTOTKT
LPARAMETERS LOFORMSET, LOFORM, LOAUTOFORM

LOFORMSET.LLBROWSE = LOAUTOFORM.KBINVTKTNO.SELECTEDFROMBROWSE

PRIVATE LCLINKCODE
STORE SPACE(6) TO LCLINKCODE
KBINVTKTNO=LOAUTOFORM.KBINVTKTNO.KEYTEXTBOX.VALUE
=LFVTICKET(LOFORMSET,LOFORM,LOAUTOFORM.LATICKETS[loAutoForm.cboTktType.Value,2],@KBINVTKTNO,@LCLINKCODE,;
  LOAUTOFORM.LAAPLCST[loAutoForm.cboCostType.Value,2])
LOAUTOFORM.KBINVTKTNO.KEYTEXTBOX.VALUE=KBINVTKTNO
IF LOFORMSET.LASETUPS[3,2]='Y'
  IF !SEEK(LCLINKCODE+'013','GL_LINK')
    =SEEK('DEFDEF'+'013','GL_LINK')
  ENDIF
  STORE GL_LINK.GLACNT TO LOAUTOFORM.GLAPDGLACT.KEYTEXTBOX.VALUE,LOAUTOFORM.LCWIPACNT
ELSE
  STORE LOFORMSET.LCDISTACCT TO LOAUTOFORM.GLAPDGLACT.KEYTEXTBOX.VALUE,LOAUTOFORM.LCWIPACNT
ENDIF

IF !EMPTY(LOAUTOFORM.KBINVTKTNO.KEYTEXTBOX.VALUE)
  *Old: SHOW GET ibTktNo  DISABLE &&Revise
  *Old: SHOW GET loAutoForm.kbInvTktNo  DISABLE  &&Revise
  *Old: SHOW GET loAutoForm.cboCostType ENABLE   &&Revise
  LOAUTOFORM.KBINVTKTNO.ENABLED = .F.
  LOAUTOFORM.CBOCOSTTYPE.ENABLED = .T.
ENDIF
LOFORMSET.LLBROWSE = .F.
LOAUTOFORM.KBINVTKTNO.SELECTEDFROMBROWSE = .F.

RETURN
*-- End of lfvAutoTkt


*!*************************************************************
*! Name      : lfwAplCst
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 09/12/2004
*! Purpose   : Create Array with available cost types. Called from the When event
*!             of cboCostType in APAINVD.SCX
*!*************************************************************
*! Parameters: The FormSet of APPYINV.SCX, The Form of APINVDT.SCX, The Form of APAINVD.SCX
*!*************************************************************
*! Returns   :  None
*!*************************************************************
FUNCTION LFWAPLCST
LPARAMETERS LOFORMSET, LOFORM, LOAUTOFORM

IF EMPTY(LOAUTOFORM.LAAPLCST[1,2])
  DO CASE
  CASE INLIST(LOAUTOFORM.LATICKETS[loAutoForm.cboTktType.Value,2],'I','S','M','R')
    LCARYNAME = IIF(LOAUTOFORM.LATICKETS[loAutoForm.cboTktType.Value,2]='M','loFormSet.laMCstType','loFormSet.laICstType')
    DECLARE LOAUTOFORM.LAAPLCST[ALEN(&lcAryName,1),3]
    =ACOPY(&LCARYNAME,LOAUTOFORM.LAAPLCST)

  CASE INLIST(LOAUTOFORM.LATICKETS[loAutoForm.cboTktType.Value,2],'T','L','F')
    LCARYNAME = IIF(LOAUTOFORM.LATICKETS[loAutoForm.cboTktType.Value,2]='T','loFormSet.laTCstType','loFormSet.laLCstType')
    DECLARE LOAUTOFORM.LAAPLCST[ALEN(&lcAryName,1),3]
    =ACOPY(&LCARYNAME,LOAUTOFORM.LAAPLCST)

  CASE INLIST(LOAUTOFORM.LATICKETS[loAutoForm.cboTktType.Value,2],'A')
    LCARYNAME = IIF(LOAUTOFORM.LATICKETS[loAutoForm.cboTktType.Value,2]='A','loFormSet.laACstType','loFormSet.laICstType')
    DECLARE LOAUTOFORM.LAAPLCST[ALEN(&lcAryName,1),3]
    =ACOPY(&LCARYNAME,LOAUTOFORM.LAAPLCST)

  CASE INLIST(LOAUTOFORM.LATICKETS[loAutoForm.cboTktType.Value,2],'D')
    LCARYNAME = IIF(LOAUTOFORM.LATICKETS[loAutoForm.cboTktType.Value,2]='D','loFormSet.laMCstType','loFormSet.laICstType')
    DECLARE LOAUTOFORM.LAAPLCST[ALEN(&lcAryName,1),3]
    =ACOPY(&LCARYNAME,LOAUTOFORM.LAAPLCST)

  ENDCASE
  *Old: SHOW GET loAutoForm.cboCostType  &&Revise
  LOAUTOFORM.CBOCOSTTYPE.REQUERY()

ENDIF

RETURN
*-- End of lfwAplCst


*!*************************************************************
*! Name      : lfvAplCst
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 09/12/2004
*! Purpose   : Validate Selected Cost Type. Called from the Valid event
*!             of cboCostType in APAINVD.SCX
*!*************************************************************
*! Parameters: The FormSet of APPYINV.SCX, The Form of APINVDT.SCX, The Form of APAINVD.SCX
*!*************************************************************
*! Returns   :  None
*!*************************************************************
FUNCTION LFVAPLCST
*N000682,1 MMT 12/09/2012 Globalization changes[Start]
*LPARAMETERS LOFORMSET, LOFORM, LOAUTOFORM
PARAMETERS LOFORMSET, LOFORM, LOAUTOFORM
*N000682,1 MMT 12/09/2012 Globalization changes[End]
IF LOAUTOFORM.LAAPLCST[loAutoForm.cboCostType.Value,3] = 'M'
  LOAUTOFORM.CBOMFGOPR.VALUE =1
  DIMENSION LACODE[ALEN(loFormSet.laCodes,1),ALEN(loFormSet.laCodes,2)]
  =ACOPY(LOFORMSET.LACODES,LACODES)
  =GFWCODEPOP(@LACODES,'MFGCODE','L')
  =ACOPY(LACODES,LOFORMSET.LACODES)
  LOAUTOFORM.LCMFGCODE=LOFORMSET.LAMFGCODE[loAutoForm.cboMFGOpr.Value,2]

  *Old: SHOW GET loAutoForm.cboMFGOpr ENABLE  &&Revise
  *Check that the Document currency same as invoice currency [BEGIN]
  *Old: SHOW GET loAutoForm.cboCostType   DISABLE   &&Revise
  *Old: SHOW GET ibRSession ENABLE &&Revise
  *Old: SHOW GET loAutoForm.kbRSession ENABLE  &&Revise
  *Old: SHOW GET ibWIPAcnt  ENABLE &&Revise
  *Old: SHOW GET loAutoForm.glApDGlAct.KeyTextBox.Value ENABLE &&Revise
  *Old: SHOW GET pbGenerate ENABLE &&Revise
  LOAUTOFORM.CBOCOSTTYPE.ENABLED = .F.
  STORE .T. TO LOAUTOFORM.CBOMFGOPR.ENABLED, LOAUTOFORM.KBRSESSION.ENABLED, ;
    LOAUTOFORM.GLAPDGLACT.ENABLED, LOAUTOFORM.CMDGENERATE.ENABLED
  *Check that the Document currency same as invoice currency [END]
ELSE
  *Check that the Document currency same as invoice currency [BEGIN]
  IF LFCHKCSTCUR(LOFORMSET,LOFORM,LOAUTOFORM.LATICKETS[loAutoForm.cboTktType.Value,2],;
      LOAUTOFORM.KBINVTKTNO.KEYTEXTBOX.VALUE,;
      LOAUTOFORM.LAAPLCST[loAutoForm.cboCostType.Value,3])
    DIMENSION LACODE[ALEN(loFormSet.laCodes,1),ALEN(loFormSet.laCodes,2)]
    =ACOPY(LOFORMSET.LACODES,LACODES)
    =GFWCODEPOP(@LACODES,'MFGCODE','N')
    =ACOPY(LACODES,LOFORMSET.LACODES)
    *Old: SHOW GET loAutoForm.cboMFGOpr DISABLE   &&Revise
    LOAUTOFORM.CBOMFGOPR.ENABLED = .F.
    LOAUTOFORM.LCMFGCODE=REPLICATE(IIF(LOAUTOFORM.LAAPLCST[loAutoForm.cboCostType.Value,3]='P','*',;
      IIF(LOAUTOFORM.LAAPLCST[loAutoForm.cboCostType.Value,3]='D','#',' ')),6)
    *Old: SHOW GET loAutoForm.cboCostType   DISABLE  &&Revise
    *Old: SHOW GET ibRSession ENABLE &&Revise
    *Old: SHOW GET loAutoForm.kbRSession ENABLE  &&Revise
    *Old: SHOW GET ibWIPAcnt  ENABLE &&Revise
    *Old: SHOW GET loAutoForm.glApDGlAct.KeyTextBox.Value ENABLE &&Revise
    *Old: SHOW GET pbGenerate ENABLE &&Revise
    LOAUTOFORM.CBOCOSTTYPE.ENABLED = .F.
    STORE .T. TO LOAUTOFORM.KBRSESSION.ENABLED, LOAUTOFORM.GLAPDGLACT.ENABLED, ;
      LOAUTOFORM.CMDGENERATE.ENABLED
  ELSE
    *Old: SHOW GET ibTktNo  ENABLE &&Revise
    *Old: SHOW GET loAutoForm.kbInvTktNo  ENABLE   &&Revise
    *Old: SHOW GET loAutoForm.cboCostType DISABLE   &&Revise
    *_CUROBJ = OBJNUM(loAutoForm.kbInvTktNo)  &&Old CurObj
    LOAUTOFORM.KBINVTKTNO.ENABLED = .T.
    LOAUTOFORM.CBOCOSTTYPE.ENABLED = .F.
    LOAUTOFORM.KBINVTKTNO.KEYTEXTBOX.SETFOCUS()
  ENDIF
  *Check that the Document currency same as invoice currency [END]
ENDIF

RETURN 1
*-- End of lfvAplCst

*!*************************************************************
*! Name      : lfwAplOpr
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 09/12/2004
*! Purpose   : Called from the When event of cboMFGOpr in APAINVD.SCX
*!*************************************************************
*! Parameters: The FormSet of APPYINV.SCX, The Form of APINVDT.SCX, The Form of APAINVD.SCX
*!*************************************************************
*! Returns   :  None
*!*************************************************************
FUNCTION LFWAPLOPR
*N000682,1 MMT 12/09/2012 Globalization changes[Start]
*LPARAMETERS LOFORMSET, LOFORM, LOAUTOFORM
PARAMETERS LOFORMSET, LOFORM, LOAUTOFORM
*N000682,1 MMT 12/09/2012 Globalization changes[End]
DIMENSION LACODES[ALEN(loFormSet.laCodes,1),ALEN(loFormSet.laCodes,2)]
=ACOPY(LOFORMSET.LACODES,LACODES)
=GFWCODEPOP(@LACODES,'MFGCODE','L')
=ACOPY(LACODES,LOFORMSET.LACODES)
LOAUTOFORM.CBOMFGOPR.REQUERY()
RETURN
*-- End of lfwAplOpr


*!*************************************************************
*! Name      : lfvAplOpr
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 09/12/2004
*! Purpose   : Validate Selected MFG Operation. Called from the Valid event
*!             of cboMFGOpr in APAINVD.SCX
*!*************************************************************
*! Parameters: The FormSet of APPYINV.SCX, The Form of APINVDT.SCX, The Form of APAINVD.SCX
*!*************************************************************
*! Returns   :  None
*!*************************************************************
FUNCTION LFVAPLOPR
LPARAMETERS LOFORMSET, LOFORM, LOAUTOFORM

LOAUTOFORM.LCMFGCODE=LOFORMSET.LAMFGCODE[loAutoForm.cboMFGOpr.Value,2]
DIMENSION LAMFGRFLD[ALEN(loFormSet.laMfgRFld,1),ALEN(loFormSet.laMfgRFld,2)]
=ACOPY(LOFORMSET.LAMFGRFLD,LAMFGRFLD)
=GFRLTFLD(LOAUTOFORM.LCMFGCODE,@LAMFGRFLD,'MFGCODE')
=ACOPY(LAMFGRFLD,LOFORMSET.LAMFGRFLD)
IF !EMPTY(LOFORMSET.LCMFGGLACNT)
  *Message : 04152
  *MFG Code has been setup to be applied directly through the
  *cost sheet program
  *Button : 00000
  *Ok
  =GFMODALGEN("TRM04152B00000","DIALOG",LOFORMSET.LAMFGCODE[loAutoForm.cboMFGOpr.Value,1])
  RETURN
ENDIF
LOCAL LCSQLSTATEMENT, LNRESULT, LCALIAS
LCALIAS = ALIAS()
*! B610120,1 HIA 17/10/2012 T20121005.0001 - Aria4xp - AP - Error message applying invoice to Material Manufacturing order [Begin]
*! B610236,1 HIA 02/11/2013 Aria4xp - AP - Payable Invoice - Auto screen GPS LTD Waiting Scheduling [T20130130.0018][Start]
IF LOAUTOFORM.LATICKETS[loAutoForm.cbotktType.value,2] $ 'IMT'
  *! B610236,1 HIA 02/11/2013 Aria4xp - AP - Payable Invoice - Auto screen GPS LTD Waiting Scheduling [T20130130.0018][End]
lcSQLSTATEMENT = "SELECT CCURRCODE FROM BOMLINE (INDEX=BOMLINE) WHERE "+;
                 "CIMTYP='"+LOAUTOFORM.LATICKETS[loAutoForm.cboTktType.Value,2]+;
                 "' AND CTKTNO='"+LOAUTOFORM.KBINVTKTNO.KEYTEXTBOX.VALUE+"' "+;
                 "AND mfgcode ='"+LOAUTOFORM.LCMFGCODE+"'"

lnRESULT = OARIAAPPLICATION.REMOTECOMPANYDATA.SQLRUN(LCSQLSTATEMENT,'BomLCurr','BOMLINE',;
           OARIAAPPLICATION.ACTIVECOMPANYCONSTR,3,'SAVE',LOFORMSET.DATASESSIONID)

IF lnRESULT<1
  oARIAAPPLICATION.REMOTECOMPANYDATA.CHECKRETRESULT("execute",LNRESULT,.T.)
  IF !EMPTY(LCALIAS)
    SELECT (LCALIAS)
  ENDIF
  loAutoForm.cboMFGOpr.ENABLED =.F.
  LOAUTOFORM.CMDGENERATE.ENABLED =.F.
  LOAUTOFORM.CBOCOSTTYPE.ENABLED = .T.
  LOAUTOFORM.CBOCOSTTYPE.SETFOCUS()
  RETURN .F.
ENDIF

SELECT 'BomLCurr'
LOCATE
IF EOF()
  IF !EMPTY(LCALIAS)
    SELECT (LCALIAS)
  ENDIF
  loAutoForm.cboMFGOpr.ENABLED =.F.
  LOAUTOFORM.CMDGENERATE.ENABLED =.F.
  LOAUTOFORM.CBOCOSTTYPE.ENABLED = .T.
  LOAUTOFORM.CBOCOSTTYPE.SETFOCUS()

  RETURN .F.
ENDIF
IF BomLCurr.CCURRCODE <> PADR(LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.KEYTEXTBOX.VALUE,3)
  =GFMODALGEN("TRM04168B00000","DIALOG",ALLT(LOAUTOFORM.CBOCOSTTYPE.DISPLAYVALUE)+'|Cost|'+LOFORMSET.ARIAFORM1.PGFPAYINV.PGHEAD.KBCURRCODE.KEYTEXTBOX.VALUE)
  loAutoForm.cboMFGOpr.ENABLED =.F.
  LOAUTOFORM.CMDGENERATE.ENABLED =.F.
  LOAUTOFORM.CBOCOSTTYPE.ENABLED = .T.
  LOAUTOFORM.CBOCOSTTYPE.SETFOCUS()

  IF !EMPTY(LCALIAS)
    SELECT (LCALIAS)
  ENDIF
  RETURN .F.
ENDIF
LOAUTOFORM.CMDGENERATE.ENABLED =.T.
  *! B610236,1 HIA 02/11/2013 Aria4xp - AP - Payable Invoice - Auto screen GPS LTD Waiting Scheduling [T20130130.0018][Start]
ENDIF
*! B610236,1 HIA 02/11/2013 Aria4xp - AP - Payable Invoice - Auto screen GPS LTD Waiting Scheduling [T20130130.0018][End]
*! B610120,1 HIA 17/10/2012 T20121005.0001 - Aria4xp - AP - Error message applying invoice to Material Manufacturing order [End]

*CIMTYP+CTKTNO+COPRCODE+CLOTNO+TRANCD
LCSQLSTATEMENT = "SELECT DISTINCT cLotNo FROM MFGOPRDT (INDEX=MFGOPRDT) WHERE "+;
  "CIMTYP='"+LOAUTOFORM.LATICKETS[loAutoForm.cboTktType.Value,2]+;
  "' AND CTKTNO='"+LOAUTOFORM.KBINVTKTNO.KEYTEXTBOX.VALUE+"' "+;
  "AND COPRCODE='"+LOAUTOFORM.LCMFGCODE+"'"
LNRESULT=OARIAAPPLICATION.REMOTECOMPANYDATA.SQLRUN(LCSQLSTATEMENT,'Lots','MFGOPRDT',;
  OARIAAPPLICATION.ACTIVECOMPANYCONSTR,3,'SAVE',LOFORMSET.DATASESSIONID)
IF LNRESULT<1
  OARIAAPPLICATION.REMOTECOMPANYDATA.CHECKRETRESULT("execute",LNRESULT,.T.)
  IF !EMPTY(LCALIAS)
    SELECT (LCALIAS)
  ENDIF
  *AIT WINDOW LINENO()
  RETURN .F.
ENDIF


SELECT CLOTNO FROM LOTS INTO ARRAY LOAUTOFORM.LAAPLLOTS &&Sql106: Must use SqlRun
USE IN LOTS
IF !EMPTY(LCALIAS)
  SELECT (LCALIAS)
ENDIF

LOAUTOFORM.CBOLOTNO.VALUE = 1
DO CASE
CASE _TALLY = 0
  DECLARE LOAUTOFORM.LAAPLLOTS[1]
  *N000682,1 MMT 12/09/2012 Globalization changes[Start]
  *LOAUTOFORM.LAAPLLOTS[1] = 'N/A'
  LOAUTOFORM.LAAPLLOTS[1] = IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_NOTAPPLICABLE,LOAUTOFORM.GetHeaderText("LANG_APPYINV_NOTAPPLICABLE",LOAUTOFORM.HeaderAlias))
  *N000682,1 MMT 12/09/2012 Globalization changes[End]
  *Old: SHOW GET loAutoForm.cboLotNo DISABLE  &&Revise
  LOAUTOFORM.CBOLOTNO.ENABLED = .F.
CASE _TALLY = 1
  *Old: SHOW GET loAutoForm.cboLotNo DISABLE  &&Revise
  LOAUTOFORM.CBOLOTNO.ENABLED = .F.
OTHERWISE
  *Old: SHOW GET loAutoForm.cboLotNo ENABLE  &&Revise
  LOAUTOFORM.CBOLOTNO.ENABLED = .T.
ENDCASE
*(Begin) Enabling the RSession object in case
*of there are no lots or one and only one lot.
IF _TALLY <= 1
  LOAUTOFORM.LCAPLLOTNO = SPACE(2)
  *Old: SHOW GET ibRSession ENABLE &&Revise
  *Old: SHOW GET loAutoForm.kbRSession ENABLE  &&Revise
  LOAUTOFORM.KBRSESSION.ENABLED = .T.
ELSE
  LOAUTOFORM.LCAPLLOTNO = LOAUTOFORM.LAAPLLOTS[loAutoForm.cboLotNo.Value]
  STORE '' TO LOAUTOFORM.KBRSESSION.KEYTEXTBOX.VALUE
  *Old: SHOW GET ibRSession DISABLE &&Revise
  *Old: SHOW GET loAutoForm.kbRSession DISABLE  &&Revise
  LOAUTOFORM.KBRSESSION.ENABLED = .F.
ENDIF

*Change the defaulte WIP Account to LFNM Account (ENGLAND)[Begin]
*IF ASCAN(laEvntTrig , PADR('UPDAAPGL',10)) <> 0
*=gfDoTriger('APPYINV',PADR('UPDAAPGL',10))
*ENDIF
*Change the defaulte WIP Account to LFNM Account (ENGLAND)[end]

RETURN 1
*-- End of lfvAplOpr


*!*************************************************************
*! Name      : lfvAplLotNo
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 09/12/2004
*! Purpose   : Validate Selected MFG Operation Lot#. Called from the Valid event
*!             of cboLotNo in APAINVD.SCX
*!*************************************************************
*! Parameters: The FormSet of APPYINV.SCX, The Form of APINVDT.SCX, The Form of APAINVD.SCX
*!*************************************************************
*! Returns   :  None
*!*************************************************************
FUNCTION LFVAPLLOTNO
LPARAMETERS LOFORMSET, LOFORM, LOAUTOFORM

LOAUTOFORM.LCAPLLOTNO = LOAUTOFORM.LAAPLLOTS[loAutoForm.cboLotNo.Value]

RETURN 1
*-- End of lfvAplLotNo


*!*************************************************************
*! Name      : lfvRSession
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 09/12/2004
*! Purpose   : Validate Selected Document Receiving Session. Called from the Valid event
*!             of kbRSession in APAINVD.SCX
*!*************************************************************
*! Parameters: The FormSet of APPYINV.SCX, The Form of APINVDT.SCX, The Form of APAINVD.SCX,
*!                       lcType    : Document Type
*!                       lcTicket  : Document #
*!                       llClrRead : Terminate Read
*!*************************************************************
*! Returns   :  None
*!*************************************************************
FUNCTION LFVRSESSION
LPARAMETERS LOFORMSET, LOFORM, LOAUTOFORM, LCTYPE, LCTICKET, LLCLRREAD, LCITEM, LCCOLOR, LCCSTTYPE

LOCAL LCSQLSTATEMENT, LNRESULT, LCALIAS, LLRETVAL
LLRETVAL = .T.

LCALIAS = ALIAS()

LOFORMSET.LLBROWSE = LOAUTOFORM.KBRSESSION.SELECTEDFROMBROWSE

*Fix bug when Saving the debit memo againest Return PO [BEGIN]
PRIVATE LCBRFIELDS,LCFILE_TTL,LCRCVSESS
STORE '' TO LCBRFIELDS,LCFILE_TTL,LCRCVSESS
LCRCVSESS = GFTEMPNAME()
*Fix bug when Saving the debit memo againest Return PO [END]

SET ENGINEBEHAVIOR 70

DO CASE
CASE INLIST(LCTYPE,'I','R','A','D')
  *Old: SET ORDER TO TAG Posrec IN POSLN
  LOFORMSET.POSLN.SETORDER('POSREC') &&Sql106: Check Tag ;
  *CBUSDOCU+CSTYTYPE+PO+CRSESSION+SHIPNO+CINVTYPE+STYLE+STR(LINENO,6)+TRANCD+CSTYGRADE ;
  (CSTYTYPE+PO+CRSESSION+SHIPNO+STYLE+STR(LINENO,6)+TRANCD)
  LCTEMP = IIF(LCTYPE='R','R','P')+IIF(INLIST(LCTYPE,'A','D'),LCTYPE,'P')
  IF LOFORMSET.LLBROWSE OR (!EMPTY(LOAUTOFORM.KBRSESSION.KEYTEXTBOX.VALUE) AND ;
      !LOFORMSET.POSLN.SEEK(LCTEMP+LCTICKET+LOAUTOFORM.KBRSESSION.KEYTEXTBOX.VALUE+SPACE(6)+;
      IIF(EMPTY(LCITEM),"",'0001'+ALLTRIM(LCITEM)))) &&Sql107: Check Key
    LCSQLSTATEMENT = "SELECT * FROM POSLN (INDEX=POSREC) WHERE "+;
      "CBUSDOCU='"+LEFT(LCTEMP,1)+"' AND CSTYTYPE='"+RIGHT(LCTEMP,1)+"' "+;
      "AND PO='"+LCTICKET+"'"
    LNRESULT=OARIAAPPLICATION.REMOTECOMPANYDATA.SQLRUN(LCSQLSTATEMENT,'RcvSess','POSLN',;
      OARIAAPPLICATION.ACTIVECOMPANYCONSTR,3,'SAVE',LOFORMSET.DATASESSIONID)
    IF LNRESULT<1
      OARIAAPPLICATION.REMOTECOMPANYDATA.CHECKRETRESULT("execute",LNRESULT,.T.)
      IF !EMPTY(LCALIAS)
        SELECT (LCALIAS)
      ENDIF
      *AIT WINDOW LINENO()
      RETURN .F.
    ENDIF

    SET ENGINEBEHAVIOR 70

    SELECT CRSESSION ,DATE ,SUM(TOTQTY) AS NRECQTY, SUM(TOTQTY*NFLANCOST&LCCSTTYPE) AS NRECAMNT ;
      FROM RCVSESS WHERE !EMPTY(CRSESSION) AND CINVTYPE+STYLE=IIF(EMPTY(LCITEM),'','0001'+ALLTRIM(LCITEM)) AND ;
      IIF(LCTYPE = 'A',TRANCD<>'6',.T.) ;
      GROUP BY CSTYTYPE,PO,CRSESSION INTO DBF (OARIAAPPLICATION.WORKDIR+LCRCVSESS)  &&Sql108: Must use SqlRun
    USE IN RCVSESS

    *Fix bug when Saving the debit memo againest Return PO [END]
    LOFORMSET.LLBROWSE = .T.
    LOAUTOFORM.KBRSESSION.SELECTEDFROMBROWSE = .T.
  ENDIF
  *Old: SET ORDER TO TAG PosLn IN POSLN
  LOFORMSET.POSLN.SETORDER('POSLN') &&Sql109: Check Tag ;
  *CBUSDOCU+CSTYTYPE+PO+CINVTYPE+STYLE+STR(LINENO,6)+TRANCD ;
  (CSTYTYPE+PO+STYLE+STR(LINENO,6)+TRANCD)
CASE LCTYPE='S'
  *Old: SET ORDER TO TAG Poshrec IN POSLN
  LOFORMSET.POSLN.SETORDER('POSHREC') &&Sql110: Check Tag ;
  *SHIPNO+CRSESSION+CBUSDOCU+CSTYTYPE+PO+CINVTYPE+STYLE+STR(LINENO,6)+TRANCD ;
  (SHIPNO+CRSESSION+CSTYTYPE+PO+STYLE+STR(LINENO,6)+TRANCD)
  IF LOFORMSET.LLBROWSE OR (!EMPTY(LOAUTOFORM.KBRSESSION.KEYTEXTBOX.VALUE) AND ;
      !LOFORMSET.POSLN.SEEK(LCTICKET+LOAUTOFORM.KBRSESSION.KEYTEXTBOX.VALUE)) &&Sql111: Check Key
    LCSQLSTATEMENT = "SELECT * FROM POSLN (INDEX=POSHREC) WHERE SHIPNO='"+LCTICKET+"'"
    LNRESULT=OARIAAPPLICATION.REMOTECOMPANYDATA.SQLRUN(LCSQLSTATEMENT,'RcvSess','POSLN',;
      OARIAAPPLICATION.ACTIVECOMPANYCONSTR,3,'SAVE',LOFORMSET.DATASESSIONID)
    IF LNRESULT<1
      OARIAAPPLICATION.REMOTECOMPANYDATA.CHECKRETRESULT("execute",LNRESULT,.T.)
      IF !EMPTY(LCALIAS)
        SELECT (LCALIAS)
      ENDIF
      *AIT WINDOW LINENO()
      RETURN .F.
    ENDIF
    SELECT CRSESSION ,DATE ,SUM(TOTQTY) AS NRECQTY, SUM(TOTQTY*NFLANCOST&LCCSTTYPE) AS NRECAMNT ;
      FROM RCVSESS WHERE !EMPTY(CRSESSION) AND CINVTYPE+STYLE=IIF(EMPTY(LCITEM),'','0001'+ALLTRIM(LCITEM)) ;
      GROUP BY SHIPNO,CRSESSION INTO DBF (OARIAAPPLICATION.WORKDIR+LCRCVSESS)  &&Sql112: Must use SqlRun
    USE IN RCVSESS

    LOFORMSET.LLBROWSE = .T.
    LOAUTOFORM.KBRSESSION.SELECTEDFROMBROWSE = .T.
  ENDIF
  *Old: SET ORDER TO TAG PosLn IN POSLN
  LOFORMSET.POSLN.SETORDER('POSLN') &&Sql113: Check Tag ;
  *CBUSDOCU+CSTYTYPE+PO+CINVTYPE+STYLE+STR(LINENO,6)+TRANCD ;
  (CSTYTYPE+PO+STYLE+STR(LINENO,6)+TRANCD)
CASE LCTYPE='M'
  *Old: SET ORDER TO TAG Cutrec IN CutTktL
  LOFORMSET.CUTTKTL.SETORDER('POSREC') &&Sql114: Check Tag ;
  *CBUSDOCU+CSTYTYPE+PO+CRSESSION+SHIPNO+CINVTYPE+STYLE+STR(LINENO,6)+TRANCD+CSTYGRADE ;
  (CRSESSION+CUTTKT+STYLE+TRANCD)
  IF LOFORMSET.LLBROWSE OR (!EMPTY(LOAUTOFORM.KBRSESSION.KEYTEXTBOX.VALUE) AND ;
      !LOFORMSET.CUTTKTL.SEEK('PU'+LCTICKET+LOAUTOFORM.KBRSESSION.KEYTEXTBOX.VALUE+;
      IIF(EMPTY(LCITEM),'','0001'+ALLTRIM(LCITEM))))    &&Sql115: Check Key
    LCSQLSTATEMENT = "SELECT * FROM POSLN (INDEX=POSREC) WHERE "+;
      "CBUSDOCU='P' AND CSTYTYPE='U'"+;
      "AND PO='"+LCTICKET+"'"
    LNRESULT=OARIAAPPLICATION.REMOTECOMPANYDATA.SQLRUN(LCSQLSTATEMENT,'RcvSess','POSLN',;
      OARIAAPPLICATION.ACTIVECOMPANYCONSTR,3,'SAVE',LOFORMSET.DATASESSIONID)
    IF LNRESULT<1
      OARIAAPPLICATION.REMOTECOMPANYDATA.CHECKRETRESULT("execute",LNRESULT,.T.)
      IF !EMPTY(LCALIAS)
        SELECT (LCALIAS)
      ENDIF
      *AIT WINDOW LINENO()
      RETURN .F.
    ENDIF

    SELECT CRSESSION, DATE, SUM(TOTQTY) AS NRECQTY, SUM(TOTQTY*NICOST&LCCSTTYPE) AS NRECAMNT ;
      FROM RCVSESS  WHERE !EMPTY(CRSESSION) AND CINVTYPE+STYLE=IIF(EMPTY(LCITEM),'','0001'+ALLTRIM(LCITEM)) ;
      GROUP BY PO,CRSESSION INTO DBF (OARIAAPPLICATION.WORKDIR+LCRCVSESS)  &&Sql116: Must use SqlRun
    USE IN RCVSESS
    LOFORMSET.LLBROWSE = .T.
    LOAUTOFORM.KBRSESSION.SELECTEDFROMBROWSE = .T.
  ENDIF
  *Old: SET ORDER TO TAG CutTktL IN CutTktL
  LOFORMSET.CUTTKTL.SETORDER('POSREC') &&Sql117: Check Tag ;
  *CBUSDOCU+CSTYTYPE+PO+CRSESSION+SHIPNO+CINVTYPE+STYLE+STR(LINENO,6)+TRANCD+CSTYGRADE ;
  (CUTTKT+STYLE+DYELOT+TRANCD)
CASE INLIST(LCTYPE,'L','F')
  SELECT POFLN
  *Old: SET ORDER TO TAG POFREC
  LOFORMSET.POFLN.SETORDER('POSREC') &&Sql118: Check Tag ;
  *CBUSDOCU+CSTYTYPE+PO+CRSESSION+SHIPNO+CINVTYPE+STYLE+STR(LINENO,6)+TRANCD+CSTYGRADE ;
  (CMATTYPE+POMAT+CRSESSION+FABRIC+COLOR+TRANCD)
  LCTEMP = IIF(LCTYPE='L','PM','RM')
  IF LOFORMSET.LLBROWSE OR (!EMPTY(LOAUTOFORM.KBRSESSION.KEYTEXTBOX.VALUE) AND ;
      !LOFORMSET.POFLN.SEEK(LCTEMP+LCTICKET+LOAUTOFORM.KBRSESSION.KEYTEXTBOX.VALUE+;
      IIF(EMPTY(LCITEM),'','0002'+LFUPDITEM(SUBSTR(LCITEM,1,LOFORMSET.LNFABMAJLEN),LCCOLOR)))) &&Sql119: Check Key
    LCSQLSTATEMENT = "SELECT * FROM POSLN (INDEX=POSREC) WHERE "+;
      "CBUSDOCU='"+LEFT(LCTEMP,1)+"' AND CSTYTYPE='"+RIGHT(LCTEMP,1)+"' "+;
      "AND PO='"+LCTICKET+"'"
    LNRESULT=OARIAAPPLICATION.REMOTECOMPANYDATA.SQLRUN(LCSQLSTATEMENT,'RcvSess','POSLN',;
      OARIAAPPLICATION.ACTIVECOMPANYCONSTR,3,'SAVE',LOFORMSET.DATASESSIONID)
    IF LNRESULT<1
      OARIAAPPLICATION.REMOTECOMPANYDATA.CHECKRETRESULT("execute",LNRESULT,.T.)
      IF !EMPTY(LCALIAS)
        SELECT (LCALIAS)
      ENDIF
      *AIT WINDOW LINENO()
      RETURN .F.
    ENDIF

    SELECT CRSESSION,DATE,SUM(TOTQTY) AS NRECQTY, SUM(TOTQTY*NFLANCOST&LCCSTTYPE) AS NRECAMNT;
      FROM RCVSESS WHERE !EMPTY(CRSESSION) AND CINVTYPE+STYLE=IIF(EMPTY(LCITEM),'','0002'+LFUPDITEM(SUBSTR(LCITEM,1,LOFORMSET.LNFABMAJLEN),LCCOLOR)) ;
      GROUP BY PO,CRSESSION INTO DBF (OARIAAPPLICATION.WORKDIR+LCRCVSESS)  &&Sql120: Must use SqlRun
    USE IN RCVSESS
    LOFORMSET.LLBROWSE = .T.
    LOAUTOFORM.KBRSESSION.SELECTEDFROMBROWSE = .T.
  ENDIF
CASE LCTYPE='T'
  *Fix the contribution process  to save the invoice [Begin]
  SELECT MMFGORDD
  *SET ORDER TO TAG MMFGORDD
  LOFORMSET.MMFGORDD.SETORDER('POSLN') &&Sql121: Check Tag ;
  *CBUSDOCU+CSTYTYPE+PO+CINVTYPE+STYLE+STR(LINENO,6)+TRANCD ;
  (CMFGORDNO+CFABRIC+COLOR+DYELOT+TRANCD)
  IF LOFORMSET.LLBROWSE OR (!EMPTY(LOAUTOFORM.KBRSESSION.KEYTEXTBOX.VALUE) AND ;
      !LOFORMSET.MMFGORDD.SEEK('PF'+LCTICKET+LOAUTOFORM.KBRSESSION.KEYTEXTBOX.VALUE+IIF(EMPTY(LCITEM),'','0002'+LFUPDITEM(SUBSTR(LCITEM,1,LOFORMSET.LNFABMAJLEN),LCCOLOR))))  &&Sql122: Check Key
    LCSQLSTATEMENT = "SELECT * FROM POSLN (INDEX=POSREC) WHERE "+;
      "CBUSDOCU='P' AND CSTYTYPE='F' "+;
      "AND PO='"+LCTICKET+"'"
    LNRESULT=OARIAAPPLICATION.REMOTECOMPANYDATA.SQLRUN(LCSQLSTATEMENT,'RcvSess','POSLN',;
      OARIAAPPLICATION.ACTIVECOMPANYCONSTR,3,'SAVE',LOFORMSET.DATASESSIONID)
    IF LNRESULT<1
      OARIAAPPLICATION.REMOTECOMPANYDATA.CHECKRETRESULT("execute",LNRESULT,.T.)
      IF !EMPTY(LCALIAS)
        SELECT (LCALIAS)
      ENDIF
      *AIT WINDOW LINENO()
      RETURN .F.
    ENDIF
    *! B610111,1 MMT 10/11/2012 Modify Payable invoice screen to handle MFG order case[Start]
    *    SELECT CRSESSION,DRECVDATE AS DATE,SUM(TOTQTY) AS NRECQTY,;
    SUM(TOTQTY*NLAN_COST&LCCSTTYPE) AS NRECAMNT;
    FROM RCVSESS WHERE !EMPTY(CRSESSION) AND ;
    CINVTYPE+STYLE=IIF(EMPTY(LCITEM),'','0002'+LFUPDITEM(SUBSTR(LCITEM,1,LOFORMSET.LNFABMAJLEN),LCCOLOR)) ;
    GROUP BY CRSESSION INTO DBF (OARIAAPPLICATION.WORKDIR+LCRCVSESS)  &&Sql123: Must use SqlRun
    SELECT CRSESSION,DATE,SUM(TOTQTY) AS NRECQTY,;
      SUM(TOTQTY*NLAN_COST&LCCSTTYPE) AS NRECAMNT;
      FROM RCVSESS WHERE !EMPTY(CRSESSION) AND ;
      CINVTYPE+STYLE=IIF(EMPTY(LCITEM),'','0002'+LFUPDITEM(SUBSTR(LCITEM,1,LOFORMSET.LNFABMAJLEN),LCCOLOR)) ;
      GROUP BY CRSESSION INTO DBF (OARIAAPPLICATION.WORKDIR+LCRCVSESS)  &&Sql123: Must use SqlRun
    *! B610111,1 MMT 10/11/2012 Modify Payable invoice screen to handle MFG order case[End]
    USE IN RCVSESS
    LOFORMSET.LLBROWSE = .T.
    LOAUTOFORM.KBRSESSION.SELECTEDFROMBROWSE = .T.
  ENDIF
ENDCASE
IF LOFORMSET.LLBROWSE
  IF LLCLRREAD
    CLEAR READ
    RETURN
  ENDIF

  *Fix bug when Saving the debit memo againest Return PO [BEGIN]
  *ASM, Checking if there is no records to display [Start]
  IF EOF()
    LOAUTOFORM.KBRSESSION.KEYTEXTBOX.VALUE=SPACE(LEN(CRSESSION))
    =GFMODALGEN('TRM38180B00000','DIALOG')
    LLRETVAL = .F.
  ELSE
    *N000682,1 MMT 11/22/2012 Globalization changes[Start]
    *LCFILE_TTL = IIF(LCTYPE$'RF','Issuing Sessions','Receiving Sessions')
    *IF LCTYPE $ 'RF'
    *  LCBRFIELDS = [cRSession :R:H = "Session#", Date :R:H = "Date", nRecQty :R:H = "Iss. Qty", nRecAmnt :R:H = "Iss. Amount"]
    *ELSE
    *  LCBRFIELDS = [cRSession :R:H = "Session#", Date :R:H = "Date", nRecQty :R:H = "Rcv. Qty", nRecAmnt :R:H = "Rcv. Amount"]
    *ENDIF
    *N000682,1 11/20/2012 MMT Globlization changes[Start]
*LCFILE_TTL = IIF(LCTYPE$'RF',LANG_ISSUESESSION,LANG_RECVSESSION)
LCFILE_TTL = IIF(LCTYPE$'RF',IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_ISSUESESSION,loFormSet.GetHeaderText("LANG_ISSUESESSION",loFormSet.HeaderAlias)),IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_RECVSESSION,loFormSet.GetHeaderText("LANG_RECVSESSION",loFormSet.HeaderAlias)))
*N000682,1 11/20/2012 MMT Globlization changes[End]

    IF LCTYPE $ 'RF'
      *N000682,1 11/20/2012 MMT Globlization changes[Start]
*LCBRFIELDS = [cRSession :R:H = "]+LANG_SEESION_NO+[", Date :R:H = "]+LANG_DATE+[", nRecQty :R:H = "]+LANG_ISSUEQTY+[", nRecAmnt :R:H = "]+LANG_ISSUEAMOUNT+["]
LCBRFIELDS = [cRSession :R:H = "]+IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_SEESION_NO,loFormSet.GetHeaderText("LANG_SEESION_NO",loFormSet.HeaderAlias))+[", Date :R:H = "]+IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_DATE,loFormSet.GetHeaderText("LANG_DATE",loFormSet.HeaderAlias))+[", nRecQty :R:H = "]+IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_ISSUEQTY,loFormSet.GetHeaderText("LANG_ISSUEQTY",loFormSet.HeaderAlias))+[", nRecAmnt :R:H = "]+IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_ISSUEAMOUNT,loFormSet.GetHeaderText("LANG_ISSUEAMOUNT",loFormSet.HeaderAlias))+["]
*N000682,1 11/20/2012 MMT Globlization changes[End]

    ELSE
      *N000682,1 11/20/2012 MMT Globlization changes[Start]
*LCBRFIELDS = [cRSession :R:H = "]+LANG_SEESION_NO+[", Date :R:H = "]+LANG_DATE+[", nRecQty :R:H = "]+LANG_RCVQTY+[", nRecAmnt :R:H = "]+LANG_RCVAMOUNT+["]
LCBRFIELDS = [cRSession :R:H = "]+IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_SEESION_NO,loFormSet.GetHeaderText("LANG_SEESION_NO",loFormSet.HeaderAlias))+[", Date :R:H = "]+IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_DATE,loFormSet.GetHeaderText("LANG_DATE",loFormSet.HeaderAlias))+[", nRecQty :R:H = "]+IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_RCVQTY,loFormSet.GetHeaderText("LANG_RCVQTY",loFormSet.HeaderAlias))+[", nRecAmnt :R:H = "]+IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_RCVAMOUNT,loFormSet.GetHeaderText("LANG_RCVAMOUNT",loFormSet.HeaderAlias))+["]
*N000682,1 11/20/2012 MMT Globlization changes[End]

    ENDIF
    *N000682,1 MMT 11/22/2012 Globalization changes[END]
    LOAUTOFORM.KBRSESSION.KEYTEXTBOX.VALUE = ;
      IIF(ARIABROW('',LCFILE_TTL,GNBRHSROW1,GNBRHSCOL1,GNBRHSROW2,GNBRHSCOL2,'','','cRSession',;
      'laBrowArr'),CRSESSION,SPACE(6))
  ENDIF
  *ASM, Checking if there is no records to display [End]
  *Fix bug when Saving the debit memo againest Return PO [END]

  IF USED(LCRCVSESS)
    USE IN (LCRCVSESS)
    ERASE (OARIAAPPLICATION.WORKDIR+LCRCVSESS)
  ENDIF

ENDIF

IF !EMPTY(LCALIAS)
  SELECT (LCALIAS)
ENDIF

LOFORMSET.LLBROWSE = .F.
LOAUTOFORM.KBRSESSION.SELECTEDFROMBROWSE = .F.
*Get the correct WIP account with shipment ticket [Begin]
IF LCTYPE = 'S' AND !LLCLRREAD
  LCLINKCODN = IIF(EMPTY(LCTICKET),SPACE(6),LFGETGLLNK(LCTICKET,'',LOAUTOFORM.KBRSESSION.KEYTEXTBOX.VALUE))
  LCLINKCODE = SUBSTR(LCLINKCODN,1,6)
  IF VAL(SUBSTR(LCLINKCODN,7)) > 1
    *N000682,1 MMT 11/22/2012 Globalization changes[Start]
    *LCMASSE = IIF(EMPTY(LOAUTOFORM.KBRSESSION.KEYTEXTBOX.VALUE),"This shipment","This receiving session")
    *LCMASSE = LCMASSE + " has more than one WIP account."+;
      " Would you like to keep the PO's using their default WIP accounts, or assign one WIP account for all PO's? "
    *N000682,1 11/20/2012 MMT Globlization changes[Start]
*LCMASSE = IIF(EMPTY(LOAUTOFORM.KBRSESSION.KEYTEXTBOX.VALUE),LANG_THISSHPMENT,LANG_THISRECEIVINGSESSION)
LCMASSE = IIF(EMPTY(LOAUTOFORM.KBRSESSION.KEYTEXTBOX.VALUE),IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_THISSHPMENT,loFormSet.GetHeaderText("LANG_THISSHPMENT",loFormSet.HeaderAlias)),IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_THISRECEIVINGSESSION,loFormSet.GetHeaderText("LANG_THISRECEIVINGSESSION",loFormSet.HeaderAlias)))
*N000682,1 11/20/2012 MMT Globlization changes[End]

    LCMASSE = LCMASSE + IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_HASMOREWIPACCOUNT,loFormSet.GetHeaderText("LANG_HASMOREWIPACCOUNT",loFormSet.HeaderAlias))+;
IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_WOULDLIKETOKEEPPOS,loFormSet.GetHeaderText("LANG_WOULDLIKETOKEEPPOS",loFormSet.HeaderAlias))


    *N000682,1 MMT 11/22/2012 Globalization changes[end]
    IF GFMODALGEN("TRM00000B04013","DIALOG",.F.,.F.,LCMASSE ) = 1
      LCOLDALIAS = ALIAS()
      *STORE '' TO loAutoForm.glApDGlAct.KeyTextBox.Value,loAutoForm.lcWIPAcnt
      STORE '' TO LOFORMSET.LCAPDGLACT,LOAUTOFORM.LCWIPACNT
      SELECT (LOFORMSET.LCAPVINVDT)
      REPLACE CAPDGLACT WITH ''
      *Old: SHOW GET ibWIPAcnt   DISABLE &&Revise
      *Old: SHOW GET loAutoForm.glApDGlAct.KeyTextBox.Value  DISABLE &&Revise
      *Old: SHOW GET m.cApDGlAct DISABLE &&Revise
      STORE .F. TO LOAUTOFORM.GLAPDGLACT.ENABLED, LOFORM.GLAPDGLACT.ENABLED
    ENDIF
  ELSE
    IF !SEEK(LCLINKCODE+'013','GL_LINK')
      =SEEK('DEFDEF'+'013','GL_LINK')
    ENDIF
    *STORE GL_Link.GlAcnt TO loAutoForm.glApDGlAct.KeyTextBox.Value,loAutoForm.lcWIPAcnt
    IF TYPE('loAutoForm.lcWIPAcnt')<>'U'
      STORE GL_LINK.GLACNT TO LOFORMSET.LCAPDGLACT,LOAUTOFORM.LCWIPACNT
    ELSE
      STORE GL_LINK.GLACNT TO LOFORMSET.LCAPDGLACT
    ENDIF
    *Old: SHOW GET loAutoForm.glApDGlAct.KeyTextBox.Value &&Revise
  ENDIF
ENDIF
*Get the correct WIP account with shipment ticket [end]

RETURN LLRETVAL
*-- End of lfvRSession


*!*************************************************************
*! Name      : lfvAutoGen
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 09/12/2004
*! Purpose   : Select Document Lines to Invoice. Called from the Click event
*!             of the Generate Button in APAINVD.SCX
*!*************************************************************
*! Parameters: The FormSet of APPYINV.SCX, The Form of APINVDT.SCX, The Form of APAINVD.SCX
*!*************************************************************
*! Returns   :  None
*!*************************************************************
FUNCTION LFVAUTOGEN
LPARAMETERS LOFORMSET, LOFORM, LOAUTOFORM

*Check only when costing type is MFG Codes
IF LOAUTOFORM.LAAPLCST[loAutoForm.cboCostType.Value,3] = 'M'
  DIMENSION LAMFGRFLD[ALEN(loFormSet.laMfgRFld,1),ALEN(loFormSet.laMfgRFld,2)]
  =ACOPY(LOFORMSET.LAMFGRFLD,LAMFGRFLD)
  =GFRLTFLD(LOAUTOFORM.LCMFGCODE,@LAMFGRFLD,'MFGCODE')
  =ACOPY(LAMFGRFLD,LOFORMSET.LAMFGRFLD)
  IF !EMPTY(LOFORMSET.LCMFGGLACNT)
    *Message : 04152
    *MFG Code has been setup to be applied directly through the
    *cost sheet program
    *Button : 00000
    *Ok
    =GFMODALGEN("TRM04152B00000","DIALOG",LOFORMSET.LAMFGCODE[loAutoForm.cboMFGOpr.Value,1])
    RETURN
  ENDIF
ENDIF
=LFGENINVLN(LOFORMSET,LOFORM,LOAUTOFORM.LATICKETS[loAutoForm.cboTktType.Value,2],;
  LOAUTOFORM.KBINVTKTNO.KEYTEXTBOX.VALUE,LOAUTOFORM.LCMFGCODE,LOAUTOFORM.LCAPLLOTNO,;
  LOAUTOFORM.KBRSESSION.KEYTEXTBOX.VALUE,;
  LOAUTOFORM.LAAPLCST[loAutoForm.cboCostType.Value,2],'','','',.T.)
SELECT (LOFORMSET.LCAUTOINV)
IF EOF()
ELSE
  *Old: SHOW GETS WINDOW 'APAINVD0' DISABLE &&Revise
  *Old: SHOW GET ibAInvDet ENABLE &&Revise
  *Old: SHOW GET pbClear   ENABLE &&Revise
  *Old: SHOW GETS WINDOW 'APAINVD2' ENABLE &&Revise
  *Old: SHOW GET pbSelAll DISABLE &&Revise
  WITH LOAUTOFORM
    STORE .F. TO .CBOTKTTYPE.ENABLED, .KBINVTKTNO.ENABLED, .CBOCOSTTYPE.ENABLED, ;
      .CBOMFGOPR.ENABLED, .KBRSESSION.ENABLED, .CBOLOTNO.ENABLED, .GLAPDGLACT.ENABLED, ;
      .CMDGENERATE.ENABLED, .CMDCLEAR.ENABLED
    .CMDCLEAR.ENABLED = .T.
    STORE .T. TO .CMDSELECT.ENABLED , .CMDSELALL.ENABLED, .CMDSELNONE.ENABLED, ;
      .CMDINVERT.ENABLED, .CMDPROCEED.ENABLED, .CMDCLOSE.ENABLED
    .CMDSELALL.ENABLED = .F.
  ENDWITH
  =LFAINVBROW(LOFORMSET, LOFORM, LOAUTOFORM)
ENDIF
=LFWAINVDT(LOFORMSET, LOFORM, LOAUTOFORM)

*! C201079,1 MMT 12/02/2008 Add disribution button to Ap invoice screen[Start]
IF ASCAN(LOFORMSET.LAEVNTTRIG,PADR('REFDISTBUT',10),1,ALEN(LOFORMSET.LAEVNTTRIG,1),1) > 0
  LOFORMAUTO = LOAUTOFORM
  LOFORMSET.MDOTRIGGER(PADR('REFDISTBUT',10))
ENDIF
*! C201079,1 MMT 12/02/2008 Add disribution button to Ap invoice screen[End]


RETURN
*-- End of lfvAutoGen


*!*************************************************************
*! Name      : lfClrInvLn
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 09/12/2004
*! Purpose   : Clear Selected Document Lines. Called from the Click event
*!             of the Clear Button in APAINVD.SCX
*!*************************************************************
*! Parameters: The FormSet of APPYINV.SCX, The Form of APINVDT.SCX, The Form of APAINVD.SCX
*!*************************************************************
*! Returns   :  None
*!*************************************************************
FUNCTION  LFCLRINVLN
*N000682,1 MMT 12/09/2012 Globalization changes[Start]
*LPARAMETERS LOFORMSET, LOFORM, LOAUTOFORM
PARAMETERS LOFORMSET, LOFORM, LOAUTOFORM
*N000682,1 MMT 12/09/2012 Globalization changes[end]
DECLARE LOAUTOFORM.LAAPLCST[1,3],LOAUTOFORM.LATICKETS[1,3],LOAUTOFORM.LAAPLLOTS[1]
STORE 0         TO LOAUTOFORM.CBOLOTNO.VALUE
STORE SPACE(24) TO LOAUTOFORM.GLAPDGLACT.KEYTEXTBOX.VALUE
STORE SPACE(6)  TO LOAUTOFORM.KBINVTKTNO.KEYTEXTBOX.VALUE
STORE 1         TO LOAUTOFORM.CBOTKTTYPE.VALUE,LOAUTOFORM.CBOCOSTTYPE.VALUE
STORE ''        TO LOAUTOFORM.LCMFGCODE,LOAUTOFORM.KBRSESSION.KEYTEXTBOX.VALUE
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*STORE 'N/A'     TO loForm.laOprLots[1]
*N000682,1 MMT 12/09/2012 Globalization changes[Start]
*STORE 'N/A'     TO LOFORMSET.LAOPRLOTS[1]
STORE IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_NOTAPPLICABLE,loformset.GetHeaderText("LANG_APPYINV_NOTAPPLICABLE",loformset.HeaderAlias))  TO LOFORMSET.LAOPRLOTS[1]
*N000682,1 MMT 12/09/2012 Globalization changes[End]
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
STORE SPACE(2)  TO LOAUTOFORM.LCAPLLOTNO
*N000682,1 MMT 11/22/2012 Globalization changes[Start]
*LOAUTOFORM.LATICKETS[1,1] = 'Select Document Type'
*N000682,1 11/20/2012 MMT Globlization changes[Start]
*LOAUTOFORM.LATICKETS[1,1] = LANG_APPYINV_SELECTDOCTYPE
LOAUTOFORM.LATICKETS[1,1] = IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_SELECTDOCTYPE,loFormSet.GetHeaderText("LANG_APPYINV_SELECTDOCTYPE",loFormSet.HeaderAlias))
*N000682,1 11/20/2012 MMT Globlization changes[End]

*N000682,1 MMT 11/22/2012 Globalization changes[END]
LOAUTOFORM.LATICKETS[1,2] = ' '
*N000682,1 MMT 11/22/2012 Globalization changes[Start]
*LOAUTOFORM.LATICKETS[1,3] = 'Document#'
*LOAUTOFORM.LAAPLCST[1,1]  = 'Select Cost Type'
*N000682,1 11/20/2012 MMT Globlization changes[Start]
*LOAUTOFORM.LATICKETS[1,3] = LANG_APPYINV_DOCNO
LOAUTOFORM.LATICKETS[1,3] = IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_DOCNO,loFormSet.GetHeaderText("LANG_APPYINV_DOCNO",loFormSet.HeaderAlias))
*N000682,1 11/20/2012 MMT Globlization changes[End]

*N000682,1 11/20/2012 MMT Globlization changes[Start]
*LOAUTOFORM.LAAPLCST[1,1]  = LANG_APPYINV_SELCOSTTYPE
LOAUTOFORM.LAAPLCST[1,1]  = IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_SELCOSTTYPE,loFormSet.GetHeaderText("LANG_APPYINV_SELCOSTTYPE",loFormSet.HeaderAlias))
*N000682,1 11/20/2012 MMT Globlization changes[End]

*N000682,1 MMT 11/22/2012 Globalization changes[END]
LOAUTOFORM.LAAPLCST[1,2]  = ' '
LOAUTOFORM.LAAPLCST[1,3]  = ' '

SELECT (LOFORMSET.LCAUTOINV)
ZAP
=LFAINVBROW(LOFORMSET, LOFORM, LOAUTOFORM)
*=lfRefresh('APAINVD0')
*Old: SHOW GETS WINDOW 'APAINVD0' DISABLE ONLY &&Revise
*Old: SHOW GETS WINDOW 'APAINVD2' DISABLE ONLY &&Revise
*Old: SHOW GET ibAInvDet  ENABLE &&Revise
WITH LOAUTOFORM
  STORE .F. TO .CBOTKTTYPE.ENABLED, .KBINVTKTNO.ENABLED, .CBOCOSTTYPE.ENABLED, ;
    .CBOMFGOPR.ENABLED, .KBRSESSION.ENABLED, .CBOLOTNO.ENABLED, .GLAPDGLACT.ENABLED, ;
    .CMDGENERATE.ENABLED, .CMDCLEAR.ENABLED
  STORE .F. TO .CMDSELECT.ENABLED, .CMDSELALL.ENABLED, .CMDSELNONE.ENABLED, .CMDINVERT.ENABLED, ;
    .CMDPROCEED.ENABLED, .CMDCLOSE.ENABLED
ENDWITH
*Old: SHOW GET loAutoForm.cboTktType.Value   ENABLE  &&Revise
*Old: SHOW GET pbCancel   ENABLE &&Revise
STORE .T. TO LOAUTOFORM.CBOTKTTYPE.ENABLED, LOAUTOFORM.CMDCLOSE.ENABLED
DIMENSION LACODES[ALEN(loFormSet.laCodes,1),ALEN(loFormSet.laCodes,2)]
=ACOPY(LOFORMSET.LACODES,LACODES)
=GFWCODEPOP(@LACODES,'MFGCODE','N')
=ACOPY(LACODES,LOFORMSET.LACODES)
*_CUROBJ = OBJNUM(ibAInvDet)&&Old CurObj

*! C201079,1 MMT 12/02/2008 Add disribution button to Ap invoice screen[Start]
IF ASCAN(LOFORMSET.LAEVNTTRIG,PADR('REFDISTBUT',10),1,ALEN(LOFORMSET.LAEVNTTRIG,1),1) > 0
  LOFORMAUTO = LOAUTOFORM
  LOFORMSET.MDOTRIGGER(PADR('REFDISTBUT',10))
ENDIF
*! C201079,1 MMT 12/02/2008 Add disribution button to Ap invoice screen[End]


RETURN
*-- End of lfClrInvLn


*!*************************************************************
*! Name      : lfvSelect
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 09/12/2004
*! Purpose   : Select Some Ticket line to Invoice. Called from the Click event
*!             of the Select Button(s) in APAINVD.SCX
*!*************************************************************
*! Parameters: The FormSet of APPYINV.SCX, The Form of APINVDT.SCX, The Form of APAINVD.SCX,
*!                       lcType  : 'S' : Select/UnSelect
*!                               : 'A' : Select All
*!                               : 'N' : Select None
*!                               : 'V' : Invert
*!*************************************************************
*! Returns   :  None
*!*************************************************************
FUNCTION LFVSELECT
LPARAMETERS LOFORMSET, LOFORM, LOAUTOFORM, LCTYPE
PRIVATE LCDATASEL,LCDATAUSEL,LCDATA,CKEY

LCKEY=ITEM+CWARECODE+CDYELOT
DO CASE
CASE LCTYPE = 'S'
  *Do not edit any invoices which have a closed PO in case of Auto Contr.
  IF !(LOAUTOFORM.LATICKETS[loAutoForm.cboTktType.Value,2] = "S"  .AND. LOFORMSET.POSHDR.SEEK("PP"+CTKTNO) .AND. POSHDR.STATUS = "S") &&Sql124: Check Key
    REPLACE CSELECT WITH IIF(CSELECT=SPACE(1),"",SPACE(1))
  ENDIF
CASE LCTYPE = 'A'
  *Do not edit any invoices which have a closed PO in case of Auto Contr.
  REPLACE ALL CSELECT WITH IIF(!(LOAUTOFORM.LATICKETS[loAutoForm.cboTktType.Value,2] = "S"  .AND. LOFORMSET.POSHDR.SEEK("PP"+CTKTNO) .AND. POSHDR.STATUS = "S"),"","") &&Sql125: Check Key
CASE LCTYPE = 'N'
  REPLACE ALL CSELECT WITH SPACE(1)
CASE LCTYPE = 'V'
  REPLACE ALL CSELECT WITH IIF(CSELECT=SPACE(1) .AND. !(LOAUTOFORM.LATICKETS[loAutoForm.cboTktType.Value,2] = "S"  .AND. LOFORMSET.POSHDR.SEEK("PP"+CTKTNO) .AND. POSHDR.STATUS = "S"),"",SPACE(1)) &&S
ENDCASE
SET ORDER TO TAG 'SELECT'
LCDATASEL   = IIF(SEEK(""),'ENABLE','DISABLE')
LCDATAUSEL  = IIF(SEEK(' '),'ENABLE','DISABLE')
SET ORDER TO TAG (LOFORMSET.LCAUTOINV)
=SEEK(LCKEY)
LCDATA  = IIF(EOF(),'DISABLE','ENABLE')
*Old: SHOW GET pbSelAll  &lcDataUSel &&Revise
*Old: SHOW GET pbSelNone &lcDataSel &&Revise
*Old: SHOW GET pbInvert  &lcData &&Revise
*Old: SHOW GET pbProceed &lcDataSel &&Revise
LOAUTOFORM.CMDSELALL.ENABLED=(LCDATAUSEL='ENABLE')
LOAUTOFORM.CMDSELNONE.ENABLED=(LCDATASEL='ENABLE')
LOAUTOFORM.CMDINVERT.ENABLED=(LCDATA='ENABLE')
LOAUTOFORM.CMDPROCEED.ENABLED=(LCDATASEL='ENABLE')

IF CSELECT = SPACE(1)
  *Old: SHOW GET pbSelect,1 PROMPT '\<Select' &lcData &&Revise
  *N000682,1 MMT 11/20/2012 Globalization Changes[Start]
  *  LOAUTOFORM.CMDSELECT.CAPTION='\<Select'
  *N000682,1 11/20/2012 MMT Globlization changes[Start]
*LOAUTOFORM.CMDSELECT.CAPTION=LANG_APPYINV_SELECT
LOAUTOFORM.CMDSELECT.CAPTION=IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_SELECT,loFormSet.GetHeaderText("LANG_APPYINV_SELECT",loFormSet.HeaderAlias))
*N000682,1 11/20/2012 MMT Globlization changes[End]

  *N000682,1 MMT 11/20/2012 Globalization Changes[End]

  LOAUTOFORM.CMDSELECT.ENABLED=(LCDATA='ENABLE')
ELSE
  *Old: SHOW GET pbSelect,1 PROMPT 'Un\<Select' &lcData &&Revise
  *N000682,1 MMT 11/20/2012 Globalization Changes[Start]
  *  LOAUTOFORM.CMDSELECT.CAPTION='Un\<Select'
  *N000682,1 11/20/2012 MMT Globlization changes[Start]
*LOAUTOFORM.CMDSELECT.CAPTION=LANG_APPYINV_UNSELECT
LOAUTOFORM.CMDSELECT.CAPTION=IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_UNSELECT,loFormSet.GetHeaderText("LANG_APPYINV_UNSELECT",loFormSet.HeaderAlias))
*N000682,1 11/20/2012 MMT Globlization changes[End]

  *N000682,1 MMT 11/20/2012 Globalization Changes[End]

  LOAUTOFORM.CMDSELECT.ENABLED=(LCDATA='ENABLE')
ENDIF

*! C201079,1 MMT 12/02/2008 Add disribution button to Ap invoice screen[Start]
IF ASCAN(LOFORMSET.LAEVNTTRIG,PADR('REFDISTBUT',10),1,ALEN(LOFORMSET.LAEVNTTRIG,1),1) > 0
  LOFORMAUTO = LOAUTOFORM
  LOFORMSET.MDOTRIGGER(PADR('REFDISTBUT',10))
ENDIF
*! C201079,1 MMT 12/02/2008 Add disribution button to Ap invoice screen[End]


RETURN
*-- End of lfvSelect


*!*************************************************************
*! Name      : lfvProAuto
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 09/12/2004
*! Purpose   : Create Invoice Lines Automatically. Called from the Click event
*!             of the Proceed Button in APAINVD.SCX
*!*************************************************************
*! Parameters: The FormSet of APPYINV.SCX, The Form of APINVDT.SCX, The Form of APAINVD.SCX
*!*************************************************************
*! Returns   :  None
*!*************************************************************
FUNCTION LFVPROAUTO
LPARAMETERS LOFORMSET, LOFORM, LOAUTOFORM

PRIVATE LCITEM , LCWIPACCT

SET ORDER TO TAG ITEM IN (LOFORMSET.LCAPVINVDT)
SELECT (LOFORMSET.LCAUTOINV)
SET ORDER TO TAG 'SELECT'
=SEEK("")

*Get the Max. line from invoicetkt  [Start]
*laData[52] = lfGetMaxLin()
*Get the Max. line invoicetkt [End]
SCAN REST WHILE CSELECT+ITEM+CWARECODE+CDYELOT = ""
  LCITEM = IIF(INLIST(LOAUTOFORM.LATICKETS[loAutoForm.cboTktType.Value,2],'L','T','F'),PADR(SUBSTR(ITEM,1,LOFORMSET.LNFABMAJLEN),19),ITEM)
  SELECT (LOFORMSET.LCAPVINVDT)
  *Initiale lcWipAcct.[Start]
  LCWIPACCT = IIF(  LOAUTOFORM.LATICKETS[loAutoForm.cboTktType.Value,2]= 'S'  ,EVALUATE(LOFORMSET.LCAUTOINV+'.cWIPAcct') , LOAUTOFORM.GLAPDGLACT.KEYTEXTBOX.VALUE)
  *Initiale lcWipAcct.[END]
  IF !SEEK(LOAUTOFORM.LATICKETS[loAutoForm.cboTktType.Value,2]+LOAUTOFORM.KBINVTKTNO.KEYTEXTBOX.VALUE+LOAUTOFORM.LCAPLLOTNO+STR(EVALUATE(LOFORMSET.LCAUTOINV+'.LineNo'),6)+;
      LOAUTOFORM.LAAPLCST[loAutoForm.cboCostType.Value,2]+LOAUTOFORM.LCMFGCODE+LCITEM+EVALUATE(LOFORMSET.LCAUTOINV+'.Color')+EVALUATE(LOFORMSET.LCAUTOINV+'.cDyelot'))
    LCAPVIDES = ''
    DO CASE
    CASE INLIST(LOAUTOFORM.LATICKETS[loAutoForm.cboTktType.Value,2],'I','S','M','R','D','A')
      =SEEK(LCITEM,'Style')
      LCAPVIDES = STYLE.DESC1
    CASE INLIST(LOAUTOFORM.LATICKETS[loAutoForm.cboTktType.Value,2],'T','L','F')
      =LOFORMSET.FABRIC.SEEK('0002'+LFUPDITEM(SUBSTR(LCITEM,1,LOFORMSET.LNFABMAJLEN),EVALUATE(LOFORMSET.LCAUTOINV+'.Color'))) &&Sql127: Check Key
      LCAPVIDES = FABRIC.DESC
    ENDCASE
    REPLACE APINVHDR.NLASTVILNO WITH  APINVHDR.NLASTVILNO + 1 IN APINVHDR
    APPEND BLANK


    LCWIPACCT = IIF(  LOAUTOFORM.LATICKETS[loAutoForm.cboTktType.Value,2]= 'S'  ,;
      EVALUATE(LOFORMSET.LCAUTOINV+'.cWIPAcct') , LOAUTOFORM.GLAPDGLACT.KEYTEXTBOX.VALUE)

    =SEEK(LCITEM,'Style')
    IF LOAUTOFORM.LCMFGCODE =REPLICATE('*',6)
      LOAUTOFORM.LCMFGCODE=IIF(!STYLE.LDETCOST,PADR('*'+LOAUTOFORM.LAAPLCST[loAutoForm.cboCostType.Value,2],6),LOAUTOFORM.LCMFGCODE )
    ENDIF
    IF LOAUTOFORM.LCMFGCODE =REPLICATE('#',6)
      LOAUTOFORM.LCMFGCODE=IIF(!STYLE.LDETCOST,PADR('*'+LOAUTOFORM.LAAPLCST[loAutoForm.cboCostType.Value,2],6),LOAUTOFORM.LCMFGCODE )
    ENDIF

    REPLACE CSTATUS    WITH 'A'  ,;
      CVENDCODE  WITH LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE ,;
      CAPINVNO   WITH LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE ,;
      CAPVILNO   WITH STR(APINVHDR.NLASTVILNO,4) ,;
      CIMTYP     WITH LOAUTOFORM.LATICKETS[loAutoForm.cboTktType.Value,2] ,;
      LINENO     WITH EVALUATE(LOFORMSET.LCAUTOINV+'.LineNo')   ,;
      CBOMTYPE   WITH LOAUTOFORM.LAAPLCST[loAutoForm.cboCostType.Value,2]  ,;
      CCOSTTYPE  WITH LOAUTOFORM.LAAPLCST[loAutoForm.cboCostType.Value,3]  ,;
      COPRCODE   WITH LOAUTOFORM.LCMFGCODE   ,;
      CTKTNO     WITH IIF(CIMTYP='S',EVALUATE(LOFORMSET.LCAUTOINV+'.cTktNo'),LOAUTOFORM.KBINVTKTNO.KEYTEXTBOX.VALUE) ,;
      SHIPNO     WITH IIF(CIMTYP='S',LOAUTOFORM.KBINVTKTNO.KEYTEXTBOX.VALUE,'') ,;
      CLOTNO     WITH LOAUTOFORM.LCAPLLOTNO  ,;
      ITEM       WITH LCITEM      ,;
      COLOR      WITH EVALUATE(LOFORMSET.LCAUTOINV+'.Color') ,;
      CDYELOT    WITH EVALUATE(LOFORMSET.LCAUTOINV+'.cDyelot'),;
      CAPVIDES   WITH LCAPVIDES ,;
      CAPDGLACT  WITH LCWIPACCT ,;
      CLOTNO     WITH IIF(CIMTYP='D',LOAUTOFORM.LAAPLLOTS[loAutoForm.cboLotNo.Value],'')
  ENDIF
  LNDISAMNT = EVALUATE(LOFORMSET.LCAUTOINV+'.nInvAmnt') * IIF(LOAUTOFORM.LATICKETS[loAutoForm.cboTktType.Value,2] $ 'RF',-1,1)
  =LFUPDAPDIST(LOFORMSET,LOFORM,CAPVILNO,LNDISAMNT,LCWIPACCT,LOAUTOFORM.LATICKETS[loAutoForm.cboTktType.Value,2])

  REPLACE NAPQTY1    WITH NAPQTY1 + EVALUATE(LOFORMSET.LCAUTOINV+'.nInvQty1')   ,;
    NAPQTY2    WITH NAPQTY2 + EVALUATE(LOFORMSET.LCAUTOINV+'.nInvQty2')   ,;
    NAPQTY3    WITH NAPQTY3 + EVALUATE(LOFORMSET.LCAUTOINV+'.nInvQty3')   ,;
    NAPQTY4    WITH NAPQTY4 + EVALUATE(LOFORMSET.LCAUTOINV+'.nInvQty4')   ,;
    NAPQTY5    WITH NAPQTY5 + EVALUATE(LOFORMSET.LCAUTOINV+'.nInvQty5')   ,;
    NAPQTY6    WITH NAPQTY6 + EVALUATE(LOFORMSET.LCAUTOINV+'.nInvQty6')   ,;
    NAPQTY7    WITH NAPQTY7 + EVALUATE(LOFORMSET.LCAUTOINV+'.nInvQty7')   ,;
    NAPQTY8    WITH NAPQTY8 + EVALUATE(LOFORMSET.LCAUTOINV+'.nInvQty8')   ,;
    NAPTOTQTY  WITH NAPTOTQTY + EVALUATE(LOFORMSET.LCAUTOINV+'.nInvQty')  ,;
    NAPAMNT    WITH NAPAMNT + EVALUATE(LOFORMSET.LCAUTOINV+'.nInvAmnt')   ,;
    NAPPRICE   WITH IIF(NAPTOTQTY=0,0,NAPAMNT/NAPTOTQTY)
  IF !EMPTY(LOAUTOFORM.KBRSESSION.KEYTEXTBOX.VALUE) OR LOFORM.LLDEFAUAPR
    REPLACE NAPAPRQTY1 WITH NAPAPRQTY1 + EVALUATE(LOFORMSET.LCAUTOINV+'.nInvQty1') ,;
      NAPAPRQTY2 WITH NAPAPRQTY2 + EVALUATE(LOFORMSET.LCAUTOINV+'.nInvQty2') ,;
      NAPAPRQTY3 WITH NAPAPRQTY3 + EVALUATE(LOFORMSET.LCAUTOINV+'.nInvQty3') ,;
      NAPAPRQTY4 WITH NAPAPRQTY4 + EVALUATE(LOFORMSET.LCAUTOINV+'.nInvQty4') ,;
      NAPAPRQTY5 WITH NAPAPRQTY5 + EVALUATE(LOFORMSET.LCAUTOINV+'.nInvQty5') ,;
      NAPAPRQTY6 WITH NAPAPRQTY6 + EVALUATE(LOFORMSET.LCAUTOINV+'.nInvQty6') ,;
      NAPAPRQTY7 WITH NAPAPRQTY7 + EVALUATE(LOFORMSET.LCAUTOINV+'.nInvQty7') ,;
      NAPAPRQTY8 WITH NAPAPRQTY8 + EVALUATE(LOFORMSET.LCAUTOINV+'.nInvQty8') ,;
      NAPTAPRQTY WITH NAPTAPRQTY + EVALUATE(LOFORMSET.LCAUTOINV+'.nInvQty')  ,;
      NAPAPRAMNT WITH NAPAPRAMNT + EVALUATE(LOFORMSET.LCAUTOINV+'.nInvAmnt') ,;
      NAPAPRPRIC WITH IIF(NAPTAPRQTY=0,0,NAPAPRAMNT/NAPTAPRQTY)
  ENDIF
  REPLACE NAPAMNT    WITH NAPAMNT    * IIF((LOAUTOFORM.LATICKETS[loAutoForm.cboTktType.Value,2] $ 'RF') OR LOFORMSET.LLDEBITM ,-1,1),;
    NAPPRICE   WITH NAPPRICE   * IIF((LOAUTOFORM.LATICKETS[loAutoForm.cboTktType.Value,2] $ 'RF') OR LOFORMSET.LLDEBITM ,-1,1),;
    NAPAPRAMNT WITH NAPAPRAMNT * IIF((LOAUTOFORM.LATICKETS[loAutoForm.cboTktType.Value,2] $ 'RF') OR LOFORMSET.LLDEBITM ,-1,1),;
    NAPAPRPRIC WITH NAPAPRPRIC * IIF((LOAUTOFORM.LATICKETS[loAutoForm.cboTktType.Value,2] $ 'RF') OR LOFORMSET.LLDEBITM ,-1,1)
  LOFORMSET.LNTAPRAMT = LOFORMSET.LNTAPRAMT + ROUND(EVALUATE(LOFORMSET.LCAUTOINV+'.nInvAmnt')*IIF((LOAUTOFORM.LATICKETS[loAutoForm.cboTktType.Value,2] $ 'RF') OR LOFORMSET.LLDEBITM ,-1,1),2)
  LOFORMSET.LNTINVAMT = LOFORMSET.LNTINVAMT + ROUND(EVALUATE(LOFORMSET.LCAUTOINV+'.nInvAmnt')*IIF((LOAUTOFORM.LATICKETS[loAutoForm.cboTktType.Value,2] $ 'RF') OR LOFORMSET.LLDEBITM ,-1,1),2)

  SELECT (LOFORMSET.LCAPINVTKT)
  IF !SEEK(PADR(LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE,8)+PADR(LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE,12)+EVALUATE(LOFORMSET.LCAPVINVDT+'.cApVILNo')+LOAUTOFORM.KBRSESSION.KEYTEXTBOX.VALUE)

    INSERT INTO (LOFORMSET.LCAPINVTKT) ;
      (CVENDCODE,CAPINVNO,CAPVILNO,CRSESSION,ITEM,COLOR,CWARECODE,CDYELOT,;
      CSTATUS,LINENO,CIMTYP,CTKTNO,CRECVTYPE,CAPDLINNO,CAPDGLACT) VALUES  ;
      (LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE,LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE,EVALUATE(LOFORMSET.LCAPVINVDT+'.cApVILNo'),LOAUTOFORM.KBRSESSION.KEYTEXTBOX.VALUE,;
      EVALUATE(LOFORMSET.LCAPVINVDT+'.Item'),EVALUATE(LOFORMSET.LCAPVINVDT+'.Color'),EVALUATE(LOFORMSET.LCAUTOINV+'.cWareCode'),;
      EVALUATE(LOFORMSET.LCAUTOINV+'.cDyelot'),'A',EVALUATE(LOFORMSET.LCAUTOINV+'.LineNo'),LOAUTOFORM.LATICKETS[loAutoForm.cboTktType.Value,2],;
      IIF(LOAUTOFORM.LATICKETS[loAutoForm.cboTktType.Value,2]='S',EVALUATE(LOFORMSET.LCAUTOINV+'.cTktNo'),LOAUTOFORM.KBINVTKTNO.KEYTEXTBOX.VALUE),;
      EVALUATE(LOFORMSET.LCAUTOINV+'.cRecvType'),EVALUATE(LOFORMSET.LCAPVINVDT+'.cApVILNo'),EVALUATE(LOFORMSET.LCAPVINVDT+'.cApDGlAct'))

  ENDIF
  REPLACE NAPAPLQTY1 WITH NAPAPLQTY1 + EVALUATE(LOFORMSET.LCAUTOINV+'.nInvQty1') ,;
    NAPAPLQTY2 WITH NAPAPLQTY2 + EVALUATE(LOFORMSET.LCAUTOINV+'.nInvQty2') ,;
    NAPAPLQTY3 WITH NAPAPLQTY3 + EVALUATE(LOFORMSET.LCAUTOINV+'.nInvQty3') ,;
    NAPAPLQTY4 WITH NAPAPLQTY4 + EVALUATE(LOFORMSET.LCAUTOINV+'.nInvQty4') ,;
    NAPAPLQTY5 WITH NAPAPLQTY5 + EVALUATE(LOFORMSET.LCAUTOINV+'.nInvQty5') ,;
    NAPAPLQTY6 WITH NAPAPLQTY6 + EVALUATE(LOFORMSET.LCAUTOINV+'.nInvQty6') ,;
    NAPAPLQTY7 WITH NAPAPLQTY7 + EVALUATE(LOFORMSET.LCAUTOINV+'.nInvQty7') ,;
    NAPAPLQTY8 WITH NAPAPLQTY8 + EVALUATE(LOFORMSET.LCAUTOINV+'.nInvQty8') ,;
    NAPTAPLQTY WITH NAPTAPLQTY + EVALUATE(LOFORMSET.LCAUTOINV+'.nInvQty')  ,;
    NAPAPLAMNT WITH NAPAPLAMNT + EVALUATE(LOFORMSET.LCAUTOINV+'.nInvAmnt') ,;
    NAPAPLPRIC WITH IIF(NAPTAPLQTY=0,0,NAPAPLAMNT/NAPTAPLQTY)

  REPLACE NAPAPLAMNT WITH NAPAPLAMNT * IIF((LOAUTOFORM.LATICKETS[loAutoForm.cboTktType.Value,2] $ 'RF') OR LOFORMSET.LLDEBITM ,-1,1),;
    NAPAPLPRIC WITH NAPAPLPRIC * IIF((LOAUTOFORM.LATICKETS[loAutoForm.cboTktType.Value,2] $ 'RF') OR LOFORMSET.LLDEBITM ,-1,1)
ENDSCAN
SET ORDER TO TAG (LOFORMSET.LCAPVINVDT) IN (LOFORMSET.LCAPVINVDT)

RETURN
*-- End of lfvProAuto



***AAA***



***MMM***


*!*************************************************************
*! Name      : lfMultiInit
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 09/15/2004
*! Purpose   : Called from the Init Event of the APIMAPR.SCX
*!*************************************************************
*! Parameters: The FormSet of APPYINV.SCX, The Form of APINVDT.SCX, The Form of APIMAPR.SCX
*!*************************************************************
*! Returns   :  None
*!*************************************************************
FUNCTION LFMULTIINIT
LPARAMETERS LOFORMSET, LOFORM, LOMULTIFORM


*ASM, Add Properties to the form [Start]
LCALLVAR = 'lcInvLine,llDetails,llQtyUsDec,lcQtyFldPc,loMultiRec'

DIMENSION LAALLVAR[1,1]
STORE '' TO LAALLVAR
=GFSUBSTR(LCALLVAR,@LAALLVAR,',')

LOCAL LNI
FOR LNI = 1 TO ALEN(LAALLVAR,1)
  IF LOWER(LEFT(LAALLVAR[lnI,1],2)) <> 'la'
    PRIVATE &LAALLVAR[lnI,1].
  ENDIF
ENDFOR

=LFADDPRO(LOMULTIFORM)

*ASM, Add Properties to the form [End]

LOMULTIFORM.LCINVLINE = EVALUATE(LOFORMSET.LCAPVINVDT+'.cApVILNo')
*!ASM, Enable Detailed Qty Entering in case of Material too
*loMultiForm.llDetails = INLIST(EVALUATE(loFormSet.lcAPvInvDt+'.cIMTyp'),'M','I','S','R') AND loForm.llDefQtyDt
LOMULTIFORM.LLDETAILS = INLIST(EVALUATE(LOFORMSET.LCAPVINVDT+'.cIMTyp'),'M','I','S','R', 'L' , 'T' , 'F') AND LOFORM.LLDEFQTYDT

*Add this line to check if the quantity field is going to use
*decimal points or not, the quantity field is going to use
*decimal points in the case of document types Material PO
*, Material PO Return and Material MFG Order [Begin]
LOMULTIFORM.LLQTYUSDEC = INLIST(EVALUATE(LOFORMSET.LCAPVINVDT+'.cIMTyp') , 'L' , 'T' , 'F')
LOMULTIFORM.LCQTYFLDPC = IIF(LOMULTIFORM.LLQTYUSDEC , '9999999.999' , '9999999')
LOMULTIFORM.TXTAPTAPRQTY.INPUTMASK=LOMULTIFORM.LCQTYFLDPC
FOR LNI=1 TO 8
  LCI=ALLTRIM(STR(LNI))
  LOMULTIFORM.CNTAPAPR_QTY.TXTQTY&LCI..INPUTMASK=LOMULTIFORM.LCQTYFLDPC
NEXT
*Add this line to check if the quantity field is going to use [End]

SELECT *,RECNO() AS NLRECNO FROM (LOFORMSET.LCAPVINVDT) WHERE CVENDCODE+CAPINVNO+CAPVILNO =;
  PADR(LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE,8)+PADR(LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE,12)+LOMULTIFORM.LCINVLINE ;
  INTO DBF (OARIAAPPLICATION.WORKDIR+LOFORMSET.LCTMPAPR)

SELECT (LOFORMSET.LCTMPAPR)

WITH LOMULTIFORM.GRDMAPRLINES

  .COLUMNCOUNT = 0
  .RECORDSOURCE = LOFORMSET.LCTMPAPR
  .COLUMNCOUNT = 6

  .COLUMN1.CONTROLSOURCE = "nApTotQty"
  *N000682,1 MMT 11/20/2012 Globalization Changes[Start]
  *  .COLUMN1.HEADER1.CAPTION = 'Inv. Qty.'
  *N000682,1 11/20/2012 MMT Globlization changes[Start]
*.COLUMN1.HEADER1.CAPTION =LANG_APPYINV_INV_QTY
.COLUMN1.HEADER1.CAPTION =IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_INV_QTY,loFormSet.GetHeaderText("LANG_APPYINV_INV_QTY",loFormSet.HeaderAlias))
*N000682,1 11/20/2012 MMT Globlization changes[End]

  *N000682,1 11/20/2012 MMT Globlization changes[End]


  .COLUMN2.CONTROLSOURCE = "nApPrice"
  *N000682,1 MMT 11/20/2012 Globalization Changes[Start]
  *  .COLUMN2.HEADER1.CAPTION = 'Inv. Price'
  *N000682,1 11/20/2012 MMT Globlization changes[Start]
*.COLUMN2.HEADER1.CAPTION =LANG_APPYINV_INV_PRICE
.COLUMN2.HEADER1.CAPTION =IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_INV_PRICE,loFormSet.GetHeaderText("LANG_APPYINV_INV_PRICE",loFormSet.HeaderAlias))
*N000682,1 11/20/2012 MMT Globlization changes[End]

  *N000682,1 MMT 11/20/2012 Globalization Changes[End]




  .COLUMN3.CONTROLSOURCE = "ROUND(nApAmnt,2)"
  *N000682,1 MMT 11/20/2012 Globalization Changes[Start]
  *  .COLUMN3.HEADER1.CAPTION = 'Inv. Amount'
  *N000682,1 11/20/2012 MMT Globlization changes[Start]
*.COLUMN3.HEADER1.CAPTION =LANG_APPYINV_INV_AMOUNT
.COLUMN3.HEADER1.CAPTION =IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_INV_AMOUNT,loFormSet.GetHeaderText("LANG_APPYINV_INV_AMOUNT",loFormSet.HeaderAlias))
*N000682,1 11/20/2012 MMT Globlization changes[End]

  *N000682,1 MMT 11/20/2012 Globalization Changes[End]




  .COLUMN4.CONTROLSOURCE = "nApTAprQty"
  *N000682,1 MMT 11/20/2012 Globalization Changes[Start]
  *  .COLUMN4.HEADER1.CAPTION = 'Appr. Qty.'
  *N000682,1 11/20/2012 MMT Globlization changes[Start]
*.COLUMN4.HEADER1.CAPTION =LANG_APPYINV_APPR_QTY
.COLUMN4.HEADER1.CAPTION =IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_APPR_QTY,loFormSet.GetHeaderText("LANG_APPYINV_APPR_QTY",loFormSet.HeaderAlias))
*N000682,1 11/20/2012 MMT Globlization changes[End]

  *N000682,1 MMT 11/20/2012 Globalization Changes[End]
  .COLUMN5.CONTROLSOURCE = "nApAprPric"
  *N000682,1 MMT 11/20/2012 Globalization Changes[Start]
  *  .COLUMN5.HEADER1.CAPTION = 'Appr. Price'
  *N000682,1 11/20/2012 MMT Globlization changes[Start]
*.COLUMN5.HEADER1.CAPTION =LANG_APPYINV_APPR_PRICE
.COLUMN5.HEADER1.CAPTION =IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_APPR_PRICE,loFormSet.GetHeaderText("LANG_APPYINV_APPR_PRICE",loFormSet.HeaderAlias))
*N000682,1 11/20/2012 MMT Globlization changes[End]

  *N000682,1 MMT 11/20/2012 Globalization Changes[End]




  .COLUMN6.CONTROLSOURCE = "ROUND(nApAprAmnt,2)"
  *N000682,1 MMT 11/20/2012 Globalization Changes[Start]
  *  .COLUMN6.HEADER1.CAPTION = 'Appr. Amount'
  *N000682,1 11/20/2012 MMT Globlization changes[Start]
*.COLUMN6.HEADER1.CAPTION =LANG_APPYINV_APPR_AMOUNT
.COLUMN6.HEADER1.CAPTION =IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_APPR_AMOUNT,loFormSet.GetHeaderText("LANG_APPYINV_APPR_AMOUNT",loFormSet.HeaderAlias))
*N000682,1 11/20/2012 MMT Globlization changes[End]

  *N000682,1 MMT 11/20/2012 Globalization Changes[End]




ENDWITH

LOMULTIFORM.CNTAPAPR_QTY.SCALE = LOFORM.CNTAPAPR_QTY.SCALE

SCATTER NAME LOMULTIFORM.LOMULTIREC
=LFGRDMAPRAFTERROWCOL(LOFORMSET, LOFORM, LOMULTIFORM)


RETURN
*-- End of lfMultiInit


*!*************************************************************
*! Name      : lfgrdMAprAfterRowCol
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 09/15/2004
*! Purpose   : Called from the AfterRowColChange Event of the grid in APIMAPR.SCX
*!*************************************************************
*! Parameters: The FormSet of APPYINV.SCX, The Form of APINVDT.SCX, The Form of APIMAPR.SCX
*!*************************************************************
*! Returns   :  None
*!*************************************************************
FUNCTION LFGRDMAPRAFTERROWCOL
LPARAMETERS LOFORMSET, LOFORM, LOMULTIFORM

SCATTER NAME LOMULTIFORM.LOMULTIREC

IF LOMULTIFORM.LLDETAILS
  *=lfRefresh('APIMAPR2')
  *Old: SHOW GETS WINDOW 'APIMAPR2' ONLY &&Revise
  LOMULTIFORM.CNTAPAPR_QTY.VISIBLE = .T.
  LOMULTIFORM.TXTAPTAPRQTY.VISIBLE = .F.
ELSE
  *=lfRefresh('APIMAPR3')
  *Old: SHOW GETS WINDOW 'APIMAPR3' ONLY &&Revise
  LOMULTIFORM.CNTAPAPR_QTY.VISIBLE = .F.
  LOMULTIFORM.TXTAPTAPRQTY.VISIBLE = .T.
ENDIF

LOMULTIFORM.REFRESH()

RETURN
*-- End of lfgrdMAprAfterRowCol


*!*************************************************************
*! Name      : lfvNewApr
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 09/15/2004
*! Purpose   : Called from the Click Event of the New Button in APIMAPR.SCX
*!*************************************************************
*! Parameters: The FormSet of APPYINV.SCX, The Form of APINVDT.SCX, The Form of APIMAPR.SCX
*!*************************************************************
*! Returns   :  None
*!*************************************************************
FUNCTION LFVNEWAPR
LPARAMETERS LOFORMSET, LOFORM, LOMULTIFORM

SELECT (LOFORMSET.LCAPVINVDT)
=SEEK(PADR(LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE,8)+PADR(LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE,12)+LOMULTIFORM.LCINVLINE)

SCATTER NAME LOMULTIFORM.LOMULTIREC ;
  FIELDS CVENDCODE,CAPINVNO,CAPVILNO,CIMTYP,CBOMTYPE,CCOSTTYPE,COPRCODE,CLOTNO,;
  ITEM,COLOR,CDYELOT,CAPVIDES,CTKTNO,SHIPNO,CAPDGLACT ADDITIVE

LOMULTIFORM.LOMULTIREC.NAPAPRPRIC = NAPPRICE
SELECT (LOFORMSET.LCTMPAPR)
WITH LOMULTIFORM.LOMULTIREC
  SUM ALL NAPAPRQTY1,NAPAPRQTY2,NAPAPRQTY3,NAPAPRQTY4,NAPAPRQTY5,NAPAPRQTY6,;
    NAPAPRQTY7,NAPAPRQTY8 ;
    TO .NAPAPRQTY1,.NAPAPRQTY2, .NAPAPRQTY3, .NAPAPRQTY4,;
    .NAPAPRQTY5,.NAPAPRQTY6, .NAPAPRQTY7,.NAPAPRQTY8

  .NAPAPRQTY1 = MAX(EVALUATE(LOFORMSET.LCAPVINVDT+'.nApQty1')-.NAPAPRQTY1,0)
  .NAPAPRQTY2 = MAX(EVALUATE(LOFORMSET.LCAPVINVDT+'.nApQty2')-.NAPAPRQTY2,0)
  .NAPAPRQTY3 = MAX(EVALUATE(LOFORMSET.LCAPVINVDT+'.nApQty3')-.NAPAPRQTY3,0)
  .NAPAPRQTY4 = MAX(EVALUATE(LOFORMSET.LCAPVINVDT+'.nApQty4')-.NAPAPRQTY4,0)
  .NAPAPRQTY5 = MAX(EVALUATE(LOFORMSET.LCAPVINVDT+'.nApQty5')-.NAPAPRQTY5,0)
  .NAPAPRQTY6 = MAX(EVALUATE(LOFORMSET.LCAPVINVDT+'.nApQty6')-.NAPAPRQTY6,0)
  .NAPAPRQTY7 = MAX(EVALUATE(LOFORMSET.LCAPVINVDT+'.nApQty7')-.NAPAPRQTY7,0)
  .NAPAPRQTY8 = MAX(EVALUATE(LOFORMSET.LCAPVINVDT+'.nApQty8')-.NAPAPRQTY8,0)
  .NAPTAPRQTY = .NAPAPRQTY1+.NAPAPRQTY2+.NAPAPRQTY3+.NAPAPRQTY4+;
    .NAPAPRQTY5+.NAPAPRQTY6+.NAPAPRQTY7+.NAPAPRQTY8
  .NAPAPRAMNT = .NAPTAPRQTY*.NAPAPRPRIC
ENDWITH

SELECT (LOFORMSET.LCTMPAPR)
APPEND BLANK
GATHER NAME LOMULTIFORM.LOMULTIREC FIELDS CVENDCODE,CAPINVNO,CAPVILNO,CIMTYP,CBOMTYPE,CCOSTTYPE,;
  COPRCODE,CLOTNO,ITEM,COLOR,CDYELOT,CAPVIDES,CTKTNO,SHIPNO,CAPDGLACT,NAPAPRPRIC,;
  NAPAPRQTY1,NAPAPRQTY2,NAPAPRQTY3,NAPAPRQTY4,NAPAPRQTY5,NAPAPRQTY6,NAPAPRQTY7,;
  NAPAPRQTY8,NAPTAPRQTY,NAPAPRAMNT

*Old: =lfWMApr()
=LFGRDMAPRAFTERROWCOL(LOFORMSET, LOFORM, LOMULTIFORM)

*Change this line because we are going to switch between 2 Get
*          Fields for the "Approve Quantity" to be able to add the
*          decimal points to the "Approve Quantity" in the case of
*          document types Material PO, Material PO Return and
*          Material MFG Order [Begin]
*_CUROBJ = IIF(loMultiForm.llDetails,OBJNUM(m.nAPAprQty1),OBJNUM(m.nAPTAprQty))
*Old: _CUROBJ = IIF(loMultiForm.llDetails , OBJNUM(m.nAPAprQty1) , loFormSet.lnApQtyObj)&&Old CurObj
IF LOMULTIFORM.LLDETAILS
  LOMULTIFORM.CNTAPAPR_QTY.TXTQTY1.SETFOCUS()
ELSE
  LOMULTIFORM.TXTAPTAPRQTY.SETFOCUS()
ENDIF
*Change this line because we are going to switch between 2 [End]

RETURN
*-- End of lfvNewApr


*!*************************************************************
*! Name      : lfvRemApr
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 09/15/2004
*! Purpose   : Called from the Click Event of the Remove Button in APIMAPR.SCX
*!*************************************************************
*! Parameters: The FormSet of APPYINV.SCX, The Form of APINVDT.SCX, The Form of APIMAPR.SCX
*!*************************************************************
*! Returns   :  None
*!*************************************************************
FUNCTION LFVREMAPR
LPARAMETERS LOFORMSET, LOFORM, LOMULTIFORM

IF GFMODALGEN("QRM00007B00007","ALERT") = 1
  DELETE
  GO TOP
  *Old: =lfWMApr()
  =LFGRDMAPRAFTERROWCOL(LOFORMSET, LOFORM, LOMULTIFORM)
ENDIF

RETURN
*-- End of lfvRemApr


*!*************************************************************
*! Name      : lfvMAprQty
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 09/15/2004
*! Purpose   : Validate Approved Total Quantity in APIMAPR.SCX
*!*************************************************************
*! Parameters: The FormSet of APPYINV.SCX, The Form of APINVDT.SCX, The Form of APIMAPR.SCX
*!*************************************************************
*! Returns   :  None
*!*************************************************************
FUNCTION LFVMAPRQTY
LPARAMETERS LOFORMSET, LOFORM, LOMULTIFORM

WITH LOMULTIFORM.LOMULTIREC
  .NAPAPRPRIC = IIF(.NAPTAPRQTY=0,.NAPAPRAMNT,.NAPAPRPRIC)
  .NAPTAPRQTY = IIF(.NAPTAPRQTY=0,1,.NAPTAPRQTY)
  .NAPAPRAMNT = .NAPTAPRQTY*.NAPAPRPRIC
ENDWITH

*Old: SHOW GET m.nAPAprAmnt &&Revise
LOMULTIFORM.TXTAPAPRAMNT.REFRESH()

GATHER NAME LOMULTIFORM.LOMULTIREC FIELDS NAPAPRAMNT,NAPTAPRQTY,NAPAPRPRIC
LOMULTIFORM.REFRESH()

RETURN
*-- End of lfvMAprQty

*!*************************************************************
*! Name      : lfvMAprCst
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 09/15/2004
*! Purpose   : Validate Approved Cost in APIMAPR.SCX
*!*************************************************************
*! Parameters: The FormSet of APPYINV.SCX, The Form of APINVDT.SCX, The Form of APIMAPR.SCX
*!*************************************************************
*! Returns   :  None
*!*************************************************************
FUNCTION LFVMAPRCST
LPARAMETERS LOFORMSET, LOFORM, LOMULTIFORM

LOMULTIFORM.LOMULTIREC.NAPAPRAMNT = LOMULTIFORM.LOMULTIREC.NAPTAPRQTY*LOMULTIFORM.LOMULTIREC.NAPAPRPRIC
GATHER NAME LOMULTIFORM.LOMULTIREC FIELDS NAPAPRAMNT,NAPAPRPRIC
*SHOW WINDOW (lcMAPrTtl) REFRESH SAME
LOMULTIFORM.REFRESH()

RETURN
*-- End of lfvMAprCst

*!*************************************************************
*! Name      : lfvMAprAmnt
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 09/15/2004
*! Purpose   : Validate Approved Amount in APIMAPR.SCX
*!*************************************************************
*! Parameters: The FormSet of APPYINV.SCX, The Form of APINVDT.SCX, The Form of APIMAPR.SCX
*!*************************************************************
*! Returns   :  None
*!*************************************************************
FUNCTION LFVMAPRAMNT
LPARAMETERS LOFORMSET, LOFORM, LOMULTIFORM

WITH LOMULTIFORM.LOMULTIREC
  .NAPAPRAMNT = .NAPAPRAMNT*1.000
  .NAPAPRPRIC = IIF(.NAPTAPRQTY=0,0,.NAPAPRAMNT/.NAPTAPRQTY)
ENDWITH

*Old: SHOW GET m.nAPAprPric &&Revise
LOMULTIFORM.TXTAPAPRPRIC.REFRESH()

GATHER NAME LOMULTIFORM.LOMULTIREC FIELDS NAPAPRAMNT,NAPAPRPRIC
*SHOW WINDOW (lcMAPrTtl) REFRESH SAME
LOMULTIFORM.REFRESH()

RETURN
*-- End of lfvMAprAmnt

*!*************************************************************
*! Name      : lfvMAprSQty
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 09/15/2004
*! Purpose   : Validate Approved Size Quantity in APIMAPR.SCX
*!*************************************************************
*! Parameters: The FormSet of APPYINV.SCX, The Form of APINVDT.SCX, The Form of APIMAPR.SCX
*!*************************************************************
*! Returns   :  None
*!*************************************************************
FUNCTION LFVMAPRSQTY
LPARAMETERS LOFORMSET, LOFORM, LOMULTIFORM

IF EOF(LOFORMSET.LCTMPAPR)
  RETURN
ENDIF
WITH LOMULTIFORM.LOMULTIREC
  .NAPTAPRQTY = .NAPAPRQTY1+.NAPAPRQTY2+.NAPAPRQTY3+.NAPAPRQTY4+;
    .NAPAPRQTY5+.NAPAPRQTY6+.NAPAPRQTY7+.NAPAPRQTY8
ENDWITH

GATHER NAME LOMULTIFORM.LOMULTIREC FIELDS NAPAPRQTY1,NAPAPRQTY2,NAPAPRQTY3,NAPAPRQTY4,;
  NAPAPRQTY5,NAPAPRQTY6,NAPAPRQTY7,NAPAPRQTY8
=LFVMAPRQTY(LOFORMSET, LOFORM, LOMULTIFORM)
*SHOW WINDOW (lcMAPrTtl) REFRESH SAME
*=lfRefresh('APIMAPR2')
LOMULTIFORM.REFRESH()

RETURN
*-- End of lfvMAprSQty

*!*************************************************************
*! Name      : lfvProMApr
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 09/15/2004
*! Purpose   : Called from the Click Event of the Proceed Button in APIMAPR.SCX
*!*************************************************************
*! Parameters: The FormSet of APPYINV.SCX, The Form of APINVDT.SCX, The Form of APIMAPR.SCX
*!*************************************************************
*! Returns   :  None
*!*************************************************************
FUNCTION LFVPROMAPR
LPARAMETERS LOFORMSET, LOFORM, LOMULTIFORM

SET DELETE OFF
*! E302678,1 MMT 03/24/2010 Convert Payable invoice screen to use SQL tables[Start]
SELECT(LOFORMSET.LCTMPAPR)
*! E302678,1 MMT 03/24/2010 Convert Payable invoice screen to use SQL tables[End]

WITH LOMULTIFORM.LOMULTIREC
  SCAN
    DO CASE
    CASE DELETED() AND NLRECNO <> 0
      SELECT (LOFORMSET.LCAPVINVDT)
      GO EVALUATE(LOFORMSET.LCTMPAPR+'.nLRecNo')
      REPLACE CSTATUS WITH IIF(CSTATUS='A','S','D')
      DELETE
      LOFORMSET.LNTAPRAMT = LOFORMSET.LNTAPRAMT - ROUND(NAPAPRAMNT,2)*IIF(.CIMTYP $ 'RF',-1,1)
    CASE !DELETED() AND NLRECNO <> 0
      SCATTER NAME LOMULTIFORM.LOMULTIREC
      SELECT (LOFORMSET.LCAPVINVDT)
      GO EVALUATE(LOFORMSET.LCTMPAPR+'.nLRecNo')
      .CSTATUS = IIF(CSTATUS='S','M',CSTATUS)
      LOFORMSET.LNTAPRAMT = LOFORMSET.LNTAPRAMT+(ROUND(.NAPAPRAMNT,2)-ROUND(NAPAPRAMNT,2))*IIF(.CIMTYP $ 'RF',-1,1)
      GATHER NAME LOMULTIFORM.LOMULTIREC
    CASE !DELETED() AND NLRECNO = 0
      SCATTER NAME LOMULTIFORM.LOMULTIREC
      .CSTATUS = 'A'
      SELECT (LOFORMSET.LCAPVINVDT)
      APPEND BLANK
      GATHER NAME LOMULTIFORM.LOMULTIREC
      LOFORMSET.LNTAPRAMT = LOFORMSET.LNTAPRAMT + ROUND(.NAPAPRAMNT,2)
    ENDCASE
  ENDSCAN
ENDWITH
SET DELETE ON
SELECT (LOFORMSET.LCAPVINVDT)
SKIP 1
SKIP -1

RETURN
*-- End of lfvProMApr


***MMM***
***CCC***
*!*************************************************************
*! Name      : lfContInit
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 11/07/2004
*! Purpose   : Called From the Init Event of the Contribution Screen
*!*************************************************************
*! Parameters: The FormSet of APPYINV.SCX, The Form of APINVDT.SCX, The Form of APMATST.SCX
*!*************************************************************
*! Returns   :  None
*!*************************************************************
FUNCTION LFCONTINIT
PARAMETERS LOFORMSET, LOFORM, LOCONTFORM

LOCAL LCSQLSTATEMENT, LNRESULT, LCTEMP

*ASM, Add Properties to the form [Start]
LCALLVAR = 'laRSession,lnCntrbAmnt,lnAplAmnt,lnRecCost,lnTRecQty,lnRecAmnt,'+;
  'lnActCost,lnTActQty,lnActAmnt,lnTAplQty,'+;
  'lnRecQty1,lnRecQty2,lnRecQty3,lnRecQty4,lnRecQty5,lnRecQty6,lnRecQty7,lnRecQty8,'+;
  'lnActQty1,lnActQty2,lnActQty3,lnActQty4,lnActQty5,lnActQty6,lnActQty7,lnActQty8,'+;
  'lnAplQty1,lnAplQty2,lnAplQty3,lnAplQty4,lnAplQty5,lnAplQty6,lnAplQty7,lnAplQty8,'+;
  'kbRSession,lnAmount,rbCntrb,lcContItem,lcContClr,lcMfgCode,lcMfgTmp,llProceed,'+;
  'lnCMarker,lcCntrbBr,lcPopStat,lcRemStat,lcNewStat,lcInvLineNo,loRec,lcShipNo,lcTicket,'+;
  'lcBrowQty,lcBrowCst,llShowSize,lcRcvQty,lcLnFldName,lcAcFldName'

DIMENSION LAALLVAR[1,1]
STORE '' TO LAALLVAR
=GFSUBSTR(LCALLVAR,@LAALLVAR,',')

LOCAL LNI
FOR LNI = 1 TO ALEN(LAALLVAR,1)
  IF LOWER(LEFT(LAALLVAR[lnI,1],2)) <> 'la'
    PRIVATE &LAALLVAR[lnI,1].
  ENDIF
ENDFOR
DIMENSION LARSESSION[1]
=LFADDPRO(LOCONTFORM)

*ASM, Add Properties to the form [End]
SELECT IIF(LOFORMSET.ACTIVEMODE="V",'APVINVDT2',LOFORMSET.LCAPVINVDT)

LCLOTNO    = CLOTNO
LOCONTFORM.LCTICKET   = CTKTNO
LOCONTFORM.LCSHIPNO   = SHIPNO
LOFORM.LCCSTTYPE  = CBOMTYPE
LCCSTCATG  = CCOSTTYPE
LOFORM.LCOPRCODE  = COPRCODE
LOFORM.LCTKTTYPE  = CIMTYP
LOCONTFORM.LCINVLINENO= CAPVILNO
LOFORMSET.LNLINENO   = LINENO
*B608531,1 WAM 04/23/2008 Get the proper fabric/color code
*lcItem     = IIF(INLIST(loForm.lcTktType,'S','I','M','R','A','D'),Item,SUBSTR(Item,1,loFormSet.lnFabMajLen)+Color)
IF INLIST(LOFORM.LCTKTTYPE,'S','I','M','R','A','D')
  LCITEM = ITEM
ELSE
  LCITEMPIC = GFITEMMASK('PI','','0002')
  LCITEM = PADR(SUBSTR(ITEM,1,LOFORMSET.LNFABMAJLEN)+SUBSTR(LCITEMPIC,LOFORMSET.LNFABMAJLEN+1,1)+COLOR,19)
ENDIF
*B608531,1 WAM 04/23/2008 (End)

LOCONTFORM.LNCMARKER  = 0
*N000682,1 MMT 11/22/2012 Globalization changes[Start]
*LOCONTFORM.LCCNTRBBR  = 'Contributed Lines'
*N000682,1 11/20/2012 MMT Globlization changes[Start]
*LOCONTFORM.LCCNTRBBR  = LANG_CONRIBUTEDLINES
LOCONTFORM.LCCNTRBBR  = IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_CONRIBUTEDLINES,loFormSet.GetHeaderText("LANG_CONRIBUTEDLINES",loFormSet.HeaderAlias))
*N000682,1 11/20/2012 MMT Globlization changes[End]

*N000682,1 MMT 11/22/2012 Globalization changes[END]
LOCONTFORM.LLSHOWSIZE = LOFORM.LLDEFQTYDT AND INLIST(LOFORM.LCTKTTYPE,'S','I','M','R','A','D')
LNRECNO= RECNO()
SUM NAPAPRAMNT TO LOCONTFORM.LNAPLAMNT FOR CVENDCODE+CAPINVNO+CAPVILNO = ;
  PADR(LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE,8)+PADR(LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE,12)+LOCONTFORM.LCINVLINENO
IF BETWEEN(LNRECNO,1,RECCOUNT())
  GO LNRECNO
ENDIF
LLQTYUSDEC = INLIST(LOFORM.LCTKTTYPE , 'L' , 'T' , 'F')
LCQTYFLDPC = IIF(LLQTYUSDEC , '9999999.999' , '9999999')
STORE LCQTYFLDPC TO LOCONTFORM.TXTTRECQTY.INPUTMASK, LOCONTFORM.TXTTACTQTY.INPUTMASK, ;
  LOCONTFORM.TXTAPTAPLQTY.INPUTMASK

STORE 0 TO LOCONTFORM.LNRECQTY1,LOCONTFORM.LNRECQTY2,LOCONTFORM.LNRECQTY3,LOCONTFORM.LNRECQTY4,LOCONTFORM.LNRECQTY5,LOCONTFORM.LNRECQTY6,;
  LOCONTFORM.LNRECQTY7,LOCONTFORM.LNRECQTY8,LOCONTFORM.LNTRECQTY,LOCONTFORM.LNRECCOST,LOCONTFORM.LNRECAMNT,;
  LOCONTFORM.LNACTQTY1,LOCONTFORM.LNACTQTY2,LOCONTFORM.LNACTQTY3,LOCONTFORM.LNACTQTY4,LOCONTFORM.LNACTQTY5,LOCONTFORM.LNACTQTY6,;
  LOCONTFORM.LNACTQTY7,LOCONTFORM.LNACTQTY8,LOCONTFORM.LNTACTQTY,LOCONTFORM.LNACTCOST,LOCONTFORM.LNACTAMNT
IF LOFORM.LCTKTTYPE = 'S'
  *Old: SET ORDER TO TAG Bomshrec
  LOFORMSET.BOMLINE.SETORDER('Bomshrec') &&Sql ;
  *CIMTYP+CTYPE+CBOMTYP+MFGCODE+SHIPNO+CRSESSION+CTKTNO+STR(LINENO,6)+CINVTYPE+STYLE+CSTYGRADE ;
  (CIMTYP+CTYPE+CBOMTYP+MFGCODE+SHIPNO+CRSESSION+CTKTNO+STR(LINENO,6)+STYLE+SCLR+CSTYGRADE)
ELSE
  *Old: SET ORDER TO TAG BOMPOREC IN BOMLINE
  LOFORMSET.BOMLINE.SETORDER('BOMPOREC') &&Sql ;
  *CIMTYP+CTYPE+CBOMTYP+MFGCODE+CTKTNO+CRSESSION+SHIPNO+STR(LINENO,6)+CINVTYPE+STYLE+CSTYGRADE ;
  (CIMTYP+CTYPE+CBOMTYP+MFGCODE+CTKTNO+CRSESSION+SHIPNO+STR(LINENO,6)+STYLE+SCLR+CSTYGRADE)
ENDIF

*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
SELECT APINVTKT
=GFSEEK(LOFORM.LCTKTTYPE+LOCONTFORM.LCTICKET,'apinvtkt','TICKET')
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]


SELECT APINVTKT.CRSESSION,APINVTKT.ITEM,APINVTKT.COLOR,APINVTKT.CWARECODE,;
  APINVTKT.CDYELOT,SUM(APINVTKT.NAPAPLQTY1) AS NAPLQTY1,;
  SUM(APINVTKT.NAPAPLQTY2) AS NAPLQTY2,SUM(APINVTKT.NAPAPLQTY3) AS NAPLQTY3,;
  SUM(APINVTKT.NAPAPLQTY4) AS NAPLQTY4,SUM(APINVTKT.NAPAPLQTY5) AS NAPLQTY5,;
  SUM(APINVTKT.NAPAPLQTY6) AS NAPLQTY6,SUM(APINVTKT.NAPAPLQTY7) AS NAPLQTY7,;
  SUM(APINVTKT.NAPAPLQTY8) AS NAPLQTY8,SUM(APINVTKT.NAPTAPLQTY) AS NAPLQTY,;
  SUM(APINVTKT.NAPAPLAMNT) AS NAPLAMNT FROM APINVTKT,APVINVDT WHERE ;
  APVINVDT.CIMTYP+APVINVDT.CTKTNO+APVINVDT.CLOTNO+APVINVDT.CBOMTYPE+;
  APVINVDT.COPRCODE+APVINVDT.ITEM+APVINVDT.COLOR+APVINVDT.CDYELOT=;
  LOFORM.LCTKTTYPE+LOCONTFORM.LCTICKET+LCLOTNO+LOFORM.LCCSTTYPE+LOFORM.LCOPRCODE AND ;
  APINVTKT.CVENDCODE+APINVTKT.CAPINVNO+APINVTKT.CAPVILNO+APINVTKT.CRSESSION=;
  APVINVDT.CVENDCODE+APVINVDT.CAPINVNO+APVINVDT.CAPVILNO  ;
  GROUP BY ;
  APINVTKT.CRSESSION,APINVTKT.ITEM,APINVTKT.COLOR,APINVTKT.CWARECODE,APINVTKT.CDYELOT ;
  INTO DBF (OARIAAPPLICATION.WORKDIR+LOFORMSET.LCAPPLIED)
INDEX ON CRSESSION+ITEM+COLOR+CWARECODE+CDYELOT TAG (LOFORMSET.LCAPPLIED)
SELECT (LOFORMSET.LCAPPLIED)
DELETE FOR EMPTY(CRSESSION+ITEM+COLOR+CWARECODE)

SELECT IIF(LOFORMSET.ACTIVEMODE="V",'APInvTkt',LOFORMSET.LCAPINVTKT)
SET RELATION TO CRSESSION+ITEM+COLOR+CWARECODE+CDYELOT INTO (LOFORMSET.LCAPPLIED)
IF INLIST(LOFORM.LCTKTTYPE,'S','I','M','R','A','D')
  SET RELATION TO ITEM INTO STYLE ADDITIVE
ENDIF



DO CASE
CASE LOFORM.LCTKTTYPE = 'S'
  LOFORMSET.LCFILEINUSE = 'POSLN'
  LOCONTFORM.LCLNFLDNAME = 'POSLN.NFLANCOST' &&sql
  LOCONTFORM.LCACFLDNAME = 'POSLN.NFACTCOST'
  LOCONTFORM.LCRCVQTY    = 'POSLN.TotQty'
  LOFORMSET.POSLN.SETORDER('POSHREC')  &&Sql ;
  *SHIPNO+CRSESSION+CBUSDOCU+CSTYTYPE+PO+CINVTYPE+STYLE+STR(LINENO,6)+TRANCD ;
  (SHIPNO+CRSESSION+CSTYTYPE+PO+STYLE+STR(LINENO,6)+TRANCD)


  *SHIPNO+CBUSDOCU+CSTYTYPE+PO+CINVTYPE+STYLE+STR(LINENO,6)+TRANCD && POSLNSH Tag
  LCSQLSTATEMENT = "SELECT * FROM POSLN (INDEX=POSLNSH) WHERE SHIPNO='"+;
    LOCONTFORM.LCSHIPNO+"' AND CBUSDOCU='P' AND CSTYTYPE='P'"

  LNRESULT=OARIAAPPLICATION.REMOTECOMPANYDATA.SQLRUN(LCSQLSTATEMENT,'TmpPosln','POSLN',;
    OARIAAPPLICATION.ACTIVECOMPANYCONSTR,3,'SAVE',LOFORMSET.DATASESSIONID)
  IF LNRESULT<1
    OARIAAPPLICATION.REMOTECOMPANYDATA.CHECKRETRESULT("execute",LNRESULT,.T.)
    IF !EMPTY(LCALIAS)
      SELECT (LCALIAS)
    ENDIF
    *AIT WINDOW LINENO()
    RETURN .F.
  ENDIF
  *B608531,1 WAM 04/23/2008 Get all style/color lines
  *SELECT * FROM TmpPosln WHERE IIF(loFormSet.lnLineNo=0,.T.,;
  style+STR(lineno,6)=lcItem+STR(loFormSet.lnLineNo,6)) AND;
  clotNo=lcLotNo INTO DBF (oAriaApplication.WorkDir+loFormSet.lcTmpTkt) &&sql
  SELECT * FROM TMPPOSLN WHERE IIF(LOFORMSET.LNLINENO=0,.T.,STYLE+STR(LINENO,6)=LCITEM) AND;
    CLOTNO=LCLOTNO INTO DBF (OARIAAPPLICATION.WORKDIR+LOFORMSET.LCTMPTKT) &&sql
  *B608531,1 WAM 04/23/2008 (End)

  INDEX ON PO+STR(LINENO,6)+CRSESSION+TRANCD+CSTYGRADE TAG (LOFORMSET.LCTMPTKT)
  USE IN TMPPOSLN

  SELECT IIF(LOFORMSET.ACTIVEMODE="V",'APInvTkt',LOFORMSET.LCAPINVTKT)
  SET RELATION TO CTKTNO+STR(LINENO,6)+CRSESSION+IIF(CRECVTYPE='R','21',IIF(CRECVTYPE='S','42','43')) INTO (LOFORMSET.LCTMPTKT) ADDITIVE
  LOCONTFORM.LCBROWQTY = LOFORMSET.LCTMPTKT+'.TotQty'
  LOCONTFORM.LCBROWCST = LOFORMSET.LCTMPTKT+'.NFLANCOST'

CASE INLIST(LOFORM.LCTKTTYPE,'I','R','A','D')
  LOFORMSET.LCFILEINUSE = 'POSLN'
  LOCONTFORM.LCLNFLDNAME = 'POSLN.NFLANCOST' &&sql
  LOCONTFORM.LCACFLDNAME = 'POSLN.NFACTCOST'
  LOCONTFORM.LCRCVQTY    = 'POSLN.TotQty'
  *Old: SET ORDER TO TAG POSREC IN POSLN
  LOFORMSET.POSLN.SETORDER('POSREC') &&Sql5: Check Tag ;
  *CBUSDOCU+CSTYTYPE+PO+CRSESSION+SHIPNO+CINVTYPE+STYLE+STR(LINENO,6)+TRANCD+CSTYGRADE ;
  (CSTYTYPE+PO+CRSESSION+SHIPNO+STYLE+STR(LINENO,6)+TRANCD)

  *CBUSDOCU+CSTYTYPE+PO+CINVTYPE+STYLE+STR(LINENO,6)+TRANCD && POSLN Tag
  LCTEMP = IIF(LOFORM.LCTKTTYPE='R','R','P')+IIF(INLIST(LOFORM.LCTKTTYPE,'A','D'),LOFORM.LCTKTTYPE,'P')
  LCSQLSTATEMENT = "SELECT * FROM POSLN (INDEX=POSLN) WHERE "+;
    "CBUSDOCU='"+LEFT(LCTEMP,1)+"' AND CSTYTYPE='"+RIGHT(LCTEMP,1)+"' "+;
    "AND PO='"+LOCONTFORM.LCTICKET+"'"
  LNRESULT=OARIAAPPLICATION.REMOTECOMPANYDATA.SQLRUN(LCSQLSTATEMENT,'TmpPosln','POSLN',;
    OARIAAPPLICATION.ACTIVECOMPANYCONSTR,3,'SAVE',LOFORMSET.DATASESSIONID)
  IF LNRESULT<1
    OARIAAPPLICATION.REMOTECOMPANYDATA.CHECKRETRESULT("execute",LNRESULT,.T.)
    IF !EMPTY(LCALIAS)
      SELECT (LCALIAS)
    ENDIF
    *AIT WINDOW LINENO()
    RETURN .F.
  ENDIF
  *B608531,1 WAM 04/23/2008 Get all style/color lines
  *SELECT * FROM TmpPosln WHERE IIF(loFormSet.lnLineNo=0,.T.,;
  style+STR(lineno,6)=lcItem+STR(loFormSet.lnLineNo,6)) AND;
  clotNo=lcLotNo INTO DBF (oAriaApplication.WorkDir+loFormSet.lcTmpTkt) &&sql
  SELECT * FROM TMPPOSLN WHERE IIF(LOFORMSET.LNLINENO=0,.T.,STYLE+STR(LINENO,6)=LCITEM) AND;
    CLOTNO=LCLOTNO INTO DBF (OARIAAPPLICATION.WORKDIR+LOFORMSET.LCTMPTKT) &&sql
  *B608531,1 WAM 04/23/2008 (End)

  INDEX ON STR(LINENO,6)+CRSESSION+TRANCD+CSTYGRADE TAG (LOFORMSET.LCTMPTKT)
  USE IN TMPPOSLN

  SELECT IIF(LOFORMSET.ACTIVEMODE="V",'APInvTkt',LOFORMSET.LCAPINVTKT)
  SET RELATION TO STR(LINENO,6)+CRSESSION+IIF(CRECVTYPE='R','21',IIF(CRECVTYPE='S','42','43')) INTO (LOFORMSET.LCTMPTKT) ADDITIVE
  LOCONTFORM.LCBROWQTY = LOFORMSET.LCTMPTKT+'.TotQty'
  LOCONTFORM.LCBROWCST = LOFORMSET.LCTMPTKT+'.NFLANCOST'

CASE LOFORM.LCTKTTYPE = 'M'
  LOFORMSET.LCFILEINUSE = 'CutTktL'
  LOCONTFORM.LCLNFLDNAME = 'CutTktL.NFLANCOST' &&sql
  LOCONTFORM.LCACFLDNAME = 'CutTktL.NFACTCOST'
  LOCONTFORM.LCRCVQTY    = 'CutTktL.TotQty'
  *Old: SET ORDER TO TAG CUTREC IN CUTTKTL
  LOFORMSET.CUTTKTL.SETORDER('POSREC') &&Sql ;
  *CBUSDOCU+CSTYTYPE+PO+CRSESSION+SHIPNO+CINVTYPE+STYLE+STR(LINENO,6)+TRANCD+CSTYGRADE ;
  (CRSESSION+CUTTKT+STYLE+TRANCD)

  *CBUSDOCU+CSTYTYPE+PO+CINVTYPE+STYLE+STR(LINENO,6)+TRANCD && POSLN Tag
  LCSQLSTATEMENT = "SELECT * FROM POSLN (INDEX=POSLN) WHERE "+;
    "CBUSDOCU='P' AND CSTYTYPE='U' AND PO='"+LOCONTFORM.LCTICKET+"'"
  LNRESULT=OARIAAPPLICATION.REMOTECOMPANYDATA.SQLRUN(LCSQLSTATEMENT,'TmpPosln','POSLN',;
    OARIAAPPLICATION.ACTIVECOMPANYCONSTR,3,'SAVE',LOFORMSET.DATASESSIONID)
  IF LNRESULT<1
    OARIAAPPLICATION.REMOTECOMPANYDATA.CHECKRETRESULT("execute",LNRESULT,.T.)
    IF !EMPTY(LCALIAS)
      SELECT (LCALIAS)
    ENDIF
    *WAIT WINDOW LINENO()
    RETURN .F.
  ENDIF
  SELECT * FROM TMPPOSLN WHERE IIF(LOFORMSET.LNLINENO=0,.T.,;
    STYLE+STR(LINENO,6)=LCITEM+STR(LOFORMSET.LNLINENO,6)) ;
    INTO DBF (OARIAAPPLICATION.WORKDIR+LOFORMSET.LCTMPTKT) &&sql
  INDEX ON STR(LINENO,6)+CRSESSION+TRANCD+CSTYGRADE TAG (LOFORMSET.LCTMPTKT)
  USE IN TMPPOSLN

  SELECT IIF(LOFORMSET.ACTIVEMODE="V",'APInvTkt',LOFORMSET.LCAPINVTKT)
  SET RELATION TO STR(LINENO,6)+CRSESSION+IIF(CRECVTYPE='R','21',IIF(CRECVTYPE='S','42','43')) INTO (LOFORMSET.LCTMPTKT) ADDITIVE
  LOCONTFORM.LCBROWQTY = LOFORMSET.LCTMPTKT+'.TotQty'
  LOCONTFORM.LCBROWCST = LOFORMSET.LCTMPTKT+'.NFLANCOST'

CASE INLIST(LOFORM.LCTKTTYPE,'L','F')
  LOFORMSET.LCFILEINUSE = 'POFLN'
  LOCONTFORM.LCLNFLDNAME = 'POFLN.NFLANCOST' &&sql
  LOCONTFORM.LCACFLDNAME = 'POFLN.NFACTCOST'
  LOCONTFORM.LCRCVQTY    = 'POFLN.TOTQTY'
  *Old: SET ORDER TO TAG POFREC IN POFLN
  LOFORMSET.POFLN.SETORDER('POSREC') &&Sql ;
  *CBUSDOCU+CSTYTYPE+PO+CRSESSION+SHIPNO+CINVTYPE+STYLE+STR(LINENO,6)+TRANCD+CSTYGRADE ;
  (CMATTYPE+POMAT+CRSESSION+FABRIC+COLOR+TRANCD)

  LCTEMP = IIF(LOFORM.LCTKTTYPE='L','PM','RM')
  LCSQLSTATEMENT = "SELECT * FROM POSLN (INDEX=POSLN) WHERE "+;
    "CBUSDOCU='"+LEFT(LCTEMP,1)+"' AND CSTYTYPE='"+RIGHT(LCTEMP,1)+"' "+;
    "AND PO='"+LOCONTFORM.LCTICKET+"'"
  LNRESULT=OARIAAPPLICATION.REMOTECOMPANYDATA.SQLRUN(LCSQLSTATEMENT,'TmpPosln','POSLN',;
    OARIAAPPLICATION.ACTIVECOMPANYCONSTR,3,'SAVE',LOFORMSET.DATASESSIONID)
  IF LNRESULT<1
    OARIAAPPLICATION.REMOTECOMPANYDATA.CHECKRETRESULT("execute",LNRESULT,.T.)
    IF !EMPTY(LCALIAS)
      SELECT (LCALIAS)
    ENDIF
    WAIT WINDOW LINENO()
    RETURN .F.
  ENDIF
  SELECT * FROM TMPPOSLN WHERE IIF(LOFORMSET.LNLINENO=0,.T.,;
    STYLE+STR(LINENO,6)=LCITEM+STR(LOFORMSET.LNLINENO,6));
    INTO DBF (OARIAAPPLICATION.WORKDIR+LOFORMSET.LCTMPTKT) &&sql
  INDEX ON STR(LINENO,6)+CRSESSION+TRANCD+CSTYGRADE TAG (LOFORMSET.LCTMPTKT)

  USE IN TMPPOSLN

  SELECT IIF(LOFORMSET.ACTIVEMODE="V",'APInvTkt',LOFORMSET.LCAPINVTKT)
  SET RELATION TO STR(LINENO,6)+CRSESSION+IIF(CRECVTYPE='R','21',IIF(CRECVTYPE='S','42','43')) INTO (LOFORMSET.LCTMPTKT) ADDITIVE
  LOCONTFORM.LCBROWQTY = LOFORMSET.LCTMPTKT+'.TOTQTY'
  LOCONTFORM.LCBROWCST = LOFORMSET.LCTMPTKT+'.NFLANCOST'

CASE LOFORM.LCTKTTYPE = 'T'
  LOFORMSET.LCFILEINUSE = 'MMFGORDD'
  LOCONTFORM.LCLNFLDNAME = 'MMFGORDD.NFLANCOST' &&sql
  LOCONTFORM.LCACFLDNAME = 'MMFGORDD.NFACTCOST'
  LOCONTFORM.LCRCVQTY    = 'MMFGORDD.TOTQTY'

  *CBUSDOCU+CSTYTYPE+PO+CINVTYPE+STYLE+STR(LINENO,6)+TRANCD && POSLN Tag
  LCSQLSTATEMENT = "SELECT * FROM POSLN (INDEX=POSLN) WHERE "+;
    "CBUSDOCU='P' AND CSTYTYPE='F' AND PO='"+LOCONTFORM.LCTICKET+"'"
  LNRESULT=OARIAAPPLICATION.REMOTECOMPANYDATA.SQLRUN(LCSQLSTATEMENT,'TmpPosln','POSLN',;
    OARIAAPPLICATION.ACTIVECOMPANYCONSTR,3,'SAVE',LOFORMSET.DATASESSIONID)
  IF LNRESULT<1
    OARIAAPPLICATION.REMOTECOMPANYDATA.CHECKRETRESULT("execute",LNRESULT,.T.)
    IF !EMPTY(LCALIAS)
      SELECT (LCALIAS)
    ENDIF
    WAIT WINDOW LINENO()
    RETURN .F.
  ENDIF
  SELECT * FROM TMPPOSLN WHERE IIF(LOFORMSET.LNLINENO=0,.T.,;
    STYLE+STR(LINENO,6)=LCITEM+STR(LOFORMSET.LNLINENO,6)) ;
    INTO DBF (OARIAAPPLICATION.WORKDIR+LOFORMSET.LCTMPTKT) &&sql
  *INDEX ON cRSession+STYLE+SPACE(12)+color+TranCd+CSTYGRADE TAG (loFormSet.lcTmpTkt)
  *! B610111,1 MMT 10/11/2012 Modify Payable invoice screen to handle MFG order case[Start]
  *  INDEX ON CRSESSION+STYLE+TRANCD+CSTYGRADE TAG (LOFORMSET.LCTMPTKT)
  INDEX ON STR(LINENO,6)+CRSESSION+TRANCD+CSTYGRADE TAG (LOFORMSET.LCTMPTKT)
  *! B610111,1 MMT 10/11/2012 Modify Payable invoice screen to handle MFG order case[End]
  USE IN TMPPOSLN

  SELECT IIF(LOFORMSET.ACTIVEMODE="V",'APInvTkt',LOFORMSET.LCAPINVTKT)
  *SET RELATION TO cRSession+item+color+IIF(cRecvType='R','21',IIF(cRecvType='S','42','43')) INTO (loFormSet.lcTmpTkt) ADDITIVE
  *! B610111,1 MMT 10/11/2012 Modify Payable invoice screen to handle MFG order case[Start]
  *  SET RELATION TO CRSESSION+STYLE+IIF(CRECVTYPE='R','21',IIF(CRECVTYPE='S','42','43')) INTO (LOFORMSET.LCTMPTKT) ADDITIVE
  SET RELATION TO STR(LINENO,6)+CRSESSION+IIF(CRECVTYPE='R','21',IIF(CRECVTYPE='S','42','43')) INTO (LOFORMSET.LCTMPTKT) ADDITIVE
  *! B610111,1 MMT 10/11/2012 Modify Payable invoice screen to handle MFG order case[ENd]
  LOCONTFORM.LCBROWQTY = LOFORMSET.LCTMPTKT+'.TOTQTY'
  LOCONTFORM.LCBROWCST = LOFORMSET.LCTMPTKT+'.NFLANCOST'

ENDCASE
IF LOFORMSET.ACTIVEMODE="V"
  SELECT DISTINCT CRSESSION FROM APINVTKT ;
    WHERE CVENDCODE+CAPINVNO+CAPVILNO+CRSESSION = ;
    PADR(LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE,8)+PADR(LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE,12)+LOCONTFORM.LCINVLINENO AND !EMPTY(CRSESSION);
    INTO ARRAY LOCONTFORM.LARSESSION
ELSE
  SELECT DISTINCT CRSESSION FROM (LOFORMSET.LCAPINVTKT) ;
    WHERE CVENDCODE+CAPINVNO+CAPVILNO+CRSESSION = ;
    PADR(LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE,8)+PADR(LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE,12)+LOCONTFORM.LCINVLINENO AND !EMPTY(CRSESSION);
    INTO ARRAY LOCONTFORM.LARSESSION
ENDIF
SELECT IIF(LOFORMSET.ACTIVEMODE="V",'APInvTkt',LOFORMSET.LCAPINVTKT)

LOCONTFORM.LCPOPSTAT = IIF(_TALLY > 0 .AND. !LOFORMSET.LLCLOSED,'ENABLE','DISABLE')
LOCONTFORM.LCREMSTAT = IIF(_TALLY > 0 .AND. !LOFORMSET.ACTIVEMODE="V" .AND. !LOFORMSET.LLCLOSED,'ENABLE','DISABLE')
LOCONTFORM.LCNEWSTAT = IIF(!LOFORMSET.ACTIVEMODE="V" .AND. !LOFORMSET.LLCLOSED,'ENABLE','DISABLE')


IF _TALLY = 0
  DECLARE LOCONTFORM.LARSESSION[1]
  STORE '' TO LOCONTFORM.LARSESSION
ENDIF
LOCONTFORM.CBOSESSION.REQUERY()
STORE 1 TO LOCONTFORM.CBOSESSION.VALUE
SET KEY TO
=SEEK(PADR(LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE,8)+PADR(LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE,12)+LOCONTFORM.LCINVLINENO+SPACE(6))
LOCONTFORM.LNCNTRBAMNT = LOCONTFORM.LNAPLAMNT - IIF(LOFORMSET.ACTIVEMODE="V",APINVTKT.NAPAPLAMNT,EVALUATE(LOFORMSET.LCAPINVTKT+'.nApAplAmnt'))
SET KEY TO PADR(LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE,8)+PADR(LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE,12)+LOCONTFORM.LCINVLINENO+LOCONTFORM.LARSESSION[loContform.cboSession.Value]
=SEEK(PADR(LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE,8)+PADR(LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE,12)+LOCONTFORM.LCINVLINENO+LOCONTFORM.LARSESSION[loContform.cboSession.Value])
SET FILTER TO !EMPTY(CRSESSION)
GO TOP
SCATTER NAME LOCONTFORM.LOREC

WITH LOCONTFORM.GRDCONTLINES

  .COLUMNCOUNT = 0
  .RECORDSOURCE = IIF(LOFORMSET.ACTIVEMODE="V",'APInvTkt',LOFORMSET.LCAPINVTKT)
  LNCOL='0'

  IF LOFORM.LCTKTTYPE='S'
    LNCOL = ALLTRIM(STR(VAL(LNCOL)+1))
    .COLUMNCOUNT = VAL(LNCOL)
    .COLUMN&LNCOL..CONTROLSOURCE = "cTktNo"
    *N000682,1 MMT 11/20/2012 Globalization Changes[Start]
    *    .COLUMN&LNCOL..HEADER1.CAPTION = 'PO#'
    *N000682,1 11/20/2012 MMT Globlization changes[Start]
*.COLUMN&LNCOL..HEADER1.CAPTION =LANG_APPYINV_PO
.COLUMN&LNCOL..HEADER1.CAPTION =IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_PO,loFormSet.GetHeaderText("LANG_APPYINV_PO",loFormSet.HeaderAlias))
*N000682,1 11/20/2012 MMT Globlization changes[End]

    *N000682,1 MMT 11/20/2012 Globalization Changes[End]



    .COLUMN&LNCOL..WIDTH = 75

    LNCOL = ALLTRIM(STR(VAL(LNCOL)+1))
    .COLUMNCOUNT = VAL(LNCOL)
    .COLUMN&LNCOL..CONTROLSOURCE = "cApdGlAct"
    *N000682,1 11/20/2012 MMT Globlization changes[Start]
    *    .COLUMN&LNCOL..HEADER1.CAPTION = 'WIP Account'
    *N000682,1 11/20/2012 MMT Globlization changes[Start]
*.COLUMN&LNCOL..HEADER1.CAPTION =LANG_APPYINV_WIP_ACCOUNT
.COLUMN&LNCOL..HEADER1.CAPTION =IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_WIP_ACCOUNT,loFormSet.GetHeaderText("LANG_APPYINV_WIP_ACCOUNT",loFormSet.HeaderAlias))
*N000682,1 11/20/2012 MMT Globlization changes[End]

    *N000682,1 MMT 11/20/2012 Globalization Changes[End]



    .COLUMN&LNCOL..WIDTH = 75
  ENDIF

  IF INLIST(LOFORM.LCTKTTYPE,'I','S','M','R','A','D')
    LNCOL = ALLTRIM(STR(VAL(LNCOL)+1))
    .COLUMNCOUNT = VAL(LNCOL)
    .COLUMN&LNCOL..CONTROLSOURCE = "Item"
    .COLUMN&LNCOL..HEADER1.CAPTION = LOFORM.CNTSTYLE.LBLITEMHEADER.CAPTION
    .COLUMN&LNCOL..WIDTH = 150
  ELSE
    LNCOL = ALLTRIM(STR(VAL(LNCOL)+1))
    .COLUMNCOUNT = VAL(LNCOL)
    .COLUMN&LNCOL..CONTROLSOURCE = "SUBSTR(Item,1,"+ALLTRIM(STR(LOFORMSET.LNFABMAJLEN))+")"
    *N000682,1 MMT 11/20/2012 Globalization Changes[Start]
    *    .COLUMN&LNCOL..HEADER1.CAPTION = 'Fabric'
    *N000682,1 11/20/2012 MMT Globlization changes[Start]
*.COLUMN&LNCOL..HEADER1.CAPTION =LANG_APPYINV_FABRIC
.COLUMN&LNCOL..HEADER1.CAPTION =IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_FABRIC,loFormSet.GetHeaderText("LANG_APPYINV_FABRIC",loFormSet.HeaderAlias))
*N000682,1 11/20/2012 MMT Globlization changes[End]

    *N000682,1 11/20/2012 MMT Globlization changes[End]

    .COLUMN&LNCOL..WIDTH = 100
    LNCOL = ALLTRIM(STR(VAL(LNCOL)+1))
    .COLUMNCOUNT = VAL(LNCOL)
    .COLUMN&LNCOL..CONTROLSOURCE = "Color"
    *N000682,1 11/20/2012 MMT Globlization changes[Start]
    *    .COLUMN&LNCOL..HEADER1.CAPTION = 'Color'
    *N000682,1 11/20/2012 MMT Globlization changes[Start]
*.COLUMN&LNCOL..HEADER1.CAPTION =LANG_APPYINV_COLOR
.COLUMN&LNCOL..HEADER1.CAPTION =IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_COLOR,loFormSet.GetHeaderText("LANG_APPYINV_COLOR",loFormSet.HeaderAlias))
*N000682,1 11/20/2012 MMT Globlization changes[End]

    *N000682,1 11/20/2012 MMT Globlization changes[End]

    .COLUMN&LNCOL..WIDTH = 75
  ENDIF

  IF LOFORMSET.LLWAREHOUS
    LNCOL = ALLTRIM(STR(VAL(LNCOL)+1))
    .COLUMNCOUNT = VAL(LNCOL)
    .COLUMN&LNCOL..CONTROLSOURCE = "cWareCode"
    *N000682,1 MMT 11/20/2012 Globalization Changes[Start]
    *    .COLUMN&LNCOL..HEADER1.CAPTION = 'Warehouse'
    *N000682,1 11/20/2012 MMT Globlization changes[Start]
*.COLUMN&LNCOL..HEADER1.CAPTION =LANG_APPYINV_WAREHOUSE
.COLUMN&LNCOL..HEADER1.CAPTION =IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_WAREHOUSE,loFormSet.GetHeaderText("LANG_APPYINV_WAREHOUSE",loFormSet.HeaderAlias))
*N000682,1 11/20/2012 MMT Globlization changes[End]

    *N000682,1 MMT 11/20/2012 Globalization Changes[End]



    .COLUMN&LNCOL..WIDTH = 75
  ENDIF

  LNCOL = ALLTRIM(STR(VAL(LNCOL)+1))
  .COLUMNCOUNT = VAL(LNCOL)
  .COLUMN&LNCOL..CONTROLSOURCE = LOCONTFORM.LCBROWQTY
  *N000682,1 MMT 11/20/2012 Globalization Changes[Start]
  *  .COLUMN&LNCOL..HEADER1.CAPTION = 'Rec. Qty'
  *N000682,1 11/20/2012 MMT Globlization changes[Start]
*.COLUMN&LNCOL..HEADER1.CAPTION =LANG_APPYINV_REC_QTY
.COLUMN&LNCOL..HEADER1.CAPTION =IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_REC_QTY,loFormSet.GetHeaderText("LANG_APPYINV_REC_QTY",loFormSet.HeaderAlias))
*N000682,1 11/20/2012 MMT Globlization changes[End]

  *N000682,1 11/20/2012 MMT Globlization changes[End]

  .COLUMN&LNCOL..WIDTH = 75
  LNCOL = ALLTRIM(STR(VAL(LNCOL)+1))
  .COLUMNCOUNT = VAL(LNCOL)
  .COLUMN&LNCOL..CONTROLSOURCE = LOCONTFORM.LCBROWCST+LOFORM.LCCSTTYPE
  *N000682,1 MMT 11/20/2012 Globalization Changes[Start]
  *  .COLUMN&LNCOL..HEADER1.CAPTION = 'Rec. Cost'
  *N000682,1 11/20/2012 MMT Globlization changes[Start]
*.COLUMN&LNCOL..HEADER1.CAPTION =LANG_APPYINV_REC_COST
.COLUMN&LNCOL..HEADER1.CAPTION =IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_REC_COST,loFormSet.GetHeaderText("LANG_APPYINV_REC_COST",loFormSet.HeaderAlias))
*N000682,1 11/20/2012 MMT Globlization changes[End]

  *N000682,1 MMT 11/20/2012 Globalization Changes[End]

  .COLUMN&LNCOL..WIDTH = 75
  .COLUMN&LNCOL..INPUTMASK = '999999.999'
  LNCOL = ALLTRIM(STR(VAL(LNCOL)+1))
  .COLUMNCOUNT = VAL(LNCOL)
  .COLUMN&LNCOL..CONTROLSOURCE = LOCONTFORM.LCBROWQTY+'*'+LOCONTFORM.LCBROWCST+LOFORM.LCCSTTYPE
  *N000682,1 MMT 11/22/2012 Globalization changes[Start]
  *.COLUMN&LNCOL..HEADER1.CAPTION = IIF(LOFORM.LCTKTTYPE$'RF','Ex Isse Cst','Ex Rec Cst')
  *N000682,1 11/20/2012 MMT Globlization changes[Start]
*.COLUMN&LNCOL..HEADER1.CAPTION = IIF(LOFORM.LCTKTTYPE$'RF',LANG_APPYINV_EXISSCST,LANG_APPYINV_EXRECCST)
.COLUMN&LNCOL..HEADER1.CAPTION = IIF(LOFORM.LCTKTTYPE$'RF',IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_EXISSCST,loFormSet.GetHeaderText("LANG_APPYINV_EXISSCST",loFormSet.HeaderAlias)),IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_EXRECCST,loFormSet.GetHeaderText("LANG_APPYINV_EXRECCST",loFormSet.HeaderAlias)))
*N000682,1 11/20/2012 MMT Globlization changes[End]

  *N000682,1 MMT 11/22/2012 Globalization changes[End]
  .COLUMN&LNCOL..WIDTH = 75
  .COLUMN&LNCOL..INPUTMASK = '999999.999'

  LNCOL = ALLTRIM(STR(VAL(LNCOL)+1))
  .COLUMNCOUNT = VAL(LNCOL)
  .COLUMN&LNCOL..CONTROLSOURCE = "nApTAplQty"
  *N000682,1 MMT 11/20/2012 Globalization Changes[Start]
  *  .COLUMN&LNCOL..HEADER1.CAPTION = 'Inv. Qty.'
  *N000682,1 11/20/2012 MMT Globlization changes[Start]
*.COLUMN&LNCOL..HEADER1.CAPTION =LANG_APPYINV_INV_QTY
.COLUMN&LNCOL..HEADER1.CAPTION =IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_INV_QTY,loFormSet.GetHeaderText("LANG_APPYINV_INV_QTY",loFormSet.HeaderAlias))
*N000682,1 11/20/2012 MMT Globlization changes[End]

  *N000682,1 MMT 11/20/2012 Globalization Changes[End]



  .COLUMN&LNCOL..WIDTH = 75
  LNCOL = ALLTRIM(STR(VAL(LNCOL)+1))
  .COLUMNCOUNT = VAL(LNCOL)
  .COLUMN&LNCOL..CONTROLSOURCE = "nApAplPric"
  *N000682,1 MMT 11/20/2012 Globalization Changes[Start]
  *  .COLUMN&LNCOL..HEADER1.CAPTION = 'Inv. Cst.'
  *N000682,1 11/20/2012 MMT Globlization changes[Start]
*.COLUMN&LNCOL..HEADER1.CAPTION =LANG_APPYINV_INV_CST
.COLUMN&LNCOL..HEADER1.CAPTION =IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_INV_CST,loFormSet.GetHeaderText("LANG_APPYINV_INV_CST",loFormSet.HeaderAlias))
*N000682,1 11/20/2012 MMT Globlization changes[End]

  *N000682,1 MMT 11/20/2012 Globalization Changes[End]

  .COLUMN&LNCOL..WIDTH = 75
  LNCOL = ALLTRIM(STR(VAL(LNCOL)+1))
  .COLUMNCOUNT = VAL(LNCOL)
  .COLUMN&LNCOL..CONTROLSOURCE = "ROUND(nApAplAmnt,2)"
  *N000682,1 MMT 11/20/2012 Globalization Changes[Start]
  *  .COLUMN&LNCOL..HEADER1.CAPTION = 'Inv. Amnt.'
  *N000682,1 11/20/2012 MMT Globlization changes[Start]
*.COLUMN&LNCOL..HEADER1.CAPTION =LANG_APPYINV_INV_AMNT
.COLUMN&LNCOL..HEADER1.CAPTION =IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_INV_AMNT,loFormSet.GetHeaderText("LANG_APPYINV_INV_AMNT",loFormSet.HeaderAlias))
*N000682,1 11/20/2012 MMT Globlization changes[End]

  *N000682,1 MMT 11/20/2012 Globalization Changes[End]


  .COLUMN&LNCOL..WIDTH = 75

  LNCOL = ALLTRIM(STR(VAL(LNCOL)+1))
  .COLUMNCOUNT = VAL(LNCOL)
  .COLUMN&LNCOL..CONTROLSOURCE = "ROUND("+LOFORMSET.LCAPPLIED+".nAPlAmnt,2)"
  *N000682,1 11/20/2012 MMT Globlization changes[Start]
  *  .COLUMN&LNCOL..HEADER1.CAPTION = 'Act Cst'
  *N000682,1 11/20/2012 MMT Globlization changes[Start]
*.COLUMN&LNCOL..HEADER1.CAPTION =LANG_APPYINV_ACT_CST
.COLUMN&LNCOL..HEADER1.CAPTION =IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_ACT_CST,loFormSet.GetHeaderText("LANG_APPYINV_ACT_CST",loFormSet.HeaderAlias))
*N000682,1 11/20/2012 MMT Globlization changes[End]

  *N000682,1 11/20/2012 MMT Globlization changes[End]

  .COLUMN&LNCOL..WIDTH = 75
  .COLUMN&LNCOL..INPUTMASK = '9999999.999'
  LNCOL = ALLTRIM(STR(VAL(LNCOL)+1))
  .COLUMNCOUNT = VAL(LNCOL)
  .COLUMN&LNCOL..CONTROLSOURCE = "nApAplAmnt/ThisForm.lnAplAmnt*100"
  *N000682,1 MMT 11/20/2012 Globalization Changes[Start]
  *  .COLUMN&LNCOL..HEADER1.CAPTION = 'Con. %'
  *N000682,1 11/20/2012 MMT Globlization changes[Start]
*.COLUMN&LNCOL..HEADER1.CAPTION =LANG_APPYINV_CON
.COLUMN&LNCOL..HEADER1.CAPTION =IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_CON,loFormSet.GetHeaderText("LANG_APPYINV_CON",loFormSet.HeaderAlias))
*N000682,1 11/20/2012 MMT Globlization changes[End]

  *N000682,1 MMT 11/20/2012 Globalization Changes[End]


  .COLUMN&LNCOL..WIDTH = 75
  .COLUMN&LNCOL..INPUTMASK = '999.99'

ENDWITH

=LFWCNTRBSCR(LOFORMSET, LOFORM, LOCONTFORM)

RETURN
*-- End of lfContInit


*!*************************************************************
*! Name      : lfContDestroy
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 11/07/2004
*! Purpose   : Called From the Destroy Event of the Contribution Screen
*!*************************************************************
*! Parameters: The FormSet of APPYINV.SCX, The Form of APINVDT.SCX, The Form of APMATST.SCX
*!*************************************************************
*! Returns   :  None
*!*************************************************************
FUNCTION LFCONTDESTROY
PARAMETERS LOFORMSET, LOFORM, LOCONTFORM

USE IN (LOFORMSET.LCAPPLIED)
SELECT IIF(LOFORMSET.ACTIVEMODE="V",'ApInvTkt',LOFORMSET.LCAPINVTKT)  &&lower
SET RELATION TO
SET KEY TO
SET FILTER TO
IF !LOFORMSET.ACTIVEMODE="V"

  *Add these lines to take into consideration that the
  *          uncontributed record should be deleted if the amount is totally
  *          contributed. And so, if the amount was totally contributed we
  *          are going to delete the uncontributed record, and if not we
  *          will restore this record if it has been deleted [Begin]
  LCSETDELET = SET('DELETED')
  SET DELETED OFF

  IF SEEK(PADR(LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE,8)+PADR(LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE,12)+LOCONTFORM.LCINVLINENO+SPACE(6))
    REPLACE NAPAPLAMNT WITH LOCONTFORM.LNAPLAMNT - LOCONTFORM.LNCNTRBAMNT
  ELSE
    INSERT INTO (LOFORMSET.LCAPINVTKT) (CVENDCODE,CAPINVNO,CAPVILNO,CSTATUS,CIMTYP,CTKTNO) VALUES  ;
      (LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE,;
      LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE,EVALUATE(LOFORMSET.LCAPVINVDT+'.cApVILNo'),;
      'A',EVALUATE(LOFORMSET.LCAPVINVDT+'.cIMTyp'),EVALUATE(LOFORMSET.LCAPVINVDT+'.cTktNo'))

    REPLACE LINENO     WITH EVALUATE(LOFORMSET.LCAPVINVDT+'.LineNo')     ,;
      ITEM       WITH EVALUATE(LOFORMSET.LCAPVINVDT+'.Item')       ,;
      COLOR      WITH EVALUATE(LOFORMSET.LCAPVINVDT+'.Color')      ,;
      CDYELOT    WITH EVALUATE(LOFORMSET.LCAPVINVDT+'.cDyelot')    ,;
      NAPAPLQTY1 WITH EVALUATE(LOFORMSET.LCAPVINVDT+'.nApAprQty1') ,;
      NAPAPLQTY2 WITH EVALUATE(LOFORMSET.LCAPVINVDT+'.nApAprQty2') ,;
      NAPAPLQTY3 WITH EVALUATE(LOFORMSET.LCAPVINVDT+'.nApAprQty3') ,;
      NAPAPLQTY4 WITH EVALUATE(LOFORMSET.LCAPVINVDT+'.nApAprQty4') ,;
      NAPAPLQTY5 WITH EVALUATE(LOFORMSET.LCAPVINVDT+'.nApAprQty5') ,;
      NAPAPLQTY6 WITH EVALUATE(LOFORMSET.LCAPVINVDT+'.nApAprQty6') ,;
      NAPAPLQTY7 WITH EVALUATE(LOFORMSET.LCAPVINVDT+'.nApAprQty7') ,;
      NAPAPLQTY8 WITH EVALUATE(LOFORMSET.LCAPVINVDT+'.nApAprQty8') ,;
      NAPTAPLQTY WITH EVALUATE(LOFORMSET.LCAPVINVDT+'.nApTAprQty') ,;
      NAPAPLPRIC WITH EVALUATE(LOFORMSET.LCAPVINVDT+'.nAPAprPric') ,;
      NAPAPLAMNT WITH LOCONTFORM.LNAPLAMNT - LOCONTFORM.LNCNTRBAMNT ,;
      CSTATUS    WITH IIF(CSTATUS='S','M',CSTATUS)
  ENDIF

  *Add these lines to take into consideration that the
  *          uncontributed record should be deleted if the amount is totally
  *          contributed. And so, if the amount was totally contributed we
  *          are going to delete the uncontributed record, and if not we
  *          will restore this record if it has been deleted [Begin]
  *-- if the amount is totally contributed


  *We should check the TmpDist file for Shipmnet [Start]

  IF LOCONTFORM.LNAPLAMNT = LOCONTFORM.LNCNTRBAMNT
    REPLACE CSTATUS WITH IIF(NRECNO = 0 , 'S' , 'D')
    DELETE        && Delete the uncontributed record
  ELSE    && Else (if the amount is partially contributed)
    RECALL        && Recall the uncontributed record
    REPLACE CSTATUS WITH IIF(NRECNO = 0 , 'A' , 'M')
  ENDIF

  SET DELETED &LCSETDELET        && Restore the old SET DELETED status
  *Add these lines to take into consideration [End]
ENDIF

*In some case the Vendor field saved with blank value. [Start]
IF !LOFORMSET.ACTIVEMODE="V"
  SELECT (LOFORMSET.LCAPVINVDT)
  SCAN FOR EMPTY(CVENDCODE) OR EMPTY(CAPINVNO)
    REPLACE CVENDCODE WITH PADR(LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE,8),;
      CAPINVNO WITH PADR(LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE,12)
  ENDSCAN
ENDIF
*In some case the Vendor code field saved with blank value [End]
SELECT IIF(LOFORMSET.ACTIVEMODE="V",'APVINVDT2',LOFORMSET.LCAPVINVDT)
=SEEK(PADR(LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE,8)+PADR(LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE,12)+LOCONTFORM.LCINVLINENO)  &&lower  &&lower
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*SCATTER NAME loForm.loRec
SCATTER NAME LOFORMSET.LOREC
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
*=lfShowWind(loFormSet,loForm)

RETURN
*-- End of lfContDestroy


*!*************************************************************
*! Name      : lfWCntrbScr
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 11/07/2004
*! Purpose   : Called From the AfterRowColChange Event of the Grid in Contribution Screen
*!*************************************************************
*! Parameters: The FormSet of APPYINV.SCX, The Form of APINVDT.SCX, The Form of APMATST.SCX
*!*************************************************************
*! Returns   :  None
*!*************************************************************
FUNCTION LFWCNTRBSCR
PARAMETERS LOFORMSET, LOFORM, LOCONTFORM

*Old: loContForm.lnCMarker = RECNO()
*Old: SHOW WINDOW (loContForm.lcCntrbBr) REFRESH SAME
LOCONTFORM.LNTRECQTY=EVALUATE(LOCONTFORM.LCBROWQTY)
LOCONTFORM.LNRECCOST=EVAL(LOCONTFORM.LCBROWCST+LOFORM.LCCSTTYPE)
*MAN Added Round 2
LOCONTFORM.LNRECAMNT=ROUND(EVALUATE(LOCONTFORM.LCBROWQTY+'*'+LOCONTFORM.LCBROWCST+LOFORM.LCCSTTYPE),2)

LOCONTFORM.LNTACTQTY=EVALUATE(LOFORMSET.LCAPPLIED+'.nAplQty')
LOCONTFORM.LNACTAMNT=EVALUATE(LOFORMSET.LCAPPLIED+'.nAplAmnt')
LOCONTFORM.LNACTCOST=IIF(LOCONTFORM.LNTACTQTY=0,0,LOCONTFORM.LNACTAMNT/LOCONTFORM.LNTACTQTY)
SCATTER NAME LOCONTFORM.LOREC

STORE LOCONTFORM.LLSHOWSIZE TO LOCONTFORM.CNTRECQTY.VISIBLE, LOCONTFORM.CNTACTQTY.VISIBLE, ;
  LOCONTFORM.CNTAPAPLQTY.VISIBLE
IF LOCONTFORM.LLSHOWSIZE
  LOCONTFORM.LNRECQTY1=EVALUATE(LOFORMSET.LCTMPTKT+'.Qty1')
  LOCONTFORM.LNRECQTY2=EVALUATE(LOFORMSET.LCTMPTKT+'.Qty2')
  LOCONTFORM.LNRECQTY3=EVALUATE(LOFORMSET.LCTMPTKT+'.Qty3')
  LOCONTFORM.LNRECQTY4=EVALUATE(LOFORMSET.LCTMPTKT+'.Qty4')
  LOCONTFORM.LNRECQTY5=EVALUATE(LOFORMSET.LCTMPTKT+'.Qty5')
  LOCONTFORM.LNRECQTY6=EVALUATE(LOFORMSET.LCTMPTKT+'.Qty6')
  LOCONTFORM.LNRECQTY7=EVALUATE(LOFORMSET.LCTMPTKT+'.Qty7')
  LOCONTFORM.LNRECQTY8=EVALUATE(LOFORMSET.LCTMPTKT+'.Qty8')
  LOCONTFORM.LNACTQTY1=EVALUATE(LOFORMSET.LCAPPLIED+'.nAplQty1')
  LOCONTFORM.LNACTQTY2=EVALUATE(LOFORMSET.LCAPPLIED+'.nAplQty2')
  LOCONTFORM.LNACTQTY3=EVALUATE(LOFORMSET.LCAPPLIED+'.nAplQty3')
  LOCONTFORM.LNACTQTY4=EVALUATE(LOFORMSET.LCAPPLIED+'.nAplQty4')
  LOCONTFORM.LNACTQTY5=EVALUATE(LOFORMSET.LCAPPLIED+'.nAplQty5')
  LOCONTFORM.LNACTQTY6=EVALUATE(LOFORMSET.LCAPPLIED+'.nAplQty6')
  LOCONTFORM.LNACTQTY7=EVALUATE(LOFORMSET.LCAPPLIED+'.nAplQty7')
  LOCONTFORM.LNACTQTY8=EVALUATE(LOFORMSET.LCAPPLIED+'.nAplQty8')
  LOCONTFORM.TXTAPTAPLQTY.ENABLED = .F.
  *Old: =lfRefresh('APMATST2')
  LOCONTFORM.REFRESH()
ELSE
  *Old: =lfRefresh('APMATST3')
  LOCONTFORM.TXTAPTAPLQTY.ENABLED = .T.
  LOCONTFORM.REFRESH()
ENDIF
LCSTATUS=IIF(EMPTY(LOCONTFORM.LARSESSION) OR LOFORMSET.ACTIVEMODE="V",'DISABLE','ENABLE')
*Old: SHOW GET m.nApAplQty1 &lcStatus &&Revise
*Old: SHOW GET m.nApAplQty2 &lcStatus &&Revise
*Old: SHOW GET m.nApAplQty3 &lcStatus &&Revise
*Old: SHOW GET m.nApAplQty4 &lcStatus &&Revise
*Old: SHOW GET m.nApAplQty5 &lcStatus &&Revise
*Old: SHOW GET m.nApAplQty6 &lcStatus &&Revise
*Old: SHOW GET m.nApAplQty7 &lcStatus &&Revise
*Old: SHOW GET m.nApAplQty8 &lcStatus &&Revise
*Old: SHOW GET m.nApAplQty1 &lcStatus &&Revise

*Old: SHOW GET m.nApTAplQty &lcStatus &&Revise
*Old: SHOW GET loContForm.loRec.nAPAplPric &lcStatus &&Revise
*Old: SHOW GET m.nApAplAmnt &lcStatus &&Revise

WITH LOCONTFORM
  *STORE (lcStatus='ENABLE') TO .txtApTAplQty.Enabled, .txtAPAplPric.Enabled, ;
  .txtApAplAmnt.Enabled, .cntApAplQty.Enabled
  STORE (LCSTATUS='ENABLE') TO .TXTAPAPLPRIC.ENABLED, .TXTAPAPLAMNT.ENABLED, .CNTAPAPLQTY.ENABLED
  .CBOSESSION.ENABLED = !EOF(LOFORMSET.LCAPINVTKT)
ENDWITH

RETURN
*-- End of lfWCntrbScr


*!*************************************************************
*! Name      : lfvAplRSess
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 11/07/2004
*! Purpose   : Called From the Valid Event of the Session ComboBox in Contribution Screen
*!*************************************************************
*! Parameters: The FormSet of APPYINV.SCX, The Form of APINVDT.SCX, The Form of APMATST.SCX
*!*************************************************************
*! Returns   :  None
*!*************************************************************
FUNCTION LFVAPLRSESS
PARAMETERS LOFORMSET, LOFORM, LOCONTFORM

SET KEY TO PADR(LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE,8)+PADR(LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE,12)+LOCONTFORM.LCINVLINENO+LOCONTFORM.LARSESSION[loContform.cboSession.Value]
=SEEK(PADR(LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE,8)+PADR(LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE,12)+LOCONTFORM.LCINVLINENO+LOCONTFORM.LARSESSION[loContform.cboSession.Value])
LOCATE REST WHILE CVENDCODE+CAPINVNO+CAPVILNO+CRSESSION = ;
  PADR(LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE,8)+PADR(LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE,12)+LOCONTFORM.LCINVLINENO+LOCONTFORM.LARSESSION[loContform.cboSession.Value] ;
  FOR !EMPTY(CRSESSION)
=LFWCNTRBSCR(LOFORMSET, LOFORM, LOCONTFORM)

RETURN
*-- End of lfvAplRSess


*!*************************************************************
*! Name      : lfvAplQty
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 11/07/2004
*! Purpose   : Called From the Valid Event of the Qtys Container in Contribution Screen
*!*************************************************************
*! Parameters: The FormSet of APPYINV.SCX, The Form of APINVDT.SCX, The Form of APMATST.SCX
*!*************************************************************
*! Returns   :  True / False
*!*************************************************************
FUNCTION LFVAPLQTY
PARAMETERS LOFORMSET, LOFORM, LOCONTFORM, LCSIZE

LOCAL LCTEMP

IF TYPE('lcSize')='N'
  LCSIZE = ALLTRIM(STR(LCSIZE))
ENDIF

IF !EMPTY(LCSIZE) AND BETWEEN(VAL(LCSIZE),1,8)
  LOCONTFORM.LOREC.NAPTAPLQTY = LOCONTFORM.LOREC.NAPTAPLQTY-NAPAPLQTY&LCSIZE+LOCONTFORM.LOREC.NAPAPLQTY&LCSIZE
ENDIF
IF LOCONTFORM.LOREC.NAPTAPLQTY  <> NAPTAPLQTY
  *Message : 04171
  *The invoice quantity Cannot be greater than the received Quantity
  *Button : 00000
  *Ok

  *Message : 04172
  *Increasing the invoice quantity causes the total contributed
  *amount to be greater than the total cost
  *Button : 00000
  *Ok
  *N000682,1 MMT 11/22/2012 Globalization changes[Start]
  *IF (LOCONTFORM.LOREC.NAPTAPLQTY > EVALUATE(LOCONTFORM.LCBROWQTY) AND ;
      GFMODALGEN('TRM04171B00000' , 'ALERT' ,;
      'The invoice quantity|The received quantity.') = 1) OR ;
      (ABS(LOCONTFORM.LNCNTRBAMNT - NAPAPLAMNT + LOCONTFORM.LOREC.NAPTAPLQTY * NAPAPLPRIC) >;
      ABS(LOCONTFORM.LNAPLAMNT) AND ;
      GFMODALGEN('TRM04172B00000' , 'ALERT' , 'invoice quantity') = 1)
  IF (LOCONTFORM.LOREC.NAPTAPLQTY > EVALUATE(LOCONTFORM.LCBROWQTY) AND ;
      GFMODALGEN('TRM04171B00000' , 'ALERT' ,;
      'The invoice quantity|The received quantity.') = 1) OR ;
      (ABS(LOCONTFORM.LNCNTRBAMNT - NAPAPLAMNT + LOCONTFORM.LOREC.NAPTAPLQTY * NAPAPLPRIC) >;
      ABS(LOCONTFORM.LNAPLAMNT) AND ;
GFMODALGEN('TRM04172B00000' , 'ALERT' , IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_INVOICEQUANTITY,loFormSet.GetHeaderText("LANG_INVOICEQUANTITY",loFormSet.HeaderAlias))) = 1)

  *N000682,1 MMT 11/22/2012 Globalization changes[END]
    LOCONTFORM.LOREC.NAPTAPLQTY = NAPTAPLQTY
    IF !EMPTY(LCSIZE)
      LOCONTFORM.LOREC.NAPAPLQTY&LCSIZE = NAPAPLQTY&LCSIZE
    ENDIF
    RETURN
  ENDIF
  LOCONTFORM.LNCNTRBAMNT  = LOCONTFORM.LNCNTRBAMNT - NAPAPLAMNT + LOCONTFORM.LOREC.NAPTAPLQTY*NAPAPLPRIC
  *Fix the contribution process [Begin]
  IF CSTATUS = 'S'
    REPLACE CSTATUS WITH 'D'
    DELETE
    APPEND BLANK
    GATHER MEMVAR MEMO
    REPLACE CSTATUS WITH 'A';
      NRECNO WITH 0
  ENDIF
  *Fix the contribution process [End]

  LOCONTFORM.LOREC.NAPAPLPRIC = IIF(LOCONTFORM.LOREC.NAPTAPLQTY=0,0,LOCONTFORM.LOREC.NAPAPLPRIC)
  LOCONTFORM.LOREC.NAPAPLAMNT = LOCONTFORM.LOREC.NAPTAPLQTY * LOCONTFORM.LOREC.NAPAPLPRIC
  REPLACE NAPTAPLQTY WITH LOCONTFORM.LOREC.NAPTAPLQTY ,;
    NAPAPLAMNT WITH LOCONTFORM.LOREC.NAPAPLAMNT ,;
    NAPAPLPRIC WITH LOCONTFORM.LOREC.NAPAPLPRIC
  IF !EMPTY(LCSIZE)
    REPLACE NAPAPLQTY&LCSIZE WITH LOCONTFORM.LOREC.NAPAPLQTY&LCSIZE
  ENDIF

  *Add these lines to update the status field to "Modified" in
  *          the temp. Invoice Detail file (lcAPvInvDt) if the user
  *          changed the contribution of the line [Begin]

  *-- If the status of the temp. Invoice Detail file (lcAPvInvDt) record
  *-- is "Same".
  LCTEMP = LOFORMSET.LCAPVINVDT+'.cStatus'
  IF EVALUATE(LOFORMSET.LCAPVINVDT+'.cStatus') = 'S'
    REPLACE &LCTEMP WITH 'M' IN (LOFORMSET.LCAPVINVDT)
  ENDIF
  *Add these lines to update the status field to "Modified" [End]

  *Old: =lfRefresh('APMATST0')
  LOCONTFORM.REFRESH()
  *Old: =IIF(loContForm.llShowSize,lfRefresh('APMATST2'),lfRefresh('APMATST3'))
  *Old: SHOW GET loContForm.loRec.nAPAplAmnt &&Revise
  *Old: SHOW GET loContForm.loRec.nAPAplPric &&Revise
  LOCONTFORM.TXTAPAPLAMNT.REFRESH()
  LOCONTFORM.TXTAPAPLPRIC.REFRESH()

  *Old: SHOW WINDOW (loContForm.lcCntrbBr) REFRESH SAME
ENDIF

RETURN
*-- End of lfvAplQty


*!*************************************************************
*! Name      : lfvAplPrice
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 11/07/2004
*! Purpose   : Called From the Valid Event of the Unit Cost Control in Contribution Screen
*!*************************************************************
*! Parameters: The FormSet of APPYINV.SCX, The Form of APINVDT.SCX, The Form of APMATST.SCX
*!*************************************************************
*! Returns   :  True / False
*!*************************************************************
FUNCTION LFVAPLPRICE
PARAMETERS LOFORMSET, LOFORM, LOCONTFORM

LOCAL LCTEMP

*Fix bug when Saving the debit memo againest Return PO [BEGIN]
IF (LOCONTFORM.LOREC.CIMTYP $ 'RF' OR LOFORMSET.LLDEBITM) AND (LOCONTFORM.LOREC.NAPAPLPRIC > 0)
  LOCONTFORM.LOREC.NAPAPLPRIC = LOCONTFORM.LOREC.NAPAPLPRIC * -1
ENDIF
*Fix bug when Saving the debit memo againest Return PO [END]


IF LOCONTFORM.LOREC.NAPAPLPRIC <> NAPAPLPRIC
  *Add these lines to make sure that the "Approved Amount" and
  *          the "Applied Amount" have the same sign [Begin]

  *-- If the "Approved Amount" and the "Applied Amount" have different signs
  IF SIGN(LOCONTFORM.LOREC.NAPAPLPRIC) <> 0 .AND.;
      SIGN(LOCONTFORM.LOREC.NAPAPLPRIC) <> SIGN(EVALUATE(LOFORMSET.LCAPVINVDT+'.nAPAprPric'))

    *-- Message : 04185
    *-- "Approved amount and applied amount must have the same sign.   "
    *-- Button : 00000
    *-- "                         <    Ok    >                         "
    =GFMODALGEN('TRM04185B00000' , 'ALERT')

    LOCONTFORM.LOREC.NAPAPLPRIC = NAPAPLPRIC        && Restore the old value
    RETURN
  ENDIF
  *Add these lines to make sure that the "Approved Amount" [End]

  LNOLDCONT = LOCONTFORM.LNCNTRBAMNT
  LOCONTFORM.LNCNTRBAMNT = LOCONTFORM.LNCNTRBAMNT - NAPAPLAMNT + NAPTAPLQTY*LOCONTFORM.LOREC.NAPAPLPRIC
  IF ABS(LOCONTFORM.LNCNTRBAMNT) - ABS(NAPAPLAMNT) + ABS(LOCONTFORM.LOREC.NAPAPLAMNT) > ABS(LOCONTFORM.LNAPLAMNT)

    *Message : 04172
    *Increasing the unit cost causes the total contributed
    *amount to be greater than the total cost
    *Button : 00000
    *Ok
    =GFMODALGEN('TRM04172B00000','ALERT','unit cost')
    LOCONTFORM.LOREC.NAPAPLPRIC = NAPAPLPRIC
    *Fix the contribution process [Begin]
    LOCONTFORM.LNCNTRBAMNT = LNOLDCONT
    *Fix the contribution process [End]
    RETURN
  ENDIF
  IF CSTATUS = 'S'
    REPLACE CSTATUS WITH 'D'
    DELETE
    APPEND BLANK
    GATHER MEMVAR MEMO
    REPLACE CSTATUS WITH 'A';
      NRECNO WITH 0
  ENDIF
  LOCONTFORM.LOREC.NAPAPLAMNT=LOCONTFORM.LOREC.NAPTAPLQTY * LOCONTFORM.LOREC.NAPAPLPRIC
  REPLACE NAPAPLPRIC WITH LOCONTFORM.LOREC.NAPAPLPRIC,;
    NAPAPLAMNT WITH LOCONTFORM.LOREC.NAPAPLAMNT

  *Add these lines to update the status field to "Modified" in
  *          the temp. Invoice Detail file (lcAPvInvDt) if the user
  *          changed the contribution of the line [Begin]

  *-- If the status of the temp. Invoice Detail file (lcAPvInvDt) record
  *-- is "Same".
  IF EVALUATE(LOFORMSET.LCAPVINVDT+'.cStatus') = 'S'
    LCTEMP = LOFORMSET.LCAPVINVDT+'.cStatus'
    REPLACE &LCTEMP WITH 'M' IN (LOFORMSET.LCAPVINVDT)
  ENDIF
  *Add these lines to update the status field to "Modified" [End]

  *=lfRefresh('APMATST0')
  *Old: SHOW GET loContForm.loRec.nAPAplAmnt &&Revise
  LOCONTFORM.TXTAPAPLAMNT.REFRESH()
  *SHOW WINDOW (loContForm.lcCntrbBr) REFRESH SAME
  LOCONTFORM.REFRESH()
ENDIF

RETURN
*-- End of lfvAplPrice

*!*************************************************************
*! Name      : lfvAplAMnt
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 11/07/2004
*! Purpose   : Called From the Valid Event of the Total Amount Control in Contribution Screen
*!*************************************************************
*! Parameters: The FormSet of APPYINV.SCX, The Form of APINVDT.SCX, The Form of APMATST.SCX
*!*************************************************************
*! Returns   :  True / False
*!*************************************************************
FUNCTION LFVAPLAMNT
PARAMETERS LOFORMSET, LOFORM, LOCONTFORM

LOCAL LCTEMP

*Fix bug when Saving the debit memo againest Return PO [BEGIN]
IF (LOCONTFORM.LOREC.CIMTYP $ 'RF' OR LOFORMSET.LLDEBITM) AND (LOCONTFORM.LOREC.NAPAPLAMNT > 0)
  LOCONTFORM.LOREC.NAPAPLAMNT = LOCONTFORM.LOREC.NAPAPLAMNT * -1
ENDIF
*Fix bug when Saving the debit memo againest Return PO [END]

IF LOCONTFORM.LOREC.NAPAPLAMNT <> NAPAPLAMNT

  *Add these lines to make sure that the "Approved Amount" and
  *          the "Applied Amount" have the same sign [Begin]

  *-- If the "Approved Amount" and the "Applied Amount" have different signs
  IF SIGN(LOCONTFORM.LOREC.NAPAPLAMNT) <> 0 .AND.;
      SIGN(LOCONTFORM.LOREC.NAPAPLAMNT) <> SIGN(EVALUATE(LOFORMSET.LCAPVINVDT+'.nAPAprAmnt'))

    *-- Message : 04185
    *-- "Approved amount and applied amount must have the same sign.   "
    *-- Button : 00000
    *-- "                         <    Ok    >                         "
    =GFMODALGEN('TRM04185B00000' , 'ALERT')

    LOCONTFORM.LOREC.NAPAPLAMNT = NAPAPLAMNT        && Restore the old value
    RETURN
  ENDIF
  *Add these lines to make sure that the "Approved Amount" [End]


  IF ABS(LOCONTFORM.LNCNTRBAMNT - NAPAPLAMNT + LOCONTFORM.LOREC.NAPAPLAMNT) > ABS(LOCONTFORM.LNAPLAMNT)
    *Message : 04123
    *The Total Contributed AMount Cannot be greater than the total cost
    *Button : 00000
    *Ok
    =GFMODALGEN('TRM04123B00000','ALERT')
    LOCONTFORM.LOREC.NAPAPLAMNT = NAPAPLAMNT
    RETURN
  ENDIF
  LOCONTFORM.LNCNTRBAMNT = LOCONTFORM.LNCNTRBAMNT - NAPAPLAMNT+ LOCONTFORM.LOREC.NAPAPLAMNT
  * MAN Added the following line
  *Fix the contribution process [Begin]
  IF CSTATUS = 'S'
    REPLACE CSTATUS WITH 'D'
    DELETE
    APPEND BLANK
    GATHER MEMVAR MEMO
    REPLACE CSTATUS WITH 'A';
      NRECNO WITH 0
  ENDIF
  *Fix the contribution process [End]
  LOCONTFORM.LOREC.NAPAPLAMNT = LOCONTFORM.LOREC.NAPAPLAMNT * 1.000
  LOCONTFORM.LOREC.NAPAPLPRIC =IIF(NAPTAPLQTY=0,0,LOCONTFORM.LOREC.NAPAPLAMNT/NAPTAPLQTY)
  REPLACE NAPAPLAMNT WITH LOCONTFORM.LOREC.NAPAPLAMNT ,;
    NAPAPLPRIC WITH LOCONTFORM.LOREC.NAPAPLPRIC

  *Add these lines to update the status field to "Modified" in
  *          the temp. Invoice Detail file (lcAPvInvDt) if the user
  *          changed the contribution of the line [Begin]

  *-- If the status of the temp. Invoice Detail file (lcAPvInvDt) record
  *-- is "Same".
  IF EVALUATE(LOFORMSET.LCAPVINVDT+'.cStatus') = 'S'
    LCTEMP = LOFORMSET.LCAPVINVDT+'.cStatus'
    REPLACE &LCTEMP WITH 'M' IN (LOFORMSET.LCAPVINVDT)
  ENDIF
  *Add these lines to update the status field to "Modified" [End]

  *Old: =lfRefresh('APMATST0')
  *Old: SHOW GET loContForm.loRec.nAPAplPric &&Revise
  LOCONTFORM.TXTAPAPLPRIC.REFRESH()
  *SHOW WINDOW (loContForm.lcCntrbBr) REFRESH SAME
  LOCONTFORM.REFRESH()
ENDIF

RETURN
*-- End of lfvAplAMnt


*!*************************************************************
*! Name      : lfvNewCntrb
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 11/07/2004
*! Purpose   : Called From the Click Event of the New command button in Contribution Screen
*!*************************************************************
*! Parameters: The FormSet of APPYINV.SCX, The Form of APINVDT.SCX, The Form of APMATST.SCX
*!*************************************************************
*! Returns   :  None
*!*************************************************************
FUNCTION LFVNEWCNTRB
PARAMETERS LOFORMSET, LOFORM, LOCONTFORM

LOCONTFORM.LCCONTITEM = EVALUATE(LOFORMSET.LCAPVINVDT+'.Item')
LOCONTFORM.LCCONTCLR  = EVALUATE(LOFORMSET.LCAPVINVDT+'.Color')
STORE SPACE(6) TO LOCONTFORM.KBRSESSION
STORE LOCONTFORM.LNAPLAMNT - LOCONTFORM.LNCNTRBAMNT TO LOCONTFORM.LNAMOUNT
STORE 1 TO LOCONTFORM.RBCNTRB

DO WHILE .T.
  LOCONTFORM.LLPROCEED=.F.
  *DO FORM (OARIAAPPLICATION.SCREENHOME+"\AP\APMATST5.SCX") WITH LOCONTFORM
  *! E303029,1 MMT 12/26/2011 correct the calling of non-major programs within the SaaS environemnt[STart]
  *DO FORM (oAriaApplication.ScreenHome+"\AP\APMATST5.SCX") WITH loContForm
  =GFCALLFORM('APMATST5','AP',"loContForm")
  *! E303029,1 MMT 12/26/2011 correct the calling of non-major programs within the SaaS environemnt[END]
  *ASM, I think we don't need this section of Code [Start]
  *IF loFormSet.llBrowse
  *=lfvRSession(loForm.lcTktType,IIF(lcTktType='S',loContForm.lcShipNo,loContForm.lcTicket),.F.,loContForm.lcContItem,loContForm.lcContClr,loForm.lcCstType)  &&lower  &&lower
  *lnCurObj = 3&&Old CurObj
  *LOOP
  *ENDIF
  *ASM, I think we don't need this section of Code [End]


  IF LOCONTFORM.LLPROCEED
    IF EMPTY(LOCONTFORM.KBRSESSION)
      *Message : 04066
      *You have to enter the Receiving Session#
      *Button : 00000
      *Ok
      *N000682,1 MMT 11/22/2012 Globalization changes[Start]
      *=GFMODALGEN('TRM04066B00000','ALERT','Receiving Session #')
      *N000682,1 11/20/2012 MMT Globlization changes[Start]
*=GFMODALGEN('TRM04066B00000','ALERT',LANG_RECEIVINGSESSIONNUMBER)
=GFMODALGEN('TRM04066B00000','ALERT',IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_RECEIVINGSESSIONNUMBER,loFormSet.GetHeaderText("LANG_RECEIVINGSESSIONNUMBER",loFormSet.HeaderAlias)))
*N000682,1 11/20/2012 MMT Globlization changes[End]

      *N000682,1 MMT 11/22/2012 Globalization changes[END]
      *Old: lnCurObj = 2&&Old CurObj
      LOOP
    ENDIF

    IF ABS(LOCONTFORM.LNAMOUNT) <= 0

      *Message : 04121
      *The cost amount must be greater
      *Button : 00000
      *Ok
      =GFMODALGEN('TRM04121B00000','ALERT')
      *Old: lnCurObj = 3&&Old CurObj
      LOOP
    ENDIF

    *Add these lines to make sure that the "Approved Amount" and
    *          the "Applied Amount" have the same sign [Begin]

    *-- If the "Approved Amount" and the "Applied Amount" have
    *-- different signs.
    IF SIGN(LOCONTFORM.LNAMOUNT) <> SIGN(EVALUATE(LOFORMSET.LCAPVINVDT+'.nApAprAmnt'))

      *-- Message : 04185
      *-- "Invoice amount and approved amount must have the same sign."
      *-- Button : 00000
      *-- "                          <    Ok    >                     "
      =GFMODALGEN('TRM04185B00000' , 'ALERT')

      *Old: lnCurObj = 3&&Old CurObj
      LOOP
    ENDIF
    *Add these lines to make sure that the "Approved Amount" [End]

    IF ABS(LOCONTFORM.LNAMOUNT+LOCONTFORM.LNCNTRBAMNT) > ABS(EVALUATE(LOFORMSET.LCAPVINVDT+'.nApAprAmnt'))
      *Message : 04175
      *Applied Amount Cannot exceed Approved Amount
      *Button : 00000
      *Ok
      =GFMODALGEN('TRM04175B00000','ALERT')
      *Old: lnCurObj = OBJNUM(loContForm.lnAmount)&&Old CurObj
      *Old: lnCurObj = 3&&Old CurObj
      LOOP
    ENDIF
    IF SEEK(PADR(LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE,8)+PADR(LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE,12)+LOCONTFORM.LCINVLINENO+LOCONTFORM.KBRSESSION,LOFORMSET.LCAPINVTKT)
      *Message : 04127
      *This cost item has been applied to
      *Button : 00000
      *Ok
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *!*	      lcMsgTxt=loForm.laTktType[loForm.cboTktType.Value,3]+' '+;
      *!*	               EVALUATE(loFormSet.lcAPvInvDt+'.cTktNo')+' Session#: '+loContForm.kbRSession
      *N000682,1 MMT 11/22/2012 Globalization changes[Start]
      *LCMSGTXT=LOFORMSET.LATKTTYPE[loForm.cboTktType.Value,3]+' '+;
      *  EVALUATE(LOFORMSET.LCAPVINVDT+'.cTktNo')+' Session#: '+LOCONTFORM.KBRSESSION
      LCMSGTXT=LOFORMSET.LATKTTYPE[loForm.cboTktType.Value,3]+' '+;
EVALUATE(LOFORMSET.LCAPVINVDT+'.cTktNo')+IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_S_RECEIVINGSESSIONNUMBER,loFormSet.GetHeaderText("LANG_S_RECEIVINGSESSIONNUMBER",loFormSet.HeaderAlias))+LOCONTFORM.KBRSESSION

      *N000682,1 MMT 11/22/2012 Globalization changes[END]
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      =GFMODALGEN("TRM04127B00000","DIALOG",LCMSGTXT)
      *Old: lnCurObj = 2&&Old CurObj
      LOOP
    ENDIF

    IF !INLIST(LOFORM.LCTKTTYPE,'L','R','F','A') AND LOCONTFORM.RBCNTRB = 1
      LOCONTFORM.LCMFGCODE = LOFORM.LCOPRCODE

      *ASM, Key of Boomline index in case of Shipment and non shipment
      *CIMTYP+CTYPE+CBOMTYP+MFGCODE+SHIPNO+CRSESSION+CTKTNO+STR(LINENO,6)+CINVTYPE+STYLE+CSTYGRADE ;
      *CIMTYP+CTYPE+CBOMTYP+MFGCODE+CTKTNO+CRSESSION+SHIPNO+STR(LINENO,6)+CINVTYPE+STYLE+CSTYGRADE ;

      IF EMPTY(LOCONTFORM.LCCONTITEM)
        IF INLIST(LOFORM.LCTKTTYPE,'S','I','M') AND LOFORM.LCOPRCODE=REPLICATE('*',6) AND ;
            IIF(LOFORM.LCTKTTYPE='S',LOFORMSET.BOMLINE.SEEK('I2'+LOFORM.LCCSTTYPE+PADR('*'+LOFORM.LCCSTTYPE,6)+LOCONTFORM.LCSHIPNO+LOCONTFORM.KBRSESSION) OR ;
            LOFORMSET.BOMLINE.SEEK('I2'+LOFORM.LCCSTTYPE+'******'+LOCONTFORM.LCSHIPNO+LOCONTFORM.KBRSESSION),;
            LOFORMSET.BOMLINE.SEEK(LOFORM.LCTKTTYPE+'2'+LOFORM.LCCSTTYPE+PADR('*'+LOFORM.LCCSTTYPE,6)+LOCONTFORM.LCTICKET+LOCONTFORM.KBRSESSION) OR ;
            LOFORMSET.BOMLINE.SEEK(LOFORM.LCTKTTYPE+'2'+LOFORM.LCCSTTYPE+'******'+LOCONTFORM.LCTICKET+LOCONTFORM.KBRSESSION)) &&sql
          LOCONTFORM.LCMFGCODE = PADR(BOMLINE.MFGCODE,6)
        ENDIF
        IF INLIST(LOFORM.LCTKTTYPE,'S','I','M') AND LOFORM.LCOPRCODE=REPLICATE('#',6) AND ;
            IIF(LOFORM.LCTKTTYPE='S',LOFORMSET.BOMLINE.SEEK('I2'+LOFORM.LCCSTTYPE+PADR('*'+LOFORM.LCCSTTYPE,6)+LOCONTFORM.LCSHIPNO+LOCONTFORM.KBRSESSION) OR ;
            LOFORMSET.BOMLINE.SEEK('I2'+LOFORM.LCCSTTYPE+'######'+LOCONTFORM.LCSHIPNO+LOCONTFORM.KBRSESSION),;
            LOFORMSET.BOMLINE.SEEK(LOFORM.LCTKTTYPE+'2'+LOFORM.LCCSTTYPE+PADR('*'+LOFORM.LCCSTTYPE,6)+LOCONTFORM.LCTICKET+LOCONTFORM.KBRSESSION) OR ;
            LOFORMSET.BOMLINE.SEEK(LOFORM.LCTKTTYPE+'2'+LOFORM.LCCSTTYPE+'######'+LOCONTFORM.LCTICKET+LOCONTFORM.KBRSESSION)) &&sql
          LOCONTFORM.LCMFGCODE = PADR(BOMLINE.MFGCODE,6)
        ENDIF
      ELSE
        IF INLIST(LOFORM.LCTKTTYPE,'S','I','M') AND LOFORM.LCOPRCODE=REPLICATE('*',6)
          =SEEK(PADR(LOCONTFORM.LCCONTITEM,19),'STYLE')
          LOCONTFORM.LCMFGCODE=IIF(!STYLE.LDETCOST,PADR('*'+LOFORM.LCCSTTYPE,6),LOFORM.LCOPRCODE)
        ENDIF
        IF INLIST(LOFORM.LCTKTTYPE,'S','I','M') AND LOFORM.LCOPRCODE=REPLICATE('#',6)
          =SEEK(PADR(LOCONTFORM.LCCONTITEM,19),'STYLE')
          LOCONTFORM.LCMFGCODE=IIF(!STYLE.LDETCOST,PADR('*'+LOFORM.LCCSTTYPE,6),LOFORM.LCOPRCODE)
        ENDIF
      ENDIF
      *Check if Style is not empty [End]
      IF IIF(LOFORM.LCTKTTYPE='S',!LOFORMSET.BOMLINE.SEEK('I2'+LOFORM.LCCSTTYPE+LOCONTFORM.LCMFGCODE+LOCONTFORM.LCSHIPNO+LOCONTFORM.KBRSESSION),;
          !LOFORMSET.BOMLINE.SEEK(LOFORM.LCTKTTYPE+'2'+LOFORM.LCCSTTYPE+LOCONTFORM.LCMFGCODE+LOCONTFORM.LCTICKET+LOCONTFORM.KBRSESSION)) &&sql
        *Message : 04122
        *The entered cost type does not exist in the budget for this receiving.
        *You cannot make your contribution based on the budget cost.
        *Button : 00000
        *Ok
        =GFMODALGEN("TRM04122B00000","DIALOG")
        *Old: lnCurObj = 4&&Old CurObj
        LOOP
      ENDIF
    ENDIF

    *Add these lines to update the status field to "Modified" in
    *          the temp. Invoice Detail file (lcAPvInvDt) if the user
    *          changed the contribution of the line [Begin]

    *-- If the status of the temp. Invoice Detail file (lcAPvInvDt) record
    *-- is "Same".
    IF EVALUATE(LOFORMSET.LCAPVINVDT+'.cStatus') = 'S'
      SELECT (LOFORMSET.LCAPVINVDT)
      REPLACE CSTATUS WITH 'M'
    ENDIF
    *Add these lines to update the status field to "Modified" [End]

    =LFVPROCNTRB(LOFORMSET, LOFORM, LOCONTFORM)
  ENDIF
  *Old: RELEASE WINDOW 'APMATST5'
  EXIT
ENDDO

DO CASE
CASE LOFORM.LCTKTTYPE = 'S'
  *Old: SET ORDER TO TAG Poshrec IN POSLN
  LOFORMSET.POSLN.SETORDER('POSHREC')  &&Sql ;
  *SHIPNO+CRSESSION+CBUSDOCU+CSTYTYPE+PO+CINVTYPE+STYLE+STR(LINENO,6)+TRANCD ;
  (SHIPNO+CRSESSION+CSTYTYPE+PO+STYLE+STR(LINENO,6)+TRANCD)
CASE INLIST(LOFORM.LCTKTTYPE,'I','R','A','D')
  *Old: SET ORDER TO TAG Posrec IN POSLN
  LOFORMSET.POSLN.SETORDER('POSREC') &&Sql ;
  *CBUSDOCU+CSTYTYPE+PO+CRSESSION+SHIPNO+CINVTYPE+STYLE+STR(LINENO,6)+TRANCD+CSTYGRADE ;
  (CSTYTYPE+PO+CRSESSION+SHIPNO+STYLE+STR(LINENO,6)+TRANCD)
CASE LOFORM.LCTKTTYPE = 'M'
  *Old: SET ORDER TO TAG Cutrec IN CutTktL
  LOFORMSET.CUTTKTL.SETORDER('POSREC') &&Sql ;
  *CBUSDOCU+CSTYTYPE+PO+CRSESSION+SHIPNO+CINVTYPE+STYLE+STR(LINENO,6)+TRANCD+CSTYGRADE ;
  (CRSESSION+CUTTKT+STYLE+TRANCD)
CASE INLIST(LOFORM.LCTKTTYPE,'L','F')
  *Old: SET ORDER TO TAG POFREC IN POFLN
  LOFORMSET.POFLN.SETORDER('POSREC') &&Sql ;
  *CBUSDOCU+CSTYTYPE+PO+CRSESSION+SHIPNO+CINVTYPE+STYLE+STR(LINENO,6)+TRANCD+CSTYGRADE ;
  (CMATTYPE+POMAT+CRSESSION+FABRIC+COLOR+TRANCD)
CASE LOFORM.LCTKTTYPE = 'T'
  *Old: SET ORDER TO TAG MFGREC IN MMFGORDD
  LOFORMSET.MMFGORDD.SETORDER('POSREC') &&Sql ;
  *CBUSDOCU+CSTYTYPE+PO+CRSESSION+SHIPNO+CINVTYPE+STYLE+STR(LINENO,6)+TRANCD+CSTYGRADE

ENDCASE

SET ENGINEBEHAVIOR 70
SELECT DISTINCT CRSESSION FROM (LOFORMSET.LCAPINVTKT) ;
  WHERE CVENDCODE+CAPINVNO+CAPVILNO+CRSESSION = ;
  PADR(LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE,8)+PADR(LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE,12)+LOCONTFORM.LCINVLINENO AND !EMPTY(CRSESSION);
  INTO ARRAY LOCONTFORM.LARSESSION

IF _TALLY = 0
  DECLARE LOCONTFORM.LARSESSION[1]
  STORE '' TO LOCONTFORM.LARSESSION
  STORE 1 TO LOCONTFORM.CBOSESSION.VALUE
  *Old: SHOW GET loContform.cboSession.Value DISABLE &&Revise
  LOCONTFORM.CBOSESSION.ENABLED = .F.
ELSE
  STORE IIF(LOCONTFORM.LLPROCEED,ASCAN(LOCONTFORM.LARSESSION,LOCONTFORM.KBRSESSION),LOCONTFORM.CBOSESSION.VALUE) TO LOCONTFORM.CBOSESSION.VALUE
  *Old: SHOW GET loContform.cboSession.Value ENABLE &&Revise
  LOCONTFORM.CBOSESSION.ENABLED = .T.
  *Old: SHOW GET pbRemCntrb ENABLE &&Revise
  LOCONTFORM.CMDREMOVE.ENABLED = .F.
ENDIF
SELECT (LOFORMSET.LCAPINVTKT)
=LFVAPLRSESS(LOFORMSET, LOFORM, LOCONTFORM)
*Old: =lfRefresh('APMATST0')
LOCONTFORM.REFRESH()

RETURN
*-- End of lfvNewCntrb


*!*************************************************************
*! Name      : lfvRemCntrb
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 11/07/2004
*! Purpose   : Called From the Click Event of the Remove command button in Contribution Screen
*!*************************************************************
*! Parameters: The FormSet of APPYINV.SCX, The Form of APINVDT.SCX, The Form of APMATST.SCX
*!*************************************************************
*! Returns   :  None
*!*************************************************************
FUNCTION LFVREMCNTRB
PARAMETERS LOFORMSET, LOFORM, LOCONTFORM

PRIVATE LNTAPLQTY,LNAPLAMNT,LNAPLQTY1,LNAPLQTY2,LNAPLQTY3,;
  LNAPLQTY4,LNAPLQTY5,LNAPLQTY6,LNAPLQTY7,LNAPLQTY8

IF .T.
  STORE 0 TO  LNTAPLQTY,LNAPLAMNT,LNAPLQTY1,LNAPLQTY2,LNAPLQTY3,;
    LNAPLQTY4,LNAPLQTY5,LNAPLQTY6,LNAPLQTY7,LNAPLQTY8

  SELECT (LOFORMSET.LCAPINVTKT)
  =SEEK(PADR(LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE,8)+PADR(LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE,12)+LOCONTFORM.LCINVLINENO+LOCONTFORM.LARSESSION[loContform.cboSession.Value])
  SCAN REST WHILE CVENDCODE+CAPINVNO+CAPVILNO+CRSESSION  = ;
      PADR(LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE,8)+PADR(LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE,12)+LOCONTFORM.LCINVLINENO+LOCONTFORM.LARSESSION[loContform.cboSession.Value]

    LNTAPLQTY = LNTAPLQTY + NAPTAPLQTY
    LNAPLAMNT = LNAPLAMNT + NAPAPLAMNT
    LNAPLQTY1 = LNAPLQTY1 + NAPAPLQTY1
    LNAPLQTY2 = LNAPLQTY2 + NAPAPLQTY2
    LNAPLQTY3 = LNAPLQTY3 + NAPAPLQTY3
    LNAPLQTY4 = LNAPLQTY4 + NAPAPLQTY4
    LNAPLQTY5 = LNAPLQTY5 + NAPAPLQTY5
    LNAPLQTY6 = LNAPLQTY6 + NAPAPLQTY6
    LNAPLQTY7 = LNAPLQTY7 + NAPAPLQTY7
    LNAPLQTY8 = LNAPLQTY8 + NAPAPLQTY8

    *Fix the contribution process  to save the invoice [Begin]

    REPLACE CSTATUS WITH IIF(!EMPTY(NRECNO),'D','S')
    *Fix the contribution process  to save the invoice [End]
    DELETE
  ENDSCAN
  SET KEY TO

  =SEEK(PADR(LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE,8)+PADR(LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE,12)+LOCONTFORM.LCINVLINENO+SPACE(6))
  REPLACE NAPAPLQTY1 WITH NAPAPLQTY1 + LNAPLQTY1 ,;
    NAPAPLQTY2 WITH NAPAPLQTY2 + LNAPLQTY2 ,;
    NAPAPLQTY3 WITH NAPAPLQTY3 + LNAPLQTY3 ,;
    NAPAPLQTY4 WITH NAPAPLQTY4 + LNAPLQTY4 ,;
    NAPAPLQTY5 WITH NAPAPLQTY5 + LNAPLQTY5 ,;
    NAPAPLQTY6 WITH NAPAPLQTY6 + LNAPLQTY6 ,;
    NAPAPLQTY7 WITH NAPAPLQTY7 + LNAPLQTY7 ,;
    NAPAPLQTY8 WITH NAPAPLQTY8 + LNAPLQTY8 ,;
    NAPTAPLQTY WITH NAPTAPLQTY + LNTAPLQTY ,;
    NAPAPLAMNT WITH NAPAPLAMNT + LNAPLAMNT ,;
    NAPAPLPRIC WITH IIF(NAPTAPLQTY=0,0,NAPAPLAMNT/NAPTAPLQTY) ,;
    CSTATUS    WITH IIF(CSTATUS='S','M',CSTATUS)
  LOCONTFORM.LNCNTRBAMNT = LOCONTFORM.LNCNTRBAMNT - LNAPLAMNT

  =ADEL(LOCONTFORM.LARSESSION,LOCONTFORM.CBOSESSION.VALUE)
  LOCONTFORM.CBOSESSION.VALUE = 1

  *Fix the contribution process [Begin]
  SELECT (LOFORMSET.LCAPVINVDT)
  LLSEEK = SEEK(PADR(LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE,8)+PADR(LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE,12)+LOCONTFORM.LCINVLINENO)
  IF LLSEEK
    REPLACE CSTATUS WITH IIF(CSTATUS='S','M',CSTATUS)
  ENDIF
  SELECT (LOFORMSET.LCAPINVTKT)
  *Fix the contribution process [End]
  IF ALEN(LOCONTFORM.LARSESSION) > 1
    DECLARE LOCONTFORM.LARSESSION[ALEN(loContForm.laRSession)-1]
    *Old: SHOW GET loContform.cboSession.Value ENABLE &&Revise
    LOCONTFORM.CBOSESSION.ENABLED = .T.
  ELSE
    STORE '' TO LOCONTFORM.LARSESSION
    *Old: SHOW GET loContform.cboSession.Value DISABLE &&Revise
    LOCONTFORM.CBOSESSION.ENABLED = .F.
    *Old: SHOW GET pbRemCntrb DISABLE &&Revise
    LOCONTFORM.CMDREMOVE.ENABLED = .F.
  ENDIF
  *Old: =lfRefresh('APMATST0')
  LOCONTFORM.REFRESH()
  =LFVAPLRSESS(LOFORMSET, LOFORM, LOCONTFORM)
ENDIF

RETURN
*-- End of lfvRemCntrb




*!*************************************************************
*! Name      : lfvProCntrb
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 11/07/2004
*! Purpose   : Called From the Click Event of the Proceed command button in Sub Contribution Screen
*!*************************************************************
*! Parameters: The FormSet of APPYINV.SCX, The Form of APINVDT.SCX, The Form of APMATST.SCX
*!*************************************************************
*! Returns   :  None
*!*************************************************************
FUNCTION LFVPROCNTRB
PARAMETERS LOFORMSET, LOFORM, LOCONTFORM
PRIVATE LCRCVQTY, LCLNFLDNAME, LCACFLDNAME
LOCAL LOTEMP

LCRCVQTY = LOCONTFORM.LCRCVQTY
LCLNFLDNAME = LOCONTFORM.LCLNFLDNAME
LCACFLDNAME = LOCONTFORM.LCACFLDNAME
SELECT (LOFORMSET.LCAPINVTKT)
*Get PO style price for styles have no detail costing
LOCONTFORM.LCMFGCODE = LOFORM.LCOPRCODE

*Get distribution line no. from invoice tkt    [Start]
REPLACE APINVHDR.NLASTVILNO WITH  LFGETMAXLIN(LOFORMSET, LOFORM) IN APINVHDR
*Get distribution line no. from invoice tkt    [End]
*ASM, Key of Bomline index in case of Shipment and non shipment
*CIMTYP+CTYPE+CBOMTYP+MFGCODE+SHIPNO+CRSESSION+CTKTNO+STR(LINENO,6)+CINVTYPE+STYLE+CSTYGRADE ;
*CIMTYP+CTYPE+CBOMTYP+MFGCODE+CTKTNO+CRSESSION+SHIPNO+STR(LINENO,6)+CINVTYPE+STYLE+CSTYGRADE

IF EMPTY(LOCONTFORM.LCCONTITEM)
  IF INLIST(LOFORM.LCTKTTYPE,'S','I','M') AND LOFORM.LCOPRCODE=REPLICATE('*',6) AND ;
      IIF(LOFORM.LCTKTTYPE='S',LOFORMSET.BOMLINE.SEEK('I2'+LOFORM.LCCSTTYPE+PADR('*'+LOFORM.LCCSTTYPE,6)+LOCONTFORM.LCSHIPNO+LOCONTFORM.KBRSESSION) OR ;
      LOFORMSET.BOMLINE.SEEK('I2'+LOFORM.LCCSTTYPE+'******'+LOCONTFORM.LCSHIPNO+LOCONTFORM.KBRSESSION),;
      LOFORMSET.BOMLINE.SEEK(LOFORM.LCTKTTYPE+'2'+LOFORM.LCCSTTYPE+PADR('*'+LOFORM.LCCSTTYPE,6)+LOCONTFORM.LCTICKET+LOCONTFORM.KBRSESSION) OR ;
      LOFORMSET.BOMLINE.SEEK(LOFORM.LCTKTTYPE+'2'+LOFORM.LCCSTTYPE+'******'+LOCONTFORM.LCTICKET+LOCONTFORM.KBRSESSION))
    LOCONTFORM.LCMFGCODE = PADR(BOMLINE.MFGCODE,6) &&Sql
  ENDIF
  IF INLIST(LOFORM.LCTKTTYPE,'S','I','M') AND LOFORM.LCOPRCODE=REPLICATE('#',6) AND ;
      IIF(LOFORM.LCTKTTYPE='S',LOFORMSET.BOMLINE.SEEK('I2'+LOFORM.LCCSTTYPE+PADR('*'+LOFORM.LCCSTTYPE,6)+LOCONTFORM.LCSHIPNO+LOCONTFORM.KBRSESSION) OR ;
      LOFORMSET.BOMLINE.SEEK('I2'+LOFORM.LCCSTTYPE+'######'+LOCONTFORM.LCSHIPNO+LOCONTFORM.KBRSESSION),;
      LOFORMSET.BOMLINE.SEEK(LOFORM.LCTKTTYPE+'2'+LOFORM.LCCSTTYPE+PADR('*'+LOFORM.LCCSTTYPE,6)+LOCONTFORM.LCTICKET+LOCONTFORM.KBRSESSION) OR ;
      LOFORMSET.BOMLINE.SEEK(LOFORM.LCTKTTYPE+'2'+LOFORM.LCCSTTYPE+'######'+LOCONTFORM.LCTICKET+LOCONTFORM.KBRSESSION))
    LOCONTFORM.LCMFGCODE = PADR(BOMLINE.MFGCODE,6) &&Sql
  ENDIF
ELSE
  IF INLIST(LOFORM.LCTKTTYPE,'S','I','M') AND LOFORM.LCOPRCODE=REPLICATE('*',6)
    =SEEK(PADR(LOCONTFORM.LCCONTITEM,19),'STYLE')
    LOCONTFORM.LCMFGCODE=IIF(!STYLE.LDETCOST,PADR('*'+LOFORM.LCCSTTYPE,6),LOFORM.LCOPRCODE)
  ENDIF
  IF INLIST(LOFORM.LCTKTTYPE,'S','I','M') AND LOFORM.LCOPRCODE=REPLICATE('#',6)
    =SEEK(PADR(LOCONTFORM.LCCONTITEM,19),'STYLE')
    LOCONTFORM.LCMFGCODE=IIF(!STYLE.LDETCOST,PADR('*'+LOFORM.LCCSTTYPE,6),LOFORM.LCOPRCODE)
  ENDIF
ENDIF

*Fix the contribution process [Begin]
LCBOMORD = ORDER('BOMLINE') &&Sql
LLSEEKBOM = .F.
*ALB Fix the contribution process [End]
DO CASE
CASE LOFORM.LCTKTTYPE  = 'S'
  LOFORMSET.LCFILEINUSE = 'POSLN'
  SELECT POSLN
  LOFORMSET.POSLN.SETORDER('POSHREC')  &&Sql ;
  *SHIPNO+CRSESSION+CBUSDOCU+CSTYTYPE+PO+CINVTYPE+STYLE+STR(LINENO,6)+TRANCD ;
  (SHIPNO+CRSESSION+CSTYTYPE+PO+STYLE+STR(LINENO,6)+TRANCD)
  *Fix the contribution process  to save the invoice[Begin]
  LOFORMSET.LCFORCOND   = "loFormSet.PosHdr.seek('PP'+BOMLINE.CTKTNO,'POSHDR') and "+;
    "POSHDR.STATUS $ 'ACO' AND Style=ALLTRIM(EVALUATE(loFormSet.lcAPvInvDt+'.Item')) "+;
    "AND crsession = loContForm.kbRSession" &&Sql
  LCBOMCOND = "Bomline.cimtyp + Bomline.ctype + Bomline.cbomtyp + Bomline.mfgcode +;
                 Bomline.shipno + Bomline.crsession +ctktno+STR(lineno,6)+style+sclr+cstygrade" && Sql
  LCBOMKEY  = 'I2'+LOFORM.LCCSTTYPE+LOCONTFORM.LCMFGCODE+LOCONTFORM.LCSHIPNO && Sql
  SELECT BOMLINE
  *Old: SET ORDER TO TAG Bomshrec
  LOFORMSET.BOMLINE.SETORDER('Bomshrec') &&Sql Check Tag ;
  *CIMTYP+CTYPE+CBOMTYP+MFGCODE+SHIPNO+CRSESSION+CTKTNO+STR(LINENO,6)+CINVTYPE+STYLE+CSTYGRADE ;
  (CIMTYP+CTYPE+CBOMTYP+MFGCODE+SHIPNO+CRSESSION+CTKTNO+STR(LINENO,6)+STYLE+SCLR+CSTYGRADE)
  LLSEEKBOM = LOFORMSET.BOMLINE.SEEK(LCBOMKEY) && Sql
  *Fix the contribution process to save the invoice[END]

  LOFORMSET.LCCONDITION = 'SHIPNO+CRSESSION+CSTYTYPE+PO+STYLE+STR(LINENO,6)+TRANCD'
  LCKEY       = LOCONTFORM.LCSHIPNO+LOCONTFORM.KBRSESSION


  LCITEM   = 'PosLn.Style'
  LCGRADE  = 'POSLN.cStyGrade'
  LCCOLOR  = 'SPACE(6)'
  LCDYELOT = 'SPACE(10)'
  *Define variable holds the header file   [Start]
  LCHDRFILE= 'POSHDR'
  LCHDRORED= 'Poshdr'
  LCHDRKEY = "PP"

CASE INLIST(LOFORM.LCTKTTYPE,'A')
  LOFORMSET.LCFILEINUSE = 'POSLN'
  LOFORMSET.LCCONDITION = 'CSTYTYPE+PO+CRSESSION+SHIPNO+STYLE+STR(LINENO,6)+TRANCD'
  LOFORMSET.LCFORCOND   = ".T."
  SELECT POSLN
  *Old: SET ORDER TO TAG POSREC IN POSLN
  LOFORMSET.POSLN.SETORDER('POSREC') &&Sql Check Tag ;
  *CBUSDOCU+CSTYTYPE+PO+CRSESSION+SHIPNO+CINVTYPE+STYLE+STR(LINENO,6)+TRANCD+CSTYGRADE ;
  (CSTYTYPE+PO+CRSESSION+SHIPNO+STYLE+STR(LINENO,6)+TRANCD)
  IF LOFORMSET.POSLN.SEEK("PA" + LOCONTFORM.LCTICKET + LOCONTFORM.KBRSESSION) &&Sql
    LOCONTFORM.LCSHIPNO = POSLN.SHIPNO
  ENDIF
  LCKEY      = "PA"+LOCONTFORM.LCTICKET+LOCONTFORM.KBRSESSION+LOCONTFORM.LCSHIPNO+"0001"+ALLTRIM(EVALUATE(LOFORMSET.LCAPVINVDT+'.Item'))
  LCBOMCOND = "Bomline.cimtyp + Bomline.ctype + Bomline.cbomtyp + Bomline.mfgcode +;
                 Bomline.shipno + Bomline.crsession +ctktno+STR(lineno,6)+style+sclr+cstygrade" && Sql
  LCBOMKEY  = 'A3'+LOFORM.LCCSTTYPE+LOCONTFORM.LCMFGCODE+LOCONTFORM.LCSHIPNO+LOCONTFORM.KBRSESSION+LOCONTFORM.LCTICKET && Sql
  LOFORMSET.LCFORCOND = ".T. AND " +IIF(EMPTY(EVALUATE(LOFORMSET.LCAPVINVDT+'.Item')),'.T.',;
    "style = '"+EVALUATE(LOFORMSET.LCAPVINVDT+'.Item')+"'")

  SELECT BOMLINE
  *Old: SET ORDER TO TAG Bomshrec
  LOFORMSET.BOMLINE.SETORDER('Bomshrec') &&Sql Check Tag ;
  *CIMTYP+CTYPE+CBOMTYP+MFGCODE+SHIPNO+CRSESSION+CTKTNO+STR(LINENO,6)+CINVTYPE+STYLE+CSTYGRADE ;
  (CIMTYP+CTYPE+CBOMTYP+MFGCODE+SHIPNO+CRSESSION+CTKTNO+STR(LINENO,6)+STYLE+SCLR+CSTYGRADE)
  LLSEEKBOM =LOFORMSET.BOMLINE.SEEK(LCBOMKEY) && Sql
  LCITEM   = 'PosLn.Style'
  LCCOLOR  = 'SPACE(6)'
  LCDYELOT = 'SPACE(10)'
  LCGRADE  = 'POSLN.cStyGrade'
  LCHDRFILE= 'POSHDR'
  LCHDRORED= 'Poshdr'
  LCHDRKEY = "PA"

CASE INLIST(LOFORM.LCTKTTYPE,'D')
  LOFORMSET.LCFILEINUSE = 'POSLN'
  LOFORMSET.LCCONDITION = 'CSTYTYPE+PO+CRSESSION+SHIPNO+STYLE+STR(LINENO,6)+TRANCD'
  LOFORMSET.LCFORCOND   = ".T."
  SELECT POSLN
  *Old: SET ORDER TO TAG POSREC IN POSLN
  LOFORMSET.POSLN.SETORDER('POSREC') &&Sql Check Tag ;
  *CBUSDOCU+CSTYTYPE+PO+CRSESSION+SHIPNO+CINVTYPE+STYLE+STR(LINENO,6)+TRANCD+CSTYGRADE ;
  (CSTYTYPE+PO+CRSESSION+SHIPNO+STYLE+STR(LINENO,6)+TRANCD)
  IF LOFORMSET.POSLN.SEEK("PD"+ LOCONTFORM.LCTICKET + LOCONTFORM.KBRSESSION) && Sql
    LOCONTFORM.LCSHIPNO = POSLN.SHIPNO
  ENDIF
  LCKEY      = "PD"+LOCONTFORM.LCTICKET+LOCONTFORM.KBRSESSION+LOCONTFORM.LCSHIPNO+"0001"+ALLTRIM(EVALUATE(LOFORMSET.LCAPVINVDT+'.Item'))
  LCBOMCOND = "Bomline.cimtyp + Bomline.ctype + Bomline.cbomtyp + Bomline.mfgcode +;
                 Bomline.shipno + Bomline.crsession +ctktno+STR(lineno,6)+style+sclr+cstygrade" && Sql
  LCBOMKEY  = 'D2'+LOFORM.LCCSTTYPE+LOCONTFORM.LCMFGCODE+LOCONTFORM.LCSHIPNO+LOCONTFORM.KBRSESSION+LOCONTFORM.LCTICKET && Sql
  LOFORMSET.LCFORCOND = ".T. AND " +IIF(EMPTY(EVALUATE(LOFORMSET.LCAPVINVDT+'.Item')),'.T.',;
    "style = '"+EVALUATE(LOFORMSET.LCAPVINVDT+'.Item')+"'")

  SELECT BOMLINE
  *Old: SET ORDER TO TAG Bomshrec
  LOFORMSET.BOMLINE.SETORDER('Bomshrec') &&Sql Check Tag ;
  *CIMTYP+CTYPE+CBOMTYP+MFGCODE+SHIPNO+CRSESSION+CTKTNO+STR(LINENO,6)+CINVTYPE+STYLE+CSTYGRADE ;
  (CIMTYP+CTYPE+CBOMTYP+MFGCODE+SHIPNO+CRSESSION+CTKTNO+STR(LINENO,6)+STYLE+SCLR+CSTYGRADE)
  LLSEEKBOM =LOFORMSET.BOMLINE.SEEK(LCBOMKEY) && Sql
  LCITEM   = 'PosLn.Style'
  LCCOLOR  = 'SPACE(6)'
  LCDYELOT = 'SPACE(10)'
  LCGRADE  = 'POSLN.cStyGrade'
  LCHDRFILE= 'POSHDR'
  LCHDRORED= 'Poshdr'
  LCHDRKEY = "PD"

CASE INLIST(LOFORM.LCTKTTYPE,'I','R')
  LOFORMSET.LCFILEINUSE = 'POSLN'
  LOFORMSET.LCCONDITION = 'CSTYTYPE+PO+CRSESSION+SHIPNO+STYLE+STR(LINENO,6)+TRANCD'


  LOFORMSET.LCFORCOND   = ".T."
  SELECT POSLN
  LOFORMSET.POSLN.SETORDER('POSREC') &&Sql Check Tag ;
  *CBUSDOCU+CSTYTYPE+PO+CRSESSION+SHIPNO+CINVTYPE+STYLE+STR(LINENO,6)+TRANCD+CSTYGRADE ;
  (CSTYTYPE+PO+CRSESSION+SHIPNO+STYLE+STR(LINENO,6)+TRANCD)

  *Get Value of Ship No to add to index [Begin]
  IF LOFORMSET.POSLN.SEEK(IIF(LOFORM.LCTKTTYPE='I','PP','RP') + LOCONTFORM.LCTICKET + LOCONTFORM.KBRSESSION) && Sql
    LOCONTFORM.LCSHIPNO = POSLN.SHIPNO
  ENDIF
  LCKEY       = IIF(LOFORM.LCTKTTYPE='I','PP','RP')+LOCONTFORM.LCTICKET+LOCONTFORM.KBRSESSION+LOCONTFORM.LCSHIPNO+"0001"+ALLTRIM(EVALUATE(LOFORMSET.LCAPVINVDT+'.Item'))
  *Get Value of Ship No to add to index [End]

  LCBOMCOND = "Bomline.cimtyp + Bomline.ctype + Bomline.cbomtyp + Bomline.mfgcode +;
                 Bomline.shipno + Bomline.crsession +ctktno+STR(lineno,6)+style+sclr+cstygrade" && Sql
  LCBOMKEY  = 'I2'+LOFORM.LCCSTTYPE+LOCONTFORM.LCMFGCODE+LOCONTFORM.LCSHIPNO+LOCONTFORM.KBRSESSION+LOCONTFORM.LCTICKET && Sql

  *B608642,1 WAM 08/04/2008 Get only receiving lines
  *loFormSet.lcForCond = ".T. AND " +IIF(EMPTY(EVALUATE(loFormSet.lcAPvInvDt+'.Item')),'.T.',;
  "style = '"+EVALUATE(loFormSet.lcAPvInvDt+'.Item')+"'")
  LOFORMSET.LCFORCOND = "TRANCD='2' AND " +IIF(EMPTY(EVALUATE(LOFORMSET.LCAPVINVDT+'.Item')),'.T.',;
    "style = '"+EVALUATE(LOFORMSET.LCAPVINVDT+'.Item')+"'")
  *B608642,1 WAM 08/04/2008 Get only receiving lines

  SELECT BOMLINE
  *Old: SET ORDER TO TAG Bomshrec
  LOFORMSET.BOMLINE.SETORDER('Bomshrec') &&Sql Check Tag ;
  *CIMTYP+CTYPE+CBOMTYP+MFGCODE+SHIPNO+CRSESSION+CTKTNO+STR(LINENO,6)+CINVTYPE+STYLE+CSTYGRADE ;
  (CIMTYP+CTYPE+CBOMTYP+MFGCODE+SHIPNO+CRSESSION+CTKTNO+STR(LINENO,6)+STYLE+SCLR+CSTYGRADE)
  LLSEEKBOM =LOFORMSET.BOMLINE.SEEK(LCBOMKEY) && Sql


  LCITEM   = 'PosLn.Style'
  LCCOLOR  = 'SPACE(6)'
  LCDYELOT = 'SPACE(10)'
  LCGRADE  = 'POSLN.cStyGrade'

  LCHDRFILE= 'POSHDR'
  LCHDRORED= 'Poshdr'
  LCHDRKEY = IIF(LOFORM.LCTKTTYPE='I','PP','RP')

CASE LOFORM.LCTKTTYPE = 'M'
  LOFORMSET.LCFILEINUSE = 'CUTTKTL'
  LOFORMSET.LCCONDITION = 'CRSESSION+CUTTKT+STYLE+TRANCD'
  LCKEY       = 'PU'+LOCONTFORM.LCTICKET+LOCONTFORM.KBRSESSION+SPACE(6)+"0001"+ALLTRIM(EVALUATE(LOFORMSET.LCAPVINVDT+'.Item'))
  LOFORMSET.LCFORCOND   = ".T."
  SELECT CUTTKTL
  *Old: SET ORDER TO TAG CUTREC  IN CUTTKTL
  LOFORMSET.CUTTKTL.SETORDER('POSREC') &&Sql Check Tag ;
  *CBUSDOCU+CSTYTYPE+PO+CRSESSION+SHIPNO+CINVTYPE+STYLE+STR(LINENO,6)+TRANCD+CSTYGRADE ;
  (CSTYTYPE+PO+CRSESSION+SHIPNO+STYLE+STR(LINENO,6)+TRANCD)

  LCBOMCOND = "Bomline.cimtyp + Bomline.ctype + Bomline.cbomtyp + Bomline.mfgcode +Bomline.shipno +Bomline.crsession+Bomline.ctktno" && Sql
  LCBOMKEY  = 'M2'+LOFORM.LCCSTTYPE+LOCONTFORM.LCMFGCODE+LOCONTFORM.LCSHIPNO + LOCONTFORM.KBRSESSION + LOCONTFORM.LCTICKET && Sql

  *B608642,1 WAM 08/04/2008 Get only receiving lines
  *loFormSet.lcForCond = ".T. AND " +IIF(EMPTY(EVALUATE(loFormSet.lcAPvInvDt+'.Item')),'.T.',;
  "style = '"+EVALUATE(loFormSet.lcAPvInvDt+'.Item')+"'")
  LOFORMSET.LCFORCOND = "TRANCD='2' AND " +IIF(EMPTY(EVALUATE(LOFORMSET.LCAPVINVDT+'.Item')),'.T.',;
    "style = '"+EVALUATE(LOFORMSET.LCAPVINVDT+'.Item')+"'")
  *B608642,1 WAM 08/04/2008 (End)

  SELECT BOMLINE
  *Old: SET ORDER TO TAG Bomshrec
  LOFORMSET.BOMLINE.SETORDER('Bomshrec') &&Sql Check Tag ;
  *CIMTYP+CTYPE+CBOMTYP+MFGCODE+SHIPNO+CRSESSION+CTKTNO+STR(LINENO,6)+CINVTYPE+STYLE+CSTYGRADE ;
  (CIMTYP+CTYPE+CBOMTYP+MFGCODE+SHIPNO+CRSESSION+CTKTNO+STR(LINENO,6)+STYLE+SCLR+CSTYGRADE)
  LLSEEKBOM =LOFORMSET.BOMLINE.SEEK(LCBOMKEY) && Sql


  LCITEM   = 'CUTTKTL.Style'
  LCCOLOR  = 'SPACE(6)'
  LCDYELOT = 'CUTTKTL.Dyelot'
  LCGRADE  = 'CUTTKTL.cStyGrade'
  LCHDRFILE= 'CUTTKTH'
  LCHDRORED= 'Poshdr'
  LCHDRKEY = "PU"

CASE INLIST(LOFORM.LCTKTTYPE,'L','F')
  LOFORMSET.LCFILEINUSE = 'POFLN'
  *Old: SET ORDER TO TAG POFREC IN POFLN
  LOFORMSET.POFLN.SETORDER('POSREC') &&Sql Check Tag ;
  *CBUSDOCU+CSTYTYPE+PO+CRSESSION+SHIPNO+CINVTYPE+STYLE+STR(LINENO,6)+TRANCD+CSTYGRADE ;
  (CSTYTYPE+PO+CRSESSION+SHIPNO+STYLE+STR(LINENO,6)+TRANCD)
  LOFORMSET.LCCONDITION = 'cMatType+PoMat+cRSession+Fabric+Color+Trancd'
  *B128365,1 ASM 06/06/2005  [Start]
  *lcKey       = IIF(loForm.lcTktType='L','PM','RM')+loContForm.lcTicket+loContForm.kbRSession+SPACE(6)+"0002"+;
  IIF(EMPTY(EVALUATE(loFormSet.lcAPvInvDt+'.Item')),'',;
  lfupditem(SUBSTR(EVALUATE(loFormSet.lcAPvInvDt+'.Item'),1,7),EVALUATE(loFormSet.lcAPvInvDt+'.Color')))
  IF LOFORMSET.POFLN.SEEK(IIF(LOFORM.LCTKTTYPE='L','PM','RM') + LOCONTFORM.LCTICKET + LOCONTFORM.KBRSESSION)
    LOCONTFORM.LCSHIPNO = POFLN.SHIPNO
  ENDIF
  LCKEY       = IIF(LOFORM.LCTKTTYPE='L','PM','RM')+LOCONTFORM.LCTICKET+LOCONTFORM.KBRSESSION+LOCONTFORM.LCSHIPNO+"0002"+;
    IIF(EMPTY(EVALUATE(LOFORMSET.LCAPVINVDT+'.Item')),'',;
    LFUPDITEM(SUBSTR(EVALUATE(LOFORMSET.LCAPVINVDT+'.Item'),1,LOFORMSET.LNFABMAJLEN),EVALUATE(LOFORMSET.LCAPVINVDT+'.Color')))
  *B128365,1 ASM 06/06/2005  [End]

  *B608642,1 WAM 08/04/2008 Get only receiving lines
  *loFormSet.lcForCond = ".T. AND " +IIF(EMPTY(EVALUATE(loFormSet.lcAPvInvDt+'.Item')),'.T.',;
  "style = '"+lfupditem(SUBSTR(EVALUATE(loFormSet.lcAPvInvDt+'.Item'),1,loFormSet.lnFabMajLen),EVALUATE(loFormSet.lcAPvInvDt+'.Color'))+"'")
  LOFORMSET.LCFORCOND = "TRANCD='2' AND " +IIF(EMPTY(EVALUATE(LOFORMSET.LCAPVINVDT+'.Item')),'.T.',;
    "style = '"+LFUPDITEM(SUBSTR(EVALUATE(LOFORMSET.LCAPVINVDT+'.Item'),1,LOFORMSET.LNFABMAJLEN),EVALUATE(LOFORMSET.LCAPVINVDT+'.Color'))+"'")

  *B608642,1 WAM 08/04/2008 (End)

  LCITEM      = 'left(POFLN.Style,loFormSet.lnFabMajLen)'
  LCCOLOR     = 'substr(POFLN.Style,loFormSet.lnFabClrStart,loFormSet.lnFabClrLen)'
  LCDYELOT    = 'POFLN.Dyelot'
  *lcGrade     = 'POFLN.cFabGrade'
  LCGRADE     = 'POFLN.cStyGrade'
  LCHDRFILE= 'POFHDR'
  LCHDRORED= 'Poshdr'
  LCHDRKEY = IIF(LOFORM.LCTKTTYPE='L','PM','RM')
  LCBOMKEY = ""


CASE LOFORM.LCTKTTYPE = 'T'

  LOFORMSET.LCFILEINUSE = 'MMFGORDD'
  LOFORMSET.LCCONDITION = 'cRSession+cmfgordno+cfabric+color+dyelot+trancd'
  LCKEY       = 'PF'+LOCONTFORM.LCTICKET+LOCONTFORM.KBRSESSION+SPACE(6)+"0002"+IIF(EMPTY(EVALUATE(LOFORMSET.LCAPVINVDT+'.Item')),'',;
    LFUPDITEM(SUBSTR(EVALUATE(LOFORMSET.LCAPVINVDT+'.Item'),1,LOFORMSET.LNFABMAJLEN),EVALUATE(LOFORMSET.LCAPVINVDT+'.Color')))
  LOFORMSET.LCFORCOND   = ".T."
  SELECT MMFGORDD
  *Old: SET ORDER TO TAG MFGREC IN MMFGORDD
  LOFORMSET.MMFGORDD.SETORDER('POSREC') &&Sql Check Tag ;
  *CBUSDOCU+CSTYTYPE+PO+CRSESSION+SHIPNO+CINVTYPE+STYLE+STR(LINENO,6)+TRANCD+CSTYGRADE ;
  (CSTYTYPE+PO+CRSESSION+SHIPNO+STYLE+STR(LINENO,6)+TRANCD)
  LCBOMCOND = "Bomline.cimtyp + Bomline.ctype + Bomline.cbomtyp + Bomline.mfgcode +Bomline.shipno "+;
    "+Bomline.crsession+Bomline.ctktno+STR(lineno,6)+style+sclr+cstygrade"

  LCBOMKEY  = 'T2'+LOFORM.LCCSTTYPE+LOCONTFORM.LCMFGCODE+LOCONTFORM.LCSHIPNO + LOCONTFORM.KBRSESSION + LOCONTFORM.LCTICKET
  LOFORMSET.LCFORCOND = ".T. AND " +IIF(EMPTY(EVALUATE(LOFORMSET.LCAPVINVDT+'.Item')),'.T.',;
    "style = '"+LFUPDITEM(SUBSTR(EVALUATE(LOFORMSET.LCAPVINVDT+'.Item'),1,LOFORMSET.LNFABMAJLEN),EVALUATE(LOFORMSET.LCAPVINVDT+'.Color'))+"'")
  SELECT BOMLINE
  LOFORMSET.BOMLINE.SETORDER('Bomshrec') &&Sql Check Tag ;
  *CIMTYP+CTYPE+CBOMTYP+MFGCODE+SHIPNO+CRSESSION+CTKTNO+STR(LINENO,6)+CINVTYPE+STYLE+CSTYGRADE ;
  (CIMTYP+CTYPE+CBOMTYP+MFGCODE+SHIPNO+CRSESSION+CTKTNO+STR(LINENO,6)+STYLE+SCLR+CSTYGRADE)
  LLSEEKBOM =LOFORMSET.BOMLINE.SEEK(LCBOMKEY) && Sql

  LCITEM      = 'left(MMFGORDD.Style,loFormSet.lnFabMajLen)'
  LCCOLOR     = 'substr(MMFGORDD.Style,loFormSet.lnFabClrStart,loFormSet.lnFabClrLen)'
  LCDYELOT    = 'MMFGORDD.Dyelot'
  *lcGrade     = 'MMFGORDD.cFabGrade'
  LCGRADE     = 'MMFGORDD.cStyGrade'
  LCHDRFILE= 'MMFGORDH'
  LCHDRORED= 'Poshdr'
  LCHDRKEY = "PF"

ENDCASE

LNTOTBUD   = 0
LNTITMAMT  = 0
LNTOTACTCT = 0          && Total Actual Cost
LNTOTLANCT = 0          && Total Landed Cost

DO CASE
  *Contribution Based On Budget Cost
CASE LOCONTFORM.RBCNTRB = 1
  IF INLIST(LOFORM.LCTKTTYPE,'L','F','R','A')
    SELECT (LOFORMSET.LCFILEINUSE)
    *Old: =SEEK(lcKey)
    LOTEMP = EVALUATE('loFormSet.'+LOFORMSET.LCFILEINUSE)
    LOTEMP.SEEK(LCKEY)
    LCTEMP=LCLNFLDNAME+LOFORM.LCCSTTYPE+'*'+LCRCVQTY
    *SUM REST &lcTemp FOR EVALUATE(loFormSet.lcForCond) TO lnTotBud
    SUM ALL &LCTEMP FOR EVALUATE(LOFORMSET.LCFORCOND) TO LNTOTBUD
    *Old: =SEEK(lcKey)
    LOCATE
    LOFORMSET.LCFORCOND = ".T. "

    SCAN FOR EVALUATE(LOFORMSET.LCFORCOND)
      LCTEMP = LCRCVQTY+'*'+LCLNFLDNAME+LOFORM.LCCSTTYPE
      LNTOTLANCT = LNTOTLANCT + &LCTEMP
      LCTEMP = LCRCVQTY+'*'+LCACFLDNAME+LOFORM.LCCSTTYPE
      LNTOTACTCT = LNTOTACTCT + &LCTEMP


      SELECT (LOFORMSET.LCAPINVTKT)
      APPEND BLANK
      REPLACE CSTATUS    WITH 'A'          ,;
        CVENDCODE  WITH LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE    ,;
        CAPINVNO   WITH LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE    ,;
        CRECVTYPE  WITH IIF(&LCGRADE='1','R',IIF(&LCGRADE='2','S','D')) ,;
        CAPVILNO   WITH LOCONTFORM.LCINVLINENO  ,;
        CIMTYP     WITH LOFORM.LCTKTTYPE    ,;
        CTKTNO     WITH LOCONTFORM.LCTICKET     ,;
        CRSESSION  WITH LOCONTFORM.KBRSESSION   ,;
        LINENO     WITH EVAL(LOFORMSET.LCFILEINUSE+'.LineNo') ,;
        ITEM       WITH &LCITEM      ,;
        COLOR      WITH IIF(TYPE(LCCOLOR)<>'U',&LCCOLOR,'')     ,;
        CDYELOT    WITH &LCDYELOT    ,;
        CWARECODE  WITH EVAL(LOFORMSET.LCFILEINUSE+'.cWareCode') ,;
        NAPTAPLQTY WITH &LCRCVQTY
      LCTEMP = LCLNFLDNAME+LOFORM.LCCSTTYPE
      REPLACE NAPAPLPRIC WITH IIF(LNTOTBUD=0,0,&LCTEMP*LOCONTFORM.LNAMOUNT/LNTOTBUD), ;
        NAPAPLAMNT WITH IIF(LNTOTBUD=0,0,&LCTEMP*&LCRCVQTY/LNTOTBUD*LOCONTFORM.LNAMOUNT)


      *Uppdate invoicetkt file with the WIP account in case of (S)hipment.  [Start]
      * I put this cond. "lcTktType<>'T'" untill to confirm with Khalid about how we can get
      * the gl link code for MMFGORDD file.
      REPLACE APINVHDR.NLASTVILNO WITH APINVHDR.NLASTVILNO + 1 IN APINVHDR
      REPLACE CAPDGLACT WITH LFGETWIPAC(LCHDRKEY+IIF(LOFORM.LCTKTTYPE='S',POSLN.PO,LOCONTFORM.LCTICKET),LCHDRFILE,LCHDRORED) ;
        CAPDLINNO WITH STR(APINVHDR.NLASTVILNO,4)
      *Uppdate invoicetkt file with the WIP account in case of (S)hipment.  [End]

      *Get the correct WIP account with shipment ticket [Begin]
      REPLACE CAPDGLACT WITH IIF(!EMPTY(EVALUATE(LOFORMSET.LCAPVINVDT+'.cAPDGLAct')),EVALUATE(LOFORMSET.LCAPVINVDT+'.cAPDGLAct'),LFGETWIPAC(LCHDRKEY+IIF(LOFORM.LCTKTTYPE='S',POSLN.PO,LOCONTFORM.LCTICKET),LCHDRFILE,LCHDRORED)) ;
        CAPDLINNO WITH STR(APINVHDR.NLASTVILNO,4)
      *Get the correct WIP account with shipment ticket [end]

      *Add this line to accumulate the value that was actually
      *          stored in the file and not the value that should be
      *          stored, to take into consideration the rounding
      *          problems [Begin]
      LNTITMAMT  = LNTITMAMT  + NAPAPLAMNT
      *Add this line to accumulate the value [End]

      IF INLIST(LOFORM.LCTKTTYPE,'R','A')
        REPLACE NAPAPLQTY1 WITH POSLN.QTY1 ,;
          NAPAPLQTY2 WITH POSLN.QTY2 ,;
          NAPAPLQTY3 WITH POSLN.QTY3 ,;
          NAPAPLQTY4 WITH POSLN.QTY4 ,;
          NAPAPLQTY5 WITH POSLN.QTY5 ,;
          NAPAPLQTY6 WITH POSLN.QTY6 ,;
          NAPAPLQTY7 WITH POSLN.QTY7 ,;
          NAPAPLQTY8 WITH POSLN.QTY8
      ENDIF
    ENDSCAN
  ELSE
    *Fix the contribution process  to save the invoice[Begin]
    IF !LLSEEKBOM
      *Old: SET ORDER TO TAG &lcBomOrd IN BOMLINE && Sql
      LOFORMSET.BOMLINE.SETORDER(LCBOMORD)
      *N000682,1 MMT 11/22/2012 Globalization changes[Start]
      *=GFMODALGEN(.F.,'DIALOG',.F.,.F.,'There is no such cost lines to contribute')
      *N000682,1 11/20/2012 MMT Globlization changes[Start]
*=GFMODALGEN(.F.,'DIALOG',.F.,.F.,LANG_NOCOSTONRIBUTEDLINES)
=GFMODALGEN(.F.,'DIALOG',.F.,.F.,IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_NOCOSTONRIBUTEDLINES,loFormSet.GetHeaderText("LANG_NOCOSTONRIBUTEDLINES",loFormSet.HeaderAlias)))
*N000682,1 11/20/2012 MMT Globlization changes[End]

      *N000682,1 MMT 11/22/2012 Globalization changes[END]
      RETURN
    ENDIF
    SELECT BOMLINE
    *SUM REST BOMLINE.ITEMAMT FOR EVALUATE(loFormSet.lcForCond) TO lnTotBud
    *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][Start]
    *SUM ALL BOMLINE.ITEMAMT FOR EVALUATE(loFormSet.lcForCond) TO lnTotBud
    LCBOMFORCOND = STRTRAN(LOFORMSET.LCFORCOND,'TRANCD','CTYPE')
    SUM ALL BOMLINE.ITEMAMT FOR EVALUATE(LCBOMFORCOND) TO LNTOTBUD
    *!B609860,1 SAB 04/17/2012 Fix Error that occure while switching between tabs [T20120304.0004][End]
    IF INLIST(LOFORM.LCTKTTYPE,'I','R','T','M','D')
      *B608642,1 WAM 08/04/2008 Don't overwrite the FOR expression previously built
      *loFormSet.lcForCond = ".T. "
      *B608642,1 WAM 08/04/2008 (End)
    ELSE
      LOFORMSET.LCFORCOND = "loFormSet.PosHdr.Seek('PP'+POSLN.PO) and POSHDR.STATUS $ 'ACO' "+;
        "AND IIF(EMPTY(ALLTRIM(EVALUATE(loFormSet.lcAPvInvDt+'.Item'))),.T.,Style=ALLTRIM(EVALUATE(loFormSet.lcAPvInvDt+'.Item'))) AND crsession = loContForm.kbRSession"
    ENDIF
    *Fix the contribution process  to save the invoice[End]

    SELECT (LOFORMSET.LCFILEINUSE)
    LOTEMP = EVALUATE('loFormSet.'+LOFORMSET.LCFILEINUSE)
    LLSEEK = LOTEMP.SEEK(LCKEY) && add llseek for teacing
    SCAN REST FOR EVALUATE(LOFORMSET.LCFORCOND) .AND. &LCRCVQTY <> 0
      *Get the proper MfgCode for each style and move to the proper record in BOMLINE [Start]
      =SEEK(&LCITEM,'Style')
      IF !STYLE.LDETCOST
        LOCONTFORM.LCMFGTMP = PADR('*'+LOFORM.LCCSTTYPE,6)
      ELSE
        IF LOFORMSET.LACOSTTYPE[loForm.cboCostType.Value,3]= "P"
          LOCONTFORM.LCMFGTMP = REPLICATE('*',6)
        ENDIF
        IF LOFORMSET.LACOSTTYPE[loForm.cboCostType.Value,3]=  "D"
          LOCONTFORM.LCMFGTMP = REPLICATE('#',6)
        ENDIF
        IF !(LOFORMSET.LACOSTTYPE[loForm.cboCostType.Value,3]  $ "PD")
          LOCONTFORM.LCMFGTMP = LOCONTFORM.LCMFGCODE
        ENDIF
      ENDIF
      *CIMTYP+CTYPE+CBOMTYP+MFGCODE+SHIPNO+CRSESSION+CTKTNO+STR(LINENO,6)+CINVTYPE+STYLE+CSTYGRADE ;
      (CIMTYP+CTYPE+CBOMTYP+MFGCODE+SHIPNO+CRSESSION+CTKTNO+STR(LINENO,6)+STYLE+SCLR+CSTYGRADE)
      DO CASE
      CASE LOFORM.LCTKTTYPE  = 'S'
        LCBOMKEY = 'I2'+LOFORM.LCCSTTYPE+LOCONTFORM.LCMFGTMP+LOCONTFORM.LCSHIPNO+CRSESSION+PO+STR(LINENO,6)+"0001"+STYLE+CSTYGRADE && Sql
      CASE INLIST(LOFORM.LCTKTTYPE,'A')
        LCBOMKEY = 'A3'+LOFORM.LCCSTTYPE+LOCONTFORM.LCMFGTMP+SHIPNO+CRSESSION+LOCONTFORM.LCTICKET+STR(LINENO,6)+"0001"+STYLE+SPACE(6) && Sql
      CASE INLIST(LOFORM.LCTKTTYPE,'D')
        LCBOMKEY = 'D2'+LOFORM.LCCSTTYPE+LOCONTFORM.LCMFGTMP+SHIPNO+CRSESSION+LOCONTFORM.LCTICKET+STR(LINENO,6)+"0001"+STYLE+SPACE(6) && Sql
      CASE INLIST(LOFORM.LCTKTTYPE,'I','R')
        *lcBomKey = 'I2'+loForm.lcCstType+loContForm.lcMfgTmp+SHIPNO+CRSESSION+loContForm.lcTicket+STR(LINENO,6)+"0001"+STYLE+SPACE(6)+CSTYGRADE && Sql
        LCBOMKEY = 'I2'+LOFORM.LCCSTTYPE+LOCONTFORM.LCMFGTMP+SHIPNO+CRSESSION+LOCONTFORM.LCTICKET+STR(LINENO,6)+"0001"+STYLE+CSTYGRADE && Sql
      CASE LOFORM.LCTKTTYPE = 'M'            &&lower
        LCBOMKEY = 'M2'+LOFORM.LCCSTTYPE+LOCONTFORM.LCMFGTMP+SPACE(6)+CRSESSION+PO+STR(LINENO,6)+"0001"+STYLE+CSTYGRADE && Sql
      CASE INLIST(LOFORM.LCTKTTYPE,'L','F')
        LCBOMKEY = ""
      CASE LOFORM.LCTKTTYPE = 'T'
        *! B610111,1 MMT 10/11/2012 Modify Payable invoice screen to handle MFG order case[Start]
        * LCBOMKEY = 'T2'+LOFORM.LCCSTTYPE+LOCONTFORM.LCMFGCODE+SPACE(6)+CRSESSION+PO+STR(LINENO,6)+"0002"+LFUPDITEM(CFABRIC,COLOR) && Sql
        LCBOMKEY = 'T2'+LOFORM.LCCSTTYPE+LOCONTFORM.LCMFGCODE+SPACE(6)+CRSESSION+PO+STR(LINENO,6)+"0002"+STYLE && Sql
        *! B610111,1 MMT 10/11/2012 Modify Payable invoice screen to handle MFG order case[End]
      ENDCASE

      LLSEEK = LOFORMSET.BOMLINE.SEEK(LCBOMKEY)      && add llseek for tracing && Sql
      *Get the proper MfgCode for each style and move to the proper record in BOMLINE [End]
      SELECT (LOFORMSET.LCFILEINUSE)
      IF !EOF('BOMLINE')
        m.UNITCOST = IIF(LNTOTBUD=0,0,BOMLINE.ITEMAMT/LNTOTBUD*LOCONTFORM.LNAMOUNT/&LCRCVQTY)
        m.ITEMAMT  = IIF(LNTOTBUD=0,0,BOMLINE.ITEMAMT/LNTOTBUD*LOCONTFORM.LNAMOUNT)
        LNTOTLANCT = LNTOTLANCT + &LCRCVQTY * EVAL(LCLNFLDNAME+LOFORM.LCCSTTYPE)
        LNTOTACTCT = LNTOTACTCT + &LCRCVQTY * EVAL(LCACFLDNAME+LOFORM.LCCSTTYPE)


        SELECT (LOFORMSET.LCAPINVTKT)
        APPEND BLANK
        *! B610111,1 MMT 10/11/2012 Modify Payable invoice screen to handle MFG order case[Start]
        *REPLACE CSTATUS    WITH 'A'        ,;
        CVENDCODE  WITH LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE  ,;
        CRECVTYPE  WITH IIF(&LCGRADE='1','R',IIF(&LCGRADE='2','S','D')) ,;
        CAPINVNO   WITH LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE  ,;
        CAPVILNO   WITH LOCONTFORM.LCINVLINENO,;
        CRSESSION  WITH LOCONTFORM.KBRSESSION ,;
        LINENO     WITH IIF(LOFORM.LCTKTTYPE='T',0,EVALUATE(LOFORMSET.LCFILEINUSE+'.LineNo')) ,;
        CIMTYP     WITH LOFORM.LCTKTTYPE    ,;
        CTKTNO     WITH IIF(LOFORM.LCTKTTYPE='S',POSLN.PO,LOCONTFORM.LCTICKET)     ,;
        ITEM       WITH BOMLINE.STYLE ,;
        COLOR      WITH IIF(TYPE('BomLine.SClr')<>'U',BOMLINE.SCLR,'')  ,;
        CDYELOT    WITH &LCDYELOT  ,;
        NAPTAPLQTY WITH &LCRCVQTY  ,;
        NAPAPLPRIC WITH m.UNITCOST ,;
        NAPAPLAMNT WITH m.ITEMAMT  ,;
        CWARECODE  WITH EVALUATE(LOFORMSET.LCFILEINUSE+'.cWareCode')
        REPLACE CSTATUS    WITH 'A'        ,;
          CVENDCODE  WITH LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE  ,;
          CRECVTYPE  WITH IIF(&LCGRADE='1','R',IIF(&LCGRADE='2','S','D')) ,;
          CAPINVNO   WITH LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE  ,;
          CAPVILNO   WITH LOCONTFORM.LCINVLINENO,;
          CRSESSION  WITH LOCONTFORM.KBRSESSION ,;
          LINENO     WITH IIF(LOFORM.LCTKTTYPE='T',0,EVALUATE(LOFORMSET.LCFILEINUSE+'.LineNo')) ,;
          CIMTYP     WITH LOFORM.LCTKTTYPE    ,;
          CTKTNO     WITH IIF(LOFORM.LCTKTTYPE='S',POSLN.PO,LOCONTFORM.LCTICKET)     ,;
          ITEM       WITH BOMLINE.STYLE ,;
          COLOR      WITH IIF(TYPE('BomLine.SClr')<>'U',BOMLINE.SCLR,IIF(LOFORM.LCTKTTYPE='T',SUBSTR(BOMLINE.STYLE,loFormSet.lnFabClrStart,loFormSet.lnFabClrLen),''))  ,;
          CDYELOT    WITH &LCDYELOT  ,;
          NAPTAPLQTY WITH &LCRCVQTY  ,;
          NAPAPLPRIC WITH m.UNITCOST ,;
          NAPAPLAMNT WITH m.ITEMAMT  ,;
          CWARECODE  WITH EVALUATE(LOFORMSET.LCFILEINUSE+'.cWareCode')

        *! B610111,1 MMT 10/11/2012 Modify Payable invoice screen to handle MFG order case[End]
        *Uppdate invoicetkt file with the WIP account in case of (S)hipment.  [Start]
        REPLACE APINVHDR.NLASTVILNO WITH  APINVHDR.NLASTVILNO  + 1 IN APINVHDR
        REPLACE CAPDGLACT WITH LFGETWIPAC(LCHDRKEY+IIF(LOFORM.LCTKTTYPE='S',POSLN.PO,LOCONTFORM.LCTICKET),LCHDRFILE,LCHDRORED) ;
          CAPDLINNO WITH STR(APINVHDR.NLASTVILNO,4)
        *Uppdate invoicetkt file with the WIP account in case of (S)hipment.  [End]

        *Get the correct WIP account with shipment ticket [Begin]
        REPLACE CAPDGLACT WITH IIF(!EMPTY(EVALUATE(LOFORMSET.LCAPVINVDT+'.cAPDGLAct')),EVALUATE(LOFORMSET.LCAPVINVDT+'.cAPDGLAct'),LFGETWIPAC(LCHDRKEY+IIF(LOFORM.LCTKTTYPE='S',POSLN.PO,LOCONTFORM.LCTICKET),LCHDRFILE,LCHDRORED)) ;
          CAPDLINNO WITH STR(APINVHDR.NLASTVILNO,4)
        *Get the correct WIP account with shipment ticket [end]
        *Add this line to accumulate the value that was
        *          actually stored in the file and not the value that
        *          should be stored, to take into consideration the
        *          rounding problems [Begin]
        LNTITMAMT  = LNTITMAMT + NAPAPLAMNT
        *Add this line to accumulate the value [End]
        IF INLIST(LOFORM.LCTKTTYPE,'S','I','M','A','D','R')
          REPLACE NAPAPLQTY1 WITH EVALUATE(LOFORMSET.LCFILEINUSE+'.Qty1') ,;
            NAPAPLQTY2 WITH EVALUATE(LOFORMSET.LCFILEINUSE+'.Qty2') ,;
            NAPAPLQTY3 WITH EVALUATE(LOFORMSET.LCFILEINUSE+'.Qty3') ,;
            NAPAPLQTY4 WITH EVALUATE(LOFORMSET.LCFILEINUSE+'.Qty4') ,;
            NAPAPLQTY5 WITH EVALUATE(LOFORMSET.LCFILEINUSE+'.Qty5') ,;
            NAPAPLQTY6 WITH EVALUATE(LOFORMSET.LCFILEINUSE+'.Qty6') ,;
            NAPAPLQTY7 WITH EVALUATE(LOFORMSET.LCFILEINUSE+'.Qty7') ,;
            NAPAPLQTY8 WITH EVALUATE(LOFORMSET.LCFILEINUSE+'.Qty8')
        ENDIF
      ENDIF
    ENDSCAN
  ENDIF

  *Contribution Based On Received Quantity
CASE LOCONTFORM.RBCNTRB = 2
  SELECT (LOFORMSET.LCFILEINUSE)
  LOTEMP = EVALUATE('loFormSet.'+LOFORMSET.LCFILEINUSE)
  LOTEMP.SEEK(LCKEY)
  IF !INLIST(LOFORM.LCTKTTYPE,'S')
    *B608642,1 WAM 08/04/2008 Don't overwrite the FOR expression previously built
    *loFormSet.lcForCond = ".T. "
    *B608642,1 WAM 08/04/2008 (End)
  ELSE
    LOFORMSET.LCFORCOND = "loFormSet.PosHdr.Seek('PP'+POSLN.PO)and POSHDR.status $ 'ACO' "+;
      "AND IIF(EMPTY(ALLTRIM(EVALUATE(loFormSet.lcAPvInvDt+'.Item'))),.T.,Style=ALLTRIM(EVALUATE(loFormSet.lcAPvInvDt+'.Item'))) AND crsession = loContForm.kbRSession" && Sql
  ENDIF
  *SUM REST &lcRcvQty WHILE EVAL(loFormSet.lcCondition)=lcKey FOR EVALUATE(loFormSet.lcForCond) TO lnTotBud
  SUM ALL &LCRCVQTY FOR EVALUATE(LOFORMSET.LCFORCOND) TO LNTOTBUD
  *Old: =SEEK(lcKey)
  LOTEMP.SEEK(LCKEY)
  SCAN REST FOR EVALUATE(LOFORMSET.LCFORCOND) .AND. &LCRCVQTY <> 0
    SELECT (LOFORMSET.LCAPINVTKT)
    APPEND BLANK

    REPLACE CSTATUS  WITH 'A'           ,;
      CVENDCODE  WITH LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE     ,;
      CAPINVNO   WITH LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE     ,;
      CAPVILNO   WITH LOCONTFORM.LCINVLINENO   ,;
      CIMTYP     WITH LOFORM.LCTKTTYPE     ,;
      CTKTNO     WITH IIF(LOFORM.LCTKTTYPE='S',POSLN.PO,LOCONTFORM.LCTICKET) ,;
      CRSESSION  WITH LOCONTFORM.KBRSESSION    ,;
      CRECVTYPE  WITH IIF(&LCGRADE='1','R',IIF(&LCGRADE='2','S','D')) ,;
      LINENO     WITH IIF(LOFORM.LCTKTTYPE='T',0,EVALUATE(LOFORMSET.LCFILEINUSE+'.LineNo')) ,;
      ITEM       WITH EVAL(LCITEM)  ,;
      COLOR      WITH IIF(TYPE(LCCOLOR)<>'U',&LCCOLOR,'') ,;
      CDYELOT    WITH EVAL(LCDYELOT),;
      NAPTAPLQTY WITH &LCRCVQTY     ,;
      NAPAPLPRIC WITH LOCONTFORM.LNAMOUNT/ LNTOTBUD ,;
      CWARECODE  WITH EVALUATE(LOFORMSET.LCFILEINUSE+'.cWareCode') ,;
      NAPAPLAMNT WITH &LCRCVQTY*LOCONTFORM.LNAMOUNT/LNTOTBUD
    REPLACE APINVHDR.NLASTVILNO WITH APINVHDR.NLASTVILNO  + 1 IN APINVHDR
    REPLACE CAPDGLACT WITH LFGETWIPAC(LCHDRKEY+IIF(LOFORM.LCTKTTYPE='S',POSLN.PO,LOCONTFORM.LCTICKET),LCHDRFILE,LCHDRORED) ;
      CAPDLINNO WITH  STR(APINVHDR.NLASTVILNO,4)

    *Get the correct WIP account with shipment ticket [Begin]
    REPLACE CAPDGLACT WITH IIF(!EMPTY(EVALUATE(LOFORMSET.LCAPVINVDT+'.cAPDGLAct')),EVALUATE(LOFORMSET.LCAPVINVDT+'.cAPDGLAct'),LFGETWIPAC(LCHDRKEY+IIF(LOFORM.LCTKTTYPE='S',POSLN.PO,LOCONTFORM.LCTICKET),LCHDRFILE,LCHDRORED)) ;
      CAPDLINNO WITH STR(APINVHDR.NLASTVILNO,4)
    *Get the correct WIP account with shipment ticket [end]

    *Add this line to accumulate the value that was
    *          actually stored in the file and not the value that
    *          should be stored, to take into consideration the
    *          rounding problems [Begin]
    LNTITMAMT  = LNTITMAMT  + NAPAPLAMNT
    *Add this line to accumulate the value [End]
    IF INLIST(LOFORM.LCTKTTYPE,'S','I','M','R','A','D')
      REPLACE NAPAPLQTY1 WITH EVALUATE(LOFORMSET.LCFILEINUSE+'.Qty1') ,;
        NAPAPLQTY2 WITH EVALUATE(LOFORMSET.LCFILEINUSE+'.Qty2') ,;
        NAPAPLQTY3 WITH EVALUATE(LOFORMSET.LCFILEINUSE+'.Qty3') ,;
        NAPAPLQTY4 WITH EVALUATE(LOFORMSET.LCFILEINUSE+'.Qty4') ,;
        NAPAPLQTY5 WITH EVALUATE(LOFORMSET.LCFILEINUSE+'.Qty5') ,;
        NAPAPLQTY6 WITH EVALUATE(LOFORMSET.LCFILEINUSE+'.Qty6') ,;
        NAPAPLQTY7 WITH EVALUATE(LOFORMSET.LCFILEINUSE+'.Qty7') ,;
        NAPAPLQTY8 WITH EVALUATE(LOFORMSET.LCFILEINUSE+'.Qty8')
    ENDIF
    LNTOTLANCT = LNTOTLANCT + &LCRCVQTY * EVAL(LCLNFLDNAME+LOFORM.LCCSTTYPE)
    LNTOTACTCT = LNTOTACTCT + &LCRCVQTY * EVAL(LCACFLDNAME+LOFORM.LCCSTTYPE)


  ENDSCAN

  *Contribute Manually
CASE LOCONTFORM.RBCNTRB = 3
  SELECT (LOFORMSET.LCFILEINUSE)
  LOTEMP = EVALUATE('loFormSet.'+LOFORMSET.LCFILEINUSE)
  LOTEMP.SEEK(LCKEY)
  IF !INLIST(LOFORM.LCTKTTYPE,'S')
    *B608642,1 WAM 08/04/2008 Don't overwrite the FOR expression previously built
    *loFormSet.lcForCond = ".T. "
    *B608642,1 WAM 08/04/2008 (End)
  ELSE
    LOFORMSET.LCFORCOND = "loFormSet.PosHdr.Seek('PP'+POSLN.PO)and POSHDR.status $ 'ACO' "+;
      "AND IIF(EMPTY(ALLTRIM(EVALUATE(loFormSet.lcAPvInvDt+'.Item'))),.T.,Style=ALLTRIM(EVALUATE(loFormSet.lcAPvInvDt+'.Item'))) AND crsession = loContForm.kbRSession" && Sql

  ENDIF
  SCAN REST FOR EVALUATE(LOFORMSET.LCFORCOND) .AND. &LCRCVQTY <> 0
    SELECT (LOFORMSET.LCAPINVTKT)
    APPEND BLANK

    REPLACE CSTATUS  WITH 'A'           ,;
      CVENDCODE  WITH LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE     ,;
      CAPINVNO   WITH LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE     ,;
      CAPVILNO   WITH LOCONTFORM.LCINVLINENO   ,;
      CIMTYP     WITH LOFORM.LCTKTTYPE     ,;
      CTKTNO     WITH IIF(LOFORM.LCTKTTYPE='S',POSLN.PO,LOCONTFORM.LCTICKET) ,;
      CRSESSION  WITH LOCONTFORM.KBRSESSION    ,;
      CRECVTYPE  WITH IIF(&LCGRADE='1','R',IIF(&LCGRADE='2','S','D')) ,;
      LINENO     WITH IIF(LOFORM.LCTKTTYPE='T',0,EVALUATE(LOFORMSET.LCFILEINUSE+'.LineNo')) ,;
      ITEM       WITH EVAL(LCITEM)  ,;
      COLOR      WITH IIF(TYPE(LCCOLOR)<>'U',&LCCOLOR,'') ,;
      CDYELOT    WITH EVAL(LCDYELOT),;
      NAPTAPLQTY WITH &LCRCVQTY     ,;
      NAPAPLPRIC WITH 0 ,;
      CWARECODE  WITH EVALUATE(LOFORMSET.LCFILEINUSE+'.cWareCode') ,;
      NAPAPLAMNT WITH 0

    *--Alb
    *Uppdate invoicetkt file with the WIP account in case of (S)hipment.  [Start]
    REPLACE APINVHDR.NLASTVILNO WITH APINVHDR.NLASTVILNO  + 1 IN APINVHDR
    REPLACE CAPDGLACT WITH LFGETWIPAC(LCHDRKEY+IIF(LOFORM.LCTKTTYPE='S',POSLN.PO,LOCONTFORM.LCTICKET),LCHDRFILE,LCHDRORED) ;
      CAPDLINNO WITH STR(APINVHDR.NLASTVILNO,4)
    *Uppdate invoicetkt file with the WIP account in case of (S)hipment.  [End]
    IF INLIST(LOFORM.LCTKTTYPE,'S','I','M','R','A','D')
      REPLACE NAPAPLQTY1 WITH EVALUATE(LOFORMSET.LCFILEINUSE+'.Qty1') ,;
        NAPAPLQTY2 WITH EVALUATE(LOFORMSET.LCFILEINUSE+'.Qty2') ,;
        NAPAPLQTY3 WITH EVALUATE(LOFORMSET.LCFILEINUSE+'.Qty3') ,;
        NAPAPLQTY4 WITH EVALUATE(LOFORMSET.LCFILEINUSE+'.Qty4') ,;
        NAPAPLQTY5 WITH EVALUATE(LOFORMSET.LCFILEINUSE+'.Qty5') ,;
        NAPAPLQTY6 WITH EVALUATE(LOFORMSET.LCFILEINUSE+'.Qty6') ,;
        NAPAPLQTY7 WITH EVALUATE(LOFORMSET.LCFILEINUSE+'.Qty7') ,;
        NAPAPLQTY8 WITH EVALUATE(LOFORMSET.LCFILEINUSE+'.Qty8')
    ENDIF
    LNTOTLANCT = LNTOTLANCT + &LCRCVQTY * EVAL(LCLNFLDNAME+LOFORM.LCCSTTYPE)
    LNTOTACTCT = LNTOTACTCT + &LCRCVQTY * EVAL(LCACFLDNAME+LOFORM.LCCSTTYPE)
  ENDSCAN
ENDCASE



*add function to return the act. cost that remove from the contrib. file
IF LFACTCSTRMV(.F.)+LNTOTACTCT + LOCONTFORM.LNAMOUNT - LFACTCSTRMV(.T.) > LNTOTLANCT
  *Message : 04170
  *The actual cost for  has exceeded the landed cost.
  *Button : 00000
  *Ok
  =GFMODALGEN('QRM04170B00000','Dialog',ALLTRIM(LOFORMSET.LACOSTTYPE[ASCAN(loFormSet.laCostType,loForm.lcCstType)-1]))
ENDIF
IF !INLIST(LOFORM.LCTKTTYPE,'L','F')
  SELECT (LOFORMSET.LCFILEINUSE)
  SET RELATION OFF INTO BOMLINE
ENDIF
SELECT (LOFORMSET.LCAPINVTKT)
SET KEY TO

*-- If over contributed.
IF ABS(LNTITMAMT) > ABS(EVALUATE(LOFORMSET.LCAPVINVDT+'.nAPAprAmnt'))
  REPLACE NAPAPLAMNT WITH NAPAPLAMNT - (ABS(LNTITMAMT) - ABS(LOCONTFORM.LNAMOUNT))
  LNTITMAMT = LNTITMAMT - (ABS(LNTITMAMT) - ABS(LOCONTFORM.LNAMOUNT))
  =SEEK(PADR(LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE,8)+PADR(LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE,12)+LOCONTFORM.LCINVLINENO+SPACE(6))
  REPLACE NAPAPLAMNT WITH NAPAPLAMNT - LNTITMAMT

ELSE    && Else (If not over contributed)
  *-- Apply the difference to the uncontributed amount record

  IF ABS(LNTITMAMT) < ABS(EVALUATE(LOFORMSET.LCAPVINVDT+'.nAPAprAmnt'))
    REPLACE NAPAPLAMNT WITH NAPAPLAMNT - (ABS(LNTITMAMT) - ABS(LOCONTFORM.LNAMOUNT))
    LNTITMAMT = LNTITMAMT - (ABS(LNTITMAMT) - ABS(LOCONTFORM.LNAMOUNT))
  ENDIF
  *Apply the difference to the last line. [End]
  =SEEK(PADR(LOFORMSET.ARIAFORM1.KBVENDCODE.KEYTEXTBOX.VALUE,8)+PADR(LOFORMSET.ARIAFORM1.KBINVNO.KEYTEXTBOX.VALUE,12)+LOCONTFORM.LCINVLINENO+SPACE(6))
  REPLACE NAPAPLAMNT WITH NAPAPLAMNT - LNTITMAMT

ENDIF

*-- MAN is the full amount is contributed delete the record
IF NAPAPLAMNT = 0

  *Add this line to update the line status as deleted [Begin]
  REPLACE CSTATUS WITH IIF(NRECNO = 0 , 'S' , 'D')
  *Add this line to update the line status as deleted [End]
  DELETE
ENDIF
LOCONTFORM.LNCNTRBAMNT = LOCONTFORM.LNCNTRBAMNT + LNTITMAMT
*Restore the old order in BOMLINE
*SET ORDER TO TAG &lcBomOrd IN BOMLINE
LOFORMSET.BOMLINE.SETORDER(LCBOMORD)

RETURN
*-- End of lfvProCntrb


*!*************************************************************
*! Name      : lfGetWIPAc
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 11/07/2004
*! Purpose   : To get the WIP account based on Gl link code defined in poshdr file
*!*************************************************************
*! Parameters: lcHdrKey , lcHdrFile , lcHdrOred
*!*************************************************************
*! Returns   :  WIP Account
*!*************************************************************
FUNCTION LFGETWIPAC
PARAMETERS  LCHDRKEY , LCHDRFILE , LCHDRORED

PRIVATE LCGLACCT , LNAREA, LCORDER , LNRECNO
LOCAL LOTEMP

IF EMPTY(LCHDRKEY) OR EMPTY(LCHDRFILE) OR EMPTY(LCHDRORED)
  RETURN ""
ENDIF

LCGLACCT = ""
LNAREA= SELECT()
LCORDER = ORDER()
LNRECNO = RECNO()

SELECT (LCHDRFILE)
LOTEMP = EVALUATE('loFormSet.'+LCHDRFILE)
*Old: SET ORDER TO TAG (lcHdrOred) && sql
IF LOTEMP.SEEK(LCHDRKEY,LCHDRORED,.T.)
  LCGLACCT = LFVAASACT(LOFORMSET,LOFORM,EVALUATE(LCHDRFILE+'.LINK_CODE'),"013")
ENDIF

SELECT (LNAREA)
SET ORDER TO (LCORDER)
IF BETWEEN(LNRECNO , 1, RECCOUNT() )
  GOTO LNRECNO
ENDIF

RETURN LCGLACCT
*-- End of lfGetWIPAc


*:********************************************************************
*: Name      : lfActCstRmv
*: Developer : Ahmad Shoukry Mohammed (ASM)
*: Date      : 11/07/2004
*: Purpose   : Return the Act cost that removed from (lcApInTkt) file.llOldRec = .T.
*:             Return the new act cost from the other invoice lines. llOldRec = .F.
*!*************************************************************
*! Parameters: llOldRec
*:********************************************************************
*: Returns   : lnSumAmnt
*:********************************************************************
FUNCTION LFACTCSTRMV
PARAMETERS LLOLDREC
PRIVATE LNSUMAMNT,LCALIAS,LNRECNO,LCWHERE
LNSUMAMNT = 0
LCALIAS = ALIAS()
SELECT (LOFORMSET.LCAPINVTKT)
LNRECNO = IIF(!EOF(),RECNO(),0)
SET DELETE OFF
LCWHERE = IIF(LLOLDREC,"(cStatus = 'D' AND !EMPTY(nrecno))",;
  "cStatus = 'A' AND cAPVILNo <> loContForm.lcInvLineNo")
LCWHERE = "ctktno = loForm.kbInvTktNo.KeyTextBox.Value AND " + LCWHERE
IF !EMPTY(ALLTRIM(EVALUATE(LOFORMSET.LCAPVINVDT+'.item')))
  LCWHERE = LCWHERE + " AND item = '" + EVALUATE(LOFORMSET.LCAPVINVDT+'.item')+"'"
ENDIF
SELECT SUM(NAPAPLAMNT) FROM (LOFORMSET.LCAPINVTKT) WHERE &LCWHERE INTO ARRAY LASUM
IF _TALLY > 0
  LNSUMAMNT = LASUM[1]
ENDIF
SET DELETE ON
IF LNRECNO > 0
  GOTO LNRECNO
ENDIF
SELECT (LCALIAS)

RETURN LNSUMAMNT
*-- End of lfActCstRmv



***CCC***



*!**************************************************************************
*!
*!      Function: lfvUsrFld
*!
*!**************************************************************************
*C200178,1 AAN Function for update user field array with the vendor payment type.
FUNCTION LFVUSRFLD
*-- Get position of packs in laUsrField
PRIVATE LNVENPYPS
LNVENPYPS = ASCAN(LAUSRFIELD,"CVENPYTYPE")
IF LNVENPYPS  > 0
  LNVENPYPS = ASUBSCRIPT(LAUSRFIELD,LNVENPYPS ,1)
  LAUSRFIELD[lnVenPYPs ,6] = APVENDOR.CVENPYTYPE
ENDIF




****************************************************************************
*B605485,1 SSH 11/Feb/2002 Add Validation on user Privileges in adding new.
****************************************************************************
FUNCTION LFGETPREV
****************************************************************************
*Function to check if the user have preveligies to add new vendor or no.
****************************************************************************
PRIVATE LNOLDALS,  LLTORETURN

LNOLDALS = SELECT(0)
LLTORETURN = .T.
LLUSRPRV   = GFSYSOPEN(GCSYSHOME+"SYUUSRPR",'CUSER_ID')
LCPROSS_ID = UPPER(SUBSTR("AWRAPVENDR",4))

IF GLLOG_REQU
  SELECT SYUUSRPR
  IF SEEK(ALLTRIM(GCUSER_ID)+GCACT_APPL+GCACT_COMP+LCPROSS_ID) OR;
      SEEK(ALLTRIM(GCUSER_ID)+'SY'+GCACT_COMP+LCPROSS_ID)
    LLTORETURN = SYUUSRPR.LADDREC
  ELSE
    IF SEEK(ALLTRIM(GCUSER_GRP)+GCACT_APPL+GCACT_COMP+LCPROSS_ID) OR;
        SEEK(ALLTRIM(GCUSER_GRP)+'SY'+GCACT_COMP+LCPROSS_ID)
      LLTORETURN = SYUUSRPR.LADDREC
    ENDIF
  ENDIF
ELSE
  LLTORETURN = .T.
ENDIF
USE IN IIF(LLUSRPRV,'SYUUSRPR',0)
SELECT(LNOLDALS)
RETURN(LLTORETURN)


*:---------------------------------------------------------------------
*! Name      : gfwCodePop
*! Developer : Yasser Mohammed Aly - (YMA)
*! Date      : 04/27/97
*! Purpose   : Function to fill any code array with on of the
*:             following values :
*:               1) A list of the available codes from the codes file.
*:               2) The default code value.
*:               3) "ALL"
*:               4) "N/A"
*: Job ID    : E# 300631
*:---------------------------------------------------------------------
*: Calls              : IsEdtble()
*:---------------------------------------------------------------------
*: Passed Parameters  : laInfArray : Pointer to the code information array.
*:                      lcField    : The code to be displayed.
*:                      lcFillWith : Fill the array with ...
*:                      "L" : List of the available codes.
*:                      "D" : Default value.
*:                      "A" : "All"
*:                      "N" : "N/A"
*:---------------------------------------------------------------------
*: Example            : = gfwCodePop(@laCodInfo, "CTERMCODE", "A")
*:---------------------------------------------------------------------
FUNCTION GFWCODEPOP
PARAMETERS LAINFARRAY, LCFIELD, LCFILLWITH, LCACTCOMP

PRIVATE LNALIAS, LCTAG, LCTOUPDAT, LCCURPOPUP, LCSTATUS, LLADDALL
PRIVATE LLADDNOA, LCALTFILE, LCALTINDX, LCALTEXP, LCALTFIELD, LLEDITABLE
PRIVATE LCALL, LCNA, LCALLCODE, LCNACODE, LCSEPRAT, LCCURCODE, LCTAG
PRIVATE LCFIELDS, LNNEWVAL, LLALTFILE, LCSERFILE, LCSERINDX, LCSEREXP
PRIVATE LCSERFIELD, LCCODE, LCDESC, LCORDTAG


*-- If the passed parameters are not valid than go out of the function.
IF TYPE("laInfArray")#"C" OR TYPE("lcField")#"C"
  RETURN .F.
ENDIF

*-- If the last parameter is not passed than default it to build the list.
LCSETWITH  = SPACE(0)
LCFILLWITH = IIF(TYPE("lcFillWith")#"C", "L", ALLTRIM(UPPER(LCFILLWITH)))
IF ATC(",",LCFILLWITH) > 0
  LCSETWITH  = RIGHT(LCFILLWITH,LEN(LCFILLWITH)-ATC(",",LCFILLWITH))
  LCSETWITH  = ALLTRIM(LCSETWITH)
  LCFILLWITH = IIF(EMPTY(LCSETWITH), "L", "V")
ELSE
  LCFILLWITH = IIF(!(LCFILLWITH $ "LDANT"), "L", LCFILLWITH)
ENDIF

*-- Set the company used variable.
LCACTCOMP = IIF(TYPE("lcActComp")#"C", OARIAAPPLICATION.ACTIVECOMPANYID, LCACTCOMP)

*-- Get the position of the nedded field in the code information array.
LNPOS      = ASCAN (LAINFARRAY, LCFIELD)

*-- If it does not exist than go out of the function.
IF LNPOS = 0
  RETURN .F.
ENDIF

*-- Be sure that the field name has a 10 character length.
LCFIELD    = UPPER(PADR(LCFIELD,10))

*-- Initialize the needed variables from the code information array.
LCTOUPDAT  = LAINFARRAY[lnPos+1]
LCCURPOPUP = LAINFARRAY[lnPos+2]
LCSTATUS   = LAINFARRAY[lnPos+3]
LLADDALL   = LAINFARRAY[lnPos+4]
LLADDNOA   = LAINFARRAY[lnPos+5]
LCALTFILE  = LAINFARRAY[lnPos+6]
LCALTINDX  = LAINFARRAY[lnPos+7]
LCALTEXP   = LAINFARRAY[lnPos+8]
LCALTFIELD = LAINFARRAY[lnPos+9]

*-- Check if this code is editable or not.
LNFW       = 0

*llEditable = oAriaApplication.IsEdtble(lcField, @lnFW, lcActComp)
LLEDITABLE = GFISEDTBLE(LCFIELD, @LNFW)

*-- The "ALL" string and code, and the "N/A" string and code.

*N000682,1 MMT 12/09/2012 Globalization changes[Start]
*LCALL      = PADR("ALL",IIF(LLEDITABLE, 39, 30))
*LCNA       = PADR("N/A",IIF(LLEDITABLE, 39, 30))
LCALL      = PADR(IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_ALLVALUE,loformset.GetHeaderText("LANG_APPYINV_ALLVALUE",loformset.HeaderAlias)),IIF(LLEDITABLE, 39, 30))
LCNA       = PADR(IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_NOTAPPLICABLE,loformset.GetHeaderText("LANG_APPYINV_NOTAPPLICABLE",loformset.HeaderAlias)),IIF(LLEDITABLE, 39, 30))
*N000682,1 MMT 12/09/2012 Globalization changes[End]
LCALLCODE  = CHR(42)
LCNACODE   = SPACE(0)
LCSEPRAT   = SPACE(1) + "-" + SPACE(1)
LNALIAS    = SELECT()
DO CASE

  *-- If we want to build the array and it is not built from before.
CASE LCFILLWITH = "L" AND LCSTATUS # LCFILLWITH
  LCCURCODE = &LCTOUPDAT[&lcCurPopUp,2]
  SELECT CODES
  LCTAG = TAG()
  SET ORDER TO
  LCFIELDS = IIF(LLEDITABLE, "CCODE_NO+lcSeprat+CDISCREP AS Code", "CDISCREP")

  *--HDM B602174,1 Sort the codes by the code number if the code is editable,
  *--HDM B602174,1 otherwise sort them by the description.
  *--HDM B602174,1 (Added the if condition and the SQL in the else part).
  IF LLEDITABLE
    SELECT &LCFIELDS,CCODE_NO FROM CODES;
      WHERE CDEFCODE+CRLTFIELD+CFLD_NAME = "N"+"N"+LCFIELD;
      ORDER BY CCODE_NO ;
      INTO ARRAY &LCTOUPDAT
  ELSE
    SELECT &LCFIELDS,CCODE_NO FROM CODES;
      WHERE CDEFCODE+CRLTFIELD+CFLD_NAME = "N"+"N"+LCFIELD;
      ORDER BY CDISCREP ;
      INTO ARRAY &LCTOUPDAT
  ENDIF
  *--HDM B602174,1 End.

  SELECT CODES
  SET ORDER TO TAG &LCTAG
  LAINFARRAY[lnPos+3] = "L"

  IF LLADDALL
    DIMENSION &LCTOUPDAT[ALEN(&lcToUpdat,1)+1,2]
    = AINS(&LCTOUPDAT,1)
    &LCTOUPDAT[1] = LCALL
    &LCTOUPDAT[2] = LCALLCODE
  ENDIF

  IF LLADDNOA
    DIMENSION &LCTOUPDAT[ALEN(&lcToUpdat,1)+1,2]
    = AINS(&LCTOUPDAT,1)
    &LCTOUPDAT[1] = LCNA
    &LCTOUPDAT[2] = LCNACODE
  ENDIF

  LNNEWVAL    = ASCAN(&LCTOUPDAT, LCCURCODE)
  &LCCURPOPUP = IIF(LNNEWVAL <> 0, IIF(LNNEWVAL=1,1,ROUND(LNNEWVAL/2,0)), 1)

  *-- Put a passed value in the array.
CASE LCFILLWITH = "V"
  LCCODE = PADR(LCSETWITH,6)
  SELECT CODES
  LCORDTAG = TAG()
  SET ORDER TO TAG CODES
  LCDESC = IIF(SEEK("N"+LCCODE+"N"+LCFIELD), CDISCREP, SPACE(0))
  SET ORDER TO TAG LCORDTAG
  DIMENSION &LCTOUPDAT[1,2]
  &LCTOUPDAT[1,1] = IIF(LLEDITABLE, LCCODE+LCSEPRAT+LCDESC, LCDESC)
  &LCTOUPDAT[1,2] = LCCODE
  &LCCURPOPUP     = 1
  LAINFARRAY[lnPos+3] = LCFILLWITH

  *-- Put only the default value from an alternative file in the Array.
CASE LCFILLWITH = "T"
  LLALTFILE  = TYPE("lcAltFile")  = "C" AND !EMPTY(LCALTFILE ) AND ;
    TYPE("lcAltIndx")  = "C" AND !EMPTY(LCALTINDX ) AND ;
    TYPE("lcAltExp")   = "C" AND !EMPTY(LCALTEXP  ) AND ;
    TYPE("lcAltField") = "C" AND !EMPTY(LCALTFIELD)
  LCSERFILE  = IIF(LLALTFILE, LCALTFILE , "")
  LCSERINDX  = IIF(LLALTFILE, LCALTINDX , "")
  LCSEREXP   = IIF(LLALTFILE, LCALTEXP  , "")
  LCSERFIELD = IIF(LLALTFILE, LCALTFIELD, "")

  STORE SPACE(0) TO LCCODE, LCDESC
  IF LLALTFILE
    SELECT (LCSERFILE)
    LCTAG     = TAG()
    LCIDXEXP  = SYS(14,VAL(SYS(21)))
    LCCURRECP = &LCIDXEXP
    SET ORDER TO TAG &LCSERINDX
    IF SEEK(&LCSEREXP, LCSERFILE)
      LCCODE = ALLTRIM(&LCSERFIELD)
      IF EMPTY(LCCODE) OR LCCODE = "*"
        LCDESC = IIF(EMPTY(LCCODE), LCNA, LCALL)
      ELSE
        LCCODE = PADR(&LCSERFIELD,6)
        SELECT CODES
        LCORDTAG = TAG()
        SET ORDER TO TAG CODES
        LCDESC = IIF(SEEK("N"+LCCODE+"N"+LCFIELD), CDISCREP, SPACE(0))
        SET ORDER TO TAG LCORDTAG
      ENDIF
    ENDIF
    SELECT (LCSERFILE)
    SET ORDER TO TAG &LCTAG
    = SEEK(LCCURRECP)
  ENDIF
  LCCODE = PADR(LCCODE,06)
  LCDESC = PADR(LCDESC,30)
  DIMENSION &LCTOUPDAT[1,2]
  &LCTOUPDAT[1,1]     = IIF(LLEDITABLE, LCCODE+LCSEPRAT+LCDESC, LCDESC)
  &LCTOUPDAT[1,2]     = LCCODE
  &LCCURPOPUP         = 1
  LAINFARRAY[lnPos+3] = "T"

  *-- Put only the default value from the codes file in the Array.
CASE LCFILLWITH = "D"
  SELECT CODES
  LCTAG = TAG()
  SET ORDER TO TAG CCODE_NO
  STORE SPACE(0) TO LCCODE, LCDESC
  IF SEEK('D'+LCFIELD)
    LCCODE = CCODE_NO
    LCDESC = CDISCREP
  ENDIF
  SET ORDER TO TAG &LCTAG
  LCCODE = PADR(LCCODE,06)
  LCDESC = PADR(LCDESC,30)
  DIMENSION &LCTOUPDAT[1,2]
  &LCTOUPDAT[1,1]     = IIF(LLEDITABLE, LCCODE+LCSEPRAT+LCDESC, LCDESC)
  &LCTOUPDAT[1,2]     = LCCODE
  &LCCURPOPUP         = 1
  LAINFARRAY[lnPos+3] = "D"

  *-- Put only "N/A" or "All" in the list.
CASE LCFILLWITH $ "AN"
  DIMENSION &LCTOUPDAT[1,2]
  &LCTOUPDAT[1,1] = IIF(LCFILLWITH = "A", LCALL,     LCNA)
  &LCTOUPDAT[1,2] = IIF(LCFILLWITH = "A", LCALLCODE, LCNACODE)
  &LCCURPOPUP     = 1
  LAINFARRAY[lnPos+3] = LCFILLWITH

ENDCASE

*-- Refresh the popup.
*SHOW GET &lcCurPopUp

SELECT(LNALIAS)

*:*************************************************************
*: Name      : lfDyeConfig
*: Developer : Ahmad Shoukry Mohammed (ASM)
*: Date      : 11/04/2004
*: Purpose   : Return Dyelot or Configuration according to Settings.
*:*************************************************************
*: Returns   : Dyelot or Configuration.
*:*************************************************************
FUNCTION LFDYECONFIG
LOCAL LLRETVAL
DIMENSION LASETUPS[2,2]
LASETUPS[1,1]  = 'M_Dyelot'     &&-- Use Dyelot (IC)
LASETUPS[2,1] = 'M_STYCNFG'    &&-- Use configuration
=GFGETMEMVAR(@LASETUPS,OARIAAPPLICATION.ACTIVECOMPANYID)
IF LASETUPS[1,2]='Y'
  *N000682,1 MMT 11/22/2012 Globalization changes[Start]
  *LLRETVAL = IIF((LASETUPS[2,2]='Y'),'Configuration','Dyelot')
  *N000682,1 11/20/2012 MMT Globlization changes[Start]
*LLRETVAL = IIF((LASETUPS[2,2]='Y'),LANG_APPYINV_CONFIGURE,LANG_APPYINV_DYELOT)
LLRETVAL = IIF((LASETUPS[2,2]='Y'),IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_CONFIGURE,loFormSet.GetHeaderText("LANG_APPYINV_CONFIGURE",loFormSet.HeaderAlias)),IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_APPYINV_DYELOT,loFormSet.GetHeaderText("LANG_APPYINV_DYELOT",loFormSet.HeaderAlias)))
*N000682,1 11/20/2012 MMT Globlization changes[End]

  *N000682,1 MMT 11/22/2012 Globalization changes[END]
ELSE
  LLRETVAL = ''
ENDIF
RETURN LLRETVAL

*:*************************************************************
*: Name      : lfUpdItem
*: Developer : AHMED MAHER (AMH)
*: Date      : 04/11/2004
*: Purpose   : Update ITEM field with correct segment or fabric and color.
*:*************************************************************
*: Returns   : Item Value.
*:*************************************************************

FUNCTION LFUPDITEM
LPARAMETERS LCFABRIC,LCCOLOR

LCFABRIC = IIF(TYPE('lcFabric')='C',LCFABRIC,'')
LCCOLOR = IIF(TYPE('lcColor')='C',LCCOLOR,'')

LOCAL LNALIAS,LCRET
LNALIAS = SELECT(0)

*-- Get the Material Code structure.
LOCAL OGETITEMMASK,LCITEMPIC,LNI,LNREMITEM,LCREMITEM
OGETITEMMASK = CREATEOBJECT('GetItemMask')
LOCAL ARRAY LAITEMSEG[1,1]
= OGETITEMMASK.DO(@LAITEMSEG,'','0002')
LCITEMPIC = OGETITEMMASK.DO('PI','','0002')
LCRET = STRTRAN(LCITEMPIC,'X','*')
*lnRemItem = 7
LNREMITEM = LEN(LCITEMPIC)
LCREMITEM = PADR(LCFABRIC,LNREMITEM)
FOR LNI = 1 TO ALEN(LAITEMSEG,1)
  IF LAITEMSEG[lnI,1] = 'C'
    LCRET = STUFF(LCRET,LAITEMSEG[lnI,4],LEN(LAITEMSEG[lnI,3]),PADR(LCCOLOR,LEN(LAITEMSEG[lnI,3])))
  ENDIF

  IF LAITEMSEG[lnI,1] $ 'FO' AND LNREMITEM > 0
    LCRET = STUFF(LCRET,LAITEMSEG[lnI,4],LEN(LAITEMSEG[lnI,3]),PADR(LCREMITEM,LEN(LAITEMSEG[lnI,3])))
    LNREMITEM = LNREMITEM - LEN(LAITEMSEG[lnI,3])
    IF LNREMITEM > 0
      LCREMITEM = SUBSTR(LCREMITEM,LEN(LAITEMSEG[lnI,3])+1)
    ENDIF
  ENDIF
ENDFOR

SELECT (LNALIAS)
RETURN LCRET
*-- End of lfUpdItem

*:*************************************************************
*: Name      : lfUpdateSql
*: Developer : Ahmad Shoukry Mohammed (ASM)
*: Date      : 10/20/2004
*: Purpose   : To Update the SQL Tables.
*:*************************************************************
*: Returns   : True / False
*:*************************************************************
FUNCTION LFUPDATESQL
PARAMETERS LOFORMSET, LCTRANCODE
LOCAL LLFLAG
LLFLAG = .T.

IF USED('POSHDR')
  LLFLAG = LLFLAG AND LOFORMSET.POSHDR.TABLEUPDATE(LCTRANCODE)
  IF !LLFLAG
    RETURN .F.
  ENDIF
ENDIF

IF USED('POSLN')
  LLFLAG = LLFLAG AND LOFORMSET.POSLN.TABLEUPDATE(LCTRANCODE)
  IF !LLFLAG
    RETURN .F.
  ENDIF
ENDIF

IF USED('CUTTKTH')
  LLFLAG = LLFLAG AND LOFORMSET.CUTTKTH.TABLEUPDATE(LCTRANCODE)
  IF !LLFLAG
    RETURN .F.
  ENDIF
ENDIF

IF USED('CUTTKTL')
  LLFLAG = LLFLAG AND LOFORMSET.CUTTKTL.TABLEUPDATE(LCTRANCODE)
  IF !LLFLAG
    RETURN .F.
  ENDIF
ENDIF

IF USED('POFHDR')
  LLFLAG = LLFLAG AND LOFORMSET.POFHDR.TABLEUPDATE(LCTRANCODE)
  IF !LLFLAG
    RETURN .F.
  ENDIF
ENDIF

IF USED('POFLN')
  LLFLAG = LLFLAG AND LOFORMSET.POFLN.TABLEUPDATE(LCTRANCODE)
  IF !LLFLAG
    RETURN .F.
  ENDIF
ENDIF

IF USED('MMFGORDH')
  LLFLAG = LLFLAG AND LOFORMSET.MMFGORDH.TABLEUPDATE(LCTRANCODE)
  IF !LLFLAG
    RETURN .F.
  ENDIF
ENDIF

IF USED('MMFGORDD')
  LLFLAG = LLFLAG AND LOFORMSET.MMFGORDD.TABLEUPDATE(LCTRANCODE)
  IF !LLFLAG
    RETURN .F.
  ENDIF
ENDIF

IF USED('BOMCOST')
  LLFLAG = LLFLAG AND LOFORMSET.BOMCOST.TABLEUPDATE(LCTRANCODE)
  IF !LLFLAG
    RETURN .F.
  ENDIF
ENDIF

IF USED('CTKTBOM')
  LLFLAG = LLFLAG AND LOFORMSET.CTKTBOM.TABLEUPDATE(LCTRANCODE)
  IF !LLFLAG
    RETURN .F.
  ENDIF
ENDIF

IF USED('BOMLINE')
  *SELECT *, RECNO() as RecNo FROM (loFormSet.BOMLINE.lcCursorUpdate) WITH (Buffering = .T.) INTO DBF c:\t
  LLFLAG = LLFLAG AND LOFORMSET.BOMLINE.TABLEUPDATE(LCTRANCODE)
  IF !LLFLAG
    RETURN .F.
  ENDIF
ENDIF

RETURN LLFLAG
*-- End of lfUpdateSql


*:*************************************************************
*: Name      : lfRevertSql
*: Developer : Ahmad Shoukry Mohammed (ASM)
*: Date      : 10/20/2004
*: Purpose   : To Revert the SQL Tables.
*:*************************************************************
*: Returns   : None
*:*************************************************************
FUNCTION LFREVERTSQL
PARAMETERS LOFORMSET

IF USED('POSHDR')
  LOFORMSET.POSHDR.TABLEREVERT()
ENDIF

IF USED('POSLN')
  LOFORMSET.POSLN.TABLEREVERT()
ENDIF

IF USED('CUTTKTH')
  LOFORMSET.CUTTKTH.TABLEREVERT()
ENDIF

IF USED('CUTTKTL')
  LOFORMSET.CUTTKTL.TABLEREVERT()
ENDIF

IF USED('POFHDR')
  LOFORMSET.POFHDR.TABLEREVERT()
ENDIF

IF USED('POFLN')
  LOFORMSET.POFLN.TABLEREVERT()
ENDIF

IF USED('MMFGORDH')
  LOFORMSET.MMFGORDH.TABLEREVERT()
ENDIF

IF USED('MMFGORDD')
  LOFORMSET.MMFGORDD.TABLEREVERT()
ENDIF

IF USED('BOMCOST')
  LOFORMSET.BOMCOST.TABLEREVERT()
ENDIF

IF USED('CTKTBOM')
  LOFORMSET.CTKTBOM.TABLEREVERT()
ENDIF

IF USED('BOMLINE')
  LOFORMSET.BOMLINE.TABLEREVERT()
ENDIF

RETURN
*-- End of lfRevertSql




*:*************************************************************
*: Name      : lfCheckSql
*: Developer : Ahmad Shoukry Mohammed (ASM)
*: Date      : 09/06/2005
*: Purpose   : To Check the Availabilty of SQL Service.
*:*************************************************************
*: Returns   : True / False
*:*************************************************************
FUNCTION LFCHECKSQL
LOCAL LNRESULT, LLRETVAL

LNRESULT=OARIAAPPLICATION.REMOTECOMPANYDATA.SQLRUN('Select Top 0 * From PosHdr (INDEX=POSHDR)','TmpChkCur',;
  'POSHDR',OARIAAPPLICATION.ACTIVECOMPANYCONSTR,3,'SAVE',SET("Datasession"))
LLRETVAL = (LNRESULT=1)
IF USED('TmpChkCur')
  USE IN TMPCHKCUR
ENDIF
IF !LLRETVAL
  OARIAAPPLICATION.REMOTECOMPANYDATA.CHECKRETRESULT("sqlrun",LNRESULT,.T.)
ENDIF

*!*  LOCAL lnHandle, llRetVal

*!*    lnHandle = SQLSTRINGCONNECT(oAriaApplication.ActiveCompanyConStr)
*!*    MESSAGEBOX(oAriaApplication.ActiveCompanyConStr+CHR(13)+PADR(lnHandle,10)+PADR(SET("Datasession"),10))
*!*    llRetVal = lnHandle>0 and (SQLEXEC(lnHandle,'Select Top 0 * From PosHdr (INDEX=POSHDR)','TmpChkCur')=1)

*!*    IF lnHandle>0
*!*      SQLDISCONNECT(lnHandle)
*!*    ENDIF
*!*    IF USED('TmpChkCur')
*!*      USE IN TmpChkCur
*!*    ENDIF
*!*    IF !llRetVal
*!*      MESSAGEBOX('Error in  SQL Server')
*!*    ENDIF

RETURN LLRETVAL



*!*************************************************************
*! Name      : lfCheckTmpDist
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 8/16/2004
*! Purpose   : To Get next adjustment number
*!*************************************************************
*! Parameters: The FormSet
*!*************************************************************
*! Returns   : None
*!*************************************************************
*! B130111,1 ASM 11/01/2005 Allow the User to Edit an Invoice whose posted date is locked, but make entries on system date [Start]
FUNCTION LFCHECKTMPDIST
PARAMETERS LOFORMSET
LOCAL LCALIAS
LCALIAS = ALIAS()
SELECT (LOFORMSET.LCTMPDIST)

*! B610221,1 HIA 01/29/2013 Aria4xp - AP - AP Invoice-Amend Details tab updates incorrect period [T20121217.0011][Start]
LCPSTYER1 = ''
LCPSTPRD1 = ''
=LFVLDATE(OARIAAPPLICATION.PRNTCOMPANYID , @LCPSTPRD1 , @LCPSTYER1 , Date())
REPLACE ALL cfisfyear WITH LCPSTYER1, cfspprdid WITH LCPSTPRD1 FOR PADR(CAPSESSNO,8)==PADR(LOFORMSET.LCSEQUENCE,8)
*! B610221,1 HIA 01/29/2013 Aria4xp - AP - AP Invoice-Amend Details tab updates incorrect period [T20121217.0011][End]

REPLACE ALL DAPDTRDAT WITH DATE() FOR PADR(CAPSESSNO,8)==PADR(LOFORMSET.LCSEQUENCE,8)
IF !EMPTY(LCALIAS)
  SELECT (LCALIAS)
ENDIF
RETURN
*! B130111,1 ASM 11/01/2005 Allow the User to Edit an Invoice whose posted date is locked, but make entries on system date [End]
*!*************************************************************
*! Name      : lfAddLinNotes
*! Developer : Mohamed Shokry Mohamed (MHM)
*! Date      : 2/27/2008
*! Purpose   : to create notes per line
*!*************************************************************
*! Parameters: The FormSet
*!*************************************************************
*! Returns   : None
*!*************************************************************
*! T20071119.0009 - E302496
FUNCTION LFADDLINNOTES
PARAMETERS LOFORMSET


DO CASE
CASE LOFORMSET.ACTIVEMODE= "V"
  DO FORM OARIAAPPLICATION.SCREENHOME+"\ap\apnotes.scx" WITH "APDIST2.mapdist",.F.
CASE LOFORMSET.ACTIVEMODE= "A" OR LOFORMSET.ACTIVEMODE= "E"
  DO FORM OARIAAPPLICATION.SCREENHOME+"\ap\apnotes.scx" WITH LOFORMSET.LCTMPDIST+".mapdist",.T.
  IF LOFORMSET.ACTIVEMODE= "E"

    SELECT(LOFORMSET.LCTMPDIST)
    REPLACE CSTATUS   WITH 'M'
  ENDIF
  LFDISTREFRESH(LOFORMSET)
ENDCASE

RETURN



*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*!*************************************************************
*! Name      : lfTmp2Mast
*! Developer : Mariam Mazhar(MMT)
*! Date      : 08/10/2009
*! Purpose   : to Update Master SQL Tables
*!*************************************************************
FUNCTION LFTMP2MAST
PARAMETERS LCMASTFILE,LCTEMPFILE,LCFXDMSG,LCVARMSG
PRIVATE    LCMASTFILE,LCTEMPFILE,LCSAVALIAS,LCFXDMSG,LCVARMSG



LOTOOLBARWINDOW = OARIAAPPLICATION.OTOOLBAR.OWINDPARENT
*-- Include the .H file
*!B609915,1 SAB 05/13/2012 APDIST file is not updated and approve button is disabled [T20120508.0019][Start]
*#INCLUDE C:\ARIA4XP\PRGS\SY\gfTmp2Mast.H
#INCLUDE R:\ARIA4XP\PRGS\SY\gfTmp2Mast.H
*!B609915,1 SAB 05/13/2012 APDIST file is not updated and approve button is disabled [T20120508.0019][End]

*N000682,1 11/20/2012 MMT Globlization changes[Start]
LOCAL lcToMastFile
lcToMastFile = ''
IF oAriaApplication.oActivelang.cLang_ID <> "EN"
  lcToMastFile =oAriaApplication.GetClassHeaderFile(ADDBS(UPPER(ALLTRIM(oAriaApplication.LangPath))) + "PRGS\SY\" + ALLTRIM("gfTmp2Mast")+"_"+"H" +".XML")
ENDIF
*N000682,1 11/20/2012 MMT Globlization changes[END]

LCSAVALIAS = SELECT(0)

*N000682,1 11/20/2012 MMT Globlization changes[Start]
*LCFXDMSG   = IIF(TYPE('lcFxdMsg')<>'C',LANG_SAVE,LCFXDMSG )
LCFXDMSG   = IIF(TYPE('lcFxdMsg')<>'C',IIF(oAriaApplication.oActivelang.cLang_ID = "EN",LANG_SAVE,oAriaApplication.GetHeaderText("LANG_SAVE",lcToMastFile)),LCFXDMSG )
*N000682,1 11/20/2012 MMT Globlization changes[End]

LCVARMSG   = IIF(TYPE('lcVarMsg')<>'C',' ',LCVARMSG)

LCSAVEDEL = SET ('DELETE')
SET DELETE OFF

*-- Initialize the progress bar needed variables.
OPROGRESS = NEWOBJECT('ariaprogressbar',OARIAAPPLICATION.CLASSDIR+'utility.vcx')
OPROGRESS.TOTALPROGRESS = RECCOUNT(LCTEMPFILE)
OPROGRESS.LBLFIRSTLABEL.CAPTION = LCFXDMSG
OPROGRESS.SHOW()
LNCURRECORD  = 1

SELECT (LCTEMPFILE)
GO TOP
*-- Scan through all the Added,Modified or Deleted records
SCAN FOR CSTATUS <> 'S'
  *-- Call the progress bar.
  OPROGRESS.LBLSECONDLABEL.CAPTION = LCVARMSG
  OPROGRESS.CURRENTPROGRESS(LNCURRECORD)
  LNCURRECORD = LNCURRECORD + 1

  DO CASE
    *-- New added record
  CASE CSTATUS = 'A'
    SCATTER MEMVAR MEMO
    IF 'APDIST' $ LCMASTFILE
      *E302678,3 TMI 07/21/2011 [Start] check if table is fox
      IF !LFISNATIVE('APDIST')
        *E302678,3 TMI 07/21/2011 [End  ]
        LLNID = GFSQLRUN('Select NEWID() as NEWIDVAL','APDIST',.T.,'NEWID_CUR')
        IF LLNID
          m.REC_NO = NEWID_CUR.NEWIDVAL
        ELSE
          m.REC_NO = ''
        ENDIF
        *E302678,3 TMI 07/21/2011 [Start]
      ENDIF
      *E302678,3 TMI 07/21/2011 [End  ]
    ENDIF

    IF 'APPAYMNT' $ LCMASTFILE
      *E302678,3 TMI 07/21/2011 [Start] check if table is fox
      IF !LFISNATIVE('APPAYMNT')
        *E302678,3 TMI 07/21/2011 [End  ]
        LLNID = GFSQLRUN('Select NEWID() as NEWIDVAL','APPAYMNT',.T.,'NEWID_CUR')
        IF LLNID
          m.REC_NO = NEWID_CUR.NEWIDVAL
        ELSE
          m.REC_NO = ''
        ENDIF
        *E302678,3 TMI 07/21/2011 [Start]
      ENDIF
      *E302678,3 TMI 07/21/2011 [End  ]
    ENDIF

    SELECT  (LCMASTFILE)
    GFAPPEND(LCMASTFILE,.T.)
    *INSERT INTO &lcMastFile FROM MEMVAR
    *=gfReplace('')
    IF 'APDIST' $ LCMASTFILE
      =GFREPLACE('MAPDIST with m.MAPDIST')
    ENDIF
    *-- Record was modified
  CASE CSTATUS = 'M'
    SCATTER MEMVAR MEMO                 && Collect data from temp
    SELECT  (LCMASTFILE)
    *!B609918,1 MMT 05/16/2012 Payable invoice screen updates APDIST incorrectly[Start]
    *!*	    LCKEY = KEY()
    *!*	    SELECT (LCTEMPFILE)
    *!*	    LCKEYVALUE = EVALUATE(LCKEY)
    *!*	    SELECT  (LCMASTFILE)
    *!*	    IF GFSEEK(LCKEYVALUE)
    SELECT  (lcMastFile)
    GO &lcTempFile..nRecNo
    *!B609918,1 MMT 05/16/2012 Payable invoice screen updates APDIST incorrectly[END]
    GATHER  MEMVAR MEMO                 && Replace master data
    =GFREPLACE('')
    *!B609918,1 MMT 05/16/2012 Payable invoice screen updates APDIST incorrectly[Start]
    *!*	      IF 'APDIST' $ LCMASTFILE
    *!*	        =GFREPLACE('MAPDIST with m.MAPDIST')
    *!*	      ENDIF
    *!*	    ENDIF
    *!B609918,1 MMT 05/16/2012 Payable invoice screen updates APDIST incorrectly[END]
    *-- Record was deleted
  CASE CSTATUS = 'D' .AND.  DELETED()
    SELECT  (LCMASTFILE)
    *!B609918,1 MMT 05/16/2012 Payable invoice screen updates APDIST incorrectly[Start]
    *!*	    LCKEY = KEY()
    *!*	    SELECT (LCTEMPFILE)
    *!*	    LCKEYVALUE = EVALUATE(LCKEY)
    *!*	    SELECT  (LCMASTFILE)
    *!*	    IF GFSEEK(LCKEYVALUE)
    SELECT  (lcMastFile)
    GO &lcTempFile..nRecNo

    *!B609918,1 MMT 05/16/2012 Payable invoice screen updates APDIST incorrectly[END]
    GFDELETE()
    *!B609918,1 MMT 05/16/2012 Payable invoice screen updates APDIST incorrectly[Start]
    *ENDIF                                  && Delete recored not in temp
    *!B609918,1 MMT 05/16/2012 Payable invoice screen updates APDIST incorrectly[END]
  ENDCASE

  SELECT  (LCTEMPFILE)
  REPLACE CSTATUS WITH "S"
ENDSCAN
*-- Terminate the progress bar
OPROGRESS=NULL
OARIAAPPLICATION.OTOOLBAR.OWINDPARENT = LOTOOLBARWINDOW

SET DELETE &LCSAVEDEL
SELECT (LCSAVALIAS)
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]




*!*************************************************************
*! Name      : lfIsNative
*! Developer : Tarek Mohamed Ibrahim
*! Date      : 07/21/2011
*! Purpose   : check if table is fox
*!*************************************************************
*E302678,3 TMI 07/21/2011
FUNCTION LFISNATIVE
PARAMETERS LCALIAS

LCALIAS = UPPER(LCALIAS)
LOCAL LLNATIVE,LCTEMPCURS,LNSLCT
LNSLCT = SELECT(0)
LCTEMPCURS = GFTEMPNAME()
LLNATIVE = .T.
*<Write here the code that checks if this table is native>
LNREMRESULT = OARIAAPPLICATION.REMOTESYSTEMDATA.EXECUTE("Select * from SYDFILES WHERE CFILE_NAM = '&lcAlias'",'',"&lcTempCurs","",OARIAAPPLICATION.CARIA4SYSFILES,3,"",SET("Datasession"))
SELECT (LCTEMPCURS)
LOCATE
LLNATIVE = !FOUND()
USE IN (LCTEMPCURS)

SELECT (LNSLCT)
RETURN LLNATIVE
