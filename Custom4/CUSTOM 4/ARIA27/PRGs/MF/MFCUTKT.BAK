*:----------------------------------------------------------------
*: Program file        : MFCUTKT.PRG
*: Program description : Cut Ticket Add, Modify, Delete, Inquire.
*: For screen          : MFCUTKT.SPR
*: For System          : Aria Advantage Series - Version 2.7
*: For Module          : Manufactring - (MF)
*: Developer Name      : Yasser Mohammed Aly - (YMA)
*: Tracking Job Number : E300724
*:----------------------------------------------------------------
*: Calls               : 1. Cutting Ticket Bill of material.
*:----------------------------------------------------------------
*: Called From         : 1. System Menu
*:                       2. Style Inquire
*:                       3. Generate Cutting Ticket from order.
*:----------------------------------------------------------------
*: Passed Parameters   : lcPCutTKt : Cutting ticket number.
*:----------------------------------------------------------------
*: Example             : DO MFCUTKT
*:----------------------------------------------------------------
*: Modifications :
*: B602187,1  YMA 11/16/98 Fixed the bug of rebuilding the temp 
*: B602187,1               file in case of modifing a quantity then 
*: B602187,1               branching to another program and then 
*: B602187,1               comeing back.
*: B602124,1  WAM 11/26/98 Update cuttkt line no in cost sheet files.
*: E301085,1  WAM 12/07/98 Generate cost sheet automatically.
*: B602159,1  YMA 12/17/98 Fixed the bug of not changing the multi lot
*: B602159,1               status when switching to the add mode.
*: B602345,1  YMA 12/17/98 Fixed the bug of not showing the CT header
*: B602345,1               information in case of calling the CT screen
*: B602345,1               from any other program.
*: E301077,56 YMA 03/03/99 Opening files.
*: B801910,1  YMA 03/07/99 Fixed the bug of defaulting a wrong season, 
*: B801910,1               division, and pattern from the style file
*: B801910,1               when adding a new CT.
*: B602473,1  HDM 03/08/99 Check That the order allocated on this 
*: B602473,1               Has no Pick Ticket
*: B602285,1  YMA 03/09/99 Fixed the bug of displaying the wrong
*: B602285,1               InHouse value of the contractors browse.
*: E301176,1  HDM 03/22/99 Prevent programs from displaying notepad icon
*: E301176,1               as it's now controlled globally
*: E301182,5  03/30/99 YMA Use the "cuttktl line number" field in the 
*: E301182,5               CUTPICK file index.
*: B602753,1 HDM 04/07/1999 Stop Calling NotePad Program In lpSavScr as the global save
*:                         Will Call it
*: B602744,1 HDM 04/07/1999 Fixing Bug of Updating sequence file wether the CT Saved Or Not
*: B802183,1 YMA 05/20/99   Fixed the bug Alias not found.
*: E301243,1 SSE 05/31/1999 in Summary Folder , add new button that says 'Cost by unit'
*:                          upon pressing , all cost figures on this screen should be changed
*:                          to reflect the cost by unit and the button text will be changed to 
*:                          say 'Cost by C/T'
*: B602981,1 03/30/99 TAK Opened the FABDYE to fix the ALIAS NOT FOUND bug
*: B602981,1              when editing an open CT.
*: B602986,1 06/16/1999 HDM Fixing bug of incorrect screen mode after calling CT cost sheet program
*: B603031,1 07/13/1999 HDM Also update costing fields per line CASE applying prepack
*: E301289,1 WAB 08/17/1999 Adding selling price & gross margin on PO lines & CT lines
*: B802542,1 WAB 08/30/1999 Fix The bug of not update Ct line when actualised the recive qty
*: B603292,1 MAN 11/20/1999 Optimize speed when selecting CT
*: B603317,1 MAB 12/02/1999 Optimize speed in Select mode and in 
*: B603317,1                detail folder (Receiving and Sales order Options).
*: B603338,1 ARH 12/15/1999 Added the receive date in the receivings browse
*: B802331,1 AMM 12/16/1999 Move the dyelot to be after the non major in line browse
*: B803046,1 SSE 02/16/2000 When Closing Cut Ticket Cost sheet and adding new
*: B803046,1                Style then activating Detail Folder , no lines appear
*: B803046,1                in the browse of Cut Ticket lines
*: B802924,1 SSH 28/02/00   Fix the bug of alwayes cancell the remainig
*: B802924,1 SSH 28/02/00   when decreasing the qty in CutTkt.
*: E301410,1 RAMY 06/06/2000 Add one more parameter in calling the componenet avil. screen
*: C102094,1 AMH 12/20/2000 Add a customizations and trigger for Cathy Daniels.
*: C102094,1 AMH 12/20/2000 in order to display a screen to allow the user to 
*: C102094,1 AMH            either select or add new cut tickets.
*: B804220,1 AMH 05/22/2000 Add color desc. to lcFields for Cathy Daniels.
*: B604565,1 AMH 06/19/2001 Add the color description to the screen and 
*: B604565,1                remove it from the browse.
*: B804289,1 AMH 06/24/2001 fix bug of add & modifay line with prepack.
*: B604630,1 AMH 07/08/2001 Add a trigger for Cathy Daniels to validate complition date.
*: C102433,1 AMH 08/20/2001 Add a trigger for Cathy Daniels to export C/T to the old system.
*: B602481,1 AMH 10/07/2001 Fix the bug of wrong massage when Remove allocated line
*: B602481,1 AMH            and Select to View Allocation.
*: B605000,1 AMH 10/09/2001 Add a trigger for Cathy Daniels to update the canceled C/T
*: B605000,1 AMH            in the old Sstem.
*: B605229,1 KHM 12/11/2001 Fix the bug of alias cutpick not found when trying
*: B605229,1                to generate lines based on the component availability.
*: C102524,1 AMH 01/01/2002 Add trigger for Robyn Merdith to custom browser for sales orders.
*: C102581,1 AMH 03/11/2002 Add trigger for Robyn Merdith to get the defaulte value of nsel_price field.
*: B606205,1 KHM 07/03/2002 Fix the bug of displaying all the locations even if they were not
*: B606205,1                marked to be a style finished goods inventory.
*: B606290,1 KHM 07/18/2002 Fix the bug of empty message.
*: B606496,1 AMH 11/03/2002 Fix the bug of Incorrect C/T Cost Sheet required qty.
*: B606608,1 KHM 12/03/2002 Fix the bug of not updating the WIP in the style file when the user
*: B606608,1                zero out the quantities then removes the line.
*: E301869,1 HBG 07/04/2002 Generate project for Cuttkt acoording to the setup of the module
*: B606657,1 AMH 12/23/2002 Fix the bug of Cannot cancel open C/T.
*: B606743,1 WAB 04/07/2003 Add Cnaceled line while conceld the po
*: B607168,1 AMH 04/16/2003 Fix the bug of sometimes save cuttktl records with blank cwarecode field.
*: B123103,1 NNA 08/09/2004 Fix bug that landed Cost on the Cuttkt screen not including the cost of
*: B123103,1 NNA            the Damage Pieces (this fix in the Screen Only) by get the cost =
*: B123103,1 NNA            Total Cost / (First Q. Pieces + Damage Q. Pieces )
*: B125454,1 NNA 12/21/2004 Fix bug that if a user has no Grant to see any costing but he can see
*: B125454,1 NNA            it from the style Screen - Cut and Sold Tap - W.O. - Select any cuttkt
*: B125454,1 NNA            then cutting Ticket Button - you'll find that the Dollar Sign icon appeared
*: B125454,1 NNA            that make a user able to see the cost.
*E128404,3  TMI 07/18/2005  Include the cStygrade field in the created file to allow to recive cutting tickets with the Adjust cost for recieving
*:-----------------------------------------------------------------------------------------

PARAMETERS lcPCutTKt
EXTERNAL ARRAY LADEFPROC, LACTRSTAT

*-- Detrmine if the program called from the system menu or from
*-- another program.
llFromMenu = TYPE("lcPCutTKt") # "C"

*-- Define the used arrays.
DIMENSION laScrMode  [4]
DIMENSION laData     [1]
DIMENSION laFoldWinds[3,2]
DIMENSION laKeyField [1,4]
DIMENSION laCodeInfo [2,10]
DIMENSION laSeason   [1]
DIMENSION laDivision [1]
DIMENSION laPrePack  [1]

*-- To force the control pannel to call the local save and close 
*-- procedures (lpSavScr, lpClsScr)
laDefProc[09] = .F.
laDefProc[10] = .F.

*-- The screen keys.
laKeyField[1,1] = "laData[1]"
laKeyField[1,2] =.T.
laKeyField[1,3] = "CutTktH"
laKeyField[1,4] = 1

*-- Variable to hold the aias name for the cuttktl file when opened to
*-- calculate the totals per line.
lcCutLnTot = SPACE(0)

*-- Variable to hold the aias name for the cuttktl file when opened to
*-- Save lines or delete lines.
lcMastrLin = SPACE(0)

*-- Division, Season arrays.
laCodeInfo = SPACE(0)
laSeason   = SPACE(0)
laDivision = SPACE(0)


*-- The system/company setup variables.
llCostPrv  = .F.
llMultiWar = .F.
llDyelot   = .F.
llSOInstad = .F.
lcGnCTBom  = SPACE(0)

glFromBrow = .F.
lcScFields = SPACE(0)
llAlowNew  = .F.             && Flag to allow adding new CTs.

*E301289,1 WAB - Get Setting Variable ( Display seeling Price & gross Margin )
*E301289,1 WAB - initialize variables 
*E301289,1 WAB - START
*------- llDispPric  -> hold setting variable to display selling price & gross margin
*------- m.nSelPrice -> Hold Selling Price 
*------- m.GrosMrgn  -> Hold Gross Margin
*------- lnOldPrice  -> Hold Old Value from Selling Price
*------- lnOldMrgn   -> Hold Old Value from Gross Margin
*------- lnPriceLvl  -> Hold Price level no ( popoup field )
*------- lcDispFld   -> Hold ( enable / disable )
*------- laPriceLvl  -> array holding lelve lelement ( level A , B , C )
*------- lnPoCtSel   -> Hold Total selling Price (selprice * qty ) for alll polines
*------- lnUnitSel   -> Hold avreage selling price for CT.
*------- lnuntMrgn1  -> hold Estimated Gross  Margin
*------- lnuntMrgn2  -> hold Landed  Gross  Margin
*------- lnuntMrgn3  -> hold Actual Gross  Margin
*------- llCallFrm   -> .F. if we call the profitability screen from CT
*------- lcDispPric  -> for holding (DISABLE/ENABLE) for 'CT profitability' in option Bar()

llDispPric  = .F.
llStyMark   = .F.
llDispPric = gfGetMemVar('M_MFDspPrc')  
llStyMark  = gfGetMemVar('M_stymark')   ='T'
IF llDispPric
  STORE 0 TO m.nSelPrice,m.nGrosMrgn,lnOldPrice,lnOldMrgn,lnPoCtSel,lnUnitSel,;
             lnuntMrgn1,lnuntMrgn2,lnuntMrgn3,lnPriceLvl
  STORE SPACE(1) TO lcDispFld
  llCallFrm = .F.
  lcDispPric = "DISABLE"
  DECLARE laPriceLvl[4]
  laPriceLvl[1] = 'Select Price Level'
  laPriceLvl[2] = 'Level A'
  laPriceLvl[3] = 'Level B'
  laPriceLvl[4] = 'Level C'
ENDIF
*E301289,1 WAB - END



*B602187,1 YMA 11/16/98 Fixed the bug of rebuilding the temp file in case of
*B602187,1 YMA 11/16/98 modifing a quantity then branching to another program
*B602187,1 YMA 11/16/98 and then comeing back.
*llNoShow  = .F.             && Force calling the lpShow.
*B602187,1 YMA 11/16/98 End.

*-- Option pad variables.
llCTZoom   = .F.             && IS the lines browse zoomed or not.
lcActTrnBr = "B"             && What is the active option. 

*-- The "Cancel/Uncancel" button controling variables.
lcCanStat  = "DISABLE"
lcCostShSt = "DISABLE"
lcGnLinsSt = "DISABLE"

*-- Windows names.
lcCTChWin2 = SPACE(0)
lcCTChWin3 = SPACE(0)
lcCTChWn31 = SPACE(0)
lcCTChWn32 = SPACE(0)
lcCTChWin4 = SPACE(0)
lcCTChWn40 = SPACE(0)
lcCTChWn41 = SPACE(0)
lcCTChWn42 = SPACE(0)
lcCTChWn43 = SPACE(0)
lcCTChWn44 = SPACE(0)
lcCTChWn45 = SPACE(0)
lcCTChWin5 = SPACE(0)

*-- Item major/nonmajor controlling variables.
lcMjrTtl   = SPACE(0)
lcMjrPct   = SPACE(0)
lcMinTtl   = SPACE(0)
lcMinPct   = SPACE(0)
llNoNonMaj = .F.
lcNrmStat  = "DISABLE"
lcMajStat  = "ENABLE"
lnStyleWid = 0
lnMinWid   = 0
lcSegSep   = SPACE(0)

*-- Header screen variables.
llBrowse   = .F.
lcOMajor   = SPACE(0)
lcStyDesc  = SPACE(0)
lcCTStatus = SPACE(0)
lcHedrWare = SPACE(0) 
lcOHdrWare = SPACE(0) 
llOMulWH   = .F.
llMultiLot = .F.

*E301869,1 HBG 07/04/2002 check the setting of generating project & Defult template [Begin]
lcGenProj = gfGetMemVar('M_MFGENPRJ')  
IF lcGenProj $ 'AI'
  lcDefTemp  = gfGetMemVar('M_MFDEFTMP')
ENDIF  
IF lcGenProj $ 'AI'
  STORE " " TO lc_PMPrjDt,lc_PrjHist,lc_PrjAudt,lc_PMPrjRl,lc_Parser 
ENDIF  
*E301869,1 [End]

*-- Variables used to display the line totals in the "Transactions Totals"
*-- bar from the "Option" menu pad.
lcTNonMaj  = SPACE(0)                && The nonmajor code in this screen.
lnStyBud   = 0                       && Total budget for the active line.
lnStyRec   = 0                       && Total received for the active line.
lnStyDam   = 0                       && Total dameged for the active line.
lnStyCan   = 0                       && Total canceled for the active line.
lnStyOpn   = 0                       && Total open for the active line.

*-- First folder variables.
ldOEntered = {}
ldOComplet = {}
lcContrBrw = "Contractors"
lcContrFil = SPACE(0)

laCodeInfo = SPACE(0)
laCodeInfo[1,01] = "SEASON"
laCodeInfo[1,02] = "laSeason"
laCodeInfo[1,03] = "lnSeason"
laCodeInfo[1,04] = ""
laCodeInfo[1,05] = .F.
laCodeInfo[1,06] = .F.
laCodeInfo[1,07] = "CUTTKTH"
laCodeInfo[1,08] = "CUTTKTH"
laCodeInfo[1,09] = "laData[9]"
laCodeInfo[1,10] = "Season"

laCodeInfo[2,01] = "CDIVISION"
laCodeInfo[2,02] = "laDivision"
laCodeInfo[2,03] = "lnDivision"
laCodeInfo[2,04] = ""
laCodeInfo[2,05] = .F.
laCodeInfo[2,06] = .F.
laCodeInfo[2,07] = "CUTTKTH"
laCodeInfo[2,08] = "CUTTKTH"
laCodeInfo[2,09] = "laData[10]"
laCodeInfo[2,10] = "cDivision"

*-- Flag to tell if we should generate the cutting ticket lines
*-- or not, this will only be true if the lines are generated, 
*-- and that's will happen if the user select the add mode and
*-- entered the Style major value, and entered the header warehouse
*-- and then activate the 2nd tab in the screen's folder (Details).
llGenLines = .T.

*-- 2nd Folder variables.
lcNonMaj   = SPACE(0)
lcONonMaj  = SPACE(0)
lcOLinWare = 0
lcTmpCutLn = SPACE(0)
lcLinesBrw = SPACE(0)
lcLnScFlds = SPACE(0)
lcScalFlsd = SPACE(0)
lnLnRecNo  = 0
lnLnNo     = 0
lnOLnQty   = 0
lcOptBrwTl = SPACE(1)
lcRecStat  = SPACE(0)
lcTmpCtPk  = SPACE(0)

*-- 3rd Folder variables.
lcLabel1     = SPACE(0)
lcLabel2     = SPACE(0)
lcLabel3     = SPACE(0)
lcLabel4     = SPACE(0)
lcLabel5     = SPACE(0)

*E301243,1 Define new variable in the 3rd Folder [Begin.]
*-- adding this variable to 3rd Folder variables to be used as Flag
*-- to indicate whether the new Added Push Button is pressed or not by
*-- default , its value is False (not pressed)
llByUnit = .F.

*-- variable (lcTotal) created only for one reason , because Total Actual 
*-- Cost field in mfCutk5.Scx will not hold all what is written in its 
*-- expression so we have to simplify it by making it shorter 
*-- lcTotal = laData[29]+laData[30]+ladata[31]+ladata[32]+ladata[33]
*-- and it must be defined after defining laData array

*E301243,1 Define new variable in the 3rd Folder [End.]

*-- Following set of variables are used to save/restore the
*-- filter, index status of the used files, to be used to
*-- save/restore these status when branching to another prgram.
lcCutTkt     = SPACE(0)
lcRecLogKy   = SPACE(0)
lcOrderKy    = SPACE(0)
lcOCTLTag    = SPACE(0)
lcOCTLFlt    = SPACE(0)
lcOStyTag    = SPACE(0)
lcOStyFlt    = SPACE(0)
lcOCPKTag    = SPACE(0)
lcOCPKFlt    = SPACE(0)
lcOCTHTag    = SPACE(0)
lcOCTHFlt    = SPACE(0)
lcOSDyTag    = SPACE(0)
lcOFDyTag    = SPACE(0)
lcOCPKFlt    = SPACE(0)
lcOWHsTag    = SPACE(0)
lcOWHsFlt    = SPACE(0)

*-- Initialize the Folders array.
lcFolder     = SPACE(0)
lcwFoldChng  = SPACE(0)
lcFoldPush   = SPACE(0)
laFoldWind   = SPACE(0)
lcFoldPrnt   = SPACE(0)
lnActFolder  = 1
lnFolderCEnd = 0
lnFolderREnd = 0

*-- Following variables are used to handel the incomplete program 
*-- session concept.
lcSession  = SPACE(1)                  && Sequence number to flag the program sessions.
lnThisSess = gnProgCopy                && Current running session number.
lnUnCmSeRc = 0                         && The incomplete session record number.
lcProgID   = PADR("CUTTKT", 10)        && The program ID in the incomplete session file.
llUnComp   = .F.                       && Are we comming from an incomplete session?
lcScrMode  = SPACE(1)
llContinue = .F.

*-- Variables that need to be saved and restored when detecting an
*-- uncomplete program session.
DIMENSION laVars[13]
laVars[01] = "lcScrMode"
laVars[02] = "lnUnCmSeRc"
laVars[03] = "llCTZoom"
laVars[04] = "lcActTrnBr"
laVars[05] = "llGenLines"
laVars[06] = "lnActFolder"
laVars[07] = "llCUpDate"
laVars[08] = "llMultiLot"
laVars[09] = "lcHedrWare"
laVars[10] = "lcCTStatus"
laVars[11] = "lcStyDesc"
laVars[12] = "lnSeason"
laVars[13] = "lnDivision"

*-- Add the screen header fields saved in the laData Array to the 
*-- list of the variables to be restored when detecting an uncomplete 
*-- program session.
FOR lnI = 1 TO 35
  DIMENSION laVars[ALEN(laVars)+1]
  laVars[ALEN(laVars)] = "laData[" + ALLTRIM(STR(lnI,2)) + "]"
ENDFOR

*C102094,1 AMH Add Flag for opening select window [Start].
*C102094,1 AMH This flag will be set to .T. when calling the custom trigger
*C102094,1 AMH for Cathy Daneil. Otherwise it will be .F.
llOpenCt = .F.
*C102094,1 AMH [End]

*C102581,1 AMH Define variable to hold the old value of cordercut for Robyn Merdith [Start]
STORE '' TO lcOldValue
*C102581,1 AMH [End]

IF !gfSetup()
  RETURN
ENDIF

*-- Load the system/company setup variables.
llCostPrv    = gfUserPriv('IC','ICSTYLE','COSTING')
llMultiWar   = gfGetMemVar("M_WAREHOUSE") = "Y"
llDyelot     = gfGetMemVar("M_DYELOT")    = "Y"
llSOInstad   = OCCURS("SO", gcCmpModules) # 0
lcGnCTBom    = gfGetMemVar("M_GNCTBOM")

*-- 3rd Folder variables.
lcLabel1     = ALLTRIM(PROPER(gfGetMemVar('M_cMSLbl1')))
lcLabel2     = ALLTRIM(PROPER(gfGetMemVar('M_cMSLbl2')))
lcLabel3     = ALLTRIM(PROPER(gfGetMemVar('M_cMSLbl3')))
lcLabel4     = ALLTRIM(PROPER(gfGetMemVar('M_cMSLbl4')))
lcLabel5     = ALLTRIM(PROPER(gfGetMemVar('M_cMSLbl5')))

*-- To add the "Notes" button in the control pannel.

*E301176,1 HDM 03/22/1999 [Start] Prevent programs from displaying notepad icon
*                           as it's now controlled globally

*DIMENSION laPanelObj[4,3]
DIMENSION laPanelObj[3,3]

*laPanelObj[1,1] = "pbCTNote"
*laPanelObj[1,2] = gcBmpHome + "NOTES2.BMP"
*laPanelObj[1,3] = [VALID lfvCTNote() MESSAGE 'Cutting Ticket Notes' DISABLE]

*-- To add the "Cost Sheet" button in the control pannel.
laPanelObj[1,1] = "pbCostSh"
laPanelObj[1,2] = gcBmpHome + "COMM.BMP"
laPanelObj[1,3] = [VALID lfvCostSh() MESSAGE 'Cutting Ticket Cost Sheet' DISABLE]

*-- To add the "Generate Lines" button in the control pannel.
laPanelObj[2,1] = "pbCTGnLns"
laPanelObj[2,2] = gcBmpHome + "GENRATE.BMP"
laPanelObj[2,3] = [VALID lfvCTGnLns() MESSAGE 'Generate lines based on components availability' DISABLE]

laPanelObj[3,1] = 'pbObjlnk'
laPanelObj[3,2] = gcBmpHome+'RELATE.BMP'
laPanelObj[3,3] = [VALID lfvObjLnk()]

*E301176,1 HDM 03/22/1999 [Start]

*-- Change the "Delete" button in the "Control Pannel" to be
*-- "Cancel/Uncancel"
lcCancel   = gcBmpHome + "TRASH.BMP"
lcUnCanc   = gcBmpHome + "UNTRASH.BMP"
lcPromp    = lcCancel
lcDelMesag = 'cancel'
lcMenProm  = PROPER(lcDelMesag) + " Cutting Ticket"

*-- This variable is used to refresh the 2nd tab in the folder screen, it
*-- will be effective only when you run the screen at the first time
*-- or when you come back to the program from another session or program.
llRefPage2 = .T.

IF !WEXIST(gcBaseWind)
  llGenLines = .T.
  llAlowNew  = .T.

  *C102524,1 AMH Variable to open style file again with this alias [Start]
  IF ASCAN(laEvntTrig , PADR('ORDBROW',10)) <> 0
    lcStyleBrw = SPACE(0)
  ENDIF
  *C102524,1 AMH [End]

  *-- Initialize the bars status in the "Option" menu pad.
  llCTZoom   = .F.
  lcActTrnBr = "B"
  
  *-- Get the Item major/non-major information.
  lcMjrTtl   = gfItemMask("HM")
  lcMjrPct   = gfItemMask("PM")
  lcMinTtl   = gfItemMask("HN")
  lcMinPct   = gfItemMask("PN")
  lnStyleWid = LEN(lcMjrPct)
  lnMinWid   = LEN(lcMinPct)
  lcSegSep   = SUBSTR(gfItemMask("PI"), lnStyleWid+1, 1)
  llNoNonMaj = lnMinWid = 0
  
  *-- Screen fields variable, to be used to build the laData array.
  lcScFields = "CutTkt,     Style,      Status,     cWareCode,  Entered, "   +;
               "Complete,   Pattern,    cTktType,   Season,     cDivision,"   +;
               "lMultiWare, Pcs_Bud,    Pcs_Rec,    Pcs_Dam,    Pcs_Can, "   +;
               "Pcs_Act,    Pcs_Opn,    cMultiLot,  NEST_COST1, NEST_COST2," +;
               "NEST_COST3, NEST_COST4, NEST_COST5, NLAN_COST1, NLAN_COST2," +;
               "NLAN_COST3, NLAN_COST4, NLAN_COST5, NACT_COST1, NACT_COST2," +;
               "NACT_COST3, NACT_COST4, NACT_COST5, INI_COMP  , PCS_CANOLD"

  SCATTER FIELDS &lcScFields MEMO TO laData BLANK
  laData[2] = LEFT(laData[2], lnStyleWid)

  *E301243,1 now make lcTotal hold laData array from 29 to 33 [Begin.]
  lcTotal = laData[29]+laData[30]+ladata[31]+ladata[32]+ladata[33]
  *E301243,1 now make lcTotal hold laData array from 29 to 33 [End.]
  	
  *-- None of the screen's objects has been updated.
  llCUpDate  = .F.
  
  *-- Set the displayed cutting ticket status variable.
  llNoThing  = lfSetStat()
  
  *-- Windows Names.
  lcCTChWin2   = gfTempName()
  lcCTChWin3   = gfTempName()
  lcCTChWn31   = gfTempName()
  lcCTChWn32   = gfTempName()
  lcCTChWin4   = gfTempName()
  lcCTChWn40   = gfTempName()
  lcCTChWn41   = gfTempName()
  lcCTChWn42   = gfTempName()
  lcCTChWn43   = gfTempName()
  lcCTChWn44   = gfTempName()
  lcCTChWn45   = gfTempName()
  lcCTChWin5   = gfTempName()

  *E301869,1 HBG 07/04/2002 Declare the temp files nedded in generating project[Begin]  
  IF lcGenProj $ 'AI'
    lc_PMPrjDt   = gfTempName()
    lc_PrjHist   = gfTempName()
    lc_PrjAudt   = gfTempName()
    lc_PMPrjRl   = gfTempName()
    lc_Parser    = gfTempName()
  ENDIF  
  *E301869,1 [End]

  *-- Initialize the folders information.
  lcwFoldChng  = "= lfActFolder()"
  lcFoldPush   = "pbFolder"
  lnFolderCEnd = 102.50
  lnFolderREnd = 2.00
  lcFolder     = gfTempName()
  lcFoldPrnt   = gcBaseWind
  lnActFolder  = 1

  laFoldWinds[1,1] = "Header"
  laFoldWinds[1,2] = lcCTChWin3
  laFoldWinds[2,1] = "Detail"
  laFoldWinds[2,2] = lcCTChWin4
  laFoldWinds[3,1] = "Summary"
  laFoldWinds[3,2] = lcCTChWin5

  *-- Build the main temporary file.
  lcTmpCutLn = gfTempName()
  lcLinesBrw = "Cutting Ticket Lines"
  
  *HDM  
  *lcLnScFlds = "Qty1,Qty2,Qty3,Qty4,Qty5,Qty6,Qty7,Qty8,TotQty,Dyelot,nPrePack,cPrePack,cWareCode"
 
  *E301289,1 WAB - initialize variables (add nselprice,ngrosMrgn)
  *E301289,1 WAB - START
  *lcLnScFlds = "Qty1,Qty2,Qty3,Qty4,Qty5,Qty6,Qty7,Qty8,TotQty,Dyelot,nPrePack,STYLE.CBUYPREPK,cWareCode"
  
  *B804289,1 AMH add cPrePack to lcLnScFlds [Start]
  *lcLnScFlds = "Qty1,Qty2,Qty3,Qty4,Qty5,Qty6,Qty7,Qty8,TotQty,Dyelot,nPrePack,STYLE.CBUYPREPK,cWareCode,"+;
               "nSelPrice,nGrosMrgn"
  lcLnScFlds = "Qty1,Qty2,Qty3,Qty4,Qty5,Qty6,Qty7,Qty8,TotQty,Dyelot,cPrePack,nPrePack,STYLE.CBUYPREPK,cWareCode,"+;
               "nSelPrice,nGrosMrgn"
  *B804289,1 AMH add cPrePack to lcLnScFlds [Start]
  
  *E301289,1 WAB - END
  
  = lfCrtTmpLn()
  
  lcScalFlsd = "Scale.Sz1,Scale.Sz2,Scale.Sz3,Scale.Sz4,"+;
               "Scale.Sz5,Scale.Sz6,Scale.Sz7,Scale.Sz8,Scale.Cnt"

  *-- Initialize the header warehouse variable.
  IF llMultiWar
    lcHedrWare = SPACE(0)
  ELSE
    SELECT WareHous
    *B603317,1 [
    *GOTO TOP
    LOCATE
    *B603317,1 [
    lcHedrWare = cWareCode
  ENDIF
  
  *-- Initialize the code popup in the first tab in the screen's folders.
  llNoThing = gfwCodePop(@laCodeInfo, "SEASON"   , "N")
  llNoThing = gfwCodePop(@laCodeInfo, "CDIVISION", "N")

  *-- Build an empty cursor that will browse the contractor information.
  lcContrFil = gfTempName()
  *B603292,1 Added cStatus
  CREATE CURSOR (lcContrFil) ;
                (cContCode C(8), cContName C(30), lInHouse L   ,;
                 cOprCode  C(6), cLotNo    C(02), nbudget  N(6),;
                 nReceivd  N(6), nDameged  N(06), nCanceld N(6),;
                 nActQty2  N(6), cStatus C(8))

  *-- Temp name to hold the name of the temporary cutpick file.
  lcTmpCtPk = gfTempName()
  
  *-- Get a session number, to be updated in the uncomplete session
  *-- number file foe each session.
  lcSession  = gfsequence('CSESSION')
ELSE

  *-- If comming back from the cutting ticket bill of material program
  *-- then switch the screen mode to the select mode.
  IF laScrMode[4] AND !EMPTY(laData[1])
    laScrMode    = .F.
    laScrMode[1] = .T.
    *-- B602986,1 HDM [Start] Force screen refreshment
    KEYBOARD "{PGDN}"
    *-- B602986,1 HDM [End]
  ENDIF
ENDIF

*-- Empty out all the displayed objects on the screen.
SELECT (lcTmpCutLn)
SCATTER FIELDS &lcLnScFlds MEMVAR BLANK

*E301077,56 YMA 03/03/99 Start - Empty out the scale variables.
*SCATTER FIELDS &lcScalFlsd MEMVAR BLANK
STORE SPACE(5) TO m.Sz1,m.Sz2,m.Sz3,m.Sz4,m.Sz5,m.Sz6,m.Sz7,m.Sz8
STORE 0        TO m.Cnt
*E301077,56 YMA 03/03/99 End.

*-- Before running the screen, please do the folowing...
*-- 1. Save the current systrem menu.
*-- 2. Switch the "Delete" bar to be "Cancel/Uncancel"
*-- 3. Create the "Option" menu pad.
*-- 4. Set the needed filters, indexs on the used files.
*-- Run the screen and then restore all the previously stored values.
*Ren
*PUSH MENU _MSYSMENU
lcDelPadNm = SPACE(0)
lnDelBarNo = lfGtDelBar()

*C102094,1 AMH Add Flag for closing from select window [Start].
*C102094,1 AMH This flag will be set to .T. when calling the custom trigger
*C102094,1 AMH for Cathy Daneil. Otherwise it will be .F.
llCloseCt = .F.
*C102094,1 AMH [End]

= lfActPad() AND lfSetFiles() AND lfStDelBar()

*B602345,1 YMA 12/17/98 Fixed the bug of not showing the CT header
*B602345,1 YMA 12/17/98 information in case of calling the CT screen
*B602345,1 YMA 12/17/98 from any other program.
llNoShow = !(laScrMode[2] OR (laScrMode[4] AND !EMPTY(laData[1])))
*B602345,1 YMA 12/17/98 End.

*C102094,1 AMH check if close from select window [Start].
*C102094,1 AMH That will be done in the custom screen for Cathy Daneil.
*SELECT CutTktH
*DO (gcScrDir+gcWinAppl+"\MFCutKt.SPR")
IF !llCloseCt
  IF llOpenCt .AND. laScrMode[4] .AND. EMPTY(laData[1])
    llNoShow = .F.
  ENDIF
  SELECT CutTktH
  DO (gcScrDir+gcWinAppl+"\MFCutKt.SPR")
ENDIF
*C102094,1 AMH [End]

= lfDeActPad() AND lfReStFils()
*Ren
*POP MENU _MSYSMENU

*-- Release all the browses windows.
RELEASE WINDOW (lcLinesBrw)
RELEASE WINDOW (lcContrBrw)
IF !EMPTY(lcOptBrwTl) AND WEXIST(lcOptBrwTl)
  RELEASE WINDOW (lcOptBrwTl)
ENDIF

*-- Erase all the created temporary files, close all the conditionally
*-- opened aliases.
IF glQuitting
  USE IN (lcTmpCutLn)
  ERASE (gcWorkDir+lcTmpCutLn+".DBF")
  ERASE (gcWorkDir+lcTmpCutLn+".CDX")
  ERASE (gcWorkDir+lcTmpCutLn+".FPT")
  
  *E301077,56 YMA 03/03/99 Start - Use the gfCloseFile instead.
  = IIF(USED(lcCutLnTot), gfCloseFile(lcCutLnTot), .F.)
  *USE IN IIF(USED("CutLnTot"), SELECT("CutLnTot"), 0)
  *E301077,56 YMA 03/03/99 End.
    
  USE IN IIF(USED(lcContrFil), SELECT(lcContrFil), 0)
  ERASE (gcWorkDir+lcContrFil+".DBF")
  ERASE (gcWorkDir+lcContrFil+".CDX")
  ERASE (gcWorkDir+lcContrFil+".FPT")
ENDIF

*:----------------------------------------------------------------
*: Name       : lfGtDelBar
*: Developer  : Yasser Mohammed Aly - (YMA)
*: Date       : 11/03/1997
*: Purpose    : To specify the "Delete" bar number in the "File" 
*:              pad in the system menu.
*:----------------------------------------------------------------
*: Calls      : None.
*:----------------------------------------------------------------
*: Parameters : None.
*:----------------------------------------------------------------
*: Returns    : The "Delete" bar number in the "File" system menu.
*:----------------------------------------------------------------
*: Example    : lnDelBarNo = lfGtDelBar()
*:----------------------------------------------------------------
FUNCTION lfGtDelBar

*-- Open the system menu file.
*E301077,56 YM 03/03/99 Start - Use the gfOpenfile instead.
= gfOpenFile(gcSysHome+"SYCMenu","Pross_ID","SH")
*USE (gcSysHome+"SYCMenu") IN 0 ORDER Pross_ID AGAIN ALIAS MenuFile
*E301077,56 YM 03/03/99 End.

IF SEEK("GFCPDELETE", "SYCMenu")
  lcDelPadNm = UPPER(ALLTRIM(SYCMenu.cMstr_Nam))
  lnRetVal   = VAL(SYCMenu.cBar_Pos)
ELSE
  *-- The default values.
  lcDelPadNm = "P03PU03"
  lnRetVal   = 10
ENDIF
= gfCloseFile("SYCMenu")

RETURN (lnRetVal)

*:----------------------------------------------------------------
*: Name       : lfStDelBar
*: Developer  : Yasser Mohammed Aly - (YMA)
*: Date       : 11/03/1997
*: Purpose    : Change the prompt of the "Delete" bar number in 
*:              the "File" pad in the system menu to be...
*:              "Cancel/Uncancel"
*:----------------------------------------------------------------
*: Calls      : None.
*:----------------------------------------------------------------
*: Parameters : None.
*:----------------------------------------------------------------
*: Returns    : None.
*:----------------------------------------------------------------
*: Example    : = lfStDelBar()
*:----------------------------------------------------------------
FUNCTION lfStDelBar

lcDelMesag = IIF(lcPromp = lcCancel, "cancel", "uncancel") 
lcMenProm  = PROPER(lcDelMesag) + " Cutting Ticket"
DEFINE BAR lnDelBarNo OF (lcDelPadNm) PROMPT (lcMenProm)
ON SELECTION BAR lnDelBarNo OF (lcDelPadNm) DO gfCPDelete
SET SKIP OF  BAR lnDelBarNo OF (lcDelPadNm) lcCanStat  = "DISABLE"
SHOW GET pbDlt,1 PROMPT lcPromp
SHOW GET pbDlt &lcCanStat

*:----------------------------------------------------------------
*: Name       : lfSetFiles
*: Developer  : Yasser Mohammed Aly - (YMA)
*: Date       : 11/03/1997
*: Purpose    : Set the needed filtes/indexs on the used files, to
*:              avoid change them when calling another program.
*:----------------------------------------------------------------
*: Calls      : None.
*:----------------------------------------------------------------
*: Parameters : None.
*:----------------------------------------------------------------
*: Returns    : None.
*:----------------------------------------------------------------
*: Example    : = lfGtDelBar()
*:----------------------------------------------------------------
FUNCTION lfSetFiles
PRIVATE lnAlias

lnAlias = SELECT(0)

SELECT Style
lcOStyTag = TAG()
lcOStyFlt = FILTER()
SET ORDER TO TAG Style
SET FILTER TO Make AND Status <> 'X'

SELECT CutTktH
lcOCTHTag = TAG()
lcOCTHFlt = FILTER()
SET ORDER TO TAG CutTktH
SET FILTER TO
IF !llFromMenu AND SEEK(lcPCutTKt)
  lcCutTkt     = lcPCutTKt
  laScrMode    = .F.
  laScrMode[2] = .T.
ENDIF

*C102094,1 AMH Add a custom trigger for Cathy Daniels to display a screen[Start]
*C102094,1 AMH to allow the user to select a cuttkt or add a new.
IF llFromMenu .AND. !llOpenCt
  IF ASCAN(laEvntTrig , PADR('SELCTFLD',10)) <> 0
    =gfDoTriger('MFCUTKT',PADR('SELCTFLD',10))
    llOpenCt = .T.
  ENDIF     
ENDIF
*C102094,1 AMH [End]

lcCutTkt = IIF(EMPTY(lcCutTkt), laData[1], lcCutTkt) 
SELECT CutTktL
lcOCTLTag = TAG()
lcOCTLFlt = FILTER()
SET ORDER TO 
*MAN NY Start The Index Expression doesn't have STR(RECNO(),7)
*SET FILTER TO CutTkt+Style+Dyelot+TranCD+STR(RECNO(),7) = ;
              (lcCutTkt) AND TranCD = "1"
SET FILTER TO CutTkt+Style+Dyelot+TranCD = ;
              (lcCutTkt) AND TranCD = "1"              
*MAN NY End              
LOCATE

lcOrderKy  = "1" + lcCutTkt + CutTktL.Style

*E301077,56 YM 03/03/99 Start - Commented out and moved to the proper place.
*SELECT CutPick
*lcOCPKTag = TAG()
*lcOCPKFlt = FILTER()
*SET ORDER TO 
*SET FILTER TO TranCD+CtktNo+Style = (lcOrderKy)
*E301077,56 YM 03/03/99 End.

lcRecLogKy = lcCutTkt + CutTktL.Style
USE (gcDataDir+"CutTktL") IN 0 AGAIN ALIAS CutRec
SELECT CutRec
*MAN NY Start The Index Expression doesn't have STR(RECNO(),7)
SET FILTER TO CutTkt+Style+Dyelot+TranCD+STR(RECNO(),7) = ;
              (lcRecLogKy) AND TranCD # "1"
SET FILTER TO CutTkt+Style+Dyelot+TranCD = ;
              (lcRecLogKy) AND TranCD # "1"
*MAN NY End
*E301077,56 YMA 03/03/99 Start - Commented out and moved to the proper place.
*SELECT StyDye
*lcOSDyTag = TAG()
*lcOSDyFlt = FILTER()
*SET ORDER TO StyDye
*SET FILTER TO

*SELECT FabDye
*lcOFDyTag = TAG()
*lcOFDyFlt = FILTER()
*SET ORDER TO FabDye
*SET FILTER TO

*SELECT BomLine
*SET ORDER TO BomLine

*SELECT Bom
*SET ORDER TO Bom

*SELECT Fabric
*SET ORDER TO Fabric
*E301077,56 YMA 03/03/99 End.

SELECT WareHous
lcOWHsTag = TAG()
lcOWHsFlt = FILTER()
SET ORDER TO WareHous
SET FILTER TO

SELECT CtKtBom
SET ORDER TO Ctktyp

SELECT(lnAlias)

*:----------------------------------------------------------------
*: Name       : lfReStFils
*: Developer  : Yasser Mohammed Aly - (YMA)
*: Date       : 11/03/1997
*: Purpose    : Re-set the needed filtes/indexs on the used files, 
*:              to avoid change them when calling another program.
*:----------------------------------------------------------------
*: Calls      : None.
*:----------------------------------------------------------------
*: Parameters : None.
*:----------------------------------------------------------------
*: Returns    : None.
*:----------------------------------------------------------------
*: Example    : = lfReStFils()
*:----------------------------------------------------------------
FUNCTION lfReStFils
PRIVATE lnAlias

lnAlias = SELECT(0)

SELECT Style
SET ORDER TO TAG &lcOStyTag
SET FILTER TO

SELECT CutTktL
SET ORDER TO &lcOCTLTag
SET FILTER TO 

*E301077,56 YM 03/03/99 Start - Commented out.
*SELECT CutPick
*SET ORDER TO &lcOCPKTag
*SET FILTER TO
*E301077,56 YM 03/03/99 End.

SELECT CutRec
SET FILTER TO 
USE

SELECT CutTktH
SET ORDER TO TAG &lcOCTHTag

*E301077,56 YMA 03/03/99 Start - Commented out and moved to the proper place.
*SELECT StyDye
*SET ORDER TO &lcOSDyTag

*SELECT FabDye
*SET ORDER TO &lcOFDyTag
*E301077,56 YMA 03/03/99 End.


SELECT WareHous
SET ORDER TO &lcOWHsTag

SELECT(lnAlias)

*:----------------------------------------------------------------
*: Name       : lpShow
*: Developer  : Yasser Mohammed Aly - (YMA)
*: Date       : 11/03/1997
*: Purpose    : Screen modes controlling procedure.
*:----------------------------------------------------------------
*: Calls      : None.
*:----------------------------------------------------------------
*: Parameters : None.
*:----------------------------------------------------------------
*: Returns    : None.
*:----------------------------------------------------------------
*: Example    : DO lpShow
*:----------------------------------------------------------------
PROCEDURE lpShow
DO CASE
  *-- Select Mode.
  CASE laScrMode[1]

    *-- Check if there is any previuosly uncompleted session of the 
    *-- program.
    IF lfChkUnComS()
      RETURN
    ENDIF
    
    *-- Save the current screen mode to this variable that will be
    *-- saved in the uncomplete session file.
    lcScrMode  = "S"
    llCUpdate  = .F.
    lnUnCmSeRc = 0
    
    *-- Empty the screen objects.
    SCATTER FIELDS &lcScFields MEMO TO laData BLANK
    SELECT (lcTmpCutLn)
    BLANK ALL
    DELETE ALL
    llGenLines = .T.
    lcStyDesc  = SPACE(0)
    llNoThing  = gfwCodePop(@laCodeInfo, "SEASON"   , "N")
    llNoThing  = gfwCodePop(@laCodeInfo, "CDIVISION", "N")
    llNoThing  = lfSetStat()
    lcHedrWare = IIF(llMultiWar, SPACE(0), lcHedrWare)
    llCTZoom   = .F.
    lcActTrnBr = "B"
    
    *-- Enable/Disable the controlled objectes.
    lcNrmStat  = "DISABLE"
    lcMajStat  = "ENABLE"
    lcCostShSt = "DISABLE"
    lcGnLinsSt = "DISABLE"

    *-- Rebuild the contractor cursor.
    llMultiLot = laData[18] = "M"
    *B603292,1 Added cStatus
    CREATE CURSOR (lcContrFil) ;
                  (cContCode C(8), cContName C(30), lInHouse L   ,;
                   cOprCode  C(6), cLotNo    C(02), nbudget  N(6),;
                   nReceivd  N(6), nDameged  N(06), nCanceld N(6),;
                   nActQty2  N(6), cStatus C(8))
    = lfCnBrowse()

    SHOW GET laData[1]  ENABLE
    SHOW GET ibStyBrow  ENABLE
    SHOW GET laData[2]  ENABLE
    SHOW GET lcHedrWare DISABLE
    SHOW GET pbBrHdWare DISABLE
    SHOW GET laData[11] DISABLE
    SHOW GET llMultiLot DISABLE
    SHOW GET pbCTNote   DISABLE
    SHOW GET pbObjlnk   DISABLE
    SHOW GET pbCostSh   DISABLE
    SHOW GET pbCTGnLns  DISABLE
    
    *-- Activate the first fab of the screen's folders, and disable the
    *-- 2nd one.
    lnLastFold  = lnActFolder
    lnActFolder = 1
    llNoThing   = lfChngFolder(lnActFolder)
    SHOW GET ibFolder[2] DISABLE

    *-- Prepare the variables used to switch the prompt of the "Delete"
    *-- bar in the system menu, and the status of the "Cancel" button in
    *-- the control panell.
    lcCanStat    = "DISABLE"
    laCtrStat[8] = lcCanStat
    lcPromp      = lcCancel
    llNoThing    = lfShowEnd()
    
    *-- Force the activation of the first object in the screen.
    _CUROBJ = OBJNUM(laData[1])

    *E301289,1 WAB (START) DISABLE 'Po profitability' in option Bar() in select mode
    lcDispPric = "DISABLE"
    *E301289,1 WAB - END

    *C102094,1 AMH Add a customized trigger for Cathy Daniels to display [Start]
    *C102094,1 AMH a screen to allow the user to select a cuttkt or add a new one.
    IF ASCAN(laEvntTrig , PADR('SELCTFLD',10)) <> 0
      =gfDoTriger('MFCUTKT',PADR('SELCTFLD',10))
      IF llCloseCt
        =gfCPClose()
        RETURN
      ENDIF
      IF !laScrMode[1]
        DO GPCTRLSHOW
        DO lpShow
      ENDIF
    ENDIF     
    *C102094,1 AMH [End]

  *-- View Mode.
  CASE laScrMode[2]
    lnUnCmSeRc = 0
    
    *-- Reinitialize all the screen's objects.
    SCATTER FIELDS &lcScFields MEMO TO laData 
    lcMajStat    = "DISABLE"
    lcNrmStat    = "DISABLE"
    laData[2]    = LEFT(laData[2],lnStyleWid)
    lcStyDesc    = IIF(SEEK(laData[2],"Style"), Style.Desc1, "")
    lcHedrWare   = laData[4]
    llNoThing    = gfwCodePop(@laCodeInfo, "SEASON"   , "V,"+laData[09])
    llNoThing    = gfwCodePop(@laCodeInfo, "CDIVISION", "V,"+laData[10])
    llNoThing    = lfSetStat(laData[3])
    llMultiLot   = laData[18] = "M"
    lcEdtStat    = IIF(laData[3] $ "CSX", "DISABLE", "ENABLE")
    laCtrStat[7] = lcEdtStat
    lcPromp      = IIF(laData[3]="X" , lcUnCanc, lcCancel )
    
    *B606657,1 AMH Fix the bug of Cannot cancel open C/T [Start]
    *lcCanStat    = IIF(laData[3]$"HX", "ENABLE", "DISABLE")
    lcCanStat    = IIF(laData[3]$"OHX", "ENABLE", "DISABLE")
    *B606657,1 AMH [End]
    
    lcCostShSt   = "ENABLE"
    lcGnLinsSt   = "DISABLE"
    IF laData[3] = "X"
      lcCostShSt = IIF(SEEK("M"+laData[1], "CtktBom"), "ENABLE", "DISABLE")
    ENDIF
    llCUpdate    = .F.
    lcScrMode    = "V"

    *B125454,1 NNA 12/21/2004 (Begin) Seek if the Operator has privilege to see the "style cost" or not
    lcCostShSt =IIF(gcUser_lvl='O',IIF(!gfUserPriv('IC','ICSTYLE','COSTING'), "DISABLE",lcCostShSt),lcCostShSt)
    *B125454,1 NNA (End) 

    *-- Enable/Disable the controlled objectes.
    SHOW GET pbEdt       &lcEdtStat
    SHOW GET laData[1]   DISABLE
    SHOW GET ibStyBrow   DISABLE
    SHOW GET laData[2]   DISABLE
    SHOW GET lcHedrWare  DISABLE
    SHOW GET pbBrHdWare  DISABLE
    SHOW GET laData[11]  DISABLE
    SHOW GET llMultiLot  DISABLE
    SHOW GET pbCTNote    ENABLE
    SHOW GET pbObjlnk    ENABLE
    SHOW GET pbCostSh    &lcCostShSt
    SHOW GET pbCTGnLns   &lcGnLinsSt
    SHOW GET ibFolder[2] ENABLE

    llNoThing = lfLnBrowse()
    
    *-- Build the contractor cursor and update the browse on the 
    *-- screen.
    = lfBldCont() AND lfCnBrowse()

    *-- Update and refresh the "Option" browses if it's active.
    IF lcActTrnBr $ "RO" AND !llCTZoom
      = lfOptBrows()
    ENDIF
    llNoThing = lfShowEnd()
    
    *E301289,1 WAB (START) ENABLE 'Po profitability' in option Bar() in view mode
    lcDispPric = "ENABLE"
    *E301289,1 WAB - END

  *-- Edit mode.
  CASE laScrMode[3]
    *-- Reinitialize some of the screen's objects.
    *-- This will only effictive when trying to reset an uncomplete 
    *-- session of the program (not all of the used variables are
    *-- saven in the uncomplete session file).
    llCUpdate    = .T.
    lcPromp      = IIF(laData[3]="X", lcUnCanc, lcCancel) 
    lcCanStat    = "DISABLE"
    laCtrStat[8] = lcCanStat
    laData[2]    = LEFT(laData[2],lnStyleWid)
    lcStyDesc    = IIF(SEEK(laData[2],"Style"), Style.Desc1, "")
    lcHedrWare   = laData[4]
    llNoThing    = gfwCodePop(@laCodeInfo, "SEASON"   , "V,"+laData[09])
    llNoThing    = gfwCodePop(@laCodeInfo, "CDIVISION", "V,"+laData[10])
    llNoThing    = lfSetStat(laData[3])
    llMultiLot   = laData[18] = "M"

    *-- Enable/Disable the controlled objectes.
    lcMajStat  = "DISABLE"
    lcNrmStat  = "ENABLE"
    lcCostShSt = "DISABLE"
    lcGnLinsSt = IIF(laData[3]="H", "ENABLE", "DISABLE")
    SHOW GET laData[1]  DISABLE
    SHOW GET ibStyBrow  DISABLE
    SHOW GET laData[2]  DISABLE
    SHOW GET lcHedrWare ENABLE
    SHOW GET pbBrHdWare ENABLE
    SHOW GET laData[11] ENABLE
    SHOW GET llMultiLot ENABLE
    SHOW GET pbCTNote   ENABLE
    SHOW GET pbObjlnk   ENABLE
    SHOW GET pbCostSh   DISABLE
    SHOW GET pbCTGnLns  &lcGnLinsSt
    
    llNoThing = lfSetStat(laData[3])
    SHOW GET ibFolder[2] ENABLE

    *-- Build the used temporary file only if we are not comeing
    *-- from an uncompleate session of the program otherwise, these
    *-- files will be restored.
    IF !llContinue
      *MAN NY Start The Index Expression doesn't have STR(RECNO(),7)
      *SELECT CutTktL.*, Style.Scale, Style.cDefWare, 000 AS nPrePack ,;
                SPACE(1) AS cPrePack, "S" AS cStatus           ,;
                Style.cDye_Flg AS DyeYN, Style.nMCost1, Style.nMCost2,;
                Style.nMCost3, Style.nMCost4, Style.nMCost5          ,;
                000 AS nStep                                          ;
      FROM CutTktL,Style                                              ;
      WHERE  CutTktL.CutTkt+CutTktL.Style+CutTktL.Dyelot             +;
             CutTktL.TranCD+STR(RECNO("CutTktL"),7) = laData[1] AND   ;
             CutTktL.TranCD = "1"                               AND   ;
             CutTktL.Style = Style.Style                        AND   ;
             Style.Make AND Style.Status <> 'X'                       ;
      INTO   DBF(gcWorkDir+lcTmpCutLn)

      *B804289,1 AMH get the correct prepack from cuttktl file [Start]
      *SELECT CutTktL.*, Style.Scale, Style.cDefWare, 000 AS nPrePack ,;
                SPACE(1) AS cPrePack, "S" AS cStatus           ,;
                Style.cDye_Flg AS DyeYN, Style.nMCost1, Style.nMCost2,;
                Style.nMCost3, Style.nMCost4, Style.nMCost5          ,;
                000 AS nStep                                          ;
      FROM CutTktL,Style                                              ;
      WHERE  CutTktL.CutTkt+CutTktL.Style+CutTktL.Dyelot             +;
             CutTktL.TranCD = laData[1]                         AND   ;
             CutTktL.TranCD = "1"                               AND   ;
             CutTktL.Style = Style.Style                        AND   ;
             Style.Make AND Style.Status <> 'X'                       ;
      INTO   DBF(gcWorkDir+lcTmpCutLn)
      SELECT CutTktL.*, Style.Scale, Style.cDefWare, PpQty AS nPrePack ,;
                CutTktL.PrePak AS cPrePack, "S" AS cStatus           ,;
                Style.cDye_Flg AS DyeYN, Style.nMCost1, Style.nMCost2,;
                Style.nMCost3, Style.nMCost4, Style.nMCost5          ,;
                000 AS nStep                                          ;
      FROM CutTktL,Style                                              ;
      WHERE  CutTktL.CutTkt+CutTktL.Style+CutTktL.Dyelot             +;
             CutTktL.TranCD = laData[1]                         AND   ;
             CutTktL.TranCD = "1"                               AND   ;
             CutTktL.Style = Style.Style                        AND   ;
             Style.Make AND Style.Status <> 'X'                       ;
      INTO   DBF(gcWorkDir+lcTmpCutLn)
      *B804289,1 AMH [End]
      
      *MAN NY End   
      SELECT (lcTmpCutLn)
      INDEX ON Style+cWareCode+Dyelot TAG (lcTmpCutLn)
      USE
      = gfOpenFile(gcWorkDir+lcTmpCutLn, lcTmpCutLn, "SH")

      *E301077,56 YM 03/03/99 Start - Open the CutPick file.
      = gfOpenFile(gcDataDir+"CutPick","","SH")
      *E301077,56 YM 03/03/99 End.
      
      SELECT CutPick
      *lcOld = FILTER()
      *SET FILTER TO 
      SELECT *, "S" AS cCPStatus                    ,;
             Qty1 AS nCurPck1, Qty2 AS nCurPck2     ,; 
             Qty3 AS nCurPck3, Qty4 AS nCurPck4     ,; 
             Qty5 AS nCurPck5, Qty6 AS nCurPck6     ,;
             Qty7 AS nCurPck7, Qty8 AS nCurPck8     ,; 
             TotQty AS nTotCur                       ;
        FROM CutPick                                 ;
       WHERE TranCd+cTktNo+Style="1"+laData[1]       ;
        INTO DBF (gcWorkDir+lcTmpCtPk)
      SELECT (lcTmpCtPk)
      INDEX ON Style+Order+cOrdLine TAG (lcTmpCtPk)
      USE
      = gfOpenFile(gcWorkDir+lcTmpCtPk, lcTmpCtPk, "SH")
      SELECT (lcTmpCtPk)
      SET FILTER TO Style+Order+cOrdLine = (lcOrderKy)
      
      SELECT CutPick
      SET FILTER TO TranCD+CtktNo+Style = (lcOrderKy)
      *SET FILTER TO &lcOld
    ENDIF
    
    llNoThing = lfLnBrowse()
    
    *-- Update and refresh the "Option" browses if it's active.
    IF lcActTrnBr $ "RO" AND !llCTZoom
      = lfOptBrows()
    ENDIF
    
    *-- Create an "Open" record in the uncomplete session file.
    *-- This will be done only if we are not comeing from 
    *-- an uncomplete session number.
    lcScrMode = "E"
    llNoThing = IIF(lnUnCmSeRc=0, lfAdUnCmSR(), .T.)
    llNoThing = lfShowEnd()

    *E301289,1 WAB (START) ENABLE 'Po profitability' in option Bar() in edit mode
    lcDispPric = "ENABLE"
    *E301289,1 WAB - END

  *-- Add mode.
  CASE laScrMode[4]

    *-- There are two levels of the add mode in this screen, first one
    *-- is when the user click on the "New" button in the control pannel
    *-- at this point all the objects will be disabled untill he fills in
    *-- the Item major (Style) object, when he does so, the second level 
    *-- of the add mode comes up which is the normal add mode (all the 
    *-- objects are enabled except the key).
    IF EMPTY(laData[2])
      lcStyDesc  = SPACE(1)
      lcMajStat  = "ENABLE"
      lcNrmStat  = "DISABLE"
      lcHedrWare = IIF(llMultiWar, SPACE(0), lcHedrWare) 
      llNoThing  = gfwCodePop(@laCodeInfo, "SEASON"   , "N")
      llNoThing  = gfwCodePop(@laCodeInfo, "CDIVISION", "N")
      
      lnLastFold  = lnActFolder
      lnActFolder = 1
      llNoThing   = lfChngFolder(lnActFolder)
      SHOW GET ibFolder[2] DISABLE

      SELECT (lcTmpCutLn)
      BLANK ALL
      DELETE ALL
      SHOW GET ibFolder[2] DISABLE

      *B602159,1 YMA 12/17/98 Fixed the bug of not changing the multi lot
      *B602159,1 YMA 12/17/98 status when switching to the add mode.
      *-- Rebuild the contractor cursor.
      llMultiLot = laData[18] = "M"
      SHOW GET llMultiLot
      *B603292,1 Added cStatus
      CREATE CURSOR (lcContrFil) ;
                    (cContCode C(8), cContName C(30), lInHouse L   ,;
                     cOprCode  C(6), cLotNo    C(02), nbudget  N(6),;
                     nReceivd  N(6), nDameged  N(06), nCanceld N(6),;
                     nActQty2  N(6), cStatus C(8))
      =lfCnBrowse()
      *B602159,1 YMA 12/17/98 End.

      llNoThing = lfShowEnd()
      
      ACTIVATE WINDOW (lcCTChWin2)
      _CUROBJ   = OBJNUM(laData[2])
    ELSE
      *-- Create an "Open" record in the uncomplete session file.
      llCUpdate  = .T.
      lcScrMode  = "A"
      llNoThing  = IIF(lnUnCmSeRc=0, lfAdUnCmSR(), .T.)
      
      lcStyDesc = IIF(SEEK(laData[2],"Style"), Style.Desc1, "")
      lcMajStat = "DISABLE"
      lcNrmStat = "ENABLE"
      SHOW GET ibFolder[2] ENABLE
      IF llMultiWar
        _CUROBJ   = OBJNUM(lcHedrWare)
      ENDIF  
    ENDIF  
    SHOW GET laData[1]  DISABLE
    SHOW GET laData[2]  &lcMajStat
    SHOW GET ibStyBrow  &lcMajStat
    SHOW GET lcHedrWare &lcNrmStat
    SHOW GET pbBrHdWare &lcNrmStat
    SHOW GET laData[11] &lcNrmStat
    SHOW GET llMultiLot ENABLE
    SHOW GET pbCTNote   DISABLE
    SHOW GET pbObjlnk   DISABLE
    SHOW GET pbCostSh   DISABLE
    
    lcPromp      = lcCancel
    lcCanStat    = "DISABLE"
    laCtrStat[8] = lcCanStat
    lcCostShSt   = "DISABLE"
    lcGnLinsSt   = IIF(llGenLines, "DISABLE", "ENABLE")

    SHOW GET pbCTGnLns &lcGnLinsSt
    
    llNoThing = IIF(EMPTY(laData[2]), .F., lfShowEnd())

    *E301289,1 WAB - ENABLE SELLING  PRICE Button if Ther are ctlines
    *E301289,1 WAB - ENABLE   'Po profitability' in option Bar()    
*    lcGnLinsSt   = IIF(llGenLines, "ENABLE","DISABLE")
*    SHOW GET pbGP &lcGnLinsSt 
    lcDispPric = "ENABLE"
    *E301289,1 WAB - END

    *C102094,1 AMH check if this trigger exist then initialize the [Start]
    *C102094,1 AMH user defined fields.
    IF ASCAN(laEvntTrig , PADR('SELCTFLD',10)) <> 0
      DO lfIniUsrFl IN CATMAIN
    ENDIF     
    *C102094,1 AMH [End]

    *C102581,1 AMH check if this trigger exist then initialize the [Start]
    *C102581,1 AMH user defined fields.
    IF ASCAN(laEvntTrig , PADR('INIUSRFL',10)) <> 0
      =gfDoTriger('MFCUTKT',PADR('INIUSRFL',10))
    ENDIF     
    *C102581,1 AMH [End]

ENDCASE

*:----------------------------------------------------------------
*: Name       : lfShowEnd
*: Developer  : Yasser Mohammed Aly - (YMA)
*: Date       : 11/03/1997
*: Purpose    : To be called at the end of the lpShow
*:----------------------------------------------------------------
*: Calls      : None.
*:----------------------------------------------------------------
*: Parameters : None.
*:----------------------------------------------------------------
*: Returns    : None.
*:----------------------------------------------------------------
*: Example    : = lfShowEnd()
*:----------------------------------------------------------------
FUNCTION lfShowEnd

*-- This variable is used to filter the "CutTktL", "CutPick" and the alias
*-- of the "CutTktL" that deals with the cutting ticket receivings which 
*-- called "CutRec", it should be updated to refresh these filters.
lcCutTkt  = laData[1]
IF laScrMode[2]
  *B603292,1 Optimize speed when selecting CT Start
  *GOTO TOP IN CutTktL
  lnAlsNo = SELECT(0)
  SELECT CutTktL
  LOCATE 
  SELECT (lnAlsNo)
  *B603292,1 End
ENDIF
lcFltFile = IIF (laScrMode[1] OR laScrMode[2], "CutTktL", lcTmpCutLn)
lcOrderKy = IIF (laScrMode[3],&lcFltFile..Style,"1"+lcCutTkt+&lcFltFile..Style)

*-- Refresh the "Delete" bar in the system menu, and the lines browse
*-- and the active folder.
llNoThing = lfStDelBar()
llNoThing = lfActFolder()

*:----------------------------------------------------------------
*: Name       : lfActFolder
*: Developer  : Yasser Mohammed Aly - (YMA)
*: Date       : 11/03/1997
*: Purpose    : Refresh the active folder objects and disable
*:              the other object in the other folders.
*:----------------------------------------------------------------
*: Calls      : None.
*:----------------------------------------------------------------
*: Parameters : None.
*:----------------------------------------------------------------
*: Returns    : None.
*:----------------------------------------------------------------
*: Example    : = lfActFolder()
*:----------------------------------------------------------------
FUNCTION lfActFolder
DO CASE
  *-- The header folder.
  CASE lnActFolder = 1
    *-- Disble the other folders objects.
    SHOW WINDOW (lcCTChWin3) TOP
    SHOW GETS WINDOW (lcCTChWin4) DISABLE ONLY
    SHOW GETS WINDOW (lcCTChWn42) DISABLE ONLY
    SHOW GETS WINDOW (lcCTChWn40) DISABLE ONLY
    SHOW GETS WINDOW (lcCTChWin5) DISABLE ONLY
    
    *-- Enable/Disble the folder's objects.
    lcShowSt = IIF(laScrMode[3] OR (laScrMode[4] AND !EMPTY(laData[2])), "ENABLE", "DISABLE")
    SHOW GET laData[5]  &lcShowSt
    SHOW GET laData[6]  &lcShowSt
    SHOW GET laData[7]  &lcShowSt
    SHOW GET laData[8]  &lcShowSt
    SHOW GET lnSeason   DISABLE
    SHOW GET ibTrap31   ENABLE
    
    IF laScrMode[4] AND !EMPTY(laData[2]) AND llGenLines
      SHOW GET lnDivision ENABLE
    ELSE
      SHOW GET lnDivision DISABLE
    ENDIF

  *-- The details folder.
  CASE lnActFolder = 2
    *-- Disble the other folders objects.
    SHOW WINDOW (lcCTChWin4) TOP
    SHOW GETS WINDOW (lcCTChWin3) DISABLE ONLY
    SHOW GETS WINDOW (lcCTChWn31) DISABLE ONLY
    SHOW GETS WINDOW (lcCTChWin5) DISABLE ONLY

    *-- Prevent the activation of this folder if we are in add 
    *-- mode and the cutting ticket is a multi warehouse CT
    *-- and the header warehouse is empty.
    *-- Otherwise build the temporary lines file if it's not built
    *-- yet.
    IF llMultiWar AND laScrMode[4] AND !laData[11] AND EMPTY(lcHedrWare)
      *-- You have to select a warehouse first
      llNoThing   = gfModalGen('TRM38052B00000')
      lnActFolder = lnLastFold
      lnLastFold  = 2
      llNoThing   = lfChngFolder(lnActFolder)
      _CUROBJ     = OBJNUM(lcHedrWare)
    ELSE
      llNoThing   = IIF(laScrMode[4] AND llGenLines, lfBldLine(), .T.)
    ENDIF

    *-- If comming from another session or another active program
    *-- then refresh the browse and the window that's below it
    *-- according to the status of the selected bars in the 
    *-- "Option" menu pad.
    *-- The usage of this flag is usefull because we do not need to 
    *-- do this refresh every time the user change the folders, it's
    *-- only needed when comming from another session.
    IF llRefPage2 
      = IIF(llCTZoom, .T., lpvCTTran(ATC(lcActTrnBr,"BRO-T"))) 
      llRefPage2 = .F.
    ELSE
      llNoThing = lfwLnBrow()
    ENDIF  
    
    *-- Always enable the Trapping invisable button.
    SHOW GET ibTrap04 ENABLE

    *E301289,1 WAB - ENABLE SELLING  PRICE Button if Ther are ctlines
    *E301289,1 WAB - ENABLE   'Po profitability' in option Bar()    
    lcGnLinsSt  = "DISABLE"
    IF (laScrMode[4] OR laScrMode[3]) llGenLines
      lcGnLinsSt =  "ENABLE"
    ENDIF
    *lcGnLinsSt   = IIF(llGenLines AND (laScrMode[3] OR laScrMode[4]), "ENABLE","DISABLE")
    SHOW GET pbGP &lcGnLinsSt 
    *E301289,1 WAB - END
  *-- The summary folder.
  CASE lnActFolder = 3
    *-- Refresh the says in this window.
    SHOW WINDOW (lcCTChWin5) TOP
    llNoThing = lfRefresh(lcCTChWin5)

    *-- Disble the other folders objects.
    SHOW GETS WINDOW (lcCTChWin3) DISABLE ONLY
    SHOW GETS WINDOW (lcCTChWn31) DISABLE ONLY
    SHOW GETS WINDOW (lcCTChWin4) DISABLE ONLY
    SHOW GETS WINDOW (lcCTChWn42) DISABLE ONLY
    SHOW GETS WINDOW (lcCTChWn40) DISABLE ONLY
    
    *E301243 to enable Cost by Unit PUSH BUTTON every time folder is changed [Begin.]
    IF laScrMode[1] = .T.           && Select Mode
      SHOW GET PbSwitch DISABLE     && Push Botton is Disabled 
    ELSE                            && View,Edit,Add Mode
      SHOW GET PbSwitch ENABLE      && Push Botton is Enabled 	
    ENDIF                          
    *E301243 to enable Cost by Unit PUSH BUTTON every time folder is changed [End.]

ENDCASE

*-- Refresh the memo field in the uncomplete session file with the 
*-- value of the active folder number that will be used to activate 
*-- the folder that was active in the uncomplete session of the program.
llNoThing = lfUpdVars()

*:----------------------------------------------------------------
*: Name       : lfvCTNote
*: Developer  : Yasser Mohammed Aly - (YMA)
*: Date       : 11/03/1997
*: Purpose    : Valid function for the "NotePad" button in the 
*:              control pannel.
*:----------------------------------------------------------------
*: Calls      : None.
*:----------------------------------------------------------------
*: Parameters : None.
*:----------------------------------------------------------------
*: Returns    : None.
*:----------------------------------------------------------------
*: Example    : = lfvCTNote()
*:----------------------------------------------------------------
FUNCTION lfvCTNote

= NotePad('I',laData[1])

*:----------------------------------------------------------------
*: Name       : lfvCostSh
*: Developer  : Yasser Mohammed Aly - (YMA)
*: Date       : 11/03/1997
*: Purpose    : Valid function for the "Cost Sheet" button in the 
*:              control pannel.
*:----------------------------------------------------------------
*: Calls      : None.
*:----------------------------------------------------------------
*: Parameters : None.
*:----------------------------------------------------------------
*: Returns    : None.
*:----------------------------------------------------------------
*: Example    : = lfvCostSh()
*:----------------------------------------------------------------
FUNCTION lfvCostSh
PRIVATE llOpnBom

llCllCstSh = .T.
SHOW GET pbCostSh DISABLE

*-- If the cutting ticket has no cost sheet and the style used in the 
*-- cutting ticket has also no cost sheet then display a message telling
*-- that, and do not run the cost sheet program.
IF laData[3] = "H"
  
  *E301077,56 YM 03/03/99 Start - Open the BOM file.
  = gfOpenFile(gcDataDir+"BOM","BOM","SH")
  *E301077,56 YM 03/03/99 End.

  
  *-- XXXXXXXXXX cost sheet not found for XXXXXXXXXX : 'XXXXXXXXXX'. 
  *-- Cannot proceed with the cutting ticket cost sheet.
  *-- < Ok >
  lcStr      = PROPER(ALLTRIM(lcMjrTtl)) + "|" +;
               PROPER(ALLTRIM(lcMjrTtl)) + "|" +;
               ALLTRIM(laData[2])
  llCllCstSh = !(!SEEK(ALLTRIM(laData[2]),"Bom") AND ;
               gfModalGen("TRM38095B00000","DIALOG",lcStr)=1)
ENDIF

*-- Call the cutting ticket cost sheet program.
IF llCllCstSh
  lcParameter = "'M','" + laData[1] + "'"
  DO gpDoProg WITH "AWRMFCSSH", .F., "MF", lcParameter
ENDIF  

*:----------------------------------------------------------------
*: Name       : lfChkPrc
*: Developer  : Yasser Mohammed Aly - (YMA)
*: Date       : 11/03/1997
*: Purpose    : Check that the active cutting ticket line has no
*:              receivings, this check will be performed prior to 
*:              deleteing the active cutting ticket line.
*:----------------------------------------------------------------
*: Calls      : None.
*:----------------------------------------------------------------
*: Parameters : None.
*:----------------------------------------------------------------
*: Returns    : None.
*:----------------------------------------------------------------
*: Example    : = lfChkPrc()
*:----------------------------------------------------------------
FUNCTION lfChkPrc
PRIVATE lnAlias

lnAlias  = SELECT(0)
llRetVal = .F.
lcExp    = laData[1] + &lcTmpCutLn..Style

*E301077,56 YM 03/03/99 Start - Use gfOpenFile instead.
lcCutTktL = SPACE(0)
= gfOpenFile(gcDataDir+"CutTktL","CutTktL","SH", @lcCutTktL, .T.)
*USE (gcDataDir+"CutTktL") AGAIN IN 0 ALIAS CutLine ORDER CutTktL
*E301077,56 YM 03/03/99 End.

SELECT (lcCutTktL)
IF SEEK(lcExp)
  SCAN REST WHILE CutTkt+Style = lcExp FOR TranCD <> "1"
    llRetVal = .T.
    EXIT
  ENDSCAN
ENDIF
= gfCloseFile(lcCutTktL)
SELECT (lnAlias)

RETURN (llRetVal)

*:----------------------------------------------------------------
*: Name       : lfBldLine
*: Developer  : Yasser Mohammed Aly - (YMA)
*: Date       : 11/03/1997
*: Purpose    : Build the main temporary cutting ticket lines file.
*:----------------------------------------------------------------
*: Calls      : None.
*:----------------------------------------------------------------
*: Parameters : None.
*:----------------------------------------------------------------
*: Returns    : None.
*:----------------------------------------------------------------
*: Example    : = lfBldLine()
*:----------------------------------------------------------------
FUNCTION lfBldLine
PRIVATE lnAlias

*E301077,56 YM 03/03/99 Start - Open the STYDYE file.
= gfOpenFile(gcDataDir+"STYDYE","STYDYE","SH")
*E301077,56 YM 03/03/99 End.

*-- Open the "StyInvJl" file that is used in the "gpAdStyWar" 
*-- used to check the existance of the style in the warehouse
*-- to avoid opening it and closing it again in the function 
*-- for each line.
lnAlias    = SELECT(0)
llOpnStyJl = gfOpenFile(gcDataDir+"STYINVJL","STYINVJL","SH")
llGenLines = .F.
llNoThing  = SEEK(laData[2],"Style")
lcDefWare  = IIF(laData[11], "cDefWare", "lcHedrWare")
lcStyDesc  = Style.Desc1
lcTmpName  = gfTempName()

*SELECT (lcTmpCutLn)
*BLANK ALL
*DELETE ALL

*-- Open the Style file in a new alias just to avoid dealing
*-- with the master style file alias of the program that has an
*-- active index, and filter.


*E301077,56 YM 03/03/99 Start - Use gfOpenFile instead.
lcStyFile = SPACE(0)
= gfOpenFile(gcDataDir+"Style","","SH", @lcStyFile, .T.)
*USE (gcDataDir+"Style") IN 0 AGAIN ALIAS TmpSty      
*E301077,56 YM 03/03/99 End.

* Last Field Added By HDM[start]
WAIT WINDOW "Generating lines for all " + LOWER(lcMinTtl) + "(s)..." NOWAIT

*E128404,3  TMI [Start] include the cStygrade field in the created file
*-* SELECT Style, Scale, cDefWare, cDye_Flg AS DyeYN      ,;
*-*        &lcDefWare AS cWareCode, "A" AS cStatus        ,;
*-*        "1" AS TranCD,nMCost1,nMCost2,nMCost3,nMCost4  ,;
*-*        nMCost5, cDivision,cBuyPrepk AS cPrePack        ;
*-*  FROM (lcStyFile)                                      ;
*-* WHERE cStyMajor=laData[2] AND Status#'X'               ;
*-* INTO DBF (gcWorkDir+lcTmpName)
SELECT Style, Scale, cDefWare, cDye_Flg AS DyeYN      ,;
       &lcDefWare AS cWareCode, "A" AS cStatus        ,;
       "1" AS TranCD,nMCost1,nMCost2,nMCost3,nMCost4  ,;
       nMCost5, cDivision,cBuyPrepk AS cPrePack       ,;
       cStyGrade ;
FROM (lcStyFile)                                       ;
WHERE cStyMajor=laData[2] AND Status#'X'               ;
INTO DBF (gcWorkDir+lcTmpName)
*E128404,3  TMI [End  ] 

* Last Field Added By HDM[end]
SELECT (lcTmpName)
INDEX ON cDivision TAG (lcTmpName)
= gfCloseFile(lcStyFile)

*-- main temporary cutting ticket lines file.
= lfCrtTmpLn() AND lfLnBrowse()

*-- Zero out the used variables
STORE 0 TO Qty1, Qty2, Qty3, Qty4, Qty5, Qty6, Qty7, Qty8, TotQty, nPrePack
STORE SPACE(0) TO cWareCode, Dyelot , cPrePack

*-- Update the main temporary cutting ticket lines file with the selected
*-- records from the style file, and check the existance of the style in 
*-- the warehouse
SELECT (lcTmpName)
SCAN FOR cDivision = laData[10]
  IF !SEEK(Style+cWareCode+SPACE(10),"STYDYE")
    = gpAdStyWar (Style,SPACE(10),cWareCode)
  ENDIF
  SCATTER MEMVAR MEMO

  SELECT (lcTmpCutLn)
  APPEND BLANK
  GATHER MEMVAR MEMO
ENDSCAN

SELECT (lcTmpCutLn)
*B603317,1 [
*GOTO TOP
LOCATE
*B603317,1 [

WAIT CLEAR

*-- Close and erase the temporary created cursor.
= IIF(llOpnStyJl, gfCloseFile("STYINVJL"), 0)
USE IN (lcTmpName)
ERASE (gcWorkDir+lcTmpName+".DBF")
ERASE (gcWorkDir+lcTmpName+".CDX")
ERASE (gcWorkDir+lcTmpName+".FPT")

lcGnLinsSt   = "ENABLE"
SHOW GET pbCTGnLns &lcGnLinsSt

SELECT(lnAlias)

*:----------------------------------------------------------------
*: Name       : lfBldCont
*: Developer  : Yasser Mohammed Aly - (YMA)
*: Date       : 11/03/1997
*: Purpose    : Build the temporary contractors file.
*:----------------------------------------------------------------
*: Calls      : None.
*:----------------------------------------------------------------
*: Parameters : None.
*:----------------------------------------------------------------
*: Returns    : None.
*:----------------------------------------------------------------
*: Example    : = lfBldCont()
*:----------------------------------------------------------------
FUNCTION lfBldCont
PRIVATE lnAlias

lnAlias = SELECT(0)

*E301077,56 YMA 03/03/99 Commented out the following SQL, to open the MFGOPRDT 
*E301077,56 YMA 03/03/99 prior to performing it.

*SELECT *, SUM(IIF(TranCD="1", nLotTotQty, 0)) AS nbudget1  ,;
*          SUM(IIF(TranCD="2", nLotTotQty, 0)) AS nReceivd1 ,;
*          SUM(IIF(TranCD="4", nLotTotQty, 0)) AS nCanceld1 ,;
*          SUM(IIF(TranCD="3", nLotTotQty, 0)) AS nDameged1 ,;
*          SUM(IIF(TranCD="1", nActQty   , 0)) AS nActQty1   ;
*FROM  (gcDataDir+"MFGOPRDT")                                ;
*WHERE cimtyp+CTKTNO+COPRCODE+CLOTNO = "M"+laData[1]         ;
*GROUP BY cContCode, cOprCode, cLotNo, TranCD                ;
*INTO CURSOR "TempCurs"

= gfOpenFile(gcDataDir+"MFGOPRDT" , "" , "SH")
*B603292,1 speed up when selecting CT - Instead of 2 SQL 1 is enough  (START)
*B603292,1 I commented the 2 SQLs and added new SQL
*SELECT *, SUM(IIF(TranCD="1", nLotTotQty, 0)) AS nbudget1  ,;
          SUM(IIF(TranCD="2", nLotTotQty, 0)) AS nReceivd1 ,;
          SUM(IIF(TranCD="4", nLotTotQty, 0)) AS nCanceld1 ,;
          SUM(IIF(TranCD="3", nLotTotQty, 0)) AS nDameged1 ,;
          SUM(IIF(TranCD="1", nActQty   , 0)) AS nActQty1   ;
FROM  MFGOPRDT                                              ;
WHERE cimtyp+CTKTNO+COPRCODE+CLOTNO = "M"+laData[1]         ;
GROUP BY cContCode, cOprCode, cLotNo, TranCD                ;
INTO CURSOR "TempCurs"
*E301077,56 YMA 03/03/99 End.

*B602285,1 YMA 03/09/99 Close the cursor before excuting the SQL.
IF USED(lcContrFil)
  USE IN (lcContrFil)
ENDIF
*B602285,1 YMA 03/09/99 End.

*SELECT *, SUM(nbudget1 ) AS nbudget         ,;
          SUM(nReceivd1) AS nReceivd        ,;
          SUM(nCanceld1) AS nCanceld        ,;
          SUM(nDameged1) AS nDameged        ,;
          SUM(nActQty1 ) AS nActQty2         ;
FROM  "TempCurs"                             ;
GROUP BY cContCode, cOprCode, cLotNo         ;
ORDER BY cContCode, cOprCode, cLotNo, TranCD ;
INTO DBF (gcWorkDir+lcContrFil)
*USE IN TempCurs

SELECT  cContCode,SPACE(30) AS cContName, .T. AS lInHouse,cOprCode,cLotNo, SPACE(8) AS cStatus, ;
        SUM(IIF(TranCD="1", nLotTotQty, 0)) AS nbudget  ,;
        SUM(IIF(TranCD="2", nLotTotQty, 0)) AS nReceivd ,;
        SUM(IIF(TranCD="4", nLotTotQty, 0)) AS nCanceld ,;
        SUM(IIF(TranCD="3", nLotTotQty, 0)) AS nDameged ,;
        SUM(IIF(TranCD="1", nActQty   , 0)) AS nActQty2  ;
FROM  MFGOPRDT                                           ;
WHERE cimtyp+CTKTNO+COPRCODE+CLOTNO = "M"+laData[1]      ;
GROUP BY cContCode, cOprCode, cLotNo                     ;
INTO DBF (gcWorkDir+lcContrFil)
*B603292,1 speed when selecting CT  (End)

*B602285,1 YMA 03/09/99 Get the proper value of the InHouse field from the master file.
SELECT MFGOPRDT
SET ORDER TO Mfgoprdt

SELECT (lcContrFil)
SCAN
  *B603292,1 Speed up when selecting a ticket - cImTyp and CTKTNO don't exist in the temp file 
  *IF SEEK(cimtyp+CTKTNO+COPRCODE+CLOTNO+"1", "MFGOPRDT")
  IF SEEK("M"+laData[1]+COPRCODE+CLOTNO+"1", "MFGOPRDT")
    SELECT (lcContrFil)
    *B603292,1 Speed up when selecting a ticket Calculate the Status here instead of calc filed in
    *B603292,1 the browse by calling a function Start
    lnOpen  = MAX(nbudget-nReceivd-nDameged-nCanceld,0)
    DO CASE
      CASE lnOpen = 0 AND nReceivd = nActQty2
       lcRetVal = "Actual"
      CASE lnOpen = 0
       lcRetVal = "Complete"
      OTHERWISE
       lcRetVal = "Open"
    ENDCASE
    *B603292,1 End

    *B603292,1 Speed up when selecting a ticket - Replace the cContName and the cStatus
    *REPLACE &lcContrFil..lInHouse WITH MFGOPRDT.lInHouse 
    REPLACE &lcContrFil..lInHouse  WITH MFGOPRDT.lInHouse, ;
            &lcContrFil..cContName WITH MFGOPRDT.cContName,;
            &lcContrFil..cStatus   WITH lcRetVal 
            
  ENDIF
ENDSCAN

SELECT (lcContrFil)
*B603317,1 [
*GOTO TOP
LOCATE
*B603317,1 [


SELECT MFGOPRDT
SET ORDER TO
*B602285,1 YMA 03/09/99 End.

SELECT(lnAlias)

*:----------------------------------------------------------------
*: Name       : lfLnBrowse
*: Developer  : Yasser Mohammed Aly - (YMA)
*: Date       : 11/03/1997
*: Purpose    : Browse the cutting ticket lines.
*:----------------------------------------------------------------
*: Calls      : None.
*:----------------------------------------------------------------
*: Parameters : None.
*:----------------------------------------------------------------
*: Returns    : None.
*:----------------------------------------------------------------
*: Example    : = lfLnBrowse()
*:----------------------------------------------------------------
FUNCTION lfLnBrowse
PRIVATE lnAlias

*-- If we're recalling this function to refresh the browse file
*-- then be sure to erase the browse window that prior to creat it
*-- again.
IF !EMPTY(lcLinesBrw) AND WEXIST(lcLinesBrw)
  RELEASE WINDOW (lcLinesBrw)
  = lfRefresh(lcCTChWin4)
ENDIF

*-- If we are in a view mode than we will browse from the master line
*-- file otherwise the temporary file will be used.
lnAlias    = SELECT(0)
llMastMode = laScrMode[1] OR laScrMode[2]
lcFile     = IIF(llMastMode, "CutTktL", lcTmpCutLn)

*-- If the browse window is zoomed than we will use another window.
lcBrWindow = IIF(llCTZoom, lcCTChWn43, lcCTChWn41)
*B802331,1 AMM Move the dyelot to be directly after the non major
*lcFields   = "cMarker=IIF(RECNO()=lnLnRecNo,'>',' '):1:R:H=' ':W=.F.,"          +;
             IIF(llNoNonMaj,"","cNonMajor=PADR(SUBSTR(Style,lnStyleWid+2),lnMinWid):R:"+ALLTRIM(STR(lnMinWid*2.1))+":P=lcMinPct:H=lcMinTtl,")+;
             "Qty1:6:H='Size1':R,"+"Qty2:6:H='Size2':R,"+"Qty3:6:H='Size3':R,"  +;
             "Qty4:6:H='Size4':R,"+"Qty5:6:H='Size5':R,"+"Qty6:6:H='Size6':R,"  +;
             "Qty7:6:H='Size7':R,"+"Qty8:6:H='Size8':R,"+"TotQty:6:H='Total':R" +;
             IIF(llMultiWar,",cWareCode:R:H='Warehouse'","")                    +;
             IIF(llDyelot,",Dyelot:R:H='Dyelot'","")

*B804220,1 AMH Add color desc. to lcFields for Cathy Daniels [Start]
*lcFields   = "cMarker=IIF(RECNO()=lnLnRecNo,'>',' '):1:R:H=' ':W=.F.,"          +;
             IIF(llNoNonMaj,"","cNonMajor=PADR(SUBSTR(Style,lnStyleWid+2),lnMinWid):R:"+ALLTRIM(STR(lnMinWid*2.1))+":P=lcMinPct:H=lcMinTtl,")+;
             IIF(llDyelot,"Dyelot:R:H='Dyelot',","") +;
             "Qty1:6:H='Size1':R,"+"Qty2:6:H='Size2':R,"+"Qty3:6:H='Size3':R,"  +;
             "Qty4:6:H='Size4':R,"+"Qty5:6:H='Size5':R,"+"Qty6:6:H='Size6':R,"  +;
             "Qty7:6:H='Size7':R,"+"Qty8:6:H='Size8':R,"+"TotQty:6:H='Total':R" +;
             IIF(llMultiWar,",cWareCode:R:H='Warehouse'","")
*B604565,1 AMH Remove color desc. to lcFields for Cathy Daniels [Start]
*lcFields   = "cMarker=IIF(RECNO()=lnLnRecNo,'>',' '):1:R:H=' ':W=.F.,"          +;
             IIF(llNoNonMaj,"","cNonMajor=PADR(SUBSTR(Style,lnStyleWid+2),lnMinWid):R:"+ALLTRIM(STR(lnMinWid*2.1))+":P=lcMinPct:H=lcMinTtl,")+;
             IIF(llNoNonMaj,"","cDesc=gfCodDes(SUBSTR(Style,lnStyleWid+2),'COLOR'):R:30:H='Desc.',")+;
             IIF(llDyelot,"Dyelot:R:H='Dyelot',","") +;
             "Qty1:6:H='Size1':R,"+"Qty2:6:H='Size2':R,"+"Qty3:6:H='Size3':R,"  +;
             "Qty4:6:H='Size4':R,"+"Qty5:6:H='Size5':R,"+"Qty6:6:H='Size6':R,"  +;
             "Qty7:6:H='Size7':R,"+"Qty8:6:H='Size8':R,"+"TotQty:6:H='Total':R" +;
             IIF(llMultiWar,",cWareCode:R:H='Warehouse'","")
*B804289,1 AMH Add color desc. to lcFields as the last col. [Start]
*lcFields   = "cMarker=IIF(RECNO()=lnLnRecNo,'>',' '):1:R:H=' ':W=.F.,"          +;
             IIF(llNoNonMaj,"","cNonMajor=PADR(SUBSTR(Style,lnStyleWid+2),lnMinWid):R:"+ALLTRIM(STR(lnMinWid*2.1))+":P=lcMinPct:H=lcMinTtl,")+;
             IIF(llDyelot,"Dyelot:R:H='Dyelot',","") +;
             "Qty1:6:H='Size1':R,"+"Qty2:6:H='Size2':R,"+"Qty3:6:H='Size3':R,"  +;
             "Qty4:6:H='Size4':R,"+"Qty5:6:H='Size5':R,"+"Qty6:6:H='Size6':R,"  +;
             "Qty7:6:H='Size7':R,"+"Qty8:6:H='Size8':R,"+"TotQty:6:H='Total':R" +;
             IIF(llMultiWar,",cWareCode:R:H='Warehouse'","")
lcFields   = "cMarker=IIF(RECNO()=lnLnRecNo,'>',' '):1:R:H=' ':W=.F.,"          +;
             IIF(llNoNonMaj,"","cNonMajor=PADR(SUBSTR(Style,lnStyleWid+2),lnMinWid):R:"+ALLTRIM(STR(lnMinWid*2.1))+":P=lcMinPct:H=lcMinTtl,")+;
             IIF(llDyelot,"Dyelot:R:H='Dyelot',","") +;
             "Qty1:6:H='Size1':R,"+"Qty2:6:H='Size2':R,"+"Qty3:6:H='Size3':R,"  +;
             "Qty4:6:H='Size4':R,"+"Qty5:6:H='Size5':R,"+"Qty6:6:H='Size6':R,"  +;
             "Qty7:6:H='Size7':R,"+"Qty8:6:H='Size8':R,"+"TotQty:6:H='Total':R" +;
             IIF(llMultiWar,",cWareCode:R:H='Warehouse'","")                    +;
             IIF(llNoNonMaj,"",",cDesc=gfCodDes(SUBSTR(Style,lnStyleWid+2),'COLOR'):R:30:H='Desc.'")
*B804289,1 AMH [End]
*B604565,1 AMH [End]
*B804220,1 AMH [End]
             
*B802331,1 AMM end

*E301289,1 WAB - Add Selling Price & Gross Margin to browse fileds IF the llDispPric is true 
*E301289,1 WAB - START
IF llDispPric
  lcFields = lcFields + [,nSelPrice :H='Selling Price' :R:P='999999999.99',;
                       nGrosMrgn :H='Gross Margin' :R:P='9999.99']
ENDIF
*E301289,1 WAB - END

SELECT (lcFile)
BROWSE FIELDS &lcFields WINDOW (lcBrWindow) IN WINDOW (lcCTChWin4) ;
       LOCK 0 SAVE NOWAIT NOEDIT NOCLEAR NOAPPEND NODELETE         ;
       NOMENU TITLE (lcLinesBrw) WHEN lfwLnBrow() VALID :F lfvBrow()
LOCATE
SELECT(lnAlias)

*:----------------------------------------------------------------
*: Name       : lfwLnBrow
*: Developer  : Yasser Mohammed Aly - (YMA)
*: Date       : 11/03/1997
*: Purpose    : "WHEN" function of the Cutting ticket lines browse.
*:----------------------------------------------------------------
*: Calls      : None.
*:----------------------------------------------------------------
*: Parameters : None.
*:----------------------------------------------------------------
*: Returns    : None.
*:----------------------------------------------------------------
*: Example    : = lfwLnBrow()
*:----------------------------------------------------------------
FUNCTION lfwLnBrow
PRIVATE lnAlias

lnAlias    = SELECT(0)
llMastMode = laScrMode[1] OR laScrMode[2]
lcFile     = IIF(llMastMode, "CutTktL", lcTmpCutLn)
SELECT (lcFile)

lnLnRecNo  = RECNO()

*E301182,5 03/30/99 YMA Set the cutpick filter in all the browse cases.
lcOrderKy  = IIF (laScrMode[3],&lcFile..Style,"1"+lcCutTkt+&lcFile..Style)
*E301182,5 03/30/99 YMA End.

*-- The behavior of the function will differ according to the status 
*-- of the bars in the "Option" menu pad as follows..
DO CASE
  *-- If the browse is zoomed, then nothing nedd to be refreshed.
  CASE llCTZoom
    *-- NoThing has to be done here.
    
  *-- If the browse edit regon is active then refresh it's objects.
  CASE lcActTrnBr = "B"
    llNoThing  = lfwBudget()
    
  *-- If the receiveings browse is the one active then refresh the
  *-- filter and the browse.
  CASE lcActTrnBr = "R"
    lcRecLogKy = lcCutTkt + &lcFile..Style
    IF !EMPTY(lcOptBrwTl) AND WEXIST(lcOptBrwTl)
      SELECT CutRec
      
      *B603317,1 [
      *GOTO TOP
      LOCATE
      *B603317,1 [
      
      = lfwOptBrow()
    ENDIF
    
  *-- If the allocated orders browse is the one active then refresh the
  *-- filter and the browse.
  CASE lcActTrnBr = "O"
    lcOrderKy = IIF (laScrMode[3],&lcFile..Style,"1"+lcCutTkt+&lcFile..Style)
    IF !EMPTY(lcOptBrwTl) AND WEXIST(lcOptBrwTl)
      lcToDelWth = IIF(laScrMode[3], lcTmpCtPk, "CutPick")
      SELECT (lcToDelWth)
      *B603317,1 [
      *GOTO TOP
      LOCATE
      *B603317,1 [

      = lfwOptBrow()
    ENDIF

  *-- If the total line transactions browse is the one active then 
  *-- recompute the totals for the active line and refresh the window.
  CASE lcActTrnBr = "T"
    llNoThing  = lfwTotals()

ENDCASE

*-- Finally refresh the lines browse to reposition the active line 
*-- pointer.
SHOW WINDOW (lcLinesBrw) REFRESH SAME
SELECT(lnAlias)

*:----------------------------------------------------------------
*: Name       : lfwBudget
*: Developer  : Yasser Mohammed Aly - (YMA)
*: Date       : 11/03/1997
*: Purpose    : "WHEN" function of the Cutting ticket lines browse
*:              when the browse edit regon is active.
*:----------------------------------------------------------------
*: Calls      : None.
*:----------------------------------------------------------------
*: Parameters : None.
*:----------------------------------------------------------------
*: Returns    : None.
*:----------------------------------------------------------------
*: Example    : = lfwBudget()
*:----------------------------------------------------------------
FUNCTION lfwBudget

llModiMod  = (laScrMode[3] OR laScrMode[4]) AND !EMPTY(laData[2])
IF EOF() OR BOF() OR DELETED()
  *-- If there is no records in the browse, then disable every thing
  *-- except the "New" button according to the screen mode.
  SCATTER FIELDS &lcLnScFlds MEMVAR BLANK
  lcNonMaj  = SPACE(0)
  llNoThing = lfGtSclInf()
  
  lcNewStat = IIF(llModiMod, "ENABLE", "DISABLE")
  lcDelStat = "DISABLE"
  lcNrmStat = "DISABLE"
  lcKeySt   = "DISABLE"
  lcWarStat = "DISABLE"
  lcDyeStat = "DISABLE"
ELSE
  *-- If the browse has records then update and enable/disable
  *-- the objects according to the mode.
  
  *-- Remember that when we are in the "Edit" or the "Add" mode
  *-- then each line will have three levels of checks to be 
  *-- performed according to the system setup and the cutting ticket 
  *-- status as follows...
  *-- 1. The existance of the "Non-Major" object.
  *-- 2. The Multi warehouse status of the system and the cutting ticket.
  *-- 3. The Dyelot status of the system and the active cutting ticket line.
  
  SCATTER FIELDS &lcLnScFlds MEMVAR
  lcNonMaj  = PADR(SUBSTR(Style,lnStyleWid+2),lnMinWid)
  llNoThing = lfGtSclInf()
  
  IF llModiMod
    llDye     = llDyelot   AND DyeYN = "Y"
    llMulti   = llMultiWar AND laData[11]
    llWarEmp  = IIF(llMultiWar, EMPTY(cWareCode), .F.)
    llDyeEmp  = IIF(llDye     , EMPTY(Dyelot)   , .F.)
    lcDelStat = IIF(laData[3]$"HO", "ENABLE", "DISABLE") 
    lcNewStat = "ENABLE"
    
    IF EMPTY(Style)
      lcKeySt   = "ENABLE"
      lcWarStat = "DISABLE"
      lcDyeStat = "DISABLE"
      lcNrmStat = "DISABLE"
    ELSE
      lcKeySt   = "DISABLE"
      lcWarStat = IIF(llWarEmp, "ENABLE", "DISABLE")
      lcDyeStat = IIF(llDyeEmp, "ENABLE", "DISABLE")
      lcNrmStat = IIF(llWarEmp OR llDyeEmp, "DISABLE", "ENABLE")
    ENDIF
  ELSE
    STORE "DISABLE" TO lcKeySt  , lcDelStat, lcNewStat
    STORE "DISABLE" TO lcNrmStat, lcWarStat, lcDyeStat
  ENDIF
ENDIF
llNoThing = lfRefresh(lcCTChWn42)      
SHOW GET lcNonMaj    &lcKeySt
SHOW GET pbBrLnWare  &lcWarStat
SHOW GET m.cWareCode &lcWarStat
SHOW GET m.Dyelot    &lcDyeStat
*--HDM Replace With CBUYPREPK [START]
*B804289,4 AMH Use lcFile insted of lcTmpCutLn [Start]
*m.cPrePack = cPrePack
m.cPrePack = IIF(TYPE('lcFile')<>'U' .AND. lcFile<>lcTmpCutLn,PrePak,cPrePack)
m.nPrePack = IIF(TYPE('lcFile')<>'U' .AND. lcFile<>lcTmpCutLn,PpQty,nPrePack)
*B804289,4 AMH [End]
IF !EMPTY(laData[2])
  =lfvPrepack()
ENDIF
*--HDM Replace With CBUYPREPK [END]

SHOW GET m.cPrePack  &lcNrmStat
SHOW GET m.nPrePack  &lcNrmStat
SHOW GET m.Qty1      &lcNrmStat
SHOW GET m.Qty2      &lcNrmStat
SHOW GET m.Qty3      &lcNrmStat
SHOW GET m.Qty4      &lcNrmStat
SHOW GET m.Qty5      &lcNrmStat
SHOW GET m.Qty6      &lcNrmStat
SHOW GET m.Qty7      &lcNrmStat
SHOW GET m.Qty8      &lcNrmStat
SHOW GET m.TotQty    &lcNrmStat
SHOW GET pbNew       &lcNewStat
SHOW GET pbRem       &lcDelStat
*E301289,1 WAB - show get gros price button ( disable /enable )depends if there are 
*E301289,1 WAB - lines in poline
*E301289,1 WAB -START
SHOW GET pbGP &lcDelStat
*E301289,1 WAB - END

*:----------------------------------------------------------------
*: Name       : lfwTotals
*: Developer  : Yasser Mohammed Aly - (YMA)
*: Date       : 11/03/1997
*: Purpose    : "WHEN" function of the Cutting ticket lines browse
*:              when the line total transaction window is active.
*:----------------------------------------------------------------
*: Calls      : None.
*:----------------------------------------------------------------
*: Parameters : None.
*:----------------------------------------------------------------
*: Returns    : None.
*:----------------------------------------------------------------
*: Example    : = lfwTotals()
*:----------------------------------------------------------------
FUNCTION lfwTotals

IF EOF() OR BOF() OR DELETED()
  *-- If there is no records in the browse than all the 
  *-- totals will be empty.
  SCATTER FIELDS &lcLnScFlds MEMVAR BLANK
  lcTNonMaj  = SPACE(0)
ELSE
  *-- Check if the active line is a newly added line in this session
  *-- or not.
  llNewLine = llMastMode = .F. AND &lcTmpCutLn..cStatus = "A"
  
  *-- Load the objects valus.
  SCATTER FIELDS &lcLnScFlds MEMVAR
  lcTNonMaj = PADR(SUBSTR(Style,lnStyleWid+2),lnMinWid)

  *-- Compute the totals.
  llNoThing = lfCompTot(Style, Dyelot)
ENDIF

*-- Refresh the window's objects.
SHOW GET lcTNonMaj
llNoThing = lfRefresh(lcCTChWn45)

*:----------------------------------------------------------------
*: Name       : lfCompTot
*: Developer  : Yasser Mohammed Aly - (YMA)
*: Date       : 11/03/1997
*: Purpose    : To compute the line total transactions.
*:----------------------------------------------------------------
*: Calls      : None.
*:----------------------------------------------------------------
*: Parameters : lcSty : Active style.
*:              lcDye : Active Dyelot.
*:----------------------------------------------------------------
*: Returns    : The global line totals variables are updated.
*:----------------------------------------------------------------
*: Example    : = lfCompTot()
*:----------------------------------------------------------------
FUNCTION lfCompTot
PARAMETERS lcSty, lcDye
PRIVATE lnAlias

STORE 0 TO lnStyBud, lnStyRec, lnStyDam, lnStyCan, lnStyOpn
IF llNewLine
  *-- If we are dealing with a new added line, then the totals
  *-- will be zeros.
  lnStyBud = &lcTmpCutLn..TotQty
  lnStyOpn = &lcTmpCutLn..TotQty
ELSE
  *-- Acumulate the totals from the "CutTktL" file that is re-opened
  *-- with the alias named "CutLnTot" when the user switch the 
  *-- "Option" bar to be "Transaction Totals", this file will be 
  *-- closed when switching to any other bar in the "Option" menu pad.
  lnAlias = SELECT(0)
  SELECT (lcCutLnTot)
  *MAN NY Start The Index Expression doesn't have STR(RECNO(),7)
  *SCAN FOR CutTkt+Style+Dyelot+TranCD+STR(RECNO(),7) = laData[1]+lcSty+lcDye
  SCAN FOR CutTkt+Style+Dyelot+TranCD = laData[1]+lcSty+lcDye
  *MAN NY End
    lcVar  = "lnSty" + SUBSTR("BUDRECDAMCAN",((VAL(TranCD)-1)*3)+1,3)
    &lcVar = &lcVar  + TotQty
  ENDSCAN
  lnStyOpn = MAX(lnStyBud - (lnStyRec+lnStyDam+lnStyCan), 0)

  SELECT(lnAlias)
ENDIF  

*:----------------------------------------------------------------
*: Name       : lfOptBrows
*: Developer  : Yasser Mohammed Aly - (YMA)
*: Date       : 11/03/1997
*: Purpose    : To browse either the receivings or the allocated
*:              orders for the current active cutting ticket line.
*:----------------------------------------------------------------
*: Calls      : None.
*:----------------------------------------------------------------
*: Parameters : None.
*:----------------------------------------------------------------
*: Returns    : None.
*:----------------------------------------------------------------
*: Example    : = lfOptBrows()
*:----------------------------------------------------------------
FUNCTION lfOptBrows
PRIVATE lnAlias

lnAlias = SELECT(0)

*E301077,56 YM 03/03/99 Start - Open the CutPick file.
= gfOpenFile(gcDataDir+"CutPick","","SH")
SELECT CutPick
SET FILTER TO TranCD+CtktNo+Style = (lcOrderKy)
*E301077,56 YM 03/03/99 End.

*-- Be sure to release the options browse window before using it
*-- again.
IF !EMPTY(lcOptBrwTl) AND WEXIST(lcOptBrwTl)
  RELEASE WINDOW (lcOptBrwTl)
  = lfRefresh(lcCTChWin4)
ENDIF

*-- Set the proper file, fields and browse window title according to
*-- the Selected bar in the "Option" menu pad.
IF lcActTrnBr = "R"
  lcRecStat  = PADR("",8)        + PADR("To Stock",8) +;
               PADR("Damaged",8) + PADR("Canceled",8)
  
  *B603338,1 ARH 12/15/99 (Start) Added the receiving date to the receiving browse
  *lcFields   = "cMarker=IIF(RECNO()=lnLnNo,'>',' '):1:R:H=' ':W=.F.,"          +;
               "cRecTo=SUBSTR(lcRecStat,((VAL(TranCD)-1)*8)+1,8):R:H='Receive':"+ALLTRIM(STR(lnMinWid*2.1))+","+;
               "Qty1:6:H='Size1':R,"+"Qty2:6:H='Size2':R,"+"Qty3:6:H='Size3':R,"  +;
               "Qty4:6:H='Size4':R,"+"Qty5:6:H='Size5':R,"+"Qty6:6:H='Size6':R,"  +;
               "Qty7:6:H='Size7':R,"+"Qty8:6:H='Size8':R,"+"TotQty:6:H='Total':R" +;
               IIF(llMultiWar,",cWareCode:R:H='Warehouse'","")                    +;
               IIF(llDyelot,",Dyelot:R:H='Dyelot'","")

  lcFields   = "cMarker=IIF(RECNO()=lnLnNo,'>',' '):1:R:H=' ':W=.F.,"          +;
               "cRecTo=SUBSTR(lcRecStat,((VAL(TranCD)-1)*8)+1,8):R:H='Receive':"+ALLTRIM(STR(lnMinWid*2.1))+","+;
               "Qty1:6:H='Size1':R,"+"Qty2:6:H='Size2':R,"+"Qty3:6:H='Size3':R,"  +;
               "Qty4:6:H='Size4':R,"+"Qty5:6:H='Size5':R,"+"Qty6:6:H='Size6':R,"  +;
               "Qty7:6:H='Size7':R,"+"Qty8:6:H='Size8':R,"+"TotQty:6:H='Total':R," +;
               "Date:H='Rcv. Date':R"+IIF(llMultiWar,",cWareCode:R:H='Warehouse'","")+;
               IIF(llDyelot,",Dyelot:R:H='Dyelot'","")
  *B603338,1 ARH 12/15/99 (End)

  lcOptBrwTl = "Receive Log"
  lcToBrow   = "CutRec"
ELSE
  lcFields   = "cMarker=IIF(RECNO()=lnLnNo,'>',' '):1:R:H=' ':W=.F.,"          +;
               "Order:R:H='Order#':"+ALLTRIM(STR(lnMinWid*2.1))+","+;
               "Qty1:6:H='Size1':R,"+"Qty2:6:H='Size2':R,"+"Qty3:6:H='Size3':R,"  +;
               "Qty4:6:H='Size4':R,"+"Qty5:6:H='Size5':R,"+"Qty6:6:H='Size6':R,"  +;
               "Qty7:6:H='Size7':R,"+"Qty8:6:H='Size8':R,"+"TotQty:6:H='Total':R"
  lcOptBrwTl = "Sales Orders"
  lcToBrow   = IIF(laScrMode[3], lcTmpCtPk, "CutPick")
  
  *C102524,1 AMH Trigger for Robyn Merdith to custom browser for sales orders [Start]
  IF ASCAN(laEvntTrig , PADR('ORDBROW',10)) <> 0
    =gfDoTriger('MFCUTKT',PADR('ORDBROW',10))
  ENDIF
  *C102524,1 AMH [End]
  
ENDIF  

*-- Browse the selected option.
SELECT (lcToBrow)

*B603317,1 [
*GOTO TOP
LOCATE
*B603317,1 [

BROWSE FIELDS &lcFields WINDOW (lcCTChWn44) IN WINDOW (lcCTChWin4) ;
       LOCK 0 SAVE NOWAIT NOEDIT NOCLEAR NOAPPEND NODELETE ;
       NOMENU TITLE (lcOptBrwTl) WHEN lfwOptBrow() VALID :F lfvBrow()

*-- Just to refresh the browse pointer.
= lfwOptBrow()

SELECT(lnAlias)

*:----------------------------------------------------------------
*: Name       : lfwOptBrow
*: Developer  : Yasser Mohammed Aly - (YMA)
*: Date       : 11/03/1997
*: Purpose    : "WHEN" function of the "Options" browse
*:----------------------------------------------------------------
*: Calls      : None.
*:----------------------------------------------------------------
*: Parameters : None.
*:----------------------------------------------------------------
*: Returns    : None.
*:----------------------------------------------------------------
*: Example    : = lfwOptBrow()
*:----------------------------------------------------------------
FUNCTION lfwOptBrow
PRIVATE lnAlias

*-- Select the proper file to deal with.
lnAlias    = SELECT(0)
IF lcActTrnBr = "R"
  lcToDelWth = "CutRec"
ELSE
  lcToDelWth = IIF(laScrMode[3], lcTmpCtPk, "CutPick")
ENDIF

*-- Refresh the browse pointer.
SELECT (lcToDelWth)
lnLnNo = RECNO()
SHOW WINDOW (lcOptBrwTl) REFRESH SAME
SELECT(lnAlias)

*:----------------------------------------------------------------
*: Name       : lfCnBrowse
*: Developer  : Yasser Mohammed Aly - (YMA)
*: Date       : 11/03/1997
*: Purpose    : The contractors browse.
*:----------------------------------------------------------------
*: Calls      : None.
*:----------------------------------------------------------------
*: Parameters : None.
*:----------------------------------------------------------------
*: Returns    : None.
*:----------------------------------------------------------------
*: Example    : = lfCnBrowse()
*:----------------------------------------------------------------
FUNCTION lfCnBrowse
PRIVATE lnAlias

*-- Be sure to release the contractors browse window before using it
*-- again.
IF !EMPTY(lcContrBrw) AND WEXIST(lcContrBrw)
  RELEASE WINDOW (lcContrBrw)
ENDIF

lnAlias    = SELECT(0)
*B603292,1 Speed up when selecting a ticket - Stop calling lfGtConSt
*lcCnFielsd = "cContCode:H='Contractor',"                             +;
             "cContName:H='Name':10,"                                +;
             "lHouse=IIF(lInHouse,'Yes','No'):H='InHouse':3,"        +;
             "cOprCode:H='Op.Code',"                                 +;
             "cOpDesc=gfCodDes(cOprCode,'MFGCODE'):H='Op.Desc.':15," +;
             "cLotNo:H='Lot#',"                                      +;
             "cStatus=lfGtConSt():H='Status',"                       +;
             "nbudget:H='Budget',"                                   +;
             "nOpen=MAX(nbudget-nReceivd-nDameged-nCanceld,0):H='Open',"    +;
             "nReceivd:H='Rec.',"                                    +;
             "nDameged:H='Dam.',"                                    +;
             "nCanceld:H='Can.'"
lcCnFielsd = "cContCode:H='Contractor',"                             +;
             "cContName:H='Name':10,"                                +;
             "lHouse=IIF(lInHouse,'Yes','No'):H='InHouse':3,"        +;
             "cOprCode:H='Op.Code',"                                 +;
             "cOpDesc=gfCodDes(cOprCode,'MFGCODE'):H='Op.Desc.':15," +;
             "cLotNo:H='Lot#',"                                      +;
             "cStatus:H='Status',"                                   +;
             "nbudget:H='Budget',"                                   +;
             "nOpen=MAX(nbudget-nReceivd-nDameged-nCanceld,0):H='Open',"    +;
             "nReceivd:H='Rec.',"                                    +;
             "nDameged:H='Dam.',"                                    +;
             "nCanceld:H='Can.'"             
SELECT (lcContrFil)
BROWSE FIELDS &lcCnFielsd WINDOW (lcCTChWn32)  IN WINDOW (lcCTChWin3)  ;
       LOCK 0 SAVE NOWAIT NOEDIT NOCLEAR NOAPPEND NODELETE            ;
       NOMENU TITLE (lcContrBrw) VALID :F lfvBrow()

SELECT(lnAlias)

*:----------------------------------------------------------------
*: Name       : lfGtConSt
*: Developer  : Yasser Mohammed Aly - (YMA)
*: Date       : 11/03/1997
*: Purpose    : Specify the status of the contractor line in words
*:              that will be used in the contractors browse.
*:----------------------------------------------------------------
*: Calls      : None.
*:----------------------------------------------------------------
*: Parameters : None.
*:----------------------------------------------------------------
*: Returns    : The status of the contractor line.
*:----------------------------------------------------------------
*: Example    : = lfGtConSt()
*:----------------------------------------------------------------
FUNCTION lfGtConSt
PRIVATE lnOpen, lcRetVal

*B802542,1 WAB - negative Qty can not be allowed here
*B802542,1 WAB - START
*lnOpen = nbudget-nReceivd-nDameged-nCanceld

lnOpen  = MAX(nbudget-nReceivd-nDameged-nCanceld,0)

*B802542,1 WAB - END

DO CASE
  CASE lnOpen = 0 AND nReceivd = nActQty2
    lcRetVal = "Actual"
  CASE lnOpen = 0
    lcRetVal = "Complete"
  OTHERWISE
    lcRetVal = "Open"
ENDCASE
RETURN (lcRetVal)

*:----------------------------------------------------------------
*: Name       : lfvBrow
*: Developer  : Yasser Mohammed Aly - (YMA)
*: Date       : 11/03/1997
*: Purpose    : Valid function for all the screen's browses.
*:----------------------------------------------------------------
*: Calls      : None.
*:----------------------------------------------------------------
*: Parameters : None.
*:----------------------------------------------------------------
*: Returns    : None.
*:----------------------------------------------------------------
*: Example    : = lfvBrow()
*:----------------------------------------------------------------
FUNCTION lfvBrow

*-- Call the global function "gfStopBrow" if one of the screen's
*-- browses is active.
IF !INLIST(WONTOP(), lcLinesBrw, lcOptBrwTl, lcContrBrw)
  glFromBrow = .T.
  = gfStopBrow()
ENDIF

*:----------------------------------------------------------------
*: Name       : lfTrap
*: Developer  : Yasser Mohammed Aly - (YMA)
*: Date       : 11/03/1997
*: Purpose    : Screen's "Deactivate" function that is used to 
*:              establish the window trapping.
*:----------------------------------------------------------------
*: Calls      : None.
*:----------------------------------------------------------------
*: Parameters : None.
*:----------------------------------------------------------------
*: Returns    : None.
*:----------------------------------------------------------------
*: Example    : = lfTrap()
*:----------------------------------------------------------------
FUNCTION lfTrap

*-- Set the global flag "glFromBrow" to true only if one of the
*-- screen's browses is active.
glFromBrow = INLIST(WONTOP(), lcLinesBrw, lcOptBrwTl, lcContrBrw) 

*-- If any of the screen's browses is active then trap the 
*-- Tab, ShiftTab, Ctrl+Enter, Ctrl+Home and Ctrl+End keys.
IF glFromBrow
  ON KEY LABEL TAB     DO lfTab
  ON KEY LABEL BACKTAB DO lfShtTab
  ON KEY LABEL Ctrl+ENTER lnDummy = 1
  ON KEY LABEL Ctrl+HOME  lnDummy = 1
  ON KEY LABEL Ctrl+END   lnDummy = 1
ENDIF  

*B602481,1 AMH Return .F. when hide the screen contained the remove botton then the [Start]
*B602481,1 AMH gfStopRead function not called after lfTrap
IF !WVISIBLE(lcCTChWn42)
  RETURN .F.
ENDIF
*B602481,1 AMH [End]

*:----------------------------------------------------------------
*: Name       : lfClrTrap
*: Developer  : Yasser Mohammed Aly - (YMA)
*: Date       : 11/03/1997
*: Purpose    : Screen's "Activate" function that is used to 
*:              release the window trapping.
*:----------------------------------------------------------------
*: Calls      : None.
*:----------------------------------------------------------------
*: Parameters : None.
*:----------------------------------------------------------------
*: Returns    : None.
*:----------------------------------------------------------------
*: Example    : = lfClrTrap()
*:----------------------------------------------------------------
FUNCTION lfClrTrap

IF glFromBrow
  = gfStopBrow()
  glFromBrow = .F.
ENDIF

*-- If none of the screen's browses is active then clear the 
*-- trapped keys.
IF !INLIST(WONTOP(), lcLinesBrw, lcOptBrwTl, lcContrBrw)
  ON KEY LABEL TAB
  ON KEY LABEL BACKTAB
  ON KEY LABEL Ctrl+ENTER
  ON KEY LABEL Ctrl+HOME 
  ON KEY LABEL Ctrl+END  
ENDIF

*:----------------------------------------------------------------
*: Name       : lfTab
*: Developer  : Yasser Mohammed Aly - (YMA)
*: Date       : 11/03/1997
*: Purpose    : The "Tab" key trapping procedure.
*:----------------------------------------------------------------
*: Calls      : None.
*:----------------------------------------------------------------
*: Parameters : None.
*:----------------------------------------------------------------
*: Returns    : None.
*:----------------------------------------------------------------
*: Example    : ON KEY LABEL TAB DO lfTab
*:----------------------------------------------------------------
FUNCTION lfTab

DO CASE
  *-- If the active browse is the details browse..
  CASE WONTOP() = lcLinesBrw
    DO CASE
      *-- And it is zoomed or not zoomed and the active option 
      *-- is the "Transactions Totals" then activate the control
      *-- pannel.
      CASE llCTZoom OR (!llCTZoom AND lcActTrnBr = "T")
        ON KEY LABEL TAB
        ACTIVATE WINDOW gwcContrl1

      *-- And it is not zoomed and the active option is the 
      *-- "Browse edit regon" then activate it.
      CASE !llCTZoom AND lcActTrnBr = "B"
        ON KEY LABEL TAB
        ACTIVATE WINDOW (lcCTChWn42)

      *-- Othrewise activate the Option browse.
      CASE !llCTZoom AND lcActTrnBr # "B"
        KEYBOARD "{ALT+J}" PLAIN CLEAR
    ENDCASE

  *-- If teh active browse is the Contractor browse or the Options
  *-- browse then activate the control pannel window.
  CASE INLIST(WONTOP(), lcOptBrwTl, lcContrBrw)
    ON KEY LABEL TAB
    ACTIVATE WINDOW gwcContrl1
ENDCASE

*:----------------------------------------------------------------
*: Name       : lfShtTab
*: Developer  : Yasser Mohammed Aly - (YMA)
*: Date       : 11/03/1997
*: Purpose    : The "Shift+Tab" key trapping procedure.
*:----------------------------------------------------------------
*: Calls      : None.
*:----------------------------------------------------------------
*: Parameters : None.
*:----------------------------------------------------------------
*: Returns    : None.
*:----------------------------------------------------------------
*: Example    : ON KEY LABEL TAB DO lfShtTab
*:----------------------------------------------------------------
FUNCTION lfShtTab

DO CASE
  *-- If the active browse is the "Line" browse then activate the 
  *-- invisable button to handel the next movement.
  CASE WONTOP() = lcLinesBrw
    ON KEY LABEL BACKTAB
    ACTIVATE WINDOW (lcCTChWn40)

  *-- If the active browse is the "Option" browse then activate the
  *-- "Line" browse.
  CASE WONTOP() = lcOptBrwTl
    KEYBOARD "{ALT+Q}" PLAIN
    
  *-- If the active browse is the "Contractors" browse then activate 
  *-- either the "Folder's button" or the "Type Object" according
  *-- to the screen mode.
  CASE WONTOP() = lcContrBrw
    ON KEY LABEL BACKTAB
    IF laScrMode[1] OR laScrMode[2] OR (laScrMode[4] AND EMPTY(laData[2]))
       ACTIVATE WINDOW (lcFolder)
      _CUROBJ = OBJNUM(ibFolder[1])
    ELSE
      ACTIVATE WINDOW (lcCTChWn31)
      _CUROBJ = OBJNUM(laData[8])
    ENDIF
ENDCASE

*:----------------------------------------------------------------
*: Name       : lfActPad
*: Developer  : Yasser Mohammed Aly - (YMA)
*: Date       : 11/03/1997
*: Purpose    : To create the "Option" menu pad.
*:----------------------------------------------------------------
*: Calls      : None.
*:----------------------------------------------------------------
*: Parameters : None.
*:----------------------------------------------------------------
*: Returns    : None.
*:----------------------------------------------------------------
*: Example    : = lfActPad()
*:----------------------------------------------------------------
FUNCTION lfActPad

*-- Define the "Options" menu pad.
DEFINE PAD   _OPTIONS OF _MSYSMENU PROMPT 'O\<ptions' KEY ALT+P , SPACE(1)

*-- Define the "Options" and the "Transactions" popups.
DEFINE POPUP _OPTIONPOP MARGIN SHADOW
DEFINE POPUP _CTTRANS   MARGIN SHADOW

*-- Define the "Options" bars in the "Options" menu pad.
DEFINE BAR 1 OF _OPTIONPOP PROMPT "Cutting Ticket Transactions" SKIP FOR !((lnActFolder=2) AND (llCTZoom=.F.) AND (laScrMode[1]=.F.))
DEFINE BAR 2 OF _OPTIONPOP PROMPT "Zoom Cutting Ticket Lines  " SKIP FOR !((laScrMode[1]=.F.) AND (lnActFolder=2)) KEY ALT+Z
DEFINE BAR 3 OF _OPTIONPOP PROMPT "\-" SKIP FOR .T.
DEFINE BAR 4 OF _OPTIONPOP PROMPT "Cutting Ticket Cost Sheet  " SKIP FOR lcCostShSt = "DISABLE"
DEFINE BAR 5 OF _OPTIONPOP PROMPT "Generate Lines Based on Components Availability" SKIP FOR lcGnLinsSt = "DISABLE"

*E301289,1 WAB - Add New Bar for  'CT profitability' 
*E301289,1 WAB - START
IF llDispPric
   DEFINE BAR 6 OF _OPTIONPOP PROMPT "CT Profitability " SKIP FOR lcDispPric = "DISABLE"
ENDIF
*E301289,1 WAB - END

*-- Define the "Transactions" bars in the "Transactions" menu pad.
DEFINE BAR 1 OF _CTTRANS   PROMPT "Budget"              KEY ALT+G
DEFINE BAR 2 OF _CTTRANS   PROMPT "Receivings"          KEY ALT+R
DEFINE BAR 3 OF _CTTRANS   PROMPT "Sales Orders"        KEY ALT+S
DEFINE BAR 4 OF _CTTRANS   PROMPT "\-" SKIP FOR .T.
DEFINE BAR 5 OF _CTTRANS   PROMPT "Transactions Totals"

*-- Define the action to be done when activating the pad and the popup.
ON PAD _OPTIONS OF _MSYSMENU ACTIVATE POPUP _OPTIONPOP
ON BAR 1 OF _OPTIONPOP ACTIVATE POPUP _CTTRANS

*-- Define the "Set Skip" flag of the bars.
SET MARK OF BAR 1 OF _CTTRANS   TO .T.
SET MARK OF BAR 2 OF _OPTIONPOP TO llCTZoom

*-- Define the action to be done when selecting the bars.
ON SELECTION POPUP _CTTRANS   DO lpvCTTran
ON SELECTION POPUP _OPTIONPOP DO lpvCTZoom

*-- Define the browses bars.
DEFINE BAR 100 OF P01PU01 PROMPT "\-" SKIP FOR .T.
DEFINE BAR 101 OF P01PU01 PROMPT lcContrBrw KEY ALT+D SKIP FOR (lnActFolder#1)
DEFINE BAR 102 OF P01PU01 PROMPT lcLinesBrw KEY ALT+Q SKIP FOR (lnActFolder#2)

*-- Activate the browses when selecting there bars.
ON SELECTION BAR 101 OF P01PU01 ACTIVATE WINDOW(lcContrBrw)
ON SELECTION BAR 102 OF P01PU01 ACTIVATE WINDOW(lcLinesBrw)

*:----------------------------------------------------------------
*: Name       : lfDeActPad
*: Developer  : Yasser Mohammed Aly - (YMA)
*: Date       : 11/03/1997
*: Purpose    : To release the "Options" menu pad.
*:----------------------------------------------------------------
*: Calls      : None.
*:----------------------------------------------------------------
*: Parameters : None.
*:----------------------------------------------------------------
*: Returns    : None.
*:----------------------------------------------------------------
*: Example    : = lfDeActPad()
*:----------------------------------------------------------------
FUNCTION lfDeActPad

RELEASE PAD _OPTIONS OF _MSYSMENU 
RELEASE POPUP _OPTIONPOP
RELEASE POPUP _CTTRANS

RELEASE BAR 100 OF P01PU01
RELEASE BAR 101 OF P01PU01
RELEASE BAR 102 OF P01PU01
RELEASE BAR 103 OF P01PU01

*:----------------------------------------------------------------
*: Name       : lpvCTZoom
*: Developer  : Yasser Mohammed Aly - (YMA)
*: Date       : 11/03/1997
*: Purpose    : Zoom/Unzoom the line browse, and call the cost sheet
*:              program.
*:----------------------------------------------------------------
*: Calls      : None.
*:----------------------------------------------------------------
*: Parameters : None.
*:----------------------------------------------------------------
*: Returns    : None.
*:----------------------------------------------------------------
*: Example    : = lpvCTZoom()
*:----------------------------------------------------------------
FUNCTION lpvCTZoom

*-- Get the bar number clicked in the popup.
lnBarNo = BAR()
DO CASE
  *-- Zoom
  CASE lnBarNo = 2
    *-- Reset the zoom flag.
    llCTZoom = !llCTZoom
    IF llCTZoom
      *-- If we are zooming, then hide the edit regon objects, and 
      *-- reelase the "Options" browse window if exist and re-browse
      *-- the lines in the zoom window.
      ACTIVATE WINDOW gwcContrl1
      SHOW GETS WINDOW (lcCTChWn42) DISABLE ONLY
      HIDE WINDOW (lcCTChWn42) SAME
      RELEASE BAR 103 OF P01PU01
      IF !EMPTY(lcOptBrwTl) AND WEXIST(lcOptBrwTl)
        RELEASE WINDOW (lcOptBrwTl)
        = lfRefresh(lcCTChWin4)
      ENDIF
    ELSE
      *-- If we are unzooming then activate the "Option" window.
      = lpvCTTran(ATC(lcActTrnBr,"BRO-T"))
    ENDIF
    *-- Update the zoom bar "Set Skip" flag.
    SET MARK OF BAR 2 OF _OPTIONPOP TO llCTZoom
    
    *-- Refresh the lines browse, and save the zoom flag value in the
    *-- uncomplete session file.
    = lfLnBrowse() AND lfwLnBrow() AND lfUpdVars()
    
  *-- Call the Cutting Ticket Cost Sheet program.
  CASE lnBarNo = 4
    = lfvCostSh()

  *-- Call the Generate Lines program.
  CASE lnBarNo = 5
    = lfvCTGnLns()

 *E301289,1 WAB - Call function to disp profitability screen
 *E301289,1 WAB - START
 CASE lnBarNo = 6
   =lfvProfit()    
 *E301289,1 WAB - END

ENDCASE

*:----------------------------------------------------------------
*: Name       : lpvCTTran
*: Developer  : Yasser Mohammed Aly - (YMA)
*: Date       : 11/03/1997
*: Purpose    : Perfprm the "Options" selection.
*:----------------------------------------------------------------
*: Calls      : None.
*:----------------------------------------------------------------
*: Parameters : lnActBar : The bar number selected.
*:----------------------------------------------------------------
*: Returns    : None.
*:----------------------------------------------------------------
*: Example    : = lpvCTTran()
*:----------------------------------------------------------------
FUNCTION lpvCTTran
PARAMETERS lnActBar

*-- If the parameter is not passed, means that the function is
*-- called from the menu (No activation of any bar is forced).
lnActBar = IIF(TYPE("lnActBar")#"N", BAR(), lnActBar)
DO CASE
  *-- If the bar is either "Budget (Browse edit regon)" or 
  *-- "Transaction Totals".
  *-- These bars are grouped because they are'nt browses, and they will
  *-- have the same action...
  CASE lnActBar = 1 OR lnActBar = 5
    SET MARK OF BAR 1 OF _CTTRANS TO (lnActBar = 1)
    SET MARK OF BAR 2 OF _CTTRANS TO .F.
    SET MARK OF BAR 3 OF _CTTRANS TO .F.
    SET MARK OF BAR 5 OF _CTTRANS TO (lnActBar = 5)
    lcActTrnBr = IIF(lnActBar = 1, "B", "T") 
    lcWinToShw = IIF(lnActBar = 1, lcCTChWn42, lcCTChWn45)
    lcWinToHid = IIF(lnActBar = 1, lcCTChWn45, lcCTChWn42)
    IF !EMPTY(lcOptBrwTl) AND WEXIST(lcOptBrwTl)
      RELEASE WINDOW (lcOptBrwTl)
      = lfRefresh(lcCTChWin4)
    ENDIF
    SHOW GETS WINDOW (lcWinToHid) DISABLE ONLY
    HIDE WINDOW (lcWinToHid) SAME
    SHOW WINDOW (lcWinToShw) SAME
    RELEASE BAR 103 OF P01PU01
  
  *-- If the bar is either "Receiving Browse" or 
  *-- "Allocated Orders Browse".
  *-- These bars are grouped because they are browses, and they will
  *-- have the same action...
  CASE lnActBar = 2 OR lnActBar = 3
    SET MARK OF BAR 1 OF _CTTRANS TO .F.
    SET MARK OF BAR 2 OF _CTTRANS TO (lnActBar = 2)
    SET MARK OF BAR 3 OF _CTTRANS TO (lnActBar = 3)
    SET MARK OF BAR 5 OF _CTTRANS TO .F.
    lcActTrnBr = IIF(lnActBar = 2, "R", "O") 
    ACTIVATE WINDOW gwcContrl1
    SHOW GETS WINDOW (lcCTChWn42) DISABLE ONLY
    SHOW GETS WINDOW (lcCTChWn45) DISABLE ONLY
    HIDE WINDOW (lcCTChWn42) SAME
    HIDE WINDOW (lcCTChWn45) SAME
    = lfOptBrows()
    DEFINE BAR 103 OF P01PU01 PROMPT lcOptBrwTl KEY ALT+J SKIP FOR (lnActFolder#2)
    ON SELECTION BAR 103 OF P01PU01 ACTIVATE WINDOW (lcOptBrwTl)
ENDCASE

*-- If the selected bar is the "Transaction Totals" bar then open the
*-- "CutTktL" again with a different alias name to be used to acumulate
*-- the totals, otherwise close this file if it's opened.
IF lcActTrnBr = "T"

  *E301077,56 YM 03/03/99 Start - Use gfOpenFile instead.
  = gfOpenFile(gcDataDir+"CutTktL","","SH", @lcCutLnTot, .T.)
  *IF !USED("CutLnTot")
  *  USE (gcDataDir+"CutTktL") IN 0 AGAIN ALIAS CutLnTot
  *ENDIF
  *E301077,56 YM 03/03/99 End.
  
ELSE
  *E301077,56 YMA 03/03/99 Start - Use the gfCloseFile instead.
  = IIF(USED(lcCutLnTot), gfCloseFile(lcCutLnTot), .F.)
  *USE IN IIF(USED("CutLnTot"), SELECT("CutLnTot"), 0)
  *E301077,56 YMA 03/03/99 End.
ENDIF

*-- Switching the "Options" bars means that the active folder is the 
*-- "Details" folder which mean that the trapping invisable button
*-- should be enable.
SHOW GET ibTrap04 ENABLE 
llNoThing = lfwLnBrow() AND lfUpdVars()

*:----------------------------------------------------------------
*: Name       : lfvCutTkt
*: Developer  : Yasser Mohammed Aly - (YMA)
*: Date       : 11/03/1997
*: Purpose    : Cutting Ticket object valid function.
*:----------------------------------------------------------------
*: Calls      : None.
*:----------------------------------------------------------------
*: Parameters : None.
*:----------------------------------------------------------------
*: Returns    : None.
*:----------------------------------------------------------------
*: Example    : = lfvCutTkt()
*:----------------------------------------------------------------
FUNCTION lfvCutTkt
PRIVATE lnAlias, lcBrFields, lcBrowTitle

lnAlias = SELECT(0)

SELECT CutTktH
IF llBrowse OR (!EMPTY(laData[1]) AND !SEEK(laData[1],"CutTktH"))
  llBrowse  = .F.
  xCutTkt   = laData[1]
  xStyle    = laData[2]
  llNoThing = CutBrow(xCutTkt,xStyle)
  IF EMPTY(xCutTkt)
    laData[1] = SPACE(1)
    _CUROBJ = _CUROBJ
    RETURN
  ELSE
    laData[1] = xCutTkt
  ENDIF
ENDIF
lcCutTkt  = laData[1]
llNoThing = IIF(EMPTY(laData[1]), .T., gfSeekRec())

SELECT(lnAlias)

*:----------------------------------------------------------------
*: Name       : lfvMajor
*: Developer  : Yasser Mohammed Aly - (YMA)
*: Date       : 11/03/1997
*: Purpose    : Major (Style) object valid function.
*:----------------------------------------------------------------
*: Calls      : None.
*:----------------------------------------------------------------
*: Parameters : None.
*:----------------------------------------------------------------
*: Returns    : None.
*:----------------------------------------------------------------
*: Example    : = lfvMajor()
*:----------------------------------------------------------------
FUNCTION lfvMajor
PRIVATE lnAlias

*B802183,1 05/20/99 YMA Fixed the bug Alias not found.
IF MDOWN()
  RETURN
ENDIF
*B802183,1 05/20/99 YMA End.
*B803046,1 Adding this variable every time user select a style [Begin]
llGenLines = .T.
*B803046,1 Adding this variable every time user select a style [End]

lnAlias = SELECT(0)
laData[2] = PADR(ALLTRIM(laData[2]),lnStyleWid)
lcOMajor  = PADR(ALLTRIM(lcOMajor ),lnStyleWid)

*-- Be sure to get a valid Major..
IF llBrowse OR (!EMPTY(laData[2]) AND !(lcOMajor == laData[2]))
  IF llBrowse OR !SEEK(laData[2],"Style")
    llBrowse  = .F.
    laData[2] = gfStyBrw('M',"","",.F.)
    IF EMPTY(laData[2])
      laData[2] = lcOMajor
      _CUROBJ   = _CUROBJ
    ENDIF
  ENDIF
ENDIF

lcStyMaj = laData[2]
IF EMPTY(lcStyMaj) OR (!EMPTY(lcStyMaj) AND !SEEK(lcStyMaj,"Style"))
  *-- If the major is not selected then do not do anything..
  lcStyDesc = SPACE(0)
ELSE
  *-- If this is an inventory style, then proceed, otherwise
  *-- display a terminating message.
  IF Style.lInvSty
    *-- If the major is selected then do the following...
    lcStyDesc = Style.Desc1
    llNoThing = lfBldDiv(.T.)
    
    IF laScrMode[4]
      *-- If we are in the "Add" mode then initialize the 
      *-- variables that need defaulf valuse from the Major object
      *-- and then switch the screen mode to be standard "Add" mode.
      laData[03] = "H"
      laData[05] = gdSysDate
      laData[06] = LDOM(gdSysDate+60) -1
      laData[07] = Style.Pattern
      llNoThing  = lfSetStat(laData[3])
      llNoThing  = gfwCodePop(@laCodeInfo, "SEASON", "V,"+Style.Season)
      *B801910,1 YMA 03/07/99 Save the season code in the CT header file.
      laData[09] = laSeason[lnSeason,2]
      *B801910,1 YMA 03/07/99 End.
      SHOW GETS
    ELSE
      *-- If we are in the select mode, then force the activation of the
      *-- cutting ticket object and force it's validation to browse
      *-- only the cutting tickets generated for the selected major.
      _CUROBJ = OBJNUM(laData[1])
      llBrowse = .T.
      KEYBOARD "{ENTER}" PLAIN
    ENDIF  
  ELSE
    *-- The selected style is a non-inventory style. cannot proceed.
    *-- < Ok >
    = gfModalGen('TRM38140B00000')
    laData[2] = lcOMajor
    _CUROBJ   = _CUROBJ
  ENDIF
ENDIF

*C102581,1 AMH Add trigger for Robyn Merdith to get the defaulte value 
*C102581,1     of nsel_price field [Start]
IF ASCAN(laEvntTrig , PADR('GETDEFA',10)) <> 0
  =gfDoTriger('MFCUTKT',PADR('GETDEFA',10))
ENDIF     
*C102581,1 AMH [End]

llNoThing = lfRefresh(lcCTChWin2)
SELECT(lnAlias)

*:----------------------------------------------------------------
*: Name       : lfvHedrWar
*: Developer  : Yasser Mohammed Aly - (YMA)
*: Date       : 11/03/1997
*: Purpose    : Header warehouse valid function.
*:----------------------------------------------------------------
*: Calls      : None.
*:----------------------------------------------------------------
*: Parameters : None.
*:----------------------------------------------------------------
*: Returns    : None.
*:----------------------------------------------------------------
*: Example    : = lfvHedrWar()
*:----------------------------------------------------------------
FUNCTION lfvHedrWar
PRIVATE lnAlias, lnDetRcNo

*E301077,56 YM 03/03/99 Start - Open the STYDYE file.
= gfOpenFile(gcDataDir+"STYDYE","STYDYE","SH")
*E301077,56 YM 03/03/99 End.

*-- Be sure to get a valid warehouse copde..
IF llBrowse OR ;
   (!EMPTY(lcHedrWare) AND !(lcOHdrWare == lcHedrWare) AND ;
    !SEEK(lcHedrWare, "WareHous"))
  llBrowse = .F.
  SELECT WareHous

  *B606205,1 KHM 07/03/2002 (Begin) Changing the passed parameters in order to display the
  *B606205,1                style finished goods locations only.
  *lcHedrWare = gfBrowWare(.T.)
  lcHedrWare = gfbrowware(.T.,.F.,.F.,.F.,.F.,'S')
  *B606205,1 KHM 07/03/2002 (End)

  IF EMPTY(lcHedrWare)
    lcHedrWare = lcOHdrWare
    _CUROBJ    = OBJNUM(lcOHdrWare)
  ENDIF
ENDIF  

IF !EMPTY(lcHedrWare) AND !(lcOHdrWare == lcHedrWare)
  *-- If the warehouse code is not empty and it's changed then check
  *-- if we have any receivings against this CT and prevent this 
  *-- modification if found any receivings.
  lnReceved = laData[13] + laData[14] + laData[15]
  IF !laData[11] AND lnReceved > 0
    lnNoThing  = gfModalGen("TRM38042B00000")
    lcHedrWare = lcOHdrWare
  ELSE
    *-- If the cutting ticket is a single warehouse cutting tisket..
    IF !laData[11]
      lnAlias = SELECT(0)
      SELECT (lcTmpCutLn)

      DIMENSION laToAss[1]
      laToAss   = SPACE(0)
      lnChoice  = 0

      *-- Check that all the non-majors in the cutting ticket lines
      *-- are assigned to the sellected warehouse, and display the
      *-- assigning message for each un-assigned non-major..
      SCAN FOR !SEEK(Style+lcHedrWare+SPACE(10), "STYDYE") ;
         WHILE lnChoice <= 2
        *-- < Assign > < Ignore > < Assign All > < Change Warehouse >
        lcStr     = ALLTRIM(lcMjrTtl) + lcSegSep + ;
                    ALLTRIM(lcMinTtl) + " : "    + ;
                    ALLTRIM(Style)    + "|"      + ;
                    ALLTRIM(lcHedrWare)
        lnChoice = gfModalGen("QRM38044B38005","DIALOG",lcStr)
        DO CASE
          *-- Assign only this non-major..
          CASE lnChoice = 1
            *-- Add the non-major to the assigning array.
            lnWlmNo = 1
            IF !EMPTY(laToAss[lnWlmNo])
              lnWlmNo = ALEN(laToAss) + 1
              DIMENSION laToAss[lnWlmNo]
            ENDIF  
            laToAss[lnWlmNo] = Style+lcHedrWare+SPACE(10)
            
          *-- Ignore this non-major..
          CASE lnChoice = 2
            *-- if the line has any quantity then refuse to do so..
            IF TotQty > 0
              *-- Cutting ticket line has quantity, Cannot ignore this line.
              *-- < Ok >
              = gfModalGen("TRM38096B00000")
              lnChoice = 4
            ENDIF
        ENDCASE
      ENDSCAN
      
      DO CASE
        *-- All the non-majors are assigned
        *-- We only need to change the warehouse in the temp file.
        CASE lnChoice = 0     
            REPLACE ALL FOR !(cWareCode == lcHedrWare)           ;
                    cWareCode WITH lcHedrWare                   ,;
                    cStatus   WITH IIF(cStatus = "A", "A", "M")
          
        *-- Assign all
        CASE lnChoice = 3
          SCAN
            IF !SEEK(Style+lcHedrWare+SPACE(10),"STYDYE")
              DO gpAdStyWar WITH STYLE,SPACE(10),lcHedrWare
            ENDIF  
            REPLACE cWareCode WITH lcHedrWare               ,;
                    cStatus   WITH IIF(cStatus = "A", "A", "M")
          ENDSCAN  

        *-- Reenter the warehouse.
        CASE lnChoice = 4
          lcHedrWare = lcOHdrWare
          _CUROBJ = _CUROBJ
        
        *-- Assign some of the records.
        OTHERWISE
          SCAN
            *-- If the user need to assign the non-major then do it,
            *-- other wise delete this line..
            IF !SEEK(Style+lcHedrWare+SPACE(10),"STYDYE") AND ;
               ASCAN(laToAss, Style+lcHedrWare+SPACE(10)) > 0
              DO gpAdStyWar WITH Style,SPACE(10),lcHedrWare
              REPLACE cWareCode WITH lcHedrWare ,;
                      cStatus   WITH IIF(cStatus = "A", "A", "M")
            ELSE
              REPLACE cWareCode WITH SPACE(0)   ,;
                      cStatus   WITH IIF(cStatus = "A", "S", "D")
              DELETE
            ENDIF  
          ENDSCAN
      ENDCASE
      
      *B603317,1 [
      *GOTO TOP
      LOCATE
      *B603317,1 [

      llNoThing = RLOCK()
      UNLOCK
      llNoThing = lfwLnBrow()
      SELECT(lnAlias)
    ENDIF
  ENDIF  
ELSE
  *-- If the user empty the header warehouse and the cutting ticket
  *-- is a single warehouse cutting ticket then refuse to do so..
  IF EMPTY(lcHedrWare) AND !laData[11] AND !EMPTY(lcOHdrWare)
    *-- Header warehouse cannot be left empty in a single warehouse 
    *-- cutting ticket.
    *-- < Ok >
    = gfModalGen("TRM38097B00000")
    lcHedrWare = lcOHdrWare
    _CUROBJ = _CUROBJ
  ENDIF
ENDIF  

*-- Refresh the warehouse object and save it's value in the uncomplete
*-- session file.
SHOW GET lcHedrWare
llNoThing = lfUpdVars()
llNoThing = lfRefresh(lcCTChWin2)

*:----------------------------------------------------------------
*: Name       : lfGtWareNm
*: Developer  : Yasser Mohammed Aly - (YMA)
*: Date       : 11/03/1997
*: Purpose    : To refresh the warehouse neame for the header 
*:              warehouse and the line warehouse if any.
*:----------------------------------------------------------------
*: Calls      : None.
*:----------------------------------------------------------------
*: Parameters : lcWareCP : The warehouse code.
*:----------------------------------------------------------------
*: Returns    : The warehouse name.
*:----------------------------------------------------------------
*: Example    : = lfGtWareNm()
*:----------------------------------------------------------------
FUNCTION lfGtWareNm
PARAMETERS lcWareCP
PRIVATE lnAlias, lcRetVal

IF EMPTY(lcWareCP)
  lcRetVal = SPACE(0)
ELSE
  lnAlias = SELECT(0)
  SELECT WareHous
  lcRetVal = IIF(SEEK(lcWareCP),cDesc,"")
  SELECT (lnAlias)
ENDIF

RETURN (lcRetVal)

*:----------------------------------------------------------------
*: Name       : lfSetStat
*: Developer  : Yasser Mohammed Aly - (YMA)
*: Date       : 11/03/1997
*: Purpose    : To convert the status character to words that will
*:              be displayed in the screen.
*:----------------------------------------------------------------
*: Calls      : None.
*:----------------------------------------------------------------
*: Parameters : lcStat : The status code.
*:----------------------------------------------------------------
*: Returns    : The "lcCTStatus" variable is updated.
*:----------------------------------------------------------------
*: Example    : = lfSetStat()
*:----------------------------------------------------------------
FUNCTION lfSetStat
PARAMETERS lcStat

lcStat = IIF(TYPE("lcStat")#"C","",lcStat)
IF !EMPTY(lcStat)
  lcAll  = PADR("Open",10)+PADR("Hold",10)+PADR("Complete",10)+;
           PADR("Canceled",10)+PADR("Actualized",10)+PADR("Closed",10)
  lcCTStatus = ALLTRIM(SUBSTR(lcAll,ATC(lcStat,"OHCXAS")*10-9,10))
ELSE
  lcCTStatus = SPACE(0)
ENDIF  
llNoThing = IIF(WEXIST(gcBaseWind), lfRefresh(lcCTChWin2), .T.) 

*:----------------------------------------------------------------
*: Name       : lfGtSclInf
*: Developer  : Yasser Mohammed Aly - (YMA)
*: Date       : 11/03/1997
*: Purpose    : Get the scale inforamtion for the current active 
*:              cutting ticket line.
*:----------------------------------------------------------------
*: Calls      : None.
*:----------------------------------------------------------------
*: Parameters : None.
*:----------------------------------------------------------------
*: Returns    : The scale memory variables are updated.
*:----------------------------------------------------------------
*: Example    : = lfGtSclInf()
*:----------------------------------------------------------------
FUNCTION lfGtSclInf
PRIVATE lnAlias

lnAlias = SELECT(0)

*E301077,56 YMA 03/03/99 Start - Open the scale file.
= gfOpenFile(gcDataDir+"Scale","Scale","SH")
*E301077,56 YMA 03/03/99 End.

*-- Get the scale code.
IF laScrMode[1] OR laScrMode[2]
  lcStyle = PADR(ALLTRIM(laData[2]),lnStyleWid) + lcSegSep + ;
            PADR(ALLTRIM(lcNonMaj),lnMinWid)
  lcScale = IIF(SEEK(lcStyle, "Style"), Style.Scale, SPACE(3))
ELSE
  lcScale = &lcTmpCutLn..Scale
ENDIF

*-- Get the scale information.
SELECT Scale
IF SEEK("S"+lcScale)
  SCATTER FIELDS &lcScalFlsd MEMVAR
ELSE
  SCATTER FIELDS &lcScalFlsd MEMVAR BLANK
ENDIF  

*-- Refresh the screen if it's exist.
llNoThing = IIF(WEXIST(gcBaseWind), lfRefresh(lcCTChWn42), .T.) 
SELECT(lnAlias)

*:----------------------------------------------------------------
*: Name       : lfvMulWH
*: Developer  : Yasser Mohammed Aly - (YMA)
*: Date       : 11/03/1997
*: Purpose    : Cutting ticket multi warehouse valid function.
*:----------------------------------------------------------------
*: Calls      : None.
*:----------------------------------------------------------------
*: Parameters : None.
*:----------------------------------------------------------------
*: Returns    : None
*:----------------------------------------------------------------
*: Example    : = lfvMulWH()
*:----------------------------------------------------------------
FUNCTION lfvMulWH
PRIVATE lnAlias

lnAlias = SELECT(0)
IF llOMulWH # laData[11]
  *-- If there is any receivings against this cutting ticket then
  *-- refuse to change the status of the cutting ticket multi warehouse.
  IF laScrMode[3] AND (CutTktH.Pcs_Rec+CutTktH.PCs_Dam+CutTktH.Pcs_Can)>0
    *-- Cutting ticket has been received.  
    *-- You cannot change the warehouse type.
    *-- < Ok >
    = gfModalGen("TRM38041B00000")
    laData[11] = llOMulWH
  ELSE
    SELECT (lcTmpCutLn)
    
    *B603317,1 [
    *GOTO TOP
    LOCATE
    *B603317,1 [

    *-- Be sure that there is a warehouse code in the cutting
    *-- ticket header.
    IF !laData[11] AND EMPTY(lcHedrWare) AND !(EOF() OR BOF())
      *-- Cannot change a multi warehouse cutting ticket to a 
      *-- single warehouse cutting ticket without entering the 
      *-- header warehouse.
      = gfModalGen("TRM38098B00000")
      laData[11] = .T.
      _CUROBJ = OBJNUM(lcHedrWare)
    ELSE
      IF laData[12] > 0
        *-- Changing the current "Single/Mulit" warehouse cutting ticket 
        *-- to be "Mulit/Single" warehouse cutting ticket. 
        *-- Do you wish to assign the cutting ticket lines to the 
        *-- "Styles/Cutting Ticket" default warehouse.
        *-- < Yes >    < No >     ===> 1, 2
        *-- OR
        *-- < Assign > < Cancel > ===> 3, 4
        IF laData[11]
          lcStr    = "single|multiple|styles"
          lnChoice = gfModalGen("QRM38040B00006","DIALOG",lcStr) + 0
        ELSE
          lcStr    = "multiple|single|cutting ticket header"
          lnChoice = gfModalGen("QRM38040B38003","DIALOG",lcStr) + 2
        ENDIF
      ELSE
        lnChoice = IIF(laData[11], 1, 3)
      ENDIF  
      
      SELECT (lcTmpCutLn)
      lnDetRcNo = RECNO()
      DO CASE
        *-- Assign the CT lines to the styles default warehouse..
        *-- OR
        *-- Assign the CT lines to the Cutting ticket header warehouse..
        CASE lnChoice = 1 OR lnChoice = 3
          *-- In order to change the multi to single warehouse CT
          *-- or visa virce we need to be sure that the CT lines
          *-- key (Style+Warehouse+Dyelot) does not get repeated
          *-- so we will change the warehouse which is part of the
          *-- key and then accumulate the result lines to generate
          *-- new lines with no repetation on the key.
          
          *-- Create the temporary file used.
          lcTmpFile = gfTempName()
          COPY STRUCTURE TO (gcDataDir + lcTmpFile) WITH CDX
          USE (gcDataDir + lcTmpFile) IN 0 ORDER (lcTmpCutLn)

          *khalid
          = gfOpenFile(gcDataDir+"STYDYE","STYDYE","SH")
          *khalid
          
          *-- Scan the master temporary file.
          SELECT (lcTmpCutLn)
          SET ORDER TO 0
          lcWareCode = IIF(lnChoice = 1, "cDefWare", "lcHedrWare")
          SCAN
            *-- Assign the line style to the new warehouse
            *-- if it's not assigned.
            IF !SEEK(STYLE+&lcWareCode+SPACE(10),"STYDYE")
              DO gpAdStyWar WITH STYLE,SPACE(10),&lcWareCode
            ENDIF  
            *-- Update the warehouse field.
            REPLACE cWareCode WITH &lcWareCode ,;
                    cStatus   WITH IIF(cStatus = "A", "A", "M")
            SCATTER TO laSource
            
            *-- Append or accumulate the new line to the
            *-- temporary file generated.
            llDyeYes = llDyelot AND (DyeYN = "Y")
            IF (llDyeYes AND !EMPTY(Dyelot)) OR !llDyeYes
              IF !SEEK(Style+cWareCode+Dyelot, lcTmpFile)
                SELECT (lcTmpFile)
                APPEND BLANK
              ENDIF
            ELSE
              SELECT (lcTmpFile)
              APPEND BLANK
            ENDIF
            
            *-- Update the qtys.
            SELECT (lcTmpFile)
            SCATTER TO laTarget FIELDS LIKE Qty*
            GATHER FROM laSource
            REPLACE Qty1    WITH Qty1 + laTarget[1] ,;
                    Qty2    WITH Qty2 + laTarget[2] ,;
                    Qty3    WITH Qty3 + laTarget[3] ,;
                    Qty4    WITH Qty4 + laTarget[4] ,;
                    Qty5    WITH Qty5 + laTarget[5] ,;
                    Qty6    WITH Qty6 + laTarget[6] ,;
                    Qty7    WITH Qty7 + laTarget[7] ,;
                    Qty8    WITH Qty8 + laTarget[8] ,;
                    TotQty  WITH Qty1+Qty2+Qty3+Qty4+Qty5+Qty6+Qty7+Qty8
          ENDSCAN
          USE IN (lcTmpFile)
          
          *-- Delete the records from the master temp file.
          SELECT (lcTmpCutLn)
          BLANK ALL
          DELETE ALL
          
          *-- Add the accumulated lines from the generated temp 
          *-- file to the master temp file.
          APPEND FROM (gcDataDir + lcTmpFile)
          ERASE (gcDataDir + lcTmpFile + ".DBF")
          ERASE (gcDataDir + lcTmpFile + ".CDX")
          SET ORDER TO (lcTmpCutLn)

        *-- Do not change the status of the cutting ticket multi warehouse.
        CASE lnChoice = 4
         laData[11] = llOMulWH
          _CUROBJ    = _CUROBJ
      ENDCASE
  
      *B603317,1 [
      *GOTO TOP
      LOCATE
      *B603317,1 [
 
      llNoThing = RLOCK()
      UNLOCK
      llNoThing = lfwLnBrow()
    ENDIF
  ENDIF  
  SHOW GET laData[11]
  llNoThing = lfUpdVars()
ENDIF
SELECT(lnAlias)

*:----------------------------------------------------------------
*: Name       : lfvEntered
*: Developer  : Yasser Mohammed Aly - (YMA)
*: Date       : 11/03/1997
*: Purpose    : Cutting ticket Entered date valid function.
*:----------------------------------------------------------------
*: Calls      : None.
*:----------------------------------------------------------------
*: Parameters : None.
*:----------------------------------------------------------------
*: Returns    : None
*:----------------------------------------------------------------
*: Example    : = lfvEntered()
*:----------------------------------------------------------------
FUNCTION lfvEntered

IF EMPTY(laData[5])
  laData[5] = ldOEntered
  _CUROBJ   = _CUROBJ
ENDIF

*-- Update the new value in the uncomltet session file.
llNoThing = lfUpdVars()

*:----------------------------------------------------------------
*: Name       : lfvComplet
*: Developer  : Yasser Mohammed Aly - (YMA)
*: Date       : 11/03/1997
*: Purpose    : Cutting ticket Complete date valid function.
*:----------------------------------------------------------------
*: Calls      : None.
*:----------------------------------------------------------------
*: Parameters : None.
*:----------------------------------------------------------------
*: Returns    : None
*:----------------------------------------------------------------
*: Example    : = lfvComplet()
*:----------------------------------------------------------------
FUNCTION lfvComplet

IF EMPTY(laData[6])
  laData[6] = ldOComplet
  _CUROBJ   = _CUROBJ
ELSE
  IF laScrMode[3] AND CutTktH.Complete # laData[6]
    *-- Would you like the system to store 99\99\99 as the 
    *-- initial comp. date ?
    *-- < Yes > < No >
    lcDate = DTOC(CutTktH.Complete)
    IF gfModalGen("QRM38099B38006","DIALOG",lcDate) = 1
      laData[34] = CutTktH.Complete
      llNoThing  = lfRefresh(lcCTChWn31)
    ENDIF
  ENDIF
ENDIF

*B604630,1 AMH Add customized trigger for Cathy Daniels to Validate [Start]
*B604630,1 AMH the complition date.
IF ASCAN(laEvntTrig , PADR('VCOMPACK',10)) <> 0
  =gfDoTriger('MFCUTKT',PADR('VCOMPACK',10))
ENDIF
*B604630,1 AMH [End]

*-- Update the new value in the uncomltet session file.
llNoThing = lfUpdVars()

*:----------------------------------------------------------------
*: Name       : lfvNew
*: Developer  : Yasser Mohammed Aly - (YMA)
*: Date       : 11/03/1997
*: Purpose    : Add new line valid function.
*:----------------------------------------------------------------
*: Calls      : None.
*:----------------------------------------------------------------
*: Parameters : None.
*:----------------------------------------------------------------
*: Returns    : None
*:----------------------------------------------------------------
*: Example    : = lfvNew()
*:----------------------------------------------------------------
FUNCTION lfvNew
PRIVATE lnAlias

lnAlias = SELECT(0)

SELECT (lcTmpCutLn)

llAppend   = .T.
llMdWarRec = .F.
llMdDyeRec = .F.

*-- If the system is setup not to use non-majors then we have to 
*-- be sure that the user will not create new lines when the system
*-- is also not using warehouses and dyelots.
IF llNoNonMaj
  lcStyle    = PADR(ALLTRIM(laData[2]),lnStyleWid)
  llNoThing  = SEEK(lcStyle, "Style")
  llMdWarRec = llMultiWar AND laData[11]
  llMdDyeRec = llDyelot   AND (Style.cDye_Flg = "Y")

  *B603317,1 [
  *GOTO TOP
  LOCATE
  *B603317,1 [

  IF !(EOF() OR BOF()) AND !llMdWarRec AND !llMdDyeRec
    *-- No available nonmajor to be added.
    *-- < Ok >
    llAppend = gfModalGen('TRM38100B00000') = 2
  ENDIF  
ENDIF  

IF llAppend
  *-- Be sure that the user does not add more that one empty new line.
  IF !SEEK(SPACE(19))
    APPEND BLANK
  ENDIF
  llNoThing = RLOCK()
  REPLACE CutTkt  WITH laData[1] ,;
          cStatus WITH "A"       ,;
          TranCd  WITH "1"
  UNLOCK
  IF llNoNonMaj
    llNoThing = lfvNonMaj()
    lnObjNum  = IIF(llMdWarRec, OBJNUM(m.cWareCode),;
                IIF(llMdDyeRec, OBJNUM(m.Dyelot   ), OBJNUM(m.cPrePack)))
  ELSE  
    llNoThing = lfwLnBrow()
    lnObjNum  = OBJNUM(lcNonMaj)
  ENDIF  

  *E301289,1 WAB - DISABLE SELLING  PRICE Butt. if There  are no  ctlines
  *E301289,1 WAB - START
  SHOW GET pbGp DISABLE
  *E301289,1 WAB - END
  _CUROBJ   = lnObjNum
ELSE

  *B603317,1 [
  *GOTO TOP
  LOCATE
  *B603317,1 [

  llNoThing = lfwLnBrow()
ENDIF

SELECT(lnAlias)

*:----------------------------------------------------------------
*: Name       : lfvRem
*: Developer  : Yasser Mohammed Aly - (YMA)
*: Date       : 11/03/1997
*: Purpose    : Remove line valid function.
*:----------------------------------------------------------------
*: Calls      : None.
*:----------------------------------------------------------------
*: Parameters : None.
*:----------------------------------------------------------------
*: Returns    : None
*:----------------------------------------------------------------
*: Example    : = lfvRem()
*:----------------------------------------------------------------
FUNCTION lfvRem
PRIVATE lnAlias

lnAlias = SELECT(0)
SELECT (lcTmpCutLn)

IF laScrMode[3] AND lfChkPrc()
  *-- There has been activity against this line. Not allowed to delete
  *-- < Ok > 
  = gfModalGen('TRM38101B00000')
ELSE
  *-- Are you sure you want to delete this line ?
  *-- < Yes > < No > 
  IF gfModalGen('QRM38102B38006') = 1
    *-- Remove the allocation if exist.
    llDelete = .T.
    IF laScrMode[3] AND SEEK(&lcTmpCutLn..Style, lcTmpCtPk)
      SELECT (lcTmpCtPk)
      *-- Since this line has allocated quantities from order(s),
      *-- deleting it will release the order(s) allocation.
      *-- < View Allocation > < Delete > < Cancel >
      lnChoice = gfModalGen('QRM38103B38015')
      DO CASE
        CASE lnChoice = 1
          llDelete   = .F.
          lcActTrnBr = "O"
          llNoThing  = lpvCTTran(ATC(lcActTrnBr,"BRO-T"))
        
        CASE lnChoice = 2
          llDelete  = .T.
          REPLACE ALL Qty1 WITH 0, Qty2 WITH 0, Qty3   WITH 0 ,;
                      Qty4 WITH 0, Qty5 WITH 0, Qty6   WITH 0 ,;
                      Qty7 WITH 0, Qty8 WITH 0, TotQty WITH 0  ;
                  FOR Style+Order+cOrdLine = &lcTmpCutLn..Style 
        CASE lnChoice = 3
          llDelete = .F.
      ENDCASE
    ENDIF
    
    IF llDelete
      SELECT (lcTmpCutLn)
      llNoThing = lfUpdHEst(TotQty, -1)
      llNewLine = laScrMode[4] OR &lcTmpCutLn..cStatus = "A"
      IF llNewLine
        laData[12] = laData[12] - TotQty
        laData[17] = laData[17] - TotQty
      ELSE
        laData[15] = laData[15] + TotQty
        laData[35] = laData[35] + IIF(laData[3]="A", 0, TotQty)
        laData[17] = laData[17] - TotQty
        *B602381,1 03/08/99 YMA Do not cancel the CT on line.
        *IF laData[17] = 0
        *  laData[03]   = IIF(laData[13]>0, "C", "X")
        *  llNoThing    = lfSetStat(laData[3])
        *  lcPromp      = IIF(laData[3]="X", lcUnCanc, lcCancel) 
        *  lcCanStat    = "DISABLE"
        *  llNoThing    = lfRefresh() AND lfStDelBar()
        *  lcEdtStat    = "DISABLE"
        *  laCtrStat[7] = lcEdtStat
        *  SHOW GET pbEdt &lcEdtStat
        *ENDIF
        *B602381,1 03/08/99 End.        
      ENDIF
      
      REPLACE cStatus WITH IIF(cStatus = "A", "S", "D")
      DELETE

      *B603317,1 [
      *GOTO TOP
      LOCATE
      *B603317,1 [

      llNoThing = RLOCK()
      UNLOCK
      = lfwLnBrow()
    ENDIF  
  ENDIF  
ENDIF

SELECT(lnAlias)

*:----------------------------------------------------------------
*: Name       : lfvNonMaj
*: Developer  : Yasser Mohammed Aly - (YMA)
*: Date       : 11/03/1997
*: Purpose    : Non-Major valid function.
*:----------------------------------------------------------------
*: Calls      : None.
*:----------------------------------------------------------------
*: Parameters : None.
*:----------------------------------------------------------------
*: Returns    : None
*:----------------------------------------------------------------
*: Example    : = lfvNonMaj()
*:----------------------------------------------------------------
FUNCTION lfvNonMaj
PRIVATE lnAlias

lnAlias = SELECT(0)
lcStyle = PADR(ALLTRIM(laData[2]),lnStyleWid) + ;
          IIF(llNoNonMaj, "", lcSegSep + PADR(ALLTRIM(lcNonMaj),lnMinWid))
IF (!(lcONonMaj == lcNonMaj) AND !EMPTY(lcNonMaj) AND LASTKEY() = 13) OR ;
   llNoNonMaj

  *E301077,56 YM 03/03/99 Start - Open the STYDYE file.
  = gfOpenFile(gcDataDir+"STYDYE","STYDYE","SH")
  *E301077,56 YM 03/03/99 End.

  SELECT Style
  IF !SEEK(lcStyle)
    lcNonMaj = gfStyBrw('N',laData[2],lcNonMaj,.F.)
    IF EMPTY(lcNonMaj)
      _CUROBJ  = _CUROBJ
    ENDIF
  ENDIF
  
  IF !llNoNonMaj AND EMPTY(lcNonMaj)
    lcNonMaj  = lcONonMaj
    _CUROBJ  = _CUROBJ
  ELSE
    SELECT Style

    lcStyle    = PADR(ALLTRIM(laData[2]),lnStyleWid) + ;
                 IIF(llNoNonMaj, "",;
                 lcSegSep + PADR(ALLTRIM(lcNonMaj),lnMinWid))
    
    IF Style.cDivision = laData[10]
      lcBomWare  = SPACE(0)
      *MAN
      IF SEEK ("M" + laData[1], "CtktBom")
     *IF laData[3] = "O" AND SEEK ("M" + laData[1], "CtktBom")
        llBom      = .T.
        lcBomWare  = CtktBom.cWareCode
      ELSE
        llBom      = .F.
      ENDIF

      *B602124,1 Commented out. Check cost item dyelots upon saving
      *IF lfChkLnCst(lcStyle) AND ;
        IIF(llBom, gfCkWhsDye("M",laData[1],lcStyle,"",SPACE(10),lcBomWare), .T.) 
      IF lfChkLnCst(lcStyle)

        llNoThing  = SEEK(lcStyle, "Style")
        lcWareCode = IIF(laData[11], Style.cDefWare, lcHedrWare)
      
        SELECT (lcTmpCutLn)
        llNoThing = RLOCK()
        REPLACE Scale     WITH Style.Scale    ,;
                DyeYN     WITH Style.cDye_Flg ,;
                nMCost1   WITH Style.nMCost1  ,;
                nMCost2   WITH Style.nMCost2  ,;
                nMCost3   WITH Style.nMCost3  ,;
                nMCost4   WITH Style.nMCost4  ,;
                nMCost5   WITH Style.nMCost5  ,;
                cDefWare  WITH Style.cDefWare

        *E128404,3  TMI [Start] Update the field "cStyGrade" from the style file
        REPLACE cStyGrade WITH STYLE.cStyGrade
        *E128404,3  TMI [End  ] 
        *B804289,4 AMH get prepack data [Start]
        REPLACE CPREPACK WITH STYLE.PREPAK
        *B804289,4 AMH [End]
        UNLOCK  
        llMdWarRec = llMultiWar AND laData[11]
        llMdDyeRec = llDyelot   AND (DyeYN = "Y")
        DO CASE
          CASE !llMdWarRec AND !llMdDyeRec
            lnTmpRecNo = RECNO()
            IF SEEK(lcStyle)
              GOTO lnTmpRecNo
              BLANK
              DELETE
              = SEEK(lcStyle)
            ELSE
              GOTO lnTmpRecNo
              IF !SEEK(PADR(lcStyle,19)+lcWareCode+SPACE(10), "STYDYE")
                DO gpAdStyWar WITH lcStyle,SPACE(10),lcWareCode
              ENDIF
              llNoThing = RLOCK()
              REPLACE Style     WITH lcStyle   ,;
                      cWareCode WITH lcWareCode
              UNLOCK
            ENDIF
          
          CASE !llMdWarRec
            IF !SEEK(PADR(lcStyle,19)+lcWareCode+SPACE(10), "STYDYE")
              DO gpAdStyWar WITH lcStyle,SPACE(10),lcWareCode
            ENDIF
            llNoThing = RLOCK()
            REPLACE Style     WITH lcStyle   ,;
                    cWareCode WITH lcWareCode
            UNLOCK
          OTHERWISE
            REPLACE Style WITH lcStyle
        ENDCASE
      ELSE
        lcNonMaj  = lcONonMaj
        _CUROBJ  = _CUROBJ
      ENDIF
    ELSE
      *B606290,1 KHM 07/18/2002 (Begin) M38139 is missed. Therefore, we added a new message
      *B606290,1                M38252.
      *lcStr     = ALLTRIM(PROPER(lcMjrTtl)) + lcSegSep + ;
                  ALLTRIM(PROPER(lcMinTtl)) + "|"      + ;
                  ALLTRIM(laDivision[lndivision,1])
      *llNoThing = gfModalGen("TRM38139B00000","DIALOG",lcStr)
      llNoThing = gfModalGen("TRM38252B00000","DIALOG",ALLTRIM(laDivision[lndivision,1]))
      *B606290,1 KHM 07/18/2002 (End)        
      lcNonMaj  = lcONonMaj
      _CUROBJ   = _CUROBJ
    ENDIF  
  ENDIF
  llNoThing  = lfwLnBrow()
ENDIF

*E301289,1 WAB - ENABLE SELLING  PRICE Butt. if Ther are ctlines
*E301289,1 WAB - START
IF !EMPTY(lcNonMaj)
  SHOW GET pbGP ENABLE
ENDIF
*E301289,1 WAB - END
*B804289,4 AMH Set current object to prepack in case of singl warehouse & dyelot no [Start]
IF !llMultiWar .AND. !llDyelot
  _CUROBJ = OBJNUM(m.cPrePack)
ENDIF
*B804289,4 AMH [End]
SELECT(lnAlias)

*:----------------------------------------------------------------
*: Name       : lfChkLnCst
*: Developer  : Yasser Mohammed Aly - (YMA)
*: Date       : 11/03/1997
*: Purpose    : Check that the new added Non-Major has cost sheet. 
*:----------------------------------------------------------------
*: Calls      : None.
*:----------------------------------------------------------------
*: Parameters : None.
*:----------------------------------------------------------------
*: Returns    : None
*:----------------------------------------------------------------
*: Example    : = lfChkLnCst()
*:----------------------------------------------------------------
FUNCTION lfChkLnCst
PARAMETERS lcStyle
PRIVATE lnAlias, llRetVal

lnAlias  = SELECT(0)
llRetVal = .T.
IF laScrMode[3] AND CutTktH.Status # "H"
  *E301077,56 YM 03/03/99 Start - Open the BOM file.
  = gfOpenFile(gcDataDir+"BOM","BOM","SH")
  *E301077,56 YM 03/03/99 End.

  SELECT Bom
  IF SEEK(PADR(ALLTRIM(laData[2]),lnStyleWid))
    *MAN Add PADR to lcStyle
    LOCATE REST WHILE cItmMajor = PADR(ALLTRIM(laData[2]),lnStyleWid) ;
            FOR LIKE(STRTRAN(cItmMask,"*","?"), PADR(lcStyle,19))
    IF !FOUND()
      *-- No cost lines found in the cost sheet, Cannot proceed!
      *-- < Ok >
      llRetVal = gfModalGen('TRM38104B00000') = 2
    ENDIF
  ENDIF
ENDIF

SELECT (lnAlias)
RETURN (llRetVal)

*:----------------------------------------------------------------
*: Name       : lfwLineWar
*: Developer  : Yasser Mohammed Aly - (YMA)
*: Date       : 11/03/1997
*: Purpose    : Save the old line warehouse value.
*:----------------------------------------------------------------
*: Calls      : None.
*:----------------------------------------------------------------
*: Parameters : None.
*:----------------------------------------------------------------
*: Returns    : None
*:----------------------------------------------------------------
*: Example    : = lfwLineWar()
*:----------------------------------------------------------------
FUNCTION lfwLineWar

lcOLinWare = m.cWareCode

*:----------------------------------------------------------------
*: Name       : lfvLineWar
*: Developer  : Yasser Mohammed Aly - (YMA)
*: Date       : 11/03/1997
*: Purpose    : The line warehouse valid function.
*:----------------------------------------------------------------
*: Calls      : None.
*:----------------------------------------------------------------
*: Parameters : None.
*:----------------------------------------------------------------
*: Returns    : None
*:----------------------------------------------------------------
*: Example    : = lfvLineWar()
*:----------------------------------------------------------------
FUNCTION lfvLineWar
PRIVATE lnAlias

lnAlias    = SELECT(0)
IF llBrowse OR (!EMPTY(m.cWareCode) AND !(lcOLinWare == m.cWareCode))
  SELECT WareHous

  *B606205,1 KHM 07/03/2002 (Begin) Changing the passed parameters in order to display the
  *B606205,1                style finished goods locations only.  
  *m.cWareCode = IIF(llBrowse OR !SEEK(m.cWareCode), gfBrowWare(.T.), m.cWareCode)
  m.cWareCode = IIF(llBrowse OR !SEEK(m.cWareCode), gfbrowware(.T.,.F.,.F.,.F.,.F.,'S'), m.cWareCode)
  *B606205,1 KHM 07/03/2002 (End)
  
  IF !EMPTY(m.cWareCode)
    SELECT (lcTmpCutLn) 
    lcStyle    = Style
    lcWareDesc = ALLTRIM(WareHous.cDesc)
    lcStr      = ALLTRIM(lcMjrTtl)  + lcSegSep + ALLTRIM(lcMinTtl) + " : " +;
                 &lcTmpCutLn..Style + "|" + lcWareDesc
    
    llCkInStDy = .T.
    lnTmpRecNo = RECNO()
    
    IF (!(llDyelot AND (DyeYN = "Y"))) OR  ;
       ( (llDyelot AND (DyeYN = "Y"))  AND ;
       (!EMPTY(Dyelot) AND SEEK(lcStyle+m.cWareCode+Dyelot)))
      lcExp = lcStyle+m.cWareCode+IIF(!(llDyelot AND (DyeYN = "Y")),"",Dyelot)
      IF SEEK(lcExp)
        GOTO lnTmpRecNo
        BLANK
        DELETE
        = SEEK(lcExp)
        llCkInStDy = .F.
      ELSE
        GOTO lnTmpRecNo
      ENDIF
    ENDIF
      
    IF llCkInStDy
      llAssign = .T.
      IF !SEEK(lcStyle+m.cWareCode+SPACE(10), "STYDYE")
        llAssign = gfModalGen("QRM38044B38004","DIALOG",lcStr) = 1
      ENDIF        
      IF llAssign
        DO gpAdStyWar WITH STYLE,SPACE(10),m.cWareCode
        llNoThing = RLOCK()
        REPLACE cWareCode WITH m.cWareCode
        UNLOCK
      ENDIF
    ENDIF
    
    llNoThing = lfwLnBrow()
  ENDIF
ENDIF  
SELECT(lnAlias)

*:----------------------------------------------------------------
*: Name       : lfvDyelot
*: Developer  : Yasser Mohammed Aly - (YMA)
*: Date       : 11/03/1997
*: Purpose    : The Dyelot valid function.
*:----------------------------------------------------------------
*: Calls      : None.
*:----------------------------------------------------------------
*: Parameters : None.
*:----------------------------------------------------------------
*: Returns    : None
*:----------------------------------------------------------------
*: Example    : = lfvDyelot()
*:----------------------------------------------------------------
FUNCTION lfvDyelot
PRIVATE lnAlias
lnAlias = SELECT(0)
SELECT (lcTmpCutLn)

IF !EMPTY(m.Dyelot)
  lnRecTmp = RECNO()
  lcExp = Style+cWareCode+m.Dyelot
  IF SEEK(lcExp)
    GOTO lnRecTmp
    BLANK
    DELETE
    = SEEK(lcExp)
  ELSE
    SELECT (lcTmpCutLn)
    GOTO lnRecTmp
    llSaveRec = .T.
    *B602124,1 Commented out. Check cost item dyelots upon saving
    *IF laData[3] = "O" AND SEEK ("M" + laData[1], "CtktBom")
    *  llSaveRec = gfCkWhsDye("M",laData[1],Style,"",m.Dyelot,CtktBom.cWareCode)
    *ENDIF
    *B602124,1 (End)
        
    IF llSaveRec
      llNoThing = RLOCK()
      REPLACE Dyelot WITH m.Dyelot
      UNLOCK
    ELSE
      m.Dyelot = SPACE(10)
      _CUROBJ  = _CUROBJ
    ENDIF
  ENDIF
ENDIF  
llNoThing = lfwLnBrow()

SELECT(lnAlias)

*:----------------------------------------------------------------
*: Name       : lfvPrePack
*: Developer  : Yasser Mohammed Aly - (YMA)
*: Date       : 11/03/1997
*: Purpose    : The prepack code valid function.
*:----------------------------------------------------------------
*: Calls      : None.
*:----------------------------------------------------------------
*: Parameters : None.
*:----------------------------------------------------------------
*: Returns    : None
*:----------------------------------------------------------------
*: Example    : = lfvPrePack()
*:----------------------------------------------------------------
FUNCTION lfvPrePack
PRIVATE lnAlias, lcBrFields, lcBrowTitle

lnAlias = SELECT(0)

*E301077,56 YMA 03/03/99 Start - Open the scale file.
= gfOpenFile(gcDataDir+"Scale","Scale","SH")
*E301077,56 YMA 03/03/99 End.

SELECT Scale
*B804289,4 AMH Use lcFile insted of lcTmpCutLn [Start]
*lcScale    = &lcTmpCutLn..Scale
lcScale    = IIF(TYPE('lcFile')<>'U' .AND. lcFile<>lcTmpCutLn,Style.Scale,&lcTmpCutLn..Scale)
*B804289,4 AMH [End]
lcPrePack  = m.cPrePack

llNoThing  = gfPrePBrow(lcScale, @lcPrePack)
m.cPrePack = lcPrePack
m.nPrePack = IIF(EMPTY(m.cPrePack), 0, m.nPrePack)
SHOW GET m.nPrePack
lcBlank    = IIF(EMPTY(m.cPrePack), "BLANK", "")
SCATTER TO laPrePack FIELDS Pp1,Pp2,Pp3,Pp4,Pp5,Pp6,Pp7,Pp8,PPTot &lcBlank
SELECT (lcTmpCutLn)
llNoThing = RLOCK()
REPLACE &lcTmpCutLn..cPrePack WITH m.cPrePack ,;
        &lcTmpCutLn..nPrePack WITH m.nPrePack
llNoThing = RLOCK()
SELECT(lnAlias)

*:----------------------------------------------------------------
*: Name       : lfUpdHEst
*: Developer  : Yasser Mohammed Aly - (YMA)
*: Date       : 11/03/1997
*: Purpose    : Update the CT header estimated cost fields that are
*:              dislayed in the summery folder on the screen.
*:----------------------------------------------------------------
*: Calls      : None.
*:----------------------------------------------------------------
*: Parameters : None.
*:----------------------------------------------------------------
*: Returns    : None
*:----------------------------------------------------------------
*: Example    : = lfUpdHEst()
*:----------------------------------------------------------------
FUNCTION lfUpdHEst
PARAMETERS lnQty, lnSign
PRIVATE lnAlias, llComFrSty


llComFrSty = .T.
IF laData[3] # "H"
  lnAlias = SELECT(0)

  *E301077,56 YM 03/03/99 Start - Open the BomLine file.
  = gfOpenFile(gcDataDir+"BomLine","BomLine","SH")
  *E301077,56 YM 03/03/99 End.

  SELECT BomLine
  IF SEEK("M"+"1"+laData[1])
    SCAN WHILE cIMTyp+cType+CtktNo = "M"+"1"+laData[1] ;
           FOR Style = &lcTmpCutLn..Style AND !lVoid
      
      IF EMPTY(cSizes)
        lnStyQty = m.TotQty
      ELSE
        lnStyQty = 0
        FOR lnI = 1 TO LEN(ALLTRIM(cSizes))
          lcSize     = SUBSTR(ALLTRIM(cSizes),lnI,1)
          lnQtyToUse = EVAL(lcTmpCutLn + ".Qty" + lcSize)
          lnStyQty   = lnStyQty + lnQtyToUse
        ENDFOR
      ENDIF

      lnItemAmnt        = lnStyQty * UnitQty * UnitCost
      lnCstType         = 18 + VAL(cBomTyp)
      laData[lnCstType] = laData[lnCstType]+(lnItemAmnt*lnSign)
	  	
      llComFrSty        = .F.
    ENDSCAN
  ENDIF
  SELECT(lnAlias)
ENDIF

IF llComFrSty
  laData[19] = laData[19] + (lnSign * nMCost1 * lnQty)
  laData[20] = laData[20] + (lnSign * nMCost2 * lnQty)
  laData[21] = laData[21] + (lnSign * nMCost3 * lnQty)
  laData[22] = laData[22] + (lnSign * nMCost4 * lnQty)
  laData[23] = laData[23] + (lnSign * nMCost5 * lnQty)
  
  
ENDIF

*:----------------------------------------------------------------
*: Name       : lfvPPQty
*: Developer  : Yasser Mohammed Aly - (YMA)
*: Date       : 11/03/1997
*: Purpose    : The prepack quantity valid function.
*:----------------------------------------------------------------
*: Calls      : None.
*:----------------------------------------------------------------
*: Parameters : None.
*:----------------------------------------------------------------
*: Returns    : None
*:----------------------------------------------------------------
*: Example    : = lfvPPQty()
*:----------------------------------------------------------------
FUNCTION lfvPPQty
PARAMETERS llFrmTot
PRIVATE lnAlias

lnAlias    = SELECT(0)
SELECT (lcTmpCutLn)

m.nPrePack = IIF(EMPTY(m.cPrePack), 0, ABS(m.nPrePack))
laData[12] = laData[12] - &lcTmpCutLn..TotQty
laData[17] = laData[17] - &lcTmpCutLn..TotQty
llNoThing  = lfUpdHEst (&lcTmpCutLn..TotQty, -1)

llNoThing  = RLOCK()
REPLACE nPrePack WITH m.nPrePack                   ,; 
        cStatus  WITH IIF(cStatus = "A", "A", "M") ,;
        Qty1     WITH m.nPrePack * laPrePack[1]    ,;
        Qty2     WITH m.nPrePack * laPrePack[2]    ,;
        Qty3     WITH m.nPrePack * laPrePack[3]    ,;
        Qty4     WITH m.nPrePack * laPrePack[4]    ,;
        Qty5     WITH m.nPrePack * laPrePack[5]    ,;
        Qty6     WITH m.nPrePack * laPrePack[6]    ,;
        Qty7     WITH m.nPrePack * laPrePack[7]    ,;
        Qty8     WITH m.nPrePack * laPrePack[8]    ,;
        TotQty   WITH Qty1+Qty2+Qty3+Qty4+Qty5+Qty6+Qty7+Qty8


*-- HDM B603031,1 [Start] Also update costing fields per line
    REPLACE nCost1    WITH nMCost1    ,;
            nCost2    WITH nMCost2    ,;
            nCost3    WITH nMCost3    ,;
            nCost4    WITH nMCost4    ,;
            nCost5    WITH nMCost5
*-- HDM B603031,1 [end]
UNLOCK

laData[12] = laData[12] + TotQty
laData[17] = laData[17] + TotQty
llNoThing  = lfUpdHEst(TotQty, 1)

SCATTER FIELDS &lcLnScFlds MEMVAR
SHOW WINDOW (lcLinesBrw) REFRESH SAME
SHOW GETS WINDOW (lcCTChWn42) ONLY
IF m.nPrePack = 0
  _CUROBJ = IIF(llFrmTot, OBJNUM(m.Qty1), OBJNUM(m.TotQty))
ENDIF
llNoThing = lfUpdVars()
SELECT(lnAlias)

*:----------------------------------------------------------------
*: Name       : lfwQty
*: Developer  : Yasser Mohammed Aly - (YMA)
*: Date       : 11/03/1997
*: Purpose    : Save the old value of the current edited quantity 
*:              field.
*:----------------------------------------------------------------
*: Calls      : None.
*:----------------------------------------------------------------
*: Parameters : None.
*:----------------------------------------------------------------
*: Returns    : None
*:----------------------------------------------------------------
*: Example    : = lfwQty()
*:----------------------------------------------------------------
FUNCTION lfwQty

lnOLnQty = ABS(EVAL("m."+VARREAD()))

*:----------------------------------------------------------------
*: Name       : lfvQty
*: Developer  : Yasser Mohammed Aly - (YMA)
*: Date       : 11/03/1997
*: Purpose    : Current edited quantity field valid function.
*:----------------------------------------------------------------
*: Calls      : None.
*:----------------------------------------------------------------
*: Parameters : None.
*:----------------------------------------------------------------
*: Returns    : None
*:----------------------------------------------------------------
*: Example    : = lfvQty()
*:----------------------------------------------------------------
FUNCTION lfvQty
*: B802924,1 SSH 28/02/00(Start)   Add new private variable.
*PRIVATE lnAlias, lcFldNam, lcVarNam
PRIVATE lnAlias, lcFldNam, lcVarNam , lnChoice , lnDiff
lnDiff = 0
*: B802924,1 SSH 28/02/00(End)
lnAlias   = SELECT(0)
lcFldNam  = SYS(18)
lcVarNam  = "m." + SYS(18)
&lcVarNam = ABS(&lcVarNam)
llNewLine = laScrMode[4] OR &lcTmpCutLn..cStatus = "A"

IF lnOLnQty # &lcVarNam
  IF laScrMode[3] AND !lfChkOrdQt()
    &lcVarNam  = lnOLnQty
    _CUROBJ = _CUROBJ
  ELSE
    SELECT (lcTmpCutLn)
    lnNewTot   = (TotQty - &lcFldNam) + &lcVarNam
    lnOldTot   = TotQty
    llNoThing  = lfUpdHEst(TotQty, -1)
    *: B802924,1 SSH 28/02/00(Start) If the user decrease the Qty.
    *: B802924,1 SSH                 ask if he want to 'cancel remaining'
    *: B802924,1 SSH                 <Yes> <No> <Cancel>
    IF laScrMode[3] .AND. lnNewTot < lnOldTot .AND. laData[3] = 'H'
      lnNewTot   = (TotQty - &lcFldNam) + &lcVarNam
      lnDiff     = TotQty-lnNewTot
      lnOldTot   = TotQty
      llNoThing  = lfUpdHEst(0, 1)
    ENDIF
    *: B802924,1 SSH 28/02/00(End).
   
    llNoThing = RLOCK()
    REPLACE nCost1    WITH nMCost1    ,;
            nCost2    WITH nMCost2    ,;
            nCost3    WITH nMCost3    ,;
            nCost4    WITH nMCost4    ,;
            nCost5    WITH nMCost5    ,;
            TotQty    WITH lnNewTot   ,;
            &lcFldNam WITH &lcVarNam  ,;
            cStatus   WITH IIF(cStatus = "A", "A", "M")
    UNLOCK
    
    llNoThing = lfUpdHEst(TotQty, 1)
    
    IF llNewLine
      laData[12] = laData[12] - lnOldTot + lnNewTot
      laData[17] = laData[17] - lnOldTot + lnNewTot
    ELSE
      IF laData[3] = "A"
        lnNewAct = laData[16]-(lnOldTot-lnNewTot)
        IF laData[16] <= lnNewAct
          laData[17] = laData[17] + (lnNewAct - laData[16])
          laData[16] = lnNewAct
        ELSE
          laData[15] = laData[15] + (laData[16] - lnNewAct)
          laData[17] = laData[17] - (laData[16] - lnNewAct)
        ENDIF
      ELSE
        lnNewBud = laData[12]-(lnOldTot-lnNewTot)
        IF laData[12] <= lnNewBud
          *: B802924,1 SSH 28/02/00(Start) If you decrease the qty.
          *: B802924,1 SSH                 in case of hold cuttkt.
          IF lnDiff = 0
          *: B802924,1 SSH (End)
            laData[17] = laData[17] + (lnNewBud - laData[12])
          ELSE
            laData[17] = lnNewBud
          ENDIF 
          *: B802924,1 SSH (End)
          laData[12] = lnNewBud
        ELSE
          *: B802924,1 SSH 28/02/00(Start) If you decrease the qty.
          *: B802924,1 SSH                 in case of hold cuttkt
          IF lnDiff = 0
          *: B802924,1 SSH (End)
            laData[15] = laData[15] + (laData[12]-lnNewBud)
            laData[35] = laData[35] + (laData[12]-lnNewBud)
            laData[17] = laData[17] - (laData[12]-lnNewBud)
          *: B802924,1 SSH (End)
          ELSE
            laData[12] = lnNewBud
            laData[17] = lnNewBud
          *: B802924,1 SSH (End)
          ENDIF
        ENDIF
      ENDIF
    ENDIF
    
    m.TotQty  = TotQty
    SHOW GET &lcFldNam
    SHOW GET m.TotQty
    SHOW WINDOW (lcLinesBrw) REFRESH SAME
  
    llNoThing = lfUpdVars()
    SELECT(lnAlias)
  ENDIF  
ENDIF

*:----------------------------------------------------------------
*: Name       : lfChkOrdQt
*: Developer  : Yasser Mohammed Aly - (YMA)
*: Date       : 11/03/1997
*: Purpose    : Chech the allocated order lines for the current 
*:              edited line quantity.
*:----------------------------------------------------------------
*: Calls      : None.
*:----------------------------------------------------------------
*: Parameters : None.
*:----------------------------------------------------------------
*: Returns    : None
*:----------------------------------------------------------------
*: Example    : = lfChkOrdQt()
*:----------------------------------------------------------------
FUNCTION lfChkOrdQt
PRIVATE lnAlias, llProceed

lnAlias   = SELECT(0)
llProceed = .T.
lcFldNo   = RIGHT(lcFldNam,1)
lcOrdFld  = "&lcTmpCutLn..Ord" + lcFldNo

IF llSOInstad AND &lcVarNam < &lcOrdFld
  SELECT (lcTmpCtPk)
  SET FILTER TO
  IF SEEK(&lcTmpCutLn..Style)
    *-- Size "XXXXX" has "999" pieces allocated from orders.
    *-- Edit the allocated quantity from order lines to keep 
    *-- track of this allocation, release allocation for only 
    *-- the size being modified, or for all the line's sizes.
    *-- < Edit Allocation > < Release > < Release All > < Cancel >
    
    lcStr    = ALLTRIM(SCALE.Sz&lcFldNo) + "|" + ALLTRIM(STR(&lcOrdFld))
    lnChoice = gfModalGen("QRM38062B38007","DIALOG",lcStr)
    IF lnChoice = 4
      llProceed = .F.
    ELSE
      lnToSend  = IIF(lnChoice < 3, VAL(lcFldNo), 0)
      llProceed = IIF(lnChoice = 1, lfEdtAloQty(lnToSend), lfRmoveAlo(lnToSend))
    ENDIF
  ENDIF
  SELECT (lcTmpCtPk)
  SET FILTER TO Style+Order+cOrdLine = (lcOrderKy)
ENDIF

SELECT(lnAlias)
RETURN (llProceed)

*:----------------------------------------------------------------
*: Name       : lfEdtAloQty
*: Developer  : Yasser Mohammed Aly - (YMA)
*: Date       : 11/03/1997
*: Purpose    : To edit the allocated orders quantity.
*:----------------------------------------------------------------
*: Calls      : None.
*:----------------------------------------------------------------
*: Parameters : None.
*:----------------------------------------------------------------
*: Returns    : None
*:----------------------------------------------------------------
*: Example    : = lfEdtAloQty()
*:----------------------------------------------------------------
FUNCTION lfEdtAloQty
PARAMETERS lnSizeNo
PRIVATE lnAlias

DIMENSION laObj[8]

llRetVal        = .F.
llFrstTime      = .T.
lcCPBrTtl       = "Quantities Allocated from Order Lines"
laObj           = .F.
laObj[lnSizeNo] = .T.
lcToBrow        = SPACE(0)
lnOldQty        = 0
lnAlias         = SELECT(0)

PUSH KEY CLEAR
ON KEY LABEL TAB        DO lfCPTab
ON KEY LABEL ESC        DO lfCPEsc
ON KEY LABEL BACKTAB    DO lfCPStb
ON KEY LABEL Ctrl+ENTER lnDummy = 1
ON KEY LABEL Ctrl+HOME  lnDummy = 1
ON KEY LABEL Ctrl+W     lnDummy = 1
ON KEY LABEL Ctrl+END   lnDummy = 1
ON KEY LABEL ALT+B ACTIVATE WINDOW (lcCPBrTtl) 

*DO (gcScrDir+gcWinAppl+"\MFCtPkTr.SPR")
DO (gcScrDir+"MFCtPkTr.SPX")

POP KEY
RELEASE WINDOW (lcCPBrTtl)
SELECT (lnAlias)

RETURN (llRetVal)

*:----------------------------------------------------------------
*: Name       : lfCtPkTrBr
*: Developer  : Yasser Mohammed Aly - (YMA)
*: Date       : 11/03/1997
*: Purpose    : Browse the allocated orders lines.
*:----------------------------------------------------------------
*: Calls      : None.
*:----------------------------------------------------------------
*: Parameters : None.
*:----------------------------------------------------------------
*: Returns    : None
*:----------------------------------------------------------------
*: Example    : = lfCtPkTrBr()
*:----------------------------------------------------------------
FUNCTION lfCtPkTrBr
PRIVATE lcField

lcToBrow = "Order:H='Order# ':R:W=.F."
FOR lnI = 1 TO Scale.Cnt
  lcIStr  = STR(lnI,1)
  lcField = lcTmpCtPk + ".QTY" + lcIStr   
  lcHdr   = "'" + ALLTRIM(Scale.Sz&lcIStr) + "'"
  lcToBrow = lcToBrow + ", &lcField:H=&lcHdr. :W=laObj["+lcIStr+"] AND lfwCPGtFld() :B=0,99999 :V=lfvCPGtFld(&lcIStr)"
ENDFOR     
lcToBrow = lcToBrow + ", &lcTmpCtPk..TOTQTY:H='TotCut':W=.F."

BROWSE FIELDS &lcToBrow KEY &lcTmpCutLn..Style LOCK 0 ;
       NOAPPEND NOCLEAR NODELETE NOWAIT SAVE NOMENU   ;
       TITLE (lcCPBrTtl) WINDOW CtPkTr2 IN WINDOW CtPkTr1

*:----------------------------------------------------------------
*: Name       : lfwCPGtFld
*: Developer  : Yasser Mohammed Aly - (YMA)
*: Date       : 11/03/1997
*: Purpose    : Save the old value of the current edited allocated
*:              order line quantity.
*:----------------------------------------------------------------
*: Calls      : None.
*:----------------------------------------------------------------
*: Parameters : None.
*:----------------------------------------------------------------
*: Returns    : None
*:----------------------------------------------------------------
*: Example    : = lfwCPGtFld()
*:----------------------------------------------------------------
FUNCTION lfwCPGtFld

lnOldQty = EVAL(VARREAD())

*:----------------------------------------------------------------
*: Name       : lfvCPGtFld
*: Developer  : Yasser Mohammed Aly - (YMA)
*: Date       : 11/03/1997
*: Purpose    : To validate the edited allocated order line
*:              quantity.
*:----------------------------------------------------------------
*: Calls      : None.
*:----------------------------------------------------------------
*: Parameters : None.
*:----------------------------------------------------------------
*: Returns    : None.
*:----------------------------------------------------------------
*: Example    : = lfvCPGtFld()
*:----------------------------------------------------------------
FUNCTION lfvCPGtFld
PARAMETER lnObj
PRIVATE lnObj, lcObj, lnAlias

lnAlias  = SELECT(0)
lcObj    = STR(lnObj,1)

lnNewQty = &lcTmpCtPk..Qty&lcObj
lnCurQty = &lcTmpCtPk..nCurPck&lcObj

SELECT (lcTmpCtPk)
IF lnNewQty > lnCurQty
  *-- The allocated quantity cannot be greater than 9999.
  *-- < Ok > 
  = gfModalGen('TRM38107B00000','DIALOG',ALLTRIM(STR(lnCurQty,6)) )
  llNoThing = RLOCK()
  REPLACE Qty&lcObj WITH lnOldQty
  UNLOCK
ELSE                 
  llNoThing = RLOCK()
  REPLACE TotQty    WITH TotQty - lnOldQty + lnNewQty ,;
          cCPStatus WITH "M"
  UNLOCK
ENDIF
SELECT(lnAlias)

*:----------------------------------------------------------------
*: Name       : lfCPTab
*: Developer  : Yasser Mohammed Aly - (YMA)
*: Date       : 11/03/1997
*: Purpose    : Tab trapping function for the order line 
*:              allocation browse.
*:----------------------------------------------------------------
*: Calls      : None.
*:----------------------------------------------------------------
*: Parameters : None.
*:----------------------------------------------------------------
*: Returns    : None
*:----------------------------------------------------------------
*: Example    : = lfCPTab()
*:----------------------------------------------------------------
FUNCTION lfCPTab

DO CASE
  CASE WONTOP() = (lcCPBrTtl)
    ACTIVATE WINDOW CtPkTr3
    _CUROBJ = OBJNUM(pbOk)

  CASE WONTOP() # (lcCPBrTtl) AND SYS(18) = "PBCAN"
    KEYBOARD "{ALT+B}" 

  OTHERWISE
    _CUROBJ = _CUROBJ + 1
ENDCASE

*:----------------------------------------------------------------
*: Name       : lfCPStb
*: Developer  : Yasser Mohammed Aly - (YMA)
*: Date       : 11/03/1997
*: Purpose    : Shit+Tab trapping function for the order line 
*:              allocation browse.
*:----------------------------------------------------------------
*: Calls      : None.
*:----------------------------------------------------------------
*: Parameters : None.
*:----------------------------------------------------------------
*: Returns    : None
*:----------------------------------------------------------------
*: Example    : = lfCPStb()
*:----------------------------------------------------------------
FUNCTION lfCPStb

DO CASE
  CASE WONTOP() = (lcCPBrTtl)
    ACTIVATE WINDOW CtPkTr3
    _CUROBJ = OBJNUM(pbCan)

  CASE WONTOP() # (lcCPBrTtl) AND SYS(18) = "PBOK"
    KEYBOARD "{ALT+B}" 

  OTHERWISE
    _CUROBJ = _CUROBJ - 1
ENDCASE

*:----------------------------------------------------------------
*: Name       : lfCPEsc
*: Developer  : Yasser Mohammed Aly - (YMA)
*: Date       : 11/03/1997
*: Purpose    : Escape trapping function for the order line 
*:              allocation browse.
*:----------------------------------------------------------------
*: Calls      : None.
*:----------------------------------------------------------------
*: Parameters : None.
*:----------------------------------------------------------------
*: Returns    : None
*:----------------------------------------------------------------
*: Example    : = lfCPEsc()
*:----------------------------------------------------------------
FUNCTION lfCPEsc

ACTIVATE WINDOW CtPkTr3
_CUROBJ = OBJNUM(pbCan)
KEYBOARD "{ENTER}"

*:----------------------------------------------------------------
*: Name       : lfvCPOk
*: Developer  : Yasser Mohammed Aly - (YMA)
*: Date       : 11/03/1997
*: Purpose    : Ok button in the allocated order lines brose screen 
*:              valid function.
*:----------------------------------------------------------------
*: Calls      : None.
*:----------------------------------------------------------------
*: Parameters : None.
*:----------------------------------------------------------------
*: Returns    : None
*:----------------------------------------------------------------
*: Example    : = lfvCPOk()
*:----------------------------------------------------------------
FUNCTION lfvCPOk
PRIVATE lnAlias

lnAlias    = SELECT(0)
lcSzNo     = STR(lnSizeNo,1)
lcCurToChk = "nCurPck" + lcSzNo
lcVarToChk = "m.Qty"   + lcSzNo
lcFldToChk = "Qty"     + lcSzNo
llGoOut    = .F.
llRetVal   = .F.

SELECT (lcTmpCtPk)
SUM ALL &lcFldToChk, TotQty, &lcCurToChk, nTotCur ;
    FOR Style+Order+cOrdLine = &lcTmpCutLn..Style ;
    TO lnNewVal, lnNewTot, lnOldVal, lnOldTot

IF lnNewVal > &lcVarToChk
  *-- The allocated quantity does not total the cutting ticket 
  *-- quantity for size XXXXX.
  *-- < Accept > < Modify >
  IF gfModalGen('QRM38108B38014',"DIALOG", ALLTRIM(Scale.Sz&lcSzNo)) = 1
    &lcVarToChk = lnNewVal
    llGoOut     = .T.
    llRetVal    = .T.
  ENDIF
ELSE
  llGoOut  = .T.
  llRetVal = .T.
ENDIF

IF llGoOut
  SELECT (lcTmpCutLn)
  llNoThing = RLOCK()
  REPLACE &lcOrdFld WITH lnNewVal ,;
          TotOrd    WITh TotOrd - lnOldTot + lnNewTot
  UNLOCK
  
  SELECT (lcTmpCtPk)
  llNoThing = RLOCK()
  REPLACE ALL nCurPck&lcSzNo WITH Qty&lcSzNo ,;
              nTotCur        WITH TotQty
  UNLOCK
  CLEAR READ
ENDIF

SELECT(lnAlias)

*:----------------------------------------------------------------
*: Name       : lfvCPCan
*: Developer  : Yasser Mohammed Aly - (YMA)
*: Date       : 11/03/1997
*: Purpose    : Cancel button in the allocated order lines brose 
*:              screen valid function.
*:----------------------------------------------------------------
*: Calls      : None.
*:----------------------------------------------------------------
*: Parameters : None.
*:----------------------------------------------------------------
*: Returns    : None
*:----------------------------------------------------------------
*: Example    : = lfvCPCan()
*:----------------------------------------------------------------
FUNCTION lfvCPCan
PRIVATE lnAlias

lnAlias    = SELECT(0)
llRetVal   = .F.
lcSzNo     = STR(lnSizeNo,1)

SELECT (lcTmpCtPk)
llNoThing = RLOCK()
REPLACE ALL Qty&lcSzNo WITH nCurPck&lcSzNo ,;
            TotQty     WITH nTotCur        ,;
            cCPStatus  WITH "S"
UNLOCK
SELECT(lnAlias)

*:----------------------------------------------------------------
*: Name       : lfRmoveAlo
*: Developer  : Yasser Mohammed Aly - (YMA)
*: Date       : 11/03/1997
*: Purpose    : Remove the allocation for a specific line or for
*:              a specific size in the line.
*:----------------------------------------------------------------
*: Calls      : None.
*:----------------------------------------------------------------
*: Parameters : None.
*:----------------------------------------------------------------
*: Returns    : None
*:----------------------------------------------------------------
*: Example    : = lfRmoveAlo()
*:----------------------------------------------------------------
FUNCTION lfRmoveAlo
PARAMETER lnSize
PRIVATE   lnAlias

lnSize     = IIF(lnSize >= 0, lnSize  , 0)
lnFirstSiz = IIF(lnSize >  0, lnSize  , 1)
lnSize     = IIF(lnSize >  0, lnSize+1, 9)
lnAlias    = SELECT(0)

SELECT (lcTmpCtPk)
SCAN FOR Style+Order+cOrdLine = &lcTmpCutLn..Style
  lnSNo = lnFirstSiz
  DO WHILE lnSNo < lnSize
    lcSFd = "Qty" + STR(lnSNo,1)
    lcOFd = "Ord" + STR(lnSNo,1)

    SELECT (lcTmpCtPk)
    llNoThing = RLOCK()
    REPLACE TotQty WITH TotQty - &lcSFd ,;
            &lcSFd WITH 0
    UNLOCK
    
    SELECT (lcTmpCutLn)
    llNoThing = RLOCK()
    REPLACE TotOrd WITh TotOrd - &lcOFd ,;
            &lcOFd WITH 0
    UNLOCK
            
    lnSNo = lnSNo + 1
  ENDDO
ENDSCAN

REPLACE ALL cCPStatus WITH "D" ;
        FOR Style+Order+cOrdLine = &lcTmpCutLn..Style AND ;
        TotQty = 0
DELETE  ALL ;
        FOR Style+Order+cOrdLine = &lcTmpCutLn..Style AND ;
        cCPStatus = "D"

*B603317,1 [
*GOTO TOP
LOCATE
*B603317,1 [

llNoThing = RLOCK()
UNLOCK

SELECT(lnAlias)

*:----------------------------------------------------------------
*: Name       : lfvTotQty
*: Developer  : Yasser Mohammed Aly - (YMA)
*: Date       : 11/03/1997
*: Purpose    : Total quantity valid function.
*:----------------------------------------------------------------
*: Calls      : None.
*:----------------------------------------------------------------
*: Parameters : None.
*:----------------------------------------------------------------
*: Returns    : None
*:----------------------------------------------------------------
*: Example    : = lfvTotQty()
*:----------------------------------------------------------------
FUNCTION lfvTotQty
PRIVATE lnAlias

lnAlias = SELECT(0)
SELECT (lcTmpCutLn)

IF MOD(m.TotQty, laPrePack[9]) <> 0
  *-- Total quantity is not evenly divisible by the total prepak quantity.
  *-- < Ok > 
  = gfModalGen('TRM38109B00000')
  m.TotQty   = 0
  _CUROBJ    = _CUROBJ
ELSE
  m.nPrePack = m.TotQty/laPrePack[9]
  llNoThing  = lfvPPQty(.T.)
ENDIF

SELECT(lnAlias)

*:----------------------------------------------------------------
*: Name       : gfCPDelete
*: Developer  : Yasser Mohammed Aly - (YMA)
*: Date       : 11/03/1997
*: Purpose    : Global control panel "Delete" valid function, that 
*:              will be used as "Cancel\Uncancel".
*:              This function shoud be overwritten in the program
*:              because there is some checks that should be performed
*:              prior to the confirming messge displayed in the 
*:              standard global function.
*:----------------------------------------------------------------
*: Calls      : None.
*:----------------------------------------------------------------
*: Parameters : None.
*:----------------------------------------------------------------
*: Returns    : None
*:----------------------------------------------------------------
*: Example    : = gfCPDelete()
*:----------------------------------------------------------------
FUNCTION gfCPDelete
PRIVATE lnAlias

*B606657,1 AMH Don't need to do the next check [Start]
*IF laData[3] # "X" AND laData[13] > 0 
*  *-- Some pieces have been received on this cutting ticket.
*  *-- < Ok >
*  = gfModalGen('TRM38110B00000')
*ENDIF
*B606657,1 AMH [End]

*-- Cancel\Uncancel all the lines in this cutting ticket?
*-- < Yes > < No >
IF gfModalGen('QRM38111B38006',"DIALOG",PROPER(lcDelMesag)) = 1
  lnAlias = SELECT(0)

  *E301077,56 YM 03/03/99 Start - Open the STYDYE file and the CutPick file.
  = gfOpenFile(gcDataDir+"STYDYE","STYDYE","SH")
  = gfOpenFile(gcDataDir+"CutPick","","SH")
  *E301077,56 YM 03/03/99 End.

  llCont  = .T.
  *E301077,56 YM 03/03/99 Start - Use gfOpenFile instead.
  lcMastrLin = SPACE(0)
  = gfOpenFile(gcDataDir+"CutTktL","CutTktL","SH", @lcMastrLin, .T.)
  *USE (gcDataDir+"CutTktL") AGAIN IN 0 ORDER CutTktL ALIAS MastrLine
  *E301077,56 YM 03/03/99 End.
  SELECT (lcMastrLin)
  
  IF SEEK(laData[1], lcMastrLin)
    llCont = .T.
    
    *B606657,1 AMH Check if Open C/T [Start]
    IF laData[3] # 'X' AND SEEK("M"+laData[1], "CTktBom")
      IF laData[13]=0
        =gfModalGen('QRM38253B00000','DIALOG')
        *-There is a C/T cost sheet, You have to delete it first.
        RETURN
      ELSE
        IF gfModalGen('QRM38254B38006','DIALOG') = 2
          *-This C/T has a cost sheet. Do you wish to cancel this C/T?
          RETURN
        ENDIF
        *-- Pieces have been received. Do you want to cancel all Open items on this ?
        IF laData[3] = 'O' AND gfModalGen('TRM34019B34001','DIALOG',"C/T.") = 2
          RETURN
        ENDIF

      ENDIF
    ENDIF
    *B606657,1 AMH [End]
    
    IF llSOInstad AND laData[3] # "X"
      SELECT CutPick
      lcOTag = TAG()
      SET FILTER TO
      SET ORDER TO CutPick
      IF SEEK("1" + laData[1] + ALLTRIM(laData[2]))
        *-- This cutting ticket has allocated quantity from order(s),
        *-- canceling the cutting ticket will release this allocation.
        *-- Would you like to continue ?
        *-- < Yes > < No >
        
        *B606657,1 AMH Release Allocation in case of Open C/T with received quantity [Start]
        *llCont = gfModalGen('QRM38112B38006') = 1
        llCont = (laData[3] = 'O' .AND. laData[13] > 0) .OR. (gfModalGen('QRM38112B38006') = 1)
        *B606657,1 AMH [End]
        
        *B602473,1 HDM 03/08/99 Check That the order allocated on this 
        *B602473,1 HDM 03/08/99 CT Has no Pick Ticket[start]
        IF llCont AND !lfChkOrder()
          llCont = .F.
        ENDIF
        *B602473,1 HDM 03/08/99 End.
        
      ENDIF  
      SET ORDER TO &lcOTag
      SET FILTER TO TranCD+CtktNo+Style = (lcOrderKy)
    ENDIF
    
    IF llCont AND laData[3] = "X"
      SELECT CutTktL
      lnMstRec = RECNO()
      SET FILTER TO 
      *MAN NY Start The Index Expression doesn't have STR(RECNO(),7)
      *SCAN FOR CutTkt+Style+Dyelot+TranCD+STR(RECNO(),7) = laData[1] ;
      *           AND !SEEK(CutTktL.Style, "Style")
      SCAN FOR CutTkt+Style+Dyelot+TranCD = laData[1] ;
           AND !SEEK(CutTktL.Style, "Style")
      *MAN NY End     
        *-- One or more of the XXXXXXXX used in this cutting ticket 
        *-- has been deleted from the system, Cannot uncancel."
        *-- < Ok >
        lcToSay = "'" + ALLTRIM(gfItemMask("HI")) + "(s)'"
        llCont  = gfModalGen('TRM38113B00000',"DIALOG",lcToSay) = 1000
        EXIT
      ENDSCAN
      *MAN NY Start The Index Expression doesn't have STR(RECNO(),7)
      *SET FILTER TO CutTkt+Style+Dyelot+TranCD+STR(RECNO(),7) = ;
                    (lcCutTkt) AND TranCD = "1"
      SET FILTER TO CutTkt+Style+Dyelot+TranCD = ;
                    (lcCutTkt) AND TranCD = "1"              
      *MAN NY End              
      IF BETWEEN(lnMstRec, 0, RECCOUNT())
        GOTO lnMstRec
      ENDIF
    ENDIF
    
    IF llCont
      DIMENSION laQty[8]
      SELECT (lcMastrLin)
      lnNewOpn = 0
      lnCanQty = 0
      
      *B606657,1 AMH Check if open C/T with received qunatity and allocated [Start]
      llOpenAllo = llSOInstad .AND. laData[3] = 'O' .AND. laData[13] > 0
      IF llOpenAllo
        lnOpOrdHdr = gfOpenFile(gcDataDir+"OrdHdr" , "OrdHdr" , "SH")
        lnOpOrdLin = gfOpenFile(gcDataDir+"OrdLine", "OrdLine", "SH")
        lnTotOrd = 0
        SELECT CUTTKTL
        lcFltSet = SET('FILTER')
        SET FILTER TO
        SET ORDER TO CUTTKTL
        SELECT (lcMastrLin)
      ENDIF
      *B606657,1 AMH [End]
      
      DO WHILE CutTkt = laData[1] AND !EOF()
        SELECT (lcMastrLin)
        
        *B606657,1 AMH Release Allocation in case of C/T open with received quantity [Start]
        llNoThing  = IIF(llOpenAllo .AND. TRANCD = '1', lfRemAllo(), .T.)
        *B606657,1 AMH [End]
        
        lcStyle    = Style
        lcWareCode = cWareCode
        laQty      = 0
        llNoThing  = lfGtWipQty()
        lnUpdSign  = IIF(laData[3] = "X", 1, -1)
        llNoThing  = lfWipAdd(lcStyle, "Style", "Wip", lnUpdSign, "laQty")
        llNoThing  = lfWipAdd(lcStyle, "Style", "nWo", lnUpdSign, "laQty")
        llNoThing  = lfWipAdd(lcStyle+lcWareCode+SPACE(10), "StyDye", "Wip", lnUpdSign, "laQty")
        llNoThing  = lfWipAdd(lcStyle+lcWareCode+SPACE(10), "StyDye", "nWo", lnUpdSign, "laQty")
        lnTotQty   = laQty[1]+laQty[2]+laQty[3]+laQty[4]+;
                     laQty[5]+laQty[6]+laQty[7]+laQty[8]
        lnNewOpn   = lnNewOpn + (lnUpdSign * lnTotQty)
        lnCanQty   = lnCanQty + lnTotQty
      ENDDO
      
      *B606657,1 AMH Check if open C/T with received qunatity and allocated [Start]
      IF llOpenAllo
        = IIF(lnOpOrdHdr, gfCloseFile("OrdHdr")  , 0)
        = IIF(lnOpOrdLin, gfCloseFile("OrdLine") , 0)
        SELECT CUTTKTL
        SET ORDER TO
        SET FILTER TO &lcFltSet.
        SELECT (lcMastrLin)
      ENDIF
      *llNoThing = IIF(llSOInstad AND laData[3] # "X", lfRelAllo(), .T.)
      llNoThing = IIF(llSOInstad AND laData[3] # "X" AND !llOpenAllo, lfRelAllo(), .T.)
      *B606657,1 AMH [End]
      
      
      SELECT CutTktH
      llNoThing = RLOCK()
      REPLACE Pcs_Act    WITH 0 ,;
              Pcs_Opn    WITH MAX (lnNewOpn, 0)
      IF laData[3] = "X"
        REPLACE Pcs_Can    WITH MAX (Pcs_Can    - Pcs_Opn, 0) ,;
                Pcs_CanOld WITH MAX (Pcs_CanOld - Pcs_Opn, 0) ,;
                Status     WITH IIF (Pcs_Opn = 0 AND Pcs_Rec > 0, "C", "H")
      ELSE
        
        *B606657,1 AMH Cancel the remaining quantity in case of open C/T [Start]
        *REPLACE Pcs_Can    WITH Pcs_Can + lnCanQty                        ,;
                Pcs_CanOld WITH Pcs_CanOld + IIF(Status#"A", lnCanQty, 0) ,;
                Status     WITH IIF(Pcs_Rec > 0, "C", "X") ,;
                TotOrd     WITH 0
        REPLACE Pcs_Can    WITH MAX(Pcs_Bud - Pcs_Rec - Pcs_Dam,0),;
                Status     WITH IIF(Pcs_Rec > 0, "C", "X"),;
                TotOrd     WITH IIF(llOpenAllo,lnTotOrd,0)

        *B606743,1 WAB (Start) if the CutTkit is completed , call function to add cancel(S) line 
        IF Status = 'C'
          =lfAdCnLine()
        ENDIF
        *B606743,1 WAB (End) 
        
        *B606657,1 AMH [End]
        
      ENDIF
      UNLOCK
      
      SELECT CutTktH
      SCATTER FIELDS &lcScFields TO laData
      llNoThing    = lfSetStat(laData[3])
      lcPromp      = IIF(laData[3]="X", lcUnCanc, lcCancel) 
      
      *B606657,1 AMH Fix the bug of Cannot cancel open C/T [Start]
      *lcCanStat    = IIF(laData[3]$"HX", "ENABLE", "DISABLE")
      lcCanStat    = IIF(laData[3]$"OHX", "ENABLE", "DISABLE")
      *B606657,1 AMH [End]
      
      llNoThing    = lfrefresh() AND lfStDelBar()
      lcEdtStat    = IIF(laData[3] $ "CSX", "DISABLE", "ENABLE")
      laCtrStat[7] = lcEdtStat
      SHOW GET pbEdt &lcEdtStat
    ENDIF
    *B605000,1 AMH Trigger for Cathy Daniels to export C/T to the old system [Start]
    IF ASCAN(laEvntTrig , PADR('EXPCTOLD',10)) <> 0
      =gfDoTriger('MFCUTKT',PADR('EXPCTOLD',10))
    ENDIF     
    *B605000,1 AMH [End]
  ELSE
    *-- The lines for this cutting ticket are missing ! 
    *-- cannot update W.I.P.!
    *-- < Ok >
    = gfModalGen('TRM38114B00000')
  ENDIF
  = gfCloseFile(lcMastrLin)

  *E301869,1 HBG 07/04/2002 Cancel the project on this cuttkt[Begin]
  =lfUpdPrjSt()
  *E301869,1 [End]
  
  SELECT(lnAlias)
ENDIF

*:----------------------------------------------------------------
*: Name       : lfGtWipQty
*: Developer  : Yasser Mohammed Aly - (YMA)
*: Date       : 11/03/1997
*: Purpose    : To compute the WIP quantities for a specific CT line.
*:----------------------------------------------------------------
*: Calls      : None.
*:----------------------------------------------------------------
*: Parameters : None.
*:----------------------------------------------------------------
*: Returns    : None
*:----------------------------------------------------------------
*: Example    : = lfGtWipQty()
*:----------------------------------------------------------------
FUNCTION lfGtWipQty
PRIVATE lnAlias

DIMENSION laZero[9]
lnAlias = SELECT(0)
laZero  = 0

SELECT (lcMastrLin)
SCAN REST WHILE CutTkt+Style = laData[1]+lcStyle
  FOR lnSize = 1 TO 8
    lcField       = "Qty" + ALLTRIM(STR(lnSize))
    lnField       = ABS(&lcField) * IIF(TranCD = "1", 1, -1)
    lnQty         = laQty[lnSize] + lnField
    laQty[lnSize] = MAX(lnQty, 0)
  ENDFOR
  
  *B606657,1 AMH Release Allocation in case of C/T open with received quantity [Start]
  *IF laData[3] # "X"
  IF laData[3] # "X" .AND. !llOpenAllo
  *B606657,1 AMH [End]
  
    GATHER FROM laZero ;
         FIELDS Ord1,Ord2,Ord3,Ord4,Ord5,Ord6,Ord7,Ord8,TotOrd
  ENDIF       
ENDSCAN
SELECT (lnAlias)

*:----------------------------------------------------------------
*: Name       : lfRelAllo
*: Developer  : Yasser Mohammed Aly - (YMA)
*: Date       : 11/03/1997
*: Purpose    : Release the order line allocation from the master
*:              prder line, header, cutpick, cuttktl files.
*:----------------------------------------------------------------
*: Calls      : None.
*:----------------------------------------------------------------
*: Parameters : None.
*:----------------------------------------------------------------
*: Returns    : None
*:----------------------------------------------------------------
*: Example    : = lfRelAllo()
*:----------------------------------------------------------------
FUNCTION lfRelAllo
PRIVATE lnAlias

DIMENSION laZero[9]
lnAlias    = SELECT(0)
laZero     = 0
lnOpOrdHdr = gfOpenFile(gcDataDir+"OrdHdr" , "OrdHdr" , "SH")
lnOpOrdLin = gfOpenFile(gcDataDir+"OrdLine", "OrdLine", "SH")
      
SELECT CutPick
SET FILTER TO 
SCAN FOR TranCd+CtktNo+Style = "1"+laData[1]
  SELECT OrdHdr
  IF SEEK("O"+CutPick.Order)
    llNoThing = RLOCK()
    REPLACE TotCut WITH 0
    UNLOCK
  ENDIF
  
  SELECT OrdLine
  IF SEEK("O"+CutPick.Order+CutPick.cOrdLine)
    GATHER FROM laZero ;
           FIELDS Cut1,Cut2,Cut3,Cut4,Cut5,Cut6,Cut7,Cut8,TotCut
  ENDIF
  
  SELECT CutPick
  GATHER FROM laZero ;
         FIELDS Qty1,Qty2,Qty3,Qty4,Qty5,Qty6,Qty7,Qty8,TotQty
ENDSCAN
SELECT CutPick
DELETE ALL FOR TranCd+CtktNo+Style = "1"+laData[1]
SET FILTER  TO TranCD+CtktNo+Style = (lcOrderKy)
      
= IIF(lnOpOrdHdr, gfCloseFile("OrdHdr")  , 0)
= IIF(lnOpOrdLin, gfCloseFile("OrdLine") , 0)

IF lcActTrnBr = "O" AND !llCTZoom
  = lfOptBrows()
ENDIF
      
SELECT (lnAlias)

*:----------------------------------------------------------------
*: Name       : lpClsScr
*: Developer  : Yasser Mohammed Aly - (YMA)
*: Date       : 11/03/1997
*: Purpose    : Local cancel function.
*:----------------------------------------------------------------
*: Calls      : None.
*:----------------------------------------------------------------
*: Parameters : None.
*:----------------------------------------------------------------
*: Returns    : None
*:----------------------------------------------------------------
*: Example    : = lpClsScr()
*:----------------------------------------------------------------
FUNCTION lpClsScr
PRIVATE lnAlias

llNoThing = lfUpdUnCmS("Initia", SPACE(0), .F.)

*:----------------------------------------------------------------
*: Name       : lpSavScr
*: Developer  : Yasser Mohammed Aly - (YMA)
*: Date       : 11/03/1997
*: Purpose    : Local save function.
*:----------------------------------------------------------------
*: Calls      : None.
*:----------------------------------------------------------------
*: Parameters : None.
*:----------------------------------------------------------------
*: Returns    : None
*:----------------------------------------------------------------
*: Example    : = lpSavScr()
*:----------------------------------------------------------------
PROCEDURE lpSavScr
PRIVATE lnAlias, lcFldNam

lnAlias    = SELECT(0)
lnLstLine  = 0
llRecSaved = .F.
llEdtCTNum = gfGetMemVar('M_GENCTNUM') = "Y"

*B602744,1 [Start]Check the total CT Quantity in Add Mode
*                 Before starting the saving proceedure
IF laScrMode[4]
  IF laData[12] = 0
   *-- Total pieces is zero. Tansaction cancelled.
   = gfModalGen("INM38051B00000")
   *Raise this flag with FALSE to tell the gfCpSave
   *that we couldn't save this CT
   llSaveIt = .F.
   llCSave  = .F.
   RETURN
  ENDIF
ENDIF
*B602744,1[End]

laData[01] = IIF(laScrMode[4], lfGetCTNum(), laData[1])


laData[04] = lcHedrWare
laData[18] = IIF(llMultiLot, "M", "S")

IF laScrMode[3] AND laData[17] = 0
  laData[3] = IIF(laData[13] > 0, "C", "X")
  
  *B602381,1 03/08/99 YMA Change the CT status upon saving.
  llNoThing    = lfSetStat(laData[3])
  lcPromp      = IIF(laData[3]="X", lcUnCanc, lcCancel) 
  
  *B606657,1 AMH Fix the bug of Cannot cancel open C/T [Start]
  *lcCanStat    = "DISABLE"
  lcCanStat    = IIF(laData[3]$"OHX", "ENABLE", "DISABLE")
  *B606657,1 AMH [End]
  
  llNoThing    = lfRefresh() AND lfStDelBar()
  lcEdtStat    = "DISABLE"
  laCtrStat[7] = lcEdtStat
  SHOW GET pbEdt &lcEdtStat
  *B602381,1 03/08/99 End.  
ENDIF

*E301077,56 YM 03/03/99 Start - Open the BOM\STYDYE files.
= gfOpenFile(gcDataDir+"BOM","BOM","SH")
= gfOpenFile(gcDataDir+"STYDYE","STYDYE","SH")
*E301077,56 YM 03/03/99 End.

*E301077,56 YM 03/03/99 Use gfOpenFile instead.
lcMastrLin = SPACE(0)
= gfOpenFile(gcDataDir+"CutTktL","CutTktL","SH", @lcMastrLin, .T.)
*USE (gcDataDir+"CutTktL") AGAIN IN 0 ORDER CutTktL ALIAS MastrLine
*E301077,56 YM 03/03/99 End.

IF laScrMode[3] AND llSOInstad
  lnOpOrdHdr = gfOpenFile(gcDataDir+"OrdHdr" , "OrdHdr" , "SH")
  lnOpOrdLin = gfOpenFile(gcDataDir+"OrdLine", "OrdLine", "SH")
  SELECT CutPick
  SET FILTER TO
  SET ORDER TO CutPkOrd
  SELECT (lcTmpCtPk)
  SET FILTER TO
ENDIF

SELECT CutTktL
SET FILTER To
SET ORDER TO CutTktL

*-- Recall all the deleted lines.
lnODelStat = SET ("DELETE")
SET DELETE OFF
SELECT (lcTmpCutLn)
RECALL ALL FOR Style+cWareCode+Dyelot = ALLTRIM(laData[2]) AND cStatus = "D"
SET DELETE &lnODelStat

*-- Count all the records to be processed to be used in the 
*-- Thermometer.
SELECT (lcTmpCutLn)
COUNT ALL TO lnTotLine FOR Style+cWareCode+Dyelot = "" AND !EMPTY(Style)
lcHdrMsg  = "Updating Cutting Ticket..."
lnCurLine = 0

*-- These two files are required by the global function that 
*-- updates the BOM files.
llOpnOpr  = gfOpenFile(gcDataDir+"MFGOprHd","MFGOprHd","SH")
llOpnFab  = gfOpenFile(gcDataDir+"Fabric"  ,"Fabric"  ,"SH")

*-- Update the uncomplete session file with the object name.
llNoThing = lfUpdUnCmS("Open", "pbSav", .T.)


SELECT (lcTmpCutLn)

*B603317,1 [
*GOTO TOP
LOCATE
*B603317,1 [

SCAN FOR !EMPTY(Style)
  lnCurLine = lnCurLine + 1
  = gfThermo(lnTotLine, lnCurLine, lcHdrMsg, &lcTmpCutLn..Style)
  SCATTER FIELDS Qty1,Qty2,Qty3,Qty4,Qty5,Qty6,Qty7,Qty8 TO laNewQty

  llNoThing = RLOCK()
  REPLACE CutTkt WITH laData[1]
  UNLOCK
  DO CASE
    CASE cStatus = "A"
      llNoThing = IIF(TotQty > 0, lfAddLine(), .T.)
  
    CASE cStatus = "M"
      llNoThing = lfModLine()
      
    CASE cStatus = "D"
      
      *B606608,1 KHM 12/03/2002 (Begin) Getting the original quantity from the master file
      *B606608,1                in case the user zero out the quantities then removed the line.
      IF SEEK(CutTkt+Style+Dyelot+TranCd,'CutTktl')
        SELECT CutTktl
        SCATTER FIELDS Qty1,Qty2,Qty3,Qty4,Qty5,Qty6,Qty7,Qty8 TO laNewQty
        SELECT (lcTmpCutLn)
      ENDIF
      *B606608,1 KHM 12/03/2002 (End)
      lnSclCnt  = IIF(SEEK("S"+&lcTmpCutLn..Scale, "Scale"), Scale.Cnt, 8)
      llNoThing = lfDelLine()
      
    CASE cStatus = "S"
      *-- Nothing has to be done here.
  ENDCASE
ENDSCAN

*-- Update the uncomplete session file.
llNoThing = lfUpdUnCmS("Complete", SPACE(0), .F.)
lcScrMode = IIF(laScrMode[3], "V", "S")

IF WEXIST('gwdThermo')
  = gfThermo(lnTotLine,lnTotLine,lcHdrMsg,"")
ENDIF

IF laScrMode[4]
  = lfDone()
ELSE
  SELECT CutTktH
  GATHER FROM laData FIELDS &lcScFields
  =gfArDyRl('' , '' , lcCTChWin2,.T.)
ENDIF

SELECT CutTktL
SET ORDER TO
*MAN NY Start The Index Expression doesn't have STR(RECNO(),7)
*SET FILTER TO CutTkt+Style+Dyelot+TranCD+STR(RECNO(),7) = ;
              (lcCutTkt) AND TranCD = "1"
SET FILTER TO CutTkt+Style+Dyelot+TranCD = ;
              (lcCutTkt) AND TranCD = "1"
*MAN NY End              

= gfCloseFile(lcMastrLin)
= IIF(llOpnOpr, gfCloseFile("MFGOprHd"), 0)
= IIF(llOpnFab, gfCloseFile("Fabric")  , 0)

IF laScrMode[3] AND llSOInstad
  SELECT (lcTmpCtPk)
  SET FILTER TO Style+Order+cOrdLine = (lcOrderKy)
  SELECT CutPick
  SET FILTER TO TranCD+CtktNo+Style = (lcOrderKy)
  SET ORDER TO 
  = IIF(lnOpOrdHdr, gfCloseFile("OrdHdr")  , 0)
  = IIF(lnOpOrdLin, gfCloseFile("OrdLine") , 0)
ENDIF

*C102433,1 AMH Trigger for Cathy Daniels to export C/T to the old system [Start]
IF laScrMode[3] .AND. ASCAN(laEvntTrig , PADR('EXPCTOLD',10)) <> 0
  =gfDoTriger('MFCUTKT',PADR('EXPCTOLD',10))
ENDIF     
*C102433,1 AMH [End]

*E301869,1 HBG 07/04/2002 Generate project for this SO acoording to the setup of the module[Begin]
IF lcGenProj $ 'AI' AND laScrMode[4]
  =lfGenProj()
ENDIF
*E301869,1 [END]

SELECT(lnAlias)

*:----------------------------------------------------------------
*: Name       : lfFillArr
*: Developer  : Yasser Mohammed Aly - (YMA)
*: Date       : 11/03/1997
*: Purpose    : 
*:----------------------------------------------------------------
*: Calls      : None.
*:----------------------------------------------------------------
*: Parameters : None.
*:----------------------------------------------------------------
*: Returns    : None
*:----------------------------------------------------------------
*: Example    : = lfFillArr()
*:----------------------------------------------------------------
FUNCTION lfFillArr
PRIVATE lnAlias

lnAlias = SELECT(0)
SELECT (lcMastrLin)
SCAN REST WHILE CutTkt+Style+Dyelot = m.CutTkt+m.Style+m.Dyelot
  FOR lnSize = 1 TO 8
    lcField = "Qty" + STR(lnSize,1)
    lnWipFd = ABS(&lcField) * IIF(TranCD = "1", 1, -1)
    lnWipQt = laWip[lnSize] + lnWipFd
    lnTrnFd = ABS(&lcField) * IIF(TranCD = "1", 0, 1)
    lnTrnQt = laTrn[lnSize] + lnTrnFd
    laWip[lnSize] = MAX(lnWipQt, 0)
    laTrn[lnSize] = MAX(lnTrnQt, 0)
  ENDFOR
ENDSCAN
SELECT(lnAlias)

*:----------------------------------------------------------------
*: Name       : lfWipMod
*: Developer  : Yasser Mohammed Aly - (YMA)
*: Date       : 11/03/1997
*: Purpose    : To modify the WIP, nWO fields in the style, stydue 
*:              files for a specific key.
*:----------------------------------------------------------------
*: Calls      : None.
*:----------------------------------------------------------------
*: Parameters : None.
*:----------------------------------------------------------------
*: Returns    : None
*:----------------------------------------------------------------
*: Example    : = lfFillArr()
*:----------------------------------------------------------------
FUNCTION lfWipMod
PARAMETERS lcFile, lcExp, laArr
PRIVATE lnAlias

lnAlias = SELECT(0)
SELECT (lcFile)
IF SEEK(lcExp)
  FOR lnSize = 1 TO 8
    lcStyFld = "Wip" + STR(lnSize,1)
    lcCutFld = "Qty" + STR(lnSize,1)
    lnDiffer = CutTktL.&lcCutFld - &laArr[lnSize]
    IF lnDiffer < 0
      IF laWip[lnSize] <= 0
        lnDiffer = MAX(&laArr[lnSize]-laTrn[lnSize], 0)
      ENDIF
      lnToUse = &lcStyFld + ABS(lnDiffer)
    ELSE
      lnToUse = IIF(laWip[lnSize]>0, MIN(lnDiffer,laWip[lnSize]), 0)
      lnToUse = &lcStyFld - lnToUse
    ENDIF
    llNoThing = RLOCK()
    REPLACE &lcStyFld WITH lnToUse
    UNLOCK
  ENDFOR
  llNoThing = RLOCK()
  REPLACE TotWip WITH Wip1+Wip2+Wip3+Wip4+Wip5+Wip6+Wip7+Wip8
  UNLOCK
ENDIF
SELECT(lnAlias)

*:----------------------------------------------------------------
*: Name       : lfGtNewLn
*: Developer  : Yasser Mohammed Aly - (YMA)
*: Date       : 11/03/1997
*: Purpose    : Generate a new CT line number.
*:----------------------------------------------------------------
*: Calls      : None.
*:----------------------------------------------------------------
*: Parameters : None.
*:----------------------------------------------------------------
*: Returns    : None
*:----------------------------------------------------------------
*: Example    : = lfGtNewLn()
*:----------------------------------------------------------------
FUNCTION lfGtNewLn
PRIVATE lnAlias

lnAlias = SELECT(0)
IF lnLstLine  = 0
  *E301077,56 YMA 03/03/99 Use gfOpenFile instead.
  lcMstCuTLn = SPACE(0)
  = gfOpenFile(gcDataDir+"CutTktL","CutTktL","SH", @lcMstCuTLn, .T.)
  *USE (gcDataDir+"CutTktL") IN 0 AGAIN ALIAS MstCuTLn ORDER CutTktL
  *E301077,56 YMA 03/03/99 End.
    
  SELECT (lcMstCuTLn)
  IF SEEK(laData[1])
    SCAN REST WHILE CUTTKT = laData[1]
      lnLstLine = MAX(lnLstLine, LineNo)
    ENDSCAN
  ENDIF
  = gfCloseFile(lcMstCuTLn)
ENDIF
lnLstLine = lnLstLine + 1

SELECT (lcTmpCutLn)
llNoThing = RLOCK()
REPLACE LineNo WITH lnLstLine
UNLOCK

SELECT(lnAlias)
 
*:----------------------------------------------------------------
*: Name       : lfGetCTNum
*: Developer  : Yasser Mohammed Aly - (YMA)
*: Date       : 11/03/1997
*: Purpose    : Generate a new CT number.
*:----------------------------------------------------------------
*: Calls      : None.
*:----------------------------------------------------------------
*: Parameters : None.
*:----------------------------------------------------------------
*: Returns    : None
*:----------------------------------------------------------------
*: Example    : = lfGetCTNum()
*:----------------------------------------------------------------
FUNCTION lfGetCTNum
PRIVATE lcRetVal

IF llEdtCTNum
  lcCTNum = SPACE(0)
  PUSH KEY 
  ON KEY
  ON KEY LABEL ESC lnDummy = 1
  DO (gcScrDir+gcWinAppl+"\mfCTGNum.SPX")
  POP KEY
  lcRetVal = lcCTNum
ELSE
  lcRetVal = gfSequence("CUTTKT","","",laData[10])
ENDIF

RETURN (lcRetVal)

*:----------------------------------------------------------------
*: Name       : lfvCTNumOk
*: Developer  : Yasser Mohammed Aly - (YMA)
*: Date       : 11/03/1997
*: Purpose    : Valid ok button in the new CT number screen.
*:----------------------------------------------------------------
*: Calls      : None.
*:----------------------------------------------------------------
*: Parameters : None.
*:----------------------------------------------------------------
*: Returns    : None
*:----------------------------------------------------------------
*: Example    : = lfvCTNumOk()
*:----------------------------------------------------------------
FUNCTION lfvCTNumOk
PRIVATE llRet 

*-- You cannot leave the Cutting Ticket number empty.
*-- Cutting Ticket number must be six digits.
*-- This Cutting Ticket number is already exist.

llRet = .F.
IF EMPTY(lcCTNum)
  lnNoThing = gfModalGen('TRM38047B00000','DIALOG',"Cutting Ticket")
ELSE
  IF LEN(ALLTRIM(lcCTNum)) < 6
    lnNoThing = gfModalGen('TRM38048B00000','DIALOG',"Cutting Ticket")
  ELSE
    IF SEEK(lcCTNum,"CutTktH")
      lnNoThing = gfModalGen('TRM38049B00000','DIALOG',"Cutting Ticket")
    ELSE
      llRet = .T.
    ENDIF
  ENDIF
ENDIF

IF llRet
  CLEAR READ
ELSE
  _CUROBJ = OBJNUM(lcCTNum)
ENDIF

*:----------------------------------------------------------------
*: Name       : lfWipAdd
*: Developer  : Yasser Mohammed Aly - (YMA)
*: Date       : 11/03/1997
*: Purpose    : Add the CT lines qty to the WIP qty in the Style, 
*:              StyDye files.
*:----------------------------------------------------------------
*: Calls      : None.
*:----------------------------------------------------------------
*: Parameters : None.
*:----------------------------------------------------------------
*: Returns    : None
*:----------------------------------------------------------------
*: Example    : = lfWipAdd()
*:----------------------------------------------------------------
FUNCTION lfWipAdd
PARAMETERS lcKey, lcFile, lcField, lnSign, laArrName
PRIVATE lnAlias

IF SEEK(lcKey, lcFile)
  llNewCon = UPPER(LEFT(lcField,1)) = "N"
  lcTotFld = IIF(llNewCon, "n", "") + "Tot" + ;
             IIF(llNewCon, RIGHT(lcField,LEN(lcField)-1), lcField)
  lnAlias  = SELECT(0)
  SELECT (lcFile)
  llNoThing = RLOCK()
  REPLACE &lcField.1  WITH &lcField.1 + (lnSign * &laArrName[1]) ,;
          &lcField.2  WITH &lcField.2 + (lnSign * &laArrName[2]) ,;
          &lcField.3  WITH &lcField.3 + (lnSign * &laArrName[3]) ,;
          &lcField.4  WITH &lcField.4 + (lnSign * &laArrName[4]) ,;
          &lcField.5  WITH &lcField.5 + (lnSign * &laArrName[5]) ,;
          &lcField.6  WITH &lcField.6 + (lnSign * &laArrName[6]) ,;
          &lcField.7  WITH &lcField.7 + (lnSign * &laArrName[7]) ,;
          &lcField.8  WITH &lcField.8 + (lnSign * &laArrName[8]) ,;
          &lcTotFld   WITH &lcField.1 + &lcField.2 + &lcField.3  +;
                           &lcField.4 + &lcField.5 + &lcField.6  +;
                           &lcField.7 + &lcField.8
  UNLOCk
  SELECT(lnAlias)
ENDIF

*:----------------------------------------------------------------
*: Name       : lfAddLine
*: Developer  : Yasser Mohammed Aly - (YMA)
*: Date       : 11/03/1997
*: Purpose    : Add new line in the CT to the master files.
*:----------------------------------------------------------------
*: Calls      : None.
*:----------------------------------------------------------------
*: Parameters : None.
*:----------------------------------------------------------------
*: Returns    : None
*:----------------------------------------------------------------
*: Example    : = lfAddLine()
*:----------------------------------------------------------------
FUNCTION lfAddLine
PRIVATE lnAlias

lnAlias    = SELECT(0)
llNoThing  = IIF(Empty(LineNo), lfGtNewLn(), .T.)
lcStDyKey  = Style + cWareCode + SPACE(10)

IF lfUpdBom()
  llRecSaved = .T.
  IF &lcTmpCutLn..nStep < 2
    llNoThing = lfWipAdd(Style    , "Style" , "Wip", 1, "laNewQty")
    llNoThing = lfUpdStp(lcTmpCutLn, 2)
  ENDIF
  
  IF &lcTmpCutLn..nStep < 3
    llNoThing = lfWipAdd(Style    , "Style" , "nWo", 1, "laNewQty")
    llNoThing = lfUpdStp(lcTmpCutLn, 3)
  ENDIF

  IF &lcTmpCutLn..nStep < 4
    llNoThing = lfWipAdd(lcStDyKey, "StyDye", "Wip", 1, "laNewQty")
    llNoThing = lfUpdStp(lcTmpCutLn, 4)
  ENDIF

  IF &lcTmpCutLn..nStep < 5
    llNoThing = lfWipAdd(lcStDyKey, "StyDye", "nWo", 1, "laNewQty")
    llNoThing = lfUpdStp(lcTmpCutLn, 5)
  ENDIF
      
  IF &lcTmpCutLn..nStep < 6
    SCATTER MEMVAR
    SELECT CutTktL
    APPEND BLANK
    GATHER MEMVAR
    *B804289,1 AMH Save prepack code & prepack qty. [Start]
    REPLACE PREPAK WITH m.cPrePack,;
            PPQTY  WITH m.nPrePack
    *B804289,1 AMH [End]
    
    *B607168,1 AMH Be sure that the cwarecode field not empty [Start]
    IF !llMultiWar .AND. EMPTY(CWARECODE)
      REPLACE CWARECODE WITH lcHedrWare
    ENDIF
    *B607168,1 AMH [End]
    
    llNoThing = lfUpdStp(lcTmpCutLn, 6)
  ENDIF    
  
ENDIF  

SELECT(lnAlias)

*:----------------------------------------------------------------
*: Name       : lfModLine
*: Developer  : Yasser Mohammed Aly - (YMA)
*: Date       : 11/03/1997
*: Purpose    : Modify a line in the CT in the master files.
*:----------------------------------------------------------------
*: Calls      : None.
*:----------------------------------------------------------------
*: Parameters : None.
*:----------------------------------------------------------------
*: Returns    : None
*:----------------------------------------------------------------
*: Example    : = lfModLine()
*:----------------------------------------------------------------
FUNCTION lfModLine
PRIVATE lnAlias

IF SEEK(laData[1]+Style+Dyelot+"1", "CutTktL")
  lnAlias  = SELECT(0)
  
  SELECT CutTktL
  SCATTER MEMVAR
  SCATTER FIELDS Qty1,Qty2,Qty3,Qty4,Qty5,Qty6,Qty7,Qty8 TO laOldQty
        
  DIMENSION laWip[9], laTrn[9]
  STORE 0 TO laWip, laTrn
        
  IF lfUpdBom()
    llNoThing  = SEEK(m.CutTkt+m.Style+m.Dyelot+"1", lcMastrLin)
    lcNewWare  = &lcTmpCutLn..cWareCode
    lcOldWare  = m.cWareCode
    lcOldKey   = m.Style + lcOldWare + SPACE(10)
    lcNewKey   = m.Style + lcNewWare + SPACE(10)
    llNoThing  = lfFillArr()
    
    IF &lcTmpCutLn..nStep < 2
      llNoThing = lfWipMod("Style" , m.Style , "laNewQty")
      llNoThing = lfUpdStp(lcTmpCutLn, 2)
    ENDIF  
    
    IF &lcTmpCutLn..nStep < 3
      llNoThing = lfWipAdd(m.Style , "Style" , "nWo", -1, "laOldQty")
      llNoThing = lfUpdStp(lcTmpCutLn, 3)
    ENDIF  

    IF &lcTmpCutLn..nStep < 4
      llNoThing = lfWipAdd(m.Style , "Style" , "nWo", +1, "laNewQty")
      llNoThing = lfUpdStp(lcTmpCutLn, 4)
    ENDIF  
    
    IF &lcTmpCutLn..nStep < 5
      llNoThing  = lfWipAdd(lcOldKey, "StyDye", "nWo", -1, "laOldQty")
      llNoThing = lfUpdStp(lcTmpCutLn, 5)
    ENDIF  

    IF &lcTmpCutLn..nStep < 6
      llNoThing  = lfWipAdd(lcNewKey, "StyDye", "nWo", +1, "laNewQty")
      llNoThing = lfUpdStp(lcTmpCutLn, 6)
    ENDIF  

    IF lcNewWare = lcOldWare
      IF &lcTmpCutLn..nStep < 7
        llNoThing = lfWipMod("StyDye", lcOldKey, "laNewQty")
        llNoThing = lfUpdStp(lcTmpCutLn, 7)
      ENDIF  
    ELSE
      IF &lcTmpCutLn..nStep < 7
        llNoThing = lfWipAdd(lcOldKey, "StyDye", "Wip", -1, "laOldQty")
        llNoThing = lfUpdStp(lcTmpCutLn, 7)
      ENDIF  

      IF &lcTmpCutLn..nStep < 8
        llNoThing = lfWipAdd(lcNewKey, "StyDye", "Wip", +1, "laNewQty")
        llNoThing = lfUpdStp(lcTmpCutLn, 8)
      ENDIF  
    ENDIF
  
    SELECT (lcTmpCutLn)
    SCATTER MEMVAR
    SELECT CutTktL
    GATHER MEMVAR

    *B804289,1 AMH Save prepack code & prepack qty. [Start]
    REPLACE PREPAK WITH m.cPrePack,;
            PPQTY  WITH m.nPrePack
    *B804289,1 AMH [End]
  
    *B607168,1 AMH Be sure that the cwarecode field not empty [Start]
    IF !llMultiWar .AND. EMPTY(CWARECODE)
      REPLACE CWARECODE WITH lcHedrWare
    ENDIF
    *B607168,1 AMH [End]
    
    IF &lcTmpCutLn..nStep < 9
      llNoThing = IIF(llSOInstad, lfModCtPk(), .T.)
      llNoThing = lfUpdStp(lcTmpCutLn, 9)
    ENDIF
    
  ENDIF
  
  SELECT(lnAlias)
ENDIF

*:----------------------------------------------------------------
*: Name       : lfModCtPk
*: Developer  : Yasser Mohammed Aly - (YMA)
*: Date       : 11/03/1997
*: Purpose    : Modify the allocated order lines.
*:----------------------------------------------------------------
*: Calls      : None.
*:----------------------------------------------------------------
*: Parameters : None.
*:----------------------------------------------------------------
*: Returns    : None
*:----------------------------------------------------------------
*: Example    : = lfModCtPk()
*:----------------------------------------------------------------
FUNCTION lfModCtPk
PRIVATE lnAlias

lnAlias    = SELECT(0)
lnODelStat = SET ("DELETE")
SET DELETE OFF

IF SEEK (&lcTmpCutLn..Style, lcTmpCtPk)
  SELECT (lcTmpCtPk)
  SCAN REST WHILE Style+Order+cOrdLine = &lcTmpCutLn..Style 
    lcStyle   = Style
    lcOrder   = Order
    lcOrdLine = cOrdLine
    SCATTER TO laNewRec
        
    
    *E301182,5 03/30/99 YMA Get the line number from the cuttktl file, and use it
    *E301182,5 03/30/99 YMA to get the correct records from the CUTPICK file.    
    lcLineNo  = STR(&lcTmpCutLn..LineNo, 6)
    IF SEEK("1"+laData[1]+lcLineNo+lcOrder+lcStyle+lcOrdLine, "CutPick")
*   IF SEEK("1"+laData[1]+lcOrder+lcStyle+lcOrdLine, "CutPick")
    *E301182,5 03/30/99 YMA End.
    
      llFound = .T.
      SELECT CutPick
      IF DELETED()
       *E301182,5 03/30/99 YMA Use the cuttkt line number.
       *LOCATE REST WHILE TranCD+CtktNo+Order+Style+cOrdLine =    ;
                          "1"+laData[1]+lcOrder+lcStyle+lcOrdLine ;
                          FOR !DELETED()
        LOCATE REST WHILE TranCD+CtktNo+Order+Style+cOrdLine =    ;
                          "1"+laData[1]+lcLineNo+lcOrder+lcStyle+lcOrdLine ;
                          FOR !DELETED()
       *E301182,5 03/30/99 YMA End.                   
                          
        llFound = FOUND()
      ENDIF                    
      
      IF llFound
        SELECT OrdHdr
        IF SEEK("O"+CutPick.Order)
          llNoThing = RLOCK()
          REPLACE TotCut WITH TotCut-CutPick.TotQty+&lcTmpCtPk..TotQty
          UNLOCK
        ENDIF
          
        SELECT OrdLine
        IF SEEK("O"+lcOrder+lcOrdLine)
          llNoThing = RLOCK()
          REPLACE Cut1   WITH Cut1 - CutPick.Qty1 + &lcTmpCtPk..Qty1 ,;
                  Cut2   WITH Cut2 - CutPick.Qty2 + &lcTmpCtPk..Qty2 ,;
                  Cut3   WITH Cut3 - CutPick.Qty3 + &lcTmpCtPk..Qty3 ,;
                  Cut4   WITH Cut4 - CutPick.Qty4 + &lcTmpCtPk..Qty4 ,;
                  Cut5   WITH Cut5 - CutPick.Qty5 + &lcTmpCtPk..Qty5 ,;
                  Cut6   WITH Cut6 - CutPick.Qty6 + &lcTmpCtPk..Qty6 ,;
                  Cut7   WITH Cut7 - CutPick.Qty7 + &lcTmpCtPk..Qty7 ,;
                  Cut8   WITH Cut8 - CutPick.Qty8 + &lcTmpCtPk..Qty8 ,;
                  TotCut WITH TotCut-CutPick.TotQty + &lcTmpCtPk..TotQty
          UNLOCK
        ENDIF
        
        SELECT CutTktH
        llNoThing = RLOCK()
        REPLACE TotOrd WITH TotOrd - CutPick.TotQty + &lcTmpCtPk..TotQty
        UNLOCK
        
        SELECT CutPick
        GATHER FROM laNewRec
        IF TotQty = 0
          DELETE
        ENDIF
      ENDIF
            
    ENDIF
  ENDSCAN

  SELECT(lnAlias)
ENDIF

SET DELETE &lnODelStat

*:----------------------------------------------------------------
*: Name       : lfDone
*: Developer  : Yasser Mohammed Aly - (YMA)
*: Date       : 11/03/1997
*: Purpose    : Take the last actions to be taken when creating 
*:              new CT
*:----------------------------------------------------------------
*: Calls      : None.
*:----------------------------------------------------------------
*: Parameters : None.
*:----------------------------------------------------------------
*: Returns    : None
*:----------------------------------------------------------------
*: Example    : = lfDone()
*:----------------------------------------------------------------
FUNCTION lfDone
PRIVATE lnAlias

lnAlias  = SELECT(0)
IF llRecSaved

  SHOW GET laData[1]
  SELECT CutTktH
  APPEND BLANK
  GATHER FROM laData FIELDS &lcScFields
    
  *C102094,1 AMH Add customized trigger for Cathy Daniels to save [Start]
  *C102094,1 AMH the customized fields.
  IF ASCAN(laEvntTrig , PADR('SAVCTFLD',10)) <> 0
    =gfDoTriger('MFCUTKT',PADR('SAVCTFLD',10))
  ENDIF     
  *C102094,1 AMH [End]

  = IIF(llEdtCTNum,.T.,gfModalGen("INM38050B00000","",laData[1]))

  *--B602753,1 HDM 04/07/1999[Start] Stop Calling NotePad Program In lpSavScr as the global save
  *--                         Will Call it
  *= IIF(gfModalGen("QRM00271B00006") = 1, NotePad('I',laData[1]), .T.)
  *--B602753,1 HDM 04/07/1999[End]

  llGoToBom = .F.
  DO CASE
    *E301085,1 Generate cost sheet automatically
    *CASE lcGnCTBom = "A"               && Always
    CASE INLIST(lcGnCTBom,"A","T")      && Always/Automatic
    *E301085,1 (End)

      llGoToBom = .T.

    CASE lcGnCTBom = "M"              && Manual
      llGoToBom = .F.

    CASE lcGnCTBom = "S"              && Ask
      *-- Would you like to create the cutting ticket cost sheet ?
      *-- < Yes > < No >
      llGoToBom = gfModalGen('QRM38115B38006') = 1
  ENDCASE
  IF llGoToBom
    IF SEEK(ALLTRIM(laData[2]), "Bom")
      *E301085,1 Generate cost sheet automatically
      *lcParameter = "'M','" + laData[1] + "'"
      lcParameter = "'M','" + laData[1] + "'"+IIF(lcGnCTBom="T",",.T.",',.F.')
      *E301085,1 (End)
      DO gpDoProg WITH "AWRMFCSSH", .F., "MF", lcParameter
      llShow = .F.
    ELSE
      *-- XXXXXXXXXX cost sheet not found for XXXXXXXXXX : 'XXXXXXXXXX'. 
      *-- Cannot proceed with the cutting ticket cost sheet.
      *-- < Ok >
      lcStr      = PROPER(ALLTRIM(lcMjrTtl)) + "|" +;
                   PROPER(ALLTRIM(lcMjrTtl)) + "|" +;
                   ALLTRIM(laData[2])
      = gfModalGen("TRM38095B00000","DIALOG",lcStr)
    ENDIF
  ENDIF
  
ELSE
  *-- Total pieces is zero. Tansaction cancelled.
  = gfModalGen("INM38051B00000")
ENDIF
SELECT(lnAlias)
  
*:----------------------------------------------------------------
*: Name       : lfDelLine
*: Developer  : Yasser Mohammed Aly - (YMA)
*: Date       : 11/03/1997
*: Purpose    : Delete line in the CT in the master files.
*:----------------------------------------------------------------
*: Calls      : None.
*:----------------------------------------------------------------
*: Parameters : None.
*:----------------------------------------------------------------
*: Returns    : None
*:----------------------------------------------------------------
*: Example    : = lfDelLine()
*:----------------------------------------------------------------
FUNCTION lfDelLine

IF SEEK(laData[1]+Style+Dyelot+"1", "CutTktL")
  llNoThing = lfUpdBom()
  lcStDyKey = CutTktL.Style + CutTktL.cWareCode + SPACE(10)
  lcStyeKey = CutTktL.Style

  IF &lcTmpCutLn..nStep < 2
    llNoThing = lfWipAdd(lcStyeKey, "Style" , "Wip", -1, "laNewQty")
    llNoThing = lfUpdStp(lcTmpCutLn, 2)
  ENDIF

  IF &lcTmpCutLn..nStep < 3
    llNoThing = lfWipAdd(lcStyeKey, "Style" , "nWo", -1, "laNewQty")
    llNoThing = lfUpdStp(lcTmpCutLn, 3)
  ENDIF
  
  IF &lcTmpCutLn..nStep < 4
    llNoThing = lfWipAdd(lcStDyKey, "StyDye", "Wip", -1, "laNewQty")
    llNoThing = lfUpdStp(lcTmpCutLn, 4)
  ENDIF

  IF &lcTmpCutLn..nStep < 5
    llNoThing = lfWipAdd(lcStDyKey, "StyDye", "nWo", -1, "laNewQty")
    llNoThing = lfUpdStp(lcTmpCutLn, 5)
  ENDIF
  
  IF &lcTmpCutLn..nStep < 6
    llNoThing = IIF(llSOInstad, lfModCtPk(), .T.)
    llNoThing = lfUpdStp(lcTmpCutLn, 6)
  ENDIF

  IF &lcTmpCutLn..nStep < 7
    SELECT CutTktL
    llNoThing = RLOCK()
    BLANK
    UNLOCK
    DELETE NEXT 1
    llNoThing = lfUpdStp(lcTmpCutLn, 7)
  ENDIF
ENDIF

*:----------------------------------------------------------------
*: Name       : lfUpdBom
*: Developer  : Yasser Mohammed Aly - (YMA)
*: Date       : 11/03/1997
*: Purpose    : Update the master BomLine, CtktBom file for the
*:              currently edited cutting ticket if it has a cost
*:              sheet, that's in case of Add, Modify, Delete a
*:              cutting ticket line, and upon saving to the master
*:              files.
*:----------------------------------------------------------------
*: Calls      : None.
*:----------------------------------------------------------------
*: Parameters : None.
*:----------------------------------------------------------------
*: Returns    : None
*:----------------------------------------------------------------
*: Example    : = lfUpdBom()
*:----------------------------------------------------------------
FUNCTION lfUpdBom
PRIVATE lnAlias

lnAlias  = SELECT(0)
llRetVal = .T.
IF laScrMode[3] AND laData[3] = "O"
  
  *-- Prepare the sent parameters to the global function.
  llNoThing  = SEEK("M"+laData[1], "CTktBom") 
  llNoThing  = SEEK(laData[1]    , "CutTktH")
  lcLinkCode = CTktBom.Link_Code
  *B602124,1 Get cuttkt line no in cost sheet files
  lnLineNo   = &lcTmpCutLn..LineNo
  lcStyle    = &lcTmpCutLn..Style
  lcDyelot   = &lcTmpCutLn..Dyelot
  lcWareCode = &lcTmpCutLn..cWareCode
  lcLastOpr  = CutTktH.cLastOpr
  lcAction   = &lcTmpCutLn..cStatus
  

  *B602981,1 03/30/99 TAK (Begin) opened the FABDYE to fix the 
  *B602981,1              ALIAS NOT FOUND bug when editing an open CT. 
  =gfOpenFile(gcDataDir+'FABDYE',gcDataDir+'FABDYE','SH')
  *B602981,1 03/30/99 TAK (End)

  *-- The array to be sent to the global function should hold
  *-- the new values - the old values
  SELECT (lcTmpCutLn)
  SCATTER FIELDS Qty1,Qty2,Qty3,Qty4,Qty5,Qty6,Qty7,Qty8,TotQty TO laBomQty
  laBomQty[9] = 0
  IF lcAction = "D"
    laBomQty = 0
  ENDIF
  
  FOR lnSize = 1 TO 8
    IF lcAction # "A"
      lcField = "CutTktL.Qty" + STR(lnSize,1)
      laBomQty[lnSize] = laBomQty[lnSize] - &lcField
    ENDIF
    laBomQty[9] = laBomQty[9] + laBomQty[lnSize]
  ENDFOR
  
  IF &lcTmpCutLn..nStep < 1

    *E301077,56 YM 03/03/99 Start - Open the BomLine file.
    = gfOpenFile(gcDataDir+"BomLine","BomLine","SH")
    *E301077,56 YM 03/03/99 End.


    *-- Call the global function.
   *B602124,1 Update cuttkt line no in cost sheet files
   *llRetVal = gfSheetItem ("M"      , laData[1] , lcLinkCode, lcStyle    ,;
                            ""       , 0         , lcDyelot  , CutTktH.cItemWare,;
                            CutTktH.cMatWare,@laBomQty, "Bom"     , "CtktBom"  ,;
                            "BomLine", "MFGOprHd", lcLastOpr ,;
                            0, 0, 0, 0, 0, 0,lcCTChWin2)
   
   *B606496,1 AMH Fix the bug of Incorrect PO Cost Sheet required qty because of using the bom file
   *B606496,1     instead of bomline. If its a new line then we will use the bom file, otherwise
   *B606496,1     we will simulate the bom file from the bomline[Start]
   *llRetVal = gfSheetItem ("M"      , laData[1] , lcLinkCode, lcStyle    ,;
                            ""       , lnLineNo , lcDyelot  , CutTktH.cItemWare,;
                            CutTktH.cMatWare,@laBomQty, "Bom"     , "CtktBom"  ,;
                            "BomLine", "MFGOprHd", lcLastOpr ,;
                            0, 0, 0, 0, 0, 0,lcCTChWin2)
   IF lcAction = "A"
     llRetVal = gfSheetItem ("M"      , laData[1] , lcLinkCode, lcStyle    ,;
                              ""       , lnLineNo , lcDyelot  , CutTktH.cItemWare,;
                              CutTktH.cMatWare,@laBomQty, "Bom"     , "CtktBom"  ,;
                              "BomLine", "MFGOprHd", lcLastOpr ,;
                              0, 0, 0, 0, 0, 0,lcCTChWin2)
   ELSE
     =lfModBom()
   ENDIF
   *B606496,1 AMH [End]
   
   *B602124,1 (End)

    llNoThing = lfUpdStp(lcTmpCutLn, 1)
  ENDIF
ENDIF

SELECT (lnAlias)
RETURN (llRetVal)

* ----------------------------------------------------------------

FUNCTION lfvCTGnLns
PRIVATE lnAlias

lnAlias    = SELECT()
llView     = IIF(laScrMode[3], SEEK(laData[2], lcTmpCtPk), .F.)
lcRetFile  = gfTempName()
llGnRetVal = .F.
lnCtHdrRec = RECNO("CutTktH")
*--E301410,1 RAMY [start]  
*DO (gcAppHome+"MFGenLns") with  ;
        llView,"M",lcTmpCutLn,"Style","",;
        "Dyelot","cWareCode","Qty","TotQty",lcRetFile

*B605229,1 KHM 12/11/2001 (Begin) Check if the CutPick file is not open
*B605229,1                the open it.
IF !USED("CutPick")
  = gfOpenFile(gcDataDir+"CutPick","CutPick","SH")
ENDIF  
*B605229,1 KHM 12/11/2001 (End)

SELECT CUTPICK
lcFilter = FILTER()
SET FILTER TO

DO (gcAppHome+"MFGenLns") WITH llView,"M",lcTmpCutLn,"Style","",;
                      "Dyelot","cWareCode","Qty","TotQty",lcRetFile,lcTmpCtPk

SELECT CUTPICK
*lcOrderKy  = "1" + lcCutTkt + CutTktL.Style
SET FILTER TO TranCD+CtktNo+Style = (lcOrderKy)
*--E301410,1 RAMY [end]

IF lnCtHdrRec > 0 AND lnCtHdrRec <= RECCOUNT("CutTktH")
  GOTO lnCtHdrRec IN CutTktH
ENDIF

IF llGnRetVal
  STORE 0 TO laData[19], laData[20], laData[21],;
             laData[22], laData[23], laData[12],;
             laData[17], laData[16], laData[15],;
             laData[35]
  *--new  
  *SELECT (lcTmpCutLn)
  *BLANK ALL
  *DELETE ALL
  *APPEND FROM (gcWorkDir+lcRetFile)
  SELECT (lcRetFile)
  SCAN
    IF SEEK(Style,lcTmpCutLn)
      SELECT (lcRetFile)
      SCATTER FIELDS QTY1 , QTY2 , QTY3 , QTY4 , QTY5 , QTY6 , QTY7 , QTY8 , TOTQTY , Ord1 , Ord2 , Ord3 , Ord4 , Ord5 , Ord6 , Ord7 , Ord8 , TOTOrd TO MEMVAR MEMO
      SELECT (lcTmpCutLn)
      GATHER FIELDS QTY1 , QTY2 , QTY3 , QTY4 , QTY5 , QTY6 , QTY7 , QTY8 , TOTQTY , Ord1 , Ord2 , Ord3 , Ord4 , Ord5 , Ord6 , Ord7 , Ord8 , TOTOrd FROM MEMVAR MEMO
    ENDIF
  ENDSCAN
  
  
  SELECT (lcTmpCutLn)
  SCAN
    llNoThing = RLOCK()
    REPLACE nCost1  WITH nMCost1 ,;
            nCost2  WITH nMCost2 ,;
            nCost3  WITH nMCost3 ,;
            nCost4  WITH nMCost4 ,;
            nCost5  WITH nMCost5 ,;
            cStatus WITH IIF(cStatus = "A", "A", "M")
    UNLOCK
    
    llNoThing = lfUpdHEst(TotQty, 1)
    llNewLine = laScrMode[4] OR &lcTmpCutLn..cStatus = "A"
    lnOldTot  = 0
    lnNewTot  = TotQty
    
    IF llNewLine
      laData[12] = laData[12] - lnOldTot + lnNewTot
      laData[17] = laData[17] - lnOldTot + lnNewTot
    ELSE
      IF laData[3] = "A"
        lnNewAct = laData[16]-(lnOldTot-lnNewTot)
        IF laData[16] <= lnNewAct
          laData[17] = laData[17] + (lnNewAct - laData[16])
          laData[16] = lnNewAct
        ELSE
          laData[15] = laData[15] + (laData[16] - lnNewAct)
          laData[17] = laData[17] - (laData[16] - lnNewAct)
        ENDIF
      ELSE
        lnNewBud = laData[12]-(lnOldTot-lnNewTot)
        IF laData[12] <= lnNewBud
          laData[17] = laData[17] + (lnNewBud - laData[12])
          laData[12] = lnNewBud
        ELSE
          laData[15] = laData[15] + (laData[12]-lnNewBud)
          laData[35] = laData[35] + (laData[12]-lnNewBud)
          laData[17] = laData[17] - (laData[12]-lnNewBud)
        ENDIF
      ENDIF
    ENDIF
    
  ENDSCAN
  
  IF laData[17] = 0
    laData[3]    = IIF(laData[13] > 0, "C", "X")
    llNoThing    = lfSetStat(laData[3])
    lcPromp      = IIF(laData[3]="X", lcUnCanc, lcCancel) 
    
    *B606657,1 AMH Fix the bug of Cannot cancel open C/T [Start]
    *lcCanStat    = "DISABLE"
    lcCanStat    = IIF(laData[3]$"OHX", "ENABLE", "DISABLE")
    *B606657,1 AMH [End]
    
    llNoThing    = lfRefresh() AND lfStDelBar()
    lcEdtStat    = "DISABLE"
    laCtrStat[7] = lcEdtStat
    SHOW GET pbEdt &lcEdtStat
  ENDIF
ENDIF

SELECT (lcTmpCutLn)

*B603317,1 [
*GOTO TOP
LOCATE
*B603317,1 [

llNoThing = lfwLnBrow() AND lfRefresh(lcCTChWin5)

SELECT(lnAlias)


*:----------------------------------------------------------------
*: Name       : lfCrtTmpLn
*: Developer  : Yasser Mohammed Aly - (YMA)
*: Date       : 02/21/98
*: Purpose    : To create the program temp file.
*:----------------------------------------------------------------
*: Parameters : None.
*:----------------------------------------------------------------
*: Returns    : None.
*:----------------------------------------------------------------
*: Example    : = lfCrtTmpLn()
*:----------------------------------------------------------------
FUNCTION lfCrtTmpLn
PRIVATE lnAlias

lnAlias = SELECT(0)

*-- Read the Cutting ticket line structure into an array.
SELECT CutTktL
lnCtLnFlds = AFIELDS(laCtLnFlds)

*-- The "nStep" field is to handel the incomplete session.
lnCtLnFlds = lnCtLnFlds + 1
DIMENSION laCtLnFlds[lnCtLnFlds, 4]
laCtLnFlds[lnCtLnFlds, 1] = "nStep"
laCtLnFlds[lnCtLnFlds, 2] = "N"
laCtLnFlds[lnCtLnFlds, 3] = 2
laCtLnFlds[lnCtLnFlds, 4] = 0

lnCtLnFlds = lnCtLnFlds + 1
DIMENSION laCtLnFlds[lnCtLnFlds, 4]
laCtLnFlds[lnCtLnFlds, 1] = "Scale"
laCtLnFlds[lnCtLnFlds, 2] = "C"
laCtLnFlds[lnCtLnFlds, 3] = 3
laCtLnFlds[lnCtLnFlds, 4] = 0

lnCtLnFlds = lnCtLnFlds + 1
DIMENSION laCtLnFlds[lnCtLnFlds, 4]
laCtLnFlds[lnCtLnFlds, 1] = "nPrePack"
laCtLnFlds[lnCtLnFlds, 2] = "N"
laCtLnFlds[lnCtLnFlds, 3] = 3
laCtLnFlds[lnCtLnFlds, 4] = 0

lnCtLnFlds = lnCtLnFlds + 1
DIMENSION laCtLnFlds[lnCtLnFlds, 4]
laCtLnFlds[lnCtLnFlds, 1] = "cPrePack"
laCtLnFlds[lnCtLnFlds, 2] = "C"
laCtLnFlds[lnCtLnFlds, 3] = 1
laCtLnFlds[lnCtLnFlds, 4] = 0

lnCtLnFlds = lnCtLnFlds + 1
DIMENSION laCtLnFlds[lnCtLnFlds, 4]
laCtLnFlds[lnCtLnFlds, 1] = "cStatus"
laCtLnFlds[lnCtLnFlds, 2] = "C"
laCtLnFlds[lnCtLnFlds, 3] = 1
laCtLnFlds[lnCtLnFlds, 4] = 0

lnCtLnFlds = lnCtLnFlds + 1
DIMENSION laCtLnFlds[lnCtLnFlds, 4]
laCtLnFlds[lnCtLnFlds, 1] = "cDefWare"
laCtLnFlds[lnCtLnFlds, 2] = "C"
laCtLnFlds[lnCtLnFlds, 3] = 6
laCtLnFlds[lnCtLnFlds, 4] = 0

lnCtLnFlds = lnCtLnFlds + 1
DIMENSION laCtLnFlds[lnCtLnFlds, 4]
laCtLnFlds[lnCtLnFlds, 1] = "DyeYN"
laCtLnFlds[lnCtLnFlds, 2] = "C"
laCtLnFlds[lnCtLnFlds, 3] = 1
laCtLnFlds[lnCtLnFlds, 4] = 0

lnCtLnFlds = lnCtLnFlds + 1
DIMENSION laCtLnFlds[lnCtLnFlds, 4]
laCtLnFlds[lnCtLnFlds, 1] = "nMCost1"
laCtLnFlds[lnCtLnFlds, 2] = "N"
laCtLnFlds[lnCtLnFlds, 3] = 9
laCtLnFlds[lnCtLnFlds, 4] = 2

lnCtLnFlds = lnCtLnFlds + 1
DIMENSION laCtLnFlds[lnCtLnFlds, 4]
laCtLnFlds[lnCtLnFlds, 1] = "nMCost2"
laCtLnFlds[lnCtLnFlds, 2] = "N"
laCtLnFlds[lnCtLnFlds, 3] = 9
laCtLnFlds[lnCtLnFlds, 4] = 2

lnCtLnFlds = lnCtLnFlds + 1
DIMENSION laCtLnFlds[lnCtLnFlds, 4]
laCtLnFlds[lnCtLnFlds, 1] = "nMCost3"
laCtLnFlds[lnCtLnFlds, 2] = "N"
laCtLnFlds[lnCtLnFlds, 3] = 9
laCtLnFlds[lnCtLnFlds, 4] = 2

lnCtLnFlds = lnCtLnFlds + 1
DIMENSION laCtLnFlds[lnCtLnFlds, 4]
laCtLnFlds[lnCtLnFlds, 1] = "nMCost4"
laCtLnFlds[lnCtLnFlds, 2] = "N"
laCtLnFlds[lnCtLnFlds, 3] = 9
laCtLnFlds[lnCtLnFlds, 4] = 2

lnCtLnFlds = lnCtLnFlds + 1
DIMENSION laCtLnFlds[lnCtLnFlds, 4]
laCtLnFlds[lnCtLnFlds, 1] = "nMCost5"
laCtLnFlds[lnCtLnFlds, 2] = "N"
laCtLnFlds[lnCtLnFlds, 3] = 9
laCtLnFlds[lnCtLnFlds, 4] = 2

*-- Create the temp file.
llNoThing = gfCrtTmp(lcTmpCutLn, @laCtLnFlds,;
            [Style+cWareCode+Dyelot], lcTmpCutLn)

*E301869,1 HBG 07/04/2002 Creating the temp files nedded in generating project[Begin]  
IF lcGenProj $ 'AI'
  =lfCrtprjTm()
ENDIF
*E301869,1 [End]

SELECT(lnAlias)

*:----------------------------------------------------------------
*: Name       : lfChkUnComS
*: Developer  : Yasser Mohammed Aly - (YMA)
*: Date       : 02/21/98
*: Purpose    : To check if there is any privous incomplete 
*:              session for the program.
*:----------------------------------------------------------------
*: Parameters : None.
*:----------------------------------------------------------------
*: Returns    : .T. -> Yes I found a privous incomplete session.
*:              .F. -> No I did not find any privous incomplete 
*:                     session.
*:----------------------------------------------------------------
*: Example    : = lfChkUnComS()
*:----------------------------------------------------------------
FUNCTION lfChkUnComS
PRIVATE llFondSess, lnAlias

*E301077,56 YM 03/03/99 Start - Open the UnCmSess file.
= gfOpenFile(gcDataDir+"UnCmSess","TRANS","SH")
*E301077,56 YM 03/03/99 End.

*-- Is there any previous incomplete program session ???
IF gfUnCompSession(lcProgID, lnThisSess, "Cutting Ticket")
  *-- If yes, please tell me where did we stop in that session..
  llFondSess = .T.
  lcCurObj   = ALLTRIM(UnCmSess.cCurrObj)
  llNoThing  = lfRestVar()
  SHOW GETS
  IF !EMPTY(lcCurObj)
    _CUROBJ = OBJNUM(&lcCurObj)
    KEYBOARD "{ENTER}" PLAIN CLEAR
  ENDIF
ELSE
  *-- If there is no incomplete session, please create the temp
  *-- files.
  llNoThing  = lfCrtTmpLn()
  llFondSess = .F.
ENDIF

*-- Do all the needed browses..
lnAlias    = SELECT(0)
llNoThing  = lfBldCont() AND lfCnBrowse()
lcFile     = IIF(laScrMode[1] OR laScrMode[2], "CutTktL", lcTmpCutLn)
SELECT (lcFile)

*B603317,1 [
*GOTO TOP
LOCATE
*B603317,1 [

llNoThing = lfLnBrowse() AND lfwLnBrow()
SELECT(lnAlias)

RETURN (llFondSess)

*:----------------------------------------------------------------
*: Name       : lfRestVar
*: Developer  : Yasser Mohammed Aly - (YMA)
*: Date       : 02/21/98
*: Purpose    : Reset the needed variables when finding any previous
*:              incomplete session.
*:----------------------------------------------------------------
*: Parameters : None.
*:----------------------------------------------------------------
*: Returns    : None.
*:----------------------------------------------------------------
*: Example    : = lfRestVar()
*:----------------------------------------------------------------
FUNCTION lfRestVar

laScrMode  = .F.
laScrMode[ATC(lcScrMode,"SVEA")] = .T.
llCUpdate  = .T.
llContinue = .T.
lcSession  = UnCmSess.cSession
llNoThing  = IIF(laScrMode[3], SEEK(laData[1], "CutTktH"), .T.)
llRefPage2 = .T.
llNoThing  = gfwCodePop(@laCodeInfo, "SEASON", "V,"+laData[09])
llNoThing  = lfBldDiv(.F.)
llNoThing  = lfChngFolder(lnActFolder)

*:----------------------------------------------------------------
*: Name       : lfAdUnCmSR
*: Developer  : Yasser Mohammed Aly - (YMA)
*: Date       : 02/21/98
*: Purpose    : To add an incomplete session record.
*:----------------------------------------------------------------
*: Parameters : None.
*:----------------------------------------------------------------
*: Returns    : None.
*:----------------------------------------------------------------
*: Example    : = lfAdUnCmSR()
*:----------------------------------------------------------------
FUNCTION lfAdUnCmSR
PRIVATE lnAlias

lnAlias = SELECT(0)

*E301077,56 YM 03/03/99 Start - Open the UnCmSess file.
= gfOpenFile(gcDataDir+"UnCmSess","TRANS","SH")
*E301077,56 YM 03/03/99 End.

*-- Look for any record with the status "Initial".
SELECT UnCmSess
IF !SEEK('I')
  *-- If you do not find any, please add a new record.
  APPEND BLANK
ENDIF

*-- Save teh record number..
lnUnCmSeRc = RECNO()

*-- Be sure to blank the record..
BLANK

*-- Update the record with my program information.
REPLACE Status     WITH 'O'       ,;
        cUTranType WITH lcProgID  ,;
        cProgram   WITH lcProgID  ,;
        cCurrScr   WITH lcProgID  ,;
        cUserId    WITH gcUser_id ,;
        cSession   WITH lcSession ,;
        cCurrObj   WITH SPACE(0)  ,;
        dTranDate  WITH gdSysDate ,;
        cTranTime  WITH TIME()
llNoThing = lfUpdVars()
llNoThing = RLOCK()

SELECT(lnAlias)

*:----------------------------------------------------------------
*: Name       : lfUpdUnCmS
*: Developer  : Yasser Mohammed Aly - (YMA)
*: Date       : 02/21/98
*: Purpose    : To update the incomplete session record.
*:----------------------------------------------------------------
*: Parameters : lcStatus : Update the record with this status.
*:              lcCurObj : Update the record with this object name.
*:              llSetCon : Lock\Unlock the record.
*:----------------------------------------------------------------
*: Returns    : None.
*:----------------------------------------------------------------
*: Example    : = lfUpdUnCmS()
*:----------------------------------------------------------------
FUNCTION lfUpdUnCmS
PARAMETERS lcStatus, lcCurObj, llSetCon
PRIVATE lnAlias

*-- If there is an incomplete session record for this session..
IF lnUnCmSeRc <> 0
  lnAlias  = SELECT(0)
  lcStatus = UPPER(LEFT(lcStatus,1))

  *-- Go and update it..
  SELECT UnCmSess
  GOTO lnUnCmSeRc
  UNLOCK
  REPLACE cCurrObj WITH lcCurObj ,;
          Status   WITH lcStatus
  llNoThing = RLOCK()

  *-- If you are asked to unlock the record, please do..
  IF !llSetCon
    UNLOCK 
  ENDIF

  SELECT(lnAlias)
ENDIF

*:----------------------------------------------------------------
*: Name       : lfUpdVars
*: Developer  : Yasser Mohammed Aly - (YMA)
*: Date       : 02/21/98
*: Purpose    : To update the incomplete session record with the
*:              needed files names and variables.
*:----------------------------------------------------------------
*: Parameters : None.
*:----------------------------------------------------------------
*: Returns    : None.
*:----------------------------------------------------------------
*: Example    : = lfUpdVars()
*:----------------------------------------------------------------
FUNCTION lfUpdVars
PRIVATE lnAlias

IF lnUnCmSeRc # 0
  *-- Build the files names string.
  lcFiles = "lcTmpCutLn," + lcTmpCutLn + ","   + ORDER(lcTmpCutLn) + "; "

  *-- If the temp sales commeission file is used, please include
  *-- it in the files string.
  IF USED(lcTmpCtPk)
    lcFiles = lcFiles +;
            "lcTmpCtPk," + lcTmpCtPk + ","   + ORDER(lcTmpCtPk) + "; "
  ENDIF

  *-- Go and update the incomplete session record.
  llNoThing = gfSavSess(lcProgID, lcFiles, @laVars, lcSession)
ENDIF

*:----------------------------------------------------------------
*: Name       : lfUpdStp
*: Developer  : Yasser Mohammed Aly - (YMA)
*: Date       : 02/21/98
*: Purpose    : To update the nStep field in a specific temp file..
*:----------------------------------------------------------------
*: Parameters : lcFileName : Please update this file.
*:              lnStepNo   : Please update the step field with this
*:                           number.
*:----------------------------------------------------------------
*: Returns    : None.
*:----------------------------------------------------------------
*: Example    : = lfUpdStp("ARHIST", 1)
*:----------------------------------------------------------------
FUNCTION lfUpdStp
PARAMETERS lcFileName, lnStepNo
PRIVATE lnAlias

lnAlias = SELECT(0)
SELECT (lcFileName)
*-- Update the needed file with the new step number..
llNoThing  = RLOCK()
REPLACE nStep WITH lnStepNo
UNLOCK
SELECT(lnAlias)

*:----------------------------------------------------------------
*: Name       : lfBldDiv
*: Developer  : Yasser Mohammed Aly - (YMA)
*: Date       : 02/21/98
*: Purpose    : 
*:----------------------------------------------------------------
*: Parameters : llSet : 
*:----------------------------------------------------------------
*: Returns    : None.
*:----------------------------------------------------------------
*: Example    : = lfBldDiv()
*:----------------------------------------------------------------
FUNCTION lfBldDiv
PARAMETERS llSet
PRIVATE lnAlias

*E301077,56 YMA 03/03/99 Start - Open the codes file.
= gfOpenFile(gcDataDir+"Codes","Codes","SH")
*E301077,56 YMA 03/03/99 End.

DIMENSION laDivision[1,2]
laDivision = SPACE(0)
lnAlias    = SELECT(0)
lcSeprat   = SPACE(1) + "-" + SPACE(1)
lnFW       = 0
llIsEditbl = gfIsEdtble("CDIVISION", @lnFW, gcAct_Comp)

SELECT Codes
lcTag = TAG()
SET ORDER TO TAG Codes

SELECT STYLE

*B801910,1 YMA 03/07/99 Save the initial style record.
lcStyExp = Style
*B801910,1 YMA 03/07/99 End.

IF SEEK(laData[2],"Style")
  SCAN REST WHILE cStyMajor = laData[2]
    IF ASCAN(laDivision, cDivision) = 0
      SELECT Codes
      IF SEEK("N"+Style.cDivision+"N"+"CDIVISION")
        lnArLen = ALEN(laDivision, 1)
        IF !(lnArLen = 1 AND EMPTY(laDivision[1]))
          lnArLen = lnArLen+1
          DIMENSION laDivision[lnArLen,2]
        ENDIF
        lcCode = PADR(Codes.cCode_No,06)
        lcDesc = PADR(Codes.cDiscrep,30) 
        lcDesc = IIF(llIsEditbl, lcCode+lcSeprat+lcDesc, lcDesc)
        laDivision[lnArLen,1] = lcDesc
        laDivision[lnArLen,2] = lcCode
      ENDIF
    ENDIF
  ENDSCAN
ENDIF

*B801910,1 YMA 03/07/99 Go to the initial style record.
SELECT STYLE
= SEEK(lcStyExp)
*B801910,1 YMA 03/07/99 End.

SELECT Codes
SET ORDER TO TAG &lcTag

IF EMPTY(laDivision[1])
  llNoThing = gfwCodePop(@laCodeInfo, "CDIVISION", "N")
ENDIF

IF llSet
  lnDivision = 1
  laData[10] = laDivision[lnDivision,2]
ENDIF
SHOW GET lnDivision

SELECT(lnAlias)

* ----------------------------------------------------------------

FUNCTION lfvObjLnk

lnAlias = SELECT(0)
DO GetObj WITH 'C',laData[1]
SELECT(lnalias)

*:----------------------------------------------------------------
*: Name       : lfChkOrder
*: Developer  : Hossam El Etreby [HDM]
*: Date       : 03/08/1999
*: Purpose    : To Check the order line file for piktkt
*:----------------------------------------------------------------
*: Parameters : NONE
*:----------------------------------------------------------------
*: Returns    : .T. if no pictkts found .F. if piktkt found
*:----------------------------------------------------------------
*: Example    : = lfUpdStp()
*:----------------------------------------------------------------
*: Due to Bug 602473
*:----------------------------------------------------------------
FUNCTION lfChkOrder
PRIVATE llRetVal, lnPrevSel, llOrdUsed

llRetVal  = .T.
lnPrevSel = SELECT(0)
llOrdUsed = gfOpenFile(gcDataDir + 'ORDLINE' ,'ORDLINE','SH')

SELECT ORDLINE

*-- Seek the Order / Contract line that found in cutpick file
IF SEEK('O' + CUTPICK.ORDER) OR SEEK('C' + CUTPICK.ORDER)
  *-- Search the OrdLine File for Pick Tickets
  SCAN REST WHILE ORDER = CUTPICK.ORDER AND !EMPTY(ORDLINE.PIKTKT)
    *-- If Found Display a message then exit the scan loop
    lcMsg    = 'There are some picked Quantities, Cannot proceed'
    llRetVal = gfModalGen('TRM32059B34000','DIALOG',lcMsg) = 100
    EXIT
  ENDSCAN
ENDIF
    
= IIF(llOrdUsed, gfCloseFile("ORDLINE"), .F.)

SELECT(lnPrevSel)
RETURN llRetVal

*:*************************************************************************
*! Name      : lfvSwitch
*! Developer : Sameh (SSE)
*! Date      : 05/31/1999
*! Purpose   : push button to switch between (Cost by C/T & Cost by Unit)
*:*************************************************************************
*! Calls     : 
*!             Procedures : ....
*!             Functions  : ....
*:*************************************************************************
*! Passed Parameters  : None
*:*************************************************************************
*! Returns            : None
*:*************************************************************************
*! Example   : = lfvSwitch()
*:*************************************************************************
*E301243,1
FUNCTION lfvSwitch
PRIVATE lnOldAlias

lnOldAlias = SELECT()    && to save the old alias number

SELECT CUTTKTH		

IF llByUnit    && if llByUnit is True (Cost is shown by C/T)
  SHOW GET pbSwitch,1 PROMPT 'Cost by Unit' 
  llByUnit = .F.    && since this is a Flag it must be Toggled (Turned On/Off)
ELSE           && else llByUnit is False (Cost is shown by Unit)
  SHOW GET pbSwitch,1 PROMPT 'Cost by C/T' 
  llByUnit = .T.
ENDIF

= lfRefresh()      && refresh all the labels to show whether (Cost by Unit/cost by C/T) values
SHOW GET PbSwitch  && show whether (Cost by Unit/cost by C/T) caption on pbSwitch push button  

SELECT (lnOldAlias)  && restore old alias number before the end of function
*-- End of lfvSwitch


*:*************************************************************************
*! Name      : lfTotalAct
*! Developer : Sameh (SSE)
*! Date      : 05/31/1999
*! Purpose   : to get the TOTAL OF ACTUAL COST 
*:*************************************************************************
*! Calls     : 
*!             Procedures : ....
*!             Functions  : ....
*:*************************************************************************
*! Passed Parameters  : None
*:*************************************************************************
*! Returns            : None
*:*************************************************************************
*! Example   : = lfTotalAct()
*:*************************************************************************
*E301243,1
FUNCTION lfTotalAct
PARAMETERS lcTotal

RETURN (IIF(laData[3]='A' AND laData[16]>0,ROUND((laData[29]+laData[30]+ladata[31]+ladata[32]+ladata[33])/laData[16],4),IIF(laData[3]$'CS' AND laData[13]>0,ROUND((laData[29]+laData[30]+ladata[31]+ladata[32]+ladata[33])/laData[13],4),0)))
*-- End of lfTotalAct.

*E301289,1 WAB - START
*!**************************************************************************
*! Name      : lfGetPrice
*! Developer : WAB - Walid A. Wahab
*! Date      : 08/26/1999
*! Purpose   : call Po selling price screen when press Gp bott.
*!**************************************************************************
*! Calls     : Poselprc.spr
*!**************************************************************************
*! Parameters: None
*!**************************************************************************
*! Returns   :  None.
*!**************************************************************************
*! Example   :  =lfGetPrice()
*!**************************************************************************
*-
FUNCTION lfGetPrice
lnOldPrice = m.nSelPrice
lnOldMrgn  = m.nGrosMrgn
lnPriceLvl = 1
lcDispFld = IIF(Empty(m.nSelPrice),'DISABLE','ENABLED')
DO (gcScrDir+"Poselprc.SPX")

*E301289,1 WAB - END

*E301289,1 WAB - START
*!**************************************************************************
*! Name      : lfvSelPrice
*! Developer : WAB - Walid A. Wahab
*! Date      : 08/26/1999
*! Purpose   : validate  after edit the selling price filed
*!           : to calculate the gross margin 
*!**************************************************************************
*! Calls     : 
*!**************************************************************************
*! Parameters: None
*!**************************************************************************
*! Returns   :  None.
*!**************************************************************************
*! Example   :  =lfvSelPrice()
*!**************************************************************************
*-
FUNCTION lfvSelPrice
PRIVATE lnRotSub
*-- calculate grosmargin [devide the diferent between price and cost by cost or 
*-- by selling price] depense on llstymark (setup) 
lnRotSub    = IIF(llStyMark,Style.TotCost,m.nSelPrice)
m.nGrosMrgn = IIF(lnRotSub=0,0,((m.nSelPrice - Style.TotCost)/lnRotSub)*100)
lcDispFld   = IIF(Empty(m.nSelPrice),'DISABLE','ENABLED')
SHOW GET pbAmdOk &lcDispFld
SHOW GET m.nGrosMrgn DISABLE
*E301289,1 WAB - END

*E301289,1 WAB - START
*!**************************************************************************
*! Name      : lfAcpPrice
*! Developer : WAB - Walid A. Wahab
*! Date      : 08/26/1999
*! Purpose   : to replace fileds to CT temp lines when press Ok. Butt.
*!**************************************************************************
*! Calls     : 
*!**************************************************************************
*! Parameters: None
*!**************************************************************************
*! Returns   :  None.
*!**************************************************************************
*! Example   :  =lfAcpPrice()
*!**************************************************************************
*-
FUNCTION lfAcpPrice
SELECT (lcTmpCutLn)
REPLACE nSelPrice WITH m.nSelPrice ,;
        nGrosMrgn WITh m.nGrosMrgn ,;
        cStatus   WITH "M"       

SHOW WINDOW (lcLinesBrw) REFRESH SAME

*E301289,1 WAB - END

*E301289,1 WAB - START
*!**************************************************************************
*! Name      : lfCanPrice
*! Developer : WAB - Walid A. Wahab
*! Date      : 08/26/1999
*! Purpose   : to cancel and return the old value to the fields when press 
*!             Cancel Butt.
*!**************************************************************************
*! Calls     : 
*!**************************************************************************
*! Parameters: None
*!**************************************************************************
*! Returns   :  None.
*!**************************************************************************
*! Example   :  =lfCanPrice()
*!**************************************************************************
*-
FUNCTION lfCanPrice
m.nSelPrice = lnOldPrice 
m.nGrosMrgn = lnOldMrgn  

*E301289,1 WAB - END


*E301289,1 WAB - START
*!**************************************************************************
*! Name      : lfvPriceLvl
*! Developer : WAB - Walid A. Wahab
*! Date      : 08/18/1999
*! Purpose   : to get the selling price from style table Depends on price level
*!**************************************************************************
*! Calls     : lfvSelPrice()
*!**************************************************************************
*! Parameters: None
*!**************************************************************************
*! Returns   :  None.
*!**************************************************************************
*! Example   :  =lfvPriceLvl()
*!**************************************************************************
*-
FUNCTION lfvPriceLvl
DO CASE 
  CASE lnPriceLvl = 2
    m.nSelPrice = STYLE.PRICEA
  CASE lnPriceLvl = 3
    m.nSelPrice = STYLE.PRICEB
  CASE lnPriceLvl = 4
    m.nSelPrice = STYLE.PRICEC
ENDCASE  
SHOW GET m.nSelPrice ENABLE
IF lnPriceLvl <>1
  =lfvSelPrice()
ENDIF
*E301289,1 WAB - END

*E301289,1 WAB - START
*!**************************************************************************
*! Name      : lfvProfit
*! Developer : WAB - Walid A. Wahab
*! Date      : 08/29/1999
*! Purpose   : Call Profitability screen
*!**************************************************************************
*! Calls     : 
*!**************************************************************************
*! Parameters: None
*!**************************************************************************
*! Returns   :  None.
*!**************************************************************************
*! Example   :  =lfvProfit()
*!**************************************************************************
FUNCTION lfvProfit
*C102581,1 AMH Call Profitability custom screen of Robyn Merdith [Start]
*DO (gcScrDir+"POPROFIT.SPX")
IF ASCAN(laEvntTrig , PADR('GETPROFT',10)) <> 0
  DO (gcScrDir+gcWinAppl+"\MFPROFIT.SPX")
ELSE
  DO (gcScrDir+"POPROFIT.SPX")
ENDIF
*C102581,1 AMH [End]

*E301289,1 WAB - END

*E301289,1 WAB - START
*!**************************************************************************
*! Name      : lfvProfit
*! Developer : WAB - Walid A. Wahab
*! Date      : 08/29/1999
*! Purpose   : calculate the total selling price & gros margin when call 
*!             Profitability screen
*!**************************************************************************
*! Calls     : 
*!**************************************************************************
*! Parameters: None
*!**************************************************************************
*! Returns   :  None.
*!**************************************************************************
*! Example   :  =lfvProfit()
*!**************************************************************************
FUNCTION lfGetProfit
Private lnRecNo , lnAvrgPrc,lnTotQty,llMastMode
lnAlias=SELECT()

llMastMode = laScrMode[1] OR laScrMode[2]
lcFile     = IIF(llMastMode, "CutTktL", lcTmpCutLn)
SELECT (lcFile)
lnRecNo = RECNO()
STORE 0 TO lnPoctSel,lnUnitSel,lnTotQty,lnuntMrgn1,lnuntMrgn2,lnuntMrgn3,lnRotSub,lnTotcost

*--- sum ( selling price * total CT line qty) for CT
SUM TotQty, nSelPrice *  TotQty TO lnTotQty,lnPoctSel
lnUnitSel = lnPoctSel / lnTotQty          && average selling price

*--- ESTIMATED
lnTotcost  = laData[19]+laData[20]+laData[21]+laData[22]+laData[23]
lnRotSub   = IIF(llStyMark,lnTotcost,lnPoCtSel)
lnuntMrgn1 = IIF(lnRotSub = 0,0,((lnPoCtSel - lnTotcost)/lnRotSub)*100)   && Gross Margin

*--- LANDED
lnTotcost  = laData[24]+laData[25]+laData[26]+laData[27]+laData[28]
lnRotSub   = IIF(llStyMark,lnTotcost,lnPoCtSel)
lnuntMrgn2 = IIF(lnRotSub = 0,0,((lnPoCtSel - lnTotcost)/lnRotSub)*100)   && Gross Margin

*--- ACTUAL
lnTotcost  = laData[29]+laData[30]+laData[31]+laData[32]+laData[33]
lnRotSub   = IIF(llStyMark,lnTotcost,lnPoCtSel)
lnuntMrgn3 = IIF(lnRotSub = 0,0,((lnPoCtSel - lnTotcost)/lnRotSub)*100)   && Gross Margin

SELECT (lcFile)
IF BETWEEN(lnRecNo, 1, RECCOUNT())
  GO  lnRecNo
ELSE
  
  *B603317,1 [
  *GO TOP
  LOCATE
  *B603317,1 [

ENDIF
SELECT(lnAlias)

*E301289,1 WAB - END

*C102094,1 AMH [Start]
*!**************************************************************************
*! Name      : lfvPackNo
*! Developer : Ahmed Maher (AMH)
*! Date      : 01/04/2001
*! Purpose   : Valid function of Pack No User defined field
*!**************************************************************************
*! Calls     : 
*!**************************************************************************
*! Parameters: None
*!**************************************************************************
*! Returns   :  None.
*!**************************************************************************
*! Example   :  =lfvPackNo()
*!**************************************************************************
FUNCTION lfvPackNo

IF ASCAN(laEvntTrig , PADR('VPACK',10)) <> 0
  =gfDoTriger('MFCUTKT',PADR('VPACK',10))
ENDIF     
*-- end of lfvPackNo.

*!**************************************************************************
*! Name      : lfwCutWhen
*! Developer : Ahmed Maher (AMH)
*! Date      : 01/09/2001
*! Purpose   : When function of User defined fields of Chathy Daniels.
*!**************************************************************************
*! Calls     : 
*!**************************************************************************
*! Parameters: None
*!**************************************************************************
*! Returns   :  None.
*!**************************************************************************
*! Example   :  =lfwCutWhen()
*!**************************************************************************
FUNCTION lfwCutWhen

RETURN .T.
*-- end of lfwCutWhen.
*C102094,1 AMH [End]

*!*************************************************************
*! Name    : lfModBom
*! Developer : AHMED MAHER (AMH)
*! Date      : 11/14/2002
*! Purpose : Function to update C/T bill of material for modified and removed lines
*!*************************************************************
*! Calls     : 
*!             Procedures : ....
*!             Functions  : ....
*!*************************************************************
*! Passed Parameters  : ............
*!*************************************************************
*! Returns            : ............
*!*************************************************************
*! Example   : =lf..()
*!*************************************************************
*B606496,1 AMH
FUNCTION lfModBom

PRIVATE lcTmpBomLn, lcMjrMsk, lcSizes, lnI, lcScale
lcMjrMsk  = gfItemMask("PM")

lcTmpBomLn = gfTempName()
SELECT BOM
=AFIELDS(laFileStru)
CREATE TABLE (gcWorkDir+lcTmpBomLn) FROM ARRAY laFileStru
INDEX ON citmmajor+typ+citmmask+mfgcode+item+iclr TAG (lcTmpBomLn)
SELECT BomLine
SEEK "M1"+laData[1]+STR(lnLineNo,6)
SCAN REST WHILE cImTyp+cType+cTktNo+STR(LineNo,6)+cBomTyp+Style+SClr+Item+IClr+MfgCode =;
                "M1"+laData[1]+STR(lnLineNo,6) ;
            FOR Style = lcStyle
  llTrim_Inv = .F.
  lcRecDesc  = ""
  lcUom      = ''
  lcMarker   = ''
  llBaseOnSz = .F.
  IF SEEK('M'+laData[1]+cBomtyp+Item+IClr+MfgCode+dyelot,'CTktBom')
    llTrim_Inv = cTktBom.Trim_Invt
    lcRecDesc  = cTktBom.Desc
    lcUom      = cTktBom.Uom
    lcMarker   = cTktBom.cMarker
  ENDIF
  IF SEEK(SUBSTR(lcStyle,1,LEN(lcMjrMsk)),'Bom')
    SELECT Bom
    LOCATE REST WHILE citmmajor+typ+citmmask+mfgcode+item+iclr=SUBSTR(lcStyle,1,LEN(lcMjrMsk));
                FOR lBasOnSiz
    llBaseOnSz = FOUND()
  ENDIF
  lcSizes = ''
  IF LEN(BOMLINE.CSIZES) > 1
    FOR lnI = 1 TO LEN(BOMLINE.CSIZES)-1
      lcSizes = lcSizes + SUBSTR(BOMLINE.CSIZES,lnI,1) + ','
    ENDFOR
    lcSizes = lcSizes + SUBSTR(BOMLINE.CSIZES,LEN(BOMLINE.CSIZES),1)
  ELSE
    lcSizes = BOMLINE.CSIZES
  ENDIF
  =SEEK(lcStyle,'STYLE')
  lcScale = STYLE.SCALE
  IF !EMPTY(lcSizes)
    lcSizes = lcScale + '~' + lcSizes
  ENDIF
  lcCrsRef = ''
  IF LEN(BOMLINE.CCOMPSIZES) > 0
    FOR lnI = 1 TO LEN(BOMLINE.CCOMPSIZES)
      =SEEK(BOMLINE.ITEM,'STYLE')
      lcCrsRef = lcCrsRef+lcScale+','+SUBSTR(BOMLINE.CCOMPSIZES,lnI,1)+'~'+STYLE.SCALE+','+;
                 SUBSTR(BOMLINE.CSIZES,lnI,1)+CHR(13)+CHR(10)
    ENDFOR
  ENDIF
  SELECT (lcTmpBomLn)
  APPEND BLANK
  REPLACE cItmMajor  WITH SUBSTR(lcStyle,1,LEN(lcMjrMsk)) ,;
          Typ        WITH BomLine.cBomtyp  ,;
          cItmMask   WITH lcStyle          ,;
          cOprCode   WITH BomLine.cOprCode ,;
          MfgCode    WITH BomLine.MfgCode  ,;
          Item       WITH BomLine.Item     ,;
          IClr       WITH BomLine.IClr     ,;
          Trim_Invt  WITH llTrim_Inv       ,;
          Desc       WITH lcRecDesc        ,;
          lBasOnSiz  WITH llBaseOnSz
  REPLACE MSIZES     WITH lcSizes          ,;
          MSZCROSREF WITH lcCrsRef         ,;
          UOM        WITH lcUom            ,;
          UNTCOST    WITH BOMLINE.UNITCOST ,;
          NPERCENT   WITH BOMLINE.NPERCENT ,;
          NESTBOMQTY WITH BOMLINE.UNITQTY  ,;
          NBOMWASTGE WITH 0                ,;
          NBOMTOTQTY WITH NESTBOMQTY       ,;
          TOTCOST    WITH NESTBOMQTY*UNTCOST,;
          CCOSTSTAT  WITH BOMLINE.CCOSTSTAT
  REPLACE CCATGTYP   WITH BOMLINE.CCATGTYP ,;
          CMARKER    WITH lcMarker
ENDSCAN

llRetVal = gfSheetItem ("M"      , laData[1] , lcLinkCode, lcStyle    ,;
                        ""       , lnLineNo , lcDyelot  , CutTktH.cItemWare,;
                        CutTktH.cMatWare,@laBomQty, lcTmpBomLn, "CtktBom"  ,;
                        "BomLine", "MFGOprHd", lcLastOpr ,;
                        0, 0, 0, 0, 0, 0,lcCTChWin2)
USE IN (lcTmpBomLn)
ERASE (gcWorkDir+lcTmpBomLn+'.DBF')
ERASE (gcWorkDir+lcTmpBomLn+'.CDX')
ERASE (gcWorkDir+lcTmpBomLn+'.FPT')
*-- end of lfModBom.

*!***********************************************************************************
*! Name      : lfGenProj
*! Developer : Hend Ghanem (HBG)
*! Date      : 07/04/2002
*! Purpose   : Creat temp files needed to generat project
*!***********************************************************************************
*! Calls     : 
*!***********************************************************************************
*! Parameters: None
*!***********************************************************************************
*! Returns   :  None.
*!***********************************************************************************
*! Example   :  =lfGenProj()
*!***********************************************************************************
*!E301869,1
FUNCTION lfCrtprjTm

CREATE CURSOR (lc_Parser);
       (cOprt_Ctg C(3), cOprt_ID C(5), dStrtDate D(8), nDurIndic N(1)) 

=gfOpenFile(gcDataDir + 'PMPRJHD'  , 'PMPRJHD' , 'SH')
=gfOpenFile(gcDataDir + 'PMPRJDT'  , 'PMPRJDT' , 'SH')
=gfOpenFile(gcDataDir + 'PMPRJRL'  , 'PMPRJRL' , 'SH')
*-- Create a table with the same structure as PMPRJDT 
*-- adding two more fields for saving.
SELECT PMPRJDT
=AFIELDS(laFileStru)
lnFileStru = ALEN(laFileStru, 1)
DIMENSION laFileStru(lnFileStru + 3, 4)
lnFileStru = lnFileStru + 1
laFileStru[lnFileStru ,1] = 'cStatus'
laFileStru[lnFileStru ,2] = 'C'
laFileStru[lnFileStru ,3] = 1
laFileStru[lnFileStru ,4] = 0
lnFileStru = lnFileStru + 1
laFileStru[lnFileStru ,1] = 'nRecNo'
laFileStru[lnFileStru ,2] = 'N'
laFileStru[lnFileStru ,3] = 10
laFileStru[lnFileStru ,4] = 0
lnFileStru = lnFileStru + 1
laFileStru[lnFileStru ,1] = 'cMComplt'
laFileStru[lnFileStru ,2] = 'C'
laFileStru[lnFileStru ,3] = 3
laFileStru[lnFileStru ,4] = 0

CREATE CURSOR (lc_PMPrjDt) FROM ARRAY laFileStru
INDEX ON cPrj_Typ + cPrj_ID + cStyle + cOprt_Ctg + cOprt_ID;
      TAG PMPRJDT OF (lc_PMPrjDt)
INDEX ON cPrj_Typ + cPrj_ID + cStyle + cCtg_Seq + cOprt_Seq;
      TAG PMPRJDTS OF (lc_PMPrjDt)
INDEX ON cPrj_Typ+cPrj_Id+cOprt_Ctg+cOprt_Id+cOprt_Res;
              TAG PMPRJUSR OF (lc_PMPrjDt)
                
CREATE CURSOR (lc_PrjHist) (cOpr_ID C(20),cUser_ID C(10),cRemain C(3),cCompDate C(8),cActnDate C(8),cStatus C(15))
INDEX ON cOpr_ID TAG PMPRJDT OF (lc_PrjHist)
 
CREATE CURSOR (lc_PrjAudt) FROM ARRAY laFileStru
INDEX ON cOprt_Ctg + cOprt_ID TAG PMPRJDT OF (lc_PrjAudt)
  
SELECT PMPRJRL
=AFIELDS(laFileStru)
lnFileStru = ALEN(laFileStru, 1)
DIMENSION laFileStru(lnFileStru + 2, 4)
lnFileStru = lnFileStru + 1
laFileStru[lnFileStru ,1] = 'cStatus'
laFileStru[lnFileStru ,2] = 'C'
laFileStru[lnFileStru ,3] = 1
laFileStru[lnFileStru ,4] = 0
lnFileStru = lnFileStru + 1
laFileStru[lnFileStru ,1] = 'nRecNo'
laFileStru[lnFileStru ,2] = 'N'
laFileStru[lnFileStru ,3] = 10
laFileStru[lnFileStru ,4] = 0
CREATE CURSOR (lc_PMPrjRl) FROM ARRAY laFileStru
INDEX ON cPrj_Typ + cPrj_ID + cStyle + cPrd_Ctg  + cPrd_ID;
       TAG PMPRJRLP OF (lc_PMPrjRl)
INDEX ON cPrj_Typ + cPrj_ID + cStyle + cOprt_Ctg + cOprt_ID;
       TAG PMPRJRL  OF (lc_PMPrjRl)

*!***********************************************************************************
*! Name      : lfGenProj
*! Developer : Hend Ghanem (HBG)
*! Date      : 07/04/2002
*! Purpose   : Generat project for the Ctktkt according to yhe setting of the module
*!***********************************************************************************
*! Calls     : 
*!***********************************************************************************
*! Parameters: None
*!***********************************************************************************
*! Returns   :  None.
*!***********************************************************************************
*! Example   :  =lfGenProj()
*!***********************************************************************************
*!E301869,1
FUNCTION lfGenProj

FOR lnI = 1 TO ALEN(laScrMode,1)
  IF laScrMode[lnI]
    lnScrMode = lnI
  ENDIF
ENDFOR
*-- Open the needed files
=gfOpenFile(gcDataDir + 'PMPTHHD'  , 'PMPTHHD' , 'SH')
=gfOpenFile(gcDataDir + 'PMPTHDT'  , 'PMPTHDT' , 'SH')
=gfOpenFile(gcDataDir + 'PMPTHRL'  , 'PMPTHRL' , 'SH')
=gfOpenFile(gcDataDir + 'AUDTRAIL' , 'AUDTRAIL', 'SH')
=gfOpenFile(gcDataDir + 'PMCTGHD'  , 'PMCTGHD' , 'SH')
=gfOpenFile(gcDataDir + 'PMCTGDT'  , 'PMCTGDT' , 'SH')
=gfOpenFile(gcDataDir + 'PMCALHD'  , 'PMCALHD' , 'SH')
=gfOpenFile(gcDataDir + 'PMCALDT'  , 'PMCALDT' , 'SH')
=gfOpenFile(gcSysHome + 'SYUUSER'  , 'Cuser_id', 'SH')
=gfOpenFile(gcSysHome + 'SYSCHDUL' , 'Coprusr' , 'SH')

DECLARE laHolidays[1]
laHolidays = ''
lnRows = 0
SELECT PMCALDT
SCAN
  ldCal_HFrm = dCal_HFrm
  DO WHILE ldCal_HFrm <= dCal_HTo
    lnRows  = lnRows  + 1
    DIMENSION laHolidays[lnRows]
    laHolidays[lnRows] = cCal_ID + DTOC(ldCal_HFrm)
    ldCal_HFrm = ldCal_HFrm + 1
  ENDDO  
ENDSCAN
lVoid = .F.
STORE gdSysDate TO ldCurDate , m.dEst_Strt , m.dclc_strt
m.dEst_Fnsh = {}

DO CASE 
  CASE lcGenProj = 'I'    && Generating Project Inquir
    lnChoice =gfModalGen('INM38251B32000','DIALOG','cut ticket')
    IF lnChoice = 1
      PUSH KEY
      DO lfvOprtins IN gcAppHome+"MFPROJ" WITH 'C',laData[1],lcDefTemp,laData[2]
      POP KEY
      =lfUpdMastr()
    ENDIF  

  CASE lcGenProj = 'A'    && Generating Project Automatic
    PUSH KEY
    DO lfvOprtins IN gcAppHome+"MFPROJ" WITH 'C',laData[1],lcDefTemp,laData[2]
    POP KEY
    =lfUpdMastr()
ENDCASE

STORE .F. To laScrMode
laScrMode[lnScrMode] = .T.


*!***********************************************************************************
*! Name      : lfUpdMastr
*! Developer : Hend Ghanem (HBG)
*! Date      : 07/04/2002
*! Purpose   : Update master files of production schedule
*!***********************************************************************************
*! Calls     : 
*!***********************************************************************************
*! Parameters: None
*!***********************************************************************************
*! Returns   :  None.
*!***********************************************************************************
*! Example   :  =lfUpdMastr()
*!***********************************************************************************
*!E301869,1
FUNCTION lfUpdMastr

INSERT INTO PMPRJHD (cprj_typ,cprj_id,cstyle,cprj_sdsc,cpath_id,cprj_stts,;
                    llaststrt,dest_strt,dest_fnsh,dreq_strt,dreq_fnsh,lschedual,llok_stat);
             VALUES ('C',laData[1],laData[2],lcStyDesc,lcDefTemp,'P',;
                    .F.,m.dest_strt,m.dest_fnsh,laData[5],laData[6],.F.,.T.)

SELECT (lc_PMPrjDt)
SCAN
  SCATTER MEMVAR MEMO
  SELECT PMPRJDT
  m.LORGINAL = .T.
  INSERT INTO PMPRJDT FROM MEMVAR

  IF !EMPTY(m.cOprt_res) OR !EMPTY(m.cGroup_Id) 
    IF !SEEK(m.cPrj_Typ+ m.cPrj_ID+m.cOprt_Ctg+m.cOprt_ID,'SYSCHDUL')
      INSERT INTO SYSCHDUL;
            (cconttype , cseqnumber , ccont_id , csubject,;
             ctrantype,nestdur,ccompleted,cUser_Id,dtrandate,dcmpltdate,COPERSTAT,;
             lPredComp);
      VALUES(m.cPrj_Typ,m.cPrj_ID,m.cOprt_Ctg+m.cOprt_ID,;
             m.coprt_dsc,'W',m.nest_dur,'N',;
             IIF(EMPTY(m.cOprt_res),m.cGroup_Id,m.cOprt_res),;
             IIF(EMPTY(m.dclc_strt),m.dEst_strt,m.dclc_strt),;
             IIF(EMPTY(m.dclc_Fnsh),m.dEst_fnsh,m.dclc_Fnsh),'O',.T.)
    ELSE
      REPLACE SYSCHDUL.cUser_Id   WITH IIF(EMPTY(m.cOprt_res),m.cGroup_Id,m.cOprt_res),;
              SYSCHDUL.csubject   WITH m.coprt_dsc,;
              SYSCHDUL.ctrantype  WITH 'W',;
              SYSCHDUL.nestdur    WITH m.nest_dur ,;
              SYSCHDUL.ccompleted WITH 'N'  ,;
              SYSCHDUL.dtrandate  WITH IIF(EMPTY(m.dclc_strt),m.dEst_strt,m.dclc_strt),;
              SYSCHDUL.dcmpltdate WITH IIF(EMPTY(m.dclc_Fnsh),m.dEst_fnsh,m.dclc_Fnsh),;
              SYSCHDUL.COPERSTAT  WITH 'O',;
              SYSCHDUL.lPredComp  WITH .T.                   
    ENDIF
        
    IF SEEK(m.cPrj_Typ+ m.cPrj_ID+m.cOprt_Ctg+m.cOprt_ID,'SYSCHDUL')
      IF m.nAct_Dur <> 0 OR !EMPTY(m.dAct_Fnsh)
        REPLACE SYSCHDUL.COPERSTAT  WITH 'C',;
                SYSCHDUL.CCOMPLETED WITH 'Y'    
      ENDIF
      IF m.lVoid
        REPLACE SYSCHDUL.COPERSTAT WITH 'X'
      ENDIF        
    ENDIF  
  ENDIF  

  *-- Update related records for every line.
  SELECT (lc_PMPrjRl)
  *-- Add cOprt_Ctg
  
  SCAN FOR cPrj_Typ + cPrj_ID + cStyle + cOprt_Ctg  + cOprt_ID = ;
                       &lc_PMPrjDt..cPrj_Typ + &lc_PMPrjDt..cPrj_Id+;
                       &lc_PMPrjDt..cStyle + &lc_PMPrjDt..cOprt_Ctg + &lc_PMPrjDt..cOprt_ID
  
    SCATTER MEMVAR MEMO
    
    DO CASE
      CASE SEEK(m.cPrj_Typ+m.cPrj_Id+m.cPrd_Ctg+m.cPrd_Id+'O','SYSCHDUL') 
        =SEEK(m.cPrj_Typ+ m.cPrj_ID+m.coprt_ctg+m.coprt_id+'O','SYSCHDUL')
        REPLACE SYSCHDUL.lPredComp WITH .F.
      CASE SEEK(m.cPrj_Typ+m.cPrj_Id+m.cPrd_Ctg+m.cPrd_Id+'C','SYSCHDUL')
        =SEEK(m.cPrj_Typ+ m.cPrj_ID+m.coprt_ctg+m.coprt_id+'O','SYSCHDUL')
        REPLACE SYSCHDUL.lPredComp WITH .T.
      CASE SEEK(m.cPrj_Typ+m.cPrj_Id+m.cPrd_Ctg+m.cPrd_Id+'X','SYSCHDUL')
        =SEEK(m.cPrj_Typ+ m.cPrj_ID+m.coprt_ctg+m.coprt_id+'O','SYSCHDUL')
        REPLACE SYSCHDUL.lPredComp WITH .T.
    ENDCASE      

    SELECT PMPRJRL
    INSERT INTO PMPRJRL FROM MEMVAR
  ENDSCAN 
  
ENDSCAN

*-- Update Audit Trail
lcProg  = 'MFCUTKT'
lcKey   = laData[1]
lcEvent = 'RESCHDCT'

IF !SEEK(PADR(lcProg,10)+PADR(lcKey,20),'AUDTRAIL')    
  SELECT (lc_PMPrjDt)
  SCAN
    IF SEEK(&lc_PMPrjDt..cPrj_Typ + &lc_PMPrjDt..cPrj_ID + &lc_PMPrjDt..cOprt_Ctg+&lc_PMPrjDt..cOprt_ID,'SYSCHDUL') 
      IF !(&lc_PMPrjDt..lOrginal)
        SELECT SYSCHDUL
        lcStauts = SYSCHDUL.COPERSTAT
        LOCATE REST WHILE cconttype+cseqnumber+ccont_id+coperstat+cuser_id =;
                        &lc_PMPrjDt..cPrj_Typ + &lc_PMPrjDt..cPrj_ID + &lc_PMPrjDt..cOprt_Ctg+&lc_PMPrjDt..cOprt_ID ;
                        FOR COPERSTAT <> lcStauts
        IF !FOUND()
          =SEEK(&lc_PMPrjDt..cPrj_Typ + &lc_PMPrjDt..cPrj_ID + &lc_PMPrjDt..cOprt_Ctg+&lc_PMPrjDt..cOprt_ID+lcStauts,'SYSCHDUL') 
        ENDIF                    
      ENDIF
   
      IF SYSCHDUL.lPredComp 
        SELECT (lc_PMPrjDt)
        SCATTER MEMVAR MEMO
        ldest_Fnsh = m.dest_Fnsh
        lnrem_dur  = m.nrem_dur
        *HBG 8/1/2003 Preaper variables to call GFAUDTRL.prg instead of using Syctrigg to update audit trail [Begin]
        lcProg  = 'MFCUTKT'
        lcKey   = laData[1]
        lcEvent = 'RESCHDCT'
        lcApObjNam = 'MFCUTKT'
        lcInform = ""
        *HBG [End]        
        DO lfUpdAdTrl IN gcAppHome+"MFPROJ" WITH 'C'
        SELECT (lc_PrjAudt)
        *HBG 8/1/2003 Call GFAUDTRL.prg instead of using Syctrigg to update audit trail [Begin]
        *IF ASCAN(laEvntTrig , PADR(lcEvent,10)) <> 0
        *  =gfDoTriger('MFCUTKT',PADR(lcEvent,10))
        *ENDIF
        DO gcAppHome+"SY\"+"GFAUDTRL" WITH lcProg , lcKey , lcApObjNam ,lcEvent,lcInform
        *HBG [End]
        
      ENDIF 
    ENDIF   
  ENDSCAN
ENDIF

SELECT PMPRJHD
REPLACE llok_stat WITH .F.


*!***********************************************************************************
*! Name      : lfUpdPrjSt
*! Developer : Hend Ghanem (HBG)
*! Date      : 07/04/2002
*! Purpose   : Update Project Status
*!***********************************************************************************
*! Calls     : 
*!***********************************************************************************
*! Parameters: None
*!***********************************************************************************
*! Returns   :  None.
*!***********************************************************************************
*! Example   :  =lfUpdMastr()
*!***********************************************************************************
*!E301869,1
FUNCTION lfUpdPrjSt

=gfOpenFile(gcDataDir + 'PMPRJHD'  , 'PMPRJHD' , 'SH')
=gfOpenFile(gcDataDir + 'PMPRJDT'  , 'PMPRJDT' , 'SH')
=gfOpenFile(gcSysHome + 'SYSCHDUL' , 'Coprusr' , 'SH')
=gfOpenFile(gcDataDir + 'AUDTRAIL' , 'AUDTRAIL', 'SH')

IF SEEK('C' + laData[1],'PMPRJHD') AND !(PMPRJHD.cprj_stts $ 'CH')
  IF CUTTKTH.STATUS = 'X'
    SELECT PMPRJHD
    REPLACE PMPRJHD.cprj_stts WITH 'X'
    lcProg  = 'MFCUTKT'
    lcKey   = laData[1]
    SELECT PMPRJDT
    IF SEEK(SUBSTR(PMPRJHD.cPrj_Typ,1,LEN(cPrj_Typ)) + SUBSTR(PMPRJHD.cPrj_ID,1,LEN(cPrj_ID)) +;
            SUBSTR(PMPRJHD.cStyle,1,LEN(cStyle)))
      SCAN REST WHILE cprj_typ+cprj_id+cstyle+coprt_ctg+coprt_id =;
             SUBSTR(PMPRJHD.cPrj_Typ,1,LEN(cPrj_Typ)) + SUBSTR(PMPRJHD.cPrj_ID,1,LEN(cPrj_ID)) +;
             SUBSTR(PMPRJHD.cStyle,1,LEN(cStyle))
        IF SEEK(PMPRJDT.cPrj_Typ + PMPRJDT.cPrj_ID + PMPRJDT.cOprt_Ctg+PMPRJDT.cOprt_ID,'SYSCHDUL')
          SELECT SYSCHDUL
          REPLACE SYSCHDUL.COPERSTAT WITH 'X'
        ENDIF
      ENDSCAN
    ENDIF
    SELECT AUDTRAIL
    DELETE FOR capobjnam+key+caudtralid = PADR(lcProg,10)+PADR(lcKey,20) 
  ENDIF
ENDIF

*:----------------------------------------------------------------
*: Name       : lfRemAllo
*: Developer  : AHMED MAHER (AMH)
*: Date       : 12/23/2002
*: Purpose    : Release the order line allocation from the master
*:              Order line, header, cutpick, cuttktl files.
*:----------------------------------------------------------------
*: Calls      : None.
*:----------------------------------------------------------------
*: Parameters : None.
*:----------------------------------------------------------------
*: Returns    : None
*:----------------------------------------------------------------
*: Example    : = lfRemAllo()
*:----------------------------------------------------------------
*B606657,1 AMH
FUNCTION lfRemAllo

PRIVATE lnAlias,lcFltSet
DIMENSION laZero[9]
lnAlias    = SELECT(0)
laZero     = 0
      
SELECT (lcMastrLin)
IF SEEK(cuttkt+style+dyelot+'2','CUTTKTL')
  SELECT CUTTKTL
  SUM REST WHILE TRANCD = '2' QTY1,QTY2,QTY3,QTY4,QTY5,QTY6,QTY7,QTY8,TOTQTY;
           TO ARRAY laZero
  SELECT (lcMastrLin)
ENDIF

IF SEEK(cuttkt+style+dyelot+'1','CUTTKTL')
  SELECT CUTTKTL
  FOR lnI = 1 TO 8
    lcI = STR(lnI,1)
    REPLACE ('ORD'+lcI) WITH MIN(laZero[lnI],EVALUATE('ORD'+lcI))
  ENDFOR
  REPLACE TOTORD WITH MIN(TOTORD,laZero[9])
  lnTotOrd = lnTotOrd + TOTORD
  SELECT CUTPICK
  SET FILTER TO
  lcOrder = SET('ORDER')
  SET ORDER TO TAG CUTPKORD
  =SEEK('1'+laData[1]+STR(CUTTKTL.LINENO,6))
  DIME laRem[9]
  laRem = 0
  SCAN REST WHILE trancd+ctktno+ctktlineno+order+style+cordline =;
                  '1'+laData[1]+STR(CUTTKTL.LINENO,6)
    FOR lnI = 1 TO 8
      lcI = STR(lnI,1)
      laRem[lnI]  = MAX(EVALUATE('QTY'+lcI)-laZero[lnI],0)
      laZero[lnI] = MAX(laZero[lnI]-EVALUATE('QTY'+lcI),0)
    ENDFOR
    laRem[9]  = MAX(TOTQTY-laZero[9],0)
    laZero[9] = MAX(laZero[9]-TOTQTY,0)
    
    IF laRem[9] > 0
      =SEEK('O'+CUTPICK.Order,'ORDHDR')
      =SEEK('O'+CUTPICK.Order+STR(INT(VAL(CUTPICK.cOrdLine)),6),'ORDLINE')
      FOR lnSizeNo = 1 TO 8
        lcSz = STR(lnSizeNo,1)
        *-Update values so as to be reflected on all involved cutting ticktes.
        REPLACE ('ORDLINE.Cut'+lcSz) WITH EVALUATE('ORDLINE.Cut'+lcSz) - laRem[lnSizeNo]
        REPLACE ('CUTPICK.Qty'+lcSz) WITH EVALUATE('CUTPICK.QTY'+lcSz) - laRem[lnSizeNo]
      ENDFOR
      REPLACE ORDHDR.TotCut  WITH ORDHDR.TotCut  - laRem[lnSizeNo]
      REPLACE ORDLINE.TotCut WITH ORDLINE.TotCut - laRem[lnSizeNo]
      REPLACE CUTPICK.TotQty WITH CUTPICK.TotQty - laRem[lnSizeNo]
    ENDIF
    
  ENDSCAN        
  =SEEK('1'+laData[1]+STR(CUTTKTL.LINENO,6))
  DELETE REST WHILE trancd+ctktno+ctktlineno+order+style+cordline =;
                    '1'+laData[1]+STR(CUTTKTL.LINENO,6) FOR TotQty = 0
  SET ORDER TO &lcOrder.
  SET FILTER TO TranCD+CtktNo+Style = (lcOrderKy)
ENDIF

IF lcActTrnBr = "O" AND !llCTZoom
  = lfOptBrows()
ENDIF
      
SELECT (lnAlias)



*!*************************************************************
*! Name      : lfAdCnLine
*! Developer : Walid A. Wahab (WAB)
*! Date      : 04/07/2003
*! Purpose : Function to add cancel line to the po
*!*************************************************************
*B606743,1 
*!*************************************************************
FUNCTION lfAdCnLine
SELECT CutTktL
lcFilter = FILTER()
SET FILTER TO
lcOrder = ORDER()
SET ORDER TO TAG Cutlin

SELECT (lcMastrLin)
SCAN FOR cuttkt+style+dyelot+trancd = laData[1] AND TRANCD = '1'
  DIMENSION laCanQTY(8)
  STORE 0 TO laCanQTY,lnTOTCan
  lcFields ='Qty1,Qty2,Qty3,Qty4,Qty5,Qty6,Qty7,Qty8'
  SCATTER FIELDS &lcFields TO laCanQTY
  lnTOTCan = TotQty
  **cuttkt+style+STR(lineno,6)+trancd
  IF SEEK(cuttkt+style+STR(lineno,6),'CutTktL')
    SELECT CutTktL 
    SCAN REST WHILE cuttkt+style+STR(lineno,6)+trancd = ;
              &lcMastrLin..cuttkt+&lcMastrLin..Style+STR(&lcMastrLin..LineNo,6)  FOR Trancd <> '1'
      FOR lnI = 1 TO 8
        lcI = STR(lnI,1)
        laCanQTY[lnI] = laCanQTY[lnI] - MIN(laCanQTY[lnI],Qty&lcI)
      ENDFOR  
    ENDSCAN
    lnTOTCan=laCanQTY[1]+laCanQTY[2]+laCanQTY[3]+laCanQTY[4]+laCanQTY[5]+laCanQTY[6]+laCanQTY[7]+laCanQTY[8]
    IF lnTotCan > 0 
      SELECT (lcMastrLin)
      SCATTER MEMVAR MEMO
      FOR lnCount = 1 to 8
        lcI=STR(lnCount,1)
        m.Qty&lcI = laCanQTY[lnCount]
      ENDFOR
      m.TotQty = lnTotCan
      m.TranCd='4'
      SELECT CutTktL
      APPEND BLANK
      GATHER MEMVAR MEMO
    ENDIF
  ENDIF
  SELECT (lcMastrLin)
ENDSCAN
SELECT CutTktL
SET FITLER TO &lcFilter
SET ORDER TO &lcOrder
