***********************************************************************
*:   Program file: APPYINV.PRG
*:  Program desc.: Accounts Payable Invoice
*:         System: Aria 4XP
*:      Developer: Ahmad Shoukry Mohammed (ASM)
*:           Date: 7/6/2004
*:      Reference: *N37760,1
*:************************************************************************
*: Passed Parameters  : lcVenCode,lcInvNo,lnReceipts
*!*************************************************************
*! Modifications :
*! B128365,1 ASM 06/06/2005 Get Ship number for Selected Receiving Session in case of Materail purchase Order
*! B128399,1 KHM 06/15/2005 Fix the bug of wrong discount applied.
*! B999999,1 ASM Fix error that showed when trying to select item/color for shipment 4545
*! B129328,1 WSH 08/15/2005 Fix thge bug of voiding invoives with wrong dates.
*! B128863,1 ASM 08/24/2005 Fix the Bug of Saving Fox Tables even when SQL Gives errors and RollBack
*! B129901,1 ASM 09/26/2005 Prevent edit Payable invoice lines when falls in locked period
*! B039743,1 ASM 09/26/2005 Invoice screen gives error messege When Choosing Lines with lcLots
*! B130111,1 ASM 11/01/2005 Allow the User to Edit an Invoice whose posted date is locked, but make entries on system date
*! B129626,1 ASM 04/24/2005 AP Invoice Error message if line with zero exists
*! B130111,2 ASM 05/01/2006 Allow the User to Edit an Invoice whose posted date is locked, but Prevent accessing Invoice Lines and Total Amount
*! B608045,1 MMT 04/16/2007 fix bug or wrong record in grid after selecting GL account[T20070322.0029]
*! B608100,1 WAM 05/28/2007 fix bug or wrong browse ticket items when adding invoice lines
*! B608159,1 WAM 07/12/2007 Rebuild lots popup after collecting operation lots
*! B608412,1 WAM 01/20/2008 Include cost 6 & 7 while add invoice lines
*! B608409,1 SSH 01/16/2008 Incorect Taxes in distribution line screen
*! B608428,1 AKA 02/11/2008 Fix bug varbaoble "cInvNo" no found while editing Tax code in invoice detail screen
*! E302496,1 MHM 02/27/2008 Add line notes to ap dist
*! C200957,1 MHM 03/02/2008 T20070920.0001  Add register No. for All UK customers.
*! B608489,1 WAM 03/23/2008 Fix bug of PO closing entries doesn't show up [T20080214.0009]
*! B608492,1 SSH 03/23/2008 Error message when selecting TAX Code on invoice lines screen in Payable Invoice
*! B608528,1 MHM 04/21/2008 Invoice Lines-cannot amend the GL account for General Expense Item
*! B608531,1 WAM 04/23/2008 Get all style/color lines in the contribution screen [T20080417.0001]
*! B608574,1 AKA 05/28/2008 Refresh the correct GL account when change the tax code on AP invoice lines [T20080516.0001]
*! B608599,1 WAM 07/01/2008 Fix updating invoice lines in the generate lines automatically function [T20080624.0001]
*! B608642,1 WAM 08/04/2008 Fix Error while updating bug while saving invoice with contributed lines [T200800408.0001]
*! B608651,1 WAM 08/11/2008 Accumulate cost in BOMCOST when link invoice line to PO shipment
*! B608685,1 WAM 09/10/2008 Compute equivalent cost when checking balance of APDIST while saving the invoice
*! B608697,1 MMT 09/29/2008 fix bug while editing ex. rate[T20080924.0002]
*! B608730,1 WAM 10/23/2008 Fix cost calculation when assign PO to invoice by Auto option [T20081020.0012]
*! C201079,1 MMT 12/02/2008 Add disribution button to Ap invoice screen[T20080829.0003]
*! B608763,1 WAM 12/15/2008 Fix error message while saving if currency code in the header chanegd [T20081208.0006]
*! B608804,1 WAM 02/17/2009 Fix updating APDIST when AP ditribution lines amount modified [T20090203.0010]
*! B608833,1 HES 04/01/2009 Add Standared Fields for POMLINE File[T20081001.0001]
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[T20090526.0002]
*! E302623,2 MMT 10/12/2009 Convert Payable invoice screen to use SQL tables[T20090526.0002]
*! E302623,3 MMT 01/03/2010 Convert Payable invoice screen to use SQL tables[T20090526.0002]
*! E302678,1 MMT 03/24/2010 Convert Payable invoice screen to use SQL tables[T20090526.0002]

*! B609219,1 MMT 04/22/2010 error while Update in Payable invoice screen if Same PO Line rec. to diff. loc. in Same session[T20100330.0009]
*!* B609356,1 SMA 07/22/2010 Fix bug of creating empty *.cdx files [T20091027.0093]
*! B609565,1 WAM 04/10/2011 Read posting date when void invoice [T20110321.0014]
*! B609614,1 MMT 06/13/2011 Fix bug of wrong AP invoice Due date[T20110602.0031]
*! B609627,1 MMT 06/22/2011 Fix bug of Error while opening Payable invoice screen  if there is no Color segment in Style code structure[T20110609.0042]

*! E302678,3 TMI 07/21/2011 Fix problems while enabling the program to run in A4xp [ApCnvPrj] 
*************************************************************************
PARAMETERS lcVenCode,lcInvNo,lnReceipts

PRIVATE lcAllVar
lcAllVar = 'laACstType,laAddrs,laBankObjs,laCodes,laCostType,'+;
  'laICstType,laLCstType,laMCstType,laMfgCode,laMfgRFld,'+;
  'laPayMethd,laRemitTo,laSetups,laTCstType,laTaxAry,laTaxCode,laTermAry,'+;
  'lc1099Amnt,lcAPInvTkt,lcAPvInvDt,lcAccount,lcAcctDes,lcActCstDt,'+;
  'lcActCstHd,lcActProg,lcApdGLAct,lcApplied,lcApprAdj,lcApprDis,lcApprPay,'+;
  'lcAprStat,lcAutoInv,lcBFactCol,lcBankCode,lcBrowStr,lcBrowsTtl,lcCheckAcc,'+;
  'lcCodeFilt,lcColorDis,lcColorInv,lcCompany,lcCondition,lcContTtl,lcCostTtl,'+;
  'lcCutTktNo,lcData23St,lcDataDir,lcDefFact,lcDelMesag,lcDisAcct,'+;
  'lcDistAcct,lcDistPrd,'+;
  'lcDistStat,lcDistYer,lcDivision,lcDumCol,lcEmptyCode,lcExSin1,lcExSin2,'+;
  'lcExSin3,lcExSin4,lcFactCol,lcFactStat,lcFileInUse,lcFisPrd,lcFisYer,'+;
  'lcForCond,lcGLAcount,lcHidObjNrm,lcInvNo,lcLabel,lcMfgGlAcnt,'+;
  'lcOldBank,lcOldCheck,lcOldComp,lcOldCurr,lcOldFact,lcOldGLAcc,lcOldInvNo,'+;
  'lcOldPayMth,lcOldPeriod,lcOldPhone,lcOldPrior,lcOldTaxCod,lcOldTmplt,lcOldVal,'+;
  'lcOldVenCr,lcOldVenInv,lcOldVend,lcOldYear,lcOprTtl,lcPayMethd,lcPhone,lcPuDiv,'+;
  'lcPuTerm,lcRecTtl,lcRemitStat,lcRemitTo,lcScDnStat,lcScFields,lcScUpStat,'+;
  'lcSchm7Dis,lcSchm7Enb,lcSequence,lcStyCol,lcTAASTtl,lcTApAcct,lcTAplCost,'+;
  'lcTAprAmnt,lcTAprov,lcTCashAcct,lcTCashPy,lcTCashTtl,lcTChldTitl,lcTCrdtCor,'+;
  'lcTDelCor,lcTDisc,lcTFactor,lcTFully,lcTInvAmnU,lcTInvAmnt,lcTInvAmont,'+;
  'lcTInvDate,lcTInvoice,lcTOperat,lcTPart,lcTPayAcct,lcTPayTtl,lcTSave,lcTTitle,'+;
  'lcTVenInv,lcTVenKey,lcTVendCode,lcTVendor,lcTVoid,lcTaxCode,lcTaxDes,lcTempSave,'+;
  'lcTermCode,lcTermsDisp,lcTmpAplCst,lcTmpApr,lcTmpDist,lcTmpDist2,lcTmpTkt,'+;
  'lcTmplate,lcVenCode,lcVenInvTypes,lcVendor,lcWindTitl,ldOldDatInv,ldOldData,'+;
  'ldOldInvDat,llAddVen,llAutoScr,llBrowse,llCanSav,llClosed,llConFirm,llDebitM,'+;
  'llDoLocal,llDocNSupp,llFirstShow,llFirstTime,llFrmScrl,llFromVend,llGLActSta,'+;
  'llInquiry,llInvByCr,llInvCan,llLocate,llLokPer,llNewStat,llOpCmp,llOpFld,'+;
  'llPaidByCrd,llSamVendor,llSave,llShipment,llUpdInvLn,llWareHous,llZoomInvD,'+;
  'lnApQtyObj,lnApdAmnt,lnAprRate,lnAprUnit,lnBrRecNo,lnDisDays,'+;
  'lnDistAmnt,lnDueDays,lnEomDay,lnFAAp,lnFreight,'+;
  'lnInvAdj,lnInvDisc,lnInvRecNo,lnLineNo,lnMfgOpr,lnOld1099,lnOldAmnt,lnOldDisc,'+;
  'lnOldDiscOf,lnOldInvAmt,lnOldRate,lnOldRemit,lnOldValue,lnPartial,lnPercent,'+;
  'lnPrice,lnQtyObj,lnReceipts,lnRemitLen,lnStartAdr,lnTAprAmt,lnTInvAmt,'+;
  'lnTax,lnTaxCode,lnTotAppPay,llVoidDate,ldVoidDate,llEnterScr, loClickCtrl, '+;
  'FABRIC, FABDYE, POSHDR, POSLN, CUTTKTH, CUTTKTL, POFHDR, POFLN, MMFGORDH,'+;
  'MMFGORDD, BOMCOST, BOMLINE, CTKTBOM, MFGOPRDT, SHPMTHDR, lnFabMajLen, '+;
  'lnFabClrStart, lnFabClrLen, lnStyMajLen, lnStyClrStart, lnStyClrLen'

lcAllVar = lcAllVar +',llDataNotOpened,llEditButton,llDeleteButton,loconnstring' &&ASM
*! E302623,3 MMT 01/03/2010 Convert Payable invoice screen to use SQL tables[Start]
lcAllVar = lcAllVar +',lcAprCurr'
*! E302623,3 MMT 01/03/2010 Convert Payable invoice screen to use SQL tables[End]
*! B609614,1 MMT 06/13/2011 Fix bug of wrong AP invoice Due date[Start]
lcAllVar = lcAllVar +',lcEom'
*! B609614,1 MMT 06/13/2011 Fix bug of wrong AP invoice Due date[End]

DIMENSION laAllVar[1,1]
STORE '' TO laAllVar
=gfSubStr(lcAllVar,@laAllVar,',')

LOCAL lnI
FOR lnI = 1 TO ALEN(laAllVar,1)
  IF LOWER(LEFT(laAllVar[lnI,1],2)) <> 'la'
    PRIVATE &laAllVar[lnI,1].
  ENDIF
ENDFOR


PRIVATE laBankObjs


*B601526,1 Add this line and varible [Begin]
lnFAAp = 0     && Varible to hold the old valeu of laData[51] &&Old
*B601526,1 Add this line and varible [End]

llInquiry = IIF(TYPE('lcVenCode') $ 'UL',.F.,.T.)

lnReceipts = IIF(TYPE('lnReceipts') $ 'UL',0,lnReceipts)

EXTERNAL ARRAY laData,laKeyField,laScrMode,laDefProc,laField_H,laCtrStat &&Old

DECLARE laKeyField [2,4],laPayMethd[1,2],laFileStru[1], laBankObjs[3,3],;
  laAddrOrd[3,2],laRemitTo[3,2],laCostType[1],laTermAry[3,2],laTaxAry[1,2],;
  laAddrs[3] &&Old
*B604310,1 ALB Fix the due date according to the payment method [Begin]
DECLARE laTermAry[4,2]
*B604310,1 ALB Fix the due date according to the payment method [end]

DECLARE laWndObj[8,3]    && Have screen name & first & last obj. for each screen. &&Old

*B607416,1 ALB Fix bug when Saving the debit memo againest Return PO [BEGIN]
STORE .F. TO llDebitM
*B607416,1 ALB Fix bug when Saving the debit memo againest Return PO [END]

*Old: laDefProc[7]    = .F.    && Use the custom delete procedure. &&Old
*Old: laDefProc[9]    = .F.    && Use the custom save procedure. &&Old

lcDumCol        = SCHEME(1,1) &&Old
lcLoclShow      = "lfDelShow"  &&Old

laKeyField[1,1] = 'laData[1]' &&Old
laKeyField[1,2] = .F.
laKeyField[1,3] = 'VENDINV'
laKeyField[1,4] = 1

laKeyField[2,1] = 'laData[2]' &&Old
laKeyField[2,2] = .T.
laKeyField[2,3] = 'VENDINV'
laKeyField[2,4] = 2

*B603484,1 SSE 03/20/2000 Define Flag to detect whether we are inside
*B603484,1                Automatic invoice screen [Begin]
*llAutoScr = Flag to detect if we are in the Automatic invoice screen
llAutoScr = .F.
*B603484,1 SSE 03/20/2000 [End]
*B605967,1 RAE [Start]
STORE .F. TO llClosed &&Old
STORE '' TO lcCutTktNo
*B605967,1 RAE [End]
*B605746,1 RAE [Start]
STORE .F. TO llSave
*B605746,1 RAE [End]
*B601419,1 This line and Varible was added by HS [Begin]
lcLabel = 'Template :'         && Varible to hold the Template Field Label
*B601419,1 This line and Varible was added by HS [End]

laPayMethd = ''
lcPhone    = SPACE(16)   && Variable to hold the phone no.
lcCompany  = SPACE(30)   && Variable to hold the company name.

STORE ' '       TO lcTmpDist  , lcTempSave , ;
  lcTPayAcct , lcTCashAcct, lcTPayTtl  , lcTCashTtl ,;
  lcTInvAmnt , lcTInvDate , lcTVendor  , lcTInvoice ,;
  lcTApAcct  , lcTAprov   , lcTCashPy  , lcTDisc    ,;
  lcTInvAmont, lcTCrdtCor , lcTDelCor  , lcTVendCode,;
  lcDefFact  , lcCodeFilt , lcDivision , lcTermCode ,;
  lcPayMethd , lcDistAcct , lcTaxDes   , lcRemitTo  ,;
  lcTaxCode  , lcData23St , lcTAprAmnt , lcTSave    ,;
  lcTVoid    , lcTFully   , lcTPart    , lcTChldTitl,;
  lcTFactor  , lcTInvAmnU , lcBrowsTtl , lcOldPayMth,;
  lcOldBank  , lcOldCheck , lcOldVenCr , lcOldVenInv,;
  lcOldGLAcc , lcOldVend  , lcOldInvNo , lcOldPhone ,;
  lcOldComp  , lcOldPrior , lcOldFact  , lcOldTmplt ,;
  lcBrowStr  , lcTTitle   , lcVendor   , lcEmptyCode,;
  lcBankCode , lcCheckAcc , lcGLAcount , lcAcctDes  ,;
  lcApprPay  , lcApprDis  , lc1099Amnt , lcApprAdj  ,;
  lcFisYer   , lcFisPrd   , lcPuDiv    , puDivision ,;
  lcPuTerm   , puTermDes  , puTax      , puTaxDes   ,;
  lcOldYear  , lcOldPeriod, lcSequence , lcDisAcct  ,;
  lcOldTaxCod, lcTmpAplCst, lcTAplCost , lcCostTtl  ,;
  lcContTtl  , lcFileDir  , lcTAASTtl  , lcFileInUse,;
  lcCondition, lcForCond  , lcTVenInv  , lcTVenKey  ,;
  lcOldVal   , laAddrs    , lcTOperat  , lcOldCurr  ,;
  lcExSin1   , lcExSin2   , lcExSin3   , lcExSin4

*! E302623,3 MMT 01/03/2010 Convert Payable invoice screen to use SQL tables[Start]
STORE '' TO lcAprCurr
*! E302623,3 MMT 01/03/2010 Convert Payable invoice screen to use SQL tables[End]
*ASM

* B605040,1 Create temp file from AP dist [Start]
STORE ' ' TO lcTmpDist2
* B605040,1 Create temp file from AP dist [End]


*E300798,1 Intialize New variables
STORE ''  TO lcAPvInvDt   && Invoice lines temp. file name
STORE ''  TO lcAPInvTkt   && Invoice Applied lines temp. file name
STORE ''  TO lcAutoInv    && Crtae Invoice lines automatically temp. file name
STORE ''  TO lcTmpApr     && Crtae Multiple Approve temp. file name
STORE ''  TO lcApplied
STORE ''  TO lcTmpTkt     && Create Ticket details Temp. file
STORE .F. TO llZoomInvD   && Zoom Invoice Detail Browse
STORE ''  TO lcMfgGlAcnt  && Operation GL Account
DECLARE laOpnFiles[1]     && Array holds names of files opened
DECLARE laSetups[3,2]     && Array holds system setups
DECLARE laCodes[2,10],laMfgCode[1,2],laTaxCode[1,2]
DECLARE laICstType[1],laMCstType[1],laLCstType[1],laTCstType[1],laMfgRFld[1,2]
STORE '' TO laSetups
lcVenInvTypes = ''        && Vendor Invoice Types
STORE ''  TO laCodes,laMfgCode,laTaxCode
STORE 1   TO lnMfgOpr,lnTaxCode

*B602238,1 Check if the invoice lines called
STORE .F. TO llUpdInvLn
STORE 0   TO  lnTInvAmt,lnTAprAmt
*E300798,1 (END)


STORE 0         TO lnPrice    , lnFreight  , lnTax      , lnQuota    ,;
  lnTotRecAss, lnOldValue , lnBrRecNo  , lnCount    ,;
  lnInvRecNo , puMethod   , lnPartial  , lnOldAmnt  ,;
  lnOldDisc  , lnInvDisc  , lnTotAppPay, lnOld1099  ,;
  lnLineNo   , lnDueDays  , lnDisDays  , lnRemitLen ,;
  lnOldInvAmt, lnOldDiscOf, lnDistAmnt , lnInvAdj   ,;
  lnApdAmnt  , lnOldInvAmt, lnOldDiscOf, lnDistAmnt ,;
  lnInvAdj   , lnApdAmnt  , lnOldRate  , lnAprRate  ,;
  lnAprUnit

*B602946,1 Add this line to add some new variables [Begin]

*-- lcActCstHd  Variable to hold random name for the "Actual Cost" temp.
*--             header file
*-- lcActCstDt  Variable to hold random name for the "Actual Cost" temp.
*--             detail file
STORE '' TO lcActCstHd , lcActCstDt

*B602946,1 Add this line to add some new variables [End]

*B602830,1 Add this line to add some new variables [Begin]
*-- lnQtyObj      Variable to hold the object number of the Invoice Quantity
*--               Get Field to be used.
*-- lnApQtyObj    Variable to hold the object number of the Approve Quantity
*--               Get Field to be used.

STORE 0         TO lnQtyObj , lnApQtyObj
*B602830,1 Add this line to add some new variables [End]

STORE .F.       TO llConFirm  , llWareHous , llShipment , ;
  llInvCan   , llBrowse   , llNewStat  ,;
  llGLActSta , llSamVendor, llPaidByCrd, llCanSav   ,;
  llLocate   , llInvByCr  , llFirstShow, llFromVend ,;
  llFrmScrl

*B602830,1 Add this line to add some new variables [Begin]
*-- llDocNSupp    Flag to know if some of the document types that already
*--               exist in the Invoice are not supplied by the vendor
*--               anymore.

STORE .F.       TO llDocNSupp
*B602830,1 Add this line to add some new variables [End]

STORE ''        TO lcDistYer , lcDistPrd
STORE {}        TO ldOldDatInv, ldOldData  , ldOldInvDat

STORE 'DISABLE' TO lcFactStat , lcRemitStat, lcTermsDisp,;
  lcAprStat  , lcDistStat , lcTmplate,lcScUpStat,lcScDnStat &&Old

STORE 1         TO puRemitTo  , lnOldRemit ,lnStartAdr

*lcActProg  = IIF(lnReceipts = 0,'APINVPY',IIF(lnReceipts = 1,'APMATPO',IIF(lnReceipts = 2,'APSTYPO','APCUTTK')))
lcActProg   = 'APPYINV'


lcColorDis = SUBSTR(SCHEME(1,1),ATC('/',SCHEME(1,1))+1) &&Old
lcColorDis = lcColorDis+'/'+STRTRAN(lcColorDis,'*','+') &&Old
lcColorInv = SCHEME(1,1) &&Old

lcSchm7Dis = SCHEME(7,10) &&Old
lcSchm7Enb = SCHEME(7,9) &&Old

lcDelMesag = "void"
*Old: lcBFactCol = lcHidObjNrm  &&Revise
*Old: lcFactCol  = lcHidObjNrm  &&Revise

lcRecTtl   = 'Receipts'
lcOprTtl   = 'Operations Cost'
*Old: lcAAsAcc   = lcEmptyAcc  &&Revise

lcStyCol   = ''  && Variable to be add to the relation to have the ware house.

lnTime     = _DBLCLICK + SECONDS()  && Variable to hold time to consider duble click. &&Old
lnPercent  = 0.00  && Variable to hold the old value of the discount percent.

llDoLocal  = .T.   && Global variable to force the program to use the;
  SHOW FUNCTION OF the PROGRAM. &&Old

*B801499,1 Add these line to add a new variable [Begin]
**Flag to know if the Posting date falls within a locked period
llLokPer = .F.
*B801499,1 Add these line to add a new variable [End]

*B605485,1 SSH 11/Feb/2002 [Start] Add Variable for adding new vendor preveli.
llAddVen = .T.
*B605485,1 SSH [END]

*B606949,1 MAN Define the variable
STORE 0 TO lnEomDay
*! B609614,1 MMT 06/13/2011 Fix bug of wrong AP invoice Due date[Start]
STORE '' TO lcEom
*! B609614,1 MMT 06/13/2011 Fix bug of wrong AP invoice Due date[End]
*ASM, This part was taken from the Setup Code of the old APPYINV.SCX [Start]
lcTAprAmnt  = 'Total approved'
lcTSave     = 'Saving'
lcTVoid     = 'Void'
lcTChldTitl = 'Distribution lines'
lcTFully    = 'fully'
lcTPart     = 'partialy'
lcBrowsTtl  = 'View Distribution'
lcTPayAcct  = 'non-check payment G/L'
lcTCashAcct = 'cash payment'
lcTPayTtl   = 'Approved for payment'
lcTCashTtl  = 'Approved for cash payment'
lcTInvAmnt  = 'amount cannot be zero'
lcTInvDate  = 'date cannot be empty'
lcTVendor   = 'vendor'
lcTInvoice  = 'invoice number'
lcTApAcct   = 'A/P account'
lcTAprov    = 'Approved for payment'
lcTCashPy   = 'Approved for cash payment'
lcTDisc     = 'Discount'
lcTReceipt  = 'PO Receipts'
lcTOperat   = 'Invoice Manufacturing Operations'
lcTFactor   = 'factor code'
lcTInvAmont = 'invoice amount'
lcTInvDate  = 'Invoice'
lcTCrdtCor  = 'Cannot pay this invoice by '
lcTDelCor   = 'Voiding this invoice will delete its installment record'
lcTVendCode = 'Vendor code '
lcTInvAmnU  = 'Invoice amount'
lcTAplCost  = IIF(lnReceipts = 2,'Apply cost to style PO receipts','Apply cost to cutting tickets')
lcCostTtl   = 'Cost items'
lcContTtl   = 'Contribution'
*ASM, This part was taken from the Setup Code of the old APPYINV.SCX [End]


DO FORM (oAriaApplication.ScreenHome+"\AP\APPYINV.SCX")

RETURN
*--end of APPYINV.PRG

*!*************************************************************
*! Name      : lfFormInit
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 7/7/2004
*! Purpose   : Function called from the INIT event of the form
*!*************************************************************
*! Parameters: The FormSet whose init code calls the function
*!*************************************************************
*! Returns   : False  ----> If fails to open the files
*!             True   ----> otheriwse
*!*************************************************************
FUNCTION lfFormInit
  LPARAMETERS loFormSet


  LOCAL lcDir, lnFileStru, lnLoop, lnCount, lnElements, lcTemp
  LOCAL ARRAY laFileStru[1]

  loFormSet.lcCallProg='AP\APPYINV.FXP'

  =lfAddPro(loFormSet)


  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  =gfOpenTable('apinvhdr','duedate','SH')
  =gfOpenTable('apvendor','vencode','SH')
  =gfOpenTable('apdist','invvend','SH')
  =gfOpenTable('apsetup','APSETUP','SH')
  =gfOpenTable('apdiv','division','SH')
  =gfOpenTable('codes','CCODE_NO','SH')
  =gfOpenTable('apinvahd','htypcod','SH')
  =gfOpenTable('apinvtkt','lncont','SH')
  =gfOpenTable('apvinvdt','item','SH')
  =gfOpenTable('Style','Style','SH')
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

  *!*	lcDir=oAriaApplication.DataDir
  *!*
  *!*	IF ! (gfOpenFile(lcDir+'APINVHDR',lcDir+'DUEDATE','SH') AND ;
  *!*	      gfOpenFile(lcDir+'APVENDOR',lcDir+'VENCODE','SH') AND ;
  *!*	      gfOpenFile(lcDir+'APDIST',lcDir+'INVVEND','SH') AND ;
  *!*	      gfOpenFile(lcDir+'APSETUP','','SH') AND ;
  *!*	      gfOpenFile(lcDir+'APDIV',lcDir+'DIVISION','SH') AND ;
  *!*	      gfOpenFile(lcDir+'APINVAHD',lcDir+'HTYPCOD','SH') AND ;
  *!*	      gfOpenFile(lcDir+'APINVTKT',lcDir+'LNCONT','SH') AND ;
  *!*	      gfOpenFile(lcDir+'APVINVDT',lcDir+'ITEM','SH') )
  *!*	      MESSAGEBOX('Error Opening One of the Data Files')
  *!*	      loFormSet.llDataNotOpened = .T.
  *!*	  RETURN .F.
  *!*	ENDIF


  *gfOpenFile(lcDir+'CODES',lcDir+'IDRLTFNAME','SH') AND ;

  *1Q: Do we need to get previllage in Aria4 ?
  *Revise: loFormSet.llAddVen = lfGetprev()


  loFormSet.llInquiry = IIF(TYPE('loFormSet.lcVenCode') $ 'UL',.F.,.T.)
  IF loFormSet.llInquiry
    *Old: loFormSet.lcLoclShow     = 'lpShow'
    loFormSet.ActiveMode="V"
    loFormSet.FormHasToolBar='0000000'
    STORE .F. TO loFormSet.llEditButton, loFormSet.llDeleteButton &&ASM

    *Old: laCtrStat[12]  = 'ENABLE'           && Enable close buttom in the control panel
    *Revise: cmdClose exist ?
    oAriaApplication.oToolBar.cmdClose.ENABLED = .T.
    *Old: loFormSet.lcModal        = 'MODAL'
    loFormSet.WINDOWTYPE= 1
  ELSE
    *Old: loFormSet.lcModal        = ''
    loFormSet.WINDOWTYPE= 0
    loFormSet.FormHasToolBar='1101111'
    STORE .T. TO loFormSet.llEditButton, loFormSet.llDeleteButton &&ASM
    =CURSORSETPROP("Buffering" ,5,'APINVHDR')
  ENDIF


  SELECT APINVHDR

  *Old: loformset.llopcmp = lfsysopen('syccomp','ccomp_id','sh')
  *Old: loformset.lcdatadir = alltrim(iif(seek(gcprnt_cmp, 'syccomp'),gfgetdatadir(allt(syccomp.ccom_ddir)), oAriaApplication.DataDir))
  *Old: IF loFormSet.llOpCmp
  *Old: =gfCloseFile('SYCCOMP')
  *Old: ENDIF

  loFormSet.lcApdGLAct = loFormSet.AriaForm1.ap1.lcemptyacc
  loFormSet.lcApdGLAct  = loFormSet.AriaForm1.ap1.lcemptyacc

  loformset.lcdatadir=loFormSet.AriaForm1.ap1.lcDataDir
  
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *=gfOpenFile(loFormSet.lcDataDir+'FISHD','Compfyear','SH')
  =gfOpenTable(loFormSet.lcDataDir+'FISHD','Compfyear','SH')
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  
  loFormSet.llLocate    = .T.
  *Old: loformset.llopfld = lfsysopen('sydfield','','sh')
  =oAriaApplication.remotesystemdata.execute("SELECT * FROM sydField","", "sydField","",oAriaApplication.SystemConnectionString,3 ,"",SET("Datasession"))
  *loFormSet.lcTVenKey   =  ALLTRIM(LOOKUP(SYDFIELD.cFld_Head, 'CVENDCODE',;
  SYDFIELD.cFld_Name,'CFLD_NAME'))
  *loFormSet.lcTVenInv   = loFormSet.lcTVenKey + '\' + ;
  ALLTRIM(LOOKUP(SYDFIELD.cFld_Head, 'CINVNO',;
  SYDFIELD.cFld_NAme,'CFLD_NAME')) + ' : '
  loFormSet.lcTVenKey = ALLTRIM(LOOKUP(SYDFIELD.cFld_Head, 'CVENDCODE',SYDFIELD.cFld_Name))
  loFormSet.lcTVenInv = loFormSet.lcTVenKey + '\' + ;
    ALLTRIM(LOOKUP(SYDFIELD.cFld_Head, 'CINVNO',SYDFIELD.cFld_NAme)) + ' : '

  loFormSet.lcEmptyCode = gfCodDes(' ' , ' ')

  loFormSet.lcDivision  = loFormSet.lcEmptyCode
  loFormSet.lcPuDiv     = loFormSet.lcEmptyCode
  loFormSet.lcTermCode  = loFormSet.lcEmptyCode
  loFormSet.lcPuTerm    = loFormSet.lcEmptyCode

  *2Q: how will this affect the cboTermCode control ?
  loFormSet.laTermAry[1,1] = 'NTERDISCR'
  *loFormSet.laTermAry[1,2] = 'apinvhdr.nterdiscr'
  
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *loFormSet.laTermAry[1,2] = '_SCREEN.ACTIVEFORM.txtTerDiscr.Value'
  loFormSet.laTermAry[1,2] = '_SCREEN.ACTIVEFORM.pgfpayInv.pgHead.txtTerDiscr.Value'
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  
  loFormSet.laTermAry[2,1] = 'NTERDUED'
  *loFormSet.laTermAry[2,2] = 'apinvhdr.nterdued'
  
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *loFormSet.laTermAry[2,2] = '_SCREEN.ACTIVEFORM.txtterdued.Value'
  loFormSet.laTermAry[2,2] = '_SCREEN.ACTIVEFORM.pgfpayInv.pgHead.txtterdued.Value'
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  
  loFormSet.laTermAry[3,1] = 'NTERDISCD'
  *loFormSet.laTermAry[3,2] = 'apinvhdr.nterdiscd'
  
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *loFormSet.laTermAry[3,2] = '_SCREEN.ACTIVEFORM.txtTerDiscd.Value'
  loFormSet.laTermAry[3,2] = '_SCREEN.ACTIVEFORM.pgfpayInv.pgHead.txtTerDiscd.Value'
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  
  loFormSet.lnEomDay = 0
  loFormSet.laTermAry[4,1] = 'EOMDAY'
  loFormSet.laTermAry[4,2] = '_SCREEN.ACTIVEFORM.Parent.lnEomDay'

*! B609614,1 MMT 06/13/2011 Fix bug of wrong AP invoice Due date[Start]
loFormSet.lcEom = ""
DIMENSION loFormSet.laTermAry[5,2]
loFormSet.laTermAry[5,1] = 'EOM'
loFormSet.laTermAry[5,2] = '_SCREEN.ACTIVEFORM.Parent.lcEom'
*! B609614,1 MMT 06/13/2011 Fix bug of wrong AP invoice Due date[End]

  *3Q: how will this affect the cboTaxCode control ?
  loFormSet.laTaxAry[1,1]  = 'CGLINPACCT'
  
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *loFormSet.laTaxAry[1,2]  = '_SCREEN.ACTIVEFORM.glActCode.KeyTextBox.Value'
  loFormSet.laTaxAry[1,2]  = '_SCREEN.ACTIVEFORM.pgfpayInv.pgdist.glActCode.KeyTextBox.Value'
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]


  *4Q: how will this affect the kbBnkCode control and the Check Account control ?
  loFormSet.laBankObjs  = ' '
  loFormSet.laBankObjs[1,1] = 'ibBank'         && Bank code invisible button
  loFormSet.laBankObjs[1,2] = 'apinvhdr.cbnkcode'     && Bank code
  loFormSet.laBankObjs[2,1] = 'ibChecks'       && Checking account invisible button
  loFormSet.laBankObjs[2,2] = 'apinvhdr.cchkacct'     && Checking account
  loFormSet.laBankObjs[3,1] = 'ibGlAcc'        && G/L account invisible button
  loFormSet.laBankObjs[3,2] = 'apinvhdr.cchkglacc'     && G/L account


  LOCATE  && To Refresh the relation

  loFormSet.lcWindTitl='Payable Invoice' &&ASM

  IF loFormSet.llInquiry
    loFormSet.lcTTitle = loFormSet.lcWindTitl
  ELSE
    IF EMPTY(loFormSet.lcSequence)

      loFormSet.lcSequence = gfSequence('CAPSESSNO')

    ENDIF
    *loFormSet.lcTTitle = PADR(SPACE((75-LEN(loFormSet.lcWindTitl))/2)+loFormSet.lcWindTitl+SPACE((74-LEN(loFormSet.lcWindTitl))/2-20)+'Session : '+ALLTRIM(loFormSet.lcSequence),76)
    loFormSet.lcTTitle = loFormSet.lcWindTitl+SPACE(5)+'Session : '+ALLTRIM(loFormSet.lcSequence)
  ENDIF

  loFormSet.AriaForm1.CAPTION=loFormSet.lcTTitle &&ASM, Form's Caption Must be Updated

  loFormSet.llFirstTime = .T.
  *Old: SCATTER FIELDS &loFormSet.lcScFields MEMO TO laData BLANK

  *5Q: how will this affect the cboInvRemit Control ?
  
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	DIMENSION laAry[ALEN(loFormSet.laRemitTo,1),2]
  *!*	=ACOPY(loFormSet.laRemitTo,laAry)
  *!*	loFormSet.lnRemitLen   = gfGetVld('cInvRemit',@laAry)
  *!*	DIMENSION loFormSet.laRemitTo[ALEN(laAry,1),2]
  *!*	=ACOPY(laAry,loFormSet.laRemitTo)
  DIMENSION laArray[ALEN(loFormSet.laRemitTo,1),2]
  =ACOPY(loFormSet.laRemitTo,laArray)
  loFormSet.lnRemitLen   = gfGetVld('cInvRemit',@laArray)
  DIMENSION loFormSet.laRemitTo[ALEN(laArray,1),2]
  =ACOPY(laArray,loFormSet.laRemitTo)
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

  loFormSet.lcRemitTo    = loFormSet.laRemitTo[1,1]
  *6Q: how will this affect the cboVendPmeth Control ?

  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	DIMENSION laAry[ALEN(loFormSet.laPayMethd,1),2]
  *!*	=ACOPY(loFormSet.laPayMethd,laAry)
  *!*	=gfGetVld('CVENPMETH',@laAry)
  *!*	DIMENSION loFormSet.laPayMethd[ALEN(laAry,1),2]
  *!*	=ACOPY(laAry,loFormSet.laPayMethd)
  DIMENSION laArray[ALEN(loFormSet.laPayMethd,1),2]
  =ACOPY(loFormSet.laPayMethd,laArray)
  =gfGetVld('CVENPMETH',@laArray)
  DIMENSION loFormSet.laPayMethd[ALEN(laArray,1),2]
  =ACOPY(laArray,loFormSet.laPayMethd)
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

  *!*	s=''
  *!*	FOR c=1 TO ALEN(loFormSet.laPayMethd,1)
  *!*	  s=s+loFormSet.laPayMethd[c,1]+' --> '+loFormSet.laPayMethd[c,2]+CHR(13)
  *!*	NEXT
  *!*	MESSAGEBOX(s)

  *Old: IF loFormSet.llOpFld
  *Old: =gfCloseFile('SYDFIELD')
  *Old: ENDIF

  loFormSet.lcTmpDist   = gfTempName()   && Random name for the Distribution Temp. file.
  loFormSet.lcTempSave  = gfTempName()   && Random name for the Temp. Cursor to use in save.
  *Old: loFormSet.lcDisChld1  = gfTempName()   && Random name for the Dist. child screen no 1.
  *Old: loFormSet.lcDisChld2  = gfTempName()   && Random name for the Dist. child screen no 2.
  *Old: loFormSet.lcDisChld3  = gfTempName()   && Random name for the Dist. child screen no 3.
  *Old: loFormSet.lcDisChld4  = gfTempName()   && Random name for the Dist. child screen no 4.
  *Old: loFormSet.lcDisChld5  = gfTempName()   && Random name for the Dist. child screen no 5.
  *Old: loFormSet.lcDisChld6  = gfTempName()   && Random name for the Dist. child screen no 6.

  loFormSet.lcTmpDist2   = gfTempName()   && Random name for the Distribution Temp. file.


  SELECT APDIST
  =AFIELDS(laFileStru)

  *create table &oAriaApplication.WorkDir.&loformset.lctempsave from array laFileStru
  =gfCrtTmp(loFormSet.lcTempSave,@laFileStru)

  lnFileStru = ALEN(laFileStru,1)
  DIMENSION laFileStru[lnFileStru+5,18]

  laFileStru[lnFileStru+1,1] = 'CDISCRIP'
  laFileStru[lnFileStru+1,2] = 'C'
  laFileStru[lnFileStru+1,3] = 60
  laFileStru[lnFileStru+1,4] = 0

  laFileStru[lnFileStru+2,1] = 'CSTATUS'
  laFileStru[lnFileStru+2,2] = 'C'
  laFileStru[lnFileStru+2,3] = 1
  laFileStru[lnFileStru+2,4] = 0

  laFileStru[lnFileStru+3,1] = 'CUPDSERNO'
  laFileStru[lnFileStru+3,2] = 'C'
  laFileStru[lnFileStru+3,3] = 1
  laFileStru[lnFileStru+3,4] = 0

  laFileStru[lnFileStru+4,1] = 'NRECNO'
  laFileStru[lnFileStru+4,2] = 'N'
  laFileStru[lnFileStru+4,3] = 10
  laFileStru[lnFileStru+4,4] = 0

  laFileStru[lnFileStru+5,1] = 'CTAXDES'
  laFileStru[lnFileStru+5,2] = 'C'
  laFileStru[lnFileStru+5,3] = 8
  laFileStru[lnFileStru+5,4] = 0

  FOR lnLoop = 1  TO 5
    STORE '' TO laFileStru[lnFileStru+lnLoop ,7],laFileStru[lnFileStru+lnLoop  ,8],;
      laFileStru[lnFileStru+lnLoop ,9],laFileStru[lnFileStru+lnLoop  ,10],;
      laFileStru[lnFileStru+lnLoop ,11],laFileStru[lnFileStru+lnLoop ,12],;
      laFileStru[lnFileStru+lnLoop ,13],laFileStru[lnFileStru+lnLoop ,14],;
      laFileStru[lnFileStru+lnLoop ,15],laFileStru[lnFileStru+lnLoop ,16]

    STORE 0 TO  laFileStru[lnFileStru+lnLoop ,17],laFileStru[lnFileStru+lnLoop ,18]
  ENDFOR

  *create table &oAriaApplication.WorkDir.&loformset.lctmpdist from array laFileStru
  *INDEX ON cVendCode+cInvNo+STR(nApDLinNo,4) TAG (loFormSet.lcTmpDist)
  =gfCrtTmp(loFormSet.lcTmpDist,@laFileStru,;
    'cVendCode+cInvNo+STR(nApDLinNo,4)',loFormSet.lcTmpDist)


  loFormSet.laMfgRFld[1,1] = 'GLACCOUNT'
  
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *loFormSet.laMfgRFld[1,2] = '_Screen.ActiveForm.Parent.CallingForm.Parent.lcMfgGlAcnt'
  loFormSet.laMfgRFld[1,2] = '_Screen.ActiveForm.Parent.lcMfgGlAcnt'
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  
  IF 'PO' $ UPPER(oAriaApplication.CompanyInstalledModules)
    *B608412,1 WAM 01/20/2008 Include cost 6 & 7 while add invoice lines
    *!*	  STORE '' TO M_CISLBL1,M_CISLBL2,M_CISLBL3,M_CISLBL4,M_CISLBL5,;
    *!*	              M_CITYPE1,M_CITYPE2,M_CITYPE3,M_CITYPE4,M_CITYPE5
    *!*	  =gfGetMemVar('M_CISLBL1,M_CISLBL2,M_CISLBL3,M_CISLBL4,M_CISLBL5,M_CITYPE1,M_CITYPE2,M_CITYPE3,M_CITYPE4,M_CITYPE5',oAriaApplication.ActiveCompanyID)
    *!*	  lnElements = 0
    *!*	  FOR lnCount = 1 TO 5

    STORE '' TO M_CISLBL1,M_CISLBL2,M_CISLBL3,M_CISLBL4,M_CISLBL5,M_CISLBL6,M_CISLBL7,;
      M_CITYPE1,M_CITYPE2,M_CITYPE3,M_CITYPE4,M_CITYPE5,M_CITYPE6,M_CITYPE7
    =gfGetMemVar('M_CISLBL1,M_CISLBL2,M_CISLBL3,M_CISLBL4,M_CISLBL5,M_CISLBL6,M_CISLBL7,M_CITYPE1,M_CITYPE2,M_CITYPE3,M_CITYPE4,M_CITYPE5,M_CITYPE6,M_CITYPE7',oAriaApplication.ActiveCompanyID)
    lnElements = 0
    FOR lnCount = 1 TO 7
      *B608412,1 WAM 01/20/2008 (End)

      IF !INLIST(EVAL('M_CITYPE'+STR(lnCount,1)),'F','S','T')
        lnElements = lnElements + 1
        DIMENSION loFormSet.laICstType[lnElements,3]
        loFormSet.laICstType[lnElements,1] = EVAL('M_CISLBL'+STR(lnCount,1))
        loFormSet.laICstType[lnElements,2] = STR(lnCount,1)
        loFormSet.laICstType[lnElements,3] = EVAL('M_CITYPE'+STR(lnCount,1))
      ENDIF
    ENDFOR
  ENDIF
  IF 'MF' $ UPPER(oAriaApplication.CompanyInstalledModules)
    DIMENSION loFormSet.laACstType[1,3]
    loFormSet.laACstType[1,1] = 'Adorment Cost'
    loFormSet.laACstType[1,2] = '2'
    loFormSet.laACstType[1,3] = 'A'
    *B608412,1 WAM 01/20/2008 Include cost 6 & 7 while add invoice lines
    *!*	  STORE '' TO M_CMSLBL1,M_CMSLBL2,M_CMSLBL3,M_CMSLBL4,M_CMSLBL5,;
    *!*	              M_CMTYPE1,M_CMTYPE2,M_CMTYPE3,M_CMTYPE4,M_CMTYPE5
    *!*	  =gfGetMemVar('M_CMSLBL1,M_CMSLBL2,M_CMSLBL3,M_CMSLBL4,M_CMSLBL5,M_CMTYPE1,M_CMTYPE2,M_CMTYPE3,M_CMTYPE4,M_CMTYPE5',oAriaApplication.ActiveCompanyID)
    *!*	  lnElements = 0
    *!*	  FOR lnCount = 1 TO 5

    STORE '' TO M_CMSLBL1,M_CMSLBL2,M_CMSLBL3,M_CMSLBL4,M_CMSLBL5,M_CMSLBL6,M_CMSLBL7,;
      M_CMTYPE1,M_CMTYPE2,M_CMTYPE3,M_CMTYPE4,M_CMTYPE5,M_CMTYPE6,M_CMTYPE7
    =gfGetMemVar('M_CMSLBL1,M_CMSLBL2,M_CMSLBL3,M_CMSLBL4,M_CMSLBL5,M_CMSLBL6,M_CMSLBL7,M_CMTYPE1,M_CMTYPE2,M_CMTYPE3,M_CMTYPE4,M_CMTYPE5,M_CMTYPE6,M_CMTYPE7',oAriaApplication.ActiveCompanyID)
    lnElements = 0
    FOR lnCount = 1 TO 7
      *B608412,1 WAM 01/20/2008 (End)

      IF !INLIST(EVAL('M_CMTYPE'+STR(lnCount,1)),'F','S','T')
        lnElements = lnElements + 1
        DIMENSION loFormSet.laMCstType[lnElements,3]
        loFormSet.laMCstType[lnElements,1] = EVAL('M_CMSLBL'+STR(lnCount,1))
        loFormSet.laMCstType[lnElements,2] = STR(lnCount,1)
        loFormSet.laMCstType[lnElements,3] = EVAL('M_CMTYPE'+STR(lnCount,1))
      ENDIF
    ENDFOR
  ENDIF
  IF 'MA' $ UPPER(oAriaApplication.CompanyInstalledModules)
    DIMENSION loFormSet.laLCstType[4,3]
    loFormSet.laLCstType[1,1] = 'Purchase Price'
    loFormSet.laLCstType[1,2] = '1'
    loFormSet.laLCstType[1,3] = 'P'
    loFormSet.laLCstType[2,1] = 'Freight'
    loFormSet.laLCstType[2,2] = '2'
    loFormSet.laLCstType[2,3] = 'D'
    loFormSet.laLCstType[3,1] = 'Tax'
    loFormSet.laLCstType[3,2] = '3'
    loFormSet.laLCstType[3,3] = 'D'
    loFormSet.laLCstType[4,1] = 'Quota'
    loFormSet.laLCstType[4,2] = '4'
    loFormSet.laLCstType[4,3] = 'D'
    STORE '' TO M_CTSLBL1,M_CTSLBL2,M_CTSLBL3,M_CTSLBL4,;
      M_CTTYPE1,M_CTTYPE2,M_CTTYPE3,M_CTTYPE4


    =gfGetMemVar('M_CTSLBL1,M_CTSLBL2,M_CTSLBL3,M_CTSLBL4,;
                M_CTTYPE1,M_CTTYPE2,M_CTTYPE3,M_CTTYPE4',oAriaApplication.ActiveCompanyID)
    lnElements = 0
    FOR lnCount = 1 TO 4

      IF !INLIST(EVAL('M_CTTYPE'+STR(lnCount,1)),'F','S','T','A','D') AND !EMPTY(EVAL('M_CTTYPE'+STR(lnCount,1)))
        lnElements = lnElements + 1
        DIMENSION loFormSet.laTCstType[lnElements,3]
        loFormSet.laTCstType[lnElements,1] = EVAL('M_CTSLBL'+STR(lnCount,1))
        loFormSet.laTCstType[lnElements,2] = STR(lnCount,1)
        loFormSet.laTCstType[lnElements,3] = EVAL('M_CTTYPE'+STR(lnCount,1))
      ENDIF
    ENDFOR
  ENDIF

  loFormSet.laSetups[1,1] = 'M_DYELOT'
  loFormSet.laSetups[2,1] = 'M_MATDYE'
  loFormSet.laSetups[3,1] = 'M_LINK_GL'
  STORE '' TO M_DYELOT,M_MATDYE,M_LINK_GL
  =gfGetMemVar('M_DYELOT,M_MATDYE,M_LINK_GL',oAriaApplication.ActiveCompanyID)
  loFormSet.laSetups[1,2] = M_DYELOT
  loFormSet.laSetups[2,2] = M_MATDYE
  loFormSet.laSetups[3,2] = M_LINK_GL

  *Revise: This must update the Form's Controls [Start]

  loFormSet.laCodes[1,1] = "MFGCODE"
  
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	loFormSet.laCodes[1,2] = "_Screen.ActiveForm.Parent.CallingForm.Parent.laMfgCode"
  *!*	loFormSet.laCodes[1,3] = "_Screen.ActiveForm.Parent.CallingForm.Parent.lnMfgOpr"
  loFormSet.laCodes[1,2] = "_Screen.ActiveForm.Parent.laMfgCode"
  loFormSet.laCodes[1,3] = "_Screen.ActiveForm.Parent.lnMfgOpr"
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  
  loFormSet.laCodes[1,4] = ""
  loFormSet.laCodes[1,5] = .F.
  loFormSet.laCodes[1,6] = .F.
  loFormSet.laCodes[1,9] = [cVendCode+cApInvNo+cAPVILNo]
  loFormSet.laCodes[1,10] = "COPRCODE"

  loFormSet.laCodes[2,1] = "CTAXCODE"
  
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	loFormSet.laCodes[2,2] = "_Screen.ActiveForm.Parent.CallingForm.Parent.laTaxCode"
  *!*	loFormSet.laCodes[2,3] = "_Screen.ActiveForm.Parent.CallingForm.Parent.lnTaxCode"
  loFormSet.laCodes[2,2] = "_Screen.ActiveForm.Parent.laTaxCode"
  loFormSet.laCodes[2,3] = "_Screen.ActiveForm.Parent.lnTaxCode"
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  
  loFormSet.laCodes[2,4] = ""
  loFormSet.laCodes[2,5] = .F.
  loFormSet.laCodes[2,6] = .T.
  loFormSet.laCodes[2,9] = [cVendCode+cApInvNo+cAPVILNo]
  loFormSet.laCodes[2,10] = "CTAXCODE"

  *Revise: This must update the Form's Controls [End]

  loFormSet.lcAPvInvDt = gfTempName()   && Random name for Invoice lines temp. file
  loFormSet.lcAPInvTkt = gfTempName()   && Random name for Invoice Applied lines temp. file
  loFormSet.lcAutoInv  = gfTempName()   && Random name for Invoice lines automatically temp. file name
  loFormSet.lcTmpApr   = gfTempName()   && Random name for multiple approve temp file.
  loFormSet.lcApplied  = gfTempName()
  loFormSet.lcTmpTkt   = gfTempName()   && Random name for Ticket details file

  loFormSet.lcActCstHd = gfTempName()   && Random name for the "Actual Cost" temp. header file
  loFormSet.lcActCstDt = gfTempName()   && Random name for the "Actual Cost" temp. detail file


  *create table (oAriaApplication.WorkDir+loformset.lcautoinv) ;
  *(cSelect C(1), Item C(19),Color C(6),cWareCode C(6), cDyelot C(10),LineNo N(6),;
  *cTktNo C(6),nTktQty1 N(6),nTktQty2 N(6),nTktQty3 N(6),nTktQty4 N(6),nTktQty5 N(6),;
  *nTktQty6 N(6),nTktQty7 N(6),nTktQty8 N(6), nTktQty N(11,3),nTktCst N(13,3),;
  *nTktAmnt N(14,2), nAplQty1 N(6),nAplQty2 N(6),nAplQty3 N(6),nAplQty4 N(6),;
  *nAplQty5 N(6),nAplQty6 N(6),nAplQty7 N(6),nAplQty8 N(6),nAplQty N(11,3), nAplAmnt N(14,2),;
  *nInvQty1 N(6),nInvQty2 N(6),nInvQty3 N(6),nInvQty4 N(6), nInvQty5 N(6),;
  *nInvQty6 N(6),nInvQty7 N(6),nInvQty8 N(6), nInvQty N(11,3), nInvAmnt N(14,2),cRecvType C(1),cWIPAcct C(24) )
  lfCrtTmp(loformset.lcAutoInv, ;
    "cSelect C(1), Item C(19),Color C(6),cWareCode C(6), cDyelot C(10),LineNo N(6),"+;
    "cTktNo C(6),nTktQty1 N(6),nTktQty2 N(6),nTktQty3 N(6),nTktQty4 N(6),nTktQty5 N(6),"+;
    "nTktQty6 N(6),nTktQty7 N(6),nTktQty8 N(6), nTktQty N(11,3),nTktCst N(13,3),"+;
    "nTktAmnt N(14,2), nAplQty1 N(6),nAplQty2 N(6),nAplQty3 N(6),nAplQty4 N(6),"+;
    "nAplQty5 N(6),nAplQty6 N(6),nAplQty7 N(6),nAplQty8 N(6),nAplQty N(11,3), nAplAmnt N(14,2),"+;
    "nInvQty1 N(6),nInvQty2 N(6),nInvQty3 N(6),nInvQty4 N(6), nInvQty5 N(6),"+;
    "nInvQty6 N(6),nInvQty7 N(6),nInvQty8 N(6), nInvQty N(11,3), nInvAmnt N(14,2),cRecvType C(1),cWIPAcct C(24)" ,;
    'cSelect+Item+cWareCode+cDyelot','SELECT')
  *INDEX ON cSelect+Item+cWareCode+cDyelot TAG 'SELECT'
  SELECT (loformset.lcAutoInv)
  INDEX ON ITEM+cWareCode+cDyelot+cTktNo TAG (loFormSet.lcAutoInv) ADDITIVE

  SELECT APVINVDT
  =AFIELDS(laFileStru)
  lnFileStru = ALEN(laFileStru,1)
  DIMENSION laFileStru[lnFileStru+2,18]
  laFileStru[lnFileStru+1,1] = 'cStatus'
  laFileStru[lnFileStru+1,2] = 'C'
  laFileStru[lnFileStru+1,3] = 1
  laFileStru[lnFileStru+1,4] = 0
  laFileStru[lnFileStru+2,1] = 'NRECNO'
  laFileStru[lnFileStru+2,2] = 'N'
  laFileStru[lnFileStru+2,3] = 5
  laFileStru[lnFileStru+2,4] = 0

  FOR lnLoop = 1  TO 2
    STORE '' TO laFileStru[lnFileStru+lnLoop ,7],laFileStru[lnFileStru+lnLoop  ,8],;
      laFileStru[lnFileStru+lnLoop ,9],laFileStru[lnFileStru+lnLoop  ,10],;
      laFileStru[lnFileStru+lnLoop ,11],laFileStru[lnFileStru+lnLoop ,12],;
      laFileStru[lnFileStru+lnLoop ,13],laFileStru[lnFileStru+lnLoop ,14],;
      laFileStru[lnFileStru+lnLoop ,15],laFileStru[lnFileStru+lnLoop ,16]

    STORE 0 TO  laFileStru[lnFileStru+lnLoop ,17],laFileStru[lnFileStru+lnLoop ,18]
  ENDFOR

  *create table &oAriaApplication.WorkDir.&loformset.lcapvinvdt from array laFileStru
  *INDEX ON cIMTyp+cTktNo+cLotNo+STR(LineNo,6)+cBomType+cOprCode+Item+Color+cDyelot TAG ITEM
  =gfCrtTmp(loFormSet.lcapvinvdt,@laFileStru,;
    'cIMTyp+cTktNo+cLotNo+STR(LineNo,6)+cBomType+cOprCode+Item+Color+cDyelot','ITEM')
  SELECT (loFormSet.lcapvinvdt)
  INDEX ON cVendCode+cApInvNo+cAPVILNo TAG (loFormSet.lcAPvInvDt) ADDITIVE
  INDEX ON cApDGlAct TAG ADJUST ADDITIVE


  SELECT APINVTKT
  =AFIELDS(laFileStru)
  lnFileStru = ALEN(laFileStru,1)
  DIMENSION laFileStru[lnFileStru+2,18]
  laFileStru[lnFileStru+1,1] = 'cStatus'
  laFileStru[lnFileStru+1,2] = 'C'
  laFileStru[lnFileStru+1,3] = 1
  laFileStru[lnFileStru+1,4] = 0
  laFileStru[lnFileStru+2,1] = 'NRECNO'
  laFileStru[lnFileStru+2,2] = 'N'
  laFileStru[lnFileStru+2,3] = 5
  laFileStru[lnFileStru+2,4] = 0

  FOR lnLoop = 1  TO 2
    STORE '' TO laFileStru[lnFileStru+lnLoop ,7],laFileStru[lnFileStru+lnLoop  ,8],;
      laFileStru[lnFileStru+lnLoop ,9],laFileStru[lnFileStru+lnLoop  ,10],;
      laFileStru[lnFileStru+lnLoop ,11],laFileStru[lnFileStru+lnLoop ,12],;
      laFileStru[lnFileStru+lnLoop ,13],laFileStru[lnFileStru+lnLoop ,14],;
      laFileStru[lnFileStru+lnLoop ,15],laFileStru[lnFileStru+lnLoop ,16]

    STORE 0 TO  laFileStru[lnFileStru+lnLoop ,17],laFileStru[lnFileStru+lnLoop ,18]
  ENDFOR

  *create table &oAriaApplication.WorkDir.&loformset.lcapinvtkt from array laFileStru
  *INDEX ON cIMTyp+cTktNo+STR(LineNo,6)+cRSession TAG Ticket
  =gfCrtTmp(loFormSet.lcapinvtkt,@laFileStru,;
    'cIMTyp+cTktNo+STR(LineNo,6)+cRSession','Ticket')
  SELECT (loFormSet.lcapinvtkt)
  INDEX ON cVendCode+cApInvNo+cApVILNo+cRSession TAG (loFormSet.lcAPInvTkt) ADDITIVE

  *Old: IF _WINDOWS
  IF EMPTY(apinvhdr.ctermcode)
    *Revise: This must update the Form's Controls
    loFormSet.lcPuTerm = loFormSet.lcEmptyCode
  ENDIF


  *Old: DEFINE POPUP puTermDes PROMPT field CODES.cdiscrep scroll;
  FROM 10.83,2.25 TO 18.83,35.35 ;
  MESSAGE gfObj_msg()

  *Old: ON SELECTION POPUP puTermDes DO lfvTermCode
  IF EMPTY(apinvhdr.cdivision)
    *Revise: This must update the Form's Controls
    loFormSet.lcPuDiv = loFormSet.lcEmptyCode
  ENDIF

  *Old: DEFINE POPUP puDivision PROMPT field CODES.cdiscrep scroll;
  FROM 14.00,2.25 TO 22.00,37.00 ;
  MESSAGE gfObj_msg()

  *Old: ON SELECTION POPUP puDivision DO lfvDivision

  *Revise: This must update the Form's Controls
  *Old: puTax = CODES.cdiscrep

  *Old: DEFINE POPUP puTaxDes PROMPT field CODES.cdiscrep scroll;
  FROM 2.35,38.00 TO 9.35,69.30 ;
  MESSAGE gfObj_msg()

  *Old: ON SELECTION POPUP puTaxDes DO lfvTaxCode
  *Old: ENDIF

  SELECT CODES

  *SET ORDER  TO TAG IDRLTFNAME
  lcTemp="'NN"+loFormSet.lcCodeFilt+"'"
  *SET FILTER TO (CDEFCODE+CRLTFIELD+CFLD_NAME = &lcTemp) OR CDEFCODE+CRLTFIELD+CFLD_NAME = ' '+'N'+'N/A'
  SELECT APINVHDR
  
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *SET ORDER TO TAG VENDINV
  gfSETORDER("VENDINV")
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  
  SET FILTER TO CINVSTAT <> 'V'

  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	SET RELATION TO apinvhdr.cvendcode INTO APVENDOR ADDITIVE
  *!*	SET RELATION TO APINVHDR.CINVNO+APINVHDR.CVENDCODE INTO APDIST ADDITIVE
  *!*	SET RELATION TO apinvhdr.cdivision INTO APDIV ADDITIVE
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

  SELECT APDIST
  SCATTER MEMVAR MEMO

  SELECT APINVHDR

  IF loFormSet.llLocate
    GO BOTTOM
    IF !EOF()
      SKIP
    ENDIF
    loFormSet.llLocate = .F.
  ENDIF


  *Old: loFormSet.laWndObj [1,1] = gcBaseWind
  *Old: loFormSet.laWndObj [1,2] = "IBVENDOR"
  *Old: loFormSet.laWndObj [1,3] = "PBNOTE"

  *Old: loFormSet.laWndObj [2,1] = loFormSet.lcDisChld1
  *Old: loFormSet.laWndObj [2,2] = "apinvhdr.capacct"
  *Old: loFormSet.laWndObj [2,3] = "PBCLOSE"

  *Old: loFormSet.laWndObj [3,1] = loFormSet.lcDisChld3
  *Old: loFormSet.laWndObj [3,2] = "apinvhdr.capacct"
  *Old: loFormSet.laWndObj [3,3] = "PBCLOSE"

  *Old: loFormSet.laWndObj [4,1] = loFormSet.lcDisChld4
  *Old: loFormSet.laWndObj [4,2] = "apinvhdr.capacct"
  *Old: loFormSet.laWndObj [4,3] = "PBCLOSE"

  *Old: loFormSet.laWndObj [5,1] = loFormSet.lcDisChld5
  *Old: loFormSet.laWndObj [5,2] = "apinvhdr.capacct"
  *Old: loFormSet.laWndObj [5,3] = "PBCLOSE"

  *Old: loFormSet.laWndObj [6,1] = loFormSet.lcDisChld6
  *Old: loFormSet.laWndObj [6,2] = "apinvhdr.capacct"
  *Old: loFormSet.laWndObj [6,3] = "PBCLOSE"

  *Old: loFormSet.laWndObj [7,1] = "CWRAPDISTR"
  *Old: loFormSet.laWndObj [7,2] = "apinvhdr.capacct"
  *Old: loFormSet.laWndObj [7,3] = "PBCLOSE"

  *Old: loFormSet.laWndObj [8,1] = "GWCCONTRL1"
  *Old: loFormSet.laWndObj [8,2] = "PBTOP"
  *Old: loFormSet.laWndObj [8,3] = "PBCLS"

  *Old: PUSH KEY

  *Old: ON KEY LABEL CTRL+W     loFormSet.lnDummy = 1
  *Old: ON KEY LABEL Ctrl+Q     loFormSet.lnDummy = 1
  *Old: ON KEY LABEL CTRL+HOME  loFormSet.lnDummy = 1
  *Old: ON KEY LABEL CTRL+END   loFormSet.lnDummy = 1
  *Old: ON KEY LABEL Ctrl+ENTER loFormSet.lnDummy = 1

  =loFormSet.mOptionMenu()

  *Old: DECLARE loFormSet.laPanelObj[1,3]
  *Old: STORE '' TO loFormSet.laPanelObj
  *Old: loFormSet.laPanelObj[1,1] = 'pbAPVInvDt'
  *Old: loFormSet.laPanelObj[1,2] = gcBmpHome+'NOTES2.BMP'
  *Old: loFormSet.laPanelObj[1,3] = [VALID lfvInvDt() MESSAGE 'Invoice Details' DISABLE]


  *ASM, Here he was calling appyinv.spr

  loFormSet.DATAENVIRONMENT.INITIALSELECTEDALIAS = 'APINVHDR'
  WITH loFormSet.AriaForm1
    .KBVendCode.keyTextBox.CONTROLSOURCE = "apinvhdr.cvendcode"
    .KBVendCompany.keyTextBox.CONTROLSOURCE = "APVENDOR.cVenComp"
    .KBVendPhone.keyTextBox.CONTROLSOURCE = "APVENDOR.cPhoneNo"
    .KBVendPhone.keyTextBox.INPUTMASK = gfPhoneTem()
    .kbInvNo.keyTextBox.CONTROLSOURCE = "apinvhdr.cinvno"
    .DtPostDate.CONTROLSOURCE = "apinvhdr.dpostdate"
    
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *.DtInvDate.ControlSource = "apinvhdr.dinvdate"
    *.txtInvAmount.ControlSource = "apinvhdr.ninvamnt"
    *.txtInvDisof.ControlSource = "apinvhdr.ninvdisof"
    *.cboTermCode.ControlSource = "apinvhdr.ctermcode"
    *.cboDivision.ControlSource = "apinvhdr.cdivision"
    *.txtInvRef.ControlSource = "apinvhdr.cinvref"
    *.cboInvRemit.ControlSource = "apinvhdr.cinvremit"
    *.kbFacCode.keyTextBox.ControlSource = "apinvhdr.cfaccode"
    *!*	  .txtOutComp.ControlSource = "apinvhdr.coutcomp"
    *!*	  .txtOutAddr1.ControlSource = "apinvhdr.coutaddr1"
    *!*	  .txtOutAddr2.ControlSource = "apinvhdr.coutaddr2"
    *!*	  .txtOutAddr3.ControlSource = "apinvhdr.coutaddr3"
    *!*	.txtVendPrior.ControlSource = "apinvhdr.cvenprior"
    *!*	.kbCurrCode.keyTextBox.ControlSource = "apinvhdr.ccurrcode"
    *!*	.txtNexRate.ControlSource = "apinvhdr.nexrate"
    *!*	.cboVendPmeth.ControlSource = "apinvhdr.cvenpmeth"
    *!*	.txtterdued.ControlSource = "apinvhdr.nterdued"
    *!*	  .txtTerDiscd.ControlSource = "apinvhdr.nterdiscd"
    *!*	  .txtTerDiscr.ControlSource = "apinvhdr.nterdiscr"
    *!*	.dtInvDuDat.ControlSource = "apinvhdr.dinvdudat"
    *!*	.txtPaidAmount.ControlSource = "lfPaidAmount(0)"
    *!*	.txtDiscTaken.ControlSource = "apinvhdr.ninvdistk"
    *!*	.txtPaid1099.ControlSource = "apinvhdr.ninv1099a"
    *!*	.txttotApproved.ControlSource = "thisform.parent.lnTotAppPay"
    .pgfpayInv.pgHead.DtInvDate.CONTROLSOURCE = "apinvhdr.dinvdate"
    .pgfpayInv.pgHead.txtInvAmount.CONTROLSOURCE = "apinvhdr.ninvamnt"
    .pgfpayInv.pgHead.txtInvDisof.CONTROLSOURCE = "apinvhdr.ninvdisof"
    .pgfpayInv.pgHead.cboTermCode.CONTROLSOURCE = "apinvhdr.ctermcode"
    .pgfpayInv.pgHead.cboDivision.CONTROLSOURCE = "apinvhdr.cdivision"
    .pgfpayInv.pgHead.txtInvRef.CONTROLSOURCE = "apinvhdr.cinvref"
    .pgfpayInv.pgHead.cboInvRemit.CONTROLSOURCE = "apinvhdr.cinvremit"
    .pgfpayInv.pgHead.kbFacCode.keyTextBox.CONTROLSOURCE = "apinvhdr.cfaccode"
    .pgfpayInv.pgHead.txtOutComp.CONTROLSOURCE = "apinvhdr.coutcomp"
    .pgfpayInv.pgHead.txtOutAddr1.CONTROLSOURCE = "apinvhdr.coutaddr1"
    .pgfpayInv.pgHead.txtOutAddr2.CONTROLSOURCE = "apinvhdr.coutaddr2"
    .pgfpayInv.pgHead.txtOutAddr3.CONTROLSOURCE = "apinvhdr.coutaddr3"
    .pgfpayInv.pgHead.txtVendPrior.CONTROLSOURCE = "apinvhdr.cvenprior"
    .pgfpayInv.pgHead.kbCurrCode.keyTextBox.CONTROLSOURCE = "apinvhdr.ccurrcode"
    .pgfpayInv.pgHead.txtNexRate.CONTROLSOURCE = "apinvhdr.nexrate"
    .pgfpayInv.pgHead.cboVendPmeth.CONTROLSOURCE = "apinvhdr.cvenpmeth"
    .pgfpayInv.pgHead.txtterdued.CONTROLSOURCE = "apinvhdr.nterdued"
    .pgfpayInv.pgHead.txtTerDiscd.CONTROLSOURCE = "apinvhdr.nterdiscd"
    .pgfpayInv.pgHead.txtTerDiscr.CONTROLSOURCE = "apinvhdr.nterdiscr"
    .pgfpayInv.pgHead.dtInvDuDat.CONTROLSOURCE = "apinvhdr.dinvdudat"
    .pgfpayInv.pgHead.txtPaidAmount.CONTROLSOURCE = "lfPaidAmount(0)"
    .pgfpayInv.pgHead.txtDiscTaken.CONTROLSOURCE = "apinvhdr.ninvdistk"
    .pgfpayInv.pgHead.txtPaid1099.CONTROLSOURCE = "apinvhdr.ninv1099a"
    .pgfpayInv.pgHead.txttotApproved.CONTROLSOURCE = "thisform.parent.lnTotAppPay"
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]



    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *!*	  .txtVenOpnDr.ControlSource = "APVENDOR.NVENOPNDR"
    *!*	  .txtVenCrLim.ControlSource = "APVENDOR.NVENCRLIM"
    *!*	  .dtVenlPurd.ControlSource = "APVENDOR.DVENLPURD"
    *!*	  .txtVenBal.ControlSource = "APVENDOR.NVENBAL"
    *!*	  .txtAvlCrLim.ControlSource = "lfAvlCrLim(0)"
    *!*	  .dtVenlPayd.ControlSource = "APVENDOR.DVENLPAYD"
    *.kbAutmCode.keyTextBox.ControlSource = "apinvhdr.cautmcode"
    .pgfpayInv.pgHead.kbAutmCode.keyTextBox.CONTROLSOURCE = "apinvhdr.cautmcode"
    .pgfpayInv.pgHead.txtVenOpnDr.CONTROLSOURCE = "APVENDOR.NVENOPNDR"
    .pgfpayInv.pgHead.txtVenCrLim.CONTROLSOURCE = "APVENDOR.NVENCRLIM"
    .pgfpayInv.pgHead.dtVenlPurd.CONTROLSOURCE = "APVENDOR.DVENLPURD"
    .pgfpayInv.pgHead.txtVenBal.CONTROLSOURCE = "APVENDOR.NVENBAL"
    .pgfpayInv.pgHead.txtAvlCrLim.CONTROLSOURCE = "lfAvlCrLim(0)"
    .pgfpayInv.pgHead.dtVenlPayd.CONTROLSOURCE = "APVENDOR.DVENLPAYD"
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    
  ENDWITH

  *on error MESSAGEBOX(PADR(error(),10)+CHR(13)+program()+PADR(lineno(),10)+CHR(13)+message())
  *on error MESSAGEBOX(_screen.ActiveForm.activecontrol.name)
  *on ERROR wait wind RELATION(1)+' into '+TARGET(1)+' - '+RELATION(2)+' into '+TARGET(2)+' - '+;
  RELATION(3)+' into '+TARGET(3)
  *ON ERROR susp

  lfGetItemMask(loFormSet,'0001')
  lfGetItemMask(loFormSet,'0002')

  RETURN .T.
  *--end of lfFormInit


  *!*************************************************************
  *! Name      : lfAddPro
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 7/7/2004
  *! Purpose   : function to Add properties to the FormSet.
  *!*************************************************************
  *! Parameters: The FomrSet
  *!*************************************************************
  *! Returns   : None
  *!*************************************************************
FUNCTION lfAddPro
  LPARAMETERS loFormSet

  LOCAL lnI, lnRow, lnCol, lcACopy
  FOR lnI = 1 TO ALEN(laAllVar,1)
    IF LOWER(LEFT(laAllVar[lnI,1],2)) = 'la'
      IF TYPE(laAllVar[lnI,1])='U'
        loFormSet.ADDPROPERTY(laAllVar[lnI,1]+'[1]')
        LOOP
      ENDIF
      lnRow = ALEN(laAllVar[lnI,1],1)
      lnCol = ALEN(laAllVar[lnI,1],2)
      IF lnCol>0
        loFormSet.ADDPROPERTY(laAllVar[lnI,1]+'['+ALLTRIM(STR(lnRow))+;
          ','+ALLTRIM(STR(lnCol))+']')
      ELSE
        loFormSet.ADDPROPERTY(laAllVar[lnI,1]+'['+ALLTRIM(STR(lnRow))+']')
      ENDIF
      lcACopy = '=ACOPY(' + laAllVar[lnI,1] + ',loFormSet.' + laAllVar[lnI,1] + ')'
      &lcACopy.
    ELSE
      loFormSet.ADDPROPERTY(laAllVar[lnI,1],IIF(TYPE(laAllVar[lnI,1])<>'U',EVALUATE(laAllVar[lnI,1]),.F.))
    ENDIF
  ENDFOR
  *--end of lfAddPro


  *!*************************************************************
  *! Name      : lfGetItemMask
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 7/7/2004
  *! Purpose   : function to Calculate the Major Length, Color Start Position and Color Lenght
  *!             for either the Style or Fabric and store them in the FormSet Properties
  *!*************************************************************
  *! Parameters: The FormSet, The InvType
  *!*************************************************************
  *! Returns   : None
  *!*************************************************************
FUNCTION lfGetItemMask
  LPARAMETERS loFormSet, lcInvType
  LOCAL oGetItemMask, lcMjrPct, lnMatMajLen
*! B609627,1 MMT 06/22/2011 Fix bug of Error while opening Payable invoice screen  if there is no Color segment in Style code structure[START]
STORE 0 TO lnFbrClrStr,lnFbrClrLen
*! B609627,1 MMT 06/22/2011 Fix bug of Error while opening Payable invoice screen  if there is no Color segment in Style code structure[END]
  oGetItemMask = CREATEOBJECT('GetItemMask')
  lcMjrPct     = oGetItemMask.DO('PM','',lcInvType) &&Major picture
  lnMatMajLen  = LEN(lcMjrPct)                      &&Major Part lenth
  IF lcInvType='0001'
    loFormSet.lnStyMajLen = lnMatMajLen
  ELSE
    loFormSet.lnFabMajLen = lnMatMajLen
  ENDIF

  DIMENSION laStySeg[1,1]

  *B608531,1 WAM 04/23/2008 Get the proper item type code structure
  *=oGetItemMask.Do(@laStySeg,'','0002')
  =oGetItemMask.DO(@laStySeg,'',lcInvType)
  *B608531,1 WAM 04/23/2008 (End)

  FOR lnCnt = 1 TO ALEN(laStySeg,1)
    IF laStySeg[lnCnt , 1] = "C"
      lnFbrClrStr = laStySeg[lnCnt , 4]
      lnFbrClrLen = LEN(laStySeg[lnCnt , 3])
    ENDIF
  ENDFOR
  IF lcInvType='0001'
    loFormSet.lnStyClrStart = lnFbrClrStr
    loFormSet.lnStyClrLen = lnFbrClrLen
  ELSE
    loFormSet.lnFabClrStart = lnFbrClrStr
    loFormSet.lnFabClrLen = lnFbrClrLen
  ENDIF

  RETURN
  *--end of lfGetItemMask


  *!*************************************************************
  *! Name      : lfPaidAmount
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 7/12/2004
  *! Purpose   : Control Source value for the paid amount
  *!*************************************************************
  *! Parameters: Dummy Value
  *!*************************************************************
  *! Returns   : lnPaidAmount
  *!*************************************************************
FUNCTION lfPaidAmount
  LPARAMETERS lnDummy

  LOCAL lnPaidAmount
  lnPaidAmount = apinvhdr.ninvpaid + apinvhdr.ninvadj
  RETURN lnPaidAmount

  *!*************************************************************
  *! Name      : lfAvlCrLim
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 7/12/2004
  *! Purpose   : Control Source value for the Current Credit Limit
  *!*************************************************************
  *! Parameters: Dummy Value
  *!*************************************************************
  *! Returns   : lnAvlCrLim
  *!*************************************************************
FUNCTION lfAvlCrLim
  LPARAMETERS lnDummy

  LOCAL lnAvlCrLim
  lnAvlCrLim = APVENDOR.NVENCRLIM - ROUND(APVENDOR.NVENBAL,0)
  RETURN lnAvlCrLim


  *!*************************************************************
  *! Name      : lfUnDistAmnt
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 7/12/2004
  *! Purpose   : Control Source For the Undistributed Amount in DistLines Screen
  *!*************************************************************
  *! Parameters: Dummy Value
  *!*************************************************************
  *! Returns   : lnAvlCrLim
  *!*************************************************************
FUNCTION lfUnDistAmnt
  LPARAMETERS lnDummy

  LOCAL lnUnDistAmnt, lnDistAmnt
   *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  IF TYPE('_SCREEN.ACTIVEFORM.PARENT.lnDistAmnt') = 'U'
    RETURN 
  ENDIF 
   *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  lnDistAmnt = _SCREEN.ACTIVEFORM.PARENT.lnDistAmnt
  
  lnUnDistAmnt = IIF(apinvhdr.ninvamnt< 0,apinvhdr.ninvamnt+ABS(lnDistAmnt),;
    apinvhdr.ninvamnt-lnDistAmnt)
  RETURN lnUnDistAmnt



  *!*************************************************************
  *! Name      : lfFormActivate
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 7/12/2004
  *! Purpose   : Function called from the Activate event of the form
  *!*************************************************************
  *! Parameters: The FormSet whose Activate code calls the function
  *!*************************************************************
  *! Returns   : None
  *!*************************************************************
FUNCTION lfFormActivate
  LOCAL loFormSet

  IF TYPE('_Screen.ActiveForm.Parent')<>'O' OR _SCREEN.ACTIVEFORM.PARENT.NAME<>'frmAPInvoice'
    RETURN
  ENDIF
  loFormSet = _SCREEN.ACTIVEFORM.PARENT

  *ASM, code that was found in the Else part of IF !WEXIST Statement [Start]

  IF loFormSet.lnInvRecNo < RECCOUNT() AND loFormSet.lnInvRecNo > 0
    GO loFormSet.lnInvRecNo
  ENDIF

  loFormSet.llFirstShow= .T.

  *Revise: cvenpmeth may represent a control value not a property
  *IF apinvhdr.cvenpmeth = 'C' .and. loFormSet.ActiveMode="V"  &&BOHO
  
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	IF loFormSet.AriaForm1.cboVendPmeth.Value = 'C' .and. loFormSet.ActiveMode="V"
  IF loFormSet.AriaForm1.pgfpayInv.pgHead.cboVendPmeth.VALUE = 'C' .AND. loFormSet.ActiveMode="V"
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    *ASM, Disabling Edit Button
    loFormSet.llEditButton = .F.
    *laCtrStat[7]  = "DISABLE"                && Edit button
  ENDIF
  IF !EMPTY(apinvhdr.cvenpmeth) &&Revise
    *Old: loFormSet.lcPayMethd = loFormSet.laPayMethd[AT(apinvhdr.cvenpmeth,'PMNCH'),1]
    *puMethod   = AT(apinvhdr.cvenpmeth,'PMNCH') &&BOHO
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *!*	    puMethod   = AT(loFormSet.AriaForm1.cboVendPmeth.Value,'PMNCH') &&Revise *7Q: Is this line necessary ?
    puMethod   = AT(loFormSet.AriaForm1.pgfpayInv.pgHead.cboVendPmeth.VALUE,'PMNCH') &&Revise *7Q: Is this line necessary ?
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  ENDIF

  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *IF SEEK(apinvhdr.cfisfyear,'FISHD')
  IF gfSEEK(apinvhdr.cfisfyear,'FISHD')
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    
    IF FISHD.CFISYSTAT <> 'H';
        .AND. apinvhdr.cvenpmeth <> 'C';
        .AND. APINVHDR.CINVSTAT <> 'A';
        .AND. loFormSet.ActiveMode="V"
      *ASM, Enabling Edit Button
      loFormSet.llEditButton = .T.
      *laCtrStat[7]  = "ENABLE"                && Edit button
      *ASM, Enabling Delete Button
      loFormSet.llDeleteButton = .T.
      *laCtrStat[8]  = "ENABLE"                && Delete button
    ELSE
      *ASM, Disabling Edit Button
      loFormSet.llEditButton = .F.
      *laCtrStat[7]  = "DISABLE"               && Edit button
      *ASM, Disabling Delete Button
      loFormSet.llDeleteButton = .F.
      *laCtrStat[8]  = "DISABLE"               && Delete button
    ENDIF
  ELSE
    *ASM, Disabling Edit Button
    loFormSet.llEditButton = .F.
    *laCtrStat[7]  = "DISABLE"               && Edit button
    *ASM, Disabling Delete Button
    loFormSet.llDeleteButton = .F.
    *laCtrStat[8]  = "DISABLE"               && Delete button
  ENDIF

  *Revise: puremitto may represent a control value not a property
  puRemitTo  = loFormSet.lnOldRemit

  *ASM, code that was found in the Else part of IF !WEXIST Statement [End]

  *ASM, code that was in the lfActivate Function [Start]
  SELECT APINVHDR

  *Old: IF !WVISIBLE(WPARENT(WOUTPUT()))
  *Old: SHOW WINDOW (WPARENT(WOUTPUT())) TOP
  *Old: ENDIF
  *Old: IF WPARENT(WOUTPUT()) = 'CWRAPDISTR'
  IF !loFormSet.llFromVend
    =lfTaxAct(loFormSet)
  ENDIF
  *Old: ON KEY LABEL ALT+C ACTIVATE WINDOW (lcBrowsTtl)
  *Old: IF !WEXIST(lcBrowsTtl)
  =lfBrowse(loFormSet)
  *Old: ELSE
  *Old: SHOW WINDOW(lcBrowsTtl) REFRESH SAME
  *Old: ENDIF

  *8Q: What will I do with the trapping functions ?
  *Old: IF WONTOP() = lcBrowsTtl
  *Old: =lfSetTrap()
  *Old: ELSE
  *Old: =lfResetTrap()
  *Old: =lfRelease() &&9Q: Why calling lfRelease here ? &&Revise
  *Old: ENDIF
  *Old: ELSE
  *Old:   IF WEXIST(lcBrowsTtl)
  *Old:     SHOW WINDOW (lcBrowsTtl) REFRESH SAME
  *Old:   ENDIF
  *Old:   =lfResetTrap()
  *Old:   =lfRelease()
  *Old: ENDIF

  SELECT APINVHDR

  *ASM, code that was in the lfActivate Function [End]

  RETURN
  *--end of lfFormActivate



  *!*************************************************************
  *! Name      : lfFormDeActivate
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 7/12/2004
  *! Purpose   : Function called from the DeActivate event of the form
  *!*************************************************************
  *! Parameters: The FormSet whose DeActivate code calls the function
  *!*************************************************************
  *! Returns   : None
  *!*************************************************************
FUNCTION lfFormDeActivate
  LOCAL loFormSet

  IF TYPE('_Screen.ActiveForm.Parent')<>'O' OR _SCREEN.ACTIVEFORM.PARENT.NAME<>'frmAPInvoice'
    RETURN
  ENDIF
  *ASM, code that was in the lfRelease Function [Start]

  *Old: IF WONTOP() = lcBrowsTtl

  *Old:  =lfSetTrap()
  *Old: glFromBrow = .T. &&10Q: what does this variable mean ?
  *Old: ELSE
  *Old:  =lfResetTrap()
  *Old: ENDIF

  *Old: IF WONTOP() = lcBrowsTtl .OR. WPARENT(WOUTPUT()) <> 'CWRAPDISTR'
  *Old: IF WEXIST(lcBrowsTtl)
  *Old: SHOW WINDOW (lcBrowsTtl) REFRESH SAME
  =lfDispObjct()
  *Old: ENDIF
  *Old: RELEASE PAD _BROWSE OF _MSYSMENU
  *ON KEY LABEL ALT+B
  *Old: ON KEY LABEL ALT+C
  *Old: RETURN .T.
  *Old: ENDIF

  *ASM, code that was in the lfRelease Function [End]

  RELEASE PAD _INQUIRY OF (loFormSet.cHostFormName) &&ASM
  RELEASE POPUP _INQURYPOP

  RELEASE PAD _BROWSE OF (loFormSet.cHostFormName) &&ASM


  RETURN
  *--end of lfFormDeActivate


  *!*******************************************************************
  *! Name      : lfCrtTmp
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 7/11/2004
  *! Purpose   : function to Create a Temprory Table, given its structure as a string.
  *!*************************************************************
  *! Passed Parameters  : File Name, File Structure, Index Tag Expression, Index Tag Name
  *!*******************************************************************
  *! Returns            :  True  ----> If passed file is opened successfully
  *!                       False ----> If passed file is fails to open succesfully.
  *!*******************************************************************
FUNCTION lfCrtTmp
  LPARAMETERS lcFile, lcStruc, lcTagexp, lcTagName
  LOCAL lcTemp
  LOCAL ARRAY laStru[1]

  lcTemp=gfTempName()
  CREATE CURSOR &lcTemp (&lcStruc)
  SELECT (lcTemp)
  AFIELDS(laStru)
  USE
  =gfCrtTmp(lcFile,@laStru,lcTagexp, lcTagName)

  RETURN
  *--end of lfCrtTmp


  *!*************************************************************
  *! Name      : lfTaxAct
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 7/12/2004
  *! Purpose   :
  *!*************************************************************
  *! Parameters: None
  *!*************************************************************
  *! Returns   : None
  *!*************************************************************
FUNCTION lfTaxAct
  LPARAMETER loFormSet


  lcObjShow = IIF(INLIST(loFormSet.ActiveMode,"V","S") OR loFormSet.llLokPer , 'DISABLE' ,;
    'ENABLE')


  IF APVENDOR.CTAXTYPE <> 'T'
    *Old: SHOW GET ibTaxCode &lcObjShow
    
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *  loFormSet.DistLines.CboTaxCode.Enabled=(lcObjShow='ENABLE')
    loFormSet.AriaForm1.pgfpayInv.pgDist.CboTaxCode.ENABLED=(lcObjShow='ENABLE')
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    
    *Old: SHOW GET ibDumm1   DISABLE

    *Old: IF _WINDOWS

    *Old: SHOW GET puTax &lcObjShow
    *Old: ENDIF
    *Old: lcActWPos = IIF(WPARENT(WONTOP())='CWRAPDISTR','TOP','BOTTOM')
    *Old: lcWinTop  = IIF(lcActWPos = 'TOP','3','4')
    *Old: SHOW WINDOW (lcDisChld&lcWinTop) &lcActWPos IN WINDOW CWRAPDISTR
  ELSE
    *Old: SHOW GET ibDumm1   &lcObjShow
    *Old: SHOW GET ibTaxCode DISABLE
    
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *loFormSet.DistLines.CboTaxCode.Enabled=.F.
    loFormSet.AriaForm1.pgfpayInv.pgDist.CboTaxCode.ENABLED=.F.
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    
    *Old: IF _WINDOWS
    *Old: SHOW GET puTax DISABLE
    *Old: ENDIF
    *Old: lcActWPos =IIF( WPARENT(WONTOP())='CWRAPDISTR','TOP','BOTT')
    *Old: lcWinTop  = IIF(lcActWPos = 'TOP','4','3')
    *Old: SHOW WINDOW (lcDisChld&lcWinTop) &lcActWPos IN WINDOW CWRAPDISTR
  ENDIF

  IF (INLIST(loFormSet.ActiveMode,"E","A")) .AND. !loFormSet.llLokPer


    IF loFormSet.lnLineNo = 0
      *IF TYPE('loFormSet.DistLines.txtLineNo.Value = 0')='N' AND loFormSet.DistLines.txtLineNo.Value = 0
      *Old: SHOW GET lnApdAmnt  DISABLE
      
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *!*	    loFormSet.DistLines.txtlnApdAmnt.Enabled=.F.
      *!*	    *Old: SHOW GET ibApGlAcc  DISABLE
      *!*	    *Old: SHOW GET lcApdGLAct DISABLE
      *!*	    loFormSet.DistLines.glActCode.Enabled=.F.
      *!*	    *Old: SHOW GET ibTaxCode  DISABLE
      *!*	    *Old: SHOW GET puTax      DISABLE
      *!*	    loFormSet.DistLines.CboTaxCode.Enabled=.F.
      *!*	    *Old: SHOW GET pbRemove   DISABLE
      *!*	    loFormSet.DistLines.cmdRemove.Enabled=.F.
      loFormSet.AriaForm1.pgfpayInv.pgDist.txtlnApdAmnt.ENABLED=.F.
      *Old: SHOW GET ibApGlAcc  DISABLE
      *Old: SHOW GET lcApdGLAct DISABLE
      loFormSet.AriaForm1.pgfpayInv.pgDist.glActCode.ENABLED=.F.
      *Old: SHOW GET ibTaxCode  DISABLE
      *Old: SHOW GET puTax      DISABLE
      loFormSet.AriaForm1.pgfpayInv.pgDist.CboTaxCode.ENABLED=.F.
      *Old: SHOW GET pbRemove   DISABLE
      loFormSet.AriaForm1.pgfpayInv.pgDist.cmdRemove.ENABLED=.F.
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      
    ENDIF
  ELSE
    *Old: SHOW GET lnApdAmnt  DISABLE
    
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *!*	  loFormSet.DistLines.txtlnApdAmnt.Enabled=.F.
    *!*	  *Old: SHOW GET ibApGlAcc  DISABLE
    *!*	  *Old: SHOW GET lcApdGLAct DISABLE
    *!*	  loFormSet.DistLines.glActCode.Enabled=.F.
    *!*	  *Old: SHOW GET ibTaxCode  DISABLE
    *!*	  *Old: SHOW GET puTax      DISABLE
    *!*	  loFormSet.DistLines.CboTaxCode.Enabled=.F.
    *!*	  *Old: SHOW GET pbNew      DISABLE
    *!*	  loFormSet.DistLines.cmdNew.Enabled=.F.
    *!*	  *Old: SHOW GET pbRemove   DISABLE
    *!*	  loFormSet.DistLines.cmdRemove.Enabled=.F.
    *!*	  *Old: SHOW GET apinvhdr.capacct DISABLE
    *!*	  *Old: SHOW GET ibApAcc DISABLE
    *!*	  loFormSet.DistLines.glAPActCode.Enabled=.F.
    loFormSet.AriaForm1.pgfpayInv.pgDist.txtlnApdAmnt.ENABLED=.F.
    *Old: SHOW GET ibApGlAcc  DISABLE
    *Old: SHOW GET lcApdGLAct DISABLE
    loFormSet.AriaForm1.pgfpayInv.pgDist.glActCode.ENABLED=.F.
    *Old: SHOW GET ibTaxCode  DISABLE
    *Old: SHOW GET puTax      DISABLE
    loFormSet.AriaForm1.pgfpayInv.pgDist.CboTaxCode.ENABLED=.F.
    *Old: SHOW GET pbNew      DISABLE
    loFormSet.AriaForm1.pgfpayInv.pgDist.cmdNew.ENABLED=.F.
    *Old: SHOW GET pbRemove   DISABLE
    loFormSet.AriaForm1.pgfpayInv.pgDist.cmdRemove.ENABLED=.F.
    *Old: SHOW GET apinvhdr.capacct DISABLE
    *Old: SHOW GET ibApAcc DISABLE
    loFormSet.AriaForm1.pgfpayInv.pgDist.glAPActCode.ENABLED=.F.
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    
  ENDIF

  RETURN
  *--end of lfTaxAct


  *!*************************************************************
  *! Name      : lfBrowse
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 7/13/2004
  *! Purpose   :
  *!*************************************************************
  *! Parameters: None
  *!*************************************************************
  *! Returns   : None
  *!*************************************************************
FUNCTION lfBrowse
  LPARAMETER loFormSet
  PRIVATE lcClrSchm



  *Old: lcClrSchm = IIF(_DOS," COLOR SCHEME 13","NOMENU")
  IF INLIST(loFormSet.ActiveMode,"E","A")
    SELECT(loFormSet.lcTmpDist)
    *Revise: May be will change the form's capion
    loFormSet.lcBrowsTtl = IIF(loFormSet.llLokPer,'View distribution','Add / Edit distribution')
  ELSE
    SELECT APDIST
    loFormSet.lcBrowsTtl = 'View distribution' &&Revise: May be will change the form's capion
  ENDIF
  IF APVENDOR.CTAXTYPE = 'T'
    *Old: lnDesWdth = 45 - lnApsAcLen
    *Revise: May be will effect the rowsource of the grid
    *Revise: loFormSet.lcBrowStr = "NAPDLINNO :4 :W=.F. :R :H='No.',"+;
    "CAPDGLACT :"+STR(lnApsAcLen,2)+" :H='Account' :P=lcApsAcMas :R ,"+;
    "CDESC=IIF(llApGlLink,ALLTRIM(LOOKUP(lcLinkChar.CACCNLDES,CAPDGLACT,lcLinkChar.CACCTCODE,'ACCTCODE')),' ') :"+STR(lnDesWdth,2)+" :R :H='Description' :R :W=.F.,"+;
    "NAPDAMNT :15 :H='Dist. amount' :R :W=.F."
    IF loFormSet.ActiveMode="V" .OR. loFormSet.llLokPer
      *Old: SHOW GET ibDumm1   ENABLE
      *Old: SHOW GET ibTaxCode DISABLE
      *Old: SHOW GET puTax     DISABLE
      
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *loFormSet.DistLines.CboTaxCode.Enabled=.F.
      loFormSet.AriaForm1.pgfpayInv.pgDist.CboTaxCode.ENABLED=.F.
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      
      *Old:  SHOW WINDOW (loFormSet.lcDisChld4) TOP IN WINDOW CWRAPDISTR
    ENDIF
  ELSE
    *Old: lnDesWdth = 36 - lnApsAcLen
    *Revise: loFormSet.lcBrowStr = "NAPDLINNO :4 :W=.F. :R :H='No.',"+;
    "CTAXDES=IIF(EMPTY(CTAXCODE),loFormSet.lcEmptyCode,LOOKUP(CODES.cdiscrep,'N'+'CTAXCODE  '+CTAXCODE,CODES.CCODE_NO,'CCODE_NO')) :8 :H='Tax Code' :R :W=.F.,"+;
    "CAPDGLACT :"+STR(lnApsAcLen,2)+" :H='Account' :P=lcApsAcMas :R :W=.F.,"+;
    "CDESC=IIF(llApGlLink,ALLTRIM(LOOKUP(lcLinkChar.CACCNLDES,CAPDGLACT,lcLinkChar.CACCTCODE,'ACCTCODE')),' ') :"+STR(lnDesWdth,2)+" :R :H='Description' :W=.F.,"+;
    "NAPDAMNT :15 :H='Dist. amount' :R :W=.F."
    IF loFormSet.ActiveMode="V" .OR. loFormSet.llLokPer
      *Old: SHOW GET ibDumm1   DISABLE
      *Old: SHOW GET ibTaxCode DISABLE
      *Old: SHOW GET puTax     DISABLE
      
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *loFormSet.DistLines.CboTaxCode.Enabled=.F.
      loFormSet.AriaForm1.pgfpayInv.pgDist.CboTaxCode.ENABLED=.F.
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      
      *Old: SHOW WINDOW (loFormSet.lcDisChld3) TOP IN WINDOW CWRAPDISTR
    ENDIF
  ENDIF
  *Revise: May be will effect the rowsource of the grid
  *Old: BROWSE FIELDS &loFormSet.lcBrowStr;
  FOR cInvNo + cVendCode + cApdTrTyp = (PADR(laData[2] , 12)) +;
  (laData[1]) .AND. cApdActId = 'D' .AND. cApdStat <> 'V';
  WINDOW (lcDischld2) ;
  WHEN lfwDisBrow();
  VALID :F (WONTOP() = loFormSet.lcBrowsTtl .AND. lfvBrowse()) .OR. gfStopBrow() ;
  IN WINDOW CWRAPDISTR;
  LOCK 0;
  NOAPPEND;
  NOCLEAR;
  NODELETE;
  NOWAIT;
  SAVE;
  TITLE loFormSet.lcBrowsTtl;
  NOEDIT &lcClrSchm
  IF loFormSet.ActiveMode="V"
    SELECT APINVHDR
    IF !EOF()
      GO RECNO()
    ENDIF
    SELECT APDIST
    LOCATE REST FOR CAPDSTAT <> 'V' .AND. CAPDACTID <> 'A'
    =lfDispObjct(loFormSet)
  ENDIF

  RETURN
  *--end of lfBrowse


  *!*************************************************************
  *! Name      : lfDispObjct
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 7/13/2004
  *! Purpose   :
  *!*************************************************************
  *! Parameters: None
  *!*************************************************************
  *! Returns   : None
  *!*************************************************************
FUNCTION lfDispObjct
  LPARAMETER loFormSet


  SELECT IIF(loFormSet.ActiveMode="V",'APDIST',loFormSet.lcTmpDist)
  loFormSet.lcApdGLAct = IIF(!EMPTY(cApdGLAct),cApdGlAct,loFormSet.AriaForm1.ap1.lcemptyacc)
  loFormSet.lnApdAmnt  = nApdAmnt
  
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *loFormSet.DistLines.txtlnApdAmnt.Value = nApdAmnt &&ASM
  loFormSet.AriaForm1.pgfpayInv.pgDist.txtlnApdAmnt.VALUE = nApdAmnt &&ASM
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

  loFormSet.lcTaxCode  = CTAXCODE

  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *loFormSet.DistLines.CboTaxCode.Value = CTAXCODE &&ASM
  loFormSet.AriaForm1.pgfpayInv.pgDist.CboTaxCode.VALUE = CTAXCODE &&ASM
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

  IF !loFormSet.ActiveMode="V" AND loFormSet.lnLineNo <= 0
    *IF !loFormSet.ActiveMode="V" AND loFormSet.DistLines.txtLineNo.Value <= 0
    loFormSet.lnApdAmnt  = 0
    *loFormSet.DistLines.txtlnApdAmnt.Value = 0 &&ASM
    loFormSet.lcTaxCode  = ''
    
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *loFormSet.DistLines.CboTaxCode.Value = '' &&ASM
    loFormSet.AriaForm1.pgfpayInv.pgDist.CboTaxCode.VALUE = '' &&ASM
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    
  ENDIF

  STORE gfCodDes(loFormSet.lcTaxCode,'CTAXCODE') TO loFormSet.lcTaxDes, puTax
  IF loFormSet.ActiveMode="V" OR loFormSet.llLokPer OR !EMPTY(loFormSet.lcVenInvTypes) OR loFormSet.lnLineNo = 0
    *IF loFormSet.ActiveMode="V" or loFormSet.llLokPer or !empty(loFormSet.lcVenInvTypes) or loFormSet.DistLines.txtLineNo.Value = 0
    *Old: SHOW GET ibApGlAcc  DISABLE
    *Old: SHOW GET loFormSet.lcApdGLAct DISABLE
    
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *!*	  loFormSet.DistLines.glActCode.Enabled=.F.
    *!*	  *Old: SHOW GET loFormSet.lnApdAmnt  DISABLE
    *!*	  loFormSet.DistLines.txtlnApdAmnt.Enabled=.F.
    *!*	  *Old: SHOW GET ibTaxCode  DISABLE
    *!*	  *Old: SHOW GET puTax      DISABLE
    *!*	  loFormSet.DistLines.CboTaxCode.Enabled=.F.
    loFormSet.AriaForm1.pgfpayInv.pgDist.glActCode.ENABLED=.F.
    *Old: SHOW GET loFormSet.lnApdAmnt  DISABLE
    loFormSet.AriaForm1.pgfpayInv.pgDist.txtlnApdAmnt.ENABLED=.F.
    *Old: SHOW GET ibTaxCode  DISABLE
    *Old: SHOW GET puTax      DISABLE
    loFormSet.AriaForm1.pgfpayInv.pgDist.CboTaxCode.ENABLED=.F.
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    
  ELSE
    *Old: IF EMPTY(loFormSet.lcTaxCode)
    
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *!*	  IF EMPTY(loFormSet.DistLines.CboTaxCode.Value)
    *!*	    *Old: SHOW GET loFormSet.lcApdGLAct ENABLE
    *!*	    *Old: SHOW GET ibApGlAcc  ENABLE
    *!*	    loFormSet.DistLines.glActCode.Enabled=.T.
    *!*	  ELSE
    *!*	    *Old: SHOW GET ibApGlAcc  DISABLE
    *!*	    *Old: SHOW GET loFormSet.lcApdGLAct DISABLE
    *!*	    loFormSet.DistLines.glActCode.Enabled=.F.
    *!*	  ENDIF
    *!*	  *Old: SHOW GET loFormSet.lnApdAmnt ENABLE
    *!*	  loFormSet.DistLines.txtlnApdAmnt.Enabled=.T.
    *!*	  *Old: SHOW GET puTax     ENABLE
    *!*	  loFormSet.DistLines.CboTaxCode.Enabled=.T.
    IF EMPTY(loFormSet.AriaForm1.pgfpayInv.pgDist.CboTaxCode.VALUE)
      *Old: SHOW GET loFormSet.lcApdGLAct ENABLE
      *Old: SHOW GET ibApGlAcc  ENABLE
      loFormSet.AriaForm1.pgfpayInv.pgDist.glActCode.ENABLED=.T.
    ELSE
      *Old: SHOW GET ibApGlAcc  DISABLE
      *Old: SHOW GET loFormSet.lcApdGLAct DISABLE
      loFormSet.AriaForm1.pgfpayInv.pgDist.glActCode.ENABLED=.F.
    ENDIF
    *Old: SHOW GET loFormSet.lnApdAmnt ENABLE
    loFormSet.AriaForm1.pgfpayInv.pgDist.txtlnApdAmnt.ENABLED=.T.
    *Old: SHOW GET puTax     ENABLE
    loFormSet.AriaForm1.pgfpayInv.pgDist.CboTaxCode.ENABLED=.T.
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    
  ENDIF
  loFormSet.lcTaxDes = gfCodDes(loFormSet.lcTaxCode , 'CTAXCODE')
  *Old: IF SUBSTR(gcBaseWind,4,LEN(gcBaseWind)) = loFormSet.lcActProg
  *Old: =lfRefresh(loFormSet.lcDisChld1+','+loFormSet.lcDisChld3+','+loFormSet.lcDisChld4+','+loFormSet.lcDisChld5)
  *Old: ENDIF

  RETURN
  *--end of lfDispObjct


  *!*************************************************************
  *! Name      : lfFormRefresh
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 7/7/2004
  *! Purpose   : Procedure called from the ChangeMode Event of the form
  *!*************************************************************
  *! Parameters: The FormSet whose init code calls the function
  *!*************************************************************
  *! Returns   : None
  *!*************************************************************
PROCEDURE lpFormRefresh
  LPARAMETERS loFormSet
  LOCAL lcObjShow, lcDistPrd, lcDistYer, llLokPer, lcExSin2

  *ASM [Start]
  IF loFormSet.llDataNotOpened
    RETURN
  ENDIF

  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *loFormSet.AriaForm1.cmdVendor.Enabled = loFormSet.ActiveMode<>'S'
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

  *ASM, Assign the Tag property of the postdate, invoice date and invoice amount
  *To be able not to enter any other control until they are validated. Also Enable the
  *PostDate and Invoice Date in case they were disabled in previous Edit Mode

  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	STORE IIF(INLIST(loFormSet.ActiveMode,"A","E"),'x','') TO ;
  *!*	  loFormSet.AriaForm1.dtPostDate.Tag, loFormSet.AriaForm1.dtInvDate.Tag, ;
  *!*	  loFormSet.AriaForm1.txtInvAmount.Tag


  *!*	STORE IIF(INLIST(loFormSet.ActiveMode,"A","E"),.T.,.F.) TO ;
  *!*	  loFormSet.AriaForm1.dtPostDate.Enabled, loFormSet.AriaForm1.dtInvDate.Enabled
  STORE IIF(INLIST(loFormSet.ActiveMode,"A","E"),'x','') TO ;
    loFormSet.AriaForm1.dtPostDate.TAG, loFormSet.Ariaform1.pgfpayInv.pgHead.dtInvDate.TAG, ;
    loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.TAG


  STORE IIF(INLIST(loFormSet.ActiveMode,"A","E"),.T.,.F.) TO ;
    loFormSet.AriaForm1.dtPostDate.ENABLED, loFormSet.Ariaform1.pgfpayInv.pgHead.dtInvDate.ENABLED
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  *ASM [End]

  loFormSet.llClosed = .F.
  IF !EMPTY(loFormSet.lcVenInvTypes)
    *11Q: is this code necessay ?
    loFormSet.laCodes[1,7] = IIF(loFormSet.ActiveMode="V",'APVINVDT',loFormSet.lcAPvInvDt) &&Old laCodes
    loFormSet.laCodes[1,8] = IIF(loFormSet.ActiveMode="V",'ORGVINV',loFormSet.lcAPvInvDt)

    *B608428,1 AKA 02/11/2008, Assign the correct file and index to TaxCode array [Start]
    *!*	  loFormSet.laCodes[2,7] = IIF(loFormSet.ActiveMode="V",'APDIST',loFormSet.lcTmpDist)
    *!*	  loFormSet.laCodes[2,8] = IIF(loFormSet.ActiveMode="V",'APDIST',loFormSet.lcTmpDist)
    loFormSet.laCodes[2,7] = IIF(loFormSet.ActiveMode="V",'APDIST',loFormSet.lcAPvInvDt)
    loFormSet.laCodes[2,8] = IIF(loFormSet.ActiveMode="V",'APDIST',loFormSet.lcAPvInvDt)
    *B608428,1 AKA 02/11/2008, Assign the correct file and index to TaxCode array [End]

  ENDIF

  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	IF loFormSet.ActiveMode="S" OR EMPTY(loFormSet.lcVenInvTypes) OR ;
  *!*	   ('M'=loFormSet.lcVenInvTypes AND gfGetMemVar('LLMULCURR') AND PADR(loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value,3) <> PADR(oAriaApplication.BaseCurrency,3))
  IF loFormSet.ActiveMode="S" OR EMPTY(loFormSet.lcVenInvTypes) OR ;
      ('M'=loFormSet.lcVenInvTypes AND gfGetMemVar('LLMULCURR') AND PADR(loFormSet.AriaForm1.pgfpayInv.pgHead.kbCurrCode.KeyTextBox.VALUE,3) <> PADR(oAriaApplication.BaseCurrency,3))
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  
    *('M'=loFormSet.lcVenInvTypes AND gfGetMemVar('LLMULCURR') AND PADR(apinvhdr.ccurrcode,3) <> PADR(oAriaApplication.BaseCurrency,3))  &&BOHO
    *Old: SHOW GET pbAPVInvDt DISABLE &&Revise
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *loFormSet.AriaForm1.cmdInvLines.Enabled = .F.
    loFormSet.AriaForm1.pgfpayInv.pgDet.ENABLED = .F.
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  ELSE
    *Old: SHOW GET pbAPVInvDt ENABLE &&Revise
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *loFormSet.AriaForm1.cmdInvLines.Enabled = .T.
    loFormSet.AriaForm1.pgfpayInv.pgDet.ENABLED = .T.
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  ENDIF


  IF loFormSet.ActiveMode="E"
    *12Q: Where is lfVlDate Function Defined and is it valid in Aria4 to pass the variable gcPrnt_Cmp ?
    *=lfVlDate(gcPrnt_Cmp , @loFormSet.lcDistPrd , @loFormSet.lcDistYer , apinvhdr.dpostdate , @loFormSet.llLokPer)  &&BOHO
    *=lfVlDate(oAriaApplication.PrntCompanyID , @loFormSet.lcDistPrd , @loFormSet.lcDistYer , loFormSet.AriaForm1.DtPostDate.Text1.Value , @loFormSet.llLokPer)
    lcDistPrd = loFormSet.lcDistPrd
    lcDistYer = loFormSet.lcDistYer
    llLokPer = loFormSet.llLokPer
    =lfVlDate(oAriaApplication.PrntCompanyID , @lcDistPrd , @lcDistYer , loFormSet.AriaForm1.DtPostDate.Text1.VALUE , @llLokPer)
    loFormSet.lcDistPrd = lcDistPrd
    loFormSet.lcDistYer = lcDistYer
    loFormSet.llLokPer = llLokPer
    *B129901,1 ASM 09/26/2005 Prevent edit Payable invoice lines when falls in locked period [Start]
    IF loFormSet.llLokPer
      *Message : " This Invoice is in a locked period any changes made will post to GL with today's date "
      *Buttons : "                    <    Ok    >                "
      *=gfModalGen("INM04205B00000","DIALOG")
      *! B130111,1 ASM 11/01/2005 Allow the User to Edit an Invoice whose posted date is locked, but make entries on system date [Start]
      *! B130111,2 ASM 05/01/2006 Allow the User to Edit an Invoice whose posted date is locked, but Prevent accessing Invoice Lines and Total Amount [Start]
      *=gfModalGen("INM04205B00000" , "DIALOG" , 'Invoice Data')
      *! B130111,2 ASM 05/01/2006 Allow the User to Edit an Invoice whose posted date is locked, but Prevent accessing Invoice Lines and Total Amount [End]
      *! B130111,1 ASM 11/01/2005 Allow the User to Edit an Invoice whose posted date is locked, but make entries on system date [End]
      *B129901,1 WSH 10/02/2005 Pass the parameter to not ask to lose changes or not. [Start]
      *oAriaApplication.oToolBar.cmdExit.Click()
      *! B130111,1 ASM 11/01/2005 Allow the User to Edit an Invoice whose posted date is locked, but make entries on system date [Start]
      *oAriaApplication.oToolBar.cmdExit.Click(.T.)
      *! B130111,1 ASM 11/01/2005 Allow the User to Edit an Invoice whose posted date is locked, but make entries on system date [End]
      *B129901,1 WSH 10/02/2005 [End]

      *RETURN
    ENDIF
    *B129901,1 ASM 09/26/2005 Prevent edit Payable invoice lines when falls in locked period [End]
  ENDIF

  IF loFormSet.ActiveMode="S" .OR. loFormSet.ActiveMode="A"
    loFormSet.llLokPer = .F.
  ENDIF


  IF loFormSet.llInquiry
    *13Q: can we use seekrecord() here ?
    *apinvhdr.cvendcode      = loFormSet.lcVenCode  &&BOHO
    loFormSet.AriaForm1.kbVendCode.keyTextBox.VALUE      = loFormSet.lcVenCode
    *apinvhdr.cinvno      = loFormSet.lcInvNo  &&BOHO
    loFormSet.AriaForm1.kbInvNo.keyTextBox.VALUE      = loFormSet.lcInvNo
    *=SEEK(apinvhdr.cvendcode+apinvhdr.cinvno,'APINVHDR')  &&BOHO
    =SEEK(loFormSet.AriaForm1.kbVendCode.keyTextBox.VALUE+loFormSet.AriaForm1.kbInvNo.keyTextBox.VALUE,'APINVHDR')
    *Old: SCATTER FIELDS &loFormSet.lcScFields MEMO TO laData
    *Old: SHOW GET pbDlt DISABLE
    loFormSet.llDeleteButton = .F.
    *Old: SHOW GET pbVendor DISABLE
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *loFormSet.AriaForm1.cmdVendor.Enabled=.F.
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  ENDIF


  IF loFormSet.llFirstShow
    loFormSet.llFirstShow= .F.
    IF loFormSet.ActiveMode="V" .OR. loFormSet.ActiveMode="E"
      *Old: SHOW GET apinvhdr.ccurrcode DISABLE
      *Old: SHOW GET ibCurrency DISABLE
      *Old: SHOW GET apinvhdr.nexrate DISABLE
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      * loFormSet.AriaForm1.kbCurrCode.Enabled=.F.
      *!*	   loFormSet.AriaForm1.txtNexRate.Enabled=.F.
      loFormSet.AriaForm1.pgfpayInv.pgHead.kbCurrCode.ENABLED=.F.
      loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.ENABLED=.F.
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

    ENDIF

    =lfDelShow()
    IF loFormSet.llFromVend
      loFormSet.llFromVend = .F.
      KEYBOARD "{ENTER}" &&Revise
    ENDIF
    RETURN
  ENDIF

  *ASM, INITIALLY DISABLING THE KEY FIELDS CONTROL
  STORE .F. TO loFormSet.AriaForm1.kbVendCode.ENABLED, loFormSet.AriaForm1.kbVendCompany.ENABLED, ;
    loFormSet.AriaForm1.kbVendPhone.ENABLED, loFormSet.AriaForm1.kbInvNo.ENABLED

  DO CASE
    CASE loFormSet.ActiveMode="S"  && Select Mode
      loFormSet.llUpdInvLn = .F.

      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      loFormSet.AriaForm1.pgfpayInv.ACTIVEPAGE = 1
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

      loFormSet.lnStartAdr=1
      *Old =lfShiftlaData(1) &&Revise: it was used to redisplay the lines of Address
      STORE  'DISABLE' TO loFormSet.lcScUpStat, loFormSet.lcScdNStat
      *Old: SHOW GET ibshiftup DISABLE &&Revise
      *Old: SHOW GET ibshiftDn DISABLE &&Revise

      STORE 'DISABLE' TO loFormSet.lcData23St,loFormSet.lcFactStat,loFormSet.lcAprStat,loFormSet.lcDistStat,;
        loFormSet.lcTermsDisp,loFormSet.lcRemitStat

      SELECT(loFormSet.lcTmpDist)
      ZAP

      *Old: IF WVISIBLE('CWRAPDISTR')
      *Old: =gfChClose('CWRAPDISTR')
      *Old: ENDIF

      SELECT APINVHDR


      IF loFormSet.llSamVendor
        *Old: apinvhdr.cvendcode   = ALLTRIM(loFormSet.lcVendor)
        loFormSet.AriaForm1.kbVendCode.KeyTextBox.VALUE = ALLTRIM(loFormSet.lcVendor)
        *Old: SHOW GET apinvhdr.cvendcode
        loFormSet.AriaForm1.kbVendCode.REFRESH()
        *Old: _CUROBJ = OBJNUM(apinvhdr.cinvno)
        loFormSet.AriaForm1.kbInvNo.SETFOCUS()
        loFormSet.AriaForm1.kbVendCode.TAG='x'
        loFormSet.llSamVendor = .F.
      ELSE
        *Revise: Use the form's controls
        loFormSet.lcPhone     = SPACE(16) && Variable to hold the phone no.
        *loFormSet.AriaForm1.kbVendPhone.KeyTextBox.Value = SPACE(16)
        loFormSet.lcCompany   = SPACE(30) && Variable to hold the company name.
        *loFormSet.AriaForm1.kbVendCompany.KeyTextBox.Value = SPACE(30)
        LOCATE
      ENDIF

      loFormSet.lcRemitTo   = loFormSet.laRemitTo[1,1] &&Revise: Use the form's controls

      *Revise: Use the form's controls [Start]
      *14Q: is this a process of assigning default values to the screen controls ?
      STORE ' '        TO loFormSet.lcPayMethd,loFormSet.lcOldYear,loFormSet.lcOldPeriod

      *Old: STORE loFormSet.lcEmptyAcc TO loFormSet.lcDisAcct, loFormSet.lcApdGLAct,apinvhdr.cchkglacc, apinvhdr.capacct, loFormSet.lcAccount
      STORE loFormSet.AriaForm1.ap1.lcemptyacc TO ;
        loFormSet.lcDisAcct, loFormSet.lcApdGLAct, loFormSet.lcAccount


      STORE 0          TO loFormSet.lnTotAppPay,loFormSet.lnOldInvAmt,loFormSet.lnOldDiscOf,loFormSet.lnDistAmnt,loFormSet.lnInvAdj,;
        loFormSet.lnLineNo,puMethod

      STORE 1          TO loFormSet.lnOldRemit,puRemitTo

      STORE .F.        TO loFormSet.llGLActSta,loFormSet.llCanSav,loFormSet.llInvByCr,loFormSet.llPaidByCrd,loFormSet.llInvCan

      loFormSet.ldOldDatInv = {}        && Variable to hold the old invoice date.
      *Revise: Use the form's controls [End]

      *Old: SHOW GET ibVendor  ENABLE
      *Old: SHOW GET ibPhone   ENABLE
      *Old: SHOW GET ibCompany ENABLE
      *Old: SHOW GET ibInvoice ENABLE
      STORE .T. TO loFormSet.AriaForm1.kbVendCode.ENABLED, loFormSet.AriaForm1.kbVendCompany.ENABLED, ;
        loFormSet.AriaForm1.kbVendPhone.ENABLED, loFormSet.AriaForm1.kbInvNo.ENABLED
      *Old: SHOW GET ibTaxCode DISABLE COLOR ,,,,,,,,&loFormSet.lcColorInv,&loFormSet.lcColorInv &&Revise
      *Old: SHOW GET puTax DISABLE
      
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *loFormSet.DistLines.cboTaxCode.Enabled=.F.
      loFormSet.AriaForm1.pgfpayInv.pgDist.cboTaxCode.ENABLED=.F.
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      
      *Old: SHOW GET pbApprove,1 PROMPT '\<Approve for payment...' &loFormSet.lcAprStat
      
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *!*	    loFormSet.AriaForm1.cmdApprove.Caption='\<Approve for payment...'
      *!*	    loFormSet.AriaForm1.cmdApprove.Enabled=(loFormSet.lcAprStat='ENABLE')
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      
      STORE loFormSet.lcEmptyCode TO loFormSet.lcDivision,loFormSet.lcPuDiv,loFormSet.lcTermCode,loFormSet.lcPuTerm
      loFormSet.AriaForm1.kbVendCode.KeyTextBox.SETFOCUS()

    CASE loFormSet.ActiveMode="V" .OR. loFormSet.ActiveMode="E"
      
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      * SET ORDER TO TAG VENCODE IN APVENDOR
      IF loFormSet.ActiveMode="V"
        loFormSet.AriaForm1.pgfpayInv.ACTIVEPAGE = 1
        =gfSqlRun("Select * From APDIST Where CINVNO='"+;
          loFormSet.AriaForm1.kbInvNo.keyTextBox.VALUE+"' AND CVENDCODE = '"+;
          loFormSet.AriaForm1.kbVendCode.keyTextBox.VALUE+"'",'APDIST')
      ENDIF
      SELECT APVENDOR
      =gfSetOrder('VENCODE')
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      
      *=SEEK(apinvhdr.cvendcode,'APVENDOR')  &&BOHO
      
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *    =SEEK(loFormSet.AriaForm1.kbVendCode.keyTextBox.Value,'APVENDOR')
      =gfSEEK(loFormSet.AriaForm1.kbVendCode.keyTextBox.VALUE,'APVENDOR')
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      
      loFormSet.lcVenInvTypes = ALLTRIM(APVENDOR.cVenInvTyp)
      loFormSet.lcVenInvTypes = loFormSet.lcVenInvTypes + IIF(gfGetmemvar('M_BOMVAR') AND 'M' $ loFormSet.lcVenInvTypes,'A','')
      loFormSet.lcVenInvTypes = loFormSet.lcVenInvTypes + IIF(!EMPTY(gfGetmemvar('M_DYEOPR')) AND 'M' $ loFormSet.lcVenInvTypes,'D','')
      lnOldAls = SELECT(0)
      SELECT APVINVDt
      lnOldInd = ORDER()      
      
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      * SET ORDER TO Orgvinv
      =gfSetOrder('Orgvinv')
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      
      =loFormSet.mOptionMenu()
      *IF SEEK(apinvhdr.cvendcode+apinvhdr.cinvno) &&Boho
      
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *!*	    IF SEEK(loFormSet.AriaForm1.kbVendCode.keyTextBox.Value+ ;
      *!*	                loFormSet.AriaForm1.kbInvNo.keyTextBox.Value)
      IF gfSEEK(loFormSet.AriaForm1.kbVendCode.keyTextBox.VALUE+ ;
          loFormSet.AriaForm1.kbInvNo.keyTextBox.VALUE)
     *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
        
        *LOCATE REST WHILE cvendcode+capinvno+capvilno = apinvhdr.cvendcode+apinvhdr.cinvno ;
        FOR   !(cimtyp $ loFormSet.lcVenInvTypes)  &&BOHO
        LOCATE REST WHILE cvendcode+capinvno+capvilno = loFormSet.AriaForm1.kbVendCode.keyTextBox.VALUE+;
          loFormSet.AriaForm1.kbInvNo.keyTextBox.VALUE ;
          FOR   !(cimtyp $ loFormSet.lcVenInvTypes)
        IF FOUND()
          =gfModalGen('TRM04196B00000','DIALOG')
          *Old: SHOW GET pbAPVInvDt DISABLE &&Revise
          
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
          *!*	        loFormSet.AriaForm1.cmdInvLines.Enabled = .F.
          loFormSet.AriaForm1.pgfpayInv.pgDet.ENABLED = .F.
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
          
          *Old: SHOW GET pbEdt DISABLE
          loFormSet.llEditButton = .F.
          
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
          *DEFINE BAR 2 OF _INQURYPOP PROMPT 'Invoice \<Lines' SKIP FOR .T.
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
          
          IF !EMPTY(lnOldInd)
            SELECT APVINVDt
            
            *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
            *SET ORDER TO (lnOldInd)
            =gfSetOrder(lnOldInd)
            *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
            
          ENDIF
          SELECT (lnOldAls)
          RETURN
        ENDIF
      ENDIF
      IF !EMPTY(lnOldInd)
        SELECT APVINVDt
        
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        *SET ORDER TO (lnOldInd)
        gfSETORDER(lnOldInd)
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
        
      ENDIF
      SELECT (lnOldAls)

      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *    loFormSet.lcDistAcct = IIF(!EMPTY(APVENDOR.CEXPACCT),APVENDOR.CEXPACCT,;
      IIF(SEEK(apinvhdr.cdivision,'APDIV') AND !EMPTY(APDIV.CEXPACCT),APDIV.CEXPACCT,APSETUP.CEXPACCT))
      loFormSet.lcDistAcct = IIF(!EMPTY(APVENDOR.CEXPACCT),APVENDOR.CEXPACCT,;
        IIF(gfSEEK(apinvhdr.cdivision,'APDIV') AND !EMPTY(APDIV.CEXPACCT),APDIV.CEXPACCT,APSETUP.CEXPACCT))
       *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

      *IF TYPE('APINVHDR.DPOSTDATE') = 'D' .AND. EMPTY(apinvhdr.dpostdate)  &&BOHO
      IF TYPE('loFormSet.AriaForm1.DtPostDate.Value') = 'D' .AND. EMPTY(loFormSet.AriaForm1.DtPostDate.VALUE)
        *apinvhdr.dpostdate = apinvhdr.dinvdate  &&BOHO
        
         *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        *loFormSet.AriaForm1.DtPostDate.Value = loFormSet.AriaForm1.DtInvDate.Value
        loFormSet.AriaForm1.DtPostDate.VALUE = loFormSet.Ariaform1.pgfpayInv.pgHead.DtInvDate.VALUE
         *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
        
      ENDIF

      *IF apinvhdr.cvenpmeth = 'C' &&BOHO
      
       *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *IF loFormSet.AriaForm1.cboVendPmeth.Value = 'C'  &&Revise
      IF loFormSet.AriaForm1.pgfpayInv.pgHead.cboVendPmeth.VALUE = 'C'  &&Revise
       *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
       
        *Old: SHOW GET pbApprove,1 PROMPT 'Credit c\<ard payment...'
        
         *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        *loFormSet.AriaForm1.cmdApprove.Caption='Credit c\<ard payment...'
         *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
        
      ELSE
        *Old: SHOW GET pbApprove,1 PROMPT '\<Approve for payment...'
        
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        *loFormSet.AriaForm1.cmdApprove.Caption='\<Approve for payment...'
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
         
      ENDIF

      IF loFormSet.ActiveMode="V"
        loFormSet.lnStartAdr=1
        *Old =lfShiftlaData(1) &&Revise: it was used to redisplay the lines of Address
        loFormSet.lcScUpStat='DISABLE'
        loFormSet.lcScdNStat='ENABLE'
        *Old: SHOW GET ibShiftUp DISABLE &&Revise
        *Old: SHOW GET ibShiftDn ENABLE &&Revise

        *IF loFormSet.llInquiry .OR. apinvhdr.cvenpmeth = 'C'   &&BOHO
        
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        *IF loFormSet.llInquiry .OR. loFormSet.AriaForm1.cboVendPmeth.Value = 'C'   &&Revise
        IF loFormSet.llInquiry .OR. loFormSet.AriaForm1.pgfpayInv.pgHead.cboVendPmeth.VALUE = 'C'   &&Revise
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
          *Old: SHOW GET pbEdt DISABLE
          loFormSet.llEditButton = .F.
        ELSE
          *Old: SHOW GET pbEdt ENABLE
          loFormSet.llEditButton = .T.
        ENDIF
        loFormSet.lcTermsDisp= 'DISABLE'
        IF !loFormSet.llInquiry
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
          *IF SEEK(apinvhdr.cfisfyear,'FISHD')
          IF gfSEEK(apinvhdr.cfisfyear,'FISHD')
           *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
            IF FISHD.CFISYSTAT <> 'H' .AND. apinvhdr.cvenpmeth <> 'C' .AND. APINVHDR.CINVSTAT <> 'A'
              *Old: SHOW GET pbDlt ENABLE
              loFormSet.llDeleteButton = .T.
            ELSE
              *Old: SHOW GET pbEdt DISABLE
              loFormSet.llEditButton = .F.
              *Old: SHOW GET pbDlt DISABLE
              loFormSet.llDeleteButton = .F.
            ENDIF
          ELSE
            *Old: SHOW GET pbEdt DISABLE
            loFormSet.llEditButton = .F.
            *Old: SHOW GET pbDlt ENABLE
            loFormSet.llDeleteButton = .T.
          ENDIF
        ENDIF
        loFormSet.lcData23St = 'DISABLE'
      ENDIF


      IF APINVHDR.CINVSTAT = 'A'
        loFormSet.lcAprStat  = 'DISABLE'
        loFormSet.lcDistStat = 'DISABLE'
        *Old: SHOW GET pbApprove &loFormSet.lcAprStat
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        *loFormSet.AriaForm1.cmdApprove.Enabled=(loFormSet.lcAprStat='ENABLE')
        *loFormSet.AriaForm1.cmdDisLine.Enabled=(loFormSet.lcDistStat='ENABLE')
        *loFormSet.AriaForm1.cmdApprove.Enabled=(loFormSet.lcAprStat='ENABLE')
        *Old: SHOW GET pbDisLine &loFormSet.lcDistStat
        loFormSet.AriaForm1.pgfpayInv.pgDist.ENABLED=(loFormSet.lcDistStat='ENABLE')
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

      ELSE
        loFormSet.lcAprStat  = 'ENABLE'
        loFormSet.lcDistStat = 'ENABLE'
        *Old: SHOW GET pbApprove &loFormSet.lcAprStat
        
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        *!*	      loFormSet.AriaForm1.cmdApprove.Enabled=(loFormSet.lcAprStat='ENABLE')
        *!*	      *Old: SHOW GET pbDisLine &loFormSet.lcDistStat
        *!*	      loFormSet.AriaForm1.cmdDisLine.Enabled=(loFormSet.lcDistStat='ENABLE')
        *loFormSet.AriaForm1.cmdApprove.Enabled=(loFormSet.lcAprStat='ENABLE')
        *Old: SHOW GET pbDisLine &loFormSet.lcDistStat
        loFormSet.AriaForm1.pgfpayInv.pgDist.ENABLED=(loFormSet.lcDistStat='ENABLE')
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
        
      ENDIF

      lcObjShow = IIF(loFormSet.ActiveMode="V" .OR. loFormSet.llLokPer , 'DISABLE' , 'ENABLE')

      *Old: SHOW GET lcApdGlAct &lcObjShow
      *Old: SHOW GET ibApGlAcc  &lcObjShow
      
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *!*	    loFormSet.DistLines.glActCode.Enabled=(lcObjShow='ENABLE')
      *!*	    *Old: SHOW GET loFormSet.lnApdAmnt  &lcObjShow
      *!*	    loFormSet.DistLines.txtlnApdAmnt.Enabled=(lcObjShow='ENABLE')
      loFormSet.AriaForm1.pgfpayInv.pgDist.glActCode.ENABLED=(lcObjShow='ENABLE')
      *Old: SHOW GET loFormSet.lnApdAmnt  &lcObjShow
      loFormSet.AriaForm1.pgfpayInv.pgDist.txtlnApdAmnt.ENABLED=(lcObjShow='ENABLE')
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      *loFormSet.lnTotAppPay = apinvhdr.ninvamtap + apinvhdr.ninvdisap + apinvhdr.ninvadjap  &&BOHO
      loFormSet.lnTotAppPay = apinvhdr.ninvamtap + ;
        apinvhdr.ninvdisap + ;
        apinvhdr.ninvadjap

      *IF loFormSet.AriaForm1.cboVendPmeth.Value <> 'C'
      IF apinvhdr.cvenpmeth <> 'C' ;
          AND ((loFormSet.ActiveMode="V" AND loFormSet.lnTotAppPay = 0) ;
          OR (apinvhdr.ninvamnt-apinvhdr.ninvpaid-apinvhdr.ninvdistk = 0))
        *OR (apinvhdr.ninvamnt-apinvhdr.ninvamtap-apinvhdr.ninvdisap = 0))
        *OR (loFormSet.AriaForm1.txtInvAmount.Value-apinvhdr.ninvamtap-apinvhdr.ninvdisap = 0))
        loFormSet.lcAprStat = 'DISABLE'
        *Old: SHOW GET pbApprove &loFormSet.lcAprStat
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        *loFormSet.AriaForm1.cmdApprove.Enabled=(loFormSet.lcAprStat='ENABLE')
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      ELSE
        IF APINVHDR.CINVSTAT = 'A'
          loFormSet.lcAprStat = 'DISABLE'
          *Old: SHOW GET pbApprove &loFormSet.lcAprStat
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
          *loFormSet.AriaForm1.cmdApprove.Enabled=(loFormSet.lcAprStat='ENABLE')
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
        ELSE
          loFormSet.lcAprStat = 'ENABLE'
          *Old: SHOW GET pbApprove &loFormSet.lcAprStat
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
          *loFormSet.AriaForm1.cmdApprove.Enabled=(loFormSet.lcAprStat='ENABLE')
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
        ENDIF
      ENDIF


      *MESSAGEBOX('Fields: '+PADR(apinvhdr.ninvamtap + apinvhdr.ninvdisap + apinvhdr.ninvadjap,10)+;
      CHR(13)+'Controls: '+;
      PADR(apinvhdr.ninvamtap + ;
      apinvhdr.ninvdisap + ;
      apinvhdr.ninvadjap,10))


      loFormSet.lcPhone     = APVENDOR.cPhoneNo
      loFormSet.lcCompany   = APVENDOR.cVenComp
      *loFormSet.lnDistAmnt  = apinvhdr.ninvamnt  &&BOHO
      
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *loFormSet.lnDistAmnt  = loFormSet.AriaForm1.txtInvAmount.Value
      loFormSet.lnDistAmnt  = loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.VALUE
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      
      *15Q: is this code necessary ?
      *lnElemNum   = lfGetArrElem(apinvhdr.cinvremit, 'loFormSet.laRemitTo')  &&BOHO
      
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *!*	    DIMENSION laAry[ALEN(loFormSet.laRemitTo,1),2]
      *!*	    =ACOPY(loFormSet.laRemitTo,laAry)
      *!*	    lnElemNum   = lfGetArrElem(loFormSet.AriaForm1.cboInvRemit.Value, @laAry)
      *!*	    DIMENSION loFormSet.laRemitTo[ALEN(laAry,1),2]
      *!*	    =ACOPY(laAry,loFormSet.laRemitTo)
      DIMENSION laArray[ALEN(loFormSet.laRemitTo,1),2]
      =ACOPY(loFormSet.laRemitTo,laArray)
      lnElemNum   = lfGetArrElem(loFormSet.AriaForm1.pgfpayInv.pgHead.cboInvRemit.VALUE, @laArray)
      DIMENSION loFormSet.laRemitTo[ALEN(laArray,1),2]
      =ACOPY(laArray,loFormSet.laRemitTo)
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      
      loFormSet.lcRemitTo   = IIF(lnElemNum > 0, loFormSet.laRemitTo[lnElemNum, 1]," ")
      puRemitTo   = lnElemNum

      DO CASE
          *CASE apinvhdr.cinvremit = 'F'  &&BOHO
          
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
          *CASE loFormSet.AriaForm1.cboInvRemit.Value = 'F'
        CASE loFormSet.AriaForm1.pgfpayInv.pgHead.cboInvRemit.VALUE = 'F'
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
          loFormSet.lcFactStat   = IIF(!loFormSet.ActiveMode="V", 'ENABLE', 'DISABLE')
        OTHERWISE
          loFormSet.lcFactStat   = 'DISABLE'
      ENDCASE
      *Old =lfShiftlaData(loFormSet.lnStartAdr) &&Revise: it was used to redisplay the lines of Address
      *Old: SHOW GET laData[6] &loFormSet.lcRemitStat
      *Old: SHOW GET loFormSet.laAddrs[1] &loFormSet.lcRemitStat
      *Old: SHOW GET loFormSet.laAddrs[2] &loFormSet.lcRemitStat
      *Old: SHOW GET loFormSet.laAddrs[3] &loFormSet.lcRemitStat
      
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *!*	    STORE (loFormSet.lcRemitStat='ENABLE') TO loFormSet.AriaForm1.txtOutComp.Enabled, ;
      *!*	           loFormSet.AriaForm1.txtOutAddr1.Enabled, loFormSet.AriaForm1.txtOutAddr2.Enabled, ;
      *!*	           loFormSet.AriaForm1.txtOutAddr3.Enabled
      STORE (loFormSet.lcRemitStat='ENABLE') TO loFormSet.AriaForm1.pgfpayInv.pgHead.txtOutComp.ENABLED, ;
        loFormSet.AriaForm1.pgfpayInv.pgHead.txtOutAddr1.ENABLED, loFormSet.AriaForm1.pgfpayInv.pgHead.txtOutAddr2.ENABLED, ;
        loFormSet.AriaForm1.pgfpayInv.pgHead.txtOutAddr3.ENABLED
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      *Old: SHOW GET apinvhdr.cfaccode &loFormSet.lcFactStat
      *Old: SHOW GET ibFactor   &loFormSet.lcFactStat
      
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      * loFormSet.AriaForm1.kbFacCode.Enabled=(loFormSet.lcFactStat='ENABLE')
      loFormSet.AriaForm1.pgfpayInv.pgHead.kbFacCode.ENABLED=(loFormSet.lcFactStat='ENABLE')
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

      IF loFormSet.ActiveMode="E"
        IF EMPTY(APVENDOR.CVEN1099t)  && If the vendor 1099 amount is empty.
          loFormSet.lcData23St = 'DISABLE'
        ELSE
          loFormSet.lcData23St = 'ENABLE'
        ENDIF


        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        *!*	      SELECT *,SPACE(60) AS 'CDISCRIP',;
        *!*	             'S' AS 'cStatus',;
        *!*	             SPACE(1) AS 'cUpdSerNo',;
        *!*	             RECNO() AS 'NRECNO';
        *!*	        FROM (oAriaApplication.DataDir+'APDIST') ;
        *!*	          WHERE CINVNO + CVENDCODE + cAPDTrTyp = ;
        *!*	                loFormSet.AriaForm1.kbInvNo.keyTextBox.Value + loFormSet.AriaForm1.kbVendCode.keyTextBox.Value + "I" ;
        *!*	                AND CAPDSTAT <> 'V';
        *!*	          INTO DBF (oAriaApplication.WorkDir+loFormSet.lcTmpDist)

        =gfSqlRun("Select * From APDIST Where CINVNO='"+;
          loFormSet.AriaForm1.kbInvNo.keyTextBox.VALUE+"' AND CVENDCODE = '"+;
          loFormSet.AriaForm1.kbVendCode.keyTextBox.VALUE+"' AND cAPDTrTyp = 'I' AND CAPDSTAT <> 'V'",'APDIST' ,.F.,'APDIST_TMP')
        SELECT *,SPACE(60) AS 'CDISCRIP',;
          'S' AS 'cStatus',;
          SPACE(1) AS 'cUpdSerNo',;
          RECNO() AS 'NRECNO';
          FROM APDIST_TMP ;
          WHERE CINVNO + CVENDCODE + cAPDTrTyp = ;
          loFormSet.AriaForm1.kbInvNo.keyTextBox.VALUE + loFormSet.AriaForm1.kbVendCode.keyTextBox.VALUE + "I" ;
          AND CAPDSTAT <> 'V';
          INTO DBF (oAriaApplication.WorkDir+loFormSet.lcTmpDist)
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]



        INDEX ON cVendCode+cInvNo+STR(nApDLinNo,4) TAG (loFormSet.lcTmpDist)

        SELECT(loFormSet.lcTmpDist)

        loFormSet.lnLineNo = RECCOUNT() - 1
        
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        *loFormSet.DistLines.txtLineNo.Value = RECCOUNT() - 1
        loFormSet.AriaForm1.pgfpayInv.pgDist.txtLineNo.VALUE = RECCOUNT() - 1
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
        
        *Old: RELEASE WINDOW (loFormSet.lcBrowsTtl)
        =lfBrowse(loFormSet)
        =lfDispObjct(loFormSet)
        *Old: =lfRefresh()

        loFormSet.lcTmplate = 'DISABLE'
        *Old: SHOW GET apinvhdr.cautmcode DISABLE
        *Old: SHOW GET ibTemplate DISABLE
        
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        *loFormSet.AriaForm1.kbAutmCode.Enabled=.F.
        loFormSet.AriaForm1.pgfpayInv.pgHead.kbAutmCode.ENABLED=.F.
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
        
        *Old: SHOW GET pbDlt DISABLE
        loFormSet.llDeleteButton = .F.
      ELSE
        loFormSet.lcRemitStat = 'DISABLE'
        *Old: RELEASE WINDOW (loFormSet.lcBrowsTtl)
        SELECT APINVHDR
        IF !EOF()
          GO RECNO()
        ENDIF
        =lfBrowse(loFormSet)
        =lfDispObjct(loFormSet)
        *Old: =lfRefresh()
      ENDIF

      *IF apinvhdr.cvenpmeth = 'C'  &&BOHO
      
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *IF loFormSet.AriaForm1.cboVendPmeth.Value = 'C'
      IF loFormSet.AriaForm1.pgfpayInv.pgHead.cboVendPmeth.VALUE = 'C'
	  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
        *Old: SHOW GET pbOk       DISABLE &&Revise
        *Old: SHOW GET pbDiscount DISABLE
        
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        *loFormSet.AriaForm1.cmdDiscount.Enabled=.F.
        loFormSet.AriaForm1.pgfpayInv.pgHead.cmdDiscount.ENABLED=.F.
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
        
        *Old: SHOW GET apinvhdr.ninvdisof DISABLE
        
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        *loFormSet.AriaForm1.txtInvDisof.Enabled=.F.
        loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvDisof.ENABLED=.F.
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
        
      ELSE
        *Old: IF !EMPTY(apinvhdr.cvenccven) .AND. WVISIBLE('CWRAPDISTR')
        *Old: =gfChClose('CWRAPDISTR')
        *Old: ENDIF
        *Old: SHOW GET pbOk ENABLE &&Revise
      ENDIF

      IF !EMPTY(APVENDOR.CAPACCT)
        loFormSet.lcAccount = APVENDOR.CAPACCT
      ELSE
        IF !EMPTY(APDIV.CAPACCT)
          loFormSet.lcAccount = APDIV.CAPACCT
        ELSE
          loFormSet.lcAccount = APSETUP.CAPACCT
        ENDIF
      ENDIF

      *Old: loFormSet.lcPayMethd = IIF(!INLIST(apinvhdr.cvenpmeth,'PMNCH'),'',loFormSet.laPayMethd[AT(apinvhdr.cvenpmeth,'PMNCH'),1])  &&Revise
      *puMethod   = AT(apinvhdr.cvenpmeth,'PMNCH')   &&BOHO

      loFormSet.lcCodeFilt = ''

      *16Q: is this code necessary ? [Start]

      *loFormSet.lcDivision = gfCodDes(apinvhdr.cdivision , 'CDIVISION')  &&BOHO
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *loFormSet.lcDivision = gfCodDes(loFormSet.AriaForm1.cboDivision.Value , 'CDIVISION')
      loFormSet.lcDivision = gfCodDes(loFormSet.AriaForm1.pgfpayInv.pgHead.cboDivision.VALUE , 'CDIVISION')
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

      loFormSet.lcPuDiv    = loFormSet.lcDivision


      *loFormSet.lcTermCode = gfCodDes(apinvhdr.ctermcode , 'CTERMCODE')  &&BOHO
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *    loFormSet.lcTermCode = gfCodDes(loFormSet.AriaForm1.cboTermCode.Value , 'CTERMCODE')
      loFormSet.lcTermCode = gfCodDes(loFormSet.AriaForm1.pgfpayInv.pgHead.cboTermCode.VALUE , 'CTERMCODE')
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

      loFormSet.lcPuTerm   = loFormSet.lcTermCode

      *17Q: is this code necessary ?

      IF EMPTY(loFormSet.lcTermCode) OR EMPTY(apinvhdr.ctermcode)  && If empty of the Terms popup or not applicable
        IF loFormSet.ActiveMode="E"
          loFormSet.lcTermsDisp= 'ENABLE'
        ELSE
          loFormSet.lcTermsDisp= 'DISABLE'
        ENDIF
      ELSE
        loFormSet.lcTermsDisp= 'DISABLE'

        IF loFormSet.ActiveMode="A" &&18Q: How come he is checking for "A" while the case condition is "V" or "E"
          
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
          *!*	        DIMENSION laAry[ALEN(loFormSet.laTermAry,1),ALEN(loFormSet.laTermAry,2)]
          *!*	        =ACOPY(loFormSet.laTermAry,laAry)
          *!*	        *=gfRltFld(apinvhdr.ctermcode , @loFormSet.laTermAry , 'CTERMCODE')  &&BOHO
          *!*	        =gfRltFld(loFormSet.AriaForm1.cboTermCode.Value , @laAry , 'CTERMCODE')
          *!*	        DIMENSION loFormSet.laTermAry[ALEN(laAry,1),ALEN(laAry,2)]
          *!*	        =ACOPY(laAry,loFormSet.laTermAry)
          *=gfRltFld(loFormSet.AriaForm1.cboTermCode.Value , @laArray, 'CTERMCODE')
          DIMENSION laArray[ALEN(loFormSet.laTermAry,1),ALEN(loFormSet.laTermAry,2)]
          =ACOPY(loFormSet.laTermAry,laArray)
          =gfRltFld(loFormSet.AriaForm1.pgfpayInv.pgHead.cboTermCode.VALUE , @laArray, 'CTERMCODE')
          DIMENSION loFormSet.laTermAry[ALEN(laArray,1),ALEN(laArray,2)]
          =ACOPY(laArray,loFormSet.laTermAry)
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
        ENDIF

      ENDIF

      *Old: SHOW GET apinvhdr.nterdued &loFormSet.lcTermsDisp
      *Old: SHOW GET apinvhdr.nterdiscd &loFormSet.lcTermsDisp
      *Old: SHOW GET apinvhdr.nterdiscr &loFormSet.lcTermsDisp
      
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *!*	    STORE (loFormSet.lcTermsDisp='ENABLE') TO loFormSet.AriaForm1.txtterdued.Enabled, ;
      *!*	          loFormSet.AriaForm1.txtTerDiscd.Enabled, loFormSet.AriaForm1.txtTerDiscr.Enabled
      STORE (loFormSet.lcTermsDisp='ENABLE') TO loFormSet.AriaForm1.pgfpayInv.pgHead.txtterdued.ENABLED, ;
        loFormSet.AriaForm1.pgfpayInv.pgHead.txtTerDiscd.ENABLED, loFormSet.AriaForm1.pgfpayInv.pgHead.txtTerDiscr.ENABLED
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

      IF loFormSet.ActiveMode="E"
        *loFormSet.lnOldInvAmt = apinvhdr.ninvamnt && Variable to hold the old invoice amount.    &&BOHO
        
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        *loFormSet.lnOldInvAmt = loFormSet.AriaForm1.txtInvAmount.Value && Variable to hold the old invoice amount.
        loFormSet.lnOldInvAmt = loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.VALUE && Variable to hold the old invoice amount.
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
        
      ENDIF

      IF loFormSet.ActiveMode="E" .AND. loFormSet.lnOldDiscOf = 0
        *loFormSet.lnOldDiscOf= apinvhdr.ninvdisof  && Variable to hold the old discount offerd amount  &&BOHO
        
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        *      loFormSet.lnOldDiscOf= loFormSet.AriaForm1.txtInvDisof.Value  && Variable to hold the old discount offerd amount
        loFormSet.lnOldDiscOf= loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvDisof.VALUE  && Variable to hold the old discount offerd amount
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
        
      ENDIF

      IF loFormSet.ActiveMode="E" .AND. EMPTY(loFormSet.lcOldYear)
        loFormSet.lcOldYear  = apinvhdr.cfisfyear  && Variable to hold the old fiscal year of the Inv. date
      ENDIF

      IF loFormSet.ActiveMode="E" .AND. EMPTY(loFormSet.lcOldPeriod)
        loFormSet.lcOldPeriod= apinvhdr.cfspprdid  && Variable to hold the old fiscal period of the Inv. date
      ENDIF

      IF loFormSet.ActiveMode="E" .AND. loFormSet.ldOldDatInv = {}
        *IF TYPE('APINVHDR.DPOSTDATE') = 'D'  &&BOHO
        IF TYPE('loFormSet.AriaForm1.DtPostDate.Value') = 'D'
          *loFormSet.ldOldDatInv= apinvhdr.dpostdate  && Variable to hold the old posting invoice date.  &&BOHO
          loFormSet.ldOldDatInv= loFormSet.AriaForm1.DtPostDate.VALUE  && Variable to hold the old posting invoice date.
        ELSE
          *loFormSet.ldOldDatInv= apinvhdr.dinvdate  && Variable to hold the old invoice date  &&BOHO
          
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
          *loFormSet.ldOldDatInv= loFormSet.AriaForm1.DtInvDate.Value  && Variable to hold the old invoice date
          loFormSet.ldOldDatInv= loFormSet.Ariaform1.pgfpayInv.pgHead.DtInvDate.VALUE  && Variable to hold the old invoice date
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
          
        ENDIF
      ENDIF

      IF loFormSet.ActiveMode="E" .AND. (apinvhdr.ninvamtap+apinvhdr.ninvdisap+apinvhdr.ninvadj) > 0
        IF TYPE('APINVHDR.DPOSTDATE') = 'D'

          *=lfVlDate(gcPrnt_Cmp , @loFormSet.lcDistPrd , @loFormSet.lcDistYer , apinvhdr.dpostdate)  &&BOHO
          *=lfVlDate(oAriaApplication.PrntCompanyID , @loFormSet.lcDistPrd , @loFormSet.lcDistYer , loFormSet.AriaForm1.DtPostDate.Text1.Value)
          lcDistPrd = loFormSet.lcDistPrd
          lcDistYer = loFormSet.lcDistYer
          llLokPer = loFormSet.llLokPer
          =lfVlDate(oAriaApplication.PrntCompanyID , @lcDistPrd , @lcDistYer , loFormSet.AriaForm1.DtPostDate.Text1.VALUE , @llLokPer)
          loFormSet.lcDistPrd = lcDistPrd
          loFormSet.lcDistYer = lcDistYer
          loFormSet.llLokPer = llLokPer
          *Old: SHOW GET apinvhdr.dinvdate DISABLE
          
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
          *loFormSet.AriaForm1.DtInvDate.Enabled=.F.
          loFormSet.Ariaform1.pgfpayInv.pgHead.DtInvDate.ENABLED=.F.
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
          
          *Old: SHOW GET apinvhdr.dpostdate DISABLE
          loFormSet.AriaForm1.DtPostDate.ENABLED=.F.
        ELSE
          *Old: SHOW GET apinvhdr.dinvdate DISABLE
          
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
          *loFormSet.AriaForm1.DtInvDate.Enabled=.F.
          loFormSet.Ariaform1.pgfpayInv.pgHead.DtInvDate.ENABLED=.F.
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
          
        ENDIF
        
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        *loFormSet.AriaForm1.txtInvAmount.SetFocus()
        loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.SETFOCUS()
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      ENDIF

      IF EMPTY(apinvhdr.cchkglacc)
        *apinvhdr.cchkglacc = loFormSet.lcEmptyAcc  &&BOHO
        
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        *REPLACE apinvhdr.cchkglacc WITH loFormSet.AriaForm1.ap1.lcemptyacc IN apinvhdr
        SELECT apinvhdr
        gfREPLACE("cchkglacc WITH '"+loFormSet.AriaForm1.ap1.lcemptyacc+"'")
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      ENDIF

      IF EMPTY(apinvhdr.capacct)
        *apinvhdr.capacct = loFormSet.lcEmptyAcc  &&BOHO
        
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        *loFormSet.DistLines.glAPActCode.KeyTextBox.Value = loFormSet.AriaForm1.ap1.lcemptyacc
        loFormSet.AriaForm1.pgfpayInv.pgDist.glAPActCode.KeyTextBox.VALUE = loFormSet.AriaForm1.ap1.lcemptyacc
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      ENDIF

      IF loFormSet.ActiveMode="E"
        IF apinvhdr.cvenpmeth <> 'C' .AND. !EMPTY(apinvhdr.cvenccven)
          loFormSet.llPaidByCrd = IIF(loFormSet.llPaidByCrd,loFormSet.llPaidByCrd,.T.)
        ENDIF
      ELSE
        loFormSet.llPaidByCrd = .F.
      ENDIF
      *Old: SHOW GET apinvhdr.ccurrcode DISABLE
      *Old: SHOW GET apinvhdr.nexrate DISABLE
      *Old: SHOW GEt ibCurrency DISABLE
      
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *loFormSet.AriaForm1.kbCurrCode.Enabled=.F.
      *loFormSet.AriaForm1.txtNexRate.Enabled=.F.
      loFormSet.AriaForm1.pgfpayInv.pgHead.kbCurrCode.ENABLED=.F.
      loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.ENABLED=.F.
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]


      IF loFormSet.ActiveMode="E"
        loFormSet.lcExSin2 = ''
        *loFormSet.lcExSin1 = gfGetExSin(@loFormSet.lcExSin2,apinvhdr.ccurrcode)  &&BOHO
        lcExSin2 = loFormSet.lcExSin2
        
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        *loFormSet.lcExSin1 = gfGetExSin(@lcExSin2,loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value)
        loFormSet.lcExSin1 = gfGetExSin(@lcExSin2,loFormSet.AriaForm1.pgfpayInv.pgHead.kbCurrCode.KeyTextBox.VALUE)
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
        
        loFormSet.lcExSin2 = lcExSin2

        *19Q: Should we change all the Into DBF commands to Into Cursor ?
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        *E302678,3 TMI 07/26/2011 [Start] in case on FOX case, do not reopen the tables using sqlrun
        IF !lfIsNative('APINVTKT')
          *E302678,3 TMI 07/26/2011 [End  ] 
        =gfSqlRun("Select * from ApInvTkt Where cvendcode='"+;
          PADR(loFormSet.AriaForm1.kbVendCode.keyTextBox.VALUE,8)+;
          "' AND capinvno='"+PADR(loFormSet.AriaForm1.kbInvNo.keyTextBox.VALUE,12)+"'",'ApInvTkt' ,.F.,'ApInvTkt')
        *E302678,3 TMI 07/26/2011 [Start] 
        ENDIF
        IF !lfIsNative('APVINVDT')
          *E302678,3 TMI 07/26/2011 [End  ] 
        =gfSqlRun("Select * from ApVInvDt Where cvendcode='"+;
          PADR(loFormSet.AriaForm1.kbVendCode.keyTextBox.VALUE,8)+;
          "' AND capinvno='"+PADR(loFormSet.AriaForm1.kbInvNo.keyTextBox.VALUE,12)+"'",'ApVInvDt')
          *E302678,3 TMI 07/26/2011 [Start] 
        ENDIF
        *E302678,3 TMI 07/26/2011 [End  ] 
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
        
        SELECT *, 'S' AS cStatus,RECNO() AS nRecNo FROM ApVInvDt WHERE ;
          cvendcode+capinvno+capvilno = PADR(loFormSet.AriaForm1.kbVendCode.keyTextBox.VALUE,8)+PADR(loFormSet.AriaForm1.kbInvNo.keyTextBox.VALUE,12) ;
          INTO DBF (oAriaApplication.WorkDir+loFormSet.lcAPvInvDt)
        INDEX ON cIMTyp+cTktNo+cLotNo+cBomType+cOprCode+ITEM+COLOR+cDyelot TAG ITEM
        INDEX ON cVendCode+cApInvNo+cAPVILNo TAG (loFormSet.lcAPvInvDt) ADDITIVE
        INDEX ON cApDGlAct TAG ADJUST ADDITIVE

        SELECT *, 'S' AS cStatus,RECNO() AS nRecNo FROM ApInvTkt WHERE ;
          cvendcode+capinvno+capvilno = PADR(loFormSet.AriaForm1.kbVendCode.keyTextBox.VALUE,8)+PADR(loFormSet.AriaForm1.kbInvNo.keyTextBox.VALUE,12) ;
          INTO DBF (oAriaApplication.WorkDir+loFormSet.lcAPInvTkt)
        INDEX ON cIMTyp+cTktNo+STR(LINENO,6)+cRSession TAG Ticket
        INDEX ON cVendCode+cApInvNo+cApVILNo+cRSession TAG (loFormSet.lcAPInvTkt) ADDITIVE

        SELECT (loFormSet.lcAPInvTkt)
        REPLACE ALL nAPAplAmnt WITH nAPAplAmnt * -1,;
          nAPAplPric WITH nAPAplPric * -1 FOR (cIMTyp $ 'RF' AND (nAPAplAmnt > 0 ))

        SELECT (loFormSet.lcApVInvDt)
        REPLACE ALL nApAprAmnt WITH nApAprAmnt * -1,;
          nApAprPric WITH nApAprPric * -1,;
          nApPrice   WITH nApPrice   * -1,;
          nApAmnt    WITH nApAmnt    * -1 FOR (cIMTyp $ 'RF' AND (nApAprAmnt > 0 ))
      ENDIF


    CASE loFormSet.ActiveMode="A"
      *Old: IF ASCAN(laEvntTrig , PADR('APINVTYPE',10)) <> 0
      *Old: =lfvUsrFld()
      *Old: ENDIF
      SELECT (loFormSet.lcAPvInvDt)
      ZAP
      SELECT (loFormSet.lcAPInvTkt)
      ZAP

      loFormSet.llSamVendor = .T.
      loFormSet.llPaidByCrd = .F.

      *apinvhdr.dinvdate  = oAriaApplication.SystemDate  &&BOHO
      
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *loFormSet.AriaForm1.DtInvDate.Value  = oAriaApplication.SystemDate
      loFormSet.Ariaform1.pgfpayInv.pgHead.DtInvDate.VALUE  = oAriaApplication.SystemDate
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

      *IF TYPE('APINVHDR.DPOSTDATE') = 'D'  &&BOHO
      IF TYPE('loFormSet.AriaForm1.DtPostDate.Value') = 'D'
        *apinvhdr.dpostdate  = oAriaApplication.SystemDate  &&BOHO
        loFormSet.AriaForm1.DtPostDate.VALUE  = oAriaApplication.SystemDate
      ENDIF

      IF EMPTY(APVENDOR.CVEN1099t) && If empty Vendor 1099 amount type
        loFormSet.lcData23St = 'DISABLE'
      ELSE
        loFormSet.lcData23St = 'ENABLE'
      ENDIF

      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *loFormSet.AriaForm1.cboInvRemit.Value = loFormSet.laRemitTo[1,2] && default remit to vendor
      loFormSet.AriaForm1.pgfpayInv.pgHead.cboInvRemit.VALUE = loFormSet.laRemitTo[1,2] && default remit to vendor
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      
      loFormSet.lcRemitTo   = loFormSet.laRemitTo[1,1]
      puRemitTo   = 1
      *19Q: What does this do ?
      =lfvRemit(loFormSet, .T.)

      *Old: SHOW GET apinvhdr.coutcomp  DISABLE
      *Old: SHOW GET apinvhdr.coutaddr1  DISABLE
      *Old: SHOW GET apinvhdr.coutaddr2  DISABLE
      *Old: SHOW GET apinvhdr.coutaddr3  DISABLE

      *Old: SHOW GET apinvhdr.coutaddr1  DISABLE
      *Old: SHOW GET apinvhdr.coutaddr2  DISABLE
      *Old: SHOW GET apinvhdr.coutaddr3  DISABLE
      *Old: SHOW GET apinvhdr.coutaddr4  DISABLE
      *Old: SHOW GET apinvhdr.coutaddr5  DISABLE
      
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *!*	    STORE .F. TO loFormSet.AriaForm1.txtOutComp.Enabled, ;
      *!*	           loFormSet.AriaForm1.txtOutAddr1.Enabled, loFormSet.AriaForm1.txtOutAddr2.Enabled, ;
      *!*	           loFormSet.AriaForm1.txtOutAddr3.Enabled
      STORE .F. TO loFormSet.AriaForm1.pgfpayInv.pgHead.txtOutComp.ENABLED, ;
        loFormSet.AriaForm1.pgfpayInv.pgHead.txtOutAddr1.ENABLED, loFormSet.AriaForm1.pgfpayInv.pgHead.txtOutAddr2.ENABLED, ;
        loFormSet.AriaForm1.pgfpayInv.pgHead.txtOutAddr3.ENABLED
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      
      *Old: SHOW GET apinvhdr.cbnkcode ENABLE
      *Old: SHOW GET apinvhdr.cchkacct ENABLE
      *STORE .F. TO loFormSet.APAprov.KBBnkCode.Enabled, loFormSet.APAprov.kbChkAcct.Enabled

      *apinvhdr.cvenpmeth = APVENDOR.CVENPMETH   && Assign the payment meth from vendor  &&BOHO
      
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *loFormSet.AriaForm1.cboVendPmeth.Value = APVENDOR.CVENPMETH   && Assign the payment meth from vendor
      loFormSet.AriaForm1.pgfpayInv.pgHead.cboVendPmeth.VALUE = APVENDOR.CVENPMETH   && Assign the payment meth from vendor
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      
      *apinvhdr.cdivision = APVENDOR.CDIVISION   && Assign the division from vendor  &&BOHO
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *loFormSet.AriaForm1.cboDivision.Value = APVENDOR.CDIVISION   && Assign the division from vendor
      loFormSet.AriaForm1.pgfpayInv.pgHead.cboDivision.VALUE = APVENDOR.CDIVISION   && Assign the division from vendor
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      *apinvhdr.ctermcode = APVENDOR.CTERMCODE   && Assign the terms from vendor  &&BOHO

      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *loFormSet.AriaForm1.cboTermCode.Value = APVENDOR.CTERMCODE   && Assign the terms from vendor
      loFormSet.AriaForm1.pgfpayInv.pgHead.cboTermCode.VALUE = APVENDOR.CTERMCODE   && Assign the terms from vendor
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

      *apinvhdr.cvenprior = APVENDOR.CVENPRIOR  &&BOHO
      
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *loFormSet.AriaForm1.txtVendPrior.Value = APVENDOR.CVENPRIOR
      loFormSet.AriaForm1.pgfpayInv.pgHead.txtVendPrior.VALUE = APVENDOR.CVENPRIOR
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      
      *Old: loFormSet.lcPayMethd = loFormSet.laPayMethd[AT(apinvhdr.cvenpmeth,'PMNCH'),1]
      *puMethod   = AT(apinvhdr.cvenpmeth,'PMNCH') &&loFormSet.laPayMethd[AT(laData[3],'PMNCH'),1]

      *IF apinvhdr.cvenpmeth = 'C'  &&BOHO
      
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *IF loFormSet.AriaForm1.cboVendPmeth.Value = 'C'
      IF loFormSet.AriaForm1.pgfpayInv.pgHead.cboVendPmeth.VALUE = 'C'
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
        *Old: SHOW GET pbApprove,1 PROMPT 'Credit c\<ard payment...'
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        *loFormSet.AriaForm1.cmdApprove.Caption='Credit c\<ard payment...'
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
        *Old: SHOW GET pbOk       DISABLE &&Revise
        *Old: SHOW GET pbDiscount DISABLE
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        *loFormSet.AriaForm1.cmdDiscount.Enabled=.F.
        loFormSet.AriaForm1.pgfpayInv.pgHead.cmdDiscount.ENABLED=.F.
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
        *Old: SHOW GET apinvhdr.ninvdisof DISABLE
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        *loFormSet.AriaForm1.txtInvDisof.Enabled=.F.
        loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvDisof.ENABLED=.F.
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      ELSE
        *Old: SHOW GET pbApprove,1 PROMPT '\<Approve for payment...'
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        *loFormSet.AriaForm1.cmdApprove.Caption='\<Approve for payment...'
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
        *Old: IF !EMPTY(apinvhdr.cvenccven) .AND. WVISIBLE('CWRAPDISTR')
        *Old: = gfChClose('CWRAPDISTR')
        *Old: ENDIF
      ENDIF

      IF EMPTY(loFormSet.lcPhone)
        loFormSet.lcPhone   = APVENDOR.cPhoneNo
      ENDIF

      IF EMPTY(loFormSet.lcCompany)
        loFormSet.lcCompany = APVENDOR.cVenComp
      ENDIF

      loFormSet.lcCodeFilt = ''

      *loFormSet.lcDivision = gfCodDes(apinvhdr.cdivision , 'CDIVISION')  &&BOHO
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *loFormSet.lcDivision = gfCodDes(loFormSet.AriaForm1.cboDivision.Value , 'CDIVISION')
      loFormSet.lcDivision = gfCodDes(loFormSet.AriaForm1.pgfpayInv.pgHead.cboDivision.VALUE , 'CDIVISION')
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

      loFormSet.lcPuDiv    = loFormSet.lcDivision


      *loFormSet.lcTermCode = gfCodDes(apinvhdr.ctermcode , 'CTERMCODE')  &&BOHO
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *loFormSet.lcTermCode = gfCodDes(loFormSet.AriaForm1.cboTermCode.Value , 'CTERMCODE')
      loFormSet.lcTermCode = gfCodDes(loFormSet.AriaForm1.pgfpayInv.pgHead.cboTermCode.VALUE , 'CTERMCODE')
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      loFormSet.lcPuTerm   = loFormSet.lcTermCode


      IF loFormSet.ActiveMode="A"
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        *!*	        DIMENSION laAry[ALEN(loFormSet.laTermAry,1),ALEN(loFormSet.laTermAry,2)]
        *!*	        =ACOPY(loFormSet.laTermAry,laAry)
        *!*	        *=gfRltFld(apinvhdr.ctermcode , @loFormSet.laTermAry , 'CTERMCODE')  &&BOHO
        *!*	        =gfRltFld(loFormSet.AriaForm1.cboTermCode.Value , @laAry , 'CTERMCODE')
        *!*	        DIMENSION loFormSet.laTermAry[ALEN(laAry,1),ALEN(laAry,2)]
        *!*	        =ACOPY(laAry,loFormSet.laTermAry)
        *=gfRltFld(loFormSet.AriaForm1.cboTermCode.Value , @laArray, 'CTERMCODE')
        DIMENSION laArray[ALEN(loFormSet.laTermAry,1),ALEN(loFormSet.laTermAry,2)]
        =ACOPY(loFormSet.laTermAry,laArray)
        =gfRltFld(loFormSet.AriaForm1.pgfpayInv.pgHead.cboTermCode.VALUE , @laArray, 'CTERMCODE')
        DIMENSION loFormSet.laTermAry[ALEN(laArray,1),ALEN(laArray,2)]
        =ACOPY(laArray,loFormSet.laTermAry)
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

        *ASM, Disable Payment Controls if the Choosen Terms not empty [Start]
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        *loFormSet.lcTermsDisp = IIF(EMPTY(loFormSet.AriaForm1.cboTermCode.Value),'ENABLE','DISABLE')  &&lower
        *!*	                STORE (loFormSet.lcTermsDisp='ENABLE') TO loFormSet.AriaForm1.txtTerDiscr.Enabled, ;
        *!*	          loFormSet.AriaForm1.txtterdued.Enabled, loFormSet.AriaForm1.txtTerDiscd.Enabled
        loFormSet.lcTermsDisp = IIF(EMPTY(loFormSet.AriaForm1.pgfpayInv.pgHead.cboTermCode.VALUE),'ENABLE','DISABLE')  &&lower
        STORE (loFormSet.lcTermsDisp='ENABLE') TO loFormSet.AriaForm1.pgfpayInv.pgHead.txtTerDiscr.ENABLED, ;
          loFormSet.AriaForm1.pgfpayInv.pgHead.txtterdued.ENABLED, loFormSet.AriaForm1.pgfpayInv.pgHead.txtTerDiscd.ENABLED
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
        *ASM, Disable Payment Controls if the Choosen Terms not empty [End]
        *ASM, Assign the Tag property of the postdate, invoice date and invoice amount
        *To be able not to enter any other control until they are validated
        *STORE 'x' TO loFormSet.AriaForm1.dtPostDate.Tag, loFormSet.AriaForm1.dtInvDate.Tag, ;
        loFormSet.AriaForm1.txtInvAmount.Tag

      ENDIF


      IF EMPTY(loFormSet.lcTermCode) .OR. EMPTY(apinvhdr.ctermcode)  && If empty of the Terms popup or not applicable
        loFormSet.lcTermsDisp= 'ENABLE'
      ELSE
        *IF TYPE('apinvhdr.nterdiscr') = 'N'  &&BOHO
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        *!*	      IF TYPE('loFormSet.AriaForm1.txtTerDiscr.Value') = 'N'
        IF TYPE('loFormSet.AriaForm1.pgfpayInv.pgHead.txtTerDiscr.Value') = 'N'
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
          loFormSet.lcTermsDisp= 'DISABLE'
        ELSE

          *apinvhdr.nterdiscr = 0 && Discount %  &&BOHO
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
          *!*	        loFormSet.AriaForm1.txtTerDiscr.Value = 0 && Discount %
          *!*	        *apinvhdr.nterdued  = 0 && Due days  &&BOHO
          *!*	        loFormSet.AriaForm1.txtterdued.Value  = 0 && Due days
          *!*	        *apinvhdr.nterdiscd = 0 && Dis. Days  &&BOHO
          *!*	        loFormSet.AriaForm1.txtTerDiscd.Value = 0 && Dis. Days
          loFormSet.AriaForm1.pgfpayInv.pgHead.txtTerDiscr.VALUE = 0 && Discount %
          *apinvhdr.nterdued  = 0 && Due days  &&BOHO
          loFormSet.AriaForm1.pgfpayInv.pgHead.txtterdued.VALUE  = 0 && Due days
          *apinvhdr.nterdiscd = 0 && Dis. Days  &&BOHO
          loFormSet.AriaForm1.pgfpayInv.pgHead.txtTerDiscd.VALUE = 0 && Dis. Days
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
          loFormSet.lcTermsDisp= 'ENABLE'
        ENDIF
      ENDIF

      *Old: SHOW GET apinvhdr.nterdiscr &loFormSet.lcTermsDisp
      *Old: SHOW GET apinvhdr.nterdued &loFormSet.lcTermsDisp
      *Old: SHOW GET apinvhdr.nterdiscd &loFormSet.lcTermsDisp
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *!*	    STORE (loFormSet.lcTermsDisp='ENABLE') TO loFormSet.AriaForm1.txtterdued.Enabled, ;
      *!*	          loFormSet.AriaForm1.txtTerDiscd.Enabled, loFormSet.AriaForm1.txtTerDiscr.Enabled
      STORE (loFormSet.lcTermsDisp='ENABLE') TO loFormSet.AriaForm1.pgfpayInv.pgHead.txtterdued.ENABLED, ;
        loFormSet.AriaForm1.pgfpayInv.pgHead.txtTerDiscd.ENABLED, loFormSet.AriaForm1.pgfpayInv.pgHead.txtTerDiscr.ENABLED
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      *Old: SHOW GET loFormSet.lcPhone
      *loFormSet.AriaForm1.kbVendPhone.Refresh()
      *Old: SHOW GET loFormSet.lcCompany
      *loFormSet.AriaForm1.kbVendCompany.Refresh()
      *Old: SHOW GET puMethod
      *loFormSet.AriaForm1.cboVendPmeth.Refresh()
      *Old: SHOW GET loFormSet.lcPuDiv
      *loFormSet.AriaForm1.cboDivision.Refresh()
      *Old: SHOW GET loFormSet.lcPuTerm
      *loFormSet.AriaForm1.cboTermCode.Refresh()

      *IF apinvhdr.ninvamnt = 0  &&BOHO
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *IF loFormSet.AriaForm1.txtInvAmount.Value = 0
      IF loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.VALUE = 0
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      
        loFormSet.lcDistStat = 'DISABLE'
        *Old: SHOW GET pbDisLine DISABLE
        
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        *loFormSet.AriaForm1.cmdDisLine.Enabled=.F.
        loFormSet.AriaForm1.pgfpayInv.pgDist.ENABLED=.F.
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
        
      ELSE
        loFormSet.lcDistStat = 'ENABLE'
        *Old: SHOW GET pbDisLine ENABLE
        
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        *loFormSet.AriaForm1.cmdDisLine.Enabled = .T.
        loFormSet.AriaForm1.pgfpayInv.pgDist.ENABLED=.T.
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
        
      ENDIF
  ENDCASE

  IF loFormSet.ActiveMode="E"
    *IF TYPE('APINVHDR.DPOSTDATE') = 'D'  &&BOHO
    IF TYPE('loFormSet.AriaForm1.DtPostDate.Value') = 'D'
      *Old: _CUROBJ = OBJNUM(apinvhdr.dpostdate)
      loFormSet.AriaForm1.DtPostDate.SETFOCUS()
    ELSE
      *Old: _CUROBJ = OBJNUM(apinvhdr.dinvdate)
      
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *loFormSet.AriaForm1.DtInvDate.SetFocus()
      loFormSet.Ariaform1.pgfpayInv.pgHead.DtInvDate.SETFOCUS()
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      
    ENDIF
  ENDIF

  *IF apinvhdr.ninvamnt <= 0  && If the invoice amount = 0  &&BOHO
  *WAIT WINDOW loFormSet.AriaForm1.txtInvAmount.ControlSource+'x'
  
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *IF TYPE('loFormSet.AriaForm1.txtInvAmount.Value')='N' AND loFormSet.AriaForm1.txtInvAmount.Value <= 0
  IF TYPE('loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.Value')='N' AND loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.VALUE <= 0
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    *Old: SHOW GET pbDiscount DISABLE
    
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *loFormSet.AriaForm1.cmdDiscount.Enabled=.F.
    loFormSet.AriaForm1.pgfpayInv.pgHead.cmdDiscount.ENABLED=.F.
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    
    *Old: SHOW GET apinvhdr.ninvdisof DISABLE
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *loFormSet.AriaForm1.txtInvDisof.Enabled=.F.
    loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvDisof.ENABLED=.F.
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  ENDIF

  *Old:=lfRefresh()    && refresh says filed on the screen

  lcColor1  = SCHEME(1,6)
  lcColor2  = SCHEME(1,2)

  *loFormSet.lcBFactCol= IIF(apinvhdr.cinvremit = 'F', loFormSet.lcSchm7Dis, loFormSet.lcHidObjNrm)  &&BOHO
  
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *loFormSet.lcBFactCol= IIF(loFormSet.AriaForm1.cboInvRemit.Value = 'F', loFormSet.lcSchm7Dis, loFormSet.lcHidObjNrm)
  loFormSet.lcBFactCol= IIF(loFormSet.AriaForm1.pgfpayInv.pgHead.cboInvRemit.VALUE = 'F', loFormSet.lcSchm7Dis, loFormSet.lcHidObjNrm)
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  *loFormSet.lcFactCol = IIF(apinvhdr.cinvremit = 'F', lcDisCont, loFormSet.lcHidObjNrm)  &&BOHO
  *ASM, the next line gives an error because lcDisCont is not defined
  *loFormSet.lcFactCol = IIF(loFormSet.AriaForm1.cboInvRemit.Value = 'F', lcDisCont, loFormSet.lcHidObjNrm)

  *Old: SHOW GET ibDivision  COLOR ,,,,,&lcSelCont,,,&lcEnbCont,&lcDisCont
  *Old: SHOW GET ibTermCode  COLOR ,,,,,&lcSelCont,,,&lcEnbCont,&lcDisCont
  *Old: SHOW GET ibPayMethod COLOR ,,,,,&lcSelCont,,,&lcEnbCont,&lcDisCont

  *Old: SHOW GET apinvhdr.cfaccode &loFormSet.lcFactStat
  *Old: SHOW GET ibFactor   &loFormSet.lcFactStat
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *loFormSet.AriaForm1.kbFacCode.Enabled=(loFormSet.lcFactStat='ENABLE')
  loFormSet.AriaForm1.pgfpayInv.pgHead.kbFacCode.ENABLED=(loFormSet.lcFactStat='ENABLE')
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  
  SELECT APINVHDR


  IF loFormSet.ActiveMode="A" .AND. EMPTY(loFormSet.lcVenInvTypes)

    loFormSet.lcTmplate = 'ENABLE'
    *Old: SHOW GET apinvhdr.cautmcode &loFormSet.lcTmplate
    *Old: SHOW GET ibTemplate &loFormSet.lcTmplate
    
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *loFormSet.AriaForm1.kbAutmCode.Enabled=(loFormSet.lcTmplate='ENABLE')
    loFormSet.AriaForm1.pgfpayInv.pgHead.kbAutmCode.ENABLED=(loFormSet.lcTmplate='ENABLE')
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  ENDIF
  IF apinvhdr.cautmtype = 'R'
    *Old: loFormSet.lcLabel = 'Recurring:' &&Revise: will assign the label caption
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *loFormSet.AriaForm1.lblAutmType.Caption = 'Recurring'
    loFormSet.AriaForm1.pgfpayInv.pgHead.lblAutmType.CAPTION = 'Recurring'
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  ELSE
    *Old: loFormSet.lcLabel = 'Template :' &&Revise: will assign the label caption
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *loFormSet.AriaForm1.lblAutmType.Caption = 'Template'
    loFormSet.AriaForm1.pgfpayInv.pgHead.lblAutmType.CAPTION = 'Template'
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[ENd]
  ENDIF
  IF loFormSet.ActiveMode="S" .OR. loFormSet.ActiveMode="V"
    loFormSet.lcTmplate = 'DISABLE'
    *Old: SHOW GET apinvhdr.cautmcode &loFormSet.lcTmplate &&Revise
    *Old: SHOW GET ibTemplate &loFormSet.lcTmplate &&Revise
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *loFormSet.AriaForm1.kbAutmCode.Enabled=(loFormSet.lcTmplate='ENABLE')
    loFormSet.AriaForm1.pgfpayInv.pgHead.kbAutmCode.ENABLED=(loFormSet.lcTmplate='ENABLE')
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  ENDIF

  SET SKIP OF PAD _INQUIRY OF (loFormSet.cHostFormName) loFormSet.ActiveMode="S"

  RETURN
  *--end of lpFormRefresh


  *!*************************************************************
  *! Name      : lfGetArrElem
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 7/18/2004
  *! Purpose   :
  *!*************************************************************
  *! Parameters: lcSrchCode, laSrchArr
  *!*************************************************************
  *! Returns   : IIF(BETWEEN(lnArrElem, 1, ALEN((laSrchArr), 1)),lnArrElem, 0)
  *!*************************************************************
FUNCTION lfGetArrElem
  PARAMETERS lcSrchCode, laSrchArr
  PRIVATE lnArrElem
  lnArrElem = 1
  DO WHILE lcSrchCode <> laSrchArr[lnArrElem, 2] .AND. ;
      lnArrElem < ALEN(laSrchArr,1)
    lnArrElem = lnArrElem + 1
  ENDDO
  RETURN IIF(BETWEEN(lnArrElem, 1, ALEN(laSrchArr, 1)),lnArrElem, 0)
  *--end of lfGetArrElem


  *!**************************************************************************
  *!
  *!      Function: lfDelShow
  *!
  *!**************************************************************************
  * Validation function of the ok push button of the discont screen.
  *
FUNCTION lfDelShow
  lcLoclShow = "lpShow"
  *E300789,4  AMM No need to SEEK because of the new structure
  *IF SEEK(gcPrnt_cmp,'SYCCOMP')
  *E300789,4  AMM end
  *E300692,1 CHANGE FILE NAME FROM SYCFISHD TO FISHD
  *IF SEEK(gcPrnt_cmp+laData[32],'SYCFISHD')
  *IF SYCFISHD.CFISYSTAT <> 'H' .AND. laData[3] <> 'C' .AND. APINVHDR.CINVSTAT <> 'A'
  *E300789,4  AMM Adjust to fit the new structure
  *IF SEEK(gcPrnt_cmp+laData[32],'FISHD')
  
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *IF SEEK(laData[32],'FISHD')
  IF gfSEEK(laData[32],'FISHD')
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    *E300789,4  AMM end
    IF FISHD.CFISYSTAT <> 'H' .AND. laData[3] <> 'C' .AND. APINVHDR.CINVSTAT <> 'A'
      *E300692,1 end
      IF laScrmode[2]
        IF _DOS
          SHOW GET pbDlt,1 PROMPT '\<Void' ENABLE
        ELSE
          SHOW GET pbDlt ENABLE
        ENDIF
      ELSE
        IF _DOS
          SHOW GET pbDlt,1 PROMPT '\<Void' DISABLE
        ELSE
          SHOW GET pbDlt DISABLE
        ENDIF
      ENDIF
    ELSE
      IF _DOS
        SHOW GET pbDlt,1 PROMPT '\<Void' DISABLE
      ELSE
        SHOW GET pbDlt DISABLE
      ENDIF
    ENDIF
  ELSE
    IF _DOS
      SHOW GET pbDlt,1 PROMPT '\<Void' DISABLE
    ELSE
      SHOW GET pbDlt DISABLE
    ENDIF
  ENDIF
  *E300789,4  AMM Start
  *ENDIF
  *E300789,4  AMM end
  IF laData[3] = 'C'
    SHOW GET pbApprove,1 PROMPT 'Credit c\<ard payment...' &lcAprStat
  ELSE
    SHOW GET pbApprove,1 PROMPT '\<Approve for payment...' &lcAprStat
  ENDIF

  SHOW GET laData[38] &lcTmplate
  SHOW GET ibTemplate &lcTmplate
  SHOW GET pbDisLine  &lcDistStat


  *!*************************************************************
  *! Name      : lfvVendCode
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 7/25/2004
  *! Purpose   : Function called from the Shared Validation of the Vendor Code
  *!*************************************************************
  *! Parameters: The FormSet
  *!*************************************************************
  *! Returns   : None
  *!*************************************************************
FUNCTION lfvVendCode
  LPARAMETERS loFormSet


  SELECT APVENDOR
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  =gfSetOrder('VENCODE')
  *! E302678,1 MMT 03/24/2010 Convert Payable invoice screen to use SQL tables[Start]
  *=gfSeek('')
  *! E302678,1 MMT 03/24/2010 Convert Payable invoice screen to use SQL tables[End]  
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  loFormSet.llBrowse = loFormSet.AriaForm1.kbVendCode.Selectedfrombrowse
  loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE = PADR(loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE,LEN(APVENDOR.cVendCode))
  loFormSet.lcVendor  = loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE  &&lower



  *IF loFormSet.llBrowse .OR. !EMPTY(loFormSet.AriaForm1.KBVendCode.KeyTextBox.Value) .AND. LASTKEY() = 13  &&lower
  IF loFormSet.llBrowse .OR. !EMPTY(loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE)
    *! E302678,1 MMT 03/24/2010 Convert Payable invoice screen to use SQL tables[Start]
    *IF loFormSet.llBrowse .OR. !SEEK(loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE) .OR. ATC("?",loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE) > 0  &&lower    
    IF loFormSet.llBrowse .OR. !gfSEEK(loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE) .OR. ATC("?",loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE) > 0  &&lower
    *! E302678,1 MMT 03/24/2010 Convert Payable invoice screen to use SQL tables[End]
      lnClosRec  = RECNO(0)

      IF loFormSet.llBrowse .OR. ATC("?",loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE) > 0  &&lower
        DIMENSION laTemp[3]
        laTemp = ''

        *lcSavBrFld = lcBrFields
        *lcSavTitle = lcFile_Ttl

        lcBrFields = lfGetBrHd(loFormSet,'APVENDOR')

        lcFile_Ttl = "Vendor"
        IF BETWEEN(lnClosRec,1,RECCOUNT('APVENDOR'))
          GO lnClosRec
        ELSE
          GO TOP
        ENDIF
        *! E302623,2 MMT 10/11/2009 Convert Payable invoice screen to use SQL tables[Start]
        *=gfBrows(' ','CVENDCODE,CPHONENO,CVENCOMP','laTemp')
        *! E302623,2 MMT 01/03/2010 Convert Payable invoice screen to use SQL tables[Start]
        *=gfBrows(' ','CVENDCODE,CPHONENO,CVENCOMP','laTemp','Vendors')
        *! E302678,1 MMT 03/24/2010 Convert Payable invoice screen to use SQL tables[Start]
		=gfSeek('')
		*! E302678,1 MMT 03/24/2010 Convert Payable invoice screen to use SQL tables[End]  
        =ARIABROW(' ', 'Vendors', .F., .F., .F., .F., .F., .T., ;
                'CVENDCODE,CPHONENO,CVENCOMP', 'laTemp', .F., .F., .F., ;
                .F., .F., .F., .F., .F., ;
                .F., .F.)
		*! E302623,2 MMT 01/03/2010 Convert Payable invoice screen to use SQL tables[End]
        *! E302623,2 MMT 10/11/2009 Convert Payable invoice screen to use SQL tables[eND]
        *lcBrFields = lcSavBrFld
        *lcFile_Ttl = lcSavTitle

        IF !EMPTY(laTemp[1])
          loFormSet.lcVendor  = laTemp[1]
          loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE = ALLTRIM(laTemp[1])  &&lower
          loFormSet.lcPhone   = laTemp[2]
          loFormSet.AriaForm1.KBVendPhone.KeyTextBox.VALUE = ALLTRIM(laTemp[2])
          loFormSet.lcCompany = laTemp[3]
          loFormSet.AriaForm1.KBVendCompany.KeyTextBox.VALUE = ALLTRIM(laTemp[3])
          *_CUROBJ   = OBJNUM(loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value)  &&lower&&Old CurObj
          *loFormSet.AriaForm1.kbInvNo.KeyTextBox.SetFocus()
          *KEYBOARD REPLICATE('{TAB}',2)

        ELSE
          *Old: loFormSet.AriaForm1.KBVendCode.KeyTextBox.Value = loFormSet.lcOldVend  &&lower
          loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE = loFormSet.AriaForm1.KBVendCode.KeyTextBox.OldValue
        ENDIF
      ELSE
        IF loFormSet.llAddVen
          lnOption = gfModalGen('QRM00001B00001','Dialog',;
            loFormSet.lcTVenKey + " : " +ALLTRIM(loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE))  &&lower
        ELSE
          lnOption = gfModalGen('QRM00001B00014','Dialog',;
            loFormSet.lcTVenKey + " : " +ALLTRIM(loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE))  &&lower
          lnOption = IIF(lnOption=2,3,lnOption)
        ENDIF
        DO CASE
          CASE lnOption = 1

            DIMENSION laTemp[3]

            laTemp = ''
            *lcSavBrFld = lcBrFields
            *lcSavTitle = lcFile_Ttl
	        *! E302678,1 MMT 03/24/2010 Convert Payable invoice screen to use SQL tables[Start]
			=gfSeek('')
   			*! E302678,1 MMT 03/24/2010 Convert Payable invoice screen to use SQL tables[End]  

            lcBrFields = lfGetBrHd(loFormSet,'APVENDOR')

            lcFile_Ttl = "Vendor"

			*! E302678,1 MMT 03/24/2010 Convert Payable invoice screen to use SQL tables[Start]
*!*	            IF BETWEEN(lnClosRec,1,RECCOUNT('APVENDOR'))
*!*	              GO lnClosRec
*!*	            ELSE
            IF !SEEK(loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE)
			*! E302678,1 MMT 03/24/2010 Convert Payable invoice screen to use SQL tables[End]                        
              GO TOP
            ENDIF
			
			*! E302623,2 MMT 10/11/2009 Convert Payable invoice screen to use SQL tables[Start]
            *=gfBrows(' ','CVENDCODE,CPHONENO,CVENCOMP','laTemp')
            *! E302623,3 MMT 01/03/2010 Convert Payable invoice screen to use SQL tables[Start]
            *=gfBrows(' ','CVENDCODE,CPHONENO,CVENCOMP','laTemp','Vendors')
            =ARIABROW(' ', 'Vendors', .F., .F., .F., .F., .F., .T., ;
                'CVENDCODE,CPHONENO,CVENCOMP', 'laTemp', .F., .F., .F., ;
                .F., .F., .F., .F., .F., ;
                .F., .F.)
            *! E302623,3 MMT 01/03/2010 Convert Payable invoice screen to use SQL tables[End]
			*! E302623,2 MMT 10/11/2009 Convert Payable invoice screen to use SQL tables[eND]
			
            *lcBrFields = lcSavBrFld
            *lcFile_Ttl = lcSavTitle

            IF !EMPTY(laTemp[1])
              loFormSet.lcVendor  = laTemp[1]
              loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE = ALLTRIM(laTemp[1])  &&lower
              loFormSet.lcPhone   = laTemp[2]
              loFormSet.AriaForm1.KBVendPhone.KeyTextBox.VALUE = ALLTRIM(laTemp[2])
              loFormSet.lcCompany = laTemp[3]
              loFormSet.AriaForm1.KBVendCompany.KeyTextBox.VALUE = ALLTRIM(laTemp[3])
              *_CUROBJ   = OBJNUM(loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value)  &&lower&&Old CurObj
              *loFormSet.AriaForm1.kbInvNo.KeyTextBox.SetFocus()
              *KEYBOARD REPLICATE('{TAB}',2)
            ELSE
              *Old: loFormSet.AriaForm1.KBVendCode.KeyTextBox.Value = loFormSet.lcOldVend  &&lower
              loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE = loFormSet.AriaForm1.KBVendCode.KeyTextBox.OldValue
            ENDIF
            *Old: =lfRefresh()
            loFormSet.REFRESH()

          CASE lnOption = 2
            *loFormSet.AriaForm1.KBVendCode.KeyTextBox.Value = loFormSet.AriaForm1.KBVendCode.KeyTextBox.OldValue
            *RETURN .F.
            loFormSet.llFromVend = .T.

            *=gfStatic()
            *Old: DO gpDoProg WITH 'AWRAPVENDR', .F., 'AP',"'" + loFormSet.lcVendor + "'"
            *DO FORM (oAriaApplication.ScreenHome+"APVENDR.SCX") WITH '"'+loFormSet.AriaForm1.KBVendCode.KeyTextBox.Value+'"' TO x
            DO FORM (oAriaApplication.ScreenHome+"APVENDR.SCX") WITH loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE NAME loVendForm NOSHOW
            *loVendForm.AddNew()
            *loVendForm.ariaForm1.kbVendor.KeyTextBox.Value=loFormSet.AriaForm1.KBVendCode.KeyTextBox.Value
            *KEYBOARD loFormSet.AriaForm1.KBVendCode.KeyTextBox.Value
            loVendForm.SHOW(1)
            *=oAriaApplication.DoProgram('AWRAPVENDR','"'+loFormSet.AriaForm1.KBVendCode.KeyTextBox.Value+'"',.F.,'AP')
            RETURN .F.

          CASE lnOption = 3
            *Old: loFormSet.AriaForm1.KBVendCode.KeyTextBox.Value = loFormSet.lcOldVend  &&lower
            loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE = loFormSet.AriaForm1.KBVendCode.KeyTextBox.OldValue
            *Old: _CUROBJ   = _CUROBJ&&Old CurObj
            RETURN .F.
            *Old: =lfRefresh()
            *loFormSet.Refresh()
        ENDCASE
      ENDIF
    ELSE
      loFormSet.lcPhone   = APVENDOR.CPHONENO
      loFormSet.AriaForm1.KBVendPhone.KeyTextBox.VALUE = APVENDOR.CPHONENO
      loFormSet.lcCompany = APVENDOR.CVENCOMP
      loFormSet.AriaForm1.KBVendCompany.KeyTextBox.VALUE = APVENDOR.CVENCOMP
      *_CUROBJ   = OBJNUM(loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value)  &&lower&&Old CurObj
      *loFormSet.AriaForm1.kbInvNo.KeyTextBox.SetFocus()
      *KEYBOARD REPLICATE('{TAB}',2)
    ENDIF
  ELSE
    *Old: loFormSet.AriaForm1.KBVendCode.KeyTextBox.Value = loFormSet.lcOldVend  &&lower
    loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE = loFormSet.AriaForm1.KBVendCode.KeyTextBox.OldValue
  ENDIF

  *Old: SHOW GET loFormSet.AriaForm1.KBVendCode.KeyTextBox.Value  &&lower &&Revise
  *Old: SHOW GET ibVendor  ENABLE &&Revise
  loFormSet.AriaForm1.KBVendCode.ENABLED = .T.
  *Old: SHOW GET loFormSet.lcPhone   ENABLE &&Revise
  *Old: SHOW GET ibPhone   ENABLE &&Revise
  loFormSet.AriaForm1.KBVendPhone.ENABLED = .T.
  *Old: SHOW GET loFormSet.lcCompany ENABLE &&Revise
  *Old: SHOW GET ibCompany ENABLE &&Revise
  loFormSet.AriaForm1.KBVendCompany.ENABLED = .T.
  *Old: SHOW GET loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value  &&lower &&Revise
  *Old: SHOW GET ibInvoice ENABLE &&Revise
  loFormSet.AriaForm1.kbInvNo.ENABLED = .T.

  loFormSet.llBrowse = .F.
  loFormSet.lcVenInvTypes = ALLTRIM(APVENDOR.cVenInvTyp)
  loFormSet.lcVenInvTypes = loFormSet.lcVenInvTypes + IIF(gfGetmemvar('M_BOMVAR') AND 'M' $ loFormSet.lcVenInvTypes,'A','')
  loFormSet.lcVenInvTypes = loFormSet.lcVenInvTypes + IIF(!EMPTY(gfGetmemvar('M_DYEOPR')) AND 'M' $ loFormSet.lcVenInvTypes,'D','')

  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	loFormSet.DistLines.glAPActCode.KeyTextBox.Value = IIF(!EMPTY(APVENDOR.CAPACCT),APVENDOR.CAPACCT, ;
  *!*	   IIF(SEEK(loFormSet.AriaForm1.cboDivision.Value,'APDIV') AND !EMPTY(APDIV.CAPACCT),APDIV.CAPACCT,APSETUP.CAPACCT))  &&lower
  *!*	loFormSet.lcDistAcct = IIF(!EMPTY(APVENDOR.CEXPACCT),APVENDOR.CEXPACCT,;
  *!*	  IIF(SEEK(loFormSet.AriaForm1.cboDivision.Value,'APDIV') AND !EMPTY(APDIV.CEXPACCT),APDIV.CEXPACCT,APSETUP.CEXPACCT))  &&lower
  loFormSet.AriaForm1.pgfpayInv.pgDist.glAPActCode.KeyTextBox.VALUE = IIF(!EMPTY(APVENDOR.CAPACCT),APVENDOR.CAPACCT, ;
    IIF(gfSEEK(loFormSet.AriaForm1.pgfpayInv.pgHead.cboDivision.VALUE,'APDIV') AND !EMPTY(APDIV.CAPACCT),APDIV.CAPACCT,APSETUP.CAPACCT))  &&lower
  loFormSet.lcDistAcct = IIF(!EMPTY(APVENDOR.CEXPACCT),APVENDOR.CEXPACCT,;
    IIF(gfSEEK(loFormSet.AriaForm1.pgfpayInv.pgHead.cboDivision.VALUE,'APDIV') AND !EMPTY(APDIV.CEXPACCT),APDIV.CEXPACCT,APSETUP.CEXPACCT))  &&lower
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

  SELECT APINVHDR
  *--end of lfvVendCode


  *!*************************************************************
  *! Name      : lfvInvNo
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 7/25/2004
  *! Purpose   : Function called from the Shared Validation of the Invoice No.
  *!*************************************************************
  *! Parameters: The FormSet
  *!*************************************************************
  *! Returns   : None
  *!*************************************************************
FUNCTION lfvInvNo
  LPARAMETERS loFormSet
  LOCAL lcVendCode, lcInvNO

  SELECT APINVHDR
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *! E302678,1 MMT 03/24/2010 Convert Payable invoice screen to use SQL tables[Start]
  *=gfSeek('')
  *! E302678,1 MMT 03/24/2010 Convert Payable invoice screen to use SQL tables[End]
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  loFormSet.llBrowse = loFormSet.AriaForm1.kbInvNo.Selectedfrombrowse
  loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE = PADR(loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE,LEN(APVENDOR.cVendCode))
  loFormSet.AriaForm1.kbInvNo.KeyTextBox.VALUE = PADR(loFormSet.AriaForm1.kbInvNo.KeyTextBox.VALUE,LEN(APINVHDR.cInvNo))

  lcBrFields = loFormSet.ariaBrFields.edtBrowseFields.VALUE

  lcSavExact = SET('EXACT')
  SET EXACT ON
  
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *IF !EMPTY(ALLTRIM(loFormSet.AriaForm1.KBVendCode.KeyTextBox.Value)) .AND. !SEEK(ALLTRIM(loFormSet.AriaForm1.KBVendCode.KeyTextBox.Value),'APVENDOR')  &&lower
  IF !EMPTY(ALLTRIM(loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE)) .AND.;
      !gfSEEK(ALLTRIM(loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE),'APVENDOR')  &&lower
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  
    *Old: _CUROBJ = OBJNUM(loFormSet.AriaForm1.KBVendCode.KeyTextBox.Value)  &&lower&&Old CurObj
    *loFormSet.AriaForm1.KBVendCode.KeyTextBox.SetFocus()
    *Old: SHOW GET loFormSet.AriaForm1.KBVendCode.KeyTextBox.Value  &&lower &&Revise
    loFormSet.AriaForm1.KBVendCode.KeyTextBox.REFRESH()
    RETURN
  ENDIF

  *Old: loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value  = ;
  IIF(EMPTY(loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value),;
  loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value,;
  ALLTRIM(loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value))  &&lower

  loFormSet.lcCodeFilt = ''
  *IF loFormSet.llBrowse .OR. !EMPTY(loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value) .AND. LASTKEY() = 13  &&lower
  IF loFormSet.llBrowse .OR. !EMPTY(loFormSet.AriaForm1.kbInvNo.KeyTextBox.VALUE)
    IF loFormSet.llBrowse .OR. ATC("?",loFormSet.AriaForm1.kbInvNo.KeyTextBox.VALUE) > 0 .OR. EMPTY(loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE)  &&lower  &&lower
      DIMENSION laTemp[2]
      laTemp = ''

      IF EMPTY(loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE)  &&lower
        *! E302623,2 MMT 10/12/2009 Convert Payable invoice screen to use SQL tables[Start]
        *gfBrows(.F.,'CVENDCODE,CINVNO','laTemp')
        *! E302623,3 MMT 01/03/2010 Convert Payable invoice screen to use SQL tables[Start]
        *=gfBrows(.F.,'CVENDCODE,CINVNO','laTemp','Invoices')
        *! E302678,1 MMT 03/24/2010 Convert Payable invoice screen to use SQL tables[Start]
        =gfSeek('')        
		*! E302678,1 MMT 03/24/2010 Convert Payable invoice screen to use SQL tables[End]          
         =ARIABROW(.F., 'Invoices', .F., .F., .F., .F., .F., .T., ;
                'CVENDCODE,CINVNO', 'laTemp', .F., .F., .F., ;
                .F., .F., .F., .F., .F., ;
                .F., .F.)
        *! E302623,3 MMT 01/03/2010 Convert Payable invoice screen to use SQL tables[End]
        *! E302623,2 MMT 10/12/2009 Convert Payable invoice screen to use SQL tables[End]
      ELSE
        SET EXACT &lcSavExact
        *! E302678,1 MMT 03/24/2010 Convert Payable invoice screen to use SQL tables[Start]
        *IF SEEK(loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE)  &&lower
        IF gfSEEK(loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE)          
        *! E302678,1 MMT 03/24/2010 Convert Payable invoice screen to use SQL tables[End]        
          *! E302623,2 MMT 10/12/2009 Convert Payable invoice screen to use SQL tables[Start]
          *=gfBrows('"'+loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE+'"','CVENDCODE,CINVNO','laTemp')
          *! E302623,3 MMT 01/03/2010 Convert Payable invoice screen to use SQL tables[Start]
          *=gfBrows('"'+loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE+'"','CVENDCODE,CINVNO','laTemp','Invoices')
 	  	  =ARIABROW("'"+PADR(loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE,8)+"'", 'Invoices', .F., .F., .F., .F., .F., .T., ;
                'CVENDCODE,CINVNO', 'laTemp', .F., .F., .F., ;
                .F., .F., .F., .F., .F., ;
                .F., .F.)
          *! E302623,3 MMT 01/03/2010 Convert Payable invoice screen to use SQL tables[End]
          *! E302623,2 MMT 10/12/2009 Convert Payable invoice screen to use SQL tables[End]
        ELSE
          =gfModalGen("TRM04042B00000","DIALOG","invoices|"+loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE)  &&lower
        ENDIF
      ENDIF

      IF !EMPTY(laTemp[1])
        *Old: SCATTER FIELDS &loFormSet.lcScFields MEMO TO laData
        *Old: laScrMode    = .F.
        loFormSet.ChangeMode("V")
        SET EXACT &lcSavExact
        *Old: SHOW GETS &&Revise
      ELSE
        *Old: loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value = loFormSet.lcOldInvNo  &&lower
        loFormSet.AriaForm1.kbInvNo.KeyTextBox.VALUE = loFormSet.AriaForm1.kbInvNo.KeyTextBox.OldValue
        *Old: SHOW GET loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value  &&lower &&Revise
        *_CUROBJ = OBJNUM(loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value)  &&lower&&Old CurObj
        *loFormSet.AriaForm1.kbInvNo.KeyTextBox.SetFocus()
      ENDIF
    ELSE
      SET FILTER TO
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *!*	    IF SEEK(loFormSet.AriaForm1.KBVendCode.KeyTextBox.Value+;
      *!*	            loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value,'APINVHDR') .AND. APINVHDR.CINVSTAT <> 'V'  &&lower
      IF gfSEEK(loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE+;
          loFormSet.AriaForm1.kbInvNo.KeyTextBox.VALUE,'APINVHDR') .AND. APINVHDR.CINVSTAT <> 'V'  &&lower
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
        
        SET FILTER TO CINVSTAT <> 'V'
        *Old: SCATTER FIELDS &loFormSet.lcScFields MEMO TO laData
        *Old: laScrMode    = .F.
        loFormSet.ChangeMode("V")
        SET EXACT &lcSavExact
        *Old: SHOW GETS &&Revise
      ELSE
        IF APINVHDR.CINVSTAT = 'V'
          SET FILTER TO CINVSTAT <> 'V'
          =gfModalGen('QRM04146B00000','Dialog',ALLTRIM(loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE)+'|'+ALLTRIM(loFormSet.AriaForm1.kbInvNo.KeyTextBox.VALUE))  &&lower  &&lower
          *loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value = loFormSet.lcOldInvNo  &&lower
          loFormSet.AriaForm1.kbInvNo.KeyTextBox.VALUE = loFormSet.AriaForm1.kbInvNo.KeyTextBox.OldValue
          *Old: SHOW GET loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value  &&lower &&Revise
          *Old: _CUROBJ = OBJNUM(loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value)  &&lower&&Old CurObj
          *loFormSet.AriaForm1.kbInvNo.KeyTextBox.SetFocus()
        ELSE
          SET FILTER TO CINVSTAT <> 'V'
          lnOption = gfModalGen('QRM00001B00001','Dialog',;
            loFormSet.lcTVenInv + ALLTRIM(loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE)+' '+ALLTRIM(loFormSet.AriaForm1.kbInvNo.KeyTextBox.VALUE))  &&lower  &&lower
          DO CASE
            CASE lnOption = 1             && Browse
              SET EXACT &lcSavExact
              *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
              *IF SEEK(loFormSet.AriaForm1.KBVendCode.KeyTextBox.Value)  &&lower
              IF gfSEEK(loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE)  &&lower
              *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
                DIMENSION laTemp[2]
                laTemp = ''
                lcVendCode=loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE
                *=gfBrows([FOR CVENDCODE = lcVendCode],'CVENDCODE,CPHONENO,CVENCOMP','laTemp')
                *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
                *!*	              SELECT * from apinvhdr WHERE CVENDCODE+CINVNO=loFormSet.AriaForm1.KBVendCode.KeyTextBox.Value ;
                *!*	                 INTO CURSOR apinvhdr2
                *! E302623,3 MMT 01/03/2010 Convert Payable invoice screen to use SQL tables[Start]
                *gfSqlRun("SELECT * from apinvhdr WHERE CVENDCODE ='"+loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE+"'",'apinvhdr',.F.,'apinvhdr2')
		        *! E302623,3 MMT 01/03/2010 Convert Payable invoice screen to use SQL tables[End]
                *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
				
				*! E302623,2 MMT 10/12/2009 Convert Payable invoice screen to use SQL tables[Start]
*!*	                =gfBrows('FOR CVENDCODE = "'+loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE+'"' ;
*!*	                  ,'CVENDCODE,CINVNO','laTemp')
		        *! E302623,3 MMT 01/03/2010 Convert Payable invoice screen to use SQL tables[Start]
                *=gfBrows('FOR CVENDCODE = "'+loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE+'"' ;
                  ,'CVENDCODE,CINVNO','laTemp','Invoices')
                SELECT apinvhdr
				*! E302678,1 MMT 03/24/2010 Convert Payable invoice screen to use SQL tables[Start]
		        =gfSeek(PADR(loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE,8))
				*! E302678,1 MMT 03/24/2010 Convert Payable invoice screen to use SQL tables[End]
                =ARIABROW('"'+loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE+'"' , 'Invoices', .F., .F., .F., .F., .F., .T., ;
                'CVENDCODE,CINVNO', 'laTemp', .F., .F., .F., ;
                .F., .F., .F., .F., .F., ;
                .F., .F.)  
                *! E302623,3 MMT 01/03/2010 Convert Payable invoice screen to use SQL tables[End]
                *! E302623,2 MMT 10/12/2009 Convert Payable invoice screen to use SQL tables[End]  
                SELECT APINVHDR
                IF !EMPTY(laTemp[1])
                  loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE = ALLTRIM(laTemp[1])  &&lower
                  loFormSet.AriaForm1.kbInvNo.KeyTextBox.VALUE = ALLTRIM(laTemp[2])  &&lower
                  *Old: SCATTER FIELDS &loFormSet.lcScFields MEMO TO laData
                  *Old: laScrMode = .F.
                  loFormSet.ChangeMode("V")
                  SET EXACT &lcSavExact
                  *Old: SHOW GETS &&Revise
                ELSE
                  *Old: loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value = loFormSet.lcOldInvNo  &&lower
                  loFormSet.AriaForm1.kbInvNo.KeyTextBox.VALUE = loFormSet.AriaForm1.kbInvNo.KeyTextBox.OldValue
                  *Old: SHOW GET loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value  &&lower &&Revise
                  *Old: _CUROBJ = OBJNUM(loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value)  &&lower&&Old CurObj
                  *loFormSet.AriaForm1.kbInvNo.KeyTextBox.SetFocus()
                ENDIF
              ELSE
                =gfModalGen("TRM04042B00000","DIALOG","invoices|"+loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE)  &&lower
                *Old: loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value = loFormSet.lcOldInvNo  &&lower
                loFormSet.AriaForm1.kbInvNo.KeyTextBox.VALUE = loFormSet.AriaForm1.kbInvNo.KeyTextBox.OldValue
                *Old: SHOW GET loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value  &&lower &&Revise
                *Old: _CUROBJ = OBJNUM(loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value)  &&lower&&Old CurObj
                *loFormSet.AriaForm1.kbInvNo.KeyTextBox.SetFocus()
              ENDIF

            CASE lnOption = 2       && Add

              lcVendCode = loFormSet.AriaForm1.kbVendcode.KeyTextBox.VALUE
              lcInvNO = loFormSet.AriaForm1.kbInvNo.KeyTextBox.VALUE
              SELECT apinvhdr
              APPEND BLANK
              REPLACE cvendcode WITH lcVendCode, cInvNo WITH lcInvNO

              *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
              =gfReplace("")
              *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

              loFormSet.lcVenInvTypes = ALLTRIM(APVENDOR.cVenInvTyp)
              loFormSet.lcVenInvTypes = loFormSet.lcVenInvTypes + IIF(gfGetmemvar('M_BOMVAR') AND 'M' $ loFormSet.lcVenInvTypes,'A','')
              loFormSet.lcVenInvTypes = loFormSet.lcVenInvTypes + IIF(!EMPTY(gfGetmemvar('M_DYEOPR')) AND 'M' $ loFormSet.lcVenInvTypes,'D','')

              *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
              *!*	            loFormSet.DistLines.glAPActCode.KeyTextBox.Value = IIF(!EMPTY(APVENDOR.CAPACCT),APVENDOR.CAPACCT, ;
              *!*	              IIF(SEEK(loFormSet.AriaForm1.cboDivision.Value,'APDIV') AND !EMPTY(APDIV.CAPACCT),APDIV.CAPACCT,APSETUP.CAPACCT))  &&lower
              *!*	            loFormSet.lcDistAcct = IIF(!EMPTY(APVENDOR.CEXPACCT),APVENDOR.CEXPACCT,;
              *!*	              IIF(SEEK(loFormSet.AriaForm1.cboDivision.Value,'APDIV') AND !EMPTY(APDIV.CEXPACCT),APDIV.CEXPACCT,APSETUP.CEXPACCT))  &&lower
              loFormSet.AriaForm1.pgfpayInv.pgDist.glAPActCode.KeyTextBox.VALUE = IIF(!EMPTY(APVENDOR.CAPACCT),APVENDOR.CAPACCT, ;
                IIF(gfSEEK(loFormSet.AriaForm1.pgfpayInv.pgHead.cboDivision.VALUE,'APDIV') AND !EMPTY(APDIV.CAPACCT),APDIV.CAPACCT,APSETUP.CAPACCT))  &&lower
              loFormSet.lcDistAcct = IIF(!EMPTY(APVENDOR.CEXPACCT),APVENDOR.CEXPACCT,;
                IIF(gfSEEK(loFormSet.AriaForm1.pgfpayInv.pgHead.cboDivision.VALUE,'APDIV') AND !EMPTY(APDIV.CEXPACCT),APDIV.CEXPACCT,APSETUP.CEXPACCT))  &&lower
              *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
              *Old: laScrMode    = .F.

              loFormSet.changeMode("A")
              loFormSet.RaiseRecordChange(5)

              *!*	            loFormSet.AddNew()
              *!*	            SELECT apinvhdr
              *!*	            IF loFormSet.ActiveMode = 'A'
              *!*	               REPLACE cvendcode WITH lcVendCode, cInvNo WITH lcInvNO
              *!*	            ENDIF
              *!*	            loFormSet.RefreshAll()
              *!*	            loFormSet.RaiseRecordChange(5)

              IF TYPE('loFormSet.AriaForm1.DtPostDate.Value') = 'D'
                *Old: _CUROBJ = OBJNUM(loFormSet.AriaForm1.DtPostDate.Value)  &&lower&&Old CurObj
                *loFormSet.AriaForm1.DtPostDate.SetFocus()
              ELSE
                *Old: _CUROBJ = OBJNUM(loFormSet.AriaForm1.DtInvDate.Value)  &&lower&&Old CurObj
                *loFormSet.AriaForm1.DtInvDate.SetFocus()
              ENDIF
              SET EXACT &lcSavExact
              *Old: SHOW GETS &&Revise

            CASE lnOption = 3       && Reenter

              *Old: loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value = loFormSet.lcOldInvNo  &&lower
              loFormSet.AriaForm1.kbInvNo.KeyTextBox.VALUE = loFormSet.AriaForm1.kbInvNo.KeyTextBox.OldValue
              *Old: SHOW GET loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value  &&lower &&Revise
              *Old: SHOW GET ibInvoice ENABLE &&Revise
              loFormSet.AriaForm1.kbInvNo.ENABLED = .T.
              *! E302623,3 MMT 01/03/2010 Convert Payable invoice screen to use SQL tables[Start]
              RETURN .F.
	          *! E302623,3 MMT 01/03/2010 Convert Payable invoice screen to use SQL tables[End]
              *Old: _CUROBJ = OBJNUM(loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value)  &&lower&&Old CurObj
              *loFormSet.AriaForm1.kbInvNo.KeyTextBox.SetFocus()
          ENDCASE
        ENDIF
      ENDIF
    ENDIF
  ENDIF

  IF !EMPTY(loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE) .AND. !EMPTY(loFormSet.AriaForm1.kbInvNo.KeyTextBox.VALUE)  &&lower  &&lower
    =lfTaxAct(loFormSet)
  ENDIF

  SET EXACT &lcSavExact

  IF !loFormSet.ActiveMode="S"  &&lower
    loFormSet.lcDefFact = APVENDOR.cFacCode
  ENDIF

  loFormSet.llBrowse = .F.

  IF apinvhdr.cautmtype = 'R'  &&lower
    loFormSet.lcLabel = 'Recurring:'
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *loFormSet.AriaForm1.lblAutmType.Caption = 'Recurring'
    loFormSet.AriaForm1.pgfpayInv.pgHead.lblAutmType.CAPTION = 'Recurring'
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  ELSE      && Else
    loFormSet.lcLabel = 'Template :'
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *loFormSet.AriaForm1.lblAutmType.Caption = 'Template'
    loFormSet.AriaForm1.pgfpayInv.pgHead.lblAutmType.CAPTION = 'Template'
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  ENDIF     && End of IF
  *Old: =lfRefresh(gcBaseWind)
  loFormSet.REFRESH()

  SELECT APINVHDR
  *--end of lfvInvNo


  *!*************************************************************
  *! Name      : lfvCompPhone
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 7/25/2004
  *! Purpose   : Function called from Shared Validation of the Company and Phone
  *!*************************************************************
  *! Parameters: The FormSet
  *!           : A Paremeter to indicate whether called from the Company or the Phone
  *!*************************************************************
  *! Returns   : None
  *!*************************************************************
FUNCTION lfvCompPhone
  LPARAMETERS loFormSet, lcObjNum

  SELECT APVENDOR
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *lcSavOrder = SET('ORDER')
  lcSavOrder = ORDER()
  =gfSeek('')
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

  loFormSet.llBrowse = IIF(lcObjNum='1',loFormSet.AriaForm1.kbVendPhone.Selectedfrombrowse, ;
    loFormSet.AriaForm1.kbVendCompany.Selectedfrombrowse)

  IF lcObjNum = '1'
    loFormSet.AriaForm1.KBVendPhone.KeyTextBox.VALUE = PADR(loFormSet.AriaForm1.KBVendPhone.KeyTextBox.VALUE,LEN(APVENDOR.CPHONENO))
    lcObjName = ALLTRIM(loFormSet.AriaForm1.KBVendPhone.KeyTextBox.VALUE)
  ELSE
    loFormSet.AriaForm1.KBVendCompany.KeyTextBox.VALUE = PADR(loFormSet.AriaForm1.KBVendCompany.KeyTextBox.VALUE,LEN(APVENDOR.CVENCOMP))
    lcObjName = ALLTRIM(loFormSet.AriaForm1.KBVendCompany.KeyTextBox.VALUE)
  ENDIF

  *Old: IF lcObjNum = '1' .AND. loFormSet.lcOldPhone = loFormSet.lcPhone .AND. !loFormSet.llBrowse
  IF lcObjNum = '1' .AND. loFormSet.AriaForm1.KBVendPhone.KeyTextBox.OldValue = ;
      loFormSet.AriaForm1.KBVendPhone.KeyTextBox.VALUE .AND. !loFormSet.llBrowse
    RETURN
  ENDIF

  *Old: IF lcObjNum = '2' .AND. loFormSet.lcOldComp = loFormSet.lcCompany .AND. !loFormSet.llBrowse
  IF lcObjNum = '2' .AND. loFormSet.AriaForm1.KBVendCompany.KeyTextBox.OldValue = ;
      loFormSet.AriaForm1.KBVendCompany.KeyTextBox.VALUE .AND. !loFormSet.llBrowse
    RETURN
  ENDIF

  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *SET ORDER TO TAG IIF(lcObjNum = '1','VENPHONE','VENCOMP')
  gfSETORDER(IIF(lcObjNum = '1','VENPHONE','VENCOMP'))
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  *Old: lcObjName  = ALLTRIM(UPPER(EVALUATE(SYS(18))))

  lcSavExact = SET('EXACT')
  SET EXACT ON

  *IF loFormSet.llBrowse .OR. !EMPTY(lcObjName) .AND. LASTKEY() = 13
  IF loFormSet.llBrowse .OR. !EMPTY(lcObjName)
    IF loFormSet.llBrowse .OR. !SEEK(lcObjName) .OR. ATC("?",lcObjName) > 0
      lnClosRec  = RECNO(0)
      DIMENSION laTemp[3]

      laTemp = ''

      *lcSavBrFld = lcBrFields
      *lcSavTitle = lcFile_Ttl

      lcBrFields = "CVENDCODE :H= 'Vendor Code',;
                  CVENCOMP :H= 'Company',;
                  CPHONENO :H= 'Phone'"

      lcFile_Ttl = "Vendor"

      IF BETWEEN(lnClosRec,1,RECCOUNT('APVENDOR'))
        GO lnClosRec
      ELSE
        GO TOP
      ENDIF
      *! E302623,2 MMT 10/12/2009 Convert Payable invoice screen to use SQL tables[Start]
      *=gfBrows(' ','CVENDCODE,CPHONENO,CVENCOMP','laTemp')
      *! E302623,3 MMT 01/03/2010 Convert Payable invoice screen to use SQL tables[Start]
	  * =gfBrows(' ','CVENDCODE,CPHONENO,CVENCOMP','laTemp',lcFile_Ttl )
	   =ARIABROW(' ', lcFile_Ttl , .F., .F., .F., .F., .F., .T., ;
                'CVENDCODE,CPHONENO,CVENCOMP', 'laTemp', .F., .F., .F., ;
                .F., .F., .F., .F., .F., ;
                .F., .F.)
      *! E302623,3 MMT 01/03/2010 Convert Payable invoice screen to use SQL tables[End]
	  *! E302623,2 MMT 10/12/2009 Convert Payable invoice screen to use SQL tables[End]
      *lcBrFields = lcSavBrFld
      *lcFile_Ttl = lcSavTitle

      IF !EMPTY(laTemp[1])
        loFormSet.lcVendor  = laTemp[1]
        loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE = ALLTRIM(laTemp[1])  &&lower
        loFormSet.lcPhone   = laTemp[2]
        loFormSet.AriaForm1.KBVendPhone.KeyTextBox.VALUE = ALLTRIM(laTemp[2])
        loFormSet.lcCompany = laTemp[3]
        loFormSet.AriaForm1.KBVendCompany.KeyTextBox.VALUE = ALLTRIM(laTemp[3])
        *Old: _CUROBJ   = OBJNUM(loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value)  &&lower&&Old CurObj
        *loFormSet.AriaForm1.kbInvNo.KeyTextBox.SetFocus()
      ELSE
        IF lcObjNum = '1'
          loFormSet.lcPhone   = loFormSet.lcOldPhone
          loFormSet.AriaForm1.KBVendPhone.KeyTextBox.VALUE = loFormSet.AriaForm1.KBVendPhone.KeyTextBox.OldValue
        ELSE
          loFormSet.lcCompany = loFormSet.lcOldComp
          loFormSet.AriaForm1.KBVendCompany.KeyTextBox.VALUE = loFormSet.AriaForm1.KBVendCompany.KeyTextBox.OldValue
        ENDIF
      ENDIF
    ELSE
      IF !EOF()
        SKIP 1
        lcNxtPhone = APVENDOR.CPHONENO
        lcNxtComp  = UPPER(ALLTRIM(APVENDOR.CVENCOMP))
        IF lcObjName = IIF(lcObjNum = '1',lcNxtPhone,lcNxtComp)
          lnClosRec  = RECNO(0)
          SKIP - 1
          DIMENSION laTemp[3]

          laTemp = ''

          *lcSavBrFld = lcBrFields
          *lcSavTitle = lcFile_Ttl

          lcBrFields = "CVENDCODE :H= 'Vendor Code',;
                      CVENCOMP :H= 'Company',;
                      CPHONENO :H= 'Phone'"

          lcFile_Ttl = "Vendor"

          IF BETWEEN(lnClosRec,1,RECCOUNT('APVENDOR'))
            GO lnClosRec
          ELSE
            GO TOP
          ENDIF

          IF lcObjNum = '1'
            *! E302623,2 MMT 10/12/2009 Convert Payable invoice screen to use SQL tables[Start]
            *=gfBrows([FOR CPHONENO = lcObjName],'CVENDCODE,CPHONENO,CVENCOMP','laTemp')    
            *! E302623,3 MMT 01/03/2010 Convert Payable invoice screen to use SQL tables[Start]        
            *=gfBrows([FOR CPHONENO = lcObjName],'CVENDCODE,CPHONENO,CVENCOMP','laTemp',lcFile_Ttl)
            =ARIABROW([FOR CPHONENO = lcObjName], lcFile_Ttl , .F., .F., .F., .F., .F., .T., ;
                'CVENDCODE,CPHONENO,CVENCOMP', 'laTemp', .F., .F., .F., ;
                .F., .F., .F., .F., .F., ;
                .F., .F.)
            *! E302623,3 MMT 01/03/2010 Convert Payable invoice screen to use SQL tables[End]
            *! E302623,2 MMT 10/12/2009 Convert Payable invoice screen to use SQL tables[End]
          ELSE
            *! E302623,2 MMT 10/12/2009 Convert Payable invoice screen to use SQL tables[Start]
            *=gfBrows([FOR UPPER(ALLTRIM(CVENCOMP)) = lcObjName],'CVENDCODE,CPHONENO,CVENCOMP','laTemp')            
            *! E302623,3 MMT 01/03/2010 Convert Payable invoice screen to use SQL tables[Start]
            *=gfBrows([FOR UPPER(ALLTRIM(CVENCOMP)) = lcObjName],'CVENDCODE,CPHONENO,CVENCOMP','laTemp',lcFile_Ttl )
            =ARIABROW([FOR UPPER(ALLTRIM(CVENCOMP)) = lcObjName], lcFile_Ttl , .F., .F., .F., .F., .F., .T., ;
                'CVENDCODE,CPHONENO,CVENCOMP', 'laTemp', .F., .F., .F., ;
                .F., .F., .F., .F., .F., ;
                .F., .F.)
            *! E302623,3 MMT 01/03/2010 Convert Payable invoice screen to use SQL tables[End]
            *! E302623,2 MMT 10/12/2009 Convert Payable invoice screen to use SQL tables[End]
          ENDIF

          *lcBrFields = lcSavBrFld
          *lcFile_Ttl = lcSavTitle

          IF !EMPTY(laTemp[1])
            loFormSet.lcVendor  = laTemp[1]
            loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE = ALLTRIM(laTemp[1])  &&lower
            loFormSet.lcPhone   = laTemp[2]
            loFormSet.AriaForm1.KBVendPhone.KeyTextBox.VALUE = ALLTRIM(laTemp[2])
            loFormSet.lcCompany = laTemp[3]
            loFormSet.AriaForm1.KBVendCompany.KeyTextBox.VALUE = ALLTRIM(laTemp[3])
            *Old: _CUROBJ   = OBJNUM(loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value)  &&lower&&Old CurObj
            *loFormSet.AriaForm1.kbInvNo.KeyTextBox.SetFocus()
          ELSE
            IF lcObjNum = '1'
              loFormSet.lcPhone   = loFormSet.lcOldPhone
              loFormSet.AriaForm1.KBVendPhone.KeyTextBox.VALUE = loFormSet.AriaForm1.KBVendPhone.KeyTextBox.OldValue
            ELSE
              loFormSet.lcCompany = loFormSet.lcOldComp
              loFormSet.AriaForm1.KBVendCompany.KeyTextBox.VALUE = loFormSet.AriaForm1.KBVendCompany.KeyTextBox.OldValue
            ENDIF
          ENDIF
        ELSE
          SKIP - 1
          loFormSet.lcVendor  = CVENDCODE
          loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE = ALLTRIM(CVENDCODE)  &&lower
          loFormSet.lcPhone   = CPHONENO
          loFormSet.AriaForm1.KBVendPhone.KeyTextBox.VALUE = CPHONENO
          loFormSet.lcCompany = CVENCOMP
          loFormSet.AriaForm1.KBVendCompany.KeyTextBox.VALUE = CVENCOMP
          *Old: _CUROBJ   = OBJNUM(loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value)  &&lower&&Old CurObj
          *loFormSet.AriaForm1.kbInvNo.KeyTextBox.SetFocus()
        ENDIF
      ENDIF
    ENDIF
  ELSE
    IF lcObjNum = '1'
      loFormSet.lcPhone   = loFormSet.lcOldPhone
      loFormSet.AriaForm1.KBVendPhone.KeyTextBox.VALUE = loFormSet.AriaForm1.KBVendPhone.KeyTextBox.OldValue
    ELSE
      loFormSet.lcCompany = loFormSet.lcOldComp
      loFormSet.AriaForm1.KBVendCompany.KeyTextBox.VALUE = loFormSet.AriaForm1.KBVendCompany.KeyTextBox.OldValue
    ENDIF
  ENDIF

  SET EXACT &lcSavExact

  *Old: SHOW GET loFormSet.AriaForm1.KBVendCode.KeyTextBox.Value  &&lower &&Revise
  *Old: SHOW GET ibVendor  ENABLE &&Revise
  loFormSet.AriaForm1.KBVendCode.ENABLED = .T.
  *Old: SHOW GET loFormSet.lcPhone   ENABLE &&Revise
  *Old: SHOW GET ibPhone   ENABLE &&Revise
  loFormSet.AriaForm1.KBVendPhone.ENABLED = .T.
  *Old: SHOW GET loFormSet.lcCompany ENABLE &&Revise
  *Old: SHOW GET ibCompany ENABLE &&Revise
  loFormSet.AriaForm1.KBVendCompany.ENABLED = .T.
  *Old: SHOW GET loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value  &&lower &&Revise
  *Old: SHOW GET ibInvoice ENABLE &&Revise
  loFormSet.AriaForm1.KBInvNo.ENABLED = .T.

  SELECT APVENDOR
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *SET ORDER TO &lcSavOrder
  =gfSetOrder(lcSavOrder)
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

  loFormSet.llBrowse = .F.

  *Old: =lfRefresh()
  loFormSet.REFRESH()

  SELECT APINVHDR

  *--end of lfvCompPhone

  *:********************************************************************
  *: Name      : lfGetBrHd
  *: Developer : Ahmad Shoukry Mohammed (ASM)
  *: Date      : 7/25/2004
  *: Purpose   : Return the Brows Fields and its header
  *!*************************************************************
  *! Parameters: The FormSet
  *!           : lcBrFile
  *:********************************************************************
  *: Returns            : lcBrReturn
  *:********************************************************************
FUNCTION lfGetBrHd
  PARAMETER loFormSet, lcBrFile

  PRIVATE lcBrReturn

  lcBrReturn = ''
  lcAlias = ALIAS()
  IF !USED('SYDFIELD')
    *Old: =gfOpenFile(gcSysHome+'SYDFIELD','','SH')
    =oAriaApplication.remotesystemdata.execute("SELECT * FROM sydField","", "sydField","",oAriaApplication.SystemConnectionString,3 ,"",SET("Datasession"))
  ENDIF
  IF !USED('SYDFLFLD')
    *Old: =gfOpenFile(gcSysHome+'SYDFLFLD','','SH')
    =oAriaApplication.remotesystemdata.execute("SELECT * FROM SYDFLFLD","", "SYDFLFLD","",oAriaApplication.SystemConnectionString,3 ,"",SET("Datasession"))
  ENDIF

  SELECT sydfield.cfld_name,sydfield.cfld_head FROM sydfield,sydflfld WHERE ;
    sydflfld.cfile_nam = lcBrFile AND sydfield.cfld_name = sydflfld.cfld_name ;
    ORDER BY sydflfld.nfld_pos INTO ARRAY laFldName

  IF _TALLY <> 0
    lnCount = 1
    lnMaxColm = IIF(_TALLY-10 > 29,29,_TALLY-10)
    lcBrReturn = lcBrReturn + laFldName[lnCount,1] + " :H= '" + ALLTRIM(laFldName[lnCount,2]) + "'"
    FOR lnCount = 2 TO lnMaxColm
      lcBrReturn = lcBrReturn + ", "+ laFldName[lnCount,1] + " :H= '" + ALLTRIM(laFldName[lnCount,2]) + "'"
    ENDFOR
  ENDIF
  SELECT (lcAlias)
  RETURN lcBrReturn


  *!*************************************************************
  *! Name      : lfGotFocus
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 8/1/2004
  *! Purpose   : function Called from the GotFocus event for all the editabled controls
  *!*************************************************************
  *! Parameters: The Form
  *!*************************************************************
  *! Returns   : True or False
  *!*************************************************************
FUNCTION lfGotFocus
  LPARAMETERS loForm


  IF !EMPTY(loForm.dtPostDate.TAG)
    loForm.dtPostDate.SETFOCUS()
    RETURN .F.
  ENDIF

  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *IF !EMPTY(loForm.dtInvDate.Tag)
  *loForm.dtInvDate.SetFocus()
  IF !EMPTY(loForm.pgfpayInv.pgHead.dtInvDate.TAG)
    loForm.pgfpayInv.pgHead.dtInvDate.SETFOCUS()
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    RETURN .F.
  ENDIF
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *IF !EMPTY(loForm.txtInvAmount.Tag)
  *loForm.txtInvAmount.SetFocus()
  IF !EMPTY(loForm.pgfpayInv.pgHead.txtInvAmount.TAG)
    loForm.pgfpayInv.pgHead.txtInvAmount.SETFOCUS()
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    RETURN .F.
  ENDIF

  RETURN
  *--end of lfGotFocus


  *!*************************************************************
  *! Name      : lfvPostdate
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 7/26/2004
  *! Purpose   : To Validate of the Posting Date.
  *!*************************************************************
  *! Parameters: The FormSet
  *!*************************************************************
  *! Returns   : True or False
  *!*************************************************************
FUNCTION lfvPostdate
  PARAMETERS loFormSet
  LOCAL lcFisPrd, lcFisYer, lcM

  IF !INLIST(loFormSet.ActiveMode,'A','E')
    RETURN
  ENDIF

  IF loFormSet.llLokPer .AND. loFormSet.ActiveMode="E"  &&lower

    IF loFormSet.AriaForm1.DtPostDate.VALUE <> loFormSet.AriaForm1.DtPostDate.OldValue  &&lower

      =gfModalGen("TRM04163B00000" , "DIALOG" , 'it')

      loFormSet.AriaForm1.DtPostDate.VALUE = loFormSet.AriaForm1.DtPostDate.OldValue
      *_CUROBJ    = _CUROBJ&&Old CurObj
      RETURN 0

    ELSE
      RETURN lfChkInvPostDate(loFormSet, loFormSet.AriaForm1.DtPostDate)
    ENDIF

  ENDIF



  IF loFormSet.AriaForm1.DtPostDate.VALUE = {}  &&lower

    IF gfModalGen("TRM04005B00006","DIALOG",'posting date cannot be empty') = 1
      *laScrMode    = .F.
      loFormSet.ChangeMode("S")
      loFormSet.llInvCan     = .T.
      *Old: SHOW GETS &&Revise
      * _CUROBJ      = OBJNUM(loFormSet.AriaForm1.KBVendCode.KeyTextBox.Value)  &&lower&&Old CurObj
      RETURN
    ELSE
      loFormSet.AriaForm1.DtPostDate.VALUE = loFormSet.AriaForm1.DtPostDate.OldValue
      *_CUROBJ      = _CUROBJ&&Old CurObj
      RETURN 0
    ENDIF
  ELSE
    lcFisPrd = loFormSet.lcFisPrd
    lcFisYer = loFormSet.lcFisYer
    IF lfVDtMsg(oAriaApplication.PrntCompanyID,@lcFisPrd,@lcFisYer,loFormSet.AriaForm1.DtPostDate)
      loFormSet.lcFisPrd = lcFisPrd
      loFormSet.lcFisYer = lcFisYer
      loFormSet.lcDistPrd = loFormSet.lcFisPrd
      loFormSet.lcDistYer = loFormSet.lcFisYer
      *_CUROBJ   = OBJNUM(loFormSet.AriaForm1.DtInvDate.Value)  &&lower&&Old CurObj
    ELSE
      loFormSet.AriaForm1.DtPostDate.VALUE = loFormSet.AriaForm1.DtPostDate.OldValue  &&lower
      *_CUROBJ    = _CUROBJ&&Old CurObj
      RETURN 0
    ENDIF
  ENDIF

  *Old: SHOW GET loFormSet.AriaForm1.DtPostDate.Value  &&lower &&Revise
  RETURN lfChkInvPostDate(loFormSet, loFormSet.AriaForm1.DtPostDate)
  *--end of lfvPostdate


  *!*************************************************************
  *! Name      : lfChkInvPostDate
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 7/27/2004
  *! Purpose   : To Make sure the Invoice Date is not After the Posting Date.
  *!*************************************************************
  *! Parameters: The FormSet
  *!           : The Control Being Edited
  *!*************************************************************
  *! Returns   : True or False
  *!*************************************************************
FUNCTION lfChkInvPostDate
  PARAMETERS loFormSet, loControl

  IF TYPE('APINVHDR.DPOSTDATE') = 'D'
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *  IF loFormSet.AriaForm1.DtInvDate.Value > loFormSet.AriaForm1.DtPostDate.Value  &&lower  &&lower
    IF loFormSet.AriaForm1.pgfpayInv.pgHead.DtInvDate.VALUE > loFormSet.AriaForm1.DtPostDate.VALUE  &&lower  &&lower
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      IF gfModalGen("TRM04197B04012","DIALOG","invoices|"+loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE) = 1  &&lower
        loFormSet.AriaForm1.DtPostDate.VALUE   = loFormSet.AriaForm1.DtPostDate.OldValue  &&lower
        *_CUROBJ = _CUROBJ&&Old CurObj
        *Old: SHOW GET loFormSet.AriaForm1.DtPostDate.Value  &&lower &&Revise
        RETURN 0
      ENDIF
    ENDIF
  ENDIF

  loControl.TAG=''

  RETURN 1
  *--end of lfChkInvPostDate


  *!*************************************************************
  *! Name      : lfvInvDate
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 7/26/2004
  *! Purpose   : To Validate the Invoice Date.
  *!*************************************************************
  *! Parameters: The FormSet
  *!*************************************************************
  *! Returns   : True or False
  *!*************************************************************
FUNCTION lfvInvDate
  PARAMETERS loFormSet
  LOCAL lcFisPrd, lcFisYer, lcExSin2

  IF !INLIST(loFormSet.ActiveMode,'A','E')
    RETURN
  ENDIF

  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *IF loFormSet.AriaForm1.DtInvDate.Value = {}  &&lower
  IF loFormSet.AriaForm1.pgfpayInv.pgHead.DtInvDate.VALUE = {}  &&lower
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    IF gfModalGen("TRM04005B00006","DIALOG",'date cannot be empty') = 1
      *laScrMode    = .F.
      loFormSet.ChangeMode="S"
      loFormSet.llInvCan     = .T.
      *Old: SHOW GETS &&Revise
      *_CUROBJ      = OBJNUM(loFormSet.AriaForm1.KBVendCode.KeyTextBox.Value)  &&lower&&Old CurObj
      RETURN .T.
    ELSE
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *    loFormSet.AriaForm1.DtInvDate.Value   = loFormSet.ldOldData  &&lower
      loFormSet.AriaForm1.pgfpayInv.pgHead.DtInvDate.VALUE   = loFormSet.ldOldData  &&lower
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      *_CUROBJ      = _CUROBJ&&Old CurObj
      RETURN 0
    ENDIF
  ELSE

    PRIVATE lcOldFisPd , lcOldFisYr
    lcOldFisPd = loFormSet.lcFisPrd
    lcOldFisYr = loFormSet.lcFisYer
    loFormSet.lcFisPrd = ''
    loFormSet.lcFisYer = ''

    lcFisPrd = loFormSet.lcFisPrd
    lcFisYer = loFormSet.lcFisYer
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *  =lfVDtMsg(oAriaApplication.PrntCompanyID,@lcFisPrd,@lcFisYer,loFormSet.AriaForm1.DtInvDate.Value)
    =lfVDtMsg(oAriaApplication.PrntCompanyID,@lcFisPrd,@lcFisYer,loFormSet.AriaForm1.pgfpayInv.pgHead.DtInvDate.VALUE)
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    loFormSet.lcFisPrd = lcFisPrd
    loFormSet.lcFisYer = lcFisYer


    IF !EMPTY(loFormSet.lcFisPrd) .AND. !EMPTY(loFormSet.lcFisYer)

      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *!*	    REPLACE apinvhdr.cfspprdid WITH loFormSet.lcFisPrd
      *!*	    REPLACE apinvhdr.cfisfyear WITH loFormSet.lcFisYer
      SELECT apinvhdr
      gfREPLACE("cfspprdid WITH '"+loFormSet.lcFisPrd+"'")
      gfREPLACE("cfisfyear WITH '"+loFormSet.lcFisYer+"'")
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      IF loFormSet.ActiveMode="A"  &&lower
        IF gfGetMemVar('LLMULCURR')
          PRIVATE lnCurrUnit
          lnCurrUnit = 0

          DO CASE
              *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
              *!*	          CASE loFormSet.AriaForm1.DtInvDate.Value <> loFormSet.AriaForm1.DtInvDate.OldValue ;
              *!*	               .AND. EMPTY(loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value)
              *!*	            loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value = ;
              *!*	               IIF(EMPTY(APVENDOR.CCURRCODE),oAriaApplication.BaseCurrency,APVENDOR.CCURRCODE)
              *!*	            loFormSet.AriaForm1.txtNexRate.Value = ;
              *!*	               gfChkRate('lnCurrUnit',loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value,;
              *!*	               loFormSet.AriaForm1.DtInvDate.Value,.T.)
              *REPLACE apinvhdr.ncurrunit WITH lnCurrUnit
              *!*	          CASE loFormSet.AriaForm1.DtInvDate.Value <> loFormSet.AriaForm1.DtInvDate.OldValue ;
              *!*	               .AND. !EMPTY(loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value)
              *!*	            loFormSet.AriaForm1.txtNexRate.Value = ;
              *!*	               gfChkRate('lnCurrUnit',loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value,;
              *!*	               loFormSet.AriaForm1.DtInvDate.Value,.T.)
              *REPLACE apinvhdr.ncurrunit WITH lnCurrUnit
			  *!*	          CASE EMPTY(loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value)  &&lower
              *!*	            loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value = ;
              *!*	               IIF(EMPTY(APVENDOR.CCURRCODE),oAriaApplication.BaseCurrency,APVENDOR.CCURRCODE)              
              *!*	            loFormSet.AriaForm1.txtNexRate.Value = ;
              *!*	               gfChkRate('lnCurrUnit',loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value,;
              *!*	               loFormSet.AriaForm1.DtInvDate.Value,.T.)
			  *REPLACE apinvhdr.ncurrunit WITH lnCurrUnit
            CASE loFormSet.AriaForm1.pgfpayInv.pgHead.DtInvDate.VALUE <> loFormSet.AriaForm1.pgfpayInv.pgHead.DtInvDate.OldValue ;
                .AND. EMPTY(loFormSet.AriaForm1.pgfpayInv.pgHead.kbCurrCode.KeyTextBox.VALUE)
              loFormSet.AriaForm1.pgfpayInv.pgHead.kbCurrCode.KeyTextBox.VALUE = ;
                IIF(EMPTY(APVENDOR.CCURRCODE),oAriaApplication.BaseCurrency,APVENDOR.CCURRCODE)

              
              loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.VALUE = ;
                gfChkRate('lnCurrUnit',loFormSet.AriaForm1.pgfpayInv.pgHead.kbCurrCode.KeyTextBox.VALUE,;
                loFormSet.AriaForm1.pgfpayInv.pgHead.DtInvDate.VALUE,.T.)
              
              
              gfREPLACE("ncurrunit WITH lnCurrUnit")
             
            
            CASE loFormSet.AriaForm1.pgfpayInv.pgHead.DtInvDate.VALUE <> loFormSet.AriaForm1.pgfpayInv.pgHead.DtInvDate.OldValue ;
                .AND. !EMPTY(loFormSet.AriaForm1.pgfpayInv.pgHead.kbCurrCode.KeyTextBox.VALUE)
              loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.VALUE = ;
                gfChkRate('lnCurrUnit',loFormSet.AriaForm1.pgfpayInv.pgHead.kbCurrCode.KeyTextBox.VALUE,;
                loFormSet.AriaForm1.pgfpayInv.pgHead.DtInvDate.VALUE,.T.)
             
              
              gfREPLACE("ncurrunit WITH lnCurrUnit")
             
            
            CASE EMPTY(loFormSet.AriaForm1.pgfpayInv.pgHead.kbCurrCode.KeyTextBox.VALUE)  &&lower
              loFormSet.AriaForm1.pgfpayInv.pgHead.kbCurrCode.KeyTextBox.VALUE = ;
                IIF(EMPTY(APVENDOR.CCURRCODE),oAriaApplication.BaseCurrency,APVENDOR.CCURRCODE)

            
              loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.VALUE = ;
                gfChkRate('lnCurrUnit',loFormSet.AriaForm1.pgfpayInv.pgHead.kbCurrCode.KeyTextBox.VALUE,;
                loFormSet.AriaForm1.pgfpayInv.pgHead.DtInvDate.VALUE,.T.)
             
              
              gfREPLACE("ncurrunit WITH lnCurrUnit")
              *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
          ENDCASE

          loFormSet.lcExSin2 = ' '
          lcExSin2 = loFormSet.lcExSin2

          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
          *loFormSet.lcExSin1 = gfGetExSin(@lcExSin2,loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value)  &&lower
          loFormSet.lcExSin1 = gfGetExSin(@lcExSin2,loFormSet.AriaForm1.pgfpayInv.pgHead.kbCurrCode.KeyTextBox.VALUE)  &&lower
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

          loFormSet.lcExSin2 = lcExSin2


          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
          *IF loFormSet.AriaForm1.txtNexRate.Value = 0  &&lower
          *loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value = oAriaApplication.BaseCurrency
          *loFormSet.AriaForm1.txtNexRate.Value = 1  &&lower
          *REPLACE apinvhdr.ncurrunit WITH 1  &&lower
          IF loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.VALUE = 0  &&lower
            loFormSet.AriaForm1.pgfpayInv.pgHead.kbCurrCode.KeyTextBox.VALUE = oAriaApplication.BaseCurrency
            loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.VALUE = 1  &&lower
            gfREPLACE("ncurrunit WITH 1")
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
          ENDIF
          *Old: SHOW GET loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value ENABLE  &&lower &&Revise
          
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
          *!*	        loFormSet.AriaForm1.kbCurrCode.Enabled = .T.
          *!*	        IF gfGetMemVar('LLEDITEXRA') .AND. ;
          *!*	          loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value <> oAriaApplication.BaseCurrency
          *!*	loFormSet.AriaForm1.txtNexRate.Enabled = .T.
          loFormSet.AriaForm1.pgfpayInv.pgHead.kbCurrCode.ENABLED = .T.
          IF gfGetMemVar('LLEDITEXRA') .AND. ;
              loFormSet.AriaForm1.pgfpayInv.pgHead.kbCurrCode.KeyTextBox.VALUE <> oAriaApplication.BaseCurrency
            loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.ENABLED = .T.
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
            *Old: SHOW GET loFormSet.AriaForm1.txtNexRate.Value ENABLE  &&lower &&Revise

          ELSE
            *Old: SHOW GET loFormSet.AriaForm1.txtNexRate.Value DISABLE  &&lower &&Revise
            *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
            *loFormSet.AriaForm1.txtNexRate.Enabled = .F.
            loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.ENABLED = .F.
            *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
            
          ENDIF
        ELSE
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
          *loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value = oAriaApplication.BaseCurrency  &&lower  &&lower
          *loFormSet.AriaForm1.txtNexRate.Value = 1  &&lower
          loFormSet.AriaForm1.pgfpayInv.pgHead.kbCurrCode.KeyTextBox.VALUE = oAriaApplication.BaseCurrency  &&lower  &&lower
          loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.VALUE = 1  &&lower
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

          REPLACE apinvhdr.ncurrunit WITH 1  &&lower
          *Old: SHOW GET loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value DISABLE  &&lower &&Revise
          *Old: SHOW GEt ibCurrency DISABLE &&Revise
          
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
          *loFormSet.AriaForm1.kbCurrCode.Enabled = .F.
          loFormSet.AriaForm1.pgfpayInv.pgHead.kbCurrCode.ENABLED = .F.
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
          
          *Old: SHOW GET loFormSet.AriaForm1.txtNexRate.Value DISABLE  &&lower &&Revise
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
          *loFormSet.AriaForm1.txtNexRate.Enabled = .F.
          loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.ENABLED = .F.
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
          
        ENDIF
      ELSE
        *Old: SHOW GET loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value DISABLE  &&lower &&Revise
        *Old: SHOW GEt ibCurrency DISABLE &&Revise
        
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        *loFormSet.AriaForm1.kbCurrCode.Enabled = .F.
        loFormSet.AriaForm1.pgfpayInv.pgHead.kbCurrCode.ENABLED = .F.
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
        
        *Old: SHOW GET loFormSet.AriaForm1.txtNexRate.Value DISABLE  &&lower &&Revise
        
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        *loFormSet.AriaForm1.txtNexRate.Enabled = .F.
        loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.ENABLED = .F.
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
        
      ENDIF
      *_CUROBJ    = OBJNUM(loFormSet.AriaForm1.txtInvAmount.Value)  &&lower&&Old CurObj
      *RETURN .T.

    ELSE

      loFormSet.lcFisPrd = lcOldFisPd
      loFormSet.lcFisYer = lcOldFisYr
      
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *loFormSet.AriaForm1.DtInvDate.Value = loFormSet.AriaForm1.DtInvDate.OldValue  &&lower
      loFormSet.AriaForm1.pgfpayInv.pgHead.DtInvDate.VALUE = loFormSet.AriaForm1.pgfpayInv.pgHead.DtInvDate.OldValue  &&lower
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      
      *_CUROBJ    = _CUROBJ&&Old CurObj
      RETURN 0
    ENDIF

  ENDIF

  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *IF lfChkInvPostDate(loFormSet, loFormSet.AriaForm1.DtInvDate) = 0
  IF lfChkInvPostDate(loFormSet, loFormSet.AriaForm1.pgfpayInv.pgHead.DtInvDate) = 0
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    RETURN 0
  ENDIF

  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *loFormSet.AriaForm1.dtInvDuDat.Value  = lfGetdueD(loFormSet.AriaForm1.DtInvDate.Value,loFormSet.AriaForm1.txtterdued.Value,loFormSet.lnEomDay)  &&lower  &&lower  &&lower
  *! B609614,1 MMT 06/13/2011 Fix bug of wrong AP invoice Due date[Start]
  *loFormSet.AriaForm1.pgfpayInv.pgHead.dtInvDuDat.VALUE  = lfGetdueD(loFormSet.AriaForm1.pgfpayInv.pgHead.DtInvDate.VALUE,loFormSet.AriaForm1.pgfpayInv.pgHead.txtterdued.VALUE,loFormSet.lnEomDay)  &&lower  &&lower  &&lower
  loFormSet.AriaForm1.pgfpayInv.pgHead.dtInvDuDat.VALUE  = lfGetdueD(loFormSet.AriaForm1.pgfpayInv.pgHead.DtInvDate.VALUE,loFormSet.AriaForm1.pgfpayInv.pgHead.txtterdued.VALUE,loFormSet.lnEomDay,loFormSet.lcEom)  &&lower  &&lower  &&lower)  &&lower  &&lower  &&lower
  *! B609614,1 MMT 06/13/2011 Fix bug of wrong AP invoice Due date[End]
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  *! E302623,3 MMT 01/03/2010 Convert Payable invoice screen to use SQL tables[Start]
  lfInvDtInit(loFormSet,loFormSet.ariaForm1.pgfpayInv.pgDet)
  *! E302623,3 MMT 01/03/2010 Convert Payable invoice screen to use SQL tables[End]
  *Old: SHOW GET loFormSet.AriaForm1.dtInvDuDat.Value  &&lower &&Revise
  *Old: SHOW GET loFormSet.AriaForm1.DtInvDate.Value  &&lower &&Revise

  RETURN
  *--end of lfvInvDate


  *!*************************************************************
  *! Name      : lfvInvAmount
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 7/26/2004
  *! Purpose   : Function called from the Valid of the Invoice Amount.
  *!*************************************************************
  *! Parameters: The FormSet
  *!*************************************************************
  *! Returns   : True or False
  *!*************************************************************
FUNCTION lfvInvAmount
  PARAMETERS loFormSet
  LOCAL lcExSin2, lcExpr

  IF !INLIST(loFormSet.ActiveMode,'A','E')
    RETURN
  ENDIF
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *IF loFormSet.llLokPer .AND. loFormSet.ActiveMode="E" .AND. ;
  loFormSet.AriaForm1.txtInvAmount.Value <> loFormSet.AriaForm1.txtInvAmount.OldValue
  IF loFormSet.llLokPer .AND. loFormSet.ActiveMode="E" .AND. ;
      loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.VALUE <> loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.OldValue
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  
    =gfModalGen("TRM04163B00000" , "DIALOG" , 'the invoice amount')
    
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *loFormSet.AriaForm1.txtInvAmount.Value = loFormSet.AriaForm1.txtInvAmount.OldValue
    loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.VALUE = loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.OldValue
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    
    *_CUROBJ    = _CUROBJ&&Old CurObj
    RETURN 0
  ENDIF

  
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *IF loFormSet.AriaForm1.txtInvAmount.Value = 0  &&lower
  IF loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.VALUE = 0  &&lower
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    IF loFormSet.ActiveMode="A"  &&lower

      IF gfModalGen("TRM04005B00006","DIALOG",loFormSet.lcTInvAmnt) = 1
        *_CUROBJ  = OBJNUM(loFormSet.AriaForm1.DtPostDate.Value)  &&lower&&Old CurObj
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        *!*	      STORE 'x' TO loFormSet.AriaForm1.dtPostDate.Tag, loFormSet.AriaForm1.dtInvDate.Tag, ;
        *!*	        loFormSet.AriaForm1.txtInvAmount.Tag
        STORE 'x' TO loFormSet.AriaForm1.dtPostDate.TAG, loFormSet.AriaForm1.pgfpayInv.pgHead.dtInvDate.TAG, ;
          loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.TAG
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
        RETURN -2
      ELSE
        
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        *loFormSet.AriaForm1.txtInvAmount.Value = loFormSet.AriaForm1.txtInvAmount.OldValue  &&lower
        loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.VALUE = loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.OldValue  &&lower
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
        
        *_CUROBJ    = _CUROBJ&&Old CurObj
        RETURN 0
      ENDIF
    ELSE
      =gfModalGen("TRM04072B00000","DIALOG",loFormSet.lcTInvAmnU+"|"+'0')
      
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *    loFormSet.AriaForm1.txtInvAmount.Value = loFormSet.AriaForm1.txtInvAmount.OldValue  &&lower
      loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.VALUE = loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.OldValue  &&lower
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      
      *_CUROBJ    = _CUROBJ&&Old CurObj
      RETURN 0
    ENDIF
  ELSE
    lnVenCrAvl = APVENDOR.NVENCRLIM - ROUND(APVENDOR.NVENBAL,0)
    IF loFormSet.ActiveMode="E"  &&lower
      *Old: lnVenCrAvl = lnVenCrAvl + APINVHDR.nInvAmnt
      lnVenCrAvl = lnVenCrAvl + OLDVAL('APINVHDR.nInvAmnt')
    ENDIF
    loFormSet.lcExSin2 = ' '
    lcExSin2 = loFormSet.lcExSin2
    
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *  loFormSet.lcExSin1 = gfGetExSin(@lcExSin2,loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value)  &&lower
    loFormSet.lcExSin1 = gfGetExSin(@lcExSin2,loFormSet.AriaForm1.pgfpayInv.pgHead.kbCurrCode.KeyTextBox.VALUE)  &&lower
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    
    loFormSet.lcExSin2 = lcExSin2

    *Old: IF ROUND(laData[12] &lcExSin1 laData[45] &lcExSin2 laData[48],2) > lnVenCrAvl .AND. APVENDOR.NVENCRLIM <> 0
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *!*	  lcExpr=STR(loFormSet.AriaForm1.txtInvAmount.Value,12,3)+loFormSet.lcExSin1+;
    *!*	         STR(loFormSet.AriaForm1.txtNexRate.Value,12,3)+loFormSet.lcExSin2+STR(apinvhdr.ncurrunit,12,3)
    lcExpr=STR(loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.VALUE,12,3)+loFormSet.lcExSin1+;
      STR(loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.VALUE,12,3)+loFormSet.lcExSin2+STR(apinvhdr.ncurrunit,12,3)
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    
    IF ROUND(&lcExpr,2) > lnVenCrAvl .AND. APVENDOR.NVENCRLIM <> 0

      =gfModalGen("TRM04043B00000","DIALOG",;
        ALLTRIM(STR(ROUND(&lcExpr,2) - lnVenCrAvl,15,2)))
    ENDIF

    IF loFormSet.ActiveMode="E"     && Edit Mode  &&lower
      DO CASE
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
          *CASE SIGN(loFormSet.AriaForm1.txtInvAmount.OldValue) <> SIGN(loFormSet.AriaForm1.txtInvAmount.Value)  &&lower
        CASE SIGN(loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.OldValue) <> SIGN(loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.VALUE)  &&lower
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
          
          =gfModalGen("TRM04008B00000","DIALOG")
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
          *loFormSet.AriaForm1.txtInvAmount.Value = loFormSet.AriaForm1.txtInvAmount.OldValue  &&lower
          loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.VALUE = loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.OldValue  &&lower
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
          
          *_CUROBJ    = _CUROBJ&&Old CurObj
          RETURN 0
          
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
          *!*	      CASE loFormSet.AriaForm1.txtInvAmount.OldValue > 0 AND ;
          *!*	           loFormSet.AriaForm1.txtInvAmount.Value < apinvhdr.ninvamtap + ;
          *!*	           apinvhdr.ninvdisap + apinvhdr.ninvadjap
        CASE loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.OldValue > 0 AND ;
            loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.VALUE < apinvhdr.ninvamtap + ;
            apinvhdr.ninvdisap + apinvhdr.ninvadjap
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
          =gfModalGen("TRM04009B00000","DIALOG")
          
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
          *        loFormSet.AriaForm1.txtInvAmount.Value = loFormSet.AriaForm1.txtInvAmount.OldValue
          loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.VALUE = loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.OldValue
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
          
          *_CUROBJ    = _CUROBJ&&Old CurObj
          RETURN 0

          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
          *!*	      CASE loFormSet.AriaForm1.txtInvAmount.OldValue < 0  AND ;
          *!*	           ABS(loFormSet.AriaForm1.txtInvAmount.Value) < ;
          *!*	           ABS(apinvhdr.ninvamtap + apinvhdr.ninvdisap + apinvhdr.ninvadjap)
        CASE loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.OldValue < 0  AND ;
            ABS(loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.VALUE) < ;
            ABS(apinvhdr.ninvamtap + apinvhdr.ninvdisap + apinvhdr.ninvadjap)
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
          
          =gfModalGen("TRM04009B00000","DIALOG")
          
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
          *!*	        loFormSet.AriaForm1.txtInvAmount.Value = loFormSet.AriaForm1.txtInvAmount.OldValue
          loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.VALUE = loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.OldValue
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
          
          *_CUROBJ    = _CUROBJ&&Old CurObj
          RETURN 0

          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
          *      CASE ABS(loFormSet.AriaForm1.txtInvAmount.Value) < ABS(apinvhdr.ninvpaid + apinvhdr.ninvdistk + apinvhdr.ninvadj)
        CASE ABS(loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.VALUE) < ABS(apinvhdr.ninvpaid + apinvhdr.ninvdistk + apinvhdr.ninvadj)
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
          
          =gfModalGen("TRM04010B00000","DIALOG")
          
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
          *loFormSet.AriaForm1.txtInvAmount.Value = loFormSet.AriaForm1.txtInvAmount.OldValue  &&lower
          loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.VALUE = loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.OldValue  &&lower
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
          
          *_CUROBJ    = _CUROBJ&&Old CurObj
          RETURN 0
      ENDCASE
    ELSE
      
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *!*	    IF loFormSet.ActiveMode="A" .AND. loFormSet.AriaForm1.txtInvAmount.Value < 0 .AND. ;
      *!*	       SIGN(loFormSet.AriaForm1.txtInvAmount.OldValue) <> SIGN(loFormSet.AriaForm1.txtInvAmount.Value)
      IF loFormSet.ActiveMode="A" .AND. loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.VALUE < 0 .AND. ;
          SIGN(loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.OldValue) <> SIGN(loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.VALUE)
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
        
        IF gfModalGen("TRM04006B00006","DIALOG") = 2
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
          *   loFormSet.AriaForm1.txtInvAmount.Value = 0  &&lower
          loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.VALUE = 0  &&lower
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
          
          *_CUROBJ    = _CUROBJ&&Old CurObj
          loFormSet.llDebitM  = .F.
          RETURN 0
        ELSE
          loFormSet.llDebitM  = .T.
          
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
          *!*	        IF loFormSet.AriaForm1.cboVendPmeth.Value = 'C'  &&lower
          *!*	          loFormSet.AriaForm1.cboVendPmeth.Value  = 'P'  &&lower
          *!*	          loFormSet.lcPayMethd = loFormSet.laPayMethd[AT(loFormSet.AriaForm1.cboVendPmeth.Value,'PMNCH'),1]  &&lower
          IF loFormSet.AriaForm1.pgfpayInv.pgHead.cboVendPmeth.VALUE = 'C'  &&lower
            loFormSet.AriaForm1.pgfpayInv.pgHead.cboVendPmeth.VALUE  = 'P'  &&lower
            loFormSet.lcPayMethd = loFormSet.laPayMethd[AT(loFormSet.AriaForm1.pgfpayInv.pgHead.cboVendPmeth.Value,'PMNCH'),1]  &&lower
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
            *Old: SHOW GET pbApprove,1 PROMPT '\<Approve for payment...' &&Revise
            *loFormSet.AriaForm1.cmdApprove.Caption = '\<Approve for payment...'
            *=lfRefresh()
          ENDIF
        ENDIF
      ENDIF
    ENDIF

    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *!*	  IF ABS(loFormSet.AriaForm1.txtInvAmount.Value) < ;
    *!*	     ABS(apinvhdr.ninvamtap + apinvhdr.ninvdisap + ;
    *!*	     apinvhdr.ninvadjap) .AND. loFormSet.AriaForm1.cboVendPmeth.Value <> 'C'
    IF ABS(loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.VALUE) < ;
        ABS(apinvhdr.ninvamtap + apinvhdr.ninvdisap + ;
        apinvhdr.ninvadjap) .AND. loFormSet.AriaForm1.pgfpayInv.pgHead.cboVendPmeth.VALUE <> 'C'
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    
      =gfModalGen("TRM04009B00000","DIALOG")
      
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *    loFormSet.AriaForm1.txtInvAmount.Value = loFormSet.AriaForm1.txtInvAmount.OldValue
      loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.VALUE = loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.OldValue
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      
      *_CUROBJ    = _CUROBJ&&Old CurObj
      RETURN 0
    ENDIF
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *!*	  IF loFormSet.AriaForm1.txtInvAmount.Value-apinvhdr.ninvpaid-apinvhdr.ninvdistk = 0 .AND. ;
    *!*	     loFormSet.AriaForm1.cboVendPmeth.Value <> 'C'
    IF loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.VALUE-apinvhdr.ninvpaid-apinvhdr.ninvdistk = 0 .AND. ;
        loFormSet.AriaForm1.pgfpayInv.pgHead.cboVendPmeth.VALUE <> 'C'
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      
      loFormSet.lcAprStat = 'DISABLE'
      *Old: SHOW GET pbApprove &loFormSet.lcAprStat &&Revise
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *    loFormSet.AriaForm1.cmdApprove.Enabled = (loFormSet.lcAprStat='ENABLE')
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    ELSE
      loFormSet.lcAprStat = 'ENABLE'
      *Old: SHOW GET pbApprove &loFormSet.lcAprStat &&Revise
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *loFormSet.AriaForm1.cmdApprove.Enabled = (loFormSet.lcAprStat='ENABLE')
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    ENDIF
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *!*	  IF loFormSet.AriaForm1.txtInvAmount.Value > 0  &&lower
    *!*	    IF loFormSet.AriaForm1.txtInvAmount.Value <> loFormSet.AriaForm1.txtInvAmount.OldValue .OR. ;
    *!*	       loFormSet.AriaForm1.txtInvDisof.Value = 0
    *!*	      loFormSet.AriaForm1.txtInvDisof.Value = (loFormSet.AriaForm1.txtTerDiscr.Value * loFormSet.AriaForm1.txtInvAmount.Value) / 100
    IF loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.VALUE > 0  &&lower
      IF loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.VALUE <> loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.OldValue .OR. ;
          loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvDisof.VALUE = 0
        loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvDisof.VALUE = (loFormSet.AriaForm1.pgfpayInv.pgHead.txtTerDiscr.VALUE * loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.VALUE) / 100
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      ENDIF
      *Old: SHOW GET pbDiscount ENABLE &&Revise
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *loFormSet.AriaForm1.cmdDiscount.Enabled = .T.
      loFormSet.AriaForm1.pgfpayInv.pgHead.cmdDiscount.ENABLED = .T.
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      *Old: SHOW GET loFormSet.AriaForm1.txtInvDisof.Value ENABLE  &&lower &&Revise
      
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *loFormSet.AriaForm1.txtInvDisof.Enabled = .T.
      loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvDisof.ENABLED = .T.
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      
    ELSE
    
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *loFormSet.AriaForm1.txtInvDisof.Value = 0  &&lower
      loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvDisof.VALUE = 0  &&lower
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      
      *Old: SHOW GET pbDiscount DISABLE &&Revise
      
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *loFormSet.AriaForm1.cmdDiscount.Enabled = .F.
      loFormSet.AriaForm1.pgfpayInv.pgHead.cmdDiscount.ENABLED = .F.
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      
      *Old: SHOW GET loFormSet.AriaForm1.txtInvDisof.Value DISABLE  &&lower &&Revise
      
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *loFormSet.AriaForm1.txtInvDisof.Enabled = .F.
      loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvDisof.ENABLED = .F.
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      
    ENDIF
    *Old: SHOW GET loFormSet.AriaForm1.txtInvAmount.Value  &&lower &&Revise
  ENDIF
  
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	IF loFormSet.AriaForm1.txtInvAmount.Value = 0 .AND. ;
  *!*	   (loFormSet.ActiveMode="A" .OR. loFormSet.ActiveMode="S")
  IF loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.VALUE = 0 .AND. ;
      (loFormSet.ActiveMode="A" .OR. loFormSet.ActiveMode="S")
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    
    loFormSet.lcDistStat = 'DISABLE'
    *Old: SHOW GET pbDisLine DISABLE &&Revise
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *loFormSet.AriaForm1.cmdDisLine.Enabled = (loFormSet.lcDistStat='ENABLE')
    loFormSet.AriaForm1.pgfpayInv.pgDist.ENABLED = (loFormSet.lcDistStat='ENABLE')
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    
  ELSE
    loFormSet.lcDistStat = 'ENABLE'
    *Old: SHOW GET pbDisLine ENABLE &&Revise
    
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *loFormSet.AriaForm1.cmdDisLine.Enabled = (loFormSet.lcDistStat='ENABLE')
    loFormSet.AriaForm1.pgfpayInv.pgDist.ENABLED = (loFormSet.lcDistStat='ENABLE')
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    
  ENDIF
  
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *IF loFormSet.AriaForm1.txtInvAmount.Value <> loFormSet.AriaForm1.txtInvAmount.OldValue
  IF loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.VALUE <> loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.OldValue
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    SELECT(loFormSet.lcTmpDist)
    DO CASE
      CASE loFormSet.ActiveMode="A"
        IF RECCOUNT() > 0
          LOCATE FOR CAPDACTID = 'A'
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
          *REPLACE NAPDAMNT  WITH -loFormSet.AriaForm1.txtInvAmount.Value  &&lower
          REPLACE NAPDAMNT  WITH -loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.VALUE  &&lower
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
        ENDIF

      CASE loFormSet.ActiveMode="E"
        LOCATE FOR CAPDACTID = 'A' .AND. EMPTY(CAPDSTAT)
        lnSavApRec = RECNO()
        IF CSTATUS = 'A'
          SCATTER MEMVAR MEMO
          m.cStatus  = 'A'
          m.cApdStat = ' '
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
          *m.nApdAmnt = -loFormSet.AriaForm1.txtInvAmount.Value  &&lower
          m.nApdAmnt = -loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.VALUE  &&lower
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
          m.lAPDPost = .F.
          m.cBatchNo = ' '
          m.cTrnSledn= ' '
          m.cAPSessNo= loFormSet.lcSequence

          m.nEntryNo = 0

          GATHER MEMVAR MEMO
        ELSE

          REPLACE CAPDSTAT  WITH 'V'        ,;
            CSTATUS   WITH 'M'
          SCATTER MEMVAR MEMO
          m.nApdAmnt = -1 * m.nApdAmnt
          m.cStatus  = 'A'
          m.lAPDPost = .F.
          m.cBatchNo = ' '
          m.cTrnSledn= ' '
          m.nEqvAmnt = -1 * m.nEqvAmnt
          m.CAPSESSNO = loFormSet.lcSequence

          m.nEntryNo = 0

          APPEND BLANK
          GATHER MEMVAR MEMO

          IF BETWEEN(lnSavApRec,0,RECCOUNT())
            GO lnSavApRec
          ENDIF

          SCATTER MEMVAR MEMO
          m.cStatus  = 'A'
          m.cApdStat = ' '
          
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
          *m.nApdAmnt = -loFormSet.AriaForm1.txtInvAmount.Value  &&lower
          m.nApdAmnt = -loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.VALUE  &&lower
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
          m.lAPDPost = .F.
          m.cBatchNo = ' '
          m.cTrnSledn= ' '
          m.cAPSessNo= loFormSet.lcSequence

          m.nEntryNo = 0

          APPEND BLANK
          GATHER MEMVAR MEMO
        ENDIF
    ENDCASE
    SELECT apinvhdr
  ENDIF

  *IF loFormSet.AriaForm1.txtInvAmount.Value <> loFormSet.lnOldAmnt .AND. WVISIBLE('CWRAPDISTR')
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *IF loFormSet.AriaForm1.txtInvAmount.Value <> loFormSet.AriaForm1.txtInvAmount.OldValue .AND. loFormSet.DistLines.Visible
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    
    *=gfChClose('CWRAPDISTR')
    
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *loFormSet.DistLines.Visible = .F.
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  *ENDIF
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *IF loFormSet.AriaForm1.txtInvAmount.Value > 0  &&lower
  IF loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.VALUE > 0  &&lower
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    loFormSet.llDebitM  = .F.
  ELSE
    loFormSet.llDebitM  = .T.
  ENDIF
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *loFormSet.AriaForm1.txtInvAmount.Tag=''
  loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.TAG=''
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  RETURN 1
  *--end of lfvInvAmount


  *!*************************************************************
  *! Name      : lfvInvDisof
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 7/26/2004
  *! Purpose   : To Validate the Invoice Discount.
  *!*************************************************************
  *! Parameters: The FormSet
  *!*************************************************************
  *! Returns   : True or False
  *!*************************************************************
FUNCTION lfvInvDisof
  PARAMETERS loFormSet

  IF !INLIST(loFormSet.ActiveMode,'A','E')
    RETURN
  ENDIF

  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	IF loFormSet.AriaForm1.txtInvDisof.Value < 0  &&lower
  *!*	  loFormSet.AriaForm1.txtInvDisof.Value = loFormSet.AriaForm1.txtInvDisof.OldValue  &&lower
  IF loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvDisof.VALUE < 0  &&lower
    loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvDisof.VALUE = loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvDisof.OldValue  &&lower
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    
    *Old: SHOW GET loFormSet.AriaForm1.txtInvDisof.Value  &&lower &&Revise
    RETURN
  ENDIF
  
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *IF loFormSet.AriaForm1.txtInvDisof.Value > loFormSet.AriaForm1.txtInvAmount.Value  &&lower  &&lower
  IF loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvDisof.VALUE > loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.VALUE  &&lower  &&lower
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  
    =gfModalGen("TRM04011B00000","DIALOG")
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *!*	  loFormSet.AriaForm1.txtInvDisof.Value = ;
    *!*	     IIF(loFormSet.AriaForm1.txtInvDisof.OldValue > 0,loFormSet.AriaForm1.txtInvDisof.Value,0)
    *! E302623,3 MMT 01/03/2010 Convert Payable invoice screen to use SQL tables[Start]
*!*	    loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvDisof.VALUE = ;
*!*	      IIF(loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvDisof.OldValue > 0,loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvDisof.VALUE,0)
    loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvDisof.VALUE = ;
      IIF(loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvDisof.OldValue > 0,loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvDisof.OldValue ,0)
    *! E302623,3 MMT 01/03/2010 Convert Payable invoice screen to use SQL tables[End]
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  ENDIF

  *Old: SHOW GET loFormSet.AriaForm1.txtInvDisof.Value  &&lower &&Revise

  RETURN
  *--end of lfvInvDisof



  *!*************************************************************
  *! Name      : lfvTermCode
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 7/26/2004
  *! Purpose   : Function called from the Valid of the Terms.
  *!*************************************************************
  *! Parameters: The FormSet
  *!*************************************************************
  *! Returns   : True or False
  *!*************************************************************
FUNCTION lfvTermCode
  PARAMETERS loFormSet

  IF !INLIST(loFormSet.ActiveMode,'A','E')
    RETURN
  ENDIF

  *B128399,1 KHM 06/15/2005 Check if last key is down or up arrow do not change the value [Begin]
  IF LASTKEY() = 24 OR LASTKEY() = 5 && 24 = Down Arrow and 5 = Up Arrow
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    * loFormSet.AriaForm1.cboTermCode.Value = loFormSet.AriaForm1.cboTermCode.OldValue
    loFormSet.AriaForm1.pgfpayInv.pgHead.cboTermCode.VALUE = loFormSet.AriaForm1.pgfpayInv.pgHead.cboTermCode.OldValue
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    RETURN 1
  ENDIF
  *B128399,1 KHM 06/15/2005 [End]


  *DO CASE
  *CASE _DOS
  *loFormSet.AriaForm1.cboTermCode.Value  =gfActPop(5,1,12,34,'SYCCODES','cCode_No','cDiscrep',@loFormSet.lcTermCode)  &&lower
  *CASE _WINDOWS

  loFormSet.lcPuTerm   = CODES.cdiscrep
  *loFormSet.AriaForm1.cboTermCode.Value = CODES.cCode_No  &&lower

  *Old: SHOW GET loFormSet.lcPuTerm &&Revise
  *ENDCASE

  IF LASTKEY() <> 27  && ESC

    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *!*	  DIMENSION laAry[ALEN(loFormSet.laTermAry,1),ALEN(loFormSet.laTermAry,2)]
    *!*	  =ACOPY(loFormSet.laTermAry,laAry)
    *!*	  =gfRltFld(loFormSet.AriaForm1.cboTermCode.Value , @laAry , 'CTERMCODE')
    *!*	  DIMENSION loFormSet.laTermAry[ALEN(laAry,1),ALEN(laAry,2)]
    *!*	  =ACOPY(laAry,loFormSet.laTermAry)
    DIMENSION laArray[ALEN(loFormSet.laTermAry,1),ALEN(loFormSet.laTermAry,2)]
    =ACOPY(loFormSet.laTermAry,laArray)
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    
    * =gfRltFld(loFormSet.AriaForm1.cboTermCode.Value , @laArray, 'CTERMCODE')
    =gfRltFld(loFormSet.AriaForm1.pgfpayInv.pgHead.cboTermCode.VALUE , @laArray, 'CTERMCODE')
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *  loFormSet.lcTermsDisp = IIF(EMPTY(loFormSet.AriaForm1.cboTermCode.Value),'ENABLE','DISABLE')  &&lower
     *loFormSet.AriaForm1.dtInvDuDat.Value  = lfGetdueD(loFormSet.AriaForm1.DtInvDate.Value,loFormSet.AriaForm1.txtterdued.Value,loFormSet.lnEomDay)  &&lower  &&lower  &&lower
    *!*	    IF loFormSet.AriaForm1.txtInvAmount.Value > 0
    *!*	    loFormSet.AriaForm1.txtInvAmount.OldValue = ;
    *!*	      IIF(TYPE('loFormSet.AriaForm1.txtInvAmount.OldValue')<>'N',;
    *!*	          loFormSet.AriaForm1.txtInvAmount.Value,loFormSet.AriaForm1.txtInvAmount.OldValue)
    *!*	    IF loFormSet.AriaForm1.txtInvAmount.Value <> loFormSet.AriaForm1.txtInvAmount.OldValue
    *!*	      loFormSet.AriaForm1.txtInvDisof.Value = (loFormSet.AriaForm1.txtTerDiscr.Value * loFormSet.AriaForm1.txtInvAmount.Value) / 100
    DIMENSION loFormSet.laTermAry[ALEN(laArray,1),ALEN(laArray,2)]
    =ACOPY(laArray,loFormSet.laTermAry)
    loFormSet.lcTermsDisp = IIF(EMPTY(loFormSet.AriaForm1.pgfpayInv.pgHead.cboTermCode.VALUE),'ENABLE','DISABLE')  &&lower
    *B609614,1 TMI [START]
    *loFormSet.AriaForm1.pgfpayInv.pgHead.dtInvDuDat.VALUE  = lfGetdueD(loFormSet.AriaForm1.pgfpayInv.pgHead.DtInvDate.VALUE,loFormSet.AriaForm1.pgfpayInv.pgHead.txtterdued.VALUE,loFormSet.lnEomDay)  &&lower  &&lower  &&lower
    loFormSet.AriaForm1.pgfpayInv.pgHead.dtInvDuDat.VALUE  = lfGetdueD(loFormSet.AriaForm1.pgfpayInv.pgHead.DtInvDate.VALUE,loFormSet.AriaForm1.pgfpayInv.pgHead.txtterdued.VALUE,loFormSet.lnEomDay,loFormSet.lcEom)  &&lower  &&lower  &&lower
    *B609614,1 TMI [END]
    IF loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.VALUE > 0
      loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.OldValue = ;
        IIF(TYPE('loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.OldValue')<>'N',;
        loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.VALUE,loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.OldValue)
      IF loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.VALUE <> loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.OldValue
        loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvDisof.VALUE = (loFormSet.AriaForm1.pgfpayInv.pgHead.txtTerDiscr.VALUE * loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.VALUE) / 100
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      ENDIF
    ENDIF

    *Old: SHOW GET loFormSet.AriaForm1.txtTerDiscr.Value &loFormSet.lcTermsDisp  &&lower &&Revise
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *!*	  loFormSet.AriaForm1.txtTerDiscr.Enabled = (loFormSet.lcTermsDisp='ENABLE')
    *!*	  *Old: SHOW GET loFormSet.AriaForm1.txtterdued.Value &loFormSet.lcTermsDisp  &&lower &&Revise
    *!*	  loFormSet.AriaForm1.txtterdued.Enabled = (loFormSet.lcTermsDisp='ENABLE')
    *!*	  *Old: SHOW GET loFormSet.AriaForm1.txtTerDiscd.Value &loFormSet.lcTermsDisp  &&lower &&Revise
    *!*	  loFormSet.AriaForm1.txtTerDiscd.Enabled = (loFormSet.lcTermsDisp='ENABLE')
    loFormSet.AriaForm1.pgfpayInv.pgHead.txtTerDiscr.ENABLED = (loFormSet.lcTermsDisp='ENABLE')
    *Old: SHOW GET loFormSet.AriaForm1.txtterdued.Value &loFormSet.lcTermsDisp  &&lower &&Revise
    loFormSet.AriaForm1.pgfpayInv.pgHead.txtterdued.ENABLED = (loFormSet.lcTermsDisp='ENABLE')
    *Old: SHOW GET loFormSet.AriaForm1.txtTerDiscd.Value &loFormSet.lcTermsDisp  &&lower &&Revise
    loFormSet.AriaForm1.pgfpayInv.pgHead.txtTerDiscd.ENABLED = (loFormSet.lcTermsDisp='ENABLE')
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    *Old: SHOW GET loFormSet.AriaForm1.dtInvDuDat.Value  &&lower &&Revise

    *=gfUpdate()
    *=lfRefresh() && refresh says filed on the screen
  ENDIF

  SELECT APINVHDR

  *IF _WINDOWS
  *DEACTIVATE POPUP puTermDes
  *ENDIF

  RETURN 1
  *--end of lfvTermCode


  *!*************************************************************
  *! Name      : lfvDivision
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 7/26/2004
  *! Purpose   : Function called from the Valid of the Divisions.
  *!*************************************************************
  *! Parameters: The FormSet
  *!*************************************************************
  *! Returns   : True or False
  *!*************************************************************
FUNCTION lfvDivision
  PARAMETERS loFormSet

  IF !INLIST(loFormSet.ActiveMode,'A','E')
    RETURN
  ENDIF

  *B128399,1 KHM 06/15/2005 Check if last key is down or up arrow do not change the value [Begin]
  IF LASTKEY() = 24 OR LASTKEY() = 5 && 24 = Down Arrow and 5 = Up Arrow
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *loFormSet.AriaForm1.cboDivision.Value = loFormSet.AriaForm1.cboDivision.OldValue
    loFormSet.AriaForm1.pgfpayInv.pgHead.cboDivision.VALUE = loFormSet.AriaForm1.pgfpayInv.pgHead.cboDivision.OldValue
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    RETURN 1
  ENDIF
  *B128399,1 KHM 06/15/2005 [End]

  *DO CASE
  *CASE _DOS
  *loFormSet.AriaForm1.cboDivision.Value = gfActPop(7,1,13,34,'SYCCODES','cCode_No','cDiscrep',@loFormSet.lcDivision)  &&lower

  *CASE _WINDOWS

  loFormSet.lcPuDiv   = CODES.cdiscrep
  *loFormSet.AriaForm1.cboDivision.Value = CODES.cCode_No  &&lower

  *Old: SHOW GET loFormSet.lcPuDiv &&Revise
  *=gfUpdate()
  *ENDCASE

  *IF _WINDOWS
  *DEACTIVATE POPUP puDivision
  *ENDIF

  *=lfRefresh()    && refresh says filed on the screen

  RETURN 1
  *--end of lfvDivision


  *!*************************************************************
  *! Name      : lfVlDate
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 7/26/2004
  *! Purpose   : To Validate dates from the periods file.
  *!*************************************************************
  *! Parameters: The company that you want to validate from its periods.
  *!           : Logical parameter to accept the date in a locked period.
  *!*************************************************************
  *! Returns   : True or False
  *!*************************************************************
FUNCTION lfVlDate
  PARAMETERS lcCompany, lcCrPrd, lcCrYer, ldDateTVal, llLockPer
  LOCAL ap1

  PRIVATE llOpenPrd, lcSavOrdPr, llValidDate, lcExactStat

  IF TYPE('lcCurYear') <> 'C' .AND. TYPE('lcCurPrd') <> 'C'
    PRIVATE lcCurYear, lcCurPrd, lLockStat

    lcCrYer    = IIF(TYPE('lcCrYer') <> 'C',' ',lcCrYer)

    lcCrPrd    = IIF(TYPE('lcCrPrd') <> 'C',' ',lcCrPrd)
  ENDIF

  llLockPer  = IIF(llLockPer,llLockPer,.F.)

  llValidDate= .F.      && Variable to return with from the function.

  lcCurYear  = ' '      && Variable to hold the current year.
  lcCurPrd   = ' '      && Varibale to hold the current period.
  lcExactStat= ' '      && Variable to hold the SET EXACT status.
  lLockStat  = .F.      && Variable to hold the lock stat of the record.

  lcSavSelct = ALIAS()  && Variable to save the currently selected file.

  llOpenPrd  = .F.      && Variable to indicate that the there is a file;
                        && OPEN BY the FUNCTION.

  ap1 = CREATEOBJECT("ap")

  *PRIVATE llOpAPS, llOpcomp

  *llOpcomp = gfOpenFile(oAriaApplication.SysPath+'SYCCOMP','Ccomp_id','SH')  &&lower
  *llOpAPS  = gfOpenFile(oAriaApplication.DataDir+'APSETUP','','SH')  &&lower

  lcCompany  = IIF(TYPE('lcCompany') <> 'C',APSETUP.CAPSGLCOM,lcCompany)

  lcCompYer  = oAriaApplication.CurrentYear
  lcCompPrd  = oAriaApplication.CurrentPeriod



  lcCompany  = IIF(TYPE('lcCompany') <> 'C',APSETUP.CAPSGLCOM,lcCompany)


  lcCompYer  = oAriaApplication.CurrentYear
  lcCompPrd  = oAriaApplication.CurrentPeriod

  IF !USED('FSPRD')   && Check if the period file is open or not.
    llOpenPrd = .T.      && Indicates that the file is open by the function.
    SELECT 0             && Select an empty work area.
    *lcDataDir = ALLTRIM(IIF(SEEK(oAriaApplication.PrntCompanyID, 'SYCCOMP'), gfGetDataDir(ALLT(SYCCOMP.cCom_DDir)), oAriaApplication.DataDir))  &&lower  &&lower
    lcdatadir = ap1.lcDataDir
    
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *USE &lcDataDir.fsprd ORDER TAG COMFYRPRDI
    =gfOpenTable('fsprd','COMFYRPRDI','SH')
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    
  ELSE
    SELECT FSPRD      && The file is open so we are going to select
    
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *!*	  lcSavOrdPr = SYS(22) && Save the file order
    *!*	  SET ORDER TO TAG COMFYRPRDI   && Change the order
    lcSavOrdPr = ORDER() && Save the file order
    =gfSetOrder('COMFYRPRDI')
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  ENDIF
  *IF USED('SYCCOMP') .AND. llOpcomp
  *=gfCloseFile('SYCCOMP')
  *ENDIF
  *IF USED('APSETUP') .AND. llOpAPS
  *=gfCloseFile('APSETUP')
  *ENDIF

  IF TYPE('ldDateTVal') <> 'D'
    ldDate = IIF(TYPE('_screen.ActiveForm.ActiveControl.Value')='D',_SCREEN.ACTIVEFORM.ACTIVECONTROL.VALUE,{})
  ELSE
    ldDate = ldDateTVal
  ENDIF
  *ldDate = ldDateTVal

  lcExactStat = SET('EXACT')
  SET EXACT OFF
  GO TOP

  SET EXACT &lcExactStat


  LOCATE REST FOR BETWEEN(ldDate,dfsppbgdt,dfsppendt)
  IF FOUND() .AND. BETWEEN(ldDate,ap1.ldPyBgDate,ap1.ldNyEnDate)

    llLockStat = lFspLocks  && Assign the variable with the period lock stat.
    lcCurYear  = cFisFYear  && Assign the variable with fiscal year of the period.
    lcCurPrd   = cFspprdid  && Assign the variable with the period no.
    lcCrYer    = cFisFYear  && Assign the variable with fiscal year of the period.
    lcCrPrd    = cFspprdid  && Assign the variable with the period no.
    llLockPer  = lFspLocks  && Assign the variable with the period lock stat.
    llValidDate= .T.        && Assign the variable with .T.

    IF USED('FSPRD') .AND. llOpenPrd
      llOpenPrd = .F.
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *USE IN FSPRD
      =gfCloseTable('FSPRD')
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[END]
    ELSE
      SELECT FSPRD
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *SET ORDER TO &lcSavOrdPr
      =gfSetOrder(lcSavOrdPr)
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    ENDIF

    IF !EMPTY(lcSavSelct)
      SELECT(lcSavSelct)
    ENDIF
  ELSE
    IF USED('FSPRD') .AND. llOpenPrd
      llOpenPrd = .F.
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *USE IN FSPRD
      =gfCloseTable('FSPRD')
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    ELSE
      SELECT FSPRD
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *SET ORDER TO &lcSavOrdPr
      =gfSetOrder(lcSavOrdPr)
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    ENDIF

    IF !EMPTY(lcSavSelct)
      SELECT(lcSavSelct)
    ENDIF
  ENDIF

  RETURN llValidDate

  *--end of lfVlDate


  *!*************************************************************
  *! Name      : lfVDtMsg
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 7/26/2004
  *! Purpose   : Validation function for date by giving messages.
  *!*************************************************************
  *! Parameters: The company that you want to validate from its periods.
  *!           : Logical parameter to accept the date in a locked period.
  *!*************************************************************
  *! Returns   : True or False
  *!*************************************************************
FUNCTION lfVDtMsg
  PARAMETERS lcCompany, lcCrPrd, lcCrYer, ldDateTVal, llLockPer


  PRIVATE llLockStat, lcCompYer, lcCompPrd
  PRIVATE lnYear, lcYerPer, lcMessage, lcMessgSel
  PRIVATE lcCurYear, lcCurPrd, llVaildDate

  lcCompYer  = ' '   && Variable to hlod the current year of the company.
  lcCompPrd  = ' '   && Variable to hlod the current period of the company.

  lcCurYear  = ' '
  lcCurPrd   = ' '

  llVaildDate= .F.   && Variable to indicate if the date is valid or not

  lcCrYer    = IIF(TYPE('lcCrYer') <> 'C',' ',lcCrYer)

  lcCrPrd    = IIF(TYPE('lcCrPrd') <> 'C',' ',lcCrPrd)

  llLockPer  = IIF(llLockPer,llLockPer,.F.)

  lnYear     = 0     && Variable to hold the year No.

  llLockStat = .F.   && Variable to hold the lock stat of the period.

  ldDateTVal = IIF(TYPE('ldDateTVal')='O',ldDateTVal.Text1.VALUE,ldDateTVal)

  IF lfVlDate(lcCompany,lcCrPrd,lcCrYer,ldDateTVal)  && Call the date validation function.

    lcCrPrd  = lcCurPrd
    lcCrYer  = lcCurYear
    lcYerPer = lcCurPrd+'-'+lcCurYear


    lnYear   = (INT(VAL(lcCurYear))-INT(VAL(lcCompYer))) + 3


    lnYear   = IIF(lnYear <= 0,1,lnYear)

    IF lnYear = 3
      lnYear  = lnYear + SIGN(VAL(lcCrPrd) - VAL(oAriaApplication.CurrentPeriod))
    ENDIF  && End Period Validation

    DO CASE
      CASE llLockStat


        =gfModalGen("TRM00134B00000","DIALOG",lcYerPer)
        llVaildDate = .F.

      CASE lnYear > 0

        lcMessage  = 'history prior   current  future  '

        lcMessgSel = ALLTRIM(SUBSTR(lcMessage,(lnYear*8)-7,8))


        IF lnYear <> 3
          =gfModalGen("TRM00136B00000","DIALOG",lcMessgSel+"|"+lcYerPer)
        ENDIF

        IF lnYear = 1   && If the year = 1 we are not going to accept.
          llVaildDate = .F.
        ELSE
          llVaildDate = .T.
        ENDIF
    ENDCASE
  ELSE

    =gfModalGen("TRM00133B00000","DIALOG")

    llVaildDate = .F.
  ENDIF

  RETURN llVaildDate

  *--end of lfVDtMsg


  *!*************************************************************
  *! Name      : lfGetdueD
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 7/26/2004
  *! Purpose   : Return the Due Date
  *!*************************************************************
  *! Parameters: ldDueDay,lnMonthDays,lnAddDays,lnDiffDays
  *!*************************************************************
  *! Returns   : ldDueDay
  *!*************************************************************

FUNCTION lfGetdueD
*! B609614,1 MMT 06/13/2011 Fix bug of wrong AP invoice Due date[Start]
*PARAMETER ldInvDate, lnDueDays, lnEOM
*PRIVATE ldDueDay, lnMonthDays, lnAddDays, lnDiffDays
PARAMETER ldInvDate, lnDueDays, lnEOM,lcEom
lnEOM = IIF(TYPE('lnEOM') <> 'N' .OR. lnEOM= 0,20,lnEOM -1)
ldDueDate = IIF(lcEom<> 'Y',ldInvDate+ lnDueDays,;
                  GOMONTH(CTOD(SUBSTR(DTOC(ldInvDate),1,3) +'10'+;
                  SUBSTR(DTOC(ldInvDate),6,5)),IIF(DAY(ldInvDate)>lnEOM,2,1))+lnDueDays)
RETURN ldDueDate 
*! B609614,1 MMT 06/13/2011 Fix bug of wrong AP invoice Due date[End]

  lnDiffDays = 0

  IF lnEOM > 0
    DO CASE
      CASE INLIST(ALLTRIM(STR(MONTH(ldInvDate))),'01','03','05','07','08','10','12')
        lnMonthDays = 31
      CASE INLIST(ALLTRIM(STR(MONTH(ldInvDate))),'04','06','09','11')
        lnMonthDays = 30
      OTHERWISE
        lnMonthDays = IIF(MOD(YEAR(ldInvDate),4)=0,29,28)
        lnDiffDays = lnEOM - lnMonthDays
    ENDCASE
    lnAddDays = IIF(DAY(ldInvDate)>lnEOM,lnMonthDays - DAY(ldInvDate),lnEOM-DAY(ldInvDate))
  ELSE
    lnAddDays = 0
  ENDIF

  ldDueDay = ldInvDate + lnDueDays + lnAddDays - lnDiffDays

  RETURN ldDueDay

  *--end of lfGetdueD



  ***xxx***


  *!*************************************************************
  *! Name      : lfvRemit
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 7/29/2004
  *! Purpose   : To Validate The RemitTo ComboBox.
  *!*************************************************************
  *! Parameters: loFormSet, llJustShow
  *!*************************************************************
  *! Returns   : None
  *!*************************************************************
FUNCTION lfvRemit
  PARAMETERS loFormSet, llJustShow
  PRIVATE lcRemitStat, lcRemitTo

  IF !INLIST(loFormSet.ActiveMode,'A','E')
    RETURN
  ENDIF


  *** Default factor for the vendor
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	loFormSet.AriaForm1.kbFacCode.KeyTextBox.Value = ;
  *!*	   IIF(EMPTY(loFormSet.AriaForm1.kbFacCode.KeyTextBox.Value), APVENDOR.cFacCode, ;
  *!*	       loFormSet.AriaForm1.kbFacCode.KeyTextBox.Value)
  *!*	DIMENSION laAry[6]
  *!*	laAry[1]=loFormSet.AriaForm1.txtOutComp.Value
  *!*	laAry[2]=apinvhdr.coutaddr1
  *!*	laAry[3]=apinvhdr.coutaddr2
  *!*	laAry[4]=apinvhdr.coutaddr3
  *!*	laAry[5]=apinvhdr.coutaddr4
  *!*	laAry[6]=apinvhdr.coutaddr5

  loFormSet.AriaForm1.pgfpayInv.pgHead.kbFacCode.KeyTextBox.VALUE = ;
    IIF(EMPTY(loFormSet.AriaForm1.pgfpayInv.pgHead.kbFacCode.KeyTextBox.VALUE), APVENDOR.cFacCode, ;
    loFormSet.AriaForm1.pgfpayInv.pgHead.kbFacCode.KeyTextBox.VALUE)
  
  DIMENSION laArray[6]
  laArray[1]=loFormSet.AriaForm1.pgfpayInv.pgHead.txtOutComp.VALUE
  laArray[2]=apinvhdr.coutaddr1
  laArray[3]=apinvhdr.coutaddr2
  laArray[4]=apinvhdr.coutaddr3
  laArray[5]=apinvhdr.coutaddr4
  laArray[6]=apinvhdr.coutaddr5
   *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

  lcRemitStat = loFormSet.lcRemitStat
  lcRemitTo = loFormSet.lcRemitTo
  DIMENSION laRemitTo[ALEN(loFormSet.laRemitTo,1),ALEN(loFormSet.laRemitTo,2)]
  =ACOPY(loFormSet.laRemitTo,laRemitTo)

   *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	loFormSet.AriaForm1.cboInvRemit.Value  = ;
  *!*	  gfRemit(loFormSet.AriaForm1.cboInvRemit.Value, !llJustShow, ;
  *!*	          loFormSet.AriaForm1.KBVendCode.KeyTextBox.Value, ;
  *!*	          loFormSet.AriaForm1.kbFacCode.KeyTextBox.Value, @lcRemitStat, ;
  *!*	          'laAry[1]','laAry[2]','laAry[3]','laAry[4]','laAry[5]','laAry[6]',;
  *!*	          3, 40, 'laRemitTo', @lcRemitTo, loFormSet.lnRemitLen)
  *!*	loFormSet.AriaForm1.txtOutComp.Value = laAry[1]

  *!*	REPLACE apinvhdr.coutaddr1 WITH laAry[2] IN apinvhdr
  *!*	REPLACE apinvhdr.coutaddr2 WITH laAry[3] IN apinvhdr
  *!*	REPLACE apinvhdr.coutaddr3 WITH laAry[4] IN apinvhdr
  *!*	REPLACE apinvhdr.coutaddr4 WITH laAry[5] IN apinvhdr
  *!*	REPLACE apinvhdr.coutaddr5 WITH laAry[6] IN apinvhdr
  loFormSet.AriaForm1.pgfpayInv.pgHead.cboInvRemit.VALUE  = ;
    gfRemit(loFormSet.AriaForm1.pgfpayInv.pgHead.cboInvRemit.VALUE, !llJustShow, ;
    loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE, ;
    loFormSet.AriaForm1.pgfpayInv.pgHead.kbFacCode.KeyTextBox.VALUE, @lcRemitStat, ;
    'laArray[1]','laArray[2]','laArray[3]','laArray[4]','laArray[5]','laArray[6]',;
    3, 40, 'laRemitTo', @lcRemitTo, loFormSet.lnRemitLen)
  loFormSet.AriaForm1.pgfpayInv.pgHead.txtOutComp.VALUE = laArray[1]
  REPLACE apinvhdr.coutaddr1 WITH laArray[2] IN apinvhdr
  REPLACE apinvhdr.coutaddr2 WITH laArray[3] IN apinvhdr
  REPLACE apinvhdr.coutaddr3 WITH laArray[4] IN apinvhdr
  REPLACE apinvhdr.coutaddr4 WITH laArray[5] IN apinvhdr
  REPLACE apinvhdr.coutaddr5 WITH laArray[6] IN apinvhdr
  SELECT apinvhdr
  =gfReplace('')
   *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  loFormSet.lcRemitStat = lcRemitStat
  loFormSet.lcRemitTo = lcRemitTo
  =ACOPY(laRemitTo,loFormSet.laRemitTo)

   *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	loFormSet.AriaForm1.kbFacCode.KeyTextBox.Value = ;
  *!*	  IIF(loFormSet.AriaForm1.cboInvRemit.Value = 'F', ;
  *!*	      loFormSet.AriaForm1.kbFacCode.KeyTextBox.Value, SPACE(6))
  loFormSet.AriaForm1.pgfpayInv.pgHead.kbFacCode.KeyTextBox.VALUE = ;
    IIF(loFormSet.AriaForm1.pgfpayInv.pgHead.cboInvRemit.VALUE = 'F', ;
    loFormSet.AriaForm1.pgfpayInv.pgHead.kbFacCode.KeyTextBox.VALUE, SPACE(6))
   *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  *loFormSet.lnOldRemit = puRemitTo


  *** If a vendor code exists,
  DO CASE
       *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *  CASE loFormSet.AriaForm1.cboInvRemit.Value = 'F'
    CASE loFormSet.AriaForm1.pgfpayInv.pgHead.cboInvRemit.VALUE = 'F'
       *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      loFormSet.lcFactStat   = IIF(!loFormSet.ActiveMode="V", 'ENABLE', 'DISABLE')  &&lower

    OTHERWISE
      loFormSet.lcFactStat   = 'DISABLE'
  ENDCASE
  *Old: =lfShiftlaData(loFormSet.lnStartAdr)
  *Old: SHOW GET loFormSet.laAddrs[1] &loFormSet.lcRemitStat &&Revise
  *Old: SHOW GET loFormSet.laAddrs[2] &loFormSet.lcRemitStat &&Revise
  *Old: SHOW GET loFormSet.laAddrs[3] &loFormSet.lcRemitStat &&Revise
   *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	STORE (loFormSet.lcRemitStat='ENABLE') TO loFormSet.AriaForm1.txtOutComp.Enabled, ;
  *!*	  loFormSet.AriaForm1.txtOutAddr1.Enabled, loFormSet.AriaForm1.txtOutAddr2.Enabled, ;
  *!*	  loFormSet.AriaForm1.txtOutAddr3.Enabled
  STORE (loFormSet.lcRemitStat='ENABLE') TO loFormSet.AriaForm1.pgfpayInv.pgHead.txtOutComp.ENABLED, ;
    loFormSet.AriaForm1.pgfpayInv.pgHead.txtOutAddr1.ENABLED, loFormSet.AriaForm1.pgfpayInv.pgHead.txtOutAddr2.ENABLED, ;
    loFormSet.AriaForm1.pgfpayInv.pgHead.txtOutAddr3.ENABLED
   *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  *Old: SHOW GET loFormSet.AriaForm1.kbFacCode.KeyTextBox.Value &loFormSet.lcFactStat  &&lower &&Revise
  *Old: SHOW GET ibFactor   &loFormSet.lcFactStat &&Revise
   *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *loFormSet.AriaForm1.kbFacCode.Enabled=(loFormSet.lcFactStat='ENABLE')
  loFormSet.AriaForm1.pgfpayInv.pgHead.kbFacCode.ENABLED=(loFormSet.lcFactStat='ENABLE')
   *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  *=lfRefresh()

  SELECT APINVHDR
  *B128399,1 KHM 06/15/2005 Return 0 to stay in the popup [Begin]
  *RETURN 1
  RETURN 0
  *B128399,1 KHM 06/15/2005 [End]
  *--end of lfvRemit


  *!*************************************************************
  *! Name      : lfvFactor
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 7/29/2004
  *! Purpose   : To Validate The Factor Control.
  *!*************************************************************
  *! Parameters: loFormSet
  *!*************************************************************
  *! Returns   : None
  *!*************************************************************
FUNCTION lfvFactor
  PARAMETERS loFormSet

  IF !INLIST(loFormSet.ActiveMode,'A','E')
    RETURN
  ENDIF
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	loFormSet.llBrowse = loFormSet.AriaForm1.kbFacCode.Selectedfrombrowse
  *!*	IF !loFormSet.llBrowse .AND.  ;
  *!*	  loFormSet.AriaForm1.kbFacCode.KeyTextBox.Value = loFormSet.AriaForm1.kbFacCode.KeyTextBox.OldValue
  loFormSet.llBrowse = loFormSet.AriaForm1.pgfpayInv.pgHead.kbFacCode.Selectedfrombrowse
  IF !loFormSet.llBrowse .AND.  ;
      loFormSet.AriaForm1.pgfpayInv.pgHead.kbFacCode.KeyTextBox.VALUE = loFormSet.AriaForm1.pgfpayInv.pgHead.kbFacCode.KeyTextBox.OldValue
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    RETURN
  ENDIF
  *Open file
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *llopFact = gfOpenFile(oAriaApplication.SysPath+'SYCFACT','CFACCODE','SH')  &&lower
  *IF loFormSet.llBrowse .OR. !EMPTY(loFormSet.AriaForm1.kbFacCode.KeyTextBox.Value)  &&lower
  * IF lfGetFac(loFormSet.AriaForm1.kbFacCode.KeyTextBox.OldValue, loFormSet.llBrowse)
  *!*	    loFormSet.AriaForm1.txtOutComp.Value = SYCFACT.cFacComp  &&lower
  *!*	    loFormSet.AriaForm1.txtOutAddr1.Value = SYCFACT.cAddress1  &&lower
  *!*	    loFormSet.AriaForm1.txtOutAddr2.Value = SYCFACT.cAddress2  &&lower
  *!*	    loFormSet.AriaForm1.txtOutAddr3.Value = lfGetAdr('SYCFACT','CFACCODE')  &&lower
  llopFact = gfOpenTable(oAriaApplication.SysPath+'SYCFACT','CFACCODE','SH')  &&lower
  IF loFormSet.llBrowse .OR. !EMPTY(loFormSet.AriaForm1.pgfpayInv.pgHead.kbFacCode.KeyTextBox.VALUE)  &&lower
    IF lfGetFac(loFormSet.AriaForm1.pgfpayInv.pgHead.kbFacCode.KeyTextBox.OldValue, loFormSet.llBrowse)
      loFormSet.AriaForm1.pgfpayInv.pgHead.txtOutComp.VALUE = SYCFACT.cFacComp  &&lower
      loFormSet.AriaForm1.pgfpayInv.pgHead.txtOutAddr1.VALUE = SYCFACT.cAddress1  &&lower
      loFormSet.AriaForm1.pgfpayInv.pgHead.txtOutAddr2.VALUE = SYCFACT.cAddress2  &&lower
      loFormSet.AriaForm1.pgfpayInv.pgHead.txtOutAddr3.VALUE = lfGetAdr('SYCFACT','CFACCODE')  &&lower
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      REPLACE apinvhdr.coutaddr1 WITH gfGetAdr('SYCFACT','CFACCODE',.F.,.F.,1) IN apinvhdr
      REPLACE apinvhdr.coutaddr2 WITH gfGetAdr('SYCFACT','CFACCODE',.F.,.F.,2) IN apinvhdr
      REPLACE apinvhdr.coutaddr3 WITH gfGetAdr('SYCFACT','CFACCODE',.F.,.F.,3) IN apinvhdr
      REPLACE apinvhdr.coutaddr4 WITH gfGetAdr('SYCFACT','CFACCODE',.F.,.F.,4) IN apinvhdr
      REPLACE apinvhdr.coutaddr5 WITH gfGetAdr('SYCFACT','CFACCODE',.F.,.F.,5) IN apinvhdr
    ENDIF
  ELSE
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *    loFormSet.AriaForm1.txtOutComp.Value = ''
    loFormSet.AriaForm1.pgfpayInv.pgHead.txtOutComp.VALUE = ''
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    REPLACE apinvhdr.coutaddr1 WITH ''
    REPLACE apinvhdr.coutaddr2 WITH ''
    REPLACE apinvhdr.coutaddr3 WITH ''
    REPLACE apinvhdr.coutaddr4 WITH ''
    REPLACE apinvhdr.coutaddr5 WITH ''
  ENDIF
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  SELECT apinvhdr
  =gfReplace("")
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

  *Old: SHOW GET loFormSet.AriaForm1.txtOutComp.Value  &&lower &&Revise
  *Old: SHOW GET loFormSet.AriaForm1.txtOutAddr1.Value   &&lower &&Revise
  *Old: SHOW GET loFormSet.AriaForm1.txtOutAddr2.Value   &&lower &&Revise
  *Old: SHOW GET loFormSet.AriaForm1.txtOutAddr3.Value   &&lower &&Revise
  
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	loFormSet.AriaForm1.txtOutComp.Refresh()
  *!*	loFormSet.AriaForm1.txtOutAddr1.Refresh()
  *!*	loFormSet.AriaForm1.txtOutAddr2.Refresh()
  *!*	loFormSet.AriaForm1.txtOutAddr3.Refresh()
  loFormSet.AriaForm1.pgfpayInv.pgHead.txtOutComp.REFRESH()
  loFormSet.AriaForm1.pgfpayInv.pgHead.txtOutAddr1.REFRESH()
  loFormSet.AriaForm1.pgfpayInv.pgHead.txtOutAddr2.REFRESH()
  loFormSet.AriaForm1.pgfpayInv.pgHead.txtOutAddr3.REFRESH()
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  *Old: =lfShiftlaData(loFormSet.lnStartAdr)
  *Old: SHOW GET loFormSet.laAddrs[1] &&Revise
  *Old: SHOW GET loFormSet.laAddrs[2] &&Revise
  *Old: SHOW GET loFormSet.laAddrs[3] &&Revise
  loFormSet.llBrowse = .F.
  IF USED('SYCFAC') .AND. llopFact
    *=gfCloseFile('SYCFAC')
    USE IN SYCFAC
  ENDIF

  RETURN
  *--end of lfvFactor


  *!*************************************************************
  *! Name      : lfvPriority
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 7/29/2004
  *! Purpose   : To Validate The Priority.
  *!*************************************************************
  *! Parameters: loFormSet
  *!*************************************************************
  *! Returns   : None
  *!*************************************************************
FUNCTION lfvPriority
  PARAMETERS loFormSet

  IF !INLIST(loFormSet.ActiveMode,'A','E')
    RETURN
  ENDIF
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	IF EMPTY(loFormSet.AriaForm1.txtVendPrior.Value)  &&lower
  *!*	  loFormSet.AriaForm1.txtVendPrior.Value = loFormSet.AriaForm1.txtVendPrior.OldValue
  IF EMPTY(loFormSet.AriaForm1.pgfpayInv.pgHead.txtVendPrior.VALUE)  &&lower
    loFormSet.AriaForm1.pgfpayInv.pgHead.txtVendPrior.VALUE = loFormSet.AriaForm1.pgfpayInv.pgHead.txtVendPrior.OldValue
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  ENDIF
  *Old: SHOW GET loFormSet.AriaForm1.txtVendPrior.Value  &&lower &&Revise

  RETURN
  *--end of lfvPriority



  *!*************************************************************
  *! Name      : lfvCurrency
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 7/29/2004
  *! Purpose   : To Validate The Currency Control.
  *!*************************************************************
  *! Parameters: loFormSet
  *!*************************************************************
  *! Returns   : None
  *!*************************************************************
  *
FUNCTION lfvCurrency
  PARAMETERS loFormSet
  LOCAL lcExSin2

  IF !INLIST(loFormSet.ActiveMode,'A','E')
    RETURN
  ENDIF

  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *loFormSet.llBrowse = loFormSet.AriaForm1.kbCurrCode.Selectedfrombrowse
  loFormSet.llBrowse = loFormSet.AriaForm1.pgfpayInv.pgHead.kbCurrCode.Selectedfrombrowse
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

  *IF !USED('SYCCURR')
  
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *  =gfOpenFile(oAriaApplication.SysPath + 'SYCCURR' , 'CCURRCODE' , 'SH')
  =gfOpenTable(oAriaApplication.SysPath + 'SYCCURR' , 'CCURRCODE' , 'SH')
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  *ENDIF

  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	IF loFormSet.llBrowse .OR. !SEEK(loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value,'SYCCURR') .OR. ;
  *!*	  ATC("?",loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value) > 0 .AND. LASTKEY() = 13
  IF loFormSet.llBrowse .OR. !SEEK(loFormSet.AriaForm1.pgfpayInv.pgHead.kbCurrCode.KeyTextBox.VALUE,'SYCCURR') .OR. ;
      ATC("?",loFormSet.AriaForm1.pgfpayInv.pgHead.kbCurrCode.KeyTextBox.VALUE) > 0 .AND. LASTKEY() = 13
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    SELECT SYCCURR
    DIMENSION laTemp[1]
    laTemp     = ''
    *Old: lcSavBrFld = lcBrFields
    *Old: lcSavTitle = lcFile_Ttl
    lcFile_Ttl = "Currency"
    lcBrFields = "CCURRCODE :R :H= 'Currency code'," +;
      "CCURRDESC :R :H= 'Description',  " +;
      "CCURRSMBL :R :H= 'Symbol'"
    *! E302623,2 MMT 10/12/2009 Convert Payable invoice screen to use SQL tables[Start]
    *=gfBrows('','CCURRCODE','laTemp')
    *! E302623,3 MMT 01/03/2010 Convert Payable invoice screen to use SQL tables[Start]
    *=gfBrows('','CCURRCODE','laTemp',lcFile_Ttl )
     =ARIABROW('', lcFile_Ttl , .F., .F., .F., .F., .F., .T., ;
                'CCURRCODE', 'laTemp', .F., .F., .F., ;
                .F., .F., .F., .F., .F., ;
                .F., .F.)
    *! E302623,3 MMT 01/03/2010 Convert Payable invoice screen to use SQL tables[End]
    *! E302623,2 MMT 08/12/2009 Convert Payable invoice screen to use SQL tables[End]
    *Old: lcBrFields = lcSavBrFld
    *Old: lcFile_Ttl = lcSavTitle
    IF EMPTY(laTemp[1])
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value = loFormSet.AriaForm1.kbCurrCode.KeyTextBox.OldValue
      loFormSet.AriaForm1.pgfpayInv.pgHead.kbCurrCode.KeyTextBox.VALUE = loFormSet.AriaForm1.pgfpayInv.pgHead.kbCurrCode.KeyTextBox.OldValue
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    ELSE
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value = laTemp[1]  &&lower
      loFormSet.AriaForm1.pgfpayInv.pgHead.kbCurrCode.KeyTextBox.VALUE = laTemp[1]  &&lower
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    ENDIF
  ENDIF

  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *IF loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value <> loFormSet.AriaForm1.kbCurrCode.KeyTextBox.OldValue
  IF loFormSet.AriaForm1.pgfpayInv.pgHead.kbCurrCode.KeyTextBox.VALUE <> loFormSet.AriaForm1.pgfpayInv.pgHead.kbCurrCode.KeyTextBox.OldValue
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    *Add this lines to clear the approve for payment amount if the
    *        invoice currency was changed [Begin]
    *IF Statment to check that the approve amount do not = 0
    IF !EMPTY(apinvhdr.ninvamtap)  &&lower
      ** MESSAGE : " Changing the invoice currency will clear the "
      **           " approved amounts.                            "
      **           "            <   Ok   >  < Cancel >            "
      **
      lnChange = gfModalGen("TRM04160B04004" , "DIALOG")
      *IF the user selected to cancel
      IF lnChange = 2

        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        *loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value = loFormSet.AriaForm1.kbCurrCode.KeyTextBox.OldValue   && Restore the old value
        loFormSet.AriaForm1.pgfpayInv.pgHead.kbCurrCode.KeyTextBox.VALUE = loFormSet.AriaForm1.pgfpayInv.pgHead.kbCurrCode.KeyTextBox.OldValue   && Restore the old value
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

        loFormSet.llBrowse = .F.

        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        *loFormSet.AriaForm1.kbCurrCode.Selectedfrombrowse = loFormSet.llBrowse
        loFormSet.AriaForm1.pgfpayInv.pgHead.kbCurrCode.Selectedfrombrowse = loFormSet.llBrowse
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

        RETURN
      ELSE   && Else clear the approve amount
        = lfvClrApr(loFormSet)
      ENDIF   && End of IF
    ENDIF   && End of IF
    *Add this lines [End]
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *IF gfGetMemVar('LLMULCURR') .AND. loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value <> oAriaApplication.BaseCurrency
    IF gfGetMemVar('LLMULCURR') .AND. loFormSet.AriaForm1.pgfpayInv.pgHead.kbCurrCode.KeyTextBox.VALUE <> oAriaApplication.BaseCurrency
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      PRIVATE lnCurrUnit
      lnCurrUnit = 0
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *!*	    loFormSet.AriaForm1.txtNexRate.Value = gfChkRate('lnCurrUnit',;
      *!*	       loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value,loFormSet.AriaForm1.DtInvDate.Value,.T.)
      loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.VALUE = gfChkRate('lnCurrUnit',;
        loFormSet.AriaForm1.pgfpayInv.pgHead.kbCurrCode.KeyTextBox.VALUE,loFormSet.AriaForm1.pgfpayInv.pgHead.DtInvDate.VALUE,.T.)
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      *Got the equation signs. (Begin)
      *to exchange currency from invoice currency to company base currency.
      *laData[44] ------> cCurrCode
      *Passed pointer parameter to get Unit sgin. (Begin)
      loFormSet.lcExSin2 = ' '
      lcExSin2 = loFormSet.lcExSin2
      
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *loFormSet.lcExSin1 = gfGetExSin(@lcExSin2,loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value)
      loFormSet.lcExSin1 = gfGetExSin(@lcExSin2,loFormSet.AriaForm1.pgfpayInv.pgHead.kbCurrCode.KeyTextBox.VALUE)
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      
      *B608763,1 WAM 12/15/2008 Restore exchange rate
      *lcExSin2 = loFormSet.lcExSin2
      loFormSet.lcExSin2 = lcExSin2
      *B608763,1 WAM 12/15/2008 (End)

      *lcExSin2 = IIF(lcExSin1 = '*','/','*')
      
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *IF loFormSet.AriaForm1.txtNexRate.Value = 0
      *loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value = oAriaApplication.BaseCurrency
      *loFormSet.AriaForm1.txtNexRate.Value = 1
      IF loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.VALUE = 0
        loFormSet.AriaForm1.pgfpayInv.pgHead.kbCurrCode.KeyTextBox.VALUE = oAriaApplication.BaseCurrency
        loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.VALUE = 1
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

      ENDIF
      IF gfGetMemVar('LLEDITEXRA')
        *Old: SHOW GET loFormSet.AriaForm1.txtNexRate.Value ENABLE  &&lower &&Revise
        
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        *loFormSet.AriaForm1.txtNexRate.Enabled = .T.
        loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.ENABLED = .T.
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
        
      ELSE
        *Old: SHOW GET loFormSet.AriaForm1.txtNexRate.Value DISABLE  &&lower &&Revise
        
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        *loFormSet.AriaForm1.txtNexRate.Enabled = .F.
        loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.ENABLED = .F.
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
        
      ENDIF
    ELSE
      
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *!*	    loFormSet.AriaForm1.txtNexRate.Value = 1  &&lower
      *!*	    *Old: SHOW GET loFormSet.AriaForm1.txtNexRate.Value DISABLE  &&lower &&Revise
      *!*	    loFormSet.AriaForm1.txtNexRate.Enabled = .F.
      loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.VALUE = 1  &&lower
      *Old: SHOW GET loFormSet.AriaForm1.txtNexRate.Value DISABLE  &&lower &&Revise
      loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.ENABLED = .F.
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      
    ENDIF
    *Disable Invoice lines option when the vendor supply only cutting
    *ticket and invoicing with forign currency.
    
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *  IF EMPTY(loFormSet.lcVenInvTypes) OR  ('M'=loFormSet.lcVenInvTypes AND gfGetMemVar('LLMULCURR') AND PADR(loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value,3)<>PADR(oAriaApplication.BaseCurrency,3) )  &&lower  &&lower
    IF EMPTY(loFormSet.lcVenInvTypes) OR  ('M'=loFormSet.lcVenInvTypes AND gfGetMemVar('LLMULCURR') AND PADR(loFormSet.AriaForm1.pgfpayInv.pgHead.kbCurrCode.KeyTextBox.VALUE,3)<>PADR(oAriaApplication.BaseCurrency,3) )  &&lower  &&lower
	*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      *Old: SHOW GET pbAPVInvDt DISABLE &&Revise
      
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *loFormSet.AriaForm1.cmdInvLines.Enabled = .F.
      loFormSet.AriaForm1.pgfpayInv.pgDet.ENABLED = .F.
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      
    ELSE
      *Old: SHOW GET pbAPVInvDt ENABLE &&Revise
      
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *loFormSet.AriaForm1.cmdInvLines.Enabled = .T.
      loFormSet.AriaForm1.pgfpayInv.pgDet.ENABLED = .T.
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      
    ENDIF
  ENDIF
  loFormSet.llBrowse = .F.
  
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *loFormSet.AriaForm1.kbCurrCode.Selectedfrombrowse = loFormSet.llBrowse
  loFormSet.AriaForm1.pgfpayInv.pgHead.kbCurrCode.Selectedfrombrowse = loFormSet.llBrowse
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  
  SELECT APINVHDR

  RETURN
  *--end of lfvCurrency


  *!*************************************************************
  *! Name      : lfvExRate
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 7/29/2004
  *! Purpose   : To Validate The Exchange Rate.
  *!*************************************************************
  *! Parameters: loFormSet
  *!*************************************************************
  *! Returns   : None
  *!*************************************************************
FUNCTION lfvExRate
  PARAMETERS loFormSet

  IF !INLIST(loFormSet.ActiveMode,'A','E')
    RETURN
  ENDIF

  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	IF loFormSet.AriaForm1.txtNexRate.Value <= 0  &&lower
  *!*	  loFormSet.AriaForm1.txtNexRate.Value = loFormSet.AriaForm1.txtNexRate.OldValue  &&lower
  IF loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.VALUE <= 0  &&lower
    loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.VALUE = loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.OldValue  &&lower
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  ENDIF
  *Old: SHOW GET loFormSet.AriaForm1.txtNexRate.Value  &&lower &&Revise

  RETURN
  *--end of lfvExRate


  *!*************************************************************
  *! Name      : lfvPayMethd
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 7/29/2004
  *! Purpose   : To Validate The Payment Methods Control.
  *!*************************************************************
  *! Parameters: loFormSet
  *!*************************************************************
  *! Returns   : True or False
  *!*************************************************************
FUNCTION lfvPayMethd
  PARAMETERS loFormSet

  IF !INLIST(loFormSet.ActiveMode,'A','E')
    RETURN
  ENDIF

  *Old: loFormSet.AriaForm1.cboVendPmeth.Value = loFormSet.laPayMethd[puMethod,2]  &&lower
  
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *IF loFormSet.AriaForm1.cboVendPmeth.Value = 'C' .AND. loFormSet.AriaForm1.txtInvAmount.Value < 0
  IF loFormSet.AriaForm1.pgfpayInv.pgHead.cboVendPmeth.VALUE = 'C' .AND. loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.VALUE < 0
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    ** MESSAGE : " You can not pay the debit invoice "
    **           " by credit card.                   "
    **           "                  Ok             "
    =gfModalGen("TRM04041B00000","DIALOG")
    
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *!*	  loFormSet.AriaForm1.cboVendPmeth.Value  = loFormSet.AriaForm1.cboVendPmeth.OldValue  &&lower
    *!*	  loFormSet.lcPayMethd = loFormSet.laPayMethd[AT(loFormSet.AriaForm1.cboVendPmeth.Value,'PMNCH'),1]  &&lower
    loFormSet.AriaForm1.pgfpayInv.pgHead.cboVendPmeth.VALUE  = loFormSet.AriaForm1.pgfpayInv.pgHead.cboVendPmeth.OldValue  &&lower
    loFormSet.lcPayMethd = loFormSet.laPayMethd[AT(loFormSet.AriaForm1.pgfpayInv.pgHead.cboVendPmeth.Value,'PMNCH'),1]  &&lower
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    
    *_CUROBJ    = _CUROBJ&&Old CurObj
    *=lfRefresh()
    RETURN 0
  ENDIF

  
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *IF !EMPTY(apinvhdr.cvenccven) .AND. loFormSet.AriaForm1.cboVendPmeth.Value = 'C'
  IF !EMPTY(apinvhdr.cvenccven) .AND. loFormSet.AriaForm1.pgfpayInv.pgHead.cboVendPmeth.VALUE = 'C'
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    
    ** MESSAGE : " This invoice is a credit card pqayment   "
    **           " for vendor  Invoice . You cannot change"
    **           " to a credit card payment.                "
    **           "                     Ok                 "
    =gfModalGen("TRM04145B00000","DIALOG",ALLTRIM(apinvhdr.cvenccven)+"|"+ALLTRIM(apinvhdr.cvenccinv)))
    
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *!*	  loFormSet.AriaForm1.cboVendPmeth.Value  = loFormSet.AriaForm1.cboVendPmeth.OldValue
    *!*	  loFormSet.lcPayMethd = loFormSet.laPayMethd[AT(loFormSet.AriaForm1.cboVendPmeth.Value,'PMNCH'),1]
    loFormSet.AriaForm1.pgfpayInv.pgHead.cboVendPmeth.VALUE  = loFormSet.AriaForm1.pgfpayInv.pgHead.cboVendPmeth.OldValue
    loFormSet.lcPayMethd = loFormSet.laPayMethd[AT(loFormSet.AriaForm1.pgfpayInv.pgHead.cboVendPmeth.Value,'PMNCH'),1]
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    *_CUROBJ    = _CUROBJ&&Old CurObj
    *=lfRefresh()
    RETURN 0
  ENDIF

  SELECT APINVAHD
  
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	lcSavOrder = SET('ORDER')
  *!*	SET ORDER TO TAG TVENDINV
  lcSavOrder = ORDER()
  =gfSetOrder('TVENDINV')
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  lcSavExact = SET('EXACT')
  SET EXACT ON

  IF SEEK('I'+loFormSet.AriaForm1.kbVendCode.KeyTextBox.VALUE+;
      loFormSet.AriaForm1.kbInvNo.KeyTextBox.VALUE) .AND. loFormSet.ActiveMode="E"
    ** MESSAGE : " This invoice has corresponding instalment "
    **           " record.  .
    **           "                      Ok                 "
    
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *!*	  lcNewPay  = loFormSet.laPayMethd[AT(loFormSet.AriaForm1.cboVendPmeth.Value,'PMNCH'),1]
    lcNewPay  = loFormSet.laPayMethd[AT(loFormSet.AriaForm1.pgfpayInv.pgHead.cboVendPmeth.Value,'PMNCH'),1]
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    
    lcTIstCor = loFormSet.lcTCrdtCor+ALLTRIM(LOWER(lcNewPay))

    =gfModalGen("TRM04120B00000","DIALOG",lcTIstCor)
    
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *!*	  loFormSet.AriaForm1.cboVendPmeth.Value  = loFormSet.AriaForm1.cboVendPmeth.OldValue
    *!*	  loFormSet.lcPayMethd = loFormSet.laPayMethd[AT(loFormSet.AriaForm1.cboVendPmeth.Value,'PMNCH'),1]  &&lower
    loFormSet.AriaForm1.pgfpayInv.pgHead.cboVendPmeth.VALUE  = loFormSet.AriaForm1.pgfpayInv.pgHead.cboVendPmeth.OldValue
    loFormSet.lcPayMethd = loFormSet.laPayMethd[AT(loFormSet.AriaForm1.pgfpayInv.pgHead.cboVendPmeth.Value,'PMNCH'),1]  &&lower
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    
    *_CUROBJ    = _CUROBJ&&Old CurObj

    *=lfRefresh()
    
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *SET ORDER TO &lcSavOrder
    =gfSetOrder(lcSavOrder)
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    
    SET EXACT &lcSavExact
    RETURN 0
  ENDIF
  
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *SET ORDER TO &lcSavOrder
  =gfSetOrder(lcSavOrder)
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  
  SET EXACT &lcSavExact

  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	IF loFormSet.AriaForm1.cboVendPmeth.Value = 'C'    && If the user select the credit card payment.  &&lower
  IF loFormSet.AriaForm1.pgfpayInv.pgHead.cboVendPmeth.VALUE = 'C'    && If the user select the credit card payment.  &&lower
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  
    ** If the amount paid + the discount taken not equal to 0.
    IF apinvhdr.ninvpaid+apinvhdr.ninvdistk+apinvhdr.ninvadj > 0
      ** MESSAGE : " You can not change to credit card payment "
      **           " for fully or partially paid invoice.      "
      **           "                     Ok                  "

      =gfModalGen("TRM04012B00000","DIALOG")

      *Old: SHOW GET pbApprove,1 PROMPT '\<Approve for payment...' &&Revise
      
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *loFormSet.AriaForm1.cmdApprove.Caption = '\<Approve for payment...'
      *!*	    loFormSet.AriaForm1.cboVendPmeth.Value =  loFormSet.AriaForm1.cboVendPmeth.OldValue
      loFormSet.AriaForm1.pgfpayInv.pgHead.cboVendPmeth.VALUE =  loFormSet.AriaForm1.pgfpayInv.pgHead.cboVendPmeth.OldValue
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      *_CUROBJ   = _CUROBJ&&Old CurObj

      *=lfRefresh()
      RETURN 0

    ELSE
      *Old: SHOW GET pbApprove,1 PROMPT 'Credit c\<ard payment...' &&Revise
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *loFormSet.AriaForm1.cmdApprove.Caption = 'Credit c\<ard payment...'
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

      ** We are going to intialize the approved payments screen objects with 0.
      REPLACE apinvhdr.cbnkcode WITH SPACE(8)
      REPLACE apinvhdr.cchkacct WITH SPACE(12)
      REPLACE apinvhdr.cchkglacc WITH loFormSet.AriaForm1.ap1.lcemptyacc
      REPLACE apinvhdr.ninvdisap WITH 0.00
      REPLACE apinvhdr.ninvamtap WITH 0.00

      REPLACE apinvhdr.ninvfaap WITH 0.00

      REPLACE apinvhdr.ninvadjap WITH 0.00
      REPLACE apinvhdr.ninva1099 WITH 0.00
      loFormSet.lnTotAppPay = 0.00
    ENDIF
  ELSE
    *Old: SHOW GET pbApprove,1 PROMPT '\<Approve for payment...' &&Revise
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    * loFormSet.AriaForm1.cmdApprove.Caption = '\<Approve for payment...'
    *!*	  IF (loFormSet.AriaForm1.cboVendPmeth.OldValue = 'H' .AND. loFormSet.AriaForm1.cboVendPmeth.Value <> 'H') .OR.;
    *!*	     (loFormSet.AriaForm1.cboVendPmeth.OldValue $ 'MPN' .AND. loFormSet.AriaForm1.cboVendPmeth.Value = 'H')
    IF (loFormSet.AriaForm1.pgfpayInv.pgHead.cboVendPmeth.OldValue = 'H' .AND. loFormSet.AriaForm1.pgfpayInv.pgHead.cboVendPmeth.VALUE <> 'H') .OR.;
        (loFormSet.AriaForm1.pgfpayInv.pgHead.cboVendPmeth.OldValue $ 'MPN' .AND. loFormSet.AriaForm1.pgfpayInv.pgHead.cboVendPmeth.VALUE = 'H')
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      REPLACE apinvhdr.ninvdisap WITH 0.00
      REPLACE apinvhdr.ninvamtap WITH 0.00

      REPLACE apinvhdr.ninvfaap WITH 0.00

      REPLACE apinvhdr.ninva1099 WITH 0.00
      REPLACE apinvhdr.cbnkcode WITH ' '
      REPLACE apinvhdr.cchkacct WITH ' '
      REPLACE apinvhdr.cchkglacc WITH loFormSet.AriaForm1.ap1.lcemptyacc
      REPLACE apinvhdr.ninvadjap WITH 0
      loFormSet.lnTotAppPay = 0.00
    ENDIF

    REPLACE apinvhdr.cvenccven WITH ;
      IIF(loFormSet.llPaidByCrd,apinvhdr.cvenccven,SPACE(8))
    REPLACE apinvhdr.cvenccinv WITH ;
      IIF(loFormSet.llPaidByCrd,apinvhdr.cvenccinv,SPACE(12))
    loFormSet.lcAccount  = loFormSet.AriaForm1.ap1.lcemptyacc

  ENDIF
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  SELECT apinvhdr
  =gfReplace("")
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  *=lfRefresh()    && refresh says filed on the screen

  *B128399,1 KHM 06/15/2005 Return 0 to stay in the popup [Begin]
  *RETURN 1
  RETURN 0
  *B128399,1 KHM 06/15/2005 [End]
  *--end of lfvPayMethd


  *!*************************************************************
  *! Name      : lfvDueDays
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 7/29/2004
  *! Purpose   : To Validate The Due Days.
  *!*************************************************************
  *! Parameters: loFormSet
  *!*************************************************************
  *! Returns   : None
  *!*************************************************************
FUNCTION lfvDueDays
  PARAMETERS loFormSet

  IF !INLIST(loFormSet.ActiveMode,'A','E')
    RETURN
  ENDIF
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	IF loFormSet.AriaForm1.txtterdued.Value < 0  &&lower
  *!*	  loFormSet.AriaForm1.txtterdued.Value = loFormSet.AriaForm1.txtterdued.OldValue
  IF loFormSet.AriaForm1.pgfpayInv.pgHead.txtterdued.VALUE < 0  &&lower
    loFormSet.AriaForm1.pgfpayInv.pgHead.txtterdued.VALUE = loFormSet.AriaForm1.pgfpayInv.pgHead.txtterdued.OldValue
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    *Old: SHOW GET loFormSet.AriaForm1.txtterdued.Value  &&lower &&Revise
  ELSE
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *!*	  loFormSet.AriaForm1.dtInvDuDat.Value  = ;
    *!*	    lfGetdueD(loFormSet.AriaForm1.DtInvDate.Value,loFormSet.AriaForm1.txtterdued.Value,;
    *!*	    loFormSet.lnEomDay)
    *! B609614,1 TMI 07/25/2011 Fix bug of wrong AP invoice Due date[Start]
    *loFormSet.AriaForm1.pgfpayInv.pgHead.dtInvDuDat.VALUE  = ;
      lfGetdueD(loFormSet.AriaForm1.pgfpayInv.pgHead.DtInvDate.VALUE,loFormSet.AriaForm1.pgfpayInv.pgHead.txtterdued.VALUE,;
      loFormSet.lnEomDay)
    loFormSet.AriaForm1.pgfpayInv.pgHead.dtInvDuDat.VALUE  = ;
      lfGetdueD(loFormSet.AriaForm1.pgfpayInv.pgHead.DtInvDate.VALUE,loFormSet.AriaForm1.pgfpayInv.pgHead.txtterdued.VALUE,;
      loFormSet.lnEomDay,loFormSet.lcEom)
    *! B609614,1 TMI 07/25/2011 Fix bug of wrong AP invoice Due date[END]
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  ENDIF

  RETURN
  *--end of lfvDueDays

  *!*************************************************************
  *! Name      : lfvDueDate
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 7/29/2004
  *! Purpose   : To Validate The Due Date.
  *!*************************************************************
  *! Parameters: loFormSet
  *!*************************************************************
  *! Returns   : None
  *!*************************************************************
FUNCTION lfvDueDate
  PARAMETERS loFormSet

  IF !INLIST(loFormSet.ActiveMode,'A','E')
    RETURN
  ENDIF

  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *IF loFormSet.AriaForm1.dtInvDuDat.Value < loFormSet.AriaForm1.DtInvDate.Value
  IF loFormSet.AriaForm1.pgfpayInv.pgHead.dtInvDuDat.VALUE < loFormSet.AriaForm1.pgfpayInv.pgHead.DtInvDate.VALUE
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    ** MESSAGE : " The due date can not be less than  "
    **           " the invoice date.                  "
    **           "                 Ok               "
    =gfModalGen("TRM04016B00000","DIALOG")
    *_CUROBJ = _CUROBJ&&Old CurObj
    *Old: SHOW GET loFormSet.AriaForm1.dtInvDuDat.Value  &&lower &&Revise
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *!*	  loFormSet.AriaForm1.dtInvDuDat.Value = loFormSet.AriaForm1.dtInvDuDat.OldValue
    loFormSet.AriaForm1.pgfpayInv.pgHead.dtInvDuDat.VALUE = loFormSet.AriaForm1.pgfpayInv.pgHead.dtInvDuDat.OldValue
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    RETURN 0
  ELSE
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *!*	  loFormSet.AriaForm1.txtterdued.Value = ;
    *!*	    loFormSet.AriaForm1.dtInvDuDat.Value - loFormSet.AriaForm1.DtInvDate.Value
    loFormSet.AriaForm1.pgfpayInv.pgHead.txtterdued.VALUE = ;
      loFormSet.AriaForm1.pgfpayInv.pgHead.dtInvDuDat.VALUE - loFormSet.AriaForm1.pgfpayInv.pgHead.DtInvDate.VALUE
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    *Old: SHOW GET loFormSet.AriaForm1.txtterdued.Value  &&lower &&Revise
  ENDIF

  RETURN
  *--end of lfvDueDate


  *!*************************************************************
  *! Name      : lfvDiscDays
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 7/29/2004
  *! Purpose   : To Validate The Discount Days.
  *!*************************************************************
  *! Parameters: loFormSet
  *!*************************************************************
  *! Returns   : None
  *!*************************************************************
FUNCTION lfvDiscDays
  PARAMETERS loFormSet

  IF !INLIST(loFormSet.ActiveMode,'A','E')
    RETURN
  ENDIF

  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	IF loFormSet.AriaForm1.txtTerDiscd.Value < 0  &&lower
  *!*	  loFormSet.AriaForm1.txtTerDiscd.Value = loFormSet.AriaForm1.txtTerDiscd.OldValue
  *!*	ENDIF
  IF loFormSet.AriaForm1.pgfpayInv.pgHead.txtTerDiscd.VALUE < 0  &&lower
    loFormSet.AriaForm1.pgfpayInv.pgHead.txtTerDiscd.VALUE = loFormSet.AriaForm1.pgfpayInv.pgHead.txtTerDiscd.OldValue
  ENDIF
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  *Old: SHOW GET loFormSet.AriaForm1.txtTerDiscd.Value  &&lower &&Revise

  RETURN
  *--end of lfvDiscDays


  *!*************************************************************
  *! Name      : lfvDiscPer
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 7/29/2004
  *! Purpose   : To Validate The Discount Percentage.
  *!*************************************************************
  *! Parameters: loFormSet
  *!*************************************************************
  *! Returns   : None
  *!*************************************************************
FUNCTION lfvDiscPer
  PARAMETERS loFormSet

  IF !INLIST(loFormSet.ActiveMode,'A','E')
    RETURN
  ENDIF

  *Execute the validation only in case of the disc. amount is > 0
  *OR the Disc % is changed
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	IF (loFormSet.AriaForm1.txtTerDiscr.Value <> loFormSet.AriaForm1.txtTerDiscr.OldValue) .OR. ;
  *!*	  (loFormSet.AriaForm1.txtTerDiscr.Value > 0 AND loFormSet.AriaForm1.txtInvDisof.Value > 0)
  *!*	  IF loFormSet.AriaForm1.txtTerDiscr.Value < 0
  *!*	    loFormSet.AriaForm1.txtTerDiscr.Value = loFormSet.AriaForm1.txtTerDiscr.OldValue
  IF (loFormSet.AriaForm1.pgfpayInv.pgHead.txtTerDiscr.VALUE <> loFormSet.AriaForm1.pgfpayInv.pgHead.txtTerDiscr.OldValue) .OR. ;
      (loFormSet.AriaForm1.pgfpayInv.pgHead.txtTerDiscr.VALUE > 0 AND loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvDisof.VALUE > 0)
    IF loFormSet.AriaForm1.pgfpayInv.pgHead.txtTerDiscr.VALUE < 0
      loFormSet.AriaForm1.pgfpayInv.pgHead.txtTerDiscr.VALUE = loFormSet.AriaForm1.pgfpayInv.pgHead.txtTerDiscr.OldValue
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      *Old: SHOW GET loFormSet.AriaForm1.txtTerDiscr.Value  &&lower &&Revise
    ELSE
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *!*	    IF loFormSet.AriaForm1.txtInvAmount.Value > 0  &&lower
      *!*	      loFormSet.AriaForm1.txtInvDisof.Value = ;
      *!*	        (loFormSet.AriaForm1.txtTerDiscr.Value * loFormSet.AriaForm1.txtInvAmount.Value) / 100
      IF loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.VALUE > 0  &&lower
        loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvDisof.VALUE = ;
          (loFormSet.AriaForm1.pgfpayInv.pgHead.txtTerDiscr.VALUE * loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.VALUE) / 100
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
        *Old: SHOW GET loFormSet.AriaForm1.txtInvDisof.Value  &&lower &&Revise
      ENDIF
    ENDIF
  ENDIF



  *Old: SHOW GET loFormSet.AriaForm1.txtInvDisof.Value  &&lower &&Revise

  RETURN
  *--end of lfvDiscPer


  *!*************************************************************
  *! Name      : lfvTemplate
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 7/29/2004
  *! Purpose   : To Validate The Template Control.
  *!*************************************************************
  *! Parameters: loFormSet
  *!*************************************************************
  *! Returns   : None
  *!*************************************************************
  * Valid function for get field laData[38] representing template code.
  *
FUNCTION lfvTemplate
  PARAMETERS loFormSet

  IF !INLIST(loFormSet.ActiveMode,'A','E')
    RETURN
  ENDIF
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *loFormSet.llBrowse = loFormSet.AriaForm1.kbAutmCode.Selectedfrombrowse
  loFormSet.llBrowse = loFormSet.AriaForm1.pgfpayInv.pgHead.kbAutmCode.Selectedfrombrowse
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  *IF Statment to check if the template field is empty
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *IF EMPTY(loFormSet.AriaForm1.kbAutmCode.KeyTextBox.Value) .AND. !loFormSet.llBrowse  &&lower
  IF EMPTY(loFormSet.AriaForm1.pgfpayInv.pgHead.kbAutmCode.KeyTextBox.VALUE) .AND. !loFormSet.llBrowse  &&lower
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    RETURN
  ENDIF

  SELECT APINVAHD

  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	loFormSet.AriaForm1.kbAutmCode.KeyTextBox.Value     = ;
  *!*	  ALLTRIM(loFormSet.AriaForm1.kbAutmCode.KeyTextBox.Value)
  *!*	loFormSet.AriaForm1.kbAutmCode.KeyTextBox.Value     = ;
  *!*	  IIF(ISDIGIT(LEFT(loFormSet.AriaForm1.kbAutmCode.KeyTextBox.Value,1)),;
  *!*	    PADL(loFormSet.AriaForm1.kbAutmCode.KeyTextBox.Value, FSIZE('cAutMCode','APINVAHD'),'0'),;
  *!*	    PADR(loFormSet.AriaForm1.kbAutmCode.KeyTextBox.Value,FSIZE('cAutMCode','APINVAHD')))
  loFormSet.AriaForm1.pgfpayInv.pgHead.kbAutmCode.KeyTextBox.VALUE     = ;
    ALLTRIM(loFormSet.AriaForm1.pgfpayInv.pgHead.kbAutmCode.KeyTextBox.VALUE)
  loFormSet.AriaForm1.pgfpayInv.pgHead.kbAutmCode.KeyTextBox.VALUE     = ;
    IIF(ISDIGIT(LEFT(loFormSet.AriaForm1.pgfpayInv.pgHead.kbAutmCode.KeyTextBox.VALUE,1)),;
    PADL(loFormSet.AriaForm1.pgfpayInv.pgHead.kbAutmCode.KeyTextBox.VALUE, FSIZE('cAutMCode','APINVAHD'),'0'),;
    PADR(loFormSet.AriaForm1.pgfpayInv.pgHead.kbAutmCode.KeyTextBox.VALUE,FSIZE('cAutMCode','APINVAHD')))
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  loFormSet.lcTmplate = 'ENABLE'
  *Old: SHOW GET loFormSet.AriaForm1.kbAutmCode.KeyTextBox.Value  &&lower &&Revise
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *loFormSet.AriaForm1.kbAutmCode.Enabled = (loFormSet.lcTmplate='ENABLE')
  *IF !loFormSet.llBrowse .AND. ;
  loFormSet.AriaForm1.pgfpayInv.pgHead.kbAutmCode.KeyTextBox.OldValue = loFormSet.AriaForm1.kbAutmCode.KeyTextBox.Value
  loFormSet.AriaForm1.pgfpayInv.pgHead.kbAutmCode.ENABLED = (loFormSet.lcTmplate='ENABLE')
  IF !loFormSet.llBrowse .AND. ;
      loFormSet.AriaForm1.pgfpayInv.pgHead.kbAutmCode.KeyTextBox.OldValue = loFormSet.AriaForm1.pgfpayInv.pgHead.kbAutmCode.KeyTextBox.VALUE
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    RETURN
  ENDIF

  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	IF loFormSet.llBrowse .OR. !EMPTY(loFormSet.AriaForm1.kbAutmCode.KeyTextBox.Value) ;
  *!*	  .AND. LASTKEY() = 13
  *!*	  IF loFormSet.llBrowse .OR. !SEEK('T'+loFormSet.AriaForm1.kbAutmCode.KeyTextBox.Value) .OR. ;
  *!*	    ATC("?",loFormSet.AriaForm1.kbAutmCode.KeyTextBox.Value) > 0
  IF loFormSet.llBrowse .OR. !EMPTY(loFormSet.AriaForm1.pgfpayInv.pgHead.kbAutmCode.KeyTextBox.VALUE) ;
      .AND. LASTKEY() = 13
    IF loFormSet.llBrowse .OR. !SEEK('T'+loFormSet.AriaForm1.pgfpayInv.pgHead.kbAutmCode.KeyTextBox.VALUE) .OR. ;
        ATC("?",loFormSet.AriaForm1.pgfpayInv.pgHead.kbAutmCode.KeyTextBox.VALUE) > 0
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      lnClosRec  = RECNO(0)
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *IF SEEK('T')
      IF gfSEEK('T')
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
        DIMENSION laTemp[2]

        laTemp = ''

        *lcSavBrFld = lcBrFields
        *lcSavTitle = lcFile_Ttl

        lcBrFields = "CAUTMCODE :H= 'Template code'"

        lcFile_Ttl = "Automatic invoices header"

        IF BETWEEN(lnClosRec,1,RECCOUNT('APINVAHD'))
          GO lnClosRec
        ELSE
          GO TOP
        ENDIF
 		
 		*! E302623,2 MMT 10/12/2009 Convert Payable invoice screen to use SQL tables[Start]
        *=gfBrows([FOR CAUTMTYPE = 'T'],'CAUTMTYPE,CAUTMCODE','laTemp')
        *! E302623,3 MMT 01/03/2010 Convert Payable invoice screen to use SQL tables[Start]
        *=gfBrows([FOR CAUTMTYPE = 'T'],'CAUTMTYPE,CAUTMCODE','laTemp',lcFile_Ttl )
         =ARIABROW([FOR CAUTMTYPE = 'T'], lcFile_Ttl , .F., .F., .F., .F., .F., .T., ;
               'CAUTMTYPE,CAUTMCODE', 'laTemp', .F., .F., .F., ;
                .F., .F., .F., .F., .F., ;
                .F., .F.)
        *! E302623,3 MMT 01/03/2010 Convert Payable invoice screen to use SQL tables[End]
        *! E302623,2 MMT 10/12/2009 Convert Payable invoice screen to use SQL tables[End]

        *lcBrFields = lcSavBrFld
        *lcFile_Ttl = lcSavTitle

        IF !EMPTY(laTemp[1])
          REPLACE apinvhdr.cautmtype WITH laTemp[1] IN apinvhdr
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
          *loFormSet.AriaForm1.kbAutmCode.KeyTextBox.Value = laTemp[2]
          loFormSet.AriaForm1.pgfpayInv.pgHead.kbAutmCode.KeyTextBox.VALUE = laTemp[2]
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
        ELSE
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
          *!*	        loFormSet.AriaForm1.kbAutmCode.KeyTextBox.Value = ;
          *!*	          loFormSet.AriaForm1.kbAutmCode.KeyTextBox.OldValue
          loFormSet.AriaForm1.pgfpayInv.pgHead.kbAutmCode.KeyTextBox.VALUE = ;
            loFormSet.AriaForm1.pgfpayInv.pgHead.kbAutmCode.KeyTextBox.OldValue
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
        ENDIF
      ELSE
        ** MESSAGE : " There are no records to display. "
        **           "                Ok              "
        =gfModalGen('QRM00052B00000','Dialog')
        
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        *!*	      REPLACE apinvhdr.cautmtype WITH ' ' IN apinvhdr
        *!*	      loFormSet.AriaForm1.kbAutmCode.KeyTextBox.Value = ;
        *!*	        loFormSet.AriaForm1.kbAutmCode.KeyTextBox.OldValue
        REPLACE apinvhdr.cautmtype WITH ' ' IN apinvhdr
        loFormSet.AriaForm1.pgfpayInv.pgHead.kbAutmCode.KeyTextBox.VALUE = ;
          loFormSet.AriaForm1.pgfpayInv.pgHead.kbAutmCode.KeyTextBox.OldValue
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
        
      ENDIF
    ELSE
      
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *IF SEEK('T'+loFormSet.AriaForm1.kbAutmCode.KeyTextBox.Value)
      IF gfSEEK('T'+loFormSet.AriaForm1.pgfpayInv.pgHead.kbAutmCode.KeyTextBox.VALUE)
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
        REPLACE apinvhdr.cautmtype WITH APINVAHD.CAUTMTYPE IN apinvhdr
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        *loFormSet.AriaForm1.kbAutmCode.KeyTextBox.Value  = APINVAHD.CAUTMCODE
        loFormSet.AriaForm1.pgfpayInv.pgHead.kbAutmCode.KeyTextBox.VALUE  = APINVAHD.CAUTMCODE
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      ENDIF
    ENDIF
  ELSE
    REPLACE apinvhdr.cautmtype WITH ' ' IN apinvhdr
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *!*	  loFormSet.AriaForm1.kbAutmCode.KeyTextBox.Value = ;
    *!*	    loFormSet.AriaForm1.kbAutmCode.KeyTextBox.OldValue
    loFormSet.AriaForm1.pgfpayInv.pgHead.kbAutmCode.KeyTextBox.VALUE = ;
      loFormSet.AriaForm1.pgfpayInv.pgHead.kbAutmCode.KeyTextBox.OldValue
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  ENDIF

  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *IF !EMPTY(loFormSet.AriaForm1.kbAutmCode.KeyTextBox.Value)
  IF !EMPTY(loFormSet.AriaForm1.pgfpayInv.pgHead.kbAutmCode.KeyTextBox.VALUE)
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    IF APVENDOR.CTAXTYPE <> APINVAHD.CAUTMBASE
      ** MESSAGE : "You cannot use this distribution    "
      **           "template since the vendor tax type  "
      **           "is  and the template lines uses tax"
      **           "type .                             "
      **           "                 Ok               "
      lcVendTax = IIF(APVENDOR.CTAXTYPE  = 'L','line item tax','percentage of the total')
      lcTempTax = IIF(APINVAHD.CAUTMBASE = 'L','line item tax','percentage of the total')
      =gfModalGen("TRM04109B00000","DIALOG",lcVendTax+"|"+lcTempTax)
      REPLACE apinvhdr.cautmtype WITH ' ' IN apinvhdr
      
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *!*	    loFormSet.AriaForm1.kbAutmCode.KeyTextBox.Value = ;
      *!*	      loFormSet.AriaForm1.kbAutmCode.KeyTextBox.OldValue
      loFormSet.AriaForm1.pgfpayInv.pgHead.kbAutmCode.KeyTextBox.VALUE = ;
        loFormSet.AriaForm1.pgfpayInv.pgHead.kbAutmCode.KeyTextBox.OldValue
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    ELSE
      *Old: IF WVISIBLE('CWRAPDISTR')
      *Old: =gfChClose('CWRAPDISTR')
      *Old: ENDIF
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *!*	    IF loFormSet.DistLines.Visible
      *!*	      loFormSet.DistLines.Visible = .F.
      IF loFormSet.AriaForm1.pgfpayInv.pgDist.ENABLED
        loFormSet.AriaForm1.pgfpayInv.pgDist.ENABLED = .F.
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      ENDIF
    ENDIF
  ENDIF

  loFormSet.llBrowse = .F.
  loFormSet.lcTmplate = 'ENABLE'
  *Old: SHOW GET loFormSet.AriaForm1.kbAutmCode.KeyTextBox.Value  &&lower &&Revise

  SELECT APINVHDR
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  =gfReplace('')
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[ENd]

  RETURN
  *--end of lfvTemplate


  *!*************************************************************
  *! Name      : gfRemit
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 7/29/2004
  *! Purpose   : Global Function.
  *!*************************************************************
  *! Parameters: Many
  *!*************************************************************
  *! Returns   : lcRmtToCode
  *!*************************************************************
FUNCTION gfRemit
  PARAMETERS lcRmtToCode, llActPopup, lcVendCode, lcFactCode, lcRemitStat,;
    lcRemitCmp, lcRemitAd1, lcRemitAd2, lcRemitAd3,lcRemitAd4,lcRemitAd5, lnRow, lnCol,;
    lcArrName, lcDispStr, lnPopWdth
  *** lcRmtToCode : normally ('V', 'F', 'O')
  *** llActPopup  : .T. if the popup is to be activated
  *** lcVendCode  : vendor code
  *** lcFactCode  : factor code
  *** lcRemitStat : remit objects display status
  *** lcRemitCmp  : remit company object name
  *** lcRemitAd1  : remit address1 object name
  *** lcRemitAd2  : remit address2 object name
  *** lcRemitAd3  : remit address(3+4+5) object name
  *** lnRow       : DOS popup top left row
  *** lnCol       : DOS popup top left column
  *** lcArrName   : remit to array name
  *** lcDispStr   : display string of the popup
  *** lnPopWdth   : dos popup width
  *** example call from APPYINV.PRG
  *** laData[5]    = lfRemit(laData[5], !llJustShow, laData[1], laData[36],;
  ***              @lcRemitStat, 'laData[6]', 'laData[7]', 'laData[8]', 'laData[9]',;
  ***              6, 39, 'laRemitTo', @lcRemitTo, lnRemitLen)
  PRIVATE lcRemitFil, lcRemitTag, lcKeyCode

  *Old: IF llActPopup
  *Old: lcRmtToCode = lfvPopups(lcArrName, @lcDispStr,;
  lnRow, lnCol, lnPopWdth)
  *Old: ELSE
  lcRmtToCode = UPPER(ALLTRIM(lcRmtToCode))
  *Old: ENDIF

  lcKeyCode = IIF(lcRmtToCode = 'V', lcVendCode, lcFactCode)
  STORE .F. TO llOpVen, llOpFact

  IF lcRmtToCode = 'V'
    **! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *lcRemitFil = 'APVENDOR'
    lcRemitFil = 'APVENDOR_A'
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    lcRemitTag = 'VENCODE'
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *llOpVen    = gfOpenFile(oAriaApplication.DataDir+'APVENDOR','VENCODE','SH')  &&lower
    llOpVen    = gfOpenTable('APVENDOR','VENCODE','SH','APVENDOR_A')  &&lower
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  ELSE
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *lcRemitFil = 'SYCFACT'
    lcRemitFil = 'SYCFACT_A'
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    lcRemitTag = 'CFACCODE'
    
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *llOpFact   = gfOpenFile(oAriaApplication.SysPath+'SYCFACT','CFACCODE','SH')  &&lower
    llOpFact   = gfOpenTable(oAriaApplication.SysPath+'SYCFACT','CFACCODE','SH','SYCFACT_A')  &&lower
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    
  ENDIF

  DO CASE
    CASE lcRmtToCode $ 'VF'
      
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *IF SEEK(lcKeyCode, lcRemitFil)
        *!*	      &lcRemitCmp  = PADR(IIF(lcRmtToCode = 'V',;
        *!*	                       APVENDOR.cVenComp, SYCFACT.cFacComp), 40)
      IF gfSEEK(lcKeyCode, lcRemitFil)
        &lcRemitCmp  = PADR(IIF(lcRmtToCode = 'V',;
        APVENDOR_A.cVenComp, SYCFACT_A.cFacComp), 40)
		*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
        &lcRemitAd1 = gfGetAdr(lcRemitFil, lcRemitTag,.F.,.F.,1)
        &lcRemitAd2 = gfGetAdr(lcRemitFil, lcRemitTag,.F.,.F.,2)
        &lcRemitAd3 = gfGetAdr(lcRemitFil, lcRemitTag,.F.,.F.,3)
        &lcRemitAd4 = gfGetAdr(lcRemitFil, lcRemitTag,.F.,.F.,4)
        &lcRemitAd5 = gfGetAdr(lcRemitFil, lcRemitTag,.F.,.F.,5)
      ELSE
        STORE SPACE(40) TO &lcRemitCmp, &lcRemitAd1,;
          (lcRemitAd2), (lcRemitAd3),;
          (lcRemitAd4), (lcRemitAd5)
      ENDIF
      lcRemitStat= 'DISABLE'
    OTHERWISE
      lcRemitStat= IIF(loFormSet.ActiveMode="V",'DISABLE','ENABLE')
  ENDCASE

  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *IF USED('APVENDOR') .AND. llOpVen
  IF USED('APVENDOR_A') .AND. llOpVen
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    *=gfCloseFile('APVENDOR')
	*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *USE IN APVENDOR
    =gfCloseTable('APVENDOR_A')
	*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  ENDIF
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *IF USED('SYCFACT') .AND. llOpFact
  IF USED('SYCFACT_A') .AND. llOpFact
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    *=gfCloseFile('SYCFACT')
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *USE IN SYCFACT
    =gfCloseTable('SYCFACT_A')
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  ENDIF
  *Old: SHOW GET (lcRemitCmp) &lcRemitStat &&Revise
  *Old: SHOW GET (lcRemitAd1) &lcRemitStat &&Revise
  *Old: SHOW GET (lcRemitAd2) &lcRemitStat &&Revise
  *Old: SHOW GET (lcRemitAd3) &lcRemitStat &&Revise
  *Old: SHOW GET (lcRemitAd4) &lcRemitStat &&Revise
  *Old: SHOW GET (lcRemitAd5) &lcRemitStat &&Revise
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *IF type('_Screen.ActiveForm.txtOutcomp,Value')='C'
  *WITH _Screen.ActiveForm
  IF TYPE('_Screen.ActiveForm.pgfpayInv.pgHead.txtOutcomp,Value')='C'
    WITH _SCREEN.ACTIVEFORM.pgfpayInv.pgHead
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      STORE (lcRemitStat='ENABLE') TO .txtOutcomp.ENABLED, .txtOutAddr1.ENABLED, ;
        .txtOutAddr2.ENABLED,  .txtOutAddr3.ENABLED
    ENDWITH
  ENDIF
  RETURN lcRmtToCode

  RETURN
  *--end of gfRemit


  *!*************************************************************
  *! Name      : lfGetFac
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 7/29/2004
  *! Purpose   : Global Function used by the validation function of the Factor Control.
  *!*************************************************************
  *! Parameters: lcOldVal, llBrowse
  *!*************************************************************
  *! Returns   : llFactFound
  *!*************************************************************
FUNCTION lfGetFac
  PARAMETERS lcOldVal, llBrowse
  *** Old factor value
  *** .T. if browsed from browsing invisible button
  PRIVATE lcPrFactor, loFactObj, lcCurAlias, lnSavFacTg, lnClosRec,;
    llFactFound, llOpenFact, lcFile_Ttl, lcBrFields
  *! E302678,1 MMT 03/24/2010 Convert Payable invoice screen to use SQL tables[Start]
  TRY 
  *! E302678,1 MMT 03/24/2010 Convert Payable invoice screen to use SQL tables[End]  
  loFactObj    = IIF(TYPE('_Screen.ActiveForm.ActiveControl.value')='C', ;
    _SCREEN.ACTIVEFORM.ACTIVECONTROL, ;
    _SCREEN.ACTIVEFORM.ACTIVECONTROL.PARENT.KeyTextBox)
  lcPrFactor     = ALLTRIM(loFactObj.VALUE)
  *! E302678,1 MMT 03/24/2010 Convert Payable invoice screen to use SQL tables[Start]
  CATCH 
    RETURN .F.
  ENDTRY
  *! E302678,1 MMT 03/24/2010 Convert Payable invoice screen to use SQL tables[End]  
  llFactFound  = .F.

  IF llBrowse .OR. !EMPTY(lcPrFactor)

    lcCurAlias = ALIAS()

    IF !USED('SYCFACT')  && Check if the factors file is open or not.
      llOpenFact  = .T.     && Indicates that the file is open by the function.
      ** Use the file and assign the index.
      SELECT 0
      *USE &oAriaApplication.SysPath.SYCFACT ORDER TAG cFacCode  &&lower
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *    gfOpenFile(oAriaApplication.SysPath+'SYCFACT','CFACCODE','SH')
      gfOpenTable(oAriaApplication.SysPath+'SYCFACT','CFACCODE','SH')
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    ELSE
      llOpenFact = .F.
      SELECT SYCFACT
      
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *!*	    lnSavFacTg = VAL(SYS(21))
      *!*	    SET ORDER TO TAG cFacCode
      lnSavFacTg = ORDER()
      =gfSetOrder('cFacCode')
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    ENDIF

    lcPrFactor   = PADR(ALLTRIM(lcPrFactor), FSIZE('cFacCode','SYCFACT'))
    *Old: &lcFactObj = lcPrFactor
    loFactObj.VALUE = lcPrFactor
    *Old: SHOW GET (lcFactObj) &&Revise

    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    * IF llBrowse .OR. !SEEK(lcPrFactor,'SYCFACT')
    IF llBrowse .OR. !gfSEEK(lcPrFactor,'SYCFACT')
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      *** If a record is to be selected
      DIMENSION laTemp[1]
      laTemp = ''
      lcFile_Ttl = 'Factors'
      lcBrFields = ' '
      lnClosRec = RECNO(0)

      *** Get browse fields from dictionary
      =GFGETBRF(@lcFile_Ttl, @lcBrFields, 'SYCFACT',;  &&lower
      "cFacCode,cFaccomp,cPhoneNo,cFaxNo,cFacTitle,cFacCont")
      IF BETWEEN(lnClosRec,1,RECCOUNT())
        GO lnClosRec
      ELSE
        GO TOP
      ENDIF
	  *! E302623,2 MMT 10/12/2009 Convert Payable invoice screen to use SQL tables[Start]
      *=gfBrows(.F.,'cFacCode','laTemp')
      *! E302623,3 MMT 01/03/2010 Convert Payable invoice screen to use SQL tables[Start]
      *=gfBrows(.F.,'cFacCode','laTemp',lcFile_Ttl)
      =ARIABROW(.F., lcFile_Ttl , .F., .F., .F., .F., .F., .T., ;
               'cFacCode', 'laTemp', .F., .F., .F., ;
                .F., .F., .F., .F., .F., ;
                .F., .F.)
      *! E302623,3 MMT 01/03/2010 Convert Payable invoice screen to use SQL tables[End]
      *! E302623,2 MMT 10/12/2009 Convert Payable invoice screen to use SQL tables[End]
      
      *** If a factor has been selected from the browse
      IF !EMPTY(laTemp[1])
        *Old: &lcFactObj  = laTemp[1]
        loFactObj.VALUE = laTemp[1]
        llFactFound = .T.
      ELSE
        *Old: &lcFactObj  = lcOldVal
        loFactObj.VALUE = loFactObj.OldValue
        llFactFound = .F.
      ENDIF
      *Old: SHOW GET (lcFactObj) &&Revise
    ELSE
      llFactFound = .T.
    ENDIF

    IF USED('SYCFACT')
      IF llOpenFact
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        * USE IN SYCFACT
        =gfCloseTable('SYCFACT')
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      ELSE
        
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        *SET ORDER TO lnSavFacTg IN SYCFACT
        SELECT SYCFACT
        =gfSetOrder(lnSavFacTg)
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      ENDIF
    ENDIF

    SELECT IIF(!EMPTY(lcCurAlias), (lcCurAlias), 0)
  ENDIF

  RETURN llFactFound

  *--end of lfGetFac

  *!*************************************************************
  *! Name      : lfGetAdr
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 7/29/2004
  *! Purpose   : Global Function used by the validation function of the Factor Control.
  *!*************************************************************
  *! Parameters: lcAlias, lcTag, lcKeyCode, lcAdrCode
  *!*************************************************************
  *! Returns   : The Address
  *!*************************************************************
FUNCTION lfGetAdr
  PARAMETERS lcAlias, lcTag, lcKeyCode, lcAdrCode
  *** lcAlias   : source file name
  *** lcTag     : source file tag that is to be used in seeking
  *** lckeycode : search key code (of the source file) (optional)
  *** lcAdrCode : address code (optional)

  PRIVATE lnSavIntTg, lnSavCmpTg, lcCurAlias, lnOldTag,;
    llOpenInt, llOpenCmp, llContinue, laAddress

  DECLARE laAddress[3,2]
  laAddress = " "

  lcTag = IIF(TYPE('lcTag') = 'C' .AND. !EMPTY(lcTag),lcTag,;
    IIF(TYPE('lcAlias') = 'C' .AND. ALIAS() = lcAlias,;
    SYS(22),""))
  IF TYPE('lcAlias') = 'C' .AND. !EMPTY(lcAlias) .AND.;
      !EMPTY(lcTag)

    llContinue = .T.
    lcCurAlias = ALIAS()

    SELECT (lcAlias)
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *!*	  lnOldTag = VAL(SYS(21))
    *!*	  SET ORDER TO TAG (lcTag)
    lnOldTag = ORDER()
    =gfSetOrder(lcTag)
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

    lcAdrCode = IIF(TYPE('lcAdrCode') = 'C'.AND. !EMPTY(lcAdrCode), lcAdrCode,;
      &lcAlias..cCont_Code)
    IF (TYPE('lcKeyCode') = 'C' .AND. !SEEK(lcKeyCode,lcAlias)) ;
        .OR. lcAdrCode <> &lcAlias..cCont_Code
      llContinue = .F.
    ENDIF

    IF llContinue
      STORE .F. TO llOpenInt, llOpenCmp
      *** Check being on a correct alias

      IF !USED('SYCINT')  && Check if the internationals file is open or not.
        llOpenInt  = .T.     && Indicates that the file is open by the function.
        ** Use the file and assign the index.
        *USE &oAriaApplication.SysPath.SYCINT ORDER TAG cContCode IN 0   &&lower
        =oAriaApplication.remotesystemdata.execute("SELECT * FROM SYCINT","", ;
          "SYCINT","",oAriaApplication.SystemConnectionString,3 ,"",SET("Datasession"))
        SELECT SYCINT
        =CURSORSETPROP("Buffering",3,'SYCINT')
        INDEX ON ccont_code TAG cContCode
      ELSE
        SELECT SYCINT
        lnSavIntTg = VAL(SYS(21))
        IF TAGNO('cContCode')<>0
          SET ORDER TO TAG cContCode   && Change the order
        ELSE
          =CURSORSETPROP("Buffering",3,'SYCINT')
          INDEX ON ccont_code TAG cContCode
        ENDIF
      ENDIF

      IF !USED('SYCCOMP')  && Check if the internationals file is open or not.
        llOpenCmp  = .T.     && Indicates that the file is open by the function.
        ** Use the file and assign the index.
        *USE &oAriaApplication.SysPath.SYCCOMP ORDER TAG cComp_ID IN 0   &&lower
        =oAriaApplication.remotesystemdata.execute("SELECT * FROM SYCCOMP","", ;
          "SYCCOMP","",oAriaApplication.SystemConnectionString,3 ,"",SET("Datasession"))
        SELECT SYCCOMP
        =CURSORSETPROP("Buffering",3,'SYCCOMP')
        INDEX ON ccomp_id TAG cComp_ID
      ELSE
        SELECT SYCCOMP
        lnSavCmpTg = VAL(SYS(21))
        IF TAGNO('cComp_ID')<>0
          SET ORDER TO TAG cComp_ID   && Change the order
        ELSE
          =CURSORSETPROP("Buffering",3,'SYCCOMP')
          INDEX ON ccomp_id TAG cComp_ID
        ENDIF
      ENDIF

      IF SEEK(&lcAlias..cCont_Code,'SYCINT');
          .OR. (SEEK(oAriaApplication.ActiveCompanyID,'SYCCOMP') ;
          .AND. SEEK(SYCCOMP.cCont_Code,'SYCINT'))
        laAddress[1,1] = SYCINT.nPart3Ord
        laAddress[1,2] = &lcAlias..cAddress3
        laAddress[2,1] = SYCINT.nPart4Ord
        laAddress[2,2] = &lcAlias..cAddress4
        laAddress[3,1] = SYCINT.nPart5Ord
        laAddress[3,2] = &lcAlias..cAddress5
        =ASORT(laAddress,1)
      ELSE
        laAddress[1,2] = &lcAlias..cAddress3
        laAddress[2,2] = &lcAlias..cAddress4
        laAddress[3,2] = &lcAlias..cAddress5
      ENDIF

      IF USED('SYCCOMP')
        IF llOpenCmp
          USE IN SYCCOMP
        ELSE
          SET ORDER TO lnSavCmpTg IN SYCCOMP
        ENDIF
      ENDIF

      IF USED('SYCINT')
        IF llOpenInt
          USE IN SYCINT
        ELSE
          SET ORDER TO lnSavIntTg IN SYCCOMP
        ENDIF
      ENDIF
    ENDIF
    SET ORDER TO lnOldTag IN (lcAlias)
    SELECT IIF(!EMPTY(lcCurAlias),(lcCurAlias),0)
  ENDIF

  *RETURN PADR(RTRIM(laAddress[1,2]) + RTRIM(laAddress[2,2]) +;
  RTRIM(laAddress[3,2]),40)

  RETURN ALLTRIM(laAddress[1,2]) +" "+ ALLTRIM(laAddress[2,2]) + " " + ALLTRIM(laAddress[3,2])

  *--end of lfGetAdr


  *!*************************************************************
  *! Name      : gfGetBrF
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 7/29/2004
  *! Purpose   : Global Function to Get browse field string,
  *!             used by the validation function of the Factor Control.
  *!*************************************************************
  *! Parameters: lcFileTitl, lcBrowFlds, lcSrchFile, lcFields
  *!*************************************************************
  *! Returns   : llMayProceed
  *!*************************************************************
FUNCTION gfGetBrF
  PARAMETERS lcFileTitl, lcBrowFlds, lcSrchFile, lcFields

  PRIVATE lcCurAlias, lnSavFlsTg, lnSavFldTg, lnFieldNum,;
    llSydFiles, llSydField, llMayProceed, laFields&&Old Afields

  *** Check parameters
  *llMayProceed = TYPE('lcFileTitl'= C) .AND. ;
  *              TYPE('lcBrowFlds'= C)
  llMayProceed = .T.

  IF llMayProceed

    STORE " " TO lcFileTitl, lcBrowFlds

    *** If a file name is not included as a parameter,
    *** use the current work area alias ( if there is any)
    lcCurAlias = ALIAS()

    lcSrchFile   = IIF(TYPE('lcSrchFile') <> 'C' .OR.;
      EMPTY(lcSrchFile), lcCurAlias, lcSrchFile)

    IF !EMPTY(lcSrchFile)

      IF !USED('SYDFILES')  && Check if the internationals file is open or not.
        llSydFiles   = .T.     && Indicates that the file is open by the function.
        *** Use the file and assign the index.
        *USE &oAriaApplication.SysPath.SYDFILES ORDER TAG cFile_Nam IN 0   &&lower
        =oAriaApplication.remotesystemdata.execute("SELECT * FROM SYDFILES","", ;
          "SYDFILES","",oAriaApplication.SystemConnectionString,3 ,"",SET("Datasession"))
        SELECT SYDFILES
        =CURSORSETPROP("Buffering",3,'SYDFILES')
        INDEX ON cfile_nam TAG cFile_Nam

      ELSE
        llSydFiles   = .F.
        SELECT SYDFILES
        lnSavFlsTg = VAL(SYS(21))
        IF TAGNO('cFile_Nam')<>0
          SET ORDER TO TAG cFile_Nam   && Change the order
        ELSE
          =CURSORSETPROP("Buffering",3,'SYDFILES')
          INDEX ON cfile_nam TAG cFile_Nam
        ENDIF
      ENDIF

      IF !USED('SYDFIELD')  && Check if the internationals file is open or not.
        llSydField  = .T.     && Indicates that the file is open by the function.
        *** Use the file and assign the index.
        *USE &oAriaApplication.SysPath.SYDFIELD ORDER TAG cFld_Name IN 0   &&lower
        =oAriaApplication.remotesystemdata.execute("SELECT * FROM SYDFIELD","", ;
          "SYDFIELD","",oAriaApplication.SystemConnectionString,3 ,"",SET("Datasession"))
        SELECT SYDFIELD
        =CURSORSETPROP("Buffering",3,'SYDFIELD')
        INDEX ON cfld_name TAG cFld_Name

      ELSE
        llSydField       = .F.
        SELECT SYDFIELD
        lnSavFldTg = VAL(SYS(21))
        IF TAGNO('cFld_Name')<>0
          SET ORDER TO TAG cFld_Name    && Change the order
        ELSE
          =CURSORSETPROP("Buffering",3,'SYDFIELD')
          INDEX ON cfld_name TAG cFld_Name
        ENDIF
      ENDIF

      DECLARE laFields[1,1]
      laFields   = " "

      lcFileTitl = ALLTRIM(LOOKUP(SYDFILES.cFile_Ttl, UPPER(ALLTRIM(lcSrchFile)),;
        SYDFILES.cFile_Nam, 'cFile_Nam'))
      lcFields   = IIF(TYPE('lcFields') <> 'C' .OR. EMPTY(lcFields),;
        STRTRAN(SYDFILES.mBrow_Fld, '|', ','), lcFields)

      =gfSubStr(lcFields, @laFields, ",")
      FOR lnFieldNum = 1 TO ALEN(laFields,1)
        lcBrowFlds = lcBrowFlds + laFields[lnFieldNum]+;
          [:H=']+ALLTRIM(LOOKUP(SYDFIELD.cFld_Head,;
          UPPER(ALLTRIM(laFields[lnFieldNum])),;&&Old Afields
        SYDFIELD.cFld_Name,;
          'cFld_Name'))+[',]
      ENDFOR
      lcBrowFlds  = SUBSTR(lcBrowFlds, 1, LEN(lcBrowFlds)-1)

      IF USED('SYDFILES')
        IF llSydFiles
          USE IN SYDFILES
        ELSE
          SET ORDER TO lnSavFlsTg IN SYDFILES
        ENDIF
      ENDIF

      IF USED('SYDFIELD')
        IF llSydField
          USE IN SYDFIELD
        ELSE
          SET ORDER TO lnSavFldTg IN SYDFIELD
        ENDIF
      ENDIF

      SELECT IIF(!EMPTY(lcCurAlias),(lcCurAlias),0)
    ELSE
      llMayProceed = .F.
    ENDIF
  ENDIF

  RETURN llMayProceed

  *--end of gfGetBrF

  ***xxx***



  ***zzz***

  *!*************************************************************
  *! Name      : lfvAprovPay
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 8/3/2004
  *! Purpose   : Function called from Click Event of The Approve For Payment Button.
  *!*************************************************************
  *! Parameters: The FormSet
  *!*************************************************************
  *! Returns   : None
  *!*************************************************************
FUNCTION lfvAprovPay
  
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *LPARAMETERS loFormSet
  PARAMETERS loFormSet
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  LOCAL lcTemp, lcExSin4


  IF APVENDOR.CVENPRIOR = '0'
    lcvendorr=ALLTRIM(APVENDOR.CVENDCODE)
    ** MESSAGE : " Vendor XXXXXX has payment priority 0."
    **           " This vendor in on hold.              "
    =gfModalGen("TRM04060B00000","DIALOG",lcvendorr)
    IF loFormSet.lnTotAppPay = 0
      RETURN
    ENDIF
  ENDIF
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	llopchk = gfOpenFile(oAriaApplication.DataDir+'APCHECKS','BANKCHECK','SH')
  *!*	llopBNK = gfOpenFile(oAriaApplication.DataDir+'APBANKS','BANKCODE','SH')
  llopchk = gfOpenTable('APCHECKS','BANKCHECK','SH')
  llopBNK = gfOpenTable('APBANKS','BANKCODE','SH')
  SELECT APCHECKS
  =gfSeek('')
  SELECT APBANKS
  =gfSeek('')
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  
  ** If bank code in the vendor file is not empty.

  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	IF loFormSet.AriaForm1.cboVendPmeth.Value <> 'C'
  IF loFormSet.AriaForm1.pgfpayInv.pgHead.cboVendPmeth.VALUE <> 'C'
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[END]
    loFormSet.lcBankCode = apinvhdr.cbnkcode
    loFormSet.lcCheckAcc = apinvhdr.cchkacct
    loFormSet.lcGLAcount = apinvhdr.cchkglacc
    loFormSet.lcApprPay  = apinvhdr.ninvamtap

    loFormSet.lnFAAp = apinvhdr.ninvfaap

    loFormSet.lcApprDis  = apinvhdr.ninvdisap
    loFormSet.lc1099Amnt = apinvhdr.ninva1099
    loFormSet.lcApprAdj  = apinvhdr.ninvadjap
	*! E302623,3 MMT 01/03/2010 Convert Payable invoice screen to use SQL tables[Start]
	*lcAprCurr  = apinvhdr.caprcurcod
    loFormSet.lcAprCurr  = apinvhdr.caprcurcod
    *! E302623,3 MMT 01/03/2010 Convert Payable invoice screen to use SQL tables[End]
    loFormSet.lnAprRate  = apinvhdr.naprexrat
    loFormSet.lnAprUnit  = apinvhdr.naprcurunt

  ENDIF
  IF !loFormSet.ActiveMode="V"
    DO CASE
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        * CASE loFormSet.AriaForm1.cboVendPmeth.Value $ 'PMN'
      CASE loFormSet.AriaForm1.pgfpayInv.pgHead.cboVendPmeth.VALUE $ 'PMN'
       *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[END]
        IF EMPTY(apinvhdr.ninvamtap)
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
          *!*	        REPLACE apinvhdr.ninvamtap WITH loFormSet.AriaForm1.txtInvAmount.Value - apinvhdr.ninvpaid - ;
          *!*	                                        apinvhdr.ninvadj - apinvhdr.ninvdistk - ;
          *!*	                                        IIF(apinvhdr.ninvdistk < loFormSet.AriaForm1.txtInvDisof.Value,;
          *!*	                                        loFormSet.AriaForm1.txtInvDisof.Value - apinvhdr.ninvdistk,0)
          REPLACE apinvhdr.ninvamtap WITH loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.VALUE - apinvhdr.ninvpaid - ;
            apinvhdr.ninvadj - apinvhdr.ninvdistk - ;
            IIF(apinvhdr.ninvdistk < loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvDisof.VALUE,;
            loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvDisof.VALUE - apinvhdr.ninvdistk,0)
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
          IF EMPTY(apinvhdr.ninvdisap)
            *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
            *!*	          REPLACE apinvhdr.ninvdisap WITH IIF(apinvhdr.ninvdistk < loFormSet.AriaForm1.txtInvDisof.Value,;
            *!*	                                              loFormSet.AriaForm1.txtInvDisof.Value - apinvhdr.ninvdistk,0)
            REPLACE apinvhdr.ninvdisap WITH IIF(apinvhdr.ninvdistk < loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvDisof.VALUE,;
              loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvDisof.VALUE - apinvhdr.ninvdistk,0)
            *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
          ENDIF
        ENDIF

        IF EMPTY(apinvhdr.cbnkcode)
          llBnkChkChng = .F.
          IF !EMPTY(APVENDOR.CBNKCODE)
            *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
            *!*	          REPLACE apinvhdr.cbnkcode WITH APVENDOR.CBNKCODE && Assign the bank code from vendor.
            *!*	          REPLACE apinvhdr.cchkacct WITH APVENDOR.CCHKACCT && Assign the check code from vendor.
			SELECT apinvhdr
            gfREPLACE("cbnkcode WITH APVENDOR.CBNKCODE") && Assign the bank code from vendor.
            gfREPLACE("cchkacct WITH APVENDOR.CCHKACCT") && Assign the check code from vendor.
            *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
            llBnkChkChng = .T.
          ELSE
            IF !EMPTY(APDIV.CBNKCODE)
              *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
              *!*	            REPLACE apinvhdr.cbnkcode WITH APDIV.CBNKCODE  && Assign the bank code from division.
              *!*	            REPLACE apinvhdr.cchkacct WITH APDIV.CCHKACCT  && Assign the bank code from division.
              SELECT apinvhdr
              gfREPLACE("cbnkcode WITH APDIV.CBNKCODE")  && Assign the bank code from division.
              gfREPLACE("cchkacct WITH APDIV.CCHKACCT")  && Assign the bank code from division.
              *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[END]
              llBnkChkChng = .T.
            ELSE
              *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
              *!*	            REPLACE apinvhdr.cbnkcode WITH APSETUP.CBNKCODE  && Assign the bank code from division.
              *!*	            REPLACE apinvhdr.cchkacct WITH APSETUP.CCHKACCT  && Assign the bank code from division.
              SELECT apinvhdr
              gfREPLACE("cbnkcode WITH APSETUP.CBNKCODE")  && Assign the bank code from division.
              gfREPLACE("cchkacct WITH APSETUP.CCHKACCT")  && Assign the bank code from division.
              *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
              llBnkChkChng = .T.
            ENDIF
          ENDIF

          IF llBnkChkChng
            *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
            *!*	          IF SEEK(apinvhdr.cbnkcode+apinvhdr.cchkacct,'APCHECKS')
            *!*	            REPLACE apinvhdr.cchkglacc WITH IIF(!EMPTY(APCHECKS.CCHKGLACC),;
            *!*	                                                APCHECKS.CCHKGLACC,loFormSet.AriaForm1.ap1.lcemptyacc)
            IF gfSEEK(apinvhdr.cbnkcode+apinvhdr.cchkacct,'APCHECKS')
              SELECT apinvhdr
              gfREPLACE("cchkglacc WITH '"+IIF(!EMPTY(APCHECKS.CCHKGLACC),;
                APCHECKS.CCHKGLACC,loFormSet.AriaForm1.ap1.lcemptyacc)+"'")
            *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
            ENDIF
          ENDIF

          IF gfGetMemVar('LLMULCURR') .AND. !EMPTY(apinvhdr.cchkacct)
            *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
            *!*	          IF SEEK(apinvhdr.cbnkcode+apinvhdr.cchkacct,'APCHECKS')
            *!*	            REPLACE apinvhdr.caprcurcod WITH IIF(EMPTY(APCHECKS.CCURRCODE),;
            *!*	                                                 loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value,;
            *!*	                                                 APCHECKS.CCURRCODE)
            IF gfSEEK(apinvhdr.cbnkcode+apinvhdr.cchkacct,'APCHECKS')
              SELECT apinvhdr
              gfREPLACE("caprcurcod WITH '"+IIF(EMPTY(APCHECKS.CCURRCODE),;
                loFormSet.AriaForm1.pgfpayInv.pgHead.kbCurrCode.KeyTextBox.VALUE,;
                APCHECKS.CCURRCODE)+"'")
            *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
            ELSE
              *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
              *REPLACE apinvhdr.caprcurcod WITH loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value
              gfREPLACE("caprcurcod WITH '"+loFormSet.AriaForm1.pgfpayInv.pgHead.kbCurrCode.KeyTextBox.VALUE+"'")
              *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
            ENDIF
          ELSE
            *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
            *REPLACE apinvhdr.caprcurcod WITH loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value
            SELECT apinvhdr
            gfREPLACE("caprcurcod WITH '"+loFormSet.AriaForm1.pgfpayInv.pgHead.kbCurrCode.KeyTextBox.VALUE+"'")
            *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[end]
          ENDIF


          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
          *IF apinvhdr.caprcurcod = loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value
          *!*	          REPLACE apinvhdr.naprexrat WITH 1
          *!*	          REPLACE apinvhdr.naprcurunt WITH 1
          IF apinvhdr.caprcurcod = loFormSet.AriaForm1.pgfpayInv.pgHead.kbCurrCode.KeyTextBox.VALUE
            SELECT apinvhdr
            gfREPLACE("naprexrat WITH 1")
            gfREPLACE("naprcurunt WITH 1")
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
          ELSE
            *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
            *IF loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value = oAriaApplication.BaseCurrency
            IF loFormSet.AriaForm1.pgfpayInv.pgHead.kbCurrCode.KeyTextBox.VALUE = oAriaApplication.BaseCurrency
            *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
              PRIVATE aprcurunt
              aprcurunt = apinvhdr.naprcurunt
              *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
              *!*	            REPLACE apinvhdr.naprexrat WITH gfChkRate('aprcurunt',;
              *!*	                                                      apinvhdr.caprcurcod,;
              *!*	                                                      loFormSet.AriaForm1.DtInvDate.Value,.F.,.F.,;
              *!*	                                                      loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value)
              *!*	            REPLACE apinvhdr.naprcurunt WITH aprcurunt
              ldDateInv = loFormSet.AriaForm1.pgfpayInv.pgHead.DtInvDate.VALUE
              lcCurCode = loFormSet.AriaForm1.pgfpayInv.pgHead.kbCurrCode.KeyTextBox.VALUE
              SELECT apinvhdr
              gfREPLACE("naprexrat WITH gfChkRate('aprcurunt',apinvhdr.caprcurcod,ldDateInv ,.F.,.F.,lcCurCode)")

              gfREPLACE("naprcurunt WITH aprcurunt")
              *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
            ELSE
              PRIVATE aprcurunt
              aprcurunt = apinvhdr.naprcurunt
              *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
              *!*	            REPLACE apinvhdr.naprexrat WITH gfChkRate('aprcurunt',;
              *!*	                                                      loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value,;
              *!*	                                                      loFormSet.AriaForm1.DtInvDate.Value,.F.,.F.,;
              *!*	                                                      apinvhdr.caprcurcod)
              *!*	            REPLACE apinvhdr.naprcurunt WITH aprcurunt
              ldDateInv = loFormSet.AriaForm1.pgfpayInv.pgHead.DtInvDate.VALUE
              lcCurCode = loFormSet.AriaForm1.pgfpayInv.pgHead.kbCurrCode.KeyTextBox.VALUE
              SELECT apinvhdr
              gfREPLACE("naprexrat WITH gfChkRate('aprcurunt',"+;
                "lcCurCode ,"+;
                "ldDateInv ,.F.,.F.,"+;
                "apinvhdr.caprcurcod)")
              gfREPLACE("naprcurunt WITH aprcurunt")
              *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
            ENDIF

          ENDIF
        ENDIF

        loFormSet.lcExSin4 = ' '

        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        *IF loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value = oAriaApplication.BaseCurrency
        IF loFormSet.AriaForm1.pgfpayInv.pgHead.kbCurrCode.KeyTextBox.VALUE = oAriaApplication.BaseCurrency
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
          lcExSin4 = loFormSet.lcExSin4
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
          *!*	        loFormSet.lcExSin3 = gfGetExSin(@lcExSin4,apinvhdr.caprcurcod,;
          *!*	                                        loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value)
          loFormSet.lcExSin3 = gfGetExSin(@lcExSin4,apinvhdr.caprcurcod,;
            loFormSet.AriaForm1.pgfpayInv.pgHead.kbCurrCode.KeyTextBox.VALUE)
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

          loFormSet.lcExSin4 = lcExSin4
          loFormSet.lcExSin3 = IIF(loFormSet.lcExSin3 = '*' , '/' , '*')
          loFormSet.lcExSin4 = IIF(loFormSet.lcExSin4 = '*' , '/' , '*')
        ELSE
          lcExSin4 = loFormSet.lcExSin4
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
          *!*	        loFormSet.lcExSin3 = gfGetExSin(@lcExSin4,;
          *!*	                                        loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value,;
          *!*	                                        apinvhdr.caprcurcod)
          loFormSet.lcExSin3 = gfGetExSin(@lcExSin4,;
            loFormSet.AriaForm1.pgfpayInv.pgHead.kbCurrCode.KeyTextBox.VALUE,;
            apinvhdr.caprcurcod)
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

          loFormSet.lcExSin4 = lcExSin4
        ENDIF


        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        *        IF loFormSet.ActiveMode="A" .AND. loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value = apinvhdr.caprcurcod
        *!*	        REPLACE apinvhdr.naprexrat WITH 1
        *!*	        REPLACE apinvhdr.naprcurunt WITH 1
        IF loFormSet.ActiveMode="A" .AND. loFormSet.AriaForm1.pgfpayInv.pgHead.kbCurrCode.KeyTextBox.VALUE = apinvhdr.caprcurcod
          SELECT apinvhdr
          gfREPLACE("naprexrat WITH 1")
          gfREPLACE("naprcurunt WITH 1")
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
        ENDIF

        lcTemp = 'apinvhdr.ninvamtap'+loFormSet.lcExSin3+'apinvhdr.naprexrat'+;
          loFormSet.lcExSin4+'apinvhdr.naprcurunt'
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        *REPLACE apinvhdr.ninvfaap WITH ROUND(&lcTemp,2)
        SELECT apinvhdr
        gfREPLACE("ninvfaap WITH ROUND(&lcTemp,2)")
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

        *Old: ON KEY LABEL ESC DO lfvCanPay
        loFormSet.lcOldGlAcc = apinvhdr.cchkglacc

        IF gfGetMemVar('LLMULCURR')
          * DO APAPROVC.SPR  && Approved screen if multi currency = .T.
          *Old: DO (oAriaApplication.ScreenHome + oAriaApplication.ActiveModuleID + '\APAPROVC.SPR')
          DO FORM (oAriaApplication.ScreenHome+"AP\APAPROV.SCX") WITH loFormSet.AriaForm1

        ELSE
          * DO APAPROV.SPR  && Approved screen if multi currency = .F.
          *Old: DO (oAriaApplication.ScreenHome + oAriaApplication.ActiveModuleID + '\APAPROV.SPR')
          DO FORM (oAriaApplication.ScreenHome+"AP\APAPROV.SCX") WITH loFormSet.AriaForm1
          
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
          *REPLACE apinvhdr.ninvfaap WITH apinvhdr.ninvamtap
          *! E302623,2 MMT 10/11/2009 Convert Payable invoice screen to use SQL tables[Start]
          SELECT apinvhdr
          *! E302623,2 MMT 10/11/2009 Convert Payable invoice screen to use SQL tables[End]
          gfREPLACE("ninvfaap WITH apinvhdr.ninvamtap")
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

        ENDIF
        *Old: ON KEY LABEL ESC DO lfEscap

        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        *!*	    CASE loFormSet.AriaForm1.cboVendPmeth.Value = 'H'
      CASE loFormSet.AriaForm1.pgfpayInv.pgHead.cboVendPmeth.VALUE = 'H'
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
        IF EMPTY(apinvhdr.ninvamtap)
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
          *!*	        REPLACE apinvhdr.ninvamtap WITH loFormSet.AriaForm1.txtInvAmount.Value - apinvhdr.ninvpaid - ;
          *!*	                                        apinvhdr.ninvadj - apinvhdr.ninvdistk - ;
          *!*	                                        IIF(apinvhdr.ninvdistk < loFormSet.AriaForm1.txtInvDisof.Value,;
          *!*	                                        loFormSet.AriaForm1.txtInvDisof.Value - apinvhdr.ninvdistk,0)
		  SELECT apinvhdr
          gfREPLACE("ninvamtap WITH loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.Value - apinvhdr.ninvpaid -"+ ;
            "apinvhdr.ninvadj - apinvhdr.ninvdistk - "+;
            "IIF(apinvhdr.ninvdistk < loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvDisof.Value,"+;
            "loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvDisof.Value - apinvhdr.ninvdistk,0)")

          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
          IF EMPTY(apinvhdr.ninvdisap)
            *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
            *!*	          REPLACE apinvhdr.ninvdisap WITH IIF(apinvhdr.ninvdistk < loFormSet.AriaForm1.txtInvDisof.Value,;
            *!*	                                              loFormSet.AriaForm1.txtInvDisof.Value - ;
            *!*	                                              apinvhdr.ninvdistk,0)
            SELECT apinvhdr
            gfREPLACE("ninvdisap WITH IIF(apinvhdr.ninvdistk < loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvDisof.Value,"+;
              "loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvDisof.Value - "+;
              "apinvhdr.ninvdistk,0)")

            *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
          ENDIF
        ENDIF
        IF EMPTY(STRTRAN(STRTRAN(apinvhdr.cchkglacc,'-'),'0'))
          DO CASE
            CASE !EMPTY(APVENDOR.CCASHACCT)
              *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
              *REPLACE apinvhdr.cchkglacc WITH APVENDOR.CCASHACCT
              *CASE !EMPTY(loFormSet.AriaForm1.cboDivision.Value) .AND. !EMPTY(APDIV.CCASHACCT)
              *REPLACE apinvhdr.cchkglacc WITH APDIV.CCASHACCT
              SELECT apinvhdr
              gfREPLACE("cchkglacc WITH APVENDOR.CCASHACCT")
            CASE !EMPTY(loFormSet.AriaForm1.pgfpayInv.pgHead.cboDivision.VALUE) .AND. !EMPTY(APDIV.CCASHACCT)
	          SELECT apinvhdr
              gfREPLACE("cchkglacc WITH APDIV.CCASHACCT")
              *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
            OTHERWISE
              *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
              *REPLACE apinvhdr.cchkglacc WITH APDIV.CCASHACCT
              SELECT apinvhdr
              gfREPLACE("cchkglacc WITH APSETUP.CCASHACCT")
              *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
          ENDCASE
        ENDIF

        IF EMPTY(apinvhdr.caprcurcod)
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
          *REPLACE apinvhdr.caprcurcod WITH loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value
          SELECT apinvhdr
          gfREPLACE("caprcurcod WITH loFormSet.AriaForm1.pgfpayInv.pgHead.kbCurrCode.KeyTextBox.Value")
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
        ENDIF


        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        *      IF loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value = apinvhdr.caprcurcod
        *!*	        REPLACE apinvhdr.naprexrat WITH 1
        *!*	        REPLACE apinvhdr.naprcurunt WITH 1
        IF loFormSet.AriaForm1.pgfpayInv.pgHead.kbCurrCode.KeyTextBox.VALUE = apinvhdr.caprcurcod
          SELECT apinvhdr
          gfREPLACE("naprexrat WITH 1")
          gfREPLACE("naprcurunt WITH 1")
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
        ENDIF

        loFormSet.lcExSin4 = ' '
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        *IF loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value = oAriaApplication.BaseCurrency
        IF loFormSet.AriaForm1.pgfpayInv.pgHead.kbCurrCode.KeyTextBox.VALUE = oAriaApplication.BaseCurrency
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
          lcExSin4 = loFormSet.lcExSin4
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
          *loFormSet.lcExSin3 = gfGetExSin(@lcExSin4,apinvhdr.caprcurcod,loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value)
          loFormSet.lcExSin3 = gfGetExSin(@lcExSin4,apinvhdr.caprcurcod,loFormSet.AriaForm1.pgfpayInv.pgHead.kbCurrCode.KeyTextBox.VALUE)
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
          loFormSet.lcExSin4 = lcExSin4
          loFormSet.lcExSin3 = IIF(loFormSet.lcExSin3 = '*' , '/' , '*')
          loFormSet.lcExSin4 = IIF(loFormSet.lcExSin4 = '*' , '/' , '*')
          loFormSet.lcExSin4 = lcExSin4
        ELSE
          lcExSin4 = loFormSet.lcExSin4
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
          *loFormSet.lcExSin3 = gfGetExSin(@lcExSin4,loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value,apinvhdr.caprcurcod)    &&lower  &&lower
          loFormSet.lcExSin3 = gfGetExSin(@lcExSin4,loFormSet.AriaForm1.pgfpayInv.pgHead.kbCurrCode.KeyTextBox.VALUE,apinvhdr.caprcurcod)    &&lower  &&lower
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
          loFormSet.lcExSin4 = lcExSin4
        ENDIF

        lcTemp = 'apinvhdr.ninvamtap'+loFormSet.lcExSin3+'apinvhdr.naprexrat'+;
          loFormSet.lcExSin4+'apinvhdr.naprcurunt'
        REPLACE apinvhdr.ninvfaap WITH ROUND(&lcTemp,2)

        *Old: ON KEY LABEL ESC DO lfvCanPay
        loFormSet.lcOldGlAcc = apinvhdr.cchkglacc

        IF gfGetMemVar('LLMULCURR')
          * DO APCSHPYC.SPR  && Approved screen if multi currency = .T.
          *Old: DO (oAriaApplication.ScreenHome + oAriaApplication.ActiveModuleID + '\APCSHPYC.SPR')
          DO FORM (oAriaApplication.ScreenHome+"AP\APAPROV.SCX") WITH loFormSet.AriaForm1


        ELSE
          * DO APCASHPY.SPR  && Approved screen if multi currency = .F.
          *Old: DO (oAriaApplication.ScreenHome + oAriaApplication.ActiveModuleID + '\APCASHPY.SPR')
          DO FORM (oAriaApplication.ScreenHome+"AP\APAPROV.SCX") WITH loFormSet.AriaForm1

          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
          *REPLACE apinvhdr.ninvfaap WITH apinvhdr.ninvamtap
          gfREPLACE('ninvfaap WITH apinvhdr.ninvamtap')
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

        ENDIF
        *Old: ON KEY LABEL ESC DO lfEscap
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        *!*	    CASE loFormSet.AriaForm1.cboVendPmeth.Value = 'C'
      CASE loFormSet.AriaForm1.pgfpayInv.pgHead.cboVendPmeth.VALUE = 'C'
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
        *Old: ON KEY LABEL ESC

        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        *!*	      REPLACE apinvhdr.caprcurcod WITH loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value
        *!*	      REPLACE apinvhdr.naprexrat WITH loFormSet.AriaForm1.txtNexRate.Value
        *!*	      REPLACE apinvhdr.naprcurunt WITH apinvhdr.ncurrunit
        SELECT apinvhdr
        gfREPLACE("caprcurcod WITH loFormSet.AriaForm1.pgfpayInv.pgHead.kbCurrCode.KeyTextBox.Value")
        gfREPLACE("naprexrat WITH loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.Value")
        gfREPLACE("naprcurunt WITH apinvhdr.ncurrunit")
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
        *E300683,1 Call *.SPR from screens directory
        * DO APINVCRD.SPR
        *Old: DO (oAriaApplication.ScreenHome + oAriaApplication.ActiveModuleID + '\APINVCRD.SPR')
        DO FORM (oAriaApplication.ScreenHome+"AP\APINVCRD.SCX") WITH loFormSet.AriaForm1
        *E300683,1 end
        *Old: ON KEY LABEL ESC DO lfEscap
    ENDCASE
  ELSE
    DO CASE
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        *!*	    CASE loFormSet.AriaForm1.cboVendPmeth.Value = 'H'
      CASE loFormSet.AriaForm1.pgfpayInv.pgHead.cboVendPmeth.VALUE = 'H'
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[END]
        *Old: ON KEY LABEL ESC DO lfvCanPay
        loFormSet.lcOldGlAcc = apinvhdr.cchkglacc  &&lower

        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        *IF loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value = oAriaApplication.BaseCurrency
        IF loFormSet.AriaForm1.pgfpayInv.pgHead.kbCurrCode.KeyTextBox.VALUE = oAriaApplication.BaseCurrency
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
          lcExSin4 = loFormSet.lcExSin4
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
          *loFormSet.lcExSin3 = gfGetExSin(@lcExSin4,apinvhdr.caprcurcod,loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value)    &&lower  &&lower
          loFormSet.lcExSin3 = gfGetExSin(@lcExSin4,apinvhdr.caprcurcod,loFormSet.AriaForm1.pgfpayInv.pgHead.kbCurrCode.KeyTextBox.VALUE)    &&lower  &&lower
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
          loFormSet.lcExSin4 = lcExSin4
          loFormSet.lcExSin3 = IIF(loFormSet.lcExSin3 = '*' , '/' , '*')
          loFormSet.lcExSin4 = IIF(loFormSet.lcExSin4 = '*' , '/' , '*')
        ELSE
          lcExSin4 = loFormSet.lcExSin4
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
          *loFormSet.lcExSin3 = gfGetExSin(@lcExSin4,loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value,apinvhdr.caprcurcod)    &&lower  &&lower
          loFormSet.lcExSin3 = gfGetExSin(@lcExSin4,loFormSet.AriaForm1.pgfpayInv.pgHead.kbCurrCode.KeyTextBox.VALUE,apinvhdr.caprcurcod)    &&lower  &&lower
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
          loFormSet.lcExSin4 = lcExSin4
        ENDIF

        lcTemp = 'apinvhdr.ninvamtap'+loFormSet.lcExSin3+'apinvhdr.naprexrat'+;
          loFormSet.lcExSin4+'apinvhdr.naprcurunt'
        apinvhdr.ninvfaap = ROUND(&lcTemp,2)


        IF gfGetMemVar('LLMULCURR')
          * DO APCSHPYC.SPR && Approved screen if multi currency = .T.
          *Old: DO (oAriaApplication.ScreenHome + oAriaApplication.ActiveModuleID + '\APCSHPYC.SPR')
          DO FORM (oAriaApplication.ScreenHome+"AP\APAPROV.SCX") WITH loFormSet.AriaForm1

        ELSE
          * DO APCASHPY.SPR && Approved screen if multi currency = .F.
          *Old: DO (oAriaApplication.ScreenHome + oAriaApplication.ActiveModuleID + '\APCASHPY.SPR')
          DO FORM (oAriaApplication.ScreenHome+"AP\APAPROV.SCX") WITH loFormSet.AriaForm1
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
          *        REPLACE apinvhdr.ninvfaap WITH apinvhdr.ninvamtap
          SELECT apinvhdr
          gfREPLACE("ninvfaap WITH apinvhdr.ninvamtap")
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
        ENDIF
        *Old: ON KEY LABEL ESC DO lfEscap
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        *!*	    CASE loFormSet.AriaForm1.cboVendPmeth.Value $ 'PMN'
      CASE loFormSet.AriaForm1.pgfpayInv.pgHead.cboVendPmeth.VALUE $ 'PMN'
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
        *Old: ON KEY LABEL ESC DO lfvCanPay
        loFormSet.lcOldGlAcc = apinvhdr.cchkglacc

        loFormSet.lcExSin4 = ' '
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        *IF loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value = oAriaApplication.BaseCurrency
        IF loFormSet.AriaForm1.pgfpayInv.pgHead.kbCurrCode.KeyTextBox.VALUE = oAriaApplication.BaseCurrency
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

          lcExSin4 = loFormSet.lcExSin4
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
          *loFormSet.lcExSin3 = gfGetExSin(@lcExSin4,apinvhdr.caprcurcod,loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value)    &&lower  &&lower
          loFormSet.lcExSin3 = gfGetExSin(@lcExSin4,apinvhdr.caprcurcod,loFormSet.AriaForm1.pgfpayInv.pgHead.kbCurrCode.KeyTextBox.VALUE)    &&lower  &&lower
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
          loFormSet.lcExSin4 = lcExSin4
          loFormSet.lcExSin3 = IIF(loFormSet.lcExSin3 = '*' , '/' , '*')
          loFormSet.lcExSin4 = IIF(loFormSet.lcExSin4 = '*' , '/' , '*')
        ELSE
          lcExSin4 = loFormSet.lcExSin4
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
          *loFormSet.lcExSin3 = gfGetExSin(@lcExSin4,loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value,apinvhdr.caprcurcod)    &&lower  &&lower
          loFormSet.lcExSin3 = gfGetExSin(@lcExSin4,loFormSet.AriaForm1.pgfpayInv.pgHead.kbCurrCode.KeyTextBox.VALUE,apinvhdr.caprcurcod)    &&lower  &&lower
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
          loFormSet.lcExSin4 = lcExSin4
        ENDIF

        lcTemp = 'apinvhdr.ninvamtap'+loFormSet.lcExSin3+'apinvhdr.naprexrat'+;
          loFormSet.lcExSin4+'apinvhdr.naprcurunt'
        REPLACE apinvhdr.ninvfaap WITH ROUND(&lcTemp,2)

        IF gfGetMemVar('LLMULCURR')
          * DO APAPROVC.SPR && Approved screen if multi currency = .T.
          *Old: DO (oAriaApplication.ScreenHome + oAriaApplication.ActiveModuleID + '\APAPROVC.SPR')
          DO FORM (oAriaApplication.ScreenHome+"AP\APAPROV.SCX") WITH loFormSet.AriaForm1

        ELSE
          * DO APAPROV.SPR && Approved screen if multi currency = .F.
          *Old: DO (oAriaApplication.ScreenHome + oAriaApplication.ActiveModuleID + '\APAPROV.SPR')  &&lower  &&lower
          DO FORM (oAriaApplication.ScreenHome+"AP\APAPROV.SCX") WITH loFormSet.AriaForm1
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
          *REPLACE apinvhdr.ninvfaap WITH apinvhdr.ninvamtap
          SELECT apinvhdr
          gfREPLACE("ninvfaap WITH apinvhdr.ninvamtap")
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

        ENDIF
        *Old: ON KEY LABEL ESC DO lfEscap
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        *!*	    CASE loFormSet.AriaForm1.cboVendPmeth.Value = 'C'
      CASE loFormSet.AriaForm1.pgfpayInv.pgHead.cboVendPmeth.VALUE = 'C'
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
        *Old: ON KEY LABEL ESC
        * DO APINVCRD.SPR
        *Old: DO (oAriaApplication.ScreenHome + oAriaApplication.ActiveModuleID + '\APINVCRD.SPR')
        DO FORM (oAriaApplication.ScreenHome+"AP\APINVCRD.SCX") WITH loFormSet.AriaForm1
        *Old: ON KEY LABEL ESC DO lfEscap
    ENDCASE
  ENDIF

  loFormSet.lnTotAppPay = apinvhdr.ninvamtap + apinvhdr.ninvdisap + apinvhdr.ninvadjap
  IF USED('APCHECKS') .AND. llopchk
    *Odl: =gfCloseFile('APCHECKS')
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *USE IN APCHECKS
    =gfCloseTable('APCHECKS')
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  ENDIF
  IF USED('APBANKS') .AND. llopBNK
    *Old: =gfCloseFile('APBANKS')
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *USE IN APBANKS
    =gfCloseTable('APBANKS')
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  ENDIF
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  SELECT apinvhdr
  =gfReplace('')
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[end]
  *Old: =lfRefresh()

  RETURN
  *--end of lfvAprovPay

  *!*************************************************************
  *! Name      : lfvCrdVend
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 8/3/2004
  *! Purpose   : To Validate the Vendor Code in the apInvCrd Screen
  *!*************************************************************
  *! Parameters: The FormSet, Reference to apInvCrd Form
  *!*************************************************************
  *! Returns   : None
  *!*************************************************************
FUNCTION lfvCrdVend
  LPARAMETERS loFormSet, loInvCrd
  LOCAL llRetVal

  llRetVal = .T.

  SELECT APVENDOR
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  =gfSeeK("")
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  lcSavExact= SET('EXACT')
  SET EXACT ON

  loFormSet.llBrowse = loInvCrd.KBVendCode.Selectedfrombrowse

  IF loFormSet.llBrowse .OR. !EMPTY(loInvCrd.KBVendCode.KeyTextBox.VALUE)
    IF loFormSet.llBrowse .OR. !SEEK(loInvCrd.KBVendCode.KeyTextBox.VALUE) .OR. ;
        ATC("?",loInvCrd.KBVendCode.KeyTextBox.VALUE) > 0
      loFormSet.llBrowse = .F.
      DIMENSION laTemp[1]

      laTemp = ''

      *lcSavBrFld = lcBrFields
      *lcSavTitle = lcFile_Ttl

      lcBrFields = "CVENDCODE :H= 'Vendor Code',;
                  CVENCOMP :H= 'Company',;
                  CPHONENO :H= 'Phone'"

      *lcFile_Ttl = "Vendor"
	  *! E302623,2 MMT 10/12/2009 Convert Payable invoice screen to use SQL tables[Start]	
      *=gfBrows(.F.,'CVENDCODE,CVENCOMP,CPHONENO','laTemp')	   
      *! E302623,3 MMT 01/03/2010 Convert Payable invoice screen to use SQL tables[Start]
      *=gfBrows(.F.,'CVENDCODE,CVENCOMP,CPHONENO','laTemp',"Vendor")
      =ARIABROW(.F., 'Vendors', .F., .F., .F., .F., .F., .T., ;
                'CVENDCODE,CPHONENO,CVENCOMP', 'laTemp', .F., .F., .F., ;
                .F., .F., .F., .F., .F., ;
                .F., .F.)

       *! E302623,3 MMT 01/03/2010 Convert Payable invoice screen to use SQL tables[End]
       *! E302623,2 MMT 10/12/2009 Convert Payable invoice screen to use SQL tables[End]

      *lcBrFields = lcSavBrFld
      *lcFile_Ttl = lcSavTitle

      IF !EMPTY(laTemp[1])
        loInvCrd.KBVendCode.KeyTextBox.VALUE = laTemp[1]
        IF !EMPTY(loInvCrd.KBVendCode.KeyTextBox.VALUE) .AND. ;
            loInvCrd.KBVendCode.KeyTextBox.VALUE = loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE
          ** MESSAGE : " The credit card vendor can not be  "
          **           " the same as the invoice vendor.    "

          =gfModalGen("TRM04013B00000","DIALOG")

          loInvCrd.KBVendCode.KeyTextBox.VALUE = SPACE(8)
          loInvCrd.txtVencInv.VALUE = SPACE(12)
          loFormSet.lcAccount  = loFormSet.AriaForm1.ap1.lcemptyacc
          *_CUROBJ    = _CUROBJ&&Old CurObj
          llRetVal = .F.
        ELSE

          IF !EMPTY(APVENDOR.CAPACCT)
            loFormSet.lcAccount = APVENDOR.CAPACCT
          ELSE
            IF !EMPTY(APDIV.CAPACCT)
              loFormSet.lcAccount = APDIV.CAPACCT
            ELSE
              loFormSet.lcAccount = APSETUP.CAPACCT
            ENDIF
          ENDIF

          loInvCrd.txtVencInv.VALUE = lfCrCINo(loFormSet, loInvCrd)

        ENDIF
      ELSE
        loInvCrd.KBVendCode.KeyTextBox.VALUE = SPACE(8)
        llRetVal=.F.
      ENDIF
    ELSE
      IF !EMPTY(loInvCrd.KBVendCode.KeyTextBox.VALUE) .AND. ;
          loInvCrd.KBVendCode.KeyTextBox.VALUE = loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE
        ** MESSAGE : " The credit card vendor can not be  "
        **           " the same as the invoice vendor.    "
        =gfModalGen("TRM04013B00000","DIALOG")
        loInvCrd.KBVendCode.KeyTextBox.VALUE = SPACE(8)
        loInvCrd.txtVencInv.VALUE = SPACE(12)
        loFormSet.lcAccount  = loFormSet.AriaForm1.ap1.lcemptyacc  &&lower
        *_CUROBJ    = _CUROBJ&&Old CurObj
        llRetVal = .F.
      ELSE
        IF SEEK(loInvCrd.KBVendCode.KeyTextBox.VALUE)

          IF !EMPTY(APVENDOR.CAPACCT)
            loFormSet.lcAccount = APVENDOR.CAPACCT
          ELSE
            IF !EMPTY(APDIV.CAPACCT)
              loFormSet.lcAccount = APDIV.CAPACCT
            ELSE
              loFormSet.lcAccount = APSETUP.CAPACCT
            ENDIF
          ENDIF

          loInvCrd.txtVencInv.VALUE = lfCrCINo(loFormSet, loInvCrd)

        ENDIF
      ENDIF
    ENDIF
  ENDIF
  SET EXACT &lcSavExact

  =SEEK (loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE,'APVENDOR')
  SELECT APINVHDR
  loInvCrd.REFRESH()

  RETURN llRetVal
  *--end of lfvCrdVend

  *!*************************************************************
  *! Name      : lfCrCINo
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 8/3/2004
  *! Purpose   : to create the Invoice No. in the apInvCrd screen
  *!*************************************************************
  *! Parameters: The FormSet, Reference to apInvCrd Form
  *!*************************************************************
  *! Returns   : None
  *!*************************************************************
FUNCTION lfCrCINo
  LPARAMETERS loFormSet, loInvCrd

  PRIVATE lcRetVal

  SELECT APINVHDR
  lnCurRco = RECNO()     &&Varible to hold the current record number

  loFormSet.lcOldVal = IIF(loInvCrd.KBVendCode.KeyTextBox.VALUE = loInvCrd.KBVendCode.KeyTextBox.OldValue, ;
    loInvCrd.txtVencInv.VALUE, SPACE(12))
  lcRetVal = IIF(lfSeekVendInvNo(PADR(loInvCrd.KBVendCode.KeyTextBox.VALUE,8),PADR(loFormSet.AriaForm1.kbInvNo.KeyTextBox.VALUE , 12)),;
    loFormSet.lcOldVal,IIF(EMPTY(loFormSet.lcOldVal),PADR(loFormSet.AriaForm1.kbInvNo.KeyTextBox.VALUE,12) , loFormSet.lcOldVal) )

  IF lnCurRco <= RECCOUNT()
    GO lnCurRco
  ELSE      &&Else go to the end of file
    GO BOTTOM
    SKIP
  ENDIF      &&End of IF

  SELECT APVENDOR
  RETURN lcRetVal
  *--end of lfCrCINo


  *!*************************************************************
  *! Name      : lfvCrdInvNo
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 8/3/2004
  *! Purpose   : To Validate the Invoice in the apInvCrd Screen
  *!*************************************************************
  *! Parameters: The FormSet, Reference to apInvCrd Form
  *!*************************************************************
  *! Returns   : None
  *!*************************************************************
FUNCTION lfvCrdInvNo
  LPARAMETERS loFormSet, loInvCrd
  LOCAL llRetVal

  llRetVal = .T.

  SELECT APINVHDR
  lnSavRecNo = RECNO()

  lcSavExact= SET('EXACT')
  SET EXACT ON

  IF !EMPTY(loInvCrd.KBVendCode.KeyTextBox.VALUE) .AND. !EMPTY(loInvCrd.txtVencInv.VALUE)
    IF lfSeekVendInvNo(loInvCrd.KBVendCode.KeyTextBox.VALUE,loInvCrd.txtVencInv.VALUE)
      ** MESSAGE : " The invoice number already exist   "
      =gfModalGen("TRM04014B00000","DIALOG",apinvhdr.cvenccinv)  &&lower
      loInvCrd.txtVencInv.VALUE = SPACE(12)
      *_CUROBJ    = _CUROBJ&&Old CurObj
      llRetVal = 0
    ELSE
      IF EMPTY(STRTRAN(STRTRAN(loFormSet.lcAccount,'-'),'0'))
        IF !EMPTY(APVENDOR.CAPACCT)
          loFormSet.lcAccount = APVENDOR.CAPACCT
        ELSE
          IF !EMPTY(APDIV.CAPACCT)
            loFormSet.lcAccount = APDIV.CAPACCT
          ELSE
            loFormSet.lcAccount = APSETUP.CAPACCT
          ENDIF
        ENDIF
      ENDIF
    ENDIF
  ENDIF

  SET EXACT &lcSavExact

  SELECT APINVHDR

  IF BETWEEN(lnSavRecNo,0,RECCOUNT())
    GO lnSavRecNo
  ENDIF

  *Old: SHOW GET apinvhdr.cvenccinv  &&lower &&Revise
  *Old: SHOW GET loFormSet.lcAccount &&Revise

  RETURN llRetVal
  *--end of lfvCrdInvNo

  *!*************************************************************
  *! Name      : lfSeekVendInvNo
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 8/3/2004
  *! Purpose   : To Seek Vendor Code + Invoice No. in APINVHDR
  *!*************************************************************
  *! Parameters: Vendor Code, Invoice No.
  *!*************************************************************
  *! Returns   : None
  *!*************************************************************
FUNCTION lfSeekVendInvNo
  LPARAMETERS lcVend, lcInvNo

  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	LOCAL ARRAY laAry[1]

  *!*	laAry = .F.

  *!*	SELECT CVENDCODE FROM (oAriaApplication.DataDir+'APINVHDR') WHERE ;
  *!*	  CVENDCODE=lcVend AND CINVNO=lcInvNo INTO ARRAY laAry
  *!*
  *!*	RETURN (TYPE('laAry[1]')='C')
  LOCAL ARRAY laArray[1]

  laArray= .F.

  SELECT CVENDCODE FROM (oAriaApplication.DataDir+'APINVHDR') WHERE ;
    CVENDCODE=lcVend AND CINVNO=lcInvNo INTO ARRAY laArray

  RETURN (TYPE('laArray[1]')='C')
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[END]
  *--end of lfSeekVendInvNo


  *!*************************************************************
  *! Name      : lfvBnkChk
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 8/3/2004
  *! Purpose   : To Validate the Bank Code and Checking Account Code in the apAprov Screen
  *!*************************************************************
  *! Parameters: The FormSet, Reference to apAprov Form
  *!*************************************************************
  *! Returns   : None
  *!*************************************************************
FUNCTION lfvBnkChk
  LPARAMETERS loFormSet, loAprov
  LOCAL lcTemp

  IF gfGetMemVar('LLMULCURR') .AND. !EMPTY(apinvhdr.cchkacct)
    IF SEEK(apinvhdr.cbnkcode+apinvhdr.cchkacct,'APCHECKS')
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *!*	    REPLACE apinvhdr.caprcurcod WITH IIF(EMPTY(APCHECKS.CCURRCODE),;
      *!*	                                         loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value,;
      *!*	                                         APCHECKS.CCURRCODE)
      REPLACE apinvhdr.caprcurcod WITH IIF(EMPTY(APCHECKS.CCURRCODE),;
        loFormSet.AriaForm1.pgfpayInv.pgHead.kbCurrCode.KeyTextBox.VALUE,;
        APCHECKS.CCURRCODE)
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[END]
    ELSE
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *    REPLACE apinvhdr.caprcurcod WITH loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value
      REPLACE apinvhdr.caprcurcod WITH loFormSet.AriaForm1.pgfpayInv.pgHead.kbCurrCode.KeyTextBox.VALUE
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    ENDIF
  ELSE
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *  REPLACE apinvhdr.caprcurcod WITH loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value
    REPLACE apinvhdr.caprcurcod WITH loFormSet.AriaForm1.pgfpayInv.pgHead.kbCurrCode.KeyTextBox.VALUE
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  ENDIF

  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *IF apinvhdr.caprcurcod = loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value
  IF apinvhdr.caprcurcod = loFormSet.AriaForm1.pgfpayInv.pgHead.kbCurrCode.KeyTextBox.VALUE
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    REPLACE apinvhdr.naprexrat WITH 1
    REPLACE apinvhdr.naprcurunt WITH 1
    *Old: SHOW GET apinvhdr.naprexrat DISABLE  &&lower &&Revise
    loAprov.txtaprexrat.ENABLED = .F.
  ELSE
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *IF loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value = oAriaApplication.BaseCurrency
    IF loFormSet.AriaForm1.pgfpayInv.pgHead.kbCurrCode.KeyTextBox.VALUE = oAriaApplication.BaseCurrency
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      PRIVATE aprcurunt
      aprcurunt = apinvhdr.naprcurunt

      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *!*	    REPLACE apinvhdr.naprexrat WITH gfChkRate('aprcurunt',apinvhdr.caprcurcod,;
      *!*	                                              loFormSet.AriaForm1.DtInvDate.Value,.F.,.F.,;
      *!*	                                              loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value)
      REPLACE apinvhdr.naprexrat WITH gfChkRate('aprcurunt',apinvhdr.caprcurcod,;
        loFormSet.AriaForm1.pgfpayInv.pgHead.DtInvDate.VALUE,.F.,.F.,;
        loFormSet.AriaForm1.pgfpayInv.pgHead.kbCurrCode.KeyTextBox.VALUE)
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      REPLACE apinvhdr.naprcurunt WITH aprcurunt
    ELSE
      PRIVATE aprcurunt
      aprcurunt = apinvhdr.naprcurunt
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *    REPLACE apinvhdr.naprexrat WITH gfChkRate('aprcurunt',;
      loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value,;
      loFormSet.AriaForm1.DtInvDate.Value,.F.,.F.,;
      apinvhdr.caprcurcod)
      REPLACE apinvhdr.naprexrat WITH gfChkRate('aprcurunt',;
        loFormSet.AriaForm1.pgfpayInv.pgHead.kbCurrCode.KeyTextBox.VALUE,;
        loFormSet.AriaForm1.pgfpayInv.pgHead.DtInvDate.VALUE,.F.,.F.,;
        apinvhdr.caprcurcod)
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      REPLACE apinvhdr.naprcurunt WITH aprcurunt
    ENDIF

    IF apinvhdr.naprexrat = 0
      ** MESSAGE : " A valid  to  exchange rate could not "
      **           " be found for .                        "

      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *IF loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value = oAriaApplication.BaseCurrency
      *=gfModalGen("QRM04157B00000","DIALOG",ALLTRIM(apinvhdr.caprcurcod)+'|'+ALLTRIM(loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value)+'|'+DTOC(loFormSet.AriaForm1.DtInvDate.Value))
      IF loFormSet.AriaForm1.pgfpayInv.pgHead.kbCurrCode.KeyTextBox.VALUE = oAriaApplication.BaseCurrency
        =gfModalGen("QRM04157B00000","DIALOG",ALLTRIM(apinvhdr.caprcurcod)+'|'+ALLTRIM(loFormSet.AriaForm1.pgfpayInv.pgHead.kbCurrCode.KeyTextBox.VALUE)+'|'+DTOC(loFormSet.AriaForm1.pgfpayInv.pgHead.DtInvDate.VALUE))
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      ELSE
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        *=gfModalGen("QRM04157B00000","DIALOG",ALLTRIM(loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value)+'|'+ALLTRIM(apinvhdr.caprcurcod)+'|'+DTOC(loFormSet.AriaForm1.DtInvDate.Value))
        =gfModalGen("QRM04157B00000","DIALOG",ALLTRIM(loFormSet.AriaForm1.pgfpayInv.pgHead.kbCurrCode.KeyTextBox.VALUE)+'|'+ALLTRIM(apinvhdr.caprcurcod)+'|'+DTOC(loFormSet.AriaForm1.pgfpayInv.pgHead.DtInvDate.VALUE))
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      ENDIF

      loAprov.txtaprexrat.VALUE = 1
      *_CUROBJ = OBJNUM(apinvhdr.cchkglacc)
    ENDIF
    *Old: SHOW GET apinvhdr.naprexrat ENABLE  &&lower &&Revise
    loAprov.txtaprexrat.ENABLED = .T.
  ENDIF
  loFormSet.lcExSin4 = ' '

  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *IF loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value = oAriaApplication.BaseCurrency
  IF loFormSet.AriaForm1.pgfpayInv.pgHead.kbCurrCode.KeyTextBox.VALUE = oAriaApplication.BaseCurrency
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    lcExSin4 = loFormSet.lcExSin4
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    * loFormSet.lcExSin3 = gfGetExSin(@lcExSin4,apinvhdr.caprcurcod,loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value)
    loFormSet.lcExSin3 = gfGetExSin(@lcExSin4,apinvhdr.caprcurcod,loFormSet.AriaForm1.pgfpayInv.pgHead.kbCurrCode.KeyTextBox.VALUE)
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    loFormSet.lcExSin4 = lcExSin4
    loFormSet.lcExSin3 = IIF(loFormSet.lcExSin3 = '*' , '/' , '*')
    loFormSet.lcExSin4 = IIF(loFormSet.lcExSin4 = '*' , '/' , '*')
  ELSE
    lcExSin4 = loFormSet.lcExSin4

    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *loFormSet.lcExSin3 = gfGetExSin(@lcExSin4,loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value,apinvhdr.caprcurcod)    &&lower  &&lower
    loFormSet.lcExSin3 = gfGetExSin(@lcExSin4,loFormSet.AriaForm1.pgfpayInv.pgHead.kbCurrCode.KeyTextBox.VALUE,apinvhdr.caprcurcod)    &&lower  &&lower
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

    loFormSet.lcExSin4 = lcExSin4
  ENDIF

  lcTemp = 'apinvhdr.ninvamtap'+loFormSet.lcExSin3+'apinvhdr.naprexrat'+loFormSet.lcExSin4+;
    'apinvhdr.naprcurunt'
  REPLACE apinvhdr.ninvfaap WITH ROUND(&lcTemp,2)

  *=lfRefresh()

  RETURN
  *--end of lfvBnkChk


  *!*************************************************************
  *! Name      : lfvAprCurrency
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 11/1/2004
  *! Purpose   : To Validate Currency in the apAprov Screen
  *!*************************************************************
  *! Parameters: The FormSet, Reference to apAprov Form
  *!*************************************************************
  *! Returns   : None
  *!*************************************************************
FUNCTION lfvAprCurrency
  LPARAMETERS loFormSet, loAprov
  LOCAL lcTemp

  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *=gfOpenFile(oAriaApplication.SysPath + 'SYCCURR' , 'CCURRCODE' , 'SH')
  =gfOpenTable(oAriaApplication.SysPath + 'SYCCURR' , 'CCURRCODE' , 'SH')
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  loFormSet.llBrowse = loAprov.kbAprCurrCode.Selectedfrombrowse
  IF loFormSet.llBrowse .OR. !SEEK(loAprov.kbAprCurrCode.keytextbox.VALUE,'SYCCURR') .OR. ;
      ATC("?",loAprov.kbAprCurrCode.KeyTextBox.VALUE) > 0
    SELECT SYCCURR
    DIMENSION laTemp[1]
    laTemp     = ''
    lcFile_Ttl = "Currency"
    lcBrFields = "CCURRCODE :R :H= 'Currency code'," +;
      "CCURRDESC :R :H= 'Description',  " +;
      "CCURRSMBL :R :H= 'Symbol'"
    *! E302623,2 MMT 10/12/2009 Convert Payable invoice screen to use SQL tables[Start]	   
    *=gfBrows('','CCURRCODE','laTemp')
    *! E302623,3 MMT 01/03/2010 Convert Payable invoice screen to use SQL tables[Start]
    *=gfBrows('','CCURRCODE','laTemp',lcFile_Ttl )
	=ARIABROW('', lcFile_Ttl , .F., .F., .F., .F., .F., .T., ;
                'CCURRCODE', 'laTemp', .F., .F., .F., ;
                .F., .F., .F., .F., .F., ;
                .F., .F.)
    *! E302623,3 MMT 01/03/2010 Convert Payable invoice screen to use SQL tables[End]
    *! E302623,2 MMT 10/12/2009 Convert Payable invoice screen to use SQL tables[End]	
    IF EMPTY(laTemp[1])
      loAprov.kbAprCurrCode.KeyTextBox.VALUE = loAprov.kbAprCurrCode.KeyTextBox.OldValue
    ELSE
      loAprov.kbAprCurrCode.KeyTextBox.VALUE = laTemp[1]
    ENDIF
  ENDIF

  IF loAprov.kbAprCurrCode.KeyTextBox.VALUE <> loAprov.kbAprCurrCode.KeyTextBox.OldValue

    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *IF gfGetMemVar('LLMULCURR') .AND. ;
    * loAprov.kbAprCurrCode.KeyTextBox.Value <> loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value
    IF gfGetMemVar('LLMULCURR') .AND. ;
        loAprov.kbAprCurrCode.KeyTextBox.VALUE <> loFormSet.AriaForm1.pgfpayInv.pgHead.kbCurrCode.KeyTextBox.VALUE
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      lnCurrUnit = 0


      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *IF loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value = oAriaApplication.BaseCurrency
      *REPLACE apinvhdr.naprexrat WITH gfChkRate('lnCurrUnit',apinvhdr.caprcurcod,loFormSet.AriaForm1.DtInvDate.Value,.F.,.F.,loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value) IN apinvhdr
      IF loFormSet.AriaForm1.pgfpayInv.pgHead.kbCurrCode.KeyTextBox.VALUE = oAriaApplication.BaseCurrency
        REPLACE apinvhdr.naprexrat WITH gfChkRate('lnCurrUnit',apinvhdr.caprcurcod,loFormSet.AriaForm1.pgfpayInv.pgHead.DtInvDate.VALUE,.F.,.F.,loFormSet.AriaForm1.pgfpayInv.pgHead.kbCurrCode.KeyTextBox.VALUE) IN apinvhdr
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      ELSE
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        *REPLACE apinvhdr.naprexrat WITH gfChkRate('lnCurrUnit',loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value,loFormSet.AriaForm1.DtInvDate.Value,.F.,.F.,apinvhdr.caprcurcod) IN apinvhdr
        REPLACE apinvhdr.naprexrat WITH gfChkRate('lnCurrUnit',loFormSet.AriaForm1.pgfpayInv.pgHead.kbCurrCode.KeyTextBox.VALUE,loFormSet.AriaForm1.pgfpayInv.pgHead.DtInvDate.VALUE,.F.,.F.,apinvhdr.caprcurcod) IN apinvhdr
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      ENDIF
      REPLACE apinvhdr.naprcurunt WITH lnCurrUnit IN apinvhdr

      loFormSet.lcExSin4 = ' '
      lcExSin4 = loFormSet.lcExSin4
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *IF loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value = oAriaApplication.BaseCurrency
      *loFormSet.lcExSin3 = gfGetExSin(@lcExSin4,apinvhdr.caprcurcod,loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value)
      IF loFormSet.AriaForm1.pgfpayInv.pgHead.kbCurrCode.KeyTextBox.VALUE = oAriaApplication.BaseCurrency
        loFormSet.lcExSin3 = gfGetExSin(@lcExSin4,apinvhdr.caprcurcod,loFormSet.AriaForm1.pgfpayInv.pgHead.kbCurrCode.KeyTextBox.VALUE)
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

        loFormSet.lcExSin4 = lcExSin4
        loFormSet.lcExSin3 = IIF(loFormSet.lcExSin3 = '*' , '/' , '*')
        loFormSet.lcExSin4 = IIF(loFormSet.lcExSin4 = '*' , '/' , '*')
      ELSE
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        *loFormSet.lcExSin3 = gfGetExSin(@lcExSin4,loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value,apinvhdr.caprcurcod)
        loFormSet.lcExSin3 = gfGetExSin(@lcExSin4,loFormSet.AriaForm1.pgfpayInv.pgHead.kbCurrCode.KeyTextBox.VALUE,apinvhdr.caprcurcod)
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
        loFormSet.lcExSin4 = lcExSin4
      ENDIF

      IF apinvhdr.naprexrat = 0
        ** MESSAGE : " A valid  to  exchange rate could not "
        **           " be found for .                        "
        **           "                   Ok                 "

        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        * IF loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value = oAriaApplication.BaseCurrency
        *=gfModalGen("QRM04157B00000","DIALOG",ALLTRIM(apinvhdr.caprcurcod)+'|'+ALLTRIM(loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value)+'|'+DTOC(loFormSet.AriaForm1.DtInvDate.Value))
        IF loFormSet.AriaForm1.pgfpayInv.pgHead.kbCurrCode.KeyTextBox.VALUE = oAriaApplication.BaseCurrency
          =gfModalGen("QRM04157B00000","DIALOG",ALLTRIM(apinvhdr.caprcurcod)+'|'+ALLTRIM(loFormSet.AriaForm1.pgfpayInv.pgHead.kbCurrCode.KeyTextBox.VALUE)+'|'+DTOC(loFormSet.AriaForm1.pgfpayInv.pgHead.DtInvDate.VALUE))
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]  
        ELSE
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
          *=gfModalGen("QRM04157B00000","DIALOG",ALLTRIM(loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value)+'|'+ALLTRIM(apinvhdr.caprcurcod)+'|'+DTOC(loFormSet.AriaForm1.DtInvDate.Value))
          =gfModalGen("QRM04157B00000","DIALOG",ALLTRIM(loFormSet.AriaForm1.pgfpayInv.pgHead.kbCurrCode.KeyTextBox.VALUE)+'|'+ALLTRIM(apinvhdr.caprcurcod)+'|'+DTOC(loFormSet.AriaForm1.pgfpayInv.pgHead.DtInvDate.VALUE))
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
        ENDIF

        REPLACE apinvhdr.naprexrat WITH  1 IN apinvhdr
        REPLACE apinvhdr.naprcurunt WITH 1 IN apinvhdr
      ENDIF

      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *!*	    IF loAprov.kbAprCurrCode.KeyTextBox.Value  = loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value
      IF loAprov.kbAprCurrCode.KeyTextBox.VALUE  = loFormSet.AriaForm1.pgfpayInv.pgHead.kbCurrCode.KeyTextBox.VALUE
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
        *Old: SHOW GET apinvhdr.naprexrat DISABLE  &&lower &&Revise
        loAprov.txtaprexrat.ENABLED = .F.
      ELSE
        *Old: SHOW GET apinvhdr.naprexrat ENABLE  &&lower &&Revise
        loAprov.txtaprexrat.ENABLED = .T.
      ENDIF
    ELSE
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *REPLACE apinvhdr.caprcurcod WITH loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value IN apinvhdr
      REPLACE apinvhdr.caprcurcod WITH loFormSet.AriaForm1.pgfpayInv.pgHead.kbCurrCode.KeyTextBox.VALUE IN apinvhdr
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      REPLACE apinvhdr.naprexrat WITH 1 IN apinvhdr
      REPLACE apinvhdr.naprcurunt WITH 1 IN apinvhdr
      *Old: SHOW GET apinvhdr.naprexrat DISABLE  &&lower &&Revise
      loAprov.txtaprexrat.ENABLED = .F.
    ENDIF
  ENDIF
  lcTemp ='apinvhdr.ninvamtap'+loFormSet.lcExSin3+'apinvhdr.naprexrat'+loFormSet.lcExSin4+;
    'apinvhdr.naprcurunt'
  REPLACE apinvhdr.ninvfaap WITH ROUND(&lcTemp,2) IN apinvhdr

  WITH loAprov
    .kbAprCurrCode.REFRESH()
    .txtaprexrat.REFRESH()
    .txtinvfaap.REFRESH()
  ENDWITH

  SELECT APINVHDR

  RETURN
  *--end of lfvAprCurrency


  *!*************************************************************
  *! Name      : lfvExRate
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 8/3/2004
  *! Purpose   : To Validate Exchange Rate in the apAprov Screen
  *!*************************************************************
  *! Parameters: The FormSet, Reference to apAprov Form
  *!*************************************************************
  *! Returns   : None
  *!*************************************************************

  *B608697,1 MMT 09/29/2008 fix bug while editing ex. rate[Start]
  *FUNCTION lfvExRate
FUNCTION LFVAPREXRATE
  *B608697,1 MMT 09/29/2008 fix bug while editing ex. rate[End]

  LPARAMETERS loFormSet, loAprov
  LOCAL lcTemp

  
  IF loAprov.txtaprexrat.VALUE <= 0
    loAprov.txtaprexrat.VALUE = loAprov.txtaprexrat.OldValue
  ENDIF

  lcTemp = 'apinvhdr.ninvamtap'+loFormSet.lcExSin3+'apinvhdr.naprexrat'+loFormSet.lcExSin4+;
    'apinvhdr.naprcurunt'

  REPLACE apinvhdr.ninvfaap WITH ROUND(&lcTemp,2)
  *=lfRefresh()

  RETURN
  *--end of lfvExRate

  *!*************************************************************
  *! Name      : lfvApprove
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 8/3/2004
  *! Purpose   : To Validate the Approved amount, discount and adjustment in the apAprov screen
  *!*************************************************************
  *! Parameters: The FormSet, Reference to apAprov Form, lnObjNum
  *!*************************************************************
  *! Returns   : None
  *!*************************************************************
FUNCTION lfvApprove
  LPARAMETERS loFormSet, loAprov, lnObjNum
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *IF loFormSet.AriaForm1.txtInvAmount.Value > 0
  * IF !BETWEEN(apinvhdr.ninvdisap+apinvhdr.ninvamtap+apinvhdr.ninvadjap,;
  0, loFormSet.AriaForm1.txtInvAmount.Value-apinvhdr.ninvpaid-;
  apinvhdr.ninvdistk-apinvhdr.ninvadj)

  IF loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.VALUE > 0
    IF !BETWEEN(apinvhdr.ninvdisap+apinvhdr.ninvamtap+apinvhdr.ninvadjap,;
        0, loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.VALUE-apinvhdr.ninvpaid-;
        apinvhdr.ninvdistk-apinvhdr.ninvadj)
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      ** MESSAGE : " Total approved amount can not be greater than "
      **           " the open amount.                              "
      =gfModalGen("TRM04015B00000","DIALOG",loFormSet.lcTAprAmnt+"|"+'invoice')
      DO CASE
        CASE lnObjNum = 1
          loAprov.txtinvdisap.VALUE = loAprov.txtinvdisap.OldValue
        CASE lnObjNum = 2
          loAprov.txtinvamtap.VALUE = loAprov.txtinvamtap.OldValue
        CASE lnObjNum = 3
          loAprov.txtinvadjap.VALUE = loAprov.txtinvadjap.OldValue
      ENDCASE
    ENDIF
  ELSE
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *!*	  IF !BETWEEN(apinvhdr.ninvdisap+apinvhdr.ninvamtap+apinvhdr.ninvadjap,;
    *!*	              loFormSet.AriaForm1.txtInvAmount.Value-apinvhdr.ninvpaid-apinvhdr.ninvdistk-;
    *!*	              apinvhdr.ninvadj,0)
    IF !BETWEEN(apinvhdr.ninvdisap+apinvhdr.ninvamtap+apinvhdr.ninvadjap,;
        loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.VALUE-apinvhdr.ninvpaid-apinvhdr.ninvdistk-;
        apinvhdr.ninvadj,0)
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      ** MESSAGE : " Total approved amount can not be greater than "
      **           " the open amount.                              "
      =gfModalGen("TRM04015B00000","DIALOG",loFormSet.lcTAprAmnt+"|"+'debit memo ')
      DO CASE
        CASE lnObjNum = 1
          loAprov.txtinvdisap.VALUE = loAprov.txtinvdisap.OldValue
        CASE lnObjNum = 2
          loAprov.txtinvamtap.VALUE = loAprov.txtinvamtap.OldValue
        CASE lnObjNum = 3
          loAprov.txtinvadjap.VALUE = loAprov.txtinvadjap.OldValue
      ENDCASE
    ENDIF
  ENDIF

  lcTemp = 'apinvhdr.ninvamtap'+loFormSet.lcExSin3+;
    IIF(loFormSet.lcExSin3='/',"iif(apinvhdr.naprexrat=0,1,apinvhdr.naprexrat)","apinvhdr.naprexrat")+loFormSet.lcExSin4+;
    IIF(loFormSet.lcExSin4='/',"iif(apinvhdr.naprcurunt=0,1,apinvhdr.naprcurunt)","apinvhdr.naprcurunt")

  REPLACE apinvhdr.ninvfaap WITH ROUND(&lcTemp,2) IN apinvhdr

  *Old: SHOW GET apinvhdr.ninvdisap  &&lower &&Revise
  *Old: SHOW GET apinvhdr.ninvamtap  &&lower &&Revise
  *Old: SHOW GET apinvhdr.ninva1099 &loFormSet.lcData23St  &&lower &&Revise
  loAprov.txtinva1099.ENABLED = (loFormSet.lcData23St='ENABLE')
  *Old: SHOW GET apinvhdr.ninvadjap  &&lower &&Revise

  *=lfRefresh()

  RETURN
  *--end of lfvApprove

  *!*************************************************************
  *! Name      : lfv1099Aprov
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 8/3/2004
  *! Purpose   : To Validate the 1099amount of the apApprov Screen
  *!*************************************************************
  *! Parameters: The FormSet, Reference to apAprov Form
  *!*************************************************************
  *! Returns   : None
  *!*************************************************************
FUNCTION lfv1099Aprov
  LPARAMETERS loFormSet, loAprov

  DO CASE
    CASE apinvhdr.ninvamtap > 0
      IF !BETWEEN(apinvhdr.ninva1099,0,apinvhdr.ninvamtap)
        ** MESSAGE : " The 1099 amount must be between 0 and ."
        =gfModalGen("TRM04017B00000","DIALOG",'0'+"|"+ALLTRIM(STR(apinvhdr.ninvamtap,15,2)))
        loAprov.txtinva1099.VALUE = loAprov.txtinva1099.OldValue
      ENDIF
    CASE apinvhdr.ninvamtap < 0
      IF !BETWEEN(apinvhdr.ninva1099,apinvhdr.ninvamtap,0)
        ** MESSAGE : " The 1099 amount must be between  and 0."
        =gfModalGen("TRM04017B00000","DIALOG",ALLTRIM(STR(apinvhdr.ninvamtap,15,2))+"|"+'0')  &&lower
        loAprov.txtinva1099.VALUE = loAprov.txtinva1099.OldValue
      ENDIF
    CASE apinvhdr.ninvamtap = 0 .AND. apinvhdr.ninva1099 > apinvhdr.ninvamtap
      ** MESSAGE : " The 1099 amount can not be greater than "
      **           " the approve to pay amount.              "
      =gfModalGen("TRM04147B00000","DIALOG")
      loAprov.txtinva1099.VALUE = loAprov.txtinva1099.OldValue
  ENDCASE

  *Old: SHOW GET apinvhdr.ninva1099 &loFormSet.lcData23St  &&lower &&Revise
  loAprov.txtinva1099.ENABLED = (loFormSet.lcData23St='ENABLE')

  RETURN
  *--end of lfv1099Aprov

  *!*************************************************************
  *! Name      : lfvOkApr
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 8/3/2004
  *! Purpose   : Clicking Ok button of the in the apAprov Screen
  *!*************************************************************
  *! Parameters: The FormSet, Reference to apAprov Form
  *!*************************************************************
  *! Returns   : None
  *!*************************************************************
FUNCTION lfvOkApr
  LPARAMETERS loFormSet, loAprov

  IF EMPTY(apinvhdr.naprexrat)
    ** MESSAGE : "      should be greater than        "
    =gfModalGen("TRM04072B00000" , "DIALOG" , "Exchange rate|zero")
    loAprov.txtaprexrat.SETFOCUS()
    RETURN .F.
  ENDIF

  lcEmptyObj = NULL


  DO CASE
    CASE apinvhdr.ninvamtap = 0
      ** MESSAGE : " You have to enter the approved to pay amount."
      =gfModalGen("TRM04022B00000","DIALOG")
      *Old: _CUROBJ = OBJNUM(apinvhdr.ninvamtap)  &&lower&&Old CurObj
      loAprov.txtinvamtap.SETFOCUS()
      RETURN .F.

    CASE EMPTY(STRTRAN(STRTRAN(apinvhdr.cchkglacc,'-'),'0'))
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *!*	    IF loFormSet.AriaForm1.cboVendPmeth.Value = 'H'
      IF loFormSet.AriaForm1.pgfpayInv.pgHead.cboVendPmeth.VALUE = 'H'
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
        ** MESSAGE : " You have to enter the  account.     "
        =gfModalGen("TRM04020B00000","DIALOG",loFormSet.lcTPayAcct)
        *Old: _CUROBJ = OBJNUM(apinvhdr.cchkglacc)
        loAprov.glChkActCode.KeyTextBox.SETFOCUS()
        RETURN .F.
      ELSE
        lcEmptyObj = loAprov.glChkActCode.KeyTextBox
      ENDIF
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *!*	  CASE loFormSet.AriaForm1.cboVendPmeth.Value <> 'H' .AND. EMPTY(apinvhdr.cbnkcode)
    CASE loFormSet.AriaForm1.pgfpayInv.pgHead.cboVendPmeth.VALUE <> 'H' .AND. EMPTY(apinvhdr.cbnkcode)
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      lcEmptyObj = loAprov.BankChk.kbBanks.keyTextBox

      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *!*	  CASE loFormSet.AriaForm1.cboVendPmeth.Value <> 'H' .AND. EMPTY(apinvhdr.cchkacct)
    CASE loFormSet.AriaForm1.pgfpayInv.pgHead.cboVendPmeth.VALUE <> 'H' .AND. EMPTY(apinvhdr.cchkacct)
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[END]
      lcEmptyObj = loAprov.BankChk.kbChkAccount.keyTextBox

  ENDCASE

  *IF !EMPTY(lcEmptyObj)
  IF !ISNULL(lcEmptyObj)
    ** MESSAGE : " You have to enter the bank code,the  "
    **           " checking account,and the GL account. "
    =gfModalGen("TRM04021B00000","DIALOG")
    *_CUROBJ = OBJNUM(&lcEmptyObj)
    lcEmptyObj.SETFOCUS()
    RETURN .F.
  ENDIF

  IF loFormSet.lcData23St = 'ENABLE'
    IF apinvhdr.ninvamtap >= 0  &&lower
      lnLowerVal = 0
      lnUpperVal = apinvhdr.ninvamtap  &&lower
    ELSE
      lnLowerVal = apinvhdr.ninvamtap  &&lower
      lnUpperVal = 0
    ENDIF

    IF !BETWEEN(apinvhdr.ninva1099,lnLowerVal,lnUpperVal)
      ** MESSAGE : " The 1099 amount must be between 0 and ."
      =gfModalGen("TRM04017B00000","DIALOG",;
        ALLTRIM(STR(lnLowerVal,15,2))+"|"+ALLTRIM(STR(lnUpperVal,15,2)))
      *_CUROBJ = OBJNUM(apinvhdr.ninva1099)
      loAprov.txtinva1099.SETFOCUS()
      RETURN .F.
    ENDIF
  ENDIF

  IF !gfGetMemVar('LLMULCURR') .AND. loFormSet.ActiveMode="A" && If not multi currrency.
    REPLACE apinvhdr.caprcurcod WITH oAriaApplication.BaseCurrency
    REPLACE apinvhdr.naprexrat WITH 1
    REPLACE apinvhdr.naprcurunt WITH 1
  ENDIF

  *CLEAR READ

  RETURN .T.
  *--end of lfvOkApr


  *!*************************************************************
  *! Name      : lfvClrApr
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 7/29/2004
  *! Purpose   : Validation function of the Cancel push button of the apAprov Screen.
  *!*************************************************************
  *! Parameters: loFormSet
  *!*************************************************************
  *! Returns   : None
  *!*************************************************************
FUNCTION lfvClrApr
  PARAMETERS loFormSet

  REPLACE apinvhdr.cchkglacc WITH loFormSet.AriaForm1.ap1.lcemptyacc
  REPLACE apinvhdr.ninvdisap WITH 0
  REPLACE apinvhdr.ninvamtap WITH 0

  REPLACE apinvhdr.ninvfaap WITH 0

  REPLACE apinvhdr.ninva1099 WITH 0
  REPLACE apinvhdr.ninvadjap WITH 0

  REPLACE apinvhdr.naprexrat WITH 0
  REPLACE apinvhdr.caprcurcod WITH ''
  REPLACE apinvhdr.naprcurunt WITH 0

  REPLACE apinvhdr.cbnkcode WITH SPACE(8)
  REPLACE apinvhdr.cchkacct WITH SPACE(12)

  RETURN
  *--end of lfvClrApr



  *!*************************************************************
  *! Name      : lfvCanPay
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 8/3/2004
  *! Purpose   : Clicking Cancel button of the in the apAprov Screen
  *!*************************************************************
  *! Parameters: The FormSet
  *!*************************************************************
  *! Returns   : None
  *!*************************************************************
FUNCTION lfvCanPay
  LPARAMETERS loFormSet
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	IF loFormSet.AriaForm1.cboVendPmeth.Value <> 'H'  &&lower
  IF loFormSet.AriaForm1.pgfpayInv.pgHead.cboVendPmeth.VALUE <> 'H'  &&lower
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    REPLACE apinvhdr.cbnkcode WITH loFormSet.lcBankCode
    REPLACE apinvhdr.cchkacct WITH loFormSet.lcCheckAcc
  ENDIF
  REPLACE apinvhdr.cchkglacc WITH IIF(!EMPTY(loFormSet.lcGLAcount),loFormSet.lcGlAcount, ;
    loFormSet.AriaForm1.ap1.lcemptyacc)
  REPLACE apinvhdr.ninvamtap WITH loFormSet.lcApprPay

  REPLACE apinvhdr.ninvfaap WITH loFormSet.lnFAAp

  REPLACE apinvhdr.ninvdisap WITH loFormSet.lcApprDis
  REPLACE apinvhdr.ninva1099 WITH loFormSet.lc1099Amnt
  REPLACE apinvhdr.ninvadjap WITH loFormSet.lcApprAdj
  *! E302623,3 MMT 01/03/2010 Convert Payable invoice screen to use SQL tables[Start]	
  *REPLACE apinvhdr.caprcurcod WITH lcAprCurr
  REPLACE apinvhdr.caprcurcod WITH loFormSet.lcAprCurr
  *! E302623,3 MMT 01/03/2010 Convert Payable invoice screen to use SQL tables[End]
  REPLACE apinvhdr.naprexrat WITH loFormSet.lnAprRate
  REPLACE apinvhdr.naprcurunt WITH loFormSet.lnAprUnit

  *CLEAR READ

  RETURN
  *--end of lfvCanPay


  *!*************************************************************
  *! Name      : lfAprovRefresh
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 8/3/2004
  *! Purpose   : Called from the Resfresh Event of the apAprov Screen
  *!*************************************************************
  *! Parameters: The FormSet, Reference to apAprov Form
  *!*************************************************************
  *! Returns   : None
  *!*************************************************************
FUNCTION lfAprovRefresh
  LPARAMETERS loFormSet, loAprov

  IF loFormSet.ActiveMode="V"
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *IF loFormSet.AriaForm1.cboVendPmeth.Value $ 'PMN'  &&lower
    IF loFormSet.AriaForm1.pgfpayInv.pgHead.cboVendPmeth.VALUE $ 'PMN'  &&lower
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      *Old: SHOW GET apinvhdr.cbnkcode DISABLE  &&lower &&Revise
      *Old: SHOW GET ibBank     DISABLE &&Revise
      *Old: SHOW GET apinvhdr.cchkacct DISABLE  &&lower &&Revise
      *Old: SHOW GET ibChecks   DISABLE &&Revise
    ELSE
      *Old: SHOW GET ibAprCur   DISABLE &&Revise
    ENDIF

    *Old: SHOW GET apinvhdr.cchkglacc DISABLE  &&lower &&Revise
    *Old: SHOW GET ibGLAcc    DISABLE &&Revise
    *Old: SHOW GET apinvhdr.ninvdisap DISABLE  &&lower &&Revise
    *Old: SHOW GET apinvhdr.ninvamtap DISABLE  &&lower &&Revise
    *Old: SHOW GET apinvhdr.ninva1099 &loFormSet.lcData23St  &&lower &&Revise
    *Old: SHOW GET apinvhdr.ninvadjap DISABLE  &&lower &&Revise
    *Old: SHOW GET pbCancel   DISABLE &&Revise
    *Old: SHOW GET pbClrApr   DISABLE &&Revise
    *Old: SHOW GET apinvhdr.naprexrat DISABLE  &&lower &&Revise
    *Old: SHOW GET apinvhdr.caprcurcod DISABLE  &&lower &&Revise

    STORE .F. TO loAprov.bankChk.ENABLED, loAprov.glChkActCode.ENABLED, ;
      loAprov.txtaprexrat.ENABLED,loAprov.txtinva1099.ENABLED, loAprov.txtinvamtap.ENABLED, ;
      loAprov.txtinvdisap.ENABLED, loAprov.txtinvadjap.ENABLED, loAprov.cmdClearApprov.ENABLED, ;
      loAprov.cmdCancel.ENABLED


    loAprov.cmdApprove.CAPTION = '\<Ok'


  ELSE

    *IF EMPTY(apinvhdr.cbnkcode)
    *Old: SHOW GET apinvhdr.cchkacct DISABLE      && Disable check account field
    *Old: SHOW GET ibChecks   DISABLE      && Disable check account browse push button
    *ENDIF
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *!*	  IF loFormSet.AriaForm1.cboVendPmeth.Value = 'H' .AND. ;
    *!*	     apinvhdr.caprcurcod = loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value
    IF loFormSet.AriaForm1.pgfpayInv.pgHead.cboVendPmeth.VALUE = 'H' .AND. ;
        apinvhdr.caprcurcod = loFormSet.AriaForm1.pgfpayInv.pgHead.kbCurrCode.KeyTextBox.VALUE
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      *Old: SHOW GET apinvhdr.naprexrat DISABLE
      loAprov.txtaprexrat.ENABLED = .F.
    ELSE
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *IF apinvhdr.caprcurcod = loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value
      IF apinvhdr.caprcurcod = loFormSet.AriaForm1.pgfpayInv.pgHead.kbCurrCode.KeyTextBox.VALUE
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
        *Old: SHOW GET apinvhdr.naprexrat DISABLE
        loAprov.txtaprexrat.ENABLED = .F.
      ELSE
        *Old: SHOW GET apinvhdr.naprexrat ENABLE
        loAprov.txtaprexrat.ENABLED = .T.
      ENDIF
    ENDIF
  ENDIF

  IF INLIST(loFormSet.ActiveMode,"E","A")
    *_CUROBJ = OBJNUM(apinvhdr.ninvamtap)
    loAprov.txtinvamtap.SETFOCUS()
  ENDIF
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *IF loFormSet.AriaForm1.txtInvAmount.Value < 0
  IF loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.VALUE < 0
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    *Old: Show GET apinvhdr.ninvdisap DISABLE
    *Old: Show GET apinvhdr.ninvadjap DISABLE
    STORE .F. TO loAprov.txtinvdisap.ENABLED, loAprov.txtinvadjap.ENABLED
  ENDIF

  loAprov.txtActName.VALUE = IIF(loFormSet.AriaForm1.ap1.llApGlLink,;
    ALLTRIM(LOOKUP(lcLinkChar.CACCNLDES,loAprov.glChkActCode.KeyTextbox.VALUE,lcLinkChar.CACCTCODE,"ACCTCODE")),' ')


  RETURN
  *--end of lfAprovRefresh

  ***zzz***




  ***ddd***


  *!*************************************************************
  *! Name      : lfvDistrib
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 8/8/2004
  *! Purpose   : Function called from the Click Event of the Distribution Lines Button
  *!*************************************************************
  *! Parameters: The FormSet
  *!*************************************************************
  *! Returns   : None
  *!*************************************************************
FUNCTION lfvDistrib
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *LPARAMETERS loFormSet
  PARAMETERS loFormSet
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  llOpInvad = .F.
  *Old: IF loFormSet.ActiveMode="S" .OR. loFormSet.ActiveMode="V"
  *Old: ON KEY LABEL ALT+N
  *Old: ON KEY LABEL ALT+V
  *Old: ELSE
  *Old: ON KEY LABEL ALT+N DO LFVNEWLINE
  *Old: ON KEY LABEL ALT+V DO LFVREMLINE
  *Old: ENDIF
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *IF loFormSet.AriaForm1.cboVendPmeth.Value <> 'C' .AND. !EMPTY(apinvhdr.cvenccven)
  IF loFormSet.AriaForm1.pgfpayInv.pgHead.cboVendPmeth.VALUE <> 'C' .AND. !EMPTY(apinvhdr.cvenccven)
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    ** MESSAGE : " This invoice is a credit card payment for "
    **           " vendor  invoice .                       "
    **           "                     Ok                  "
    =gfModalGen("TRM04034B00000","DIALOG",ALLTRIM(apinvhdr.cvenccven)+"|"+ALLTRIM(apinvhdr.cvenccinv))
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *RETURN
    loFormSet.AriaForm1.pgfpayInv.ACTIVEPAGE = 1
    RETURN .F.
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  ELSE
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *  llOpInvad= gfOpenFile(oAriaApplication.DataDir+'APINVADT','DTYPCOD','SH')  &&lower
    llOpInvad= gfOpenTable('APINVADT','DTYPCOD','SH')  &&lower
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    IF INLIST(loFormSet.ActiveMode,"A","E")

      SELECT(loFormSet.lcTmpDist)
      IF loFormSet.ActiveMode="A"
        IF RECCOUNT() = 0
          SELECT(loFormSet.lcTmpDist)

          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
          *!*	        REPLACE apinvhdr.capacct WITH ;
          *!*	          IIF(!EMPTY(APVENDOR.cAPAcct) , APVENDOR.cAPAcct ,;
          *!*	               IIF(SEEK(loFormSet.AriaForm1.cboDivision.Value , 'APDIV') .AND.;
          *!*	                   !EMPTY(APDIV.cAPAcct) , APDIV.cAPAcct ,APSETUP.cAPAcct)) IN apinvhdr
          *loFormSet.DistLines.glAPActCode.KeyTextBox.Value = apinvhdr.capacct
          SELECT apinvhdr
          gfREPLACE("capacct WITH '"+;
            IIF(!EMPTY(APVENDOR.cAPAcct) , APVENDOR.cAPAcct ,;
            IIF(gfSEEK(loFormSet.AriaForm1.pgfpayInv.pgHead.cboDivision.VALUE , 'APDIV') .AND.;
            !EMPTY(APDIV.cAPAcct) , APDIV.cAPAcct ,APSETUP.cAPAcct)) +"'")
          SELECT(loFormSet.lcTmpDist)
                
          loFormSet.AriaForm1.pgfpayInv.pgDist.glAPActCode.KeyTextBox.VALUE = apinvhdr.capacct
           *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
          APPEND BLANK
          =gfAdd_Info(loFormSet.lcTmpDist)
           *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
          *!*	        REPLACE CVENDCODE WITH loFormSet.AriaForm1.KBVendCode.KeyTextBox.Value  ,;
          *!*	                CINVNO    WITH loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value  ,;
          *!*	                DAPDTRDAT WITH loFormSet.AriaForm1.DtPostDate.Value ,;
          *!*	                LAPDPOST  WITH .F.        ,;
          *!*	                CAPDGLACT WITH loFormSet.DistLines.glAPActCode.KeyTextBox.Value ,;
          *!*	                NAPDAMNT  WITH -loFormSet.AriaForm1.txtInvAmount.Value,;
          *!*	                CAPDACTID WITH 'A'        ,;
          *!*	                CAPDREF   WITH loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value  ,;
          *!*	                CFISFYEAR WITH loFormSet.lcDistYer  ,;
          *!*	                CFSPPRDID WITH loFormSet.lcDistPrd  ,;
          *!*	                CAPSESSNO WITH loFormSet.lcSequence ,;
          *!*	                CAPDTRTYP WITH 'I'        ,;
          *!*	                CSTATUS   WITH 'A'
          REPLACE CVENDCODE WITH loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE  ,;
            CINVNO    WITH loFormSet.AriaForm1.kbInvNo.KeyTextBox.VALUE  ,;
            DAPDTRDAT WITH loFormSet.AriaForm1.DtPostDate.VALUE ,;
            LAPDPOST  WITH .F.        ,;
            CAPDGLACT WITH loFormSet.AriaForm1.pgfpayInv.pgDist.glAPActCode.KeyTextBox.VALUE ,;
            NAPDAMNT  WITH -loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.VALUE,;
            CAPDACTID WITH 'A'        ,;
            CAPDREF   WITH loFormSet.AriaForm1.kbInvNo.KeyTextBox.VALUE  ,;
            CFISFYEAR WITH loFormSet.lcDistYer  ,;
            CFSPPRDID WITH loFormSet.lcDistPrd  ,;
            CAPSESSNO WITH loFormSet.lcSequence ,;
            CAPDTRTYP WITH 'I'        ,;
            CSTATUS   WITH 'A'
           *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
        ELSE
          SELECT(loFormSet.lcTmpDist)
          LOCATE FOR CAPDACTID = 'A'
           *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
          *REPLACE NAPDAMNT WITH -loFormSet.AriaForm1.txtInvAmount.Value
          REPLACE NAPDAMNT WITH -loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.VALUE
           *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[END]
          =gfAdd_Info(loFormSet.lcTmpDist)
        ENDIF
      ENDIF
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *!*	    IF loFormSet.ActiveMode="E" AND TYPE('loFormSet.AriaForm1.txtInvAmount.OldValue')='N' ;
      *!*	      AND loFormSet.AriaForm1.txtInvAmount.Value <> loFormSet.AriaForm1.txtInvAmount.OldValue
      IF loFormSet.ActiveMode="E" AND TYPE('loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.OldValue')='N' ;
          AND loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.VALUE <> loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.OldValue
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
        LOCATE FOR CAPDACTID = 'A' .AND. EMPTY(CAPDSTAT)
        lnSavApRec = RECNO()
        IF CSTATUS = 'A'
          SCATTER MEMVAR MEMO
          m.cStatus  = 'A'
          m.cApdStat = ' '
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
          *m.nApdAmnt = -loFormSet.AriaForm1.txtInvAmount.Value
          m.nApdAmnt = -loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.VALUE
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
          m.lAPDPost = .F.
          m.cBatchNo = ' '
          m.cTrnSledn= ' '
          m.cAPSessNo= loFormSet.lcSequence
          m.nEntryNo = 0
          GATHER MEMVAR MEMO
        ELSE
          REPLACE CAPDSTAT  WITH 'V'        ,;
            CAPSESSNO WITH loFormSet.lcSequence ,;
            CSTATUS   WITH 'M'
          SCATTER MEMVAR MEMO
          m.nApdAmnt = -1 * m.nApdAmnt
          m.cStatus  = 'A'
          m.lAPDPost = .F.
          m.cBatchNo = ' '
          m.cTrnSledn= ' '
          m.nEqvAmnt = -1 * m.nEqvAmnt
          m.nEntryNo = 0
          APPEND BLANK
          =gfAdd_Info(loFormSet.lcTmpDist)
          GATHER MEMVAR MEMO
          IF BETWEEN(lnSavApRec,0,RECCOUNT())
            GO lnSavApRec
          ENDIF
          SCATTER MEMVAR MEMO
          m.cStatus  = 'A'
          m.cApdStat = ' '
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
          *m.nApdAmnt = -loFormSet.AriaForm1.txtInvAmount.Value
          m.nApdAmnt = -loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.VALUE
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
          m.lAPDPost = .F.
          m.cBatchNo = ' '
          m.cTrnSledn= ' '
          m.cAPSessNo= loFormSet.lcSequence
          m.nEntryNo = 0
          APPEND BLANK
          =gfAdd_Info(loFormSet.lcTmpDist)
          GATHER MEMVAR MEMO
        ENDIF
      ENDIF
      SELECT(loFormSet.lcTmpDist)
      GO TOP
      IF !EOF()
        SKIP 1
      ENDIF
      DO CASE
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
          *CASE !EMPTY(loFormSet.AriaForm1.kbAutmCode.KeyTextBox.Value) .AND. loFormSet.lnLineNo = 0
        CASE !EMPTY(loFormSet.AriaForm1.pgfpayInv.pgHead.kbAutmCode.KeyTextBox.VALUE) .AND. loFormSet.lnLineNo = 0
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
          SELECT APINVADT
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
          *!*	        IF SEEK('T'+loFormSet.AriaForm1.kbAutmCode.KeyTextBox.Value)
          *!*	          SCAN REST WHILE CAUTMTYPE+CAUTMCODE = 'T'+loFormSet.AriaForm1.kbAutmCode.KeyTextBox.Value
          IF SEEK('T'+loFormSet.AriaForm1.pgfpayInv.pgHead.kbAutmCode.KeyTextBox.VALUE)
            SCAN REST WHILE CAUTMTYPE+CAUTMCODE = 'T'+loFormSet.AriaForm1.pgfpayInv.pgHead.kbAutmCode.KeyTextBox.VALUE
           *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
              IF loFormSet.AriaForm1.ap1.llApGlLink
                IF !SEEK(APINVADT.CAPDGLACT,'lcLinkChar')
                  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
                  *=gfModalGen("TRM04110B00000","DIALOG",ALLTRIM(loFormSet.AriaForm1.kbAutmCode.KeyTextBox.Value)+'|'+ALLTRIM(APINVADT.CAPDGLACT))
                  =gfModalGen("TRM04110B00000","DIALOG",ALLTRIM(loFormSet.AriaForm1.pgfpayInv.pgHead.kbAutmCode.KeyTextBox.VALUE)+'|'+ALLTRIM(APINVADT.CAPDGLACT))
                  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[ENd]
                  SELECT(loFormSet.lcTmpDist)
                  SCAN
                    IF CAPDACTID <> 'A'
                      REPLACE CSTATUS WITH 'S'
                      DELETE
                    ENDIF
                  ENDSCAN
                  SELECT APINVHDR
                  loFormSet.lcTmplate = 'ENABLE'
                  *_CUROBJ = OBJNUM(loFormSet.AriaForm1.kbAutmCode.KeyTextBox.Value)
                  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
                  *loFormSet.AriaForm1.kbAutmCode.KeyTextBox.SetFocus()
                  loFormSet.AriaForm1.pgfpayInv.pgHead.kbAutmCode.KeyTextBox.SETFOCUS()
                  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
                  RETURN
                ELSE
                  SELECT(loFormSet.lcTmpDist)
                  *** Add the distribution account. ***
                  APPEND BLANK
                  =gfAdd_Info(loFormSet.lcTmpDist)
                  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
                  *!*	                REPLACE CVENDCODE WITH loFormSet.AriaForm1.KBVendCode.KeyTextBox.Value  ,;
                  *!*	                        CINVNO    WITH loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value  ,;
                  *!*	                        DAPDTRDAT WITH loFormSet.AriaForm1.DtPostDate.Value ,;
                  *!*	                        LAPDPOST  WITH .F.        ,;
                  *!*	                        CAPDREF   WITH loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value  ,;
                  *!*	                        CAPDACTID WITH 'D'        ,;
                  *!*	                        CFISFYEAR WITH loFormSet.lcDistYer  ,;
                  *!*	                        CFSPPRDID WITH loFormSet.lcDistPrd  ,;
                  *!*	                        CAPSESSNO WITH loFormSet.lcSequence ,;
                  *!*	                        CAPDTRTYP WITH 'I'        ,;
                  *!*	                        CSTATUS   WITH 'A'        ,;
                  *!*	                        NAPDLINNO WITH lfvLineNo(loFormSet),;
                  *!*	                        CTAXCODE  WITH APINVADT.CTAXCODE,;
                  *!*	                        CAPDGLACT WITH APINVADT.CAPDGLACT,;
                  *!*	                        NAPDAMNT  WITH APINVADT.NAPDAMNT * loFormSet.AriaForm1.txtInvAmount.Value / 100
                  REPLACE CVENDCODE WITH loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE  ,;
                    CINVNO    WITH loFormSet.AriaForm1.kbInvNo.KeyTextBox.VALUE  ,;
                    DAPDTRDAT WITH loFormSet.AriaForm1.DtPostDate.VALUE ,;
                    LAPDPOST  WITH .F.        ,;
                    CAPDREF   WITH loFormSet.AriaForm1.kbInvNo.KeyTextBox.VALUE  ,;
                    CAPDACTID WITH 'D'        ,;
                    CFISFYEAR WITH loFormSet.lcDistYer  ,;
                    CFSPPRDID WITH loFormSet.lcDistPrd  ,;
                    CAPSESSNO WITH loFormSet.lcSequence ,;
                    CAPDTRTYP WITH 'I'        ,;
                    CSTATUS   WITH 'A'        ,;
                    NAPDLINNO WITH lfvLineNo(loFormSet),;
                    CTAXCODE  WITH APINVADT.CTAXCODE,;
                    CAPDGLACT WITH APINVADT.CAPDGLACT,;
                    NAPDAMNT  WITH APINVADT.NAPDAMNT * loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.VALUE / 100
                  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

                  loFormSet.lnDistAmnt = loFormSet.lnDistAmnt + NAPDAMNT
                ENDIF
              ELSE
                SELECT(loFormSet.lcTmpDist)
                *** Add the distribution account. ***
                APPEND BLANK
                =gfAdd_Info(loFormSet.lcTmpDist)
                *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
                *!*	              REPLACE CVENDCODE WITH loFormSet.AriaForm1.KBVendCode.KeyTextBox.Value  ,;
                *!*	                      CINVNO    WITH loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value  ,;
                *!*	                      DAPDTRDAT WITH loFormSet.AriaForm1.DtPostDate.Value ,;
                *!*	                      LAPDPOST  WITH .F.        ,;
                *!*	                      CAPDREF   WITH loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value  ,;
                *!*	                      CAPDACTID WITH 'D'        ,;
                *!*	                      CFISFYEAR WITH loFormSet.lcDistYer  ,;
                *!*	                      CFSPPRDID WITH loFormSet.lcDistPrd  ,;
                *!*	                      CAPSESSNO WITH loFormSet.lcSequence ,;
                *!*	                      CAPDTRTYP WITH 'I'        ,;
                *!*	                      CSTATUS   WITH 'A'        ,;
                *!*	                      NAPDLINNO WITH lfvLineNo(loFormSet),;
                *!*	                      CTAXCODE  WITH APINVADT.CTAXCODE,;
                *!*	                      CAPDGLACT WITH APINVADT.CAPDGLACT,;
                *!*	                      NAPDAMNT  WITH APINVADT.NAPDAMNT * loFormSet.AriaForm1.txtInvAmount.Value / 100
                REPLACE CVENDCODE WITH loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE  ,;
                  CINVNO    WITH loFormSet.AriaForm1.kbInvNo.KeyTextBox.VALUE  ,;
                  DAPDTRDAT WITH loFormSet.AriaForm1.DtPostDate.VALUE ,;
                  LAPDPOST  WITH .F.        ,;
                  CAPDREF   WITH loFormSet.AriaForm1.kbInvNo.KeyTextBox.VALUE  ,;
                  CAPDACTID WITH 'D'        ,;
                  CFISFYEAR WITH loFormSet.lcDistYer  ,;
                  CFSPPRDID WITH loFormSet.lcDistPrd  ,;
                  CAPSESSNO WITH loFormSet.lcSequence ,;
                  CAPDTRTYP WITH 'I'        ,;
                  CSTATUS   WITH 'A'        ,;
                  NAPDLINNO WITH lfvLineNo(loFormSet),;
                  CTAXCODE  WITH APINVADT.CTAXCODE,;
                  CAPDGLACT WITH APINVADT.CAPDGLACT,;
                  NAPDAMNT  WITH APINVADT.NAPDAMNT * loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.VALUE / 100
                *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
                loFormSet.lnDistAmnt = loFormSet.lnDistAmnt + NAPDAMNT
              ENDIF
              SELECT APINVADT
            ENDSCAN
          ENDIF
        CASE loFormSet.ActiveMode="A" .AND. RECCOUNT(loFormSet.lcTmpDist) = 1 AND EMPTY(loFormSet.lcVenInvTypes)
          SELECT(loFormSet.lcTmpDist)

          *B602946,1 Add this line to get the default Expense Account [Begin]
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
          *!*	        *loFormSet.lcDistAcct = IIF(!EMPTY(APVENDOR.cExpAcct) , APVENDOR.cExpAcct ,;
          *!*	                         IIF(SEEK(loFormSet.AriaForm1.cboDivision.Value , 'APDIV') .AND.;
          *!*	                             !EMPTY(APDIV.cExpAcct) , APDIV.cExpAcct ,;
          *!*	                             APSETUP.cExpAcct))
          loFormSet.lcDistAcct = IIF(!EMPTY(APVENDOR.cExpAcct) , APVENDOR.cExpAcct ,;
            IIF(gfSEEK(loFormSet.AriaForm1.pgfpayInv.pgHead.cboDivision.VALUE , 'APDIV') .AND.;
            !EMPTY(APDIV.cExpAcct) , APDIV.cExpAcct ,;
            APSETUP.cExpAcct))
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
          *B602946,1 Add this line to get the default Expense Account [End]

          *** Add the distribution account. ***
          APPEND BLANK
          =gfAdd_Info(loFormSet.lcTmpDist)
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
          *!*	        REPLACE CVENDCODE WITH loFormSet.AriaForm1.KBVendCode.KeyTextBox.Value  ,;
          *!*	                CINVNO    WITH loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value  ,;
          *!*	                DAPDTRDAT WITH loFormSet.AriaForm1.DtPostDate.Value ,;
          *!*	                LAPDPOST  WITH .F.        ,;
          *!*	                CAPDGLACT WITH loFormSet.lcDistAcct ,;
          *!*	                NAPDAMNT  WITH loFormSet.AriaForm1.txtInvAmount.Value ,;
          *!*	                CAPDREF   WITH loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value  ,;
          *!*	                CAPDACTID WITH 'D'        ,;
          *!*	                CFISFYEAR WITH loFormSet.lcDistYer  ,;
          *!*	                CFSPPRDID WITH loFormSet.lcDistPrd  ,;
          *!*	                CAPSESSNO WITH loFormSet.lcSequence ,;
          *!*	                CAPDTRTYP WITH 'I'        ,;
          *!*	                CSTATUS   WITH 'A'        ,;
          *!*	                NAPDLINNO WITH lfvLineNo(loFormSet)
          REPLACE CVENDCODE WITH loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE  ,;
            CINVNO    WITH loFormSet.AriaForm1.kbInvNo.KeyTextBox.VALUE  ,;
            DAPDTRDAT WITH loFormSet.AriaForm1.DtPostDate.VALUE ,;
            LAPDPOST  WITH .F.        ,;
            CAPDGLACT WITH loFormSet.lcDistAcct ,;
            NAPDAMNT  WITH loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.VALUE ,;
            CAPDREF   WITH loFormSet.AriaForm1.kbInvNo.KeyTextBox.VALUE  ,;
            CAPDACTID WITH 'D'        ,;
            CFISFYEAR WITH loFormSet.lcDistYer  ,;
            CFSPPRDID WITH loFormSet.lcDistPrd  ,;
            CAPSESSNO WITH loFormSet.lcSequence ,;
            CAPDTRTYP WITH 'I'        ,;
            CSTATUS   WITH 'A'        ,;
            NAPDLINNO WITH lfvLineNo(loFormSet)
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
          loFormSet.lnDistAmnt = loFormSet.lnDistAmnt + NAPDAMNT
      ENDCASE
      SELECT(loFormSet.lcTmpDist)
      GO TOP
      IF !EOF()
        SKIP 1
      ENDIF
      *E300798,1 Disable Editing Distribution lines created for invoice lines
      IF loFormSet.llLokPer OR !EMPTY(loFormSet.lcVenInvTypes)
        loFormSet.llNewStat  = .F.
        *Old: SHOW GET pbNew    DISABLE &&Revise
        *Old: SHOW GET pbRemove DISABLE &&Revise
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        *!*	      loFormSet.DistLines.cmdNew.Enabled = .F.
        *!*	      loFormSet.DistLines.cmdRemove.Enabled = .F.
        loFormSet.AriaForm1.pgfpayInv.pgDist.cmdNew.ENABLED = .F.
        loFormSet.AriaForm1.pgfpayInv.pgDist.cmdRemove.ENABLED = .F.
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      ENDIF
      IF loFormSet.llLokPer
        *Old: SHOW GET loFormSet.DistLines.glAPActCode.KeyTextBox.Value DISABLE  &&lower &&Revise
        *Old: SHOW GET ibApAcc    DISABLE &&Revise
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        *loFormSet.DistLines.glAPActCode.Enabled = .F.
        loFormSet.AriaForm1.pgfpayInv.pgDist.glAPActCode.ENABLED = .F.
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      ENDIF
    ELSE
      SELECT APINVHDR
      IF !EOF()
        GO RECNO()
      ENDIF
      SELECT APDIST
      loFormSet.llNewStat = .F.
      *Old: SHOW GET pbNew      DISABLE &&Revise
      *Old: SHOW GET pbRemove   DISABLE &&Revise
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *!*	    loFormSet.DistLines.cmdNew.Enabled = .F.
      *!*	    loFormSet.DistLines.cmdRemove.Enabled = .F.
      *!*	    *Old: SHOW GET loFormSet.DistLines.glAPActCode.KeyTextBox.Value DISABLE  &&lower &&Revise
      *!*	    *Old: SHOW GET ibApAcc    DISABLE &&Revise
      *!*	    loFormSet.DistLines.glAPActCode.Enabled = .F.
      loFormSet.AriaForm1.pgfpayInv.pgDist.cmdNew.ENABLED = .F.
      loFormSet.AriaForm1.pgfpayInv.pgDist.cmdRemove.ENABLED = .F.
      *Old: SHOW GET loFormSet.DistLines.glAPActCode.KeyTextBox.Value DISABLE  &&lower &&Revise
      *Old: SHOW GET ibApAcc    DISABLE &&Revise
      loFormSet.AriaForm1.pgfpayInv.pgDist.glAPActCode.ENABLED = .F.
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    ENDIF
    *Old: RELEASE WINDOW (loFormSet.lcBrowsTtl)
    loFormSet.lcTmplate = 'DISABLE'
    *Old: SHOW GET loFormSet.AriaForm1.kbAutmCode.KeyTextBox.Value DISABLE  &&lower &&Revise
    *Old: SHOW GET ibTemplate DISABLE &&Revise
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *loFormSet.AriaForm1.kbAutmCode.Enabled =.F.
    loFormSet.AriaForm1.pgfpayInv.pgHead.kbAutmCode.ENABLED =.F.
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    *Old: loFormSet.lcCodeFilt = ''
    =lfDispObjct(loFormSet)
    =lfBrowse(loFormSet)
    *Old: =lfRefresh()
    *Old: =gfActWind('CWRAPDISTR',loFormSet.lcTChldTitl,gcBaseWind)
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *loFormSet.DistLines.Show()
    loFormSet.AriaForm1.pgfpayInv.pgDist.ENABLED = .T.
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  ENDIF
  IF USED('APINVADT') .AND. llOpInvad
    *Old: =gfCloseFile('APINVADT')
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *USE IN APINVADT
    =gfCloseTable('APINVADT')
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  ENDIF

  RETURN
  *--end of lfvDistrib



  *!*************************************************************
  *! Name      : lfvApAccount
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 8/8/2004
  *! Purpose   : To validate the AP account in the Ditribution Lines screen
  *!*************************************************************
  *! Parameters: The FormSet
  *!*************************************************************
  *! Returns   : None
  *!**************************************************************
FUNCTION lfvApAccount
  LPARAMETERS loFormSet
  LOCAL lcFilt

  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	IF loFormSet.DistLines.glAPActCode.SelectedFromBrowse OR ;
  *!*	  loFormSet.DistLines.glAPActCode.KeyTextBox.OldValue<>loFormSet.DistLines.glAPActCode.KeyTextBox.Value
  *!*	  IF EMPTY(STRTRAN(STRTRAN(loFormSet.DistLines.glAPActCode.KeyTextBox.Value,'-'),'0'))
  *!*	    loFormSet.DistLines.glAPActCode.KeyTextBox.Value = ;
  *!*	      loFormSet.DistLines.glAPActCode.KeyTextBox.OldValue
  IF loFormSet.AriaForm1.pgfpayInv.pgDist.glAPActCode.SelectedFromBrowse OR ;
      loFormSet.AriaForm1.pgfpayInv.pgDist.glAPActCode.KeyTextBox.OldValue<>loFormSet.AriaForm1.pgfpayInv.pgDist.glAPActCode.KeyTextBox.VALUE
    IF EMPTY(STRTRAN(STRTRAN(loFormSet.AriaForm1.pgfpayInv.pgDist.glAPActCode.KeyTextBox.VALUE,'-'),'0'))
      loFormSet.AriaForm1.pgfpayInv.pgDist.glAPActCode.KeyTextBox.VALUE = ;
        loFormSet.AriaForm1.pgfpayInv.pgDist.glAPActCode.KeyTextBox.OldValue
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    ELSE
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *!*	    IF loFormSet.DistLines.glAPActCode.KeyTextBox.OldValue <> ;
      *!*	      loFormSet.DistLines.glAPActCode.KeyTextBox.Value
      IF loFormSet.AriaForm1.pgfpayInv.pgDist.glAPActCode.KeyTextBox.OldValue <> ;
          loFormSet.AriaForm1.pgfpayInv.pgDist.glAPActCode.KeyTextBox.VALUE
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
        IF (apinvhdr.ninvpaid+apinvhdr.ninvdistk+apinvhdr.ninvadj) > 0
          ** MESSAGE : " This invoice is  paid.  You have "
          **           " to make an adjustment entry in GL "
          **           " to clear the old AP account.      "
          **           "                 Ok              "
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
          *=gfModalGen('QRM04039B00000','Dialog',IIF(apinvhdr.ninvpaid+apinvhdr.ninvdistk+apinvhdr.ninvadj = loFormSet.AriaForm1.txtInvAmount.Value,loFormSet.lcTFully,loFormSet.lcTPart))
          =gfModalGen('QRM04039B00000','Dialog',IIF(apinvhdr.ninvpaid+apinvhdr.ninvdistk+apinvhdr.ninvadj = loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.VALUE,loFormSet.lcTFully,loFormSet.lcTPart))
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[END]
        ENDIF


        SELECT(loFormSet.lcTmpDist)
        lcFilt = FILTER()
        SET FILTER TO
        lnSavRecNo = RECNO()
        LOCATE FOR CAPDACTID = 'A'
        lnSavApRec = RECNO()
        IF loFormSet.ActiveMode="A"
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
          *REPLACE CAPDGLACT WITH loFormSet.DistLines.glAPActCode.KeyTextBox.Value
          REPLACE CAPDGLACT WITH loFormSet.AriaForm1.pgfpayInv.pgDist.glAPActCode.KeyTextBox.VALUE
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[END]
          =gfAdd_Info(loFormSet.lcTmpDist)
          IF BETWEEN(lnSavRecNo,0,RECCOUNT())
            GO lnSavRecNo
          ENDIF
        ELSE
          IF CSTATUS = 'S' .AND. UPDATED() && IF the record is modified.
            *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
            *=lfvUpdTemp(loFormSet,'capdglact',loFormSet.DistLines.glAPActCode.KeyTextBox.OldValue)
            =lfvUpdTemp(loFormSet,'capdglact',loFormSet.AriaForm1.pgfpayInv.pgDist.glAPActCode.KeyTextBox.OldValue)
            *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[END]
            IF BETWEEN(lnSavApRec,0,RECCOUNT())
              GO lnSavApRec
            ENDIF
            *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
            *!*	          REPLACE CAPDGLACT WITH loFormSet.DistLines.glAPActCode.KeyTextBox.Value ,;
            *!*	                  CSTATUS   WITH 'M'        ,;
            *!*	                  LAPDPOST  WITH .F.        ,;
            *!*	                  CBATCHNO  WITH ' '        ,;
            *!*	                  CTRNSLEDN WITH ' '        ,;
            *!*	                  CAPSESSNO WITH loFormSet.lcSequence ,;
            *!*	                  CUPDSERNO WITH ' '        ,;
            *!*	                  nEntryNo  WITH 0
            REPLACE CAPDGLACT WITH loFormSet.AriaForm1.pgfpayInv.pgDist.glAPActCode.KeyTextBox.VALUE ,;
              CSTATUS   WITH 'M'        ,;
              LAPDPOST  WITH .F.        ,;
              CBATCHNO  WITH ' '        ,;
              CTRNSLEDN WITH ' '        ,;
              CAPSESSNO WITH loFormSet.lcSequence ,;
              CUPDSERNO WITH ' '        ,;
              nEntryNo  WITH 0
            *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[END]
            =gfAdd_Info(loFormSet.lcTmpDist)
            IF BETWEEN(lnSavRecNo,0,RECCOUNT())
              GO lnSavRecNo
            ENDIF
          ENDIF
        ENDIF
        IF BETWEEN(lnSavRecNo,0,RECCOUNT())
          GO lnSavRecNo
        ENDIF
      ENDIF
    ENDIF
  ENDIF

  *Old: SHOW GET loFormSet.DistLines.glAPActCode.KeyTextBox.Value  &&lower &&Revise
  SELECT(loFormSet.lcTmpDist)
  IF !EMPTY(lcFilt)
    SET FILTER TO &lcFilt
  ENDIF

  *Old: =lfvTrapKey()
  lfDistRefresh(loFormSet)
  *Old: IF SUBSTR(gcBaseWind,4,LEN(gcBaseWind)) = loFormSet.lcActProg
  *Old: =lfRefresh()
  *Old: ENDIF

  RETURN
  *--end of lfvApAccount


  *!*************************************************************
  *! Name      : lfvLineNo
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 8/8/2004
  *! Purpose   : To Increment the Line No. in the Ditribution Lines screen
  *!*************************************************************
  *! Parameters: The FormSet
  *!*************************************************************
  *! Returns   : None
  *!**************************************************************
FUNCTION lfvLineNo
  LPARAMETERS loFormSet

  loFormSet.lnLineNo = loFormSet.lnLineNo + 1

  RETURN loFormSet.lnLineNo
  *--end of lfvLineNo


  *!*************************************************************
  *! Name      : lfvTaxCode
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 8/8/2004
  *! Purpose   : To validate the Tax Code Control in the Ditribution Lines screen
  *!*************************************************************
  *! Parameters: The FormSet
  *!*************************************************************
  *! Returns   : None
  *!**************************************************************
FUNCTION lfvTaxCode
  LPARAMETERS loFormSet
  LOCAL lcFilt


  PRIVATE lcOldTax, lcOldAcct

  *Old: lcOldTax  = &loFormSet.lcTmpDist..cTaxCode
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	lcOldTax  = loFormSet.DistLines.cboTaxCode.OldValue
  *!*	*Old: lcOldAcct = &loFormSet.lcTmpDist..cApDGlAct
  *!*	lcOldAcct = loFormSet.DistLines.glActCode.KeyTextbox.OldValue
  *!*	*Old: puTax     = CODES.cdiscrep

  *!*	*! B608045,1 MMT 04/16/2007 fix bug or wrong record in grid after selecting GL account[Start]
  *!*	*puTax = loFormSet.DistLines.cboTaxCode.Text
  *!*	puTax = loFormSet.DistLines.cboTaxCode.DisplayValue
  *!*	*! B608045,1 MMT 04/16/2007 fix bug or wrong record in grid after selecting GL account[End]

  *!*	*Old: loFormSet.lcTaxCode = CODES.cCode_No
  *!*	loFormSet.lcTaxCode = loFormSet.DistLines.cboTaxCode.Value
  lcOldTax  = loFormSet.AriaForm1.pgfpayInv.pgDist.cboTaxCode.OldValue
  *Old: lcOldAcct = &loFormSet.lcTmpDist..cApDGlAct
  lcOldAcct = loFormSet.AriaForm1.pgfpayInv.pgDist.glActCode.KeyTextbox.OldValue
  *Old: puTax     = CODES.cdiscrep
  *puTax = loFormSet.DistLines.cboTaxCode.Text
  puTax = loFormSet.AriaForm1.pgfpayInv.pgDist.cboTaxCode.DISPLAYVALUE
  *Old: loFormSet.lcTaxCode = CODES.cCode_No
  loFormSet.lcTaxCode = loFormSet.AriaForm1.pgfpayInv.pgDist.cboTaxCode.VALUE
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[END]

  *Old: SHOW GET puTax &&Revise
  loFormSet.lcCodeFilt = ''

  *IF LASTKEY() = 13 OR LASTKEY() = 32
  IF LASTKEY()<>27
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *IF !EMPTY(loFormSet.DistLines.cboTaxCode.Value)
    IF !EMPTY(loFormSet.AriaForm1.pgfpayInv.pgDist.cboTaxCode.VALUE)
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      DIMENSION laTaxAry[ALEN(loFormSet.laTaxAry,1),ALEN(loFormSet.laTaxAry,2)]
      =ACOPY(loFormSet.laTaxAry,laTaxAry)
      =gfRltFld(loFormSet.lcTaxCode , @laTaxAry , 'CTAXCODE')
      =ACOPY(laTaxAry,loFormSet.laTaxAry)
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *!*	    loFormSet.DistLines.glActCode.KeyTextbox.Value = ;
      *!*	      IIF(!EMPTY(STRTRAN(STRTRAN(loFormSet.DistLines.glActCode.KeyTextbox.Value,'-'),'0')),;
      *!*	           loFormSet.DistLines.glActCode.KeyTextbox.Value,loFormSet.AriaForm1.ap1.lcemptyacc)
      loFormSet.AriaForm1.pgfpayInv.pgDist.glActCode.KeyTextbox.VALUE = ;
        IIF(!EMPTY(STRTRAN(STRTRAN(loFormSet.AriaForm1.pgfpayInv.pgDist.glActCode.KeyTextbox.VALUE,'-'),'0')),;
        loFormSet.AriaForm1.pgfpayInv.pgDist.glActCode.KeyTextbox.VALUE,loFormSet.AriaForm1.ap1.lcemptyacc)
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      ** If there is a G/L link, validate the G/L input account,
      ** from the chart of accounts.
      ** If it is not found, present the following message and
      ** reset tax code to N/A.

      ** Message :    "    G/L input account   for tax code      "
      **              "    is not found in the chart of accounts.  "
      **              "    You cannot select this tax code.        "

      *! B608045,1 MMT 04/16/2007 fix bug or wrong record in grid after selecting GL account[Start]
      *IF loFormSet.AriaForm1.ap1.llApGlLink .AND. ;
      !SEEK(loFormSet.DistLines.glActCode.KeyTextbox.Value, 'lcLinkChar')
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *!*	    IF loFormSet.AriaForm1.ap1.llApGlLink .AND. ;
      *!*	      !SEEK(ALLTRIM(loFormSet.DistLines.glActCode.KeyTextbox.Value), 'lcLinkChar')
      IF loFormSet.AriaForm1.ap1.llApGlLink .AND. ;
          !SEEK(ALLTRIM(loFormSet.AriaForm1.pgfpayInv.pgDist.glActCode.KeyTextbox.VALUE), 'lcLinkChar')
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
        *! B608045,1 MMT 04/16/2007 fix bug or wrong record in grid after selecting GL account[End]

        *! B608045,1 MMT 04/16/2007 fix bug or wrong record in grid after selecting GL account[Start]
        *loFormSet.lcTaxDesMs = puTax
        *=gfModalGen("TRM04091B00000","DIALOG",;
        ALLTRIM(loFormSet.DistLines.glActCode.KeyTextbox.Value)+'|'+;
        ALLTRIM(loFormSet.lcTaxDesMs))
        loFormSet.lcTaxDes = puTax
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        *!*	      =gfModalGen("TRM04091B00000","DIALOG",;
        *!*	        ALLTRIM(loFormSet.DistLines.glActCode.KeyTextbox.Value)+'|'+;
        *!*	        ALLTRIM(loFormSet.lcTaxDes))
        =gfModalGen("TRM04091B00000","DIALOG",;
          ALLTRIM(loFormSet.AriaForm1.pgfpayInv.pgDist.glActCode.KeyTextbox.VALUE)+'|'+;
          ALLTRIM(loFormSet.lcTaxDes))
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
        *! B608045,1 MMT 04/16/2007 fix bug or wrong record in grid after selecting GL account[End]
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        *!*	      IF loFormSet.DistLines.cboTaxCode.Value <> lcOldTax
        *!*	        loFormSet.DistLines.cboTaxCode.Value  = lcOldTax
        *!*	        loFormSet.DistLines.glActCode.KeyTextbox.Value = lcOldAcct
        *!*	        loFormSet.lcTaxDes   = gfCodDes(loFormSet.DistLines.cboTaxCode.Value , 'CTAXCODE')
        IF loFormSet.AriaForm1.pgfpayInv.pgDist.cboTaxCode.VALUE <> lcOldTax
          loFormSet.AriaForm1.pgfpayInv.pgDist.cboTaxCode.VALUE  = lcOldTax
          loFormSet.AriaForm1.pgfpayInv.pgDist.glActCode.KeyTextbox.VALUE = lcOldAcct
          loFormSet.lcTaxDes   = gfCodDes(loFormSet.AriaForm1.pgfpayInv.pgDist.cboTaxCode.VALUE , 'CTAXCODE')
          puTax      = loFormSet.lcTaxDes
        ELSE
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
          *!*	        loFormSet.DistLines.cboTaxCode.Value   = SPACE(6)
          *!*	        loFormSet.DistLines.glActCode.KeyTextbox.Value = lcOldAcct
          loFormSet.AriaForm1.pgfpayInv.pgDist.cboTaxCode.VALUE   = SPACE(6)
          loFormSet.AriaForm1.pgfpayInv.pgDist.glActCode.KeyTextbox.VALUE = lcOldAcct
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
          loFormSet.lcTaxDes   = loFormSet.lcEmptyCode
          puTax      = loFormSet.lcTaxDes
        ENDIF
        *Old: SHOW GET puTax &&Revise
      ENDIF
    ENDIF
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *!*	  IF !EMPTY(loFormSet.DistLines.cboTaxCode.Value)
    *!*	    *Old: SHOW GET lcApdGlAct DISABLE &&Revise
    *!*	    *Old: SHOW GET ibApGlAcc  DISABLE &&Revise
    *!*	    loFormSet.DistLines.glActCode.Enabled = .F.
    IF !EMPTY(loFormSet.AriaForm1.pgfpayInv.pgDist.cboTaxCode.VALUE)
      *Old: SHOW GET lcApdGlAct DISABLE &&Revise
      *Old: SHOW GET ibApGlAcc  DISABLE &&Revise
      loFormSet.AriaForm1.pgfpayInv.pgDist.glActCode.ENABLED = .F.
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      loFormSet.llGLActSta = .F.
    ELSE
      *Old: SHOW GET lcApdGlAct ENABLE &&Revise
      *Old: SHOW GET ibApGlAcc  ENABLE &&Revise
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *loFormSet.DistLines.glActCode.Enabled = .T.
      loFormSet.AriaForm1.pgfpayInv.pgDist.glActCode.ENABLED = .T.
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      loFormSet.llGLActSta = .T.
    ENDIF
  ENDIF
  SELECT(loFormSet.lcTmpDist)
  lcFilt = FILTER()
  SET FILTER TO
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *IF loFormSet.DistLines.cboTaxCode.Value <> loFormSet.DistLines.cboTaxCode.OldValue
  IF loFormSet.AriaForm1.pgfpayInv.pgDist.cboTaxCode.VALUE <> loFormSet.AriaForm1.pgfpayInv.pgDist.cboTaxCode.OldValue
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    IF loFormSet.ActiveMode="E"  &&lower
      lnSavRecNo = RECNO()
      IF cStatus = 'S' .AND. UPDATED() && IF the record is modified.
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        *=lfvUpdTemp(loFormSet,'cTaxCode',loFormSet.DistLines.cboTaxCode.OldValue)
        =lfvUpdTemp(loFormSet,'cTaxCode',loFormSet.AriaForm1.pgfpayInv.pgDist.cboTaxCode.OldValue)
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
        IF BETWEEN(lnSavRecNo,0,RECCOUNT())
          GO lnSavRecNo
        ENDIF
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        *!*	      REPLACE CTAXCODE  WITH loFormSet.DistLines.cboTaxCode.Value       ,;
        *!*	              CAPDGLACT WITH loFormSet.DistLines.glActCode.KeyTextbox.Value      ,;
        *!*	              CSTATUS   WITH 'M'             ,;
        *!*	              LAPDPOST  WITH .F.             ,;
        *!*	              CBATCHNO  WITH ' '             ,;
        *!*	              CTRNSLEDN WITH ' '             ,;
        *!*	              CAPSESSNO WITH loFormSet.lcSequence      ,;
        *!*	              CUPDSERNO WITH ' '
        REPLACE CTAXCODE  WITH loFormSet.AriaForm1.pgfpayInv.pgDist.cboTaxCode.VALUE       ,;
          CAPDGLACT WITH loFormSet.AriaForm1.pgfpayInv.pgDist.glActCode.KeyTextbox.VALUE      ,;
          CSTATUS   WITH 'M'             ,;
          LAPDPOST  WITH .F.             ,;
          CBATCHNO  WITH ' '             ,;
          CTRNSLEDN WITH ' '             ,;
          CAPSESSNO WITH loFormSet.lcSequence      ,;
          CUPDSERNO WITH ' '
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
        REPLACE nEntryNo  WITH 0

        =gfAdd_Info(loFormSet.lcTmpDist)
      ELSE
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        *!*	      REPLACE CTAXCODE  WITH loFormSet.DistLines.cboTaxCode.Value, ;
        *!*	              CAPDGLACT WITH loFormSet.DistLines.glActCode.KeyTextbox.Value
        REPLACE CTAXCODE  WITH loFormSet.AriaForm1.pgfpayInv.pgDist.cboTaxCode.VALUE, ;
          CAPDGLACT WITH loFormSet.AriaForm1.pgfpayInv.pgDist.glActCode.KeyTextbox.VALUE
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      ENDIF
    ELSE
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *!*	    REPLACE CTAXCODE WITH loFormSet.DistLines.cboTaxCode.Value  ,;
      *!*	            CAPDGLACT WITH loFormSet.DistLines.glActCode.KeyTextbox.Value
      REPLACE CTAXCODE WITH loFormSet.AriaForm1.pgfpayInv.pgDist.cboTaxCode.VALUE  ,;
        CAPDGLACT WITH loFormSet.AriaForm1.pgfpayInv.pgDist.glActCode.KeyTextbox.VALUE
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    ENDIF
  ENDIF
  *=lfRefresh(lcDisChld1+','+lcDisChld3+','+lcDisChld4+','+lcDisChld5)
  *=lfvTrapKey()
  SELECT(loFormSet.lcTmpDist)
  IF !EMPTY(lcFilt)
    SET FILTER TO &lcFilt
  ENDIF
  lfDistRefresh(loFormSet)
  *DEACTIVATE POPUP puTaxDes

  RETURN
  *--end of lfvTaxCode


  *!*************************************************************
  *! Name      : lfvApGlAcc
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 8/8/2004
  *! Purpose   : To validate the AP GL account in the Ditribution Lines screen
  *!*************************************************************
  *! Parameters: The FormSet
  *!*************************************************************
  *! Returns   : None
  *!**************************************************************
FUNCTION lfvApGlAcc
  LPARAMETERS loFormSet
  LOCAL lcFilt


  SELECT(loFormSet.lcTmpDist)
  lcFilt = FILTER()
  SET FILTER TO

  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	IF loFormSet.DistLines.glActCode.KeyTextbox.OldValue <> ;
  *!*	  loFormSet.DistLines.glActCode.KeyTextbox.Value .AND. ;
  *!*	  !EMPTY(STRTRAN(STRTRAN(loFormSet.DistLines.glActCode.KeyTextbox.Value,'-'),'0'))
  IF loFormSet.AriaForm1.pgfpayInv.pgDist.glActCode.KeyTextbox.OldValue <> ;
      loFormSet.AriaForm1.pgfpayInv.pgDist.glActCode.KeyTextbox.VALUE .AND. ;
      !EMPTY(STRTRAN(STRTRAN(loFormSet.AriaForm1.pgfpayInv.pgDist.glActCode.KeyTextbox.VALUE,'-'),'0'))
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    IF loFormSet.ActiveMode="E"
      lnSavRecNo = RECNO()
      IF cStatus = 'S' .AND. UPDATED() && IF the record is modified.
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        *=lfvUpdTemp(loFormSet,'capdglact',loFormSet.DistLines.glActCode.KeyTextBox.OldValue)
        =lfvUpdTemp(loFormSet,'capdglact',loFormSet.AriaForm1.pgfpayInv.pgDist.glActCode.KeyTextBox.OldValue)
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

        IF BETWEEN(lnSavRecNo,0,RECCOUNT())
          GO lnSavRecNo
        ENDIF
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        *!*	      REPLACE CAPDGLACT WITH ;
        *!*	      IIF(EMPTY(STRTRAN(STRTRAN(loFormSet.DistLines.glActCode.KeyTextbox.Value,'-'),'0')),;
        *!*	          SPACE(loFormSet.DistLines.glActCode.KeyTextbox.Value), loFormSet.DistLines.glActCode.KeyTextbox.Value),;
        *!*	              CSTATUS   WITH 'M'        ,;
        *!*	              LAPDPOST  WITH .F.        ,;
        *!*	              CBATCHNO  WITH ' '        ,;
        *!*	              CTRNSLEDN WITH ' '        ,;
        *!*	              CAPSESSNO WITH loFormSet.lcSequence ,;
        *!*	              CUPDSERNO WITH ' '
        REPLACE CAPDGLACT WITH ;
          IIF(EMPTY(STRTRAN(STRTRAN(loFormSet.AriaForm1.pgfpayInv.pgDist.glActCode.KeyTextbox.VALUE,'-'),'0')),;
          SPACE(loFormSet.AriaForm1.pgfpayInv.pgDist.glActCode.KeyTextbox.VALUE), loFormSet.AriaForm1.pgfpayInv.pgDist.glActCode.KeyTextbox.VALUE),;
          CSTATUS   WITH 'M'        ,;
          LAPDPOST  WITH .F.        ,;
          CBATCHNO  WITH ' '        ,;
          CTRNSLEDN WITH ' '        ,;
          CAPSESSNO WITH loFormSet.lcSequence ,;
          CUPDSERNO WITH ' '
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
        REPLACE nEntryNo  WITH 0

        =gfAdd_Info(loFormSet.lcTmpDist)
      ELSE
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        *!*	      REPLACE CAPDGLACT WITH IIF(EMPTY(STRTRAN(STRTRAN(loFormSet.DistLines.glActCode.KeyTextbox.Value,'-'),'0')),;
        *!*	                             SPACE(loFormSet.DistLines.glActCode.KeyTextbox.Value), ;
        *!*	                             loFormSet.DistLines.glActCode.KeyTextbox.Value)
        REPLACE CAPDGLACT WITH IIF(EMPTY(STRTRAN(STRTRAN(loFormSet.AriaForm1.pgfpayInv.pgDist.glActCode.KeyTextbox.VALUE,'-'),'0')),;
          SPACE(loFormSet.AriaForm1.pgfpayInv.pgDist.glActCode.KeyTextbox.VALUE), ;
          loFormSet.AriaForm1.pgfpayInv.pgDist.glActCode.KeyTextbox.VALUE)
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      ENDIF
    ELSE
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *!*	    REPLACE CAPDGLACT WITH IIF(EMPTY(STRTRAN(STRTRAN(loFormSet.DistLines.glActCode.KeyTextbox.Value,'-'),'0')),;
      *!*	                             SPACE(loFormSet.DistLines.glActCode.KeyTextbox.Value), ;
      *!*	                             loFormSet.DistLines.glActCode.KeyTextbox.Value)
      REPLACE CAPDGLACT WITH IIF(EMPTY(STRTRAN(STRTRAN(loFormSet.AriaForm1.pgfpayInv.pgDist.glActCode.KeyTextbox.VALUE,'-'),'0')),;
        SPACE(loFormSet.AriaForm1.pgfpayInv.pgDist.glActCode.KeyTextbox.VALUE), ;
        loFormSet.AriaForm1.pgfpayInv.pgDist.glActCode.KeyTextbox.VALUE)
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    ENDIF
  ELSE
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *loFormSet.DistLines.glActCode.KeyTextbox.Value = loFormSet.DistLines.glActCode.KeyTextbox.OldValue
    loFormSet.AriaForm1.pgfpayInv.pgDist.glActCode.KeyTextbox.VALUE = loFormSet.AriaForm1.pgfpayInv.pgDist.glActCode.KeyTextbox.OldValue
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  ENDIF

  *Old: SHOW GET loFormSet.lcApdGLAct &&Revise

  *SHOW WINDOW (loFormSet.lcBrowsTtl) REFRESH
  *!B500684,1 MAN 06/01/95
  *=lfRefresh()
  *=lfRefresh(lcDisChld5)
  *=lfvTrapKey()
  SELECT(loFormSet.lcTmpDist)
  IF !EMPTY(lcFilt)
    SET FILTER TO &lcFilt
  ENDIF
  lfDistRefresh(loFormSet)

  RETURN
  *--end of lfvApGlAcc

  *!*************************************************************
  *! Name      : lfvDistAmnt
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 8/8/2004
  *! Purpose   : To validate the Distibuted Amount in the Ditribution Lines screen
  *!*************************************************************
  *! Parameters: The FormSet
  *!*************************************************************
  *! Returns   : None
  *!**************************************************************
FUNCTION lfvDistAmnt
  LPARAMETERS loFormSet
  LOCAL lcFilt
  SELECT(loFormSet.lcTmpDist)
  lcFilt = FILTER()
  SET FILTER TO

  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	IF loFormSet.DistLines.txtlnApdAmnt.Value <> loFormSet.DistLines.txtlnApdAmnt.OldValue
  *!*	  loFormSet.lnDistAmnt = loFormSet.lnDistAmnt - loFormSet.DistLines.txtlnApdAmnt.OldValue + ;
  *!*	                         loFormSet.DistLines.txtlnApdAmnt.Value
  IF loFormSet.AriaForm1.pgfpayInv.pgDist.txtlnApdAmnt.VALUE <> loFormSet.AriaForm1.pgfpayInv.pgDist.txtlnApdAmnt.OldValue
    loFormSet.lnDistAmnt = loFormSet.lnDistAmnt - loFormSet.AriaForm1.pgfpayInv.pgDist.txtlnApdAmnt.OldValue + ;
      loFormSet.AriaForm1.pgfpayInv.pgDist.txtlnApdAmnt.VALUE
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    *B608804,1 WAM 02/17/2009 Don't change the value of the OLDVALUE property
    *B608804,1 WAM 02/17/2009 Followinh line comented out

    *!*	  *B608528,1 MHM 04/21/2008 Invoice Lines-cannot amend the GL account for General Expense Item [Start]
    *!*	  *-Assing value to old Value as it is updated only if you click ENTER
    *!*	  loFormSet.DistLines.txtlnApdAmnt.OldValue = loFormSet.DistLines.txtlnApdAmnt.Value
    *!*	  *B608528,1 MHM 04/21/2008 Invoice Lines-cannot amend the GL account for General Expense Item[END]

    *B608804,1 WAM 02/17/2009 (End)
  ENDIF

  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *IF loFormSet.DistLines.txtlnApdAmnt.Value <> loFormSet.DistLines.txtlnApdAmnt.OldValue
  IF loFormSet.AriaForm1.pgfpayInv.pgDist.txtlnApdAmnt.VALUE <> loFormSet.AriaForm1.pgfpayInv.pgDist.txtlnApdAmnt.OldValue
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    IF loFormSet.ActiveMode="E"  &&lower
      lnSavRecNo = RECNO()
      IF cStatus = 'S' .AND. UPDATED() && IF the record is modified.
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        * =lfvUpdTemp(loFormSet,'napdamnt',loFormSet.DistLines.txtlnApdAmnt.OldValue)
        =lfvUpdTemp(loFormSet,'napdamnt',loFormSet.AriaForm1.pgfpayInv.pgDist.txtlnApdAmnt.OldValue)
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
        IF BETWEEN(lnSavRecNo,0,RECCOUNT())
          GO lnSavRecNo
        ENDIF

        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        *!*	      REPLACE NAPDAMNT  WITH loFormSet.DistLines.txtlnApdAmnt.Value  ,;
        *!*	              CSTATUS   WITH 'M'        ,;
        *!*	              LAPDPOST  WITH .F.        ,;
        *!*	              CBATCHNO  WITH ' '        ,;
        *!*	              CTRNSLEDN WITH ' '        ,;
        *!*	              CAPSESSNO WITH loFormSet.lcSequence ,;
        *!*	              CUPDSERNO WITH ' '
        REPLACE NAPDAMNT  WITH loFormSet.AriaForm1.pgfpayInv.pgDist.txtlnApdAmnt.VALUE  ,;
          CSTATUS   WITH 'M'        ,;
          LAPDPOST  WITH .F.        ,;
          CBATCHNO  WITH ' '        ,;
          CTRNSLEDN WITH ' '        ,;
          CAPSESSNO WITH loFormSet.lcSequence ,;
          CUPDSERNO WITH ' '
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
        *B801498,1 Add these line to clear the entry number [Begin]
        REPLACE nEntryNo  WITH 0
        *B801498,1 Add these line to clear the entry number [End]

        =gfAdd_Info(loFormSet.lcTmpDist)
      ELSE
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        *REPLACE NAPDAMNT WITH loFormSet.DistLines.txtlnApdAmnt.Value
        REPLACE NAPDAMNT WITH loFormSet.AriaForm1.pgfpayInv.pgDist.txtlnApdAmnt.VALUE
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      ENDIF
    ELSE
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      * REPLACE NAPDAMNT WITH loFormSet.DistLines.txtlnApdAmnt.Value
      REPLACE NAPDAMNT WITH loFormSet.AriaForm1.pgfpayInv.pgDist.txtlnApdAmnt.VALUE
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    ENDIF
  ENDIF

  *B608804,1 WAM 02/17/2009 Change the value of the OLDVALUE property here
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *loFormSet.DistLines.txtlnApdAmnt.OldValue = loFormSet.DistLines.txtlnApdAmnt.Value
  loFormSet.AriaForm1.pgfpayInv.pgDist.txtlnApdAmnt.OldValue = loFormSet.AriaForm1.pgfpayInv.pgDist.txtlnApdAmnt.VALUE
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  *B608804,1 WAM 02/17/2009 (End)

  *Old: SHOW GET loFormSet.lnApdAmnt &&Revise
  *!B500684,1 MAN 06/01/95
  *=lfRefresh()
  *=lfRefresh(lcDisChld1)
  *=lfvTrapKey()
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *loFormSet.DistLines.txtUnDist.Refresh()
  loFormSet.AriaForm1.pgfpayInv.pgDist.txtUnDist.REFRESH()
  lnSavRecNo = RECNO()
  =lfvDistrib(loFormSet)
  IF BETWEEN(lnSavRecNo,0,RECCOUNT())
    GO lnSavRecNo
  ENDIF
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  SELECT(loFormSet.lcTmpDist)
  IF !EMPTY(lcFilt)
    SET FILTER TO &lcFilt
  ENDIF
  lfDistRefresh(loFormSet)
  RETURN
  *--end of lfvDistAmnt


  *!*************************************************************
  *! Name      : lfvUpdTemp
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 8/8/2004
  *! Purpose   : To Add a record to the TempDist Table
  *!*************************************************************
  *! Parameters: The FormSet, Control Name, Control's Old Value
  *!*************************************************************
  *! Returns   : None
  *!**************************************************************
FUNCTION lfvUpdTemp
  LPARAMETERS loFormSet, lcWhich, lOldVal


  SCATTER MEMVAR MEMO

  m.cStatus  = 'A'
  m.cApdStat = 'V'
  lcWhich = 'm.'+lcWhich
  &lcWhich = lOldVal

  APPEND BLANK
  GATHER MEMVAR MEMO

  m.nApdAmnt  = -1 * m.nApdAmnt
  m.nEqvAmnt  = -1 * m.nEqvAmnt
  m.lAPDPost  = .F.
  m.cBatchNo  = ' '
  m.cTrnSledn = ' '
  m.cAPSessNo = loFormSet.lcSequence

  m.nEntryNo = 0

  APPEND BLANK
  GATHER MEMVAR MEMO

  RETURN
  *--end of lfvUpdTemp



  *!*************************************************************
  *! Name      : lfvNewLine
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 8/8/2004
  *! Purpose   : Function called from the Click Event of New Button of the Distribution Lines Screen
  *!*************************************************************
  *! Parameters: The FormSet
  *!*************************************************************
  *! Returns   : None
  *!*************************************************************
FUNCTION lfvNewLine
  LPARAMETERS loFormSet


  IF !EMPTY(APVENDOR.CEXPACCT)
    loFormSet.lcDistAcct = APVENDOR.CEXPACCT
  ELSE
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *  IF SEEK(loFormSet.AriaForm1.cboDivision.Value,'APDIV') .AND. !EMPTY(APDIV.CEXPACCT)
    IF gfSEEK(loFormSet.AriaForm1.pgfpayInv.pgHead.cboDivision.VALUE,'APDIV') .AND. !EMPTY(APDIV.CEXPACCT)
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[END]
      loFormSet.lcDistAcct = APDIV.CEXPACCT
    ELSE
      loFormSet.lcDistAcct = APSETUP.CEXPACCT
    ENDIF
  ENDIF


  SELECT(loFormSet.lcTmpDist)


  ** Add the distribution account. **
  APPEND BLANK
  IF TYPE('APINVHDR.DPOSTDATE') = 'D'
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *!*	  REPLACE CVENDCODE WITH loFormSet.AriaForm1.KBVendCode.KeyTextBox.Value  ,;
    *!*	          CINVNO    WITH loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value  ,;
    *!*	          DAPDTRDAT WITH loFormSet.AriaForm1.DtPostDate.Value ,;
    *!*	          LAPDPOST  WITH .F.        ,;
    *!*	          CAPDGLACT WITH loFormSet.lcDistAcct ,;
    *!*	          NAPDAMNT  WITH loFormSet.AriaForm1.txtInvAmount.Value - loFormSet.lnDistAmnt,;
    *!*	          CAPDACTID WITH 'D'        ,;
    *!*	          CFISFYEAR WITH loFormSet.lcDistYer  ,;
    *!*	          CFSPPRDID WITH loFormSet.lcDistPrd  ,;
    *!*	          CAPSESSNO WITH loFormSet.lcSequence,;
    *!*	          CAPDTRTYP WITH 'I'        ,;
    *!*	          CSTATUS   WITH 'A'        ,;
    *!*	          NAPDLINNO WITH lfvLineNo(loFormSet),;
    *!*	          CAPDREF   WITH loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value
    REPLACE CVENDCODE WITH loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE  ,;
      CINVNO    WITH loFormSet.AriaForm1.kbInvNo.KeyTextBox.VALUE  ,;
      DAPDTRDAT WITH loFormSet.AriaForm1.DtPostDate.VALUE ,;
      LAPDPOST  WITH .F.        ,;
      CAPDGLACT WITH loFormSet.lcDistAcct ,;
      NAPDAMNT  WITH loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.VALUE - loFormSet.lnDistAmnt,;
      CAPDACTID WITH 'D'        ,;
      CFISFYEAR WITH loFormSet.lcDistYer  ,;
      CFSPPRDID WITH loFormSet.lcDistPrd  ,;
      CAPSESSNO WITH loFormSet.lcSequence,;
      CAPDTRTYP WITH 'I'        ,;
      CSTATUS   WITH 'A'        ,;
      NAPDLINNO WITH lfvLineNo(loFormSet),;
      CAPDREF   WITH loFormSet.AriaForm1.kbInvNo.KeyTextBox.VALUE
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  ELSE
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *!*	  REPLACE CVENDCODE WITH loFormSet.AriaForm1.KBVendCode.KeyTextBox.Value  ,;
    *!*	          CINVNO    WITH loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value  ,;
    *!*	          DAPDTRDAT WITH loFormSet.AriaForm1.DtInvDate.Value ,;
    *!*	          LAPDPOST  WITH .F.        ,;
    *!*	          CAPDGLACT WITH loFormSet.lcDistAcct ,;
    *!*	          NAPDAMNT  WITH loFormSet.AriaForm1.txtInvAmount.Value - loFormSet.lnDistAmnt,;
    *!*	          CAPDACTID WITH 'D'        ,;
    *!*	          CFISFYEAR WITH apinvhdr.cfisfyear ,;
    *!*	          CFSPPRDID WITH apinvhdr.cfspprdid ,;
    *!*	          CAPSESSNO WITH loFormSet.lcSequence,;
    *!*	          CAPDTRTYP WITH 'I'        ,;
    *!*	          CSTATUS   WITH 'A'        ,;
    *!*	          NAPDLINNO WITH lfvLineNo(loFormSet),;
    *!*	          CAPDREF   WITH loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value
    REPLACE CVENDCODE WITH loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE  ,;
      CINVNO    WITH loFormSet.AriaForm1.kbInvNo.KeyTextBox.VALUE  ,;
      DAPDTRDAT WITH loFormSet.AriaForm1.pgfpayInv.pgHead.DtInvDate.VALUE ,;
      LAPDPOST  WITH .F.        ,;
      CAPDGLACT WITH loFormSet.lcDistAcct ,;
      NAPDAMNT  WITH loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.VALUE - loFormSet.lnDistAmnt,;
      CAPDACTID WITH 'D'        ,;
      CFISFYEAR WITH apinvhdr.cfisfyear ,;
      CFSPPRDID WITH apinvhdr.cfspprdid ,;
      CAPSESSNO WITH loFormSet.lcSequence,;
      CAPDTRTYP WITH 'I'        ,;
      CSTATUS   WITH 'A'        ,;
      NAPDLINNO WITH lfvLineNo(loFormSet),;
      CAPDREF   WITH loFormSet.AriaForm1.kbInvNo.KeyTextBox.VALUE
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  ENDIF
  *C100728,1 M.H End.
  =gfAdd_Info(loFormSet.lcTmpDist)

  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *loFormSet.DistLines.grdDist.Refresh()
  loFormSet.AriaForm1.pgfpayInv.pgDist.grdDist.REFRESH()
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

  IF APVENDOR.CTAXTYPE = 'T'
    *Old: _CUROBJ = OBJNUM(loFormSet.lcApdGLAct)
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *  loFormSet.DistLines.glActCode.KeyTextbox.SetFocus()
    loFormSet.AriaForm1.pgfpayInv.pgDist.glActCode.KeyTextbox.SETFOCUS()
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  ELSE
    *Old: _CUROBJ = OBJNUM(ibTaxCode)
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *loFormSet.DistLines.cboTaxCode.SetFocus()
    loFormSet.AriaForm1.pgfpayInv.pgDist.cboTaxCode.SETFOCUS()
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  ENDIF
  loFormSet.lnDistAmnt = loFormSet.lnDistAmnt + NAPDAMNT

  loFormSet.lcTmplate = 'DISABLE'
  *Old: SHOW GET loFormSet.AriaForm1.kbAutmCode.KeyTextBox.Value DISABLE  &&lower &&Revise
  *Old: SHOW GET ibTemplate DISABLE &&Revise
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *loFormSet.AriaForm1.kbAutmCode.Enabled = .F.
  loFormSet.AriaForm1.pgfpayInv.pgHead.kbAutmCode.ENABLED = .F.
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

  *SHOW WINDOW ALL REFRESH SAME
  *Old: SHOW WINDOW (loFormSet.lcBrowsTtl) REFRESH
  *Old: SHOW WINDOW (loFormSet.lcBrowsTtl) TOP IN WINDOW CWRAPDISTR

  =lfDispObjct(loFormSet)
  *!B500684,1 MAN 06/01/95
  *Old: =lfvTrapKey()
  lfDistRefresh(loFormSet)
  *Old: =lfRefresh()

  RETURN
  *--end of lfvNewLine


  *!*************************************************************
  *! Name      : lfvRemLine
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 8/8/2004
  *! Purpose   : Function called from the Click Event of Remove Button of the Distribution Lines Screen
  *!*************************************************************
  *! Parameters: The FormSet
  *!*************************************************************
  *! Returns   : None
  *!*************************************************************
FUNCTION lfvRemLine
  LPARAMETERS loFormSet
  LOCAL lcFilt

  SELECT(loFormSet.lcTmpDist)

  IF gfModalGen("QRM00007B00007","ALERT") = 1

    SELECT(loFormSet.lcTmpDist)
    lcFilt = FILTER()
    SET FILTER TO
    lnSavRecNo = 0
    loFormSet.lnDistAmnt = loFormSet.lnDistAmnt - nApdAmnt

    DO CASE
      CASE cStatus = 'A'
        REPLACE CSTATUS WITH 'S'
        DELETE
        IF loFormSet.lnLineNo > 0 .AND. !EOF()
          SKIP
          lnSavRecNo = RECNO()
          REPLACE REST NAPDLINNO WITH NAPDLINNO - 1,;
            CUPDSERNO WITH IIF(loFormSet.ActiveMode="E" .AND. CSTATUS $ 'MS','M',' ')
        ENDIF

      CASE cStatus = 'S'
        REPLACE CAPDSTAT WITH 'V',;
          CSTATUS  WITH 'M'

        SCATTER MEMVAR MEMO
        m.lApdPost = .F.
        m.cBatchNo = ' '
        m.cTrnSledn= ' '
        m.cApSessNo= loFormSet.lcSequence
        m.nAPDAmnt = 0 - m.nAPDAmnt
        m.cApdStat = 'V'
        m.cStatus  = 'A'
        m.nEqvAmnt = 0 - m.nEqvAmnt

        m.nEntryNo = 0

        DELETE

        IF loFormSet.lnLineNo > 0 .AND. !EOF()
          SKIP
          lnSavRecNo = RECNO()
          REPLACE REST NAPDLINNO WITH NAPDLINNO - 1,;
            CUPDSERNO WITH IIF(loFormSet.ActiveMode="E" .AND. CSTATUS $ 'MS','M',' ')
        ENDIF
        APPEND BLANK
        GATHER MEMVAR MEMO

      CASE cStatus = 'M'
        REPLACE CSTATUS WITH 'D'
        DELETE
        IF loFormSet.lnLineNo > 0 .AND. !EOF()
          SKIP
          lnSavRecNo = RECNO()
          REPLACE REST NAPDLINNO WITH NAPDLINNO - 1,;
            CUPDSERNO WITH IIF(loFormSet.ActiveMode="E" .AND. CSTATUS $ 'MS','M',' ')
        ENDIF
    ENDCASE

    loFormSet.lnLineNo   = loFormSet.lnLineNo - 1

    IF lnSavRecNo <> 0 .AND. lnSavRecNo <= RECCOUNT()
      GO lnSavRecNo
    ELSE
      IF !BOF()
        SKIP -1
      ENDIF
    ENDIF

    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *!*	  loFormSet.DistLines.Deactivate
    *!*	  loFormSet.DistLines.Activate
    loFormSet.AriaForm1.pgfpayInv.pgDist.DEACTIVATE
    loFormSet.AriaForm1.pgfpayInv.pgDist.ACTIVATE
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

  ENDIF

  *Enable the template field only if the" Vendor Invoice Types" is empty
  IF loFormSet.lnLineNo = 0 .AND. EMPTY(loFormSet.lcVenInvTypes)

    loFormSet.lcTmplate = 'ENABLE'
    *Old: SHOW GET loFormSet.AriaForm1.kbAutmCode.KeyTextBox.Value ENABLE  &&lower &&Revise
    *Old: SHOW GET ibTemplate ENABLE &&Revise
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *loFormSet.AriaForm1.kbAutmCode.Enabled = .T.
    loFormSet.AriaForm1.pgfpayInv.pgHead.kbAutmCode.ENABLED = .T.
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[ENd]
  ELSE
    loFormSet.lcTmplate = 'DISABLE'
    *Old: SHOW GET loFormSet.AriaForm1.kbAutmCode.KeyTextBox.Value DISABLE  &&lower &&Revise
    *Old: SHOW GET ibTemplate DISABLE &&Revise
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *loFormSet.AriaForm1.kbAutmCode.Enabled = .F.
    loFormSet.AriaForm1.pgfpayInv.pgHead.kbAutmCode.ENABLED = .F.
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[ENd]
  ENDIF

  *SHOW WINDOW ALL REFRESH SAME
  *Old: SHOW WINDOW (loFormSet.lcBrowsTtl) REFRESH
  *Old: SHOW WINDOW (loFormSet.lcBrowsTtl) TOP IN WINDOW CWRAPDISTR

  =lfDispObjct(loFormSet)

  *Old: =lfvTrapKey()
  lfDistRefresh(loFormSet)

  *Old: =lfRefresh()

  IF loFormSet.lnLineNo = 0 .AND. apinvhdr.cautmtype = 'R'
    REPLACE apinvhdr.cautmtype WITH ' ' IN apinvhdr
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *loFormSet.AriaForm1.kbAutmCode.KeyTextBox.Value = '        '
    loFormSet.AriaForm1.pgfpayInv.pgHead.kbAutmCode.KeyTextBox.VALUE = '        '
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    *Old: SHOW GET loFormSet.AriaForm1.kbAutmCode.KeyTextBox.Value
    *Old: loFormSet.lcLabel = 'Template :'
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *loFormSet.AriaForm1.lblAutmType.Caption = 'Template'
    loFormSet.AriaForm1.pgfpayInv.pgHead.lblAutmType.CAPTION = 'Template'
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    *Old: =lfRefresh(gcBaseWind)
  ENDIF

  IF !EOF(loFormSet.lcTmpDist)
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *loFormSet.DistLines.grdDist.SetFocus()
    loFormSet.AriaForm1.pgfpayInv.pgDist.grdDist.SETFOCUS()
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[ENd]
    lfDistRefresh(loFormSet)
  ELSE
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *loFormSet.DistLines.cmdNew.SetFocus()
    loFormSet.AriaForm1.pgfpayInv.pgDist.cmdNew.SETFOCUS()
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  ENDIF

  RETURN
  *--end of lfvRemLine


  *!*************************************************************
  *! Name      : lfvClsChld
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 8/8/2004
  *! Purpose   : Function called from the Click Event of Close Button of the Distribution Lines Screen
  *!*************************************************************
  *! Parameters: The FormSet
  *!*************************************************************
  *! Returns   : None
  *!*************************************************************
FUNCTION lfvClsChld
  LPARAMETERS loFormSet

  IF INLIST(loFormSet.ActiveMode,"A","E")
    IF loFormSet.lnLineNo = 0 .AND. EMPTY(loFormSet.lcVenInvTypes)
      loFormSet.lcTmplate = 'ENABLE'
    ELSE
      loFormSet.lcTmplate = 'DISABLE'
    ENDIF
    *Old: SHOW GET loFormSet.AriaForm1.kbAutmCode.KeyTextBox.Value &loFormSet.lcTmplate  &&lower &&Revise
    *Old: SHOW GET ibTemplate &loFormSet.lcTmplate &&Revise
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *  loFormSet.AriaForm1.kbAutmCode.Enabled = (loFormSet.lcTmplate = 'ENABLE')
    loFormSet.AriaForm1.pgfpayInv.pgHead.kbAutmCode.ENABLED = (loFormSet.lcTmplate = 'ENABLE')
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  ENDIF

  IF INLIST(loFormSet.ActiveMode,"A","E")
    *Old: _CUROBJ = OBJNUM(pbSav)&&Old CurObj
  ELSE
    *Old: _CUROBJ = OBJNUM(pbCls)&&Old CurObj
  ENDIF

  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *RELEASE PAD _BROWSE OF (loFormSet.cHostFormName)
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

  *Old: =gfChClose('CWRAPDISTR')
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *loFormSet.DistLines.Visible = .F.
  *loFormSet.AriaForm1.pgfpayInv.pgDist.Visible = .F.
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

  RETURN
  *--end of lfvClsChld


  *!*************************************************************
  *! Name      : lfDistRefresh
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 8/15/2004
  *! Purpose   : Function called from the Refresh Event of the Distribution Lines Screen
  *!*************************************************************
  *! Parameters: The FormSet
  *!*************************************************************
  *! Returns   : None
  *!*************************************************************
FUNCTION lfDistRefresh
  LPARAMETERS loFormSet

  IF !loFormSet.ActiveMode="V" .AND. !loFormSet.llLokPer .AND. EMPTY(loFormSet.lcVenInvTypes)

    IF loFormSet.lnDistAmnt = apinvhdr.ninvamnt
      *Old: SHOW GET pbNew ENABLE   && New 10/02/1994 &&Revise
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *loFormSet.DistLines.cmdNew.Enabled = .T.
      loFormSet.AriaForm1.pgfpayInv.pgDist.cmdNew.ENABLED = .T.
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      loFormSet.llNewStat = .F.
    ELSE
      *Old: SHOW GET pbNew ENABLE &&Revise

      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *loFormSet.DistLines.cmdNew.Enabled = .T.
      loFormSet.AriaForm1.pgfpayInv.pgDist.cmdNew.ENABLED = .T.
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

      loFormSet.llNewStat = .T.
    ENDIF


    IF loFormSet.lnLineNo <> 0
      *Old: SHOW GET pbRemove ENABLE &&Revise
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *loFormSet.DistLines.cmdRemove.Enabled = .T.
      loFormSet.AriaForm1.pgfpayInv.pgDist.cmdRemove.ENABLED = .T.
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[ENd]
    ELSE
      *Old: SHOW GET pbRemove DISABLE &&Revise
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *loFormSet.DistLines.cmdRemove.Enabled = .F.
      loFormSet.AriaForm1.pgfpayInv.pgDist.cmdRemove.ENABLED = .F.
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    ENDIF
  ELSE
    IF loFormSet.ActiveMode="V" .OR. loFormSet.llLokPer
      *Old: SHOW GET loFormSet.DistLines.glAPActCode.Value DISABLE  &&lower &&Revise
      *Old: SHOW GET ibApAcc    DISABLE &&Revise
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *loFormSet.DistLines.glAPActCode.Enabled = .F.
      loFormSet.AriaForm1.pgfpayInv.pgDist.glAPActCode.ENABLED = .F.
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[END]
    ELSE
      *Old: SHOW GET loFormSet.DistLines.glAPActCode.Value ENABLE  &&lower &&Revise
      *Old: SHOW GET ibApAcc    ENABLE &&Revise
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      * loFormSet.DistLines.glAPActCode.Enabled = .T.
      loFormSet.AriaForm1.pgfpayInv.pgDist.glAPActCode.ENABLED = .T.
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    ENDIF

    loFormSet.llNewStat = .F.
    *Old: SHOW GET pbNew DISABLE &&Revise
    *Old: SHOW GET pbRemove DISABLE &&Revise
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *!*	  loFormSet.DistLines.cmdNew.Enabled = .F.
    *!*	  loFormSet.DistLines.cmdRemove.Enabled = .F.
    loFormSet.AriaForm1.pgfpayInv.pgDist.cmdNew.ENABLED = .F.
    loFormSet.AriaForm1.pgfpayInv.pgDist.cmdRemove.ENABLED = .F.
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  ENDIF
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *WITH loFormSet.DistLines
  WITH loFormSet.AriaForm1.pgfpayInv.pgDist
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    .glAPActCode.keyTextBox.REFRESH()
    .txtInvAmount.REFRESH()
    .txtUnDist.REFRESH()
    .txtLineNo.REFRESH()
    .cbotaxCode.REFRESH()
    .glActCode.keyTextBox.REFRESH()
    .txtlnApdAmnt.REFRESH()
    .grdDist.REFRESH()
    .txtAPActName.VALUE = IIF(loFormSet.AriaForm1.ap1.llApGlLink,ALLTRIM(LOOKUP(lcLinkChar.CACCNLDES,;
    .glAPActCode.KeyTextbox.VALUE,lcLinkChar.CACCTCODE,"ACCTCODE")),' ')
    .txtglActName.VALUE = IIF(loFormSet.AriaForm1.ap1.llApGlLink,ALLTRIM(LOOKUP(lcLinkChar.CACCNLDES,;
    .glActCode.KeyTextbox.VALUE,lcLinkChar.CACCTCODE,"ACCTCODE")),' ')
  ENDWITH

  RETURN
  *--end of lfDistRefresh


  ***ddd***


  ***sss***

  *!*************************************************************
  *! Name      : lfFormBeforeSave
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 8/16/2004
  *! Purpose   : Procedure called from the Before Save Method of the formSet
  *!*************************************************************
  *! Parameters: The FormSet
  *!*************************************************************
  *! Returns   : None
  *!*************************************************************
FUNCTION lfFormBeforeSave
  LPARAMETERS loFormSet
  
  *! E302623,3 MMT 01/03/2010 Convert Payable invoice screen to use SQL tables[Start]
  IF loFormSet.ActiveMode = 'A' 
    IF !USED('APINVHDR_INV')
      =gfOpenTable('APINVHDR','VENDINV','SH','APINVHDR_INV')
    ENDIF 
    IF gfSeek(PADR(loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE,LEN(APINVHDR_INV.CVENDCODE))+PADR(loFormSet.AriaForm1.kbInvNo.KeyTextBox.VALUE,LEN(APINVHDR_INV.cInvNo)),'APINVHDR_INV')
      =gfModalGen("TRM04014B00000","DIALOG",loFormSet.AriaForm1.kbInvNo.KeyTextBox.VALUE)  &&lower
      llCSave = .F.
      RETURN .F.
    ENDIF 
  ENDIF   
  *! E302623,3 MMT 01/03/2010 Convert Payable invoice screen to use SQL tables[End]
  
  
  SELECT (loFormSet.lcTmpDist)
  *Get the Period# and Year for both dates invoice & Posting. If the Invoice date
  *prior than postinf date give a warning message to the user. [Begin]
  PRIVATE lcPstPrd,lcPstYer,lcInvPrd,lcInvYer
  STORE '' TO lcPstPrd,lcPstYer,lcInvPrd,lcInvYer
  =lfVlDate(oAriaApplication.PrntCompanyID , @lcPstPrd , @lcPstYer , loFormSet.AriaForm1.DtPostDate.VALUE)
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *=lfVlDate(oAriaApplication.PrntCompanyID , @lcInvPrd , @lcInvYer , loFormSet.AriaForm1.DtInvDate.Value)
  =lfVlDate(oAriaApplication.PrntCompanyID , @lcInvPrd , @lcInvYer , loFormSet.AriaForm1.pgfpayInv.pgHead.DtInvDate.VALUE)
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  IF VAL(lcPstYer) < VAL(lcInvYer)

    IF gfModalGen("TRM04197B04012","DIALOG","invoices|"+loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE) = 1
      *Add validation that invoice date could not be after the invoice posted date [end]
      llCSave = .F.
      *-- Return to posting date
      *Old: _CUROBJ = OBJNUM(loFormSet.AriaForm1.DtPostDate.Value)
      loFormSet.AriaForm1.DtPostDate.SETFOCUS()
      SELECT APINVHDR
      RETURN .F.
    ENDIF

  ELSE
    IF VAL(lcPstYer) = VAL(lcInvYer)
      IF VAL(lcPstPrd) < VAL(lcInvPrd)

        IF gfModalGen("TRM04197B04012","DIALOG","invoices|"+loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE) = 1
          *Add validation that invoice date could not be after the invoice posted date [end]
          llCSave = .F.
          *-- Return to posting date
          *Old: _CUROBJ = OBJNUM(loFormSet.AriaForm1.DtPostDate.Value)
          loFormSet.AriaForm1.DtPostDate.SETFOCUS()
          SELECT APINVHDR
          RETURN .F.
        ENDIF

      ENDIF
    ENDIF
  ENDIF
  loFormSet.llCanSav = .F.
  lcSavExact= SET('EXACT')
  SET EXACT ON
  IF !gfGetMemVar('LLMULCURR')  && If not multi currrency.
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value = oAriaApplication.BaseCurrency
    *loFormSet.AriaForm1.txtNexRate.Value = 1
    loFormSet.AriaForm1.pgfpayInv.pgHead.kbCurrCode.KeyTextBox.VALUE = oAriaApplication.BaseCurrency
    loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.VALUE = 1
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

    REPLACE apinvhdr.ncurrunit WITH 1 IN apinvhdr
  ENDIF

  *! B128863,1 ASM 08/24/2005 Fix the Bug of Saving Fox Tables even when SQL Gives errors and RollBack [Start]
  IF !lfCheckSql()
    llCSave = .F.
    SELECT APINVHDR
    RETURN .F.
  ENDIF
  *! B128863,1 ASM 08/24/2005 Fix the Bug of Saving Fox Tables even when SQL Gives errors and RollBack [End]

  IF loFormSet.ActiveMode="A" .AND. !SEEK(loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE,'APVENDOR')
    ** MESSAGE : "  not found.         "
    **           "          Ok        "
    **  = 'Vendor name'
    lnOption = gfModalGen("TRM04002B00000","DIALOG",loFormSet.lcTVendCode+loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE)
    llCSave     = .F.
    loFormSet.llSamVendor = .F.
    SET EXACT &lcSavExact
    SELECT APINVHDR
    RETURN .F.
  ENDIF
  *Open files and make necessary relation
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	llopFact = gfOpenFile(oAriaApplication.SysPath+'SYCFACT','CFACCODE','SH')
  *!*	llOpVHst = gfOpenFile(oAriaApplication.DataDir+'APVENHST','VENDYEAR','SH')
  llopFact = gfOpenTable(oAriaApplication.SysPath+'SYCFACT','CFACCODE','SH')
  llOpVHst = gfOpenTable('APVENHST','VENDYEAR','SH')
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  
  =CURSORSETPROP("Buffering",5,'APVENHST')
  SELECT APINVHDR
  SET RELATION OFF INTO APVENHST
  SET RELATION TO APINVHDR.CVENDCODE + APINVHDR.CFISFYEAR INTO APVENHST ADDITIVE

  *Check that total approved amount equal total invoice amount when payment method is credit card.
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	IF loFormSet.AriaForm1.cboVendPmeth.Value = 'C' AND !EMPTY(loFormSet.lcVenInvTypes) AND ;
  *!*	   loFormSet.lnTAprAmt<>0 AND loFormSet.AriaForm1.txtInvAmount.Value <> loFormSet.lnTAprAmt
  IF loFormSet.AriaForm1.pgfpayInv.pgHead.cboVendPmeth.VALUE = 'C' AND !EMPTY(loFormSet.lcVenInvTypes) AND ;
      loFormSet.lnTAprAmt<>0 AND loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.VALUE <> loFormSet.lnTAprAmt
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    
    ** MESSAGE : " Credit card payment does not support adjustments. Therefor,"
    **           " the approved invoice amount has to total the invoice amount."
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *  =gfModalGen("TRM04184B00000","DIALOG",IIF(loFormSet.AriaForm1.txtInvAmount.Value > 0,'invoice|invoice','debit memo|debit memo'))
    =gfModalGen("TRM04184B00000","DIALOG",IIF(loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.VALUE > 0,'invoice|invoice','debit memo|debit memo'))
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    llCSave     = .F.
    loFormSet.llSamVendor = .F.
    SET EXACT &lcSavExact
    SELECT APINVHDR
    RETURN .F.
  ENDIF
  
  
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *IF loFormSet.ActiveMode="A" .AND. !EMPTY(APVENDOR.CFACCODE) .AND. loFormSet.AriaForm1.cboInvRemit.Value <> 'F'
  IF loFormSet.ActiveMode="A" .AND. !EMPTY(APVENDOR.CFACCODE) .AND. loFormSet.AriaForm1.pgfpayInv.pgHead.cboInvRemit.VALUE <> 'F'
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    ** MESSAGE : " Vendor  is factored, this invoice has not been  "
    **           " remited to the factor.                           "
    **           " <Remit to factor> <Stop saving> <Continue saving>"
    **  = 'Vendor name'
    lnOption = gfModalGen("TRM04065B04003","DIALOG",loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE)

    DO CASE
      CASE lnOption = 1
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        *loFormSet.AriaForm1.cboInvRemit.Value  = 'F'
        *loFormSet.AriaForm1.kbFacCode.KeyTextBox.Value = APVENDOR.cFacCode
        *IF SEEK(loFormSet.AriaForm1.kbFacCode.KeyTextBox.Value,'SYCFACT')
        *!*	        loFormSet.AriaForm1.txtOutComp.Value  = SYCFACT.cFacComp
        *!*	        loFormSet.AriaForm1.txtOutAddr1.Value  = SYCFACT.cAddress1
        *!*	        loFormSet.AriaForm1.txtOutAddr2.Value  = SYCFACT.cAddress2
        *!*	        loFormSet.AriaForm1.txtOutAddr3.Value  = lfGetAdr('SYCFACT','CFACCODE')

        loFormSet.AriaForm1.pgfpayInv.pgHead.cboInvRemit.VALUE  = 'F'
        loFormSet.AriaForm1.pgfpayInv.pgHead.kbFacCode.KeyTextBox.VALUE = APVENDOR.cFacCode
        IF SEEK(loFormSet.AriaForm1.pgfpayInv.pgHead.kbFacCode.KeyTextBox.VALUE,'SYCFACT')
          loFormSet.AriaForm1.pgfpayInv.pgHead.txtOutComp.VALUE  = SYCFACT.cFacComp
          loFormSet.AriaForm1.pgfpayInv.pgHead.txtOutAddr1.VALUE  = SYCFACT.cAddress1
          loFormSet.AriaForm1.pgfpayInv.pgHead.txtOutAddr2.VALUE  = SYCFACT.cAddress2
          loFormSet.AriaForm1.pgfpayInv.pgHead.txtOutAddr3.VALUE  = lfGetAdr('SYCFACT','CFACCODE')
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
          REPLACE apinvhdr.coutaddr1 WITH gfGetAdr('SYCFACT','CFACCODE',.F.,.F.,1) IN apinvhdr
          REPLACE apinvhdr.coutaddr2 WITH gfGetAdr('SYCFACT','CFACCODE',.F.,.F.,2) IN apinvhdr
          REPLACE apinvhdr.coutaddr3 WITH gfGetAdr('SYCFACT','CFACCODE',.F.,.F.,3) IN apinvhdr
          REPLACE apinvhdr.coutaddr4 WITH gfGetAdr('SYCFACT','CFACCODE',.F.,.F.,4) IN apinvhdr
          REPLACE apinvhdr.coutaddr5 WITH gfGetAdr('SYCFACT','CFACCODE',.F.,.F.,5) IN apinvhdr

        ELSE
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
          *!*	        STORE SPACE(40) TO loFormSet.AriaForm1.txtOutComp.Value, ;
          *!*	          loFormSet.AriaForm1.txtOutAddr1.Value, loFormSet.AriaForm1.txtOutAddr2.Value, ;
          *!*	          loFormSet.AriaForm1.txtOutAddr3.Value
          STORE SPACE(40) TO loFormSet.AriaForm1.pgfpayInv.pgHead.txtOutComp.VALUE, ;
            loFormSet.AriaForm1.pgfpayInv.pgHead.txtOutAddr1.VALUE, loFormSet.AriaForm1.pgfpayInv.pgHead.txtOutAddr2.VALUE, ;
            loFormSet.AriaForm1.pgfpayInv.pgHead.txtOutAddr3.VALUE
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
          REPLACE apinvhdr.coutaddr4 WITH SPACE(40)
          REPLACE apinvhdr.coutaddr5 WITH SPACE(40)
        ENDIF
      CASE lnOption = 2
        loFormSet.llCanSav = .T.
    ENDCASE
  ENDIF
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  SELECT apinvhdr
  =gfReplace("")
  =gfReplace('minvnote with apinvhdr.minvnote')
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]



  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *IF loFormSet.AriaForm1.cboInvRemit.Value = 'F' .AND. EMPTY(loFormSet.AriaForm1.kbFacCode.KeyTextBox.Value)
  IF loFormSet.AriaForm1.pgfpayInv.pgHead.cboInvRemit.VALUE = 'F' .AND. EMPTY(loFormSet.AriaForm1.pgfpayInv.pgHead.kbFacCode.KeyTextBox.VALUE)
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    ** MESSAGE : " You have to enter the ."
    **           "          Ok           "
    **  = 'factor code'
    =gfModalGen("TRM04066B00000","DIALOG",loFormSet.lcTFactor)
    *Old: _CUROBJ = OBJNUM(loFormSet.AriaForm1.kbFacCode.KeyTextBox.Value)
    *Old: SHOW GET loFormSet.AriaForm1.kbFacCode.KeyTextBox.Value  &&lower &&Revise
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *  loFormSet.AriaForm1.kbFacCode.KeyTextBox.SetFocus()
    loFormSet.AriaForm1.pgfpayInv.pgHead.kbFacCode.KeyTextBox.SETFOCUS()
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    loFormSet.llCanSav = .T.
  ENDIF

  IF EMPTY(apinvhdr.cfspprdid) .OR. EMPTY(apinvhdr.cfisfyear)
    lcFisPrd = loFormSet.lcFisPrd
    lcFisYer = loFormSet.lcFisYer
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *IF lfVDtMsg(oAriaApplication.PrntCompanyID,@lcFisPrd,@lcFisYer,loFormSet.AriaForm1.DtInvDate.Value)
    IF lfVDtMsg(oAriaApplication.PrntCompanyID,@lcFisPrd,@lcFisYer,loFormSet.AriaForm1.pgfpayInv.pgHead.DtInvDate.VALUE)
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      loFormSet.lcFisPrd = lcFisPrd
      loFormSet.lcFisYer = lcFisYer
      REPLACE apinvhdr.cfspprdid WITH loFormSet.lcFisPrd IN apinvhdr
      REPLACE apinvhdr.cfisfyear WITH loFormSet.lcFisYer IN apinvhdr
    ELSE
      *Old: _CUROBJ = OBJNUM(loFormSet.AriaForm1.DtInvDate.Value)  &&lower&&Old CurObj
      *Old: SHOW GET loFormSet.AriaForm1.DtInvDate.Value  &&lower &&Revise
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *loFormSet.AriaForm1.DtInvDate.SetFocus()
      loFormSet.AriaForm1.pgfpayInv.pgHead.DtInvDate.SETFOCUS()
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[ENd]
      loFormSet.llCanSav = .T.
    ENDIF
  ENDIF
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *IF loFormSet.AriaForm1.txtInvAmount.Value = 0
  IF loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.VALUE = 0
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    ** MESSAGE : " You have to enter the ."
    **           "          Ok           "
    **  = 'invoice amount'
    =gfModalGen("TRM04066B00000","DIALOG",loFormSet.lcTInvAmont)
    *Old: _CUROBJ = OBJNUM(loFormSet.AriaForm1.txtInvAmount.Value)  &&lower&&Old CurObj
    *Old: SHOW GET loFormSet.AriaForm1.txtInvAmount.Value  &&lower &&Revise
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *  loFormSet.AriaForm1.txtInvAmount.SetFocus()
    loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.SETFOCUS()
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[END]
    loFormSet.llCanSav = .T.
  ENDIF

  *Prevent the user from saving if the company is using multi-currency
  *and the currency field is empty [Begin]
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *IF gfGetMemVar('LLMULCURR') .AND. EMPTY(loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value)
  IF gfGetMemVar('LLMULCURR') .AND. EMPTY(loFormSet.AriaForm1.pgfpayInv.pgHead.kbCurrCode.KeyTextBox.VALUE)
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[ENd]
    ** MESSAGE : " You have to enter the ."
    **           "          Ok           "
    **  = 'invoice currency'
    =gfModalGen("TRM04066B00000" , "DIALOG" , "invoice currency")

    *Old: _CUROBJ = OBJNUM(loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value)  &&lower&&Old CurObj
    *Old: SHOW GET loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value  &&lower &&Revise
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *loFormSet.AriaForm1.kbCurrCode.KeyTextBox.SetFocus()
    loFormSet.AriaForm1.pgfpayInv.pgHead.kbCurrCode.KeyTextBox.SETFOCUS()
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    loFormSet.llCanSav = .T.
  ENDIF

  IF loFormSet.llCanSav
    llCSave = .F.
    SET EXACT &lcSavExact
    SELECT APINVHDR
    RETURN .F.
  ENDIF
  
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *IF loFormSet.lnDistAmnt <> loFormSet.AriaForm1.txtInvAmount.Value
  IF loFormSet.lnDistAmnt <> loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.VALUE
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    ** MESSAGE : " The distribution amount does not "
    **           " total the invoice amount.        "
    **           "                Ok              "
    =gfModalGen("TRM04031B00000","DIALOG")
    llCSave = .F.
    SET EXACT &lcSavExact
    SELECT APINVHDR
    RETURN .F.
  ENDIF
  *Check that total approved to pay amount is not greater than the open approved invoice amount
  STORE 0 TO lnOTInvAmt,lnOTAprAmt
  SET EXACT OFF
  IF loFormSet.ActiveMode="E" AND !EMPTY(loFormSet.lcVenInvTypes)
    SELECT 'APVINVDT'
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *!*	  SET ORDER TO TAG Orgvinv
    *!*	  =SEEK(PADR(loFormSet.AriaForm1.KBVendCode.KeyTextBox.Value,8)+PADR(loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value,12))
    gfSETORDER('Orgvinv')
    =gfSEEK(PADR(loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE,8)+PADR(loFormSet.AriaForm1.kbInvNo.KeyTextBox.VALUE,12))
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    
    SUM REST IIF(CIMTYP $ 'RF',-ROUND(nAPAMnt,2),ROUND(nAPAMnt,2)),;
      IIF(CIMTYP $ 'RF',-ROUND(nApAprAmnt,2),ROUND(nApAprAmnt,2));
      TO lnOTInvAmt,lnOTAprAmt ;
      WHILE cVendCode+cApInvNo+cAPVILNo = PADR(loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE,8)+PADR(loFormSet.AriaForm1.kbInvNo.KeyTextBox.VALUE,12)
  ENDIF
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	DO WHILE !EMPTY(loFormSet.lcVenInvTypes) AND loFormSet.llUpdInvLn AND ;
  *!*	         IIF(loFormSet.AriaForm1.txtInvAmount.Value > 0,!BETWEEN(apinvhdr.ninvdisap+apinvhdr.ninvamtap+apinvhdr.ninvadjap,0,;
  *!*	         loFormSet.AriaForm1.txtInvAmount.Value-apinvhdr.ninvpaid-apinvhdr.ninvdistk-apinvhdr.ninvadj+;
  *!*	         (lnOTInvAmt-lnOTAprAmt)-(loFormSet.lnTInvAmt-loFormSet.lnTAprAmt)),;
  *!*	         !BETWEEN(apinvhdr.ninvdisap+apinvhdr.ninvamtap+apinvhdr.ninvadjap,;
  *!*	         loFormSet.AriaForm1.txtInvAmount.Value-apinvhdr.ninvpaid-apinvhdr.ninvdistk-apinvhdr.ninvadj+;
  *!*	         (lnOTInvAmt-lnOTAprAmt)-(loFormSet.lnTInvAmt-loFormSet.lnTAprAmt),0))
  DO WHILE !EMPTY(loFormSet.lcVenInvTypes) AND loFormSet.llUpdInvLn AND ;
      IIF(loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.VALUE > 0,!BETWEEN(apinvhdr.ninvdisap+apinvhdr.ninvamtap+apinvhdr.ninvadjap,0,;
      loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.VALUE-apinvhdr.ninvpaid-apinvhdr.ninvdistk-apinvhdr.ninvadj+;
      (lnOTInvAmt-lnOTAprAmt)-(loFormSet.lnTInvAmt-loFormSet.lnTAprAmt)),;
      !BETWEEN(apinvhdr.ninvdisap+apinvhdr.ninvamtap+apinvhdr.ninvadjap,;
      loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.VALUE-apinvhdr.ninvpaid-apinvhdr.ninvdistk-apinvhdr.ninvadj+;
      (lnOTInvAmt-lnOTAprAmt)-(loFormSet.lnTInvAmt-loFormSet.lnTAprAmt),0))
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    ** MESSAGE : " Total approved to pay amount can not be greater than "
    **           " the open approved invoice amount."
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *IF gfModalGen("QRM04183B04011","DIALOG",IIF(loFormSet.AriaForm1.txtInvAmount.Value > 0,'invoice','debit memo'))=2
    IF gfModalGen("QRM04183B04011","DIALOG",IIF(loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.VALUE > 0,'invoice','debit memo'))=2
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      llCSave     = .F.
      loFormSet.llSamVendor = .F.
      SET EXACT &lcSavExact
      SELECT APINVHDR
      RETURN .F.
    ENDIF
    *Q2: Shouldn't he here call the invoice lines screen ?
    =lfvAprovPay(loFormSet)
  ENDDO
  SELECT APINVHDR
  SET EXACT ON
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	IF loFormSet.AriaForm1.cboVendPmeth.Value = 'C'
  IF loFormSet.AriaForm1.pgfpayInv.pgHead.cboVendPmeth.VALUE = 'C'
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[ENd]
    IF EMPTY(apinvhdr.cvenccven)
      ** MESSAGE : " You have to enter the credit "
      **           " card .                      "
      **           "              Ok            "
      **  = 'Vendor'
      =gfModalGen("TRM04044B00000","DIALOG",loFormSet.lcTVendor)
      *Old: _CUROBJ = OBJNUM(apinvhdr.cvenccven)  &&lower&&Old CurObj
      *Old: SHOW GET apinvhdr.cvenccven  &&lower &&Revise
      loFormSet.llCanSav = .T.
      *ASM, Call the Credit Card Screen
      =lfvAprovPay(loFormSet)
    ELSE
      IF EMPTY(apinvhdr.cvenccinv)  &&lower
        ** MESSAGE : " You have to enter the credit "
        **           " card .                      "
        **           "              Ok            "
        **  = 'Invoice number'
        =gfModalGen("TRM04044B00000","DIALOG",loFormSet.lcTInvoice)
        *Old: _CUROBJ = OBJNUM(apinvhdr.cvenccinv)  &&lower&&Old CurObj
        *Old: SHOW GET apinvhdr.cvenccinv  &&lower &&Revise
        loFormSet.llCanSav = .T.
        KEYBOARD '{TAB}'
        *ASM, Call the Credit Card Screen
        =lfvAprovPay(loFormSet)
      ELSE
        IF EMPTY(STRTRAN(STRTRAN(loFormSet.lcAccount,'-'),'0'))
          ** MESSAGE : " You have to enter the credit "
          **           " card .                      "
          **           "              Ok            "
          **  = 'A/P account'
          =gfModalGen("TRM04044B00000","DIALOG",loFormSet.lcTApAcct)
          *Old: _CUROBJ = OBJNUM(loFormSet.lcAccount)&&Old CurObj
          *Old: SHOW GET loFormSet.lcAccount &&Revise
          loFormSet.llCanSav = .T.
          KEYBOARD '{TAB}'+'{TAB}'
          *ASM, Call the Credit Card Screen
          =lfvAprovPay(loFormSet)
        ELSE
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
          *IF loFormSet.AriaForm1.txtInvDisof.Value > 0   && The discount offered
          IF loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvDisof.VALUE > 0   && The discount offered
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
            ** We are going to branch to a dialog screen to enter the
            ** discount account.
            loFormSet.lcDisAcct = APDIV.CDISCACCT
            IF EMPTY(loFormSet.lcDisAcct)
              loFormSet.lcDisAcct = APSETUP.CDISCACCT
            ENDIF
            lcOldGlAcc = loFormSet.lcDisAcct
            * DO APDISACT.SPR
            *DO (oAriaApplication.ScreenHome + oAriaApplication.ActiveModuleID + '\APDISACT.SPR')
            DO FORM (oAriaApplication.ScreenHome+"\AP\APDISACT.SCX") WITH loFormSet.AriaForm1
          ENDIF
        ENDIF
      ENDIF
    ENDIF
    IF loFormSet.llCanSav
      ** MESSAGE : "  process is canceled "
      **           "             Ok             "
      =gfModalGen("TRM00103B00000","DIALOG",loFormSet.lcTSave)
      llCSave = .F.
      SET EXACT &lcSavExact
      loFormSet.lcDisAcct = loFormSet.AriaForm1.ap1.lcemptyacc
      SELECT APINVHDR
      RETURN .F.
    ENDIF

    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *  REPLACE apinvhdr.ninvdistk WITH loFormSet.AriaForm1.txtInvDisof.Value IN apinvhdr
    REPLACE apinvhdr.ninvdistk WITH loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvDisof.VALUE IN apinvhdr
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    ** This variable will be in the distribution screen.
    loFormSet.llInvByCr  = .T.
  ENDIF

  *ASM, Enable Buffering for loFormSet.lcTmpDist in order to revert if cancelling the Save
  =CURSORSETPROP("Buffering",5,loFormSet.lcTmpDist)

  IF loFormSet.ActiveMode="E"
    loFormSet.lcExSin2 = ' '
    lcExSin2 = loFormSet.lcExSin2
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *loFormSet.lcExSin1 = gfGetExSin(@lcExSin2,loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value)
    loFormSet.lcExSin1 = gfGetExSin(@lcExSin2,loFormSet.AriaForm1.pgfpayInv.pgHead.kbCurrCode.KeyTextBox.VALUE)
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    loFormSet.lcExSin2 = lcExSin2
    SELECT (loFormSet.lcTmpDist)
    GO TOP
    REPLACE ALL CSTATUS WITH 'M' FOR CUPDSERNO = 'M'
  ENDIF

  *Create the reverse transaction in the APDIST file if the user change the invoice date.

  SET EXACT &lcSavExact
  SELECT APINVHDR
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	IF loFormSet.ActiveMode="E" .AND. ;
  *!*	  IIF(TYPE('APINVHDR.DPOSTDATE')='D',;
  *!*	      loFormSet.AriaForm1.DtPostDate.Value <> OLDVAL('APINVHDR.DPOSTDATE'),;
  *!*	      loFormSet.AriaForm1.DtInvDate.Value <> OLDVAL('APINVHDR.DINVDATE'))
  IF loFormSet.ActiveMode="E" .AND. ;
      IIF(TYPE('APINVHDR.DPOSTDATE')='D',;
      loFormSet.AriaForm1.DtPostDate.VALUE <> OLDVAL('APINVHDR.DPOSTDATE'),;
      loFormSet.AriaForm1.pgfpayInv.pgHead.DtInvDate.VALUE <> OLDVAL('APINVHDR.DINVDATE'))
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    * Copy APDIST structures into laFileStru array
    SELECT APDIST
    =AFIELDS(laFileStru)
    lnFileStru = ALEN(laFileStru,1)
    DIMENSION laFileStru[lnFileStru+2,18]
    laFileStru[lnFileStru+1,1] = 'CSTATUS'
    laFileStru[lnFileStru+1,2] = 'C'
    laFileStru[lnFileStru+1,3] = 1
    laFileStru[lnFileStru+1,4] = 0
    laFileStru[lnFileStru+2,1] = 'NRECNO'
    laFileStru[lnFileStru+2,2] = 'N'
    laFileStru[lnFileStru+2,3] = 10
    laFileStru[lnFileStru+2,4] = 0

    FOR lnLoop = 1  TO 2
      STORE '' TO laFileStru[lnFileStru+lnLoop ,7],laFileStru[lnFileStru+lnLoop  ,8],;
        laFileStru[lnFileStru+lnLoop ,9],laFileStru[lnFileStru+lnLoop  ,10],;
        laFileStru[lnFileStru+lnLoop ,11],laFileStru[lnFileStru+lnLoop ,12],;
        laFileStru[lnFileStru+lnLoop ,13],laFileStru[lnFileStru+lnLoop ,14],;
        laFileStru[lnFileStru+lnLoop ,15],laFileStru[lnFileStru+lnLoop ,16]

      STORE 0 TO  laFileStru[lnFileStru+lnLoop ,17],laFileStru[lnFileStru+lnLoop ,18]
    NEXT

    lcTmpCurs = gfTempName()
    *CREATE TABLE (oAriaApplication.WorkDir+lcTmpCurs) FROM ARRAY laFileStru
    =gfCrtTmp(lcTmpCurs,@laFileStru)
    SELECT APDIST
    
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    =gfSqlRun("Select * From APDIST Where CINVNO='"+APINVHDR.CINVNO+"' AND CVENDCODE ='"+APINVHDR.CVENDCODE+"' AND CAPDSTAT <> 'V'",'APDIST')
    SELECT APDIST
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    
    SCAN FOR APINVHDR.CINVNO+APINVHDR.CVENDCODE = APDIST.CINVNO+APDIST.CVENDCODE .AND. CAPDSTAT <> 'V'
      SCATTER MEMVAR MEMO
      m.cStatus  = 'A'
      m.cApdStat = 'V'
      m.nRecNo   = 0
      SELECT (lcTmpCurs)
      APPEND BLANK
      GATHER MEMVAR MEMO

      m.nApdAmnt = -1 * m.nApdAmnt
      m.nEqvamnt = -1 * m.nEqvamnt
      m.lAPDPost = .F.
      m.cBatchNo = ' '
      m.cTrnSledn= ' '
      m.cAPSessNo= loFormSet.lcSequence

      m.nEntryNo = 0

      APPEND BLANK
      GATHER MEMVAR MEMO

      SELECT APDIST
    ENDSCAN
    USE IN (lcTmpCurs)
    SELECT (loFormSet.lcTmpDist)
    APPEND FROM (oAriaApplication.WorkDir+lcTmpCurs)
    ERASE (oAriaApplication.WorkDir+lcTmpCurs+'.DBF')  && Erase the Temp file.
    SCAN FOR cApdStat <> 'V'
      IF TYPE('APINVHDR.DPOSTDATE') = 'D'
        REPLACE DAPDTRDAT WITH loFormSet.AriaForm1.DtPostDate.VALUE ,;
          CAPSESSNO WITH loFormSet.lcSequence ,;
          CFISFYEAR WITH loFormSet.lcDistYer  ,;
          CFSPPRDID WITH loFormSet.lcDistPrd  ,;
          LAPDPOST  WITH .F.        ,;
          CSTATUS   WITH IIF(CSTATUS $ 'MS','M',CSTATUS)
      ELSE
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        *!*	      REPLACE DAPDTRDAT WITH loFormSet.AriaForm1.DtInvDate.Value ,;
        *!*	              CAPSESSNO WITH loFormSet.lcSequence ,;
        *!*	              CFISFYEAR WITH apinvhdr.cfisfyear ,;
        *!*	              CFSPPRDID WITH apinvhdr.cfspprdid ,;
        *!*	              LAPDPOST  WITH .F.        ,;
        *!*	              CSTATUS   WITH IIF(CSTATUS $ 'MS','M',CSTATUS)
        REPLACE DAPDTRDAT WITH loFormSet.AriaForm1.pgfpayInv.pgHead.DtInvDate.VALUE ,;
          CAPSESSNO WITH loFormSet.lcSequence ,;
          CFISFYEAR WITH apinvhdr.cfisfyear ,;
          CFSPPRDID WITH apinvhdr.cfspprdid ,;
          LAPDPOST  WITH .F.        ,;
          CSTATUS   WITH IIF(CSTATUS $ 'MS','M',CSTATUS)
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      ENDIF

      *Add these line to clear the batch number and transaction
      *number and entry number in the new APDIST records [Begin]
      REPLACE cBatchNo  WITH '' ,;
        cTrnSledn WITH '' ,;
        nEntryNo  WITH 0

      *Add these line to clear the batch number [End]

    ENDSCAN
  ENDIF

  *Check if adding a new invoice and link to GL and there is inactive account then do not save.
  IF loFormSet.ActiveMode="A" AND loFormSet.AriaForm1.ap1.llApGlLink AND !lfvldApAct(loFormSet)
    llCSave = .F.
    SET EXACT &lcSavExact
    =TABLEREVERT(.T.,loFormSet.lcTmpDist)
    =CURSORSETPROP("Buffering",1,loFormSet.lcTmpDist)
    SELECT APINVHDR
    RETURN .F.
  ENDIF
  *Q5: Shouldn't this checking go before updating the lcTmpDist table ?
  IF !EMPTY(loFormSet.lcVenInvTypes) .AND. loFormSet.llUpdInvLn .AND. !lfChckACst(loFormSet)
    llCSave = .F.
    SET EXACT &lcSavExact
    =TABLEREVERT(.T.,loFormSet.lcTmpDist)
    =CURSORSETPROP("Buffering",1,loFormSet.lcTmpDist)
    SELECT APINVHDR
    RETURN .F.
  ENDIF

  ** Begin of adding the currency to the Distribution lines.
  SELECT (loFormSet.lcTmpDist)
  lnTotal = 0

  SCAN FOR cApdStat <> 'V'


    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *    lcTemp = 'NAPDAMNT'+loFormSet.lcExSin1+'loFormSet.AriaForm1.txtNexRate.Value'+;
    loFormSet.lcExSin2+'apinvhdr.ncurrunit'

    *!*	  REPLACE CCURRCODE WITH loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value ,;
    *!*	          NEXRATE   WITH loFormSet.AriaForm1.txtNexRate.Value ,;
    *!*	          NCURRUNIT WITH apinvhdr.ncurrunit ,;
    *!*	          NEQVAMNT  WITH ROUND(&lcTemp,2)
    lcTemp = 'NAPDAMNT'+loFormSet.lcExSin1+'loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.Value'+;
      loFormSet.lcExSin2+'apinvhdr.ncurrunit'

    REPLACE CCURRCODE WITH loFormSet.AriaForm1.pgfpayInv.pgHead.kbCurrCode.KeyTextBox.VALUE ,;
      NEXRATE   WITH loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.VALUE ,;
      NCURRUNIT WITH apinvhdr.ncurrunit ,;
      NEQVAMNT  WITH ROUND(&lcTemp,2)
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    
    *Replacing the date and period of the posting date.
    REPLACE DAPDTRDAT WITH loFormSet.AriaForm1.DtPostDate.VALUE,;
      CFISFYEAR WITH lcPstYer  ,;
      CFSPPRDID WITH lcPstPrd

    IF CAPDACTID <> 'A'
      lnTotal = lnTotal + NEQVAMNT
    ENDIF
  ENDSCAN

  LOCATE FOR cApdStat <> 'V' .AND. CAPDACTID <> 'A' .AND. CSTATUS $ 'AM'

  IF FOUND()
    *Get equivalent amounts
    
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *!*	  lcTemp = 'loFormSet.AriaForm1.txtInvAmount.Value'+loFormSet.lcExSin1+;
    *!*	           'loFormSet.AriaForm1.txtNexRate.Value'+loFormSet.lcExSin2+'apinvhdr.ncurrunit'
    lcTemp = 'loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.Value'+loFormSet.lcExSin1+;
      'loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.Value'+loFormSet.lcExSin2+'apinvhdr.ncurrunit'
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    
    REPLACE NEQVAMNT WITH NEQVAMNT+((ROUND(&lcTemp,2))-lnTotal)
  ENDIF
  ** End of adding the currency to the Distribution lines.


  *ASM, This Part was found right after the IF GFLOCK Statment, but I moved it here instead
  *of the lfFormSaveFiles [Begin]
  IF EMPTY(STRTRAN(STRTRAN(apinvhdr.cchkglacc,'-'),'0'))
    REPLACE apinvhdr.cchkglacc WITH SPACE(24) IN apinvhdr
  ENDIF

  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	IF EMPTY(STRTRAN(STRTRAN(loFormSet.DistLines.glAPActCode.KeyTextBox.Value,'-'),'0'))
  *!*	  loFormSet.DistLines.glAPActCode.KeyTextBox.Value = SPACE(24)
  IF EMPTY(STRTRAN(STRTRAN(loFormSet.AriaForm1.pgfpayInv.pgDist.glAPActCode.KeyTextBox.VALUE,'-'),'0'))
    loFormSet.AriaForm1.pgfpayInv.pgDist.glAPActCode.KeyTextBox.VALUE = SPACE(24)
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  ENDIF
  loFormSet.llSave = lfChckVoid(loFormSet)
  IF !loFormSet.llSave
    *-- If lcTmpDist is not balanced, invoice cannot be saved.
    =gfModalGen('TRM04199B00000','ALERT')
    =gfFLOCK("APINVHDR,APDIST,APVENDOR,APVENHST",.F.)
    *Old: IF WVISIBLE('CWRAPDISTR')
    *Old: =gfChClose('CWRAPDISTR')
    *Old: ENDIF
    *Old: IF USED('APVENHST') .AND. llOpVHst
    *Old: =gfCloseFile('APVENHST')
    *Old: ENDIF
    *Old: IF USED('SYCFACT') .AND. llopFact
    *Old: =gfCloseFile('SYCFACT')
    *Old: ENDIF
    SELECT APINVHDR
    SET EXACT &lcSavExact
    =TABLEREVERT(.T.,loFormSet.lcTmpDist)
    =CURSORSETPROP("Buffering",1,loFormSet.lcTmpDist)
    SELECT APINVHDR
    RETURN .F.
  ENDIF
  *ASM, This Part was found right after the IF GFLOCK Statment [End]


  SET EXACT &lcSavExact
  SELECT APINVHDR

  RETURN .T.
  *-- End of lfFormBeforeSave

  *!*************************************************************
  *! Name      : lfFormSaveFiles
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 8/16/2004
  *! Purpose   : Procedure called from the Save Files Method of the formSet
  *!*************************************************************
  *! Parameters: The FormSet
  *!*************************************************************
  *! Returns   : None
  *!*************************************************************
FUNCTION lfFormSaveFiles
  LPARAMETERS loFormSet
  *ASM, I think here ends the BeforeSave and Starts the SaveFiles Method

  LOCAL loRec, llRevert

  lcSavExact= SET('EXACT')
  SET EXACT ON

  *!*	ACTIVATE WINDOW trace
  *!*	SUSPEND


  IF !lfCheckSql()
    llCSave = .F.
    SELECT APINVHDR
    RETURN .F.
  ENDIF

  ** Locking the 4 files ***
  *! B128863,1 ASM 08/24/2005 Fix the Bug of Saving Fox Tables even when SQL Gives errors and RollBack [Start]
  *IF gfFLOCK("APINVHDR,APDIST,APVENDOR,APVENHST",.T.)
  IF gfFLOCK("APINVHDR,APDIST,APVENDOR,APVENHST",.T.) AND lfCheckSql()
    *! B128863,1 ASM 08/24/2005 Fix the Bug of Saving Fox Tables even when SQL Gives errors and RollBack [End]

    SELECT APINVHDR

    IF loFormSet.ActiveMode="A"
      *Old: APPEND BLANK
    ENDIF

    ** Add the new data to the record.
    *Old: GATHER FROM laData FIELDS &loFormSet.lcScFields MEMO
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *!*	  IF loFormSet.AriaForm1.cboVendPmeth.Value = 'C'
    IF loFormSet.AriaForm1.pgfpayInv.pgHead.cboVendPmeth.VALUE = 'C'
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[END]
      SELECT APINVHDR
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *REPLACE NINVADJ WITH loFormSet.AriaForm1.txtInvAmount.Value - loFormSet.AriaForm1.txtInvDisof.Value
      REPLACE NINVADJ WITH loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.VALUE - loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvDisof.VALUE
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

      *Q8: what does this function do ?
      *! B130111,1 ASM 11/01/2005 Allow the User to Edit an Invoice whose posted date is locked, but make entries on system date [Start]
      IF loFormSet.llLokPer
        lfCheckTmpDist(loFormSet)
      ENDIF
      *! B130111,1 ASM 11/01/2005 Allow the User to Edit an Invoice whose posted date is locked, but make entries on system date [End]
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *=gfTmp2Mast('APDIST',loFormSet.lcTmpDist)
      lfTmp2Mast('APDIST',loFormSet.lcTmpDist)
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[END]
      *Only update the cumulative purchase if you are in ADD mode because
      *if you are in Edit mode this means that you changed the payment method
      *to Credit Card and in this case you did not purchase new thing
      SELECT APVENDOR

      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *    lcTemp = 'loFormSet.lnOldInvAmt'+loFormSet.lcExSin1+'loFormSet.AriaForm1.txtNexRate.Value'+;
      loFormSet.lcExSin2+'apinvhdr.ncurrunit'

      *!*	    REPLACE NVENBAL   WITH NVENBAL -ROUND(&lcTemp,2),;
      *!*	            DVENLPURD WITH loFormSet.AriaForm1.DtInvDate.Value
      *!*	    lcTemp = 'loFormSet.AriaForm1.txtInvAmount.Value'+loFormSet.lcExSin1+;
      *!*	             'loFormSet.AriaForm1.txtNexRate.Value'+loFormSet.lcExSin2+'apinvhdr.ncurrunit'
      *!*	    REPLACE NVENLPURA WITH ROUND(&lcTemp,2),;
      *!*	            DVENLPAYD WITH loFormSet.AriaForm1.DtInvDate.Value
      *!*	    lcTemp = '(loFormSet.AriaForm1.txtInvAmount.Value - loFormSet.AriaForm1.txtInvDisof.Value)'+;
      *!*	             loFormSet.lcExSin1+'loFormSet.AriaForm1.txtNexRate.Value'+loFormSet.lcExSin2+'apinvhdr.ncurrunit'

      lcTemp = 'loFormSet.lnOldInvAmt'+loFormSet.lcExSin1+'loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.Value'+;
        loFormSet.lcExSin2+'apinvhdr.ncurrunit'

      REPLACE NVENBAL   WITH NVENBAL -ROUND(&lcTemp,2),;
        DVENLPURD WITH loFormSet.AriaForm1.pgfpayInv.pgHead.DtInvDate.VALUE
      
      lcTemp = 'loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.Value'+loFormSet.lcExSin1+;
        'loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.Value'+loFormSet.lcExSin2+'apinvhdr.ncurrunit'
      REPLACE NVENLPURA WITH ROUND(&lcTemp,2),;
        DVENLPAYD WITH loFormSet.AriaForm1.pgfpayInv.pgHead.DtInvDate.VALUE
      lcTemp = '(loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.Value - loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvDisof.Value)'+;
        loFormSet.lcExSin1+'loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.Value'+loFormSet.lcExSin2+'apinvhdr.ncurrunit'
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      
      REPLACE NVENLPAYA WITH ROUND(&lcTemp,2)
      
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *!*	    lcTemp = '(loFormSet.AriaForm1.txtInvAmount.Value - loFormSet.AriaForm1.txtInvDisof.Value)'+;
      *!*	             loFormSet.lcExSin1+'loFormSet.AriaForm1.txtNexRate.Value'+loFormSet.lcExSin2+'apinvhdr.ncurrunit'
      lcTemp = '(loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.Value - loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvDisof.Value)'+;
        loFormSet.lcExSin1+'loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.Value'+loFormSet.lcExSin2+'apinvhdr.ncurrunit'
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      
      REPLACE NVENCPAY  WITH NVENCPAY + ROUND(&lcTemp,2)
      
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      *!*	    lcTemp = 'loFormSet.AriaForm1.txtInvAmount.Value'+loFormSet.lcExSin1+;
      *!*	             'loFormSet.AriaForm1.txtNexRate.Value'+loFormSet.lcExSin2+'apinvhdr.ncurrunit'
      lcTemp = 'loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.Value'+loFormSet.lcExSin1+;
        'loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.Value'+loFormSet.lcExSin2+'apinvhdr.ncurrunit'
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      
      REPLACE NVENCPUR  WITH NVENCPUR +IIF(loFormSet.ActiveMode="A",ROUND(&lcTemp,2),0)

      =gfAdd_Info('APVENDOR')

      SELECT APVENHST
      ** Confirm of seek with the content of ladata[1]
      lcNewPayFld  = 'NVNHPAY'+ALLTRIM(STR(INT(VAL(apinvhdr.cfspprdid))))

      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *!*	    lcTemp = 'apinvhdr.ninvdistk'+loFormSet.lcExSin1+'loFormSet.AriaForm1.txtNexRate.Value'+;
      *!*	             +loFormSet.lcExSin2+'apinvhdr.ncurrunit'
      lcTemp = 'apinvhdr.ninvdistk'+loFormSet.lcExSin1+'loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.Value'+;
        +loFormSet.lcExSin2+'apinvhdr.ncurrunit'
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      
      REPLACE NVNHDISTKN WITH NVNHDISTKN + ROUND(&lcTemp,2)
      
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *!*	    lcTemp = '(loFormSet.AriaForm1.txtInvAmount.Value - apinvhdr.ninvdistk)'+;
      *!*	             loFormSet.lcExSin1+'loFormSet.AriaForm1.txtNexRate.Value'+;
      *!*	             loFormSet.lcExSin2+'apinvhdr.ncurrunit'
      lcTemp = '(loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.Value - apinvhdr.ninvdistk)'+;
        loFormSet.lcExSin1+'loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.Value'+;
        loFormSet.lcExSin2+'apinvhdr.ncurrunit'
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      
      REPLACE NVNHCCPAY  WITH NVNHCCPAY  + ROUND(&lcTemp,2)
      
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *!*	    lcTemp = '(loFormSet.AriaForm1.txtInvAmount.Value - apinvhdr.ninvdistk)'+;
      *!*	             loFormSet.lcExSin1+'loFormSet.AriaForm1.txtNexRate.Value'+;
      *!*	             loFormSet.lcExSin2+'apinvhdr.ncurrunit'
      lcTemp = '(loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.Value - apinvhdr.ninvdistk)'+;
        loFormSet.lcExSin1+'loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.Value'+;
        loFormSet.lcExSin2+'apinvhdr.ncurrunit'
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      
      REPLACE NVNHTOTPA  WITH NVNHTOTPA  + ROUND(&lcTemp,2)
      
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *!*	    lcTemp = '(loFormSet.AriaForm1.txtInvAmount.Value - apinvhdr.ninvdistk)'+;
      *!*	             loFormSet.lcExSin1+'loFormSet.AriaForm1.txtNexRate.Value'+;
      *!*	             loFormSet.lcExSin2+'apinvhdr.ncurrunit'
      lcTemp = '(loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.Value - apinvhdr.ninvdistk)'+;
        loFormSet.lcExSin1+'loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.Value'+;
        loFormSet.lcExSin2+'apinvhdr.ncurrunit'
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      
      REPLACE  &lcNewPayFld WITH EVALUATE(lcNewPayFld) + ROUND(&lcTemp,2)
    ELSE
      *! B130111,1 ASM 11/01/2005 Allow the User to Edit an Invoice whose posted date is locked, but make entries on system date [Start]
      IF loFormSet.llLokPer
        lfCheckTmpDist(loFormSet)
      ENDIF
      *! B130111,1 ASM 11/01/2005 Allow the User to Edit an Invoice whose posted date is locked, but make entries on system date [End]
      
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *=gfTmp2Mast('APDIST',loFormSet.lcTmpDist)
      lfTmp2Mast('APDIST',loFormSet.lcTmpDist)
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]


      SELECT APVENDOR

      **! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *!*	    lcTemp = '(loFormSet.AriaForm1.txtInvAmount.Value-loFormSet.lnOldInvAmt)'+;
      *!*	             loFormSet.lcExSin1+'loFormSet.AriaForm1.txtNexRate.Value'+;
      *!*	             loFormSet.lcExSin2+'apinvhdr.ncurrunit'
      lcTemp = '(loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.Value-loFormSet.lnOldInvAmt)'+;
        loFormSet.lcExSin1+'loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.Value'+;
        loFormSet.lcExSin2+'apinvhdr.ncurrunit'
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      REPLACE NVENBAL   WITH NVENBAL  + ROUND(&lcTemp,2)
      
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *!*	    lcTemp = '(loFormSet.AriaForm1.txtInvAmount.Value-loFormSet.lnOldInvAmt)'+;
      *!*	             loFormSet.lcExSin1+'loFormSet.AriaForm1.txtNexRate.Value'+;
      *!*	             loFormSet.lcExSin2+'apinvhdr.ncurrunit'
      *!*	    REPLACE NVENCPUR  WITH NVENCPUR + ROUND(&lcTemp,2), ;
      *!*	            DVENLPURD WITH loFormSet.AriaForm1.DtInvDate.Value
	  *!*	    lcTemp = 'loFormSet.AriaForm1.txtInvAmount.Value'+loFormSet.lcExSin1+;
      *!*	             'loFormSet.AriaForm1.txtNexRate.Value'+loFormSet.lcExSin2+'apinvhdr.ncurrunit'
      lcTemp = '(loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.Value-loFormSet.lnOldInvAmt)'+;
        loFormSet.lcExSin1+'loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.Value'+;
        loFormSet.lcExSin2+'apinvhdr.ncurrunit'
      REPLACE NVENCPUR  WITH NVENCPUR + ROUND(&lcTemp,2), ;
        DVENLPURD WITH loFormSet.AriaForm1.pgfpayInv.pgHead.DtInvDate.VALUE
      lcTemp = 'loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.Value'+loFormSet.lcExSin1+;
        'loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.Value'+loFormSet.lcExSin2+'apinvhdr.ncurrunit'
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      REPLACE NVENLPURA WITH ROUND(&lcTemp,2)

      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *!*	    IF loFormSet.AriaForm1.txtInvAmount.Value < 0
      *!*	      lcTemp = '(loFormSet.lnOldInvAmt - loFormSet.AriaForm1.txtInvAmount.Value)'+;
      *!*	               loFormSet.lcExSin1+'loFormSet.AriaForm1.txtNexRate.Value'+;
      *!*	               loFormSet.lcExSin2+'apinvhdr.ncurrunit'
      IF loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.VALUE < 0
        lcTemp = '(loFormSet.lnOldInvAmt - loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.Value)'+;
          loFormSet.lcExSin1+'loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.Value'+;
          loFormSet.lcExSin2+'apinvhdr.ncurrunit'
	  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
	  
        REPLACE NVENOPNDR WITH NVENOPNDR + ROUND(&lcTemp,2)
      ENDIF
      =gfAdd_Info('APVENDOR')
    ENDIF
    SELECT APVENHST
    lcNewPerFld  = 'NVNHPUR'+ALLTRIM(STR(INT(VAL(apinvhdr.cfspprdid))))

    lcOldPerFld  = 'NVNHPUR'+ALLTRIM(STR(INT(VAL(loFormSet.lcOldPeriod))))

    IF loFormSet.lcOldYear = apinvhdr.cfisfyear .OR. loFormSet.ActiveMode="A"
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *!*	    lcTemp = '(loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvDisof.Value - loFormSet.lnOldDiscOf)'+;
      *!*	             loFormSet.lcExSin1+'loFormSet.AriaForm1.txtNexRate.Value'+;
      *!*	             loFormSet.lcExSin2+'apinvhdr.ncurrunit'
      lcTemp = '(loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvDisof.Value - loFormSet.lnOldDiscOf)'+;
        loFormSet.lcExSin1+'loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.Value'+;
        loFormSet.lcExSin2+'apinvhdr.ncurrunit'
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      
      REPLACE NVNHDISOF WITH NVNHDISOF + ROUND(&lcTemp,2)

      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *    lcTemp = '(loFormSet.AriaForm1.txtInvAmount.Value - loFormSet.lnOldInvAmt)'+;
      loFormSet.lcExSin1+'loFormSet.AriaForm1.txtNexRate.Value'+;
      loFormSet.lcExSin2+'apinvhdr.ncurrunit'
      lcTemp = '(loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.Value - loFormSet.lnOldInvAmt)'+;
        loFormSet.lcExSin1+'loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.Value'+;
        loFormSet.lcExSin2+'apinvhdr.ncurrunit'
       *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[END]
      REPLACE NVNHPURCH WITH NVNHPURCH + ROUND(&lcTemp,2)
      =gfAdd_Info('APVENHST')
      IF loFormSet.lcOldPeriod = apinvhdr.cfspprdid .OR. loFormSet.ActiveMode="A"
      
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        *!*	      lcTemp = '(loFormSet.AriaForm1.txtInvAmount.Value - loFormSet.lnOldInvAmt)'+;
        *!*	               loFormSet.lcExSin1+'loFormSet.AriaForm1.txtNexRate.Value'+;
        *!*	               loFormSet.lcExSin2+'apinvhdr.ncurrunit'
        lcTemp = '(loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.Value - loFormSet.lnOldInvAmt)'+;
          loFormSet.lcExSin1+'loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.Value'+;
          loFormSet.lcExSin2+'apinvhdr.ncurrunit'

        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
        REPLACE &lcNewPerFld WITH EVALUATE(lcNewPerFld) + ROUND(&lcTemp,2)
      ELSE
      
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        *!*	      lcTemp = 'loFormSet.lnOldInvAmt'+loFormSet.lcExSin1+;
        *!*	               'loFormSet.AriaForm1.txtNexRate.Value'+loFormSet.lcExSin2+'apinvhdr.ncurrunit'
        lcTemp = 'loFormSet.lnOldInvAmt'+loFormSet.lcExSin1+;
          'loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.Value'+loFormSet.lcExSin2+'apinvhdr.ncurrunit'
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
        
        REPLACE &lcOldPerFld WITH EVALUATE(lcOldPerFld) - ROUND(&lcTemp,2)
        
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        *!*	      lcTemp = 'loFormSet.AriaForm1.txtInvAmount.Value'+loFormSet.lcExSin1+;
        *!*	                'loFormSet.AriaForm1.txtNexRate.Value'+loFormSet.lcExSin2+'apinvhdr.ncurrunit'
        lcTemp = 'loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.Value'+loFormSet.lcExSin1+;
          'loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.Value'+loFormSet.lcExSin2+'apinvhdr.ncurrunit'
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
        
        REPLACE &lcNewPerFld WITH EVALUATE(lcNewPerFld) + ROUND(&lcTemp,2)
      ENDIF
    ELSE
      
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *    lcTemp = 'loFormSet.AriaForm1.txtInvDisof.Value'+loFormSet.lcExSin1+;
      'loFormSet.AriaForm1.txtNexRate.Value'+loFormSet.lcExSin2+'apinvhdr.ncurrunit'
      lcTemp = 'loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvDisof.Value'+loFormSet.lcExSin1+;
        'loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.Value'+loFormSet.lcExSin2+'apinvhdr.ncurrunit'
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      
      REPLACE NVNHDISOF    WITH NVNHDISOF + ROUND(&lcTemp,2)
      
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *!*	    lcTemp = 'loFormSet.AriaForm1.txtInvAmount.Value'+loFormSet.lcExSin1+;
      *!*	             'loFormSet.AriaForm1.txtNexRate.Value'+loFormSet.lcExSin2+'apinvhdr.ncurrunit'
      lcTemp = 'loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.Value'+loFormSet.lcExSin1+;
        'loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.Value'+loFormSet.lcExSin2+'apinvhdr.ncurrunit'
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      
      REPLACE NVNHPURCH    WITH NVNHPURCH + ROUND(&lcTemp,2)
      
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *!*	    lcTemp = 'loFormSet.AriaForm1.txtInvAmount.Value'+loFormSet.lcExSin1+;
      *!*	             'loFormSet.AriaForm1.txtNexRate.Value'+loFormSet.lcExSin2+'apinvhdr.ncurrunit'
      lcTemp = 'loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.Value'+loFormSet.lcExSin1+;
        'loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.Value'+loFormSet.lcExSin2+'apinvhdr.ncurrunit'
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[END]
      
      REPLACE &lcNewPerFld WITH EVALUATE(lcNewPerFld) + ROUND(&lcTemp,2)
      =gfAdd_Info('APVENHST')
      IF SEEK(loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE+loFormSet.lcOldYear)
        
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        *!*	      lcTemp = 'loFormSet.lnOldDiscOf'+loFormSet.lcExSin1+;
        *!*	               'loFormSet.AriaForm1.txtNexRate.Value'+loFormSet.lcExSin2+'apinvhdr.ncurrunit'
        lcTemp = 'loFormSet.lnOldDiscOf'+loFormSet.lcExSin1+;
          'loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.Value'+loFormSet.lcExSin2+'apinvhdr.ncurrunit'
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
        
        REPLACE NVNHDISOF  WITH NVNHDISOF - ROUND(&lcTemp,2)
        
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        *!*	      lcTemp = 'loFormSet.lnOldInvAmt'+loFormSet.lcExSin1+;
        *!*	               'loFormSet.AriaForm1.txtNexRate.Value'+loFormSet.lcExSin2+'apinvhdr.ncurrunit'
        lcTemp = 'loFormSet.lnOldInvAmt'+loFormSet.lcExSin1+;
          'loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.Value'+loFormSet.lcExSin2+'apinvhdr.ncurrunit'
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
        
        REPLACE NVNHPURCH  WITH NVNHPURCH - ROUND(&lcTemp,2)
        IF loFormSet.ActiveMode="E"
          
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
          *!*	        lcTemp = 'loFormSet.lnOldInvAmt'+loFormSet.lcExSin1+;
          *!*	                 'loFormSet.AriaForm1.txtNexRate.Value'+loFormSet.lcExSin2+'apinvhdr.ncurrunit'
          lcTemp = 'loFormSet.lnOldInvAmt'+loFormSet.lcExSin1+;
            'loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.Value'+loFormSet.lcExSin2+'apinvhdr.ncurrunit'
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
          
          REPLACE &lcOldPerFld WITH EVALUATE(lcOldPerFld) - ROUND(&lcTemp,2)
        ENDIF
        =gfAdd_Info('APVENHST')
      ENDIF
    ENDIF

    SELECT APINVHDR
    loFormSet.lnInvAdj  = NINVADJ
    lcVenPrior= APVENDOR.CVENPRIOR
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *!*	  IF loFormSet.AriaForm1.cboVendPmeth.Value = 'C'
    * laData_15 = loFormSet.AriaForm1.cboTermCode.Value
    *!*	    laData_19 = loFormSet.AriaForm1.txtterdued.Value
    *!*	    laData_16 = loFormSet.AriaForm1.txtTerDiscr.Value
    *!*	    laData_24 = loFormSet.AriaForm1.txtTerDiscd.Value

    IF loFormSet.AriaForm1.pgfpayInv.pgHead.cboVendPmeth.VALUE = 'C'
      
      laData_15 = loFormSet.AriaForm1.pgfpayInv.pgHead.cboTermCode.VALUE
      laData_19 = loFormSet.AriaForm1.pgfpayInv.pgHead.txtterdued.VALUE
      laData_16 = loFormSet.AriaForm1.pgfpayInv.pgHead.txtTerDiscr.VALUE
      laData_24 = loFormSet.AriaForm1.pgfpayInv.pgHead.txtTerDiscd.VALUE
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      
      lcoldDiv  = loFormSet.lcDivision           && Division

      *Get the creditor data from the vendor file
      SELECT APVENDOR

      lnCr_Rec = RECNO()

      SEEK apinvhdr.cvenccven

      *B600597,1 Save the creditor data in temp variables
      lcVenPmeth = cVenPmeth           && Payment method
      loFormSet.lcDivision = cDivision           && Division
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *loFormSet.AriaForm1.cboTermCode.Value = cTermCode           && Term code
      loFormSet.AriaForm1.pgfpayInv.pgHead.cboTermCode.VALUE = cTermCode           && Term code
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

      GOTO lnCr_Rec

      *Get the creditor data from the codes file
      DECLARE  laTermArry[3,2]
      laTermArry[1,1] = 'NTERDISCR'
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *laTermArry[1,2] = 'loFormSet.AriaForm1.txtTerDiscr.Value'
      laTermArry[1,2] = 'loFormSet.AriaForm1.pgfpayInv.pgHead.txtTerDiscr.Value'
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      
      laTermArry[2,1] = 'NTERDUED'
      
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *laTermArry[2,2] = 'loFormSet.AriaForm1.txtterdued.Value'
      laTermArry[2,2] = 'loFormSet.AriaForm1.pgfpayInv.pgHead.txtterdued.Value'
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      
      laTermArry[3,1] = 'NTERDISCD'
      
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *laTermArry[3,2] = 'loFormSet.AriaForm1.txtTerDiscd.Value'
      laTermArry[3,2] = 'loFormSet.AriaForm1.pgfpayInv.pgHead.txtTerDiscd.Value'
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[END]
      
      *Not calculate the due days from term code if the screen in edit mode
      IF loFormSet.ActiveMode="A"
        DIMENSION laTermAry[ALEN(loFormSet.laTermAry,1),ALEN(loFormSet.laTermAry,2)]
        =ACOPY(loFormSet.laTermAry,laTermAry)
        
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        *=gfRltFld(loFormSet.AriaForm1.cboTermCode.Value , @laTermAry , 'CTERMCODE')
        =gfRltFld(loFormSet.AriaForm1.pgfpayInv.pgHead.cboTermCode.VALUE , @laTermAry , 'CTERMCODE')
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[END]
        =ACOPY(laTermAry,loFormSet.laTermAry)
      ENDIF



      SELECT APINVHDR


      lnSavRecNo = RECNO()
      SCATTER NAME loRec
      APPEND BLANK

      IF TYPE('APINVHDR.DPOSTDATE') = 'D'
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        *!*	      REPLACE CVENDCODE WITH loRec.cvenccven,;
        *!*	              CINVNO    WITH loRec.cvenccinv,;
        *!*	              CAPACCT   WITH IIF(EMPTY(STRTRAN(STRTRAN(loFormSet.lcAccount,'-'),'0')),;
        *!*	                                 ' ', loFormSet.lcAccount) ,;
        *!*	              CDIVISION WITH loFormSet.lcDivision,;
        *!*	              DINVDATE  WITH loFormSet.AriaForm1.DtInvDate.Value,;
        *!*	              CFISFYEAR WITH loRec.CFISFYEAR,;
        *!*	              CFSPPRDID WITH loRec.CFSPPRDID,;
        *!*	              CINVREF   WITH loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value ,;
        *!*	              CINVREMIT WITH 'V'       ,;
        *!*	              NINVAMNT  WITH loFormSet.lnInvAdj  ,;
        *!*	              CVENPRIOR WITH lcVenPrior,;
        *!*	              CVENPMETH WITH lcVenPmeth,;
        *!*	              CTERMCODE WITH loFormSet.AriaForm1.cboTermCode.Value,;
        *!*	              NTERDUED  WITH loFormSet.AriaForm1.txtterdued.Value,;
        *!*	              NTERDISCD WITH loFormSet.AriaForm1.txtTerDiscd.Value,;
        *!*	              NTERDISCR WITH loFormSet.AriaForm1.txtTerDiscr.Value,;
        *!*	              DINVDUDAT WITH loFormSet.AriaForm1.dtInvDuDat.Value,;
        *!*	              CVENCCVEN WITH loFormSet.AriaForm1.KBVendCode.KeyTextBox.Value ,;
        *!*	              CVENCCINV WITH loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value,;
        *!*	              CCURRCODE WITH loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value,;
        *!*	              NEXRATE   WITH loFormSet.AriaForm1.txtNexRate.Value,;
        *!*	              NCURRUNIT WITH loRec.NCURRUNIT,;
        *!*	              DPOSTDATE WITH loFormSet.AriaForm1.DtPostDate.Value
        REPLACE CVENDCODE WITH loRec.cvenccven,;
          CINVNO    WITH loRec.cvenccinv,;
          CAPACCT   WITH IIF(EMPTY(STRTRAN(STRTRAN(loFormSet.lcAccount,'-'),'0')),;
          ' ', loFormSet.lcAccount) ,;
          CDIVISION WITH loFormSet.lcDivision,;
          DINVDATE  WITH loFormSet.AriaForm1.pgfpayInv.pgHead.DtInvDate.VALUE,;
          CFISFYEAR WITH loRec.CFISFYEAR,;
          CFSPPRDID WITH loRec.CFSPPRDID,;
          CINVREF   WITH loFormSet.AriaForm1.kbInvNo.KeyTextBox.VALUE ,;
          CINVREMIT WITH 'V'       ,;
          NINVAMNT  WITH loFormSet.lnInvAdj  ,;
          CVENPRIOR WITH lcVenPrior,;
          CVENPMETH WITH lcVenPmeth,;
          CTERMCODE WITH loFormSet.AriaForm1.pgfpayInv.pgHead.cboTermCode.VALUE,;
          NTERDUED  WITH loFormSet.AriaForm1.pgfpayInv.pgHead.txtterdued.VALUE,;
          NTERDISCD WITH loFormSet.AriaForm1.pgfpayInv.pgHead.txtTerDiscd.VALUE,;
          NTERDISCR WITH loFormSet.AriaForm1.pgfpayInv.pgHead.txtTerDiscr.VALUE,;
          DINVDUDAT WITH loFormSet.AriaForm1.pgfpayInv.pgHead.dtInvDuDat.VALUE,;
          CVENCCVEN WITH loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE ,;
          CVENCCINV WITH loFormSet.AriaForm1.kbInvNo.KeyTextBox.VALUE,;
          CCURRCODE WITH loFormSet.AriaForm1.pgfpayInv.pgHead.kbCurrCode.KeyTextBox.VALUE,;
          NEXRATE   WITH loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.VALUE,;
          NCURRUNIT WITH loRec.NCURRUNIT,;
          DPOSTDATE WITH loFormSet.AriaForm1.DtPostDate.VALUE
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      ELSE
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        *!*	      REPLACE CVENDCODE WITH loRec.cvenccven,;
        *!*	              CINVNO    WITH loRec.cvenccinv,;
        *!*	              CAPACCT   WITH IIF(EMPTY(STRTRAN(STRTRAN(loFormSet.lcAccount,'-'),'0')),;
        *!*	                                 ' ', loFormSet.lcAccount) ,;
        *!*	              CDIVISION WITH loFormSet.lcDivision,;
        *!*	              DINVDATE  WITH loFormSet.AriaForm1.DtInvDate.Value,;
        *!*	              CFISFYEAR WITH loRec.CFISFYEAR,;
        *!*	              CFSPPRDID WITH loRec.CFSPPRDID,;
        *!*	              CINVREF   WITH loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value ,;
        *!*	              CINVREMIT WITH 'V'       ,;
        *!*	              NINVAMNT  WITH loFormSet.lnInvAdj  ,;
        *!*	              CVENPRIOR WITH lcVenPrior,;
        *!*	              CVENPMETH WITH lcVenPmeth,;
        *!*	              CTERMCODE WITH loFormSet.AriaForm1.cboTermCode.Value,;
        *!*	              NTERDUED  WITH loFormSet.AriaForm1.txtterdued.Value,;
        *!*	              NTERDISCD WITH loFormSet.AriaForm1.txtTerDiscd.Value,;
        *!*	              NTERDISCR WITH loFormSet.AriaForm1.txtTerDiscr.Value,;
        *!*	              DINVDUDAT WITH loFormSet.AriaForm1.dtInvDuDat.Value,;
        *!*	              CVENCCVEN WITH loFormSet.AriaForm1.KBVendCode.KeyTextBox.Value ,;
        *!*	              CVENCCINV WITH loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value,;
        *!*	              CCURRCODE WITH loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value,;
        *!*	              NEXRATE   WITH loFormSet.AriaForm1.txtNexRate.Value,;
        *!*	              NCURRUNIT WITH loRec.NCURRUNIT
        REPLACE CVENDCODE WITH loRec.cvenccven,;
          CINVNO    WITH loRec.cvenccinv,;
          CAPACCT   WITH IIF(EMPTY(STRTRAN(STRTRAN(loFormSet.lcAccount,'-'),'0')),;
          ' ', loFormSet.lcAccount) ,;
          CDIVISION WITH loFormSet.lcDivision,;
          DINVDATE  WITH loFormSet.AriaForm1.pgfpayInv.pgHead.DtInvDate.VALUE,;
          CFISFYEAR WITH loRec.CFISFYEAR,;
          CFSPPRDID WITH loRec.CFSPPRDID,;
          CINVREF   WITH loFormSet.AriaForm1.kbInvNo.KeyTextBox.VALUE ,;
          CINVREMIT WITH 'V'       ,;
          NINVAMNT  WITH loFormSet.lnInvAdj  ,;
          CVENPRIOR WITH lcVenPrior,;
          CVENPMETH WITH lcVenPmeth,;
          CTERMCODE WITH loFormSet.AriaForm1.pgfpayInv.pgHead.cboTermCode.VALUE,;
          NTERDUED  WITH loFormSet.AriaForm1.pgfpayInv.pgHead.txtterdued.VALUE,;
          NTERDISCD WITH loFormSet.AriaForm1.pgfpayInv.pgHead.txtTerDiscd.VALUE,;
          NTERDISCR WITH loFormSet.AriaForm1.pgfpayInv.pgHead.txtTerDiscr.VALUE,;
          DINVDUDAT WITH loFormSet.AriaForm1.pgfpayInv.pgHead.dtInvDuDat.VALUE,;
          CVENCCVEN WITH loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE ,;
          CVENCCINV WITH loFormSet.AriaForm1.kbInvNo.KeyTextBox.VALUE,;
          CCURRCODE WITH loFormSet.AriaForm1.pgfpayInv.pgHead.kbCurrCode.KeyTextBox.VALUE,;
          NEXRATE   WITH loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.VALUE,;
          NCURRUNIT WITH loRec.NCURRUNIT
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      ENDIF

      =gfAdd_Info('APINVHDR')
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      =gfReplace("")
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[END]
      *Save old array data
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *loFormSet.AriaForm1.cboTermCode.Value = laData_15
      *!*	    loFormSet.AriaForm1.txtterdued.Value = laData_19
      *!*	    loFormSet.AriaForm1.txtTerDiscr.Value = laData_16
      *!*	    loFormSet.AriaForm1.txtTerDiscd.Value = laData_24
      loFormSet.AriaForm1.pgfpayInv.pgHead.cboTermCode.VALUE = laData_15
      loFormSet.AriaForm1.pgfpayInv.pgHead.txtterdued.VALUE = laData_19
      loFormSet.AriaForm1.pgfpayInv.pgHead.txtTerDiscr.VALUE = laData_16
      loFormSet.AriaForm1.pgfpayInv.pgHead.txtTerDiscd.VALUE = laData_24
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[END]
      loFormSet.lcDivision  = lcoldDiv            && Division



      SELECT APDIST
      APPEND BLANK


      IF TYPE('APINVHDR.DPOSTDATE') = 'D'

        **! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        *!*	      REPLACE CVENDCODE WITH apinvhdr.cvenccven,;
        *!*	              CINVNO    WITH apinvhdr.cvenccinv,;
        *!*	              DAPDTRDAT WITH loFormSet.AriaForm1.DtPostDate.Value,;
        *!*	              LAPDPOST  WITH .F.       ,;
        *!*	              CAPDREF   WITH loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value ,;
        *!*	              CAPDGLACT WITH loFormSet.DistLines.glAPActCode.KeyTextBox.Value,;
        *!*	              CAPDTRTYP WITH 'I'       ,;
        *!*	              NAPDAMNT  WITH loFormSet.AriaForm1.txtInvAmount.Value,;
        *!*	              CFISFYEAR WITH loFormSet.lcDistYer ,;
        *!*	              CFSPPRDID WITH loFormSet.lcDistPrd ,;
        *!*	              CAPSESSNO WITH loFormSet.lcSequence,;
        *!*	              CCURRCODE WITH loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value,;
        *!*	              NEXRATE   WITH loFormSet.AriaForm1.txtNexRate.Value,;
        *!*	              NCURRUNIT WITH apinvhdr.ncurrunit
        *!*	      lcTemp = 'loFormSet.AriaForm1.txtInvAmount.Value'+loFormSet.lcExSin1+;
        *!*	               'loFormSet.AriaForm1.txtNexRate.Value'+loFormSet.lcExSin2+'apinvhdr.ncurrunit'
        REPLACE CVENDCODE WITH apinvhdr.cvenccven,;
          CINVNO    WITH apinvhdr.cvenccinv,;
          DAPDTRDAT WITH loFormSet.AriaForm1.DtPostDate.VALUE,;
          LAPDPOST  WITH .F.       ,;
          CAPDREF   WITH loFormSet.AriaForm1.kbInvNo.KeyTextBox.VALUE ,;
          CAPDGLACT WITH loFormSet.AriaForm1.pgfpayInv.pgDist.glAPActCode.KeyTextBox.VALUE,;
          CAPDTRTYP WITH 'I'       ,;
          NAPDAMNT  WITH loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.VALUE,;
          CFISFYEAR WITH loFormSet.lcDistYer ,;
          CFSPPRDID WITH loFormSet.lcDistPrd ,;
          CAPSESSNO WITH loFormSet.lcSequence,;
          CCURRCODE WITH loFormSet.AriaForm1.pgfpayInv.pgHead.kbCurrCode.KeyTextBox.VALUE,;
          NEXRATE   WITH loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.VALUE,;
          NCURRUNIT WITH apinvhdr.ncurrunit
        lcTemp = 'loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.Value'+loFormSet.lcExSin1+;
          'loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.Value'+loFormSet.lcExSin2+'apinvhdr.ncurrunit'
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
        REPLACE NEQVAMNT  WITH ROUND(&lcTemp,2), cApdActId WITH 'A'

      ELSE
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        *!*	      REPLACE CVENDCODE WITH apinvhdr.cvenccven ,;
        *!*	              CINVNO    WITH apinvhdr.cvenccinv ,;
        *!*	              DAPDTRDAT WITH loFormSet.AriaForm1.DtInvDate.Value,;
        *!*	              LAPDPOST  WITH .F.       ,;
        *!*	              CAPDREF   WITH loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value ,;
        *!*	              CAPDGLACT WITH loFormSet.DistLines.glAPActCode.KeyTextBox.Value,;
        *!*	              CAPDTRTYP WITH 'I'       ,;
        *!*	              NAPDAMNT  WITH loFormSet.AriaForm1.txtInvAmount.Value,;
        *!*	              CFISFYEAR WITH apinvhdr.cfisfyear,;
        *!*	              CFSPPRDID WITH apinvhdr.cfspprdid,;
        *!*	              CAPSESSNO WITH loFormSet.lcSequence,;
        *!*	              CCURRCODE WITH loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value,;
        *!*	              NEXRATE   WITH loFormSet.AriaForm1.txtNexRate.Value,;
        *!*	              NCURRUNIT WITH apinvhdr.ncurrunit
        *lcTemp = 'loFormSet.AriaForm1.txtInvAmount.Value'+loFormSet.lcExSin1+;
        'loFormSet.AriaForm1.txtNexRate.Value'+loFormSet.lcExSin2+'apinvhdr.ncurrunit'

        REPLACE CVENDCODE WITH apinvhdr.cvenccven ,;
          CINVNO    WITH apinvhdr.cvenccinv ,;
          DAPDTRDAT WITH loFormSet.AriaForm1.pgfpayInv.pgHead.DtInvDate.VALUE,;
          LAPDPOST  WITH .F.       ,;
          CAPDREF   WITH loFormSet.AriaForm1.kbInvNo.KeyTextBox.VALUE ,;
          CAPDGLACT WITH loFormSet.AriaForm1.pgfpayInv.pgDist.glAPActCode.KeyTextBox.VALUE,;
          CAPDTRTYP WITH 'I'       ,;
          NAPDAMNT  WITH loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.VALUE,;
          CFISFYEAR WITH apinvhdr.cfisfyear,;
          CFSPPRDID WITH apinvhdr.cfspprdid,;
          CAPSESSNO WITH loFormSet.lcSequence,;
          CCURRCODE WITH loFormSet.AriaForm1.pgfpayInv.pgHead.kbCurrCode.KeyTextBox.VALUE,;
          NEXRATE   WITH loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.VALUE,;
          NCURRUNIT WITH apinvhdr.ncurrunit
          
       lcTemp = 'loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.Value'+loFormSet.lcExSin1+;
          'loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.Value'+loFormSet.lcExSin2+'apinvhdr.ncurrunit'
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
        REPLACE NEQVAMNT  WITH ROUND(&lcTemp,2), cApdActId WITH 'A'
      ENDIF

      =gfAdd_Info('APDIST')
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      =gfReplace("")
      =gfReplace('MAPDIST with APDIST.MAPDIST')
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[END]

      APPEND BLANK

      IF TYPE('APINVHDR.DPOSTDATE') = 'D'

        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        *!*	      REPLACE CVENDCODE WITH apinvhdr.cvenccven ;
        *!*	              CINVNO    WITH apinvhdr.cvenccinv ;
        *!*	              DAPDTRDAT WITH loFormSet.AriaForm1.DtPostDate.Value,;
        *!*	              LAPDPOST  WITH .F.       ,;
        *!*	              CAPDREF   WITH loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value ,;
        *!*	              CAPDTRTYP WITH 'I'       ,;
        *!*	              CAPDGLACT WITH IIF(EMPTY(STRTRAN(STRTRAN(loFormSet.lcAccount,'-'),'0')),;
        *!*	                                 ' ', loFormSet.lcAccount) ,;
        *!*	              NAPDAMNT  WITH loFormSet.AriaForm1.txtInvDisof.Value - loFormSet.AriaForm1.txtInvAmount.Value;
        *!*	              CFISFYEAR WITH loFormSet.lcDistYer ,;
        *!*	              CFSPPRDID WITH loFormSet.lcDistPrd ,;
        *!*	              CAPSESSNO WITH loFormSet.lcSequence,;
        *!*	              CCURRCODE WITH loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value,;
        *!*	              NEXRATE   WITH loFormSet.AriaForm1.txtNexRate.Value,;
        *!*	              NCURRUNIT WITH apinvhdr.ncurrunit
        *!*	      lcTemp = 'NAPDAMNT'+loFormSet.lcExSin1+'loFormSet.AriaForm1.txtNexRate.Value'+;
        *!*	               loFormSet.lcExSin2+'apinvhdr.ncurrunit'
        REPLACE CVENDCODE WITH apinvhdr.cvenccven ;
          CINVNO    WITH apinvhdr.cvenccinv ;
          DAPDTRDAT WITH loFormSet.AriaForm1.DtPostDate.VALUE,;
          LAPDPOST  WITH .F.       ,;
          CAPDREF   WITH loFormSet.AriaForm1.kbInvNo.KeyTextBox.VALUE ,;
          CAPDTRTYP WITH 'I'       ,;
          CAPDGLACT WITH IIF(EMPTY(STRTRAN(STRTRAN(loFormSet.lcAccount,'-'),'0')),;
          ' ', loFormSet.lcAccount) ,;
          NAPDAMNT  WITH loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvDisof.VALUE - loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.VALUE;
          CFISFYEAR WITH loFormSet.lcDistYer ,;
          CFSPPRDID WITH loFormSet.lcDistPrd ,;
          CAPSESSNO WITH loFormSet.lcSequence,;
          CCURRCODE WITH loFormSet.AriaForm1.pgfpayInv.pgHead.kbCurrCode.KeyTextBox.VALUE,;
          NEXRATE   WITH loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.VALUE,;
          NCURRUNIT WITH apinvhdr.ncurrunit

        lcTemp = 'NAPDAMNT'+loFormSet.lcExSin1+'loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.Value'+;
          loFormSet.lcExSin2+'apinvhdr.ncurrunit'
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
        REPLACE NEQVAMNT  WITH ROUND(&lcTemp,2), cApdActId WITH 'A'

      ELSE
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        *!*	      REPLACE CVENDCODE WITH apinvhdr.cvenccven ;
        *!*	              CINVNO    WITH apinvhdr.cvenccinv ;
        *!*	              DAPDTRDAT WITH loFormSet.AriaForm1.DtInvDate.Value,;
        *!*	              LAPDPOST  WITH .F.       ,;
        *!*	              CAPDREF   WITH loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value ,;
        *!*	              CAPDTRTYP WITH 'I'       ,;
        *!*	              CAPDGLACT WITH IIF(EMPTY(STRTRAN(STRTRAN(loFormSet.lcAccount,'-'),'0')),;
        *!*	                                 ' ', loFormSet.lcAccount) ,;
        *!*	              NAPDAMNT  WITH loFormSet.AriaForm1.txtInvDisof.Value - loFormSet.AriaForm1.txtInvAmount.Value,;
        *!*	              CFISFYEAR WITH apinvhdr.cfisfyear,;
        *!*	              CFSPPRDID WITH apinvhdr.cfspprdid,;
        *!*	              CAPSESSNO WITH loFormSet.lcSequence,;
        *!*	              CCURRCODE WITH loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value,;
        *!*	              NEXRATE   WITH loFormSet.AriaForm1.txtNexRate.Value,;
        *!*	              NCURRUNIT WITH apinvhdr.ncurrunit
        *!*	      lcTemp = 'NAPDAMNT'+loFormSet.lcExSin1+'loFormSet.AriaForm1.txtNexRate.Value'+;
        *!*	               loFormSet.lcExSin2+'apinvhdr.ncurrunit'
        REPLACE CVENDCODE WITH apinvhdr.cvenccven ;
          CINVNO    WITH apinvhdr.cvenccinv ;
          DAPDTRDAT WITH loFormSet.AriaForm1.pgfpayInv.pgHead.DtInvDate.VALUE,;
          LAPDPOST  WITH .F.       ,;
          CAPDREF   WITH loFormSet.AriaForm1.kbInvNo.KeyTextBox.VALUE ,;
          CAPDTRTYP WITH 'I'       ,;
          CAPDGLACT WITH IIF(EMPTY(STRTRAN(STRTRAN(loFormSet.lcAccount,'-'),'0')),;
          ' ', loFormSet.lcAccount) ,;
          NAPDAMNT  WITH loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvDisof.VALUE - loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.VALUE,;
          CFISFYEAR WITH apinvhdr.cfisfyear,;
          CFSPPRDID WITH apinvhdr.cfspprdid,;
          CAPSESSNO WITH loFormSet.lcSequence,;
          CCURRCODE WITH loFormSet.AriaForm1.pgfpayInv.pgHead.kbCurrCode.KeyTextBox.VALUE,;
          NEXRATE   WITH loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.VALUE,;
          NCURRUNIT WITH apinvhdr.ncurrunit
        
        lcTemp = 'NAPDAMNT'+loFormSet.lcExSin1+'loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.Value'+;
          loFormSet.lcExSin2+'apinvhdr.ncurrunit'
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
        REPLACE NEQVAMNT  WITH ROUND(&lcTemp,2), cApdActId WITH 'A'

      ENDIF

      =gfAdd_Info('APDIST')
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      =gfReplace("")
      =gfReplace('MAPDIST with APDIST.MAPDIST')
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

      * Adding new entry of discount account if discount amount is greater than zero.
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *IF loFormSet.AriaForm1.txtInvDisof.Value > 0
      IF loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvDisof.VALUE > 0
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
        
        APPEND BLANK
        IF TYPE('APINVHDR.DPOSTDATE') = 'D'
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
          *!*	        REPLACE CVENDCODE WITH apinvhdr.cvenccven ;
          *!*	                CINVNO    WITH apinvhdr.cvenccinv ;
          *!*	                DAPDTRDAT WITH loFormSet.AriaForm1.DtPostDate.Value,;
          *!*	                LAPDPOST  WITH .F.       ,;
          *!*	                CAPDREF   WITH loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value ,;
          *!*	                CAPDTRTYP WITH 'I'       ,;
          *!*	                cApdActId with 'S'       ,;
          *!*	                CAPDGLACT WITH loFormSet.lcDisAcct ,;
          *!*	                NAPDAMNT  WITH -loFormSet.AriaForm1.txtInvDisof.Value,;
          *!*	                CFISFYEAR WITH loFormSet.lcDistYer ,;
          *!*	                CFSPPRDID WITH loFormSet.lcDistPrd ,;
          *!*	                CAPSESSNO WITH loFormSet.lcSequence,;
          *!*	                CCURRCODE WITH loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value,;
          *!*	                NEXRATE   WITH loFormSet.AriaForm1.txtNexRate.Value,;
          *!*	                NCURRUNIT WITH apinvhdr.ncurrunit
          *!*	        lcTemp = 'NAPDAMNT'+loFormSet.lcExSin1+'loFormSet.AriaForm1.txtNexRate.Value'+;
          *!*	                 loFormSet.lcExSin2+'apinvhdr.ncurrunit'

          REPLACE CVENDCODE WITH apinvhdr.cvenccven ;
            CINVNO    WITH apinvhdr.cvenccinv ;
            DAPDTRDAT WITH loFormSet.AriaForm1.DtPostDate.VALUE,;
            LAPDPOST  WITH .F.       ,;
            CAPDREF   WITH loFormSet.AriaForm1.kbInvNo.KeyTextBox.VALUE ,;
            CAPDTRTYP WITH 'I'       ,;
            cApdActId WITH 'S'       ,;
            CAPDGLACT WITH loFormSet.lcDisAcct ,;
            NAPDAMNT  WITH -loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvDisof.VALUE,;
            CFISFYEAR WITH loFormSet.lcDistYer ,;
            CFSPPRDID WITH loFormSet.lcDistPrd ,;
            CAPSESSNO WITH loFormSet.lcSequence,;
            CCURRCODE WITH loFormSet.AriaForm1.pgfpayInv.pgHead.kbCurrCode.KeyTextBox.VALUE,;
            NEXRATE   WITH loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.VALUE,;
            NCURRUNIT WITH apinvhdr.ncurrunit


          lcTemp = 'NAPDAMNT'+loFormSet.lcExSin1+'loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.Value'+;
            loFormSet.lcExSin2+'apinvhdr.ncurrunit'
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
          REPLACE NEQVAMNT  WITH ROUND(&lcTemp,2)
        ELSE
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
          *!*	        REPLACE CVENDCODE WITH apinvhdr.cvenccven ;
          *!*	                CINVNO    WITH apinvhdr.cvenccinv ;
          *!*	                DAPDTRDAT WITH loFormSet.AriaForm1.DtInvDate.Value,;
          *!*	                LAPDPOST  WITH .F.       ,;
          *!*	                CAPDREF   WITH loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value ,;
          *!*	                CAPDTRTYP WITH 'I'       ,;
          *!*	                cApdActId with 'S'       ,;
          *!*	                CAPDGLACT WITH loFormSet.lcDisAcct ,;
          *!*	                NAPDAMNT  WITH -loFormSet.AriaForm1.txtInvDisof.Value;
          *!*	                CFISFYEAR WITH apinvhdr.cfisfyear,;
          *!*	                CFSPPRDID WITH apinvhdr.cfspprdid,;
          *!*	                CAPSESSNO WITH loFormSet.lcSequence,;
          *!*	                CCURRCODE WITH loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value,;
          *!*	                NEXRATE   WITH loFormSet.AriaForm1.txtNexRate.Value,;
          *!*	                NCURRUNIT WITH apinvhdr.ncurrunit
          *!*	        lcTemp = 'NAPDAMNT'+loFormSet.lcExSin1+'loFormSet.AriaForm1.txtNexRate.Value'+;
          *!*	                 loFormSet.lcExSin2+'apinvhdr.ncurrunit'
          REPLACE CVENDCODE WITH apinvhdr.cvenccven ;
            CINVNO    WITH apinvhdr.cvenccinv ;
            DAPDTRDAT WITH loFormSet.AriaForm1.pgfpayInv.pgHead.DtInvDate.VALUE,;
            LAPDPOST  WITH .F.       ,;
            CAPDREF   WITH loFormSet.AriaForm1.kbInvNo.KeyTextBox.VALUE ,;
            CAPDTRTYP WITH 'I'       ,;
            cApdActId WITH 'S'       ,;
            CAPDGLACT WITH loFormSet.lcDisAcct ,;
            NAPDAMNT  WITH -loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvDisof.VALUE;
            CFISFYEAR WITH apinvhdr.cfisfyear,;
            CFSPPRDID WITH apinvhdr.cfspprdid,;
            CAPSESSNO WITH loFormSet.lcSequence,;
            CCURRCODE WITH loFormSet.AriaForm1.pgfpayInv.pgHead.kbCurrCode.KeyTextBox.VALUE,;
            NEXRATE   WITH loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.VALUE,;
            NCURRUNIT WITH apinvhdr.ncurrunit
             
          lcTemp = 'NAPDAMNT'+loFormSet.lcExSin1+'loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.Value'+;
            loFormSet.lcExSin2+'apinvhdr.ncurrunit'
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
          REPLACE NEQVAMNT  WITH ROUND(&lcTemp,2)

        ENDIF
        =gfAdd_Info('APDIST')

        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        =gfReplace("")
        =gfReplace('MAPDIST with APDIST.MAPDIST')
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

      ENDIF

      ** Update the Vendor & the Vendor History files **
      *Q8: Why ? will this reposition the record pointer in APVENDOR & APVENHST
      lcOlData1 = loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE
      loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE = apinvhdr.cvenccven

      SELECT APINVHDR
      IF !EOF()
        GO RECNO()
      ENDIF

      SELECT APVENDOR
      
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *!*	    REPLACE NVENBAL   WITH NVENBAL + ROUND((loFormSet.AriaForm1.txtInvAmount.Value - loFormSet.AriaForm1.txtInvDisof.Value) * loFormSet.AriaForm1.txtNexRate.Value/apinvhdr.ncurrunit,2) ,;
      *!*	            NVENCPUR  WITH NVENCPUR + ROUND((loFormSet.AriaForm1.txtInvAmount.Value-loFormSet.AriaForm1.txtInvDisof.Value) * loFormSet.AriaForm1.txtNexRate.Value/apinvhdr.ncurrunit,2),;
      *!*	            DVENLPURD WITH loFormSet.AriaForm1.DtInvDate.Value,;
      *!*	            NVENLPURA WITH ROUND((loFormSet.AriaForm1.txtInvAmount.Value - loFormSet.AriaForm1.txtInvDisof.Value) * loFormSet.AriaForm1.txtNexRate.Value/apinvhdr.ncurrunit,2)
      REPLACE NVENBAL   WITH NVENBAL + ROUND((loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.VALUE - loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvDisof.VALUE) * loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.VALUE/apinvhdr.ncurrunit,2) ,;
        NVENCPUR  WITH NVENCPUR + ROUND((loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.VALUE-loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvDisof.VALUE) * loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.VALUE/apinvhdr.ncurrunit,2),;
        DVENLPURD WITH loFormSet.AriaForm1.pgfpayInv.pgHead.DtInvDate.VALUE,;
        NVENLPURA WITH ROUND((loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.VALUE - loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvDisof.VALUE) * loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.VALUE/apinvhdr.ncurrunit,2)

      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      =gfAdd_Info('APVENDOR')
      
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      =gfReplace("")
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]


      SELECT APVENHST
      
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *!*	    REPLACE NVNHPURCH    WITH NVNHPURCH + ROUND((loFormSet.AriaForm1.txtInvAmount.Value - loFormSet.AriaForm1.txtInvDisof.Value) * loFormSet.AriaForm1.txtNexRate.Value/apinvhdr.ncurrunit,2) ,;
      *!*	            &lcNewPerFld WITH EVALUATE(lcNewPerFld) + ROUND((loFormSet.AriaForm1.txtInvAmount.Value - loFormSet.AriaForm1.txtInvDisof.Value) * loFormSet.AriaForm1.txtNexRate.Value/apinvhdr.ncurrunit,2)
      REPLACE NVNHPURCH    WITH NVNHPURCH + ROUND((loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.VALUE - loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvDisof.VALUE) * loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.VALUE/apinvhdr.ncurrunit,2) ,;
        &lcNewPerFld WITH EVALUATE(lcNewPerFld) + ROUND((loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.VALUE - loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvDisof.VALUE) * loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.VALUE/apinvhdr.ncurrunit,2)
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      
      =gfAdd_Info('APVENHST')
      
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      =gfReplace("")
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

      loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE = lcOlData1

      SELECT APINVHDR
      GO lnSavRecNo
      *Old: SHOW GET pbEdt DISABLE &&Revise
      loFormSet.llEditButton = .F.
    ENDIF
    *Make adjutment if invoice amount does not total approved amount
    =IIF(EMPTY(loFormSet.lcVenInvTypes) OR !loFormSet.llUpdInvLn,.T.,lfInvAdjust(loFormSet))

    =gfFLOCK("APINVHDR,APDIST,APVENDOR,APVENHST",.F.)

    *Update Invoice Details File

    *Update costing files if invoice lines called

    =IIF(EMPTY(loFormSet.lcVenInvTypes) OR !loFormSet.llUpdInvLn,.T.,lfUpdFiles(loFormSet))

    *B128863,1 ASM Fix the Bug of Saving Fox Tables even when SQL Gives errors and RollBack [Start]
    *=gfAdd_Info('APINVHDR')
    *lnRecno=RECNO('apinvhdr')
    *REPLACE llok_stat WITH .F.
    *=TABLEUPDATE(.T.,.T.,'APINVHDR')
    *IF lnRecno>0
    *GO lnRecno IN APINVHDR
    *ENDIF
    *=TABLEUPDATE(.T.,.T.,'APVENDOR')
    *=TABLEUPDATE(.T.,.T.,'APVENHST')
    *=TABLEUPDATE(.T.,.T.,'APDIST')
    *=TABLEUPDATE(.T.,.T.,'APINVAHD')
    *IF !EMPTY(loFormSet.lcVenInvTypes) .AND. loFormSet.llUpdInvLn
    *=TABLEUPDATE(.T.,.T.,'APVINVDT')
    *=TABLEUPDATE(.T.,.T.,'APINVTKT')
    *=TABLEUPDATE(.T.,.T.,'ApPaymnt')
    *lcTranCode = oAriaApplication.RemoteCompanyData.BeginTran(oAriaApplication.ActiveCompanyConStr,3,'')
    *IF TYPE('lcTranCode') = 'N'
    *=oAriaApplication.RemoteCompanyData.CheckRetResult("BeginTran",lcTranCode,.T.)
    *RETURN .F.
    *ENDIF
    *IF lfUpdateSql(loFormSet,lcTranCode)
    *=oAriaApplication.RemoteCompanyData.CommitTran(lcTranCode)
    *WAIT WINDOW 'Sql Updated Successfully'
    *ELSE
    *=oAriaApplication.RemoteCompanyData.RollBackTran(lcTranCode)
    *ENDIF
    *ENDIF
    *=TABLEUPDATE(.T.,.T.,loFormSet.lcTmpDist)
    *=CURSORSETPROP("Buffering",1,loFormSet.lcTmpDist)
    *! C200957,1 MHM 03/02/2008 T20070920.0001  Add register No. for All UK customers.[Start]
    IF ASCAN(loFormSet.laEvntTrig,PADR('ADDAPREG',10),1,ALEN(loFormSet.laEvntTrig,1),1) > 0
      =loFormSet.mDoTrigger(PADR('ADDAPREG',10))
    ENDIF
    *! C200957,1 MHM 03/02/2008 [END]

    =gfAdd_Info('APINVHDR')
    lnRecno=RECNO('apinvhdr')
    REPLACE llok_stat WITH .F.
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    =gfReplace("")
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

    llRevert = .F.

    IF !EMPTY(loFormSet.lcVenInvTypes) .AND. loFormSet.llUpdInvLn
      lcTranCode = oAriaApplication.RemoteCompanyData.BeginTran(oAriaApplication.ActiveCompanyConStr,3,'')
      *B128863,1 ASM [Strat]
      *IF TYPE('lcTranCode') = 'N'
      IF TYPE('lcTranCode') <> 'C'
        *B128863,1 ASM [End]
        =oAriaApplication.RemoteCompanyData.CheckRetResult("BeginTran",lcTranCode,.T.)
        RETURN .F.
      ENDIF
      IF lfUpdateSql(loFormSet,lcTranCode)
        =oAriaApplication.RemoteCompanyData.CommitTran(lcTranCode)
        llRevert = .F.
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        *!*	     =TABLEUPDATE(.T.,.T.,'APVINVDT')
        *!*	     =TABLEUPDATE(.T.,.T.,'APINVTKT')
        *!*	     =TABLEUPDATE(.T.,.T.,'ApPaymnt')
        SELECT APVINVDT
        =gfTABLEUPDATE()
        SELECT APINVTKT
        =gfTABLEUPDATE()
        SELECT ApPaymnt
        =gfTABLEUPDATE()
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
        *WAIT WINDOW 'Sql Updated Successfully'
      ELSE
        =oAriaApplication.RemoteCompanyData.RollBackTran(lcTranCode)
        llRevert = .T.
        =lfRevertSql(loFormSet)
        =TABLEREVERT(.T.,'APVINVDT')
        =TABLEREVERT(.T.,'APINVTKT')
        =TABLEREVERT(.T.,'ApPaymnt')
      ENDIF
    ENDIF

    IF !llRevert
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *=TABLEUPDATE(.T.,.T.,'APINVHDR')
      SELECT APINVHDR
      =gfTABLEUPDATE()
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      IF lnRecno>0
        GO lnRecno IN APINVHDR
      ENDIF
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *!*	    =TABLEUPDATE(.T.,.T.,'APVENDOR')
      *!*	    =TABLEUPDATE(.T.,.T.,'APVENHST')
      *!*	    =TABLEUPDATE(.T.,.T.,'APDIST')
      *!*	    =TABLEUPDATE(.T.,.T.,'APINVAHD')
      SELECT APVENDOR
      =gfTABLEUPDATE()
      SELECT APVENHST
      =gfTABLEUPDATE()
      SELECT APDIST
      =gfTABLEUPDATE()
      SELECT APINVAHD
      =gfTABLEUPDATE()
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      =TABLEUPDATE(.T.,.T.,loFormSet.lcTmpDist)
      =CURSORSETPROP("Buffering",1,loFormSet.lcTmpDist)
    ELSE
      =TABLEREVERT(.T.,'APINVHDR')
      IF lnRecno>0
        GO lnRecno IN APINVHDR
      ENDIF
      =TABLEREVERT(.T.,'APVENDOR')
      =TABLEREVERT(.T.,'APVENHST')
      =TABLEREVERT(.T.,'APDIST')
      =TABLEREVERT(.T.,'APINVAHD')
      =TABLEREVERT(.T.,loFormSet.lcTmpDist)
      =CURSORSETPROP("Buffering",1,loFormSet.lcTmpDist)
      =gfModalGen("TRM04204B00000","DIALOG")
    ENDIF
    *B128863,1 ASM Fix the Bug of Saving Fox Tables even when SQL Gives errors and RollBack [End]

  ELSE
    =gfFLOCK("APINVHDR,APDIST,APVENDOR,APVENHST",.F.)

    *Add this line to update the flag llCSave and give the user
    *          message that the saving process is canceled [Begin]
    llCSave = .F.
    =gfModalGen("TRM00103B00000","DIALOG",'Saving')
    *Add this line to update the flag llCSave [End]
    =lfRevertSql(loFormSet)
    *WAIT WINDOW 'Sql Reverted'
    =TABLEREVERT(.T.,loFormSet.lcTmpDist)
    =CURSORSETPROP("Buffering",1,loFormSet.lcTmpDist)

  ENDIF

  *Old: IF WVISIBLE('CWRAPDISTR')
  *Old: =gfChClose('CWRAPDISTR')
  *Old: ENDIF
  *Old: IF USED('APVENHST') .AND. llOpVHst
  *Old: =gfCloseFile('APVENHST')
  *USE IN APVENHST
  *Old: ENDIF
  *Old: IF USED('SYCFACT') .AND. llopFact
  *Old: =gfCloseFile('SYCFACT')
  *USE IN SYCFACT
  *Old: ENDIF
  SELECT APINVHDR
  SET EXACT &lcSavExact


  RETURN
  *-- End of lfFormSaveFiles


  *!*************************************************************
  *! Name      : lfFormDelete
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 8/16/2004
  *! Purpose   : Procedure called from the Delete Method of the FormSet
  *!*************************************************************
  *! Parameters: The FormSet
  *!*************************************************************
  *! Returns   : None
  *!*************************************************************
FUNCTION lfFormDelete
  LPARAMETERS loFormSet
  LOCAL loRec

  IF gfModalGen("QRM00002B00006","ALERT",'Void') <> 1
    RETURN .F.
  ENDIF

  *Define 2 variable to deal with new posting date screen [Begin]
  PRIVATE lnDateWdth
  lnDateWdth = IIF('ON'$SET('CENT'),10,8)*(FONTME(7,'MS SANS SERIF',9)/9)
  STORE .F. TO loFormSet.llVoidDate , loFormSet.llEnterScr
  loFormSet.ldVoidDate  = {}

  *-- If Period is locked , cannot proceed
*B609565,1 WAM 04/10/2011 Read posting date when void invoice
*IF !lfLockPerd(loFormSet) AND loFormSet.llEnterScr
IF !lfLockPerd(loFormSet)
*B609565,1 WAM 04/10/2011 (End)

    =gfObj_Lock(.F.)
    RETURN .F.
  ENDIF
  *Define 2 variable to deal with new posting date screen [End]

  llCancel     = .F.
  llIsntalment = .F.
  IF apinvhdr.ninvpaid+apinvhdr.ninvdistk+apinvhdr.ninvadj <> 0
    ** MESSAGE : " You can not void partially or fully paid  "
    **           " invoice.                                  "
    **           "                     Ok                  "
    =gfModalGen("TRM04032B00000","DIALOG")
    =gfObj_Lock(.F.)
    RETURN .F.
  ENDIF
  SELECT APINVTKT
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *SET ORDER TO TAG Lncont
  *=SEEK(PADR(loFormSet.AriaForm1.KBVendCode.KeyTextBox.Value,8)+PADR(loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value,12))
  =gfSetOrder('Lncont')
  =gfSEEK(PADR(loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE,8)+PADR(loFormSet.AriaForm1.kbInvNo.KeyTextBox.VALUE,12))
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  LOCATE REST WHILE cVendCode+cApInvNo+cApVILNo+cRSession = ;
    PADR(loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE,8)+PADR(loFormSet.AriaForm1.kbInvNo.KeyTextBox.VALUE,12)
  IF FOUND()
    *E300798,1 Message : 04178
    *E300798,1 Vendor xxx\Invoice xxx is applied againest one or more receipts. Canot void.
    *E300798,1 Button : 00000
    *E300798,1 Ok
    =gfModalGen("TRM04178B00000","DIALOG",loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE+'|'+loFormSet.AriaForm1.kbInvNo.KeyTextBox.VALUE)
    =gfObj_Lock(.F.)
    SELECT APINVHDR  &&Boho
    RETURN .F.
  ENDIF


  lcSavExact= SET('EXACT')
  SET EXACT ON

  loFormSet.lcExSin2 = ' '
  lcExSin2 = loFormSet.lcExSin2
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *loFormSet.lcExSin1 = gfGetExSin(@lcExSin2,loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value)
  loFormSet.lcExSin1 = gfGetExSin(@lcExSin2,loFormSet.AriaForm1.pgfpayInv.pgHead.kbCurrCode.KeyTextBox.VALUE)
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  loFormSet.lcExSin2 = lcExSin2
  *Open file and make necessary relation
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *llOpVHst = gfOpenFile(oAriaApplication.DataDir+'APVENHST','VENDYEAR','SH')
  llOpVHst = gfOpenTable('APVENHST','VENDYEAR','SH')
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  =CURSORSETPROP("Buffering",5,'APVENHST')
  SELECT APINVHDR
  SET RELATION OFF INTO APVENHST
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *SET RELATION TO APINVHDR.CVENDCODE + APINVHDR.CFISFYEAR INTO APVENHST ADDITIVE
  =gfSeek(apinvhdr.cvendcode,'APVENDOR')
  =gfSeek(APINVHDR.CINVNO+APINVHDR.CVENDCODE,'APDIST')
  =gfSeek(apinvhdr.cdivision,'APDIV')
  =gfSeek(APINVHDR.CVENDCODE + APINVHDR.CFISFYEAR,'APVENHST')
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]


  IF !EMPTY(apinvhdr.cvenccven)
    ** MESSAGE : " Voiding this invoice will reopen "
    **           " invoice  for vendor  .         "
    **           "      < Void >      < Cancel >    "
    lnOption = gfModalGen("TRM04033B04001","DIALOG",ALLTRIM(apinvhdr.cvenccinv)+"|"+ALLTRIM(apinvhdr.cvenccven))

    IF lnOption = 1
      IF gfFLOCK("APINVHDR,APDIST,APVENDOR,APVENHST",.T.)
        SELECT APINVHDR
        lnSavRecNo = RECNO()
        SCATTER NAME loRec
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        *IF SEEK(loRec.cvenccven+loRec.cvenccinv)
        IF gfSEEK(loRec.cvenccven+loRec.cvenccinv)
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
          lcNewPayFld  = 'NVNHPAY'+ALLTRIM(STR(INT(VAL(APINVHDR.CFSPPRDID))))
          SELECT APVENHST

          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
          *lcTemp = 'APINVHDR.NINVADJ'+loFormSet.lcExSin1+'loFormSet.AriaForm1.txtNexRate.Value'+;
          +loFormSet.lcExSin2+'loRec.ncurrunit'

          *REPLACE NVNHCCPAY    WITH NVNHCCPAY  - ROUND(&lcTemp,2)
          *    lcTemp = 'APINVHDR.NINVDISTK'+loFormSet.lcExSin1+;
          'loFormSet.AriaForm1.txtNexRate.Value'+loFormSet.lcExSin2+'loRec.ncurrunit'

          *        REPLACE NVNHDISTKN   WITH NVNHDISTKN - ROUND(&lcTemp,2)
          * lcTemp = 'APINVHDR.NINVADJ'+loFormSet.lcExSin1+'loFormSet.AriaForm1.txtNexRate.Value'+;
          +loFormSet.lcExSin2+'loRec.ncurrunit'

          *REPLACE NVNHTOTPA    WITH NVNHTOTPA  - ROUND(&lcTemp,2)
           * lcTemp = 'APINVHDR.NINVADJ'+loFormSet.lcExSin1+'loFormSet.AriaForm1.txtNexRate.Value'+;
          +loFormSet.lcExSin2+'loRec.ncurrunit'

          *REPLACE &lcNewPayFld WITH EVALUATE(lcNewPayFld) - ROUND(&lcTemp,2)
          lcTemp = 'APINVHDR.NINVADJ'+loFormSet.lcExSin1+'loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.Value'+;
            +loFormSet.lcExSin2+'loRec.ncurrunit'

          gfREPLACE("NVNHCCPAY    WITH NVNHCCPAY  - ROUND(&lcTemp,2)")
                  
          lcTemp = 'APINVHDR.NINVDISTK'+loFormSet.lcExSin1+;
            'loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.Value'+loFormSet.lcExSin2+'loRec.ncurrunit'

          gfREPLACE("NVNHDISTKN   WITH NVNHDISTKN - ROUND(&lcTemp,2)")
         
         
          lcTemp = 'APINVHDR.NINVADJ'+loFormSet.lcExSin1+'loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.Value'+;
            +loFormSet.lcExSin2+'loRec.ncurrunit'

          gfREPLACE("NVNHTOTPA    WITH NVNHTOTPA  - ROUND(&lcTemp,2)")
        
         
          lcTemp = 'APINVHDR.NINVADJ'+loFormSet.lcExSin1+'loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.Value'+;
            +loFormSet.lcExSin2+'loRec.ncurrunit'

          gfREPLACE("&lcNewPayFld WITH EVALUATE(lcNewPayFld) - ROUND(&lcTemp,2)")
         
          =gfAdd_Info('APVENHST')
         
          =gfReplace("")
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[END]
        ENDIF

        SELECT APVENDOR
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        *IF SEEK(loRec.cvenccven)
          *lcTemp = 'APINVHDR.NINVAMNT'+loFormSet.lcExSin1+'loFormSet.AriaForm1.txtNexRate.Value'+;
          +loFormSet.lcExSin2+'loRec.ncurrunit'

          *REPLACE NVENBAL  WITH NVENBAL  + ROUND(&lcTemp,2)
          *lcTemp = '(APINVHDR.NINVAMNT-APINVHDR.NINVDISOF)'+loFormSet.lcExSin1+;
          'loFormSet.AriaForm1.txtNexRate.Value'+loFormSet.lcExSin2+'loRec.ncurrunit'

          *REPLACE NVENCPAY WITH NVENCPAY - ROUND(&lcTemp,2)
          
        IF gfSEEK(loRec.cvenccven)
          
          lcTemp = 'APINVHDR.NINVAMNT'+loFormSet.lcExSin1+'loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.Value'+;
            +loFormSet.lcExSin2+'loRec.ncurrunit'

          gfREPLACE("NVENBAL  WITH NVENBAL  + ROUND(&lcTemp,2)")
         
          lcTemp = '(APINVHDR.NINVAMNT-APINVHDR.NINVDISOF)'+loFormSet.lcExSin1+;
            'loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.Value'+loFormSet.lcExSin2+'loRec.ncurrunit'

          gfREPLACE("NVENCPAY WITH NVENCPAY - ROUND(&lcTemp,2)")

          =gfAdd_Info('APVENDOR')


          =gfReplace("")
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[END]
        ENDIF

        SELECT APINVHDR
        REPLACE NINVDISTK WITH 0,;
          NINVADJ   WITH 0,;
          CVENPMETH WITH IIF(APVENDOR.CVENPMETH <> 'C',APVENDOR.CVENPMETH,'P'),;
          CVENCCINV WITH ' ',;
          CVENCCVEN WITH ' '
        =gfAdd_Info('APINVHDR')
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        =gfReplace('')
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
        GO lnSavRecNo
      ENDIF
    ELSE
      llCancel = .T.
    ENDIF
    =gfFLOCK("APINVHDR,APDIST,APVENDOR,APVENHST",.F.)
  ENDIF

  SELECT APINVAHD
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	lcSavOrder = SET('ORDER')
  *!*	SET ORDER TO TAG TVENDINV
  *!*	IF SEEK('I'+loFormSet.AriaForm1.KBVendCode.KeyTextBox.Value+loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value)
  lcSavOrder = ORDER()
  =gfSetorder('TVENDINV')
  IF gfSEEK('I'+loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE+loFormSet.AriaForm1.kbInvNo.KeyTextBox.VALUE)
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    ** MESSAGE : " This invoice has corresponding instalment "
    **           " record.  .                               "
    **           "           Procced     < Cancel >        "

    IF gfModalGen("TRM04120B00012","DIALOG",loFormSet.lcTDelCor) = 2
      llCancel = .T.
    ELSE
      =gfObj_lock(.T.)
      llIsntalment = .T.
    ENDIF
  ENDIF
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *SET ORDER TO &lcSavOrder
  gfSETORDER(lcSavOrder)
 *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  SET EXACT &lcSavExact

  SELECT APINVHDR

  IF llCancel
    ** MESSAGE : "  process is canceled "
    **           "             Ok             "
    =gfModalGen("TRM00103B00000","DIALOG",loFormSet.lcTVoid)
    =gfObj_Lock(.F.)
    =TABLEREVERT(.T.,'APINVHDR')
    =TABLEREVERT(.T.,'APVENDOR')
    =TABLEREVERT(.T.,'APVENHST')
    SELECT APINVHDR  &&Boho
    SET EXACT &lcSavExact
    RETURN .F.
  ELSE
    SELECT APINVHDR
    IF !EOF()
      GO RECNO()
    ENDIF

    IF gfFLOCK("APINVHDR,APDIST,APVENDOR,APVENHST",.T.)

      IF llIsntalment
        SELECT APINVAHD
        =gfObj_Lock(.F.)
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        *DELETE
        =gfDelete()
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[ENd]
      ENDIF


      SELECT APDIST
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *=SEEK(loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value + loFormSet.AriaForm1.KBVendCode.KeyTextBox.Value)
      =gfSEEK(loFormSet.AriaForm1.kbInvNo.KeyTextBox.VALUE + loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE)
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      SCAN REST WHILE CINVNO + CVENDCODE = loFormSet.AriaForm1.kbInvNo.KeyTextBox.VALUE + loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE;
          FOR CAPDSTAT <> 'V'
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        *REPLACE CAPDSTAT WITH 'V'
        gfREPLACE("CAPDSTAT WITH 'V'")
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
        SCATTER MEMVAR MEMO
        m.nAPDAmnt = -1 * m.nAPDAmnt
        m.cBatchNo = ' '
        m.lApdPost = .F.
        m.cTrnSleDn= ' '
        m.cAPSessNo= loFormSet.lcSequence
        m.lApdPost = .F.
        m.neqvamnt = -1 * m.neqvamnt

        IF loFormSet.llVoidDate
          m.CFISFYEAR = loFormSet.lcDistYer
          m.CFSPPRDID = loFormSet.lcDistPrd
          m.dApdTrDat = loFormSet.ldVoidDate
        ENDIF
        *if posting date is changed [End]


        m.nEntryNo = 0

        SELECT (loFormSet.lcTempSave)
        APPEND BLANK
        GATHER MEMVAR MEMO
        =gfAdd_Info(loFormSet.lcTempSave)

        SELECT APDIST

      ENDSCAN


      SELECT (loFormSet.lcTempSave)

      IF RECCOUNT() > 0
        SELECT APDIST
        APPEND FROM (oAriaApplication.WorkDir+loFormSet.lcTempSave)
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        SCAN
          SCATTER MEMO MEMVAR
          =gfReplace("")
          =gfReplace('MAPDIST with APDIST.MAPDIST')
        ENDSCAN
       *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      ENDIF

      SELECT (loFormSet.lcTempSave)
      ZAP

      lcSavExact= SET('EXACT')
      SELECT APVENDOR
      SET EXACT ON
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *IF SEEK(loFormSet.AriaForm1.KBVendCode.KeyTextBox.Value)
      *!*	          lcTemp = 'loFormSet.AriaForm1.txtInvAmount.Value'+loFormSet.lcExSin1+;
      *!*	               'loFormSet.AriaForm1.txtNexRate.Value'+loFormSet.lcExSin2+'apinvhdr.ncurrunit'
      IF gfSEEK(loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE)
        lcTemp = 'loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.Value'+loFormSet.lcExSin1+;
          'loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.Value'+loFormSet.lcExSin2+'apinvhdr.ncurrunit'
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[ENd]
        REPLACE NVENBAL   WITH NVENBAL   - ROUND(&lcTemp,2)
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        *!*	      lcTemp = 'loFormSet.AriaForm1.txtInvAmount.Value'+loFormSet.lcExSin1+;
        *!*	               'loFormSet.AriaForm1.txtNexRate.Value'+loFormSet.lcExSin2+'apinvhdr.ncurrunit'
        lcTemp = 'loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.Value'+loFormSet.lcExSin1+;
          'loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.Value'+loFormSet.lcExSin2+'apinvhdr.ncurrunit'
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[ENd]
        REPLACE NVENCPUR  WITH NVENCPUR  - ROUND(&lcTemp,2)
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        *!*	      lcTemp = 'MIN(loFormSet.AriaForm1.txtInvAmount.Value,0)'+loFormSet.lcExSin1+;
        *!*	               'loFormSet.AriaForm1.txtNexRate.Value'+loFormSet.lcExSin2+'apinvhdr.ncurrunit'
        lcTemp = 'MIN(loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.Value,0)'+loFormSet.lcExSin1+;
          'loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.Value'+loFormSet.lcExSin2+'apinvhdr.ncurrunit'
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[ENd]
        REPLACE NVENOPNDR WITH NVENOPNDR + ROUND(&lcTemp,2)
        =gfAdd_Info('APVENDOR')
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        =gfReplace("")
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

        SELECT APVENHST

        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        *      IF SEEK(loFormSet.AriaForm1.KBVendCode.KeyTextBox.Value+apinvhdr.cfisfyear)
        IF gfSEEK(loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE+apinvhdr.cfisfyear)
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

          lcNewPerFld  = 'NVNHPUR'+ALLTRIM(STR(INT(VAL(apinvhdr.cfspprdid))))
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
          *!*	        REPLACE NVNHDISOF    WITH NVNHDISOF - ROUND(loFormSet.AriaForm1.txtInvDisof.Value * loFormSet.AriaForm1.txtNexRate.Value/apinvhdr.ncurrunit,2),;
          *!*	                NVNHPURCH    WITH NVNHPURCH - ROUND(loFormSet.AriaForm1.txtInvAmount.Value * loFormSet.AriaForm1.txtNexRate.Value/apinvhdr.ncurrunit,2),;
          *!*	                &lcNewPerFld WITH EVALUATE(lcNewPerFld) - ROUND(loFormSet.AriaForm1.txtInvAmount.Value * loFormSet.AriaForm1.txtNexRate.Value/apinvhdr.ncurrunit,2)
          *   lcTemp = 'loFormSet.AriaForm1.txtInvDisof.Value'+loFormSet.lcExSin1+;
          'loFormSet.AriaForm1.txtNexRate.Value'+loFormSet.lcExSin2+'apinvhdr.ncurrunit'
          REPLACE NVNHDISOF    WITH NVNHDISOF - ROUND(loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvDisof.VALUE * loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.VALUE/apinvhdr.ncurrunit,2),;
            NVNHPURCH    WITH NVNHPURCH - ROUND(loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.VALUE * loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.VALUE/apinvhdr.ncurrunit,2),;
            &lcNewPerFld WITH EVALUATE(lcNewPerFld) - ROUND(loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.VALUE * loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.VALUE/apinvhdr.ncurrunit,2)
          
          
          lcTemp = 'loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvDisof.Value'+loFormSet.lcExSin1+;
            'loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.Value'+loFormSet.lcExSin2+'apinvhdr.ncurrunit'
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
          
          REPLACE NVNHDISOF    WITH NVNHDISOF - ROUND(&lcTemp,2)
          
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
          *!*	        lcTemp = 'loFormSet.AriaForm1.txtInvAmount.Value'+loFormSet.lcExSin1+;
          *!*	                 'loFormSet.AriaForm1.txtNexRate.Value'+loFormSet.lcExSin2+'apinvhdr.ncurrunit'
          lcTemp = 'loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.Value'+loFormSet.lcExSin1+;
            'loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.Value'+loFormSet.lcExSin2+'apinvhdr.ncurrunit'
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
          
          REPLACE NVNHPURCH    WITH NVNHPURCH - ROUND(&lcTemp,2)
          
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
          *!*	        REPLACE &lcNewPerFld WITH EVALUATE(lcNewPerFld) - ROUND(loFormSet.AriaForm1.txtInvAmount.Value * loFormSet.AriaForm1.txtNexRate.Value/apinvhdr.ncurrunit,2)
          REPLACE &lcNewPerFld WITH EVALUATE(lcNewPerFld) - ROUND(loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.VALUE * loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.VALUE/apinvhdr.ncurrunit,2)
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
          
          =gfAdd_Info('APVENHST')
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
          =gfReplace("")
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
        ENDIF
      ENDIF

      SELECT APINVHDR
      REPLACE CINVSTAT  WITH 'V',;
        LLOK_STAT WITH .F.,;
        CLOK_USER WITH ' ',;
        DLOK_DATE WITH {} ,;
        CLOK_TIME WITH ' '
      

      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *!*	    =TABLEUPDATE(.T.,.T.,'APINVHDR')
      *!*	    =TABLEUPDATE(.T.,.T.,'APVENDOR')
      *!*	    =TABLEUPDATE(.T.,.T.,'APVENHST')
      *!*	    =TABLEUPDATE(.T.,.T.,'APDIST')
      *!*	    =TABLEUPDATE(.T.,.T.,'APINVAHD')
      =gfReplace("")
      SELECT APINVHDR
      =gfTABLEUPDATE()
      SELECT APVENDOR
      =gfTABLEUPDATE()
      SELECT APVENHST
      =gfTABLEUPDATE()
      SELECT APDIST
      =gfTABLEUPDATE()
      SELECT APINVAHD
      =gfTABLEUPDATE()
	  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      
      ** Change the screen mode to the Select mode.
      loFormSet.ChangeMode("S")
    ENDIF
    =gfFLOCK("APINVHDR,APDIST,APVENDOR,APVENHST",.F.)
  ENDIF

  *Old: IF WVISIBLE('CWRAPDISTR')
  *Old: =gfChClose('CWRAPDISTR')
  *Old: ENDIF
  *E301077,71 AMM Close file
  IF USED('APVENHST') .AND. llOpVHst
    *Old: =gfCloseFile('APVENHST')
    *USE IN APVENHST
  ENDIF
  *E301077,71 AMM end

  SELECT APINVHDR
  SET EXACT &lcSavExact
  =gfObj_Lock(.F.)

  RETURN
  *-- End of lfFormDelete

  *!*************************************************************
  *! Name      : lfvldApAct
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 8/16/2004
  *! Purpose   : To check if there is inactive account
  *!*************************************************************
  *! Parameters: The FormSet
  *!*************************************************************
  *! Returns   : None
  *!*************************************************************
FUNCTION lfvldApAct
  LPARAMETERS loFormSet

  PRIVATE lnRetVal

  lnRetVal = .T.

  SELECT ('lcLinkChar')
  SET ORDER TO TAG ACCTCODE

  SELECT (loFormSet.lcTmpDist)
  SCAN
    lcApdGlAct = cApdGlAct
    SELECT ('lcLinkChar')
    IF SEEK(lcApdGlAct,'lcLinkChar') AND cSegActiv = "I"
      lnRetVal = .F.
      EXIT
    ENDIF

  ENDSCAN

  IF !lnRetVal
    =gfModalGen("TRM04203B00000","DIALOG")
  ENDIF

  RETURN lnRetVal
  *-- End of lfvldApAct


  *!*************************************************************
  *! Name      : lfChckVoid
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 8/16/2004
  *! Purpose   : To Check the balancing in (lcTmpDist) file before saving
  *!*************************************************************
  *! Parameters: The FormSet
  *!*************************************************************
  *! Returns   : llSave
  *!*************************************************************
FUNCTION lfChckVoid
  LPARAMETERS loFormSet

  PRIVATE lnTotAmnt , ll2Return , lcOldExt , lnEqvAmnt
  STORE 0 TO lnTotAmnt , lnEqvAmnt

  lnOldAls = SELECT(0)
  lcOldExt = SET("EXACT")
  SET EXACT OFF
  SELECT (loFormSet.lcTmpDist)
  GO TOP
  ll2Return = !EOF()
  IF ll2Return
    *B608685,1 WAM 09/10/2008 Compute equivalent cost when checking balance of APDIST while saving the invoice
    *SUM ALL napdamnt , neqvamnt TO lnTotAmnt , lnEqvAmnt ;
    FOR cVendCode+cInvNo+STR(nApDLinNo,4) = PADR(loFormSet.AriaForm1.KBVendCode.KeyTextBox.Value,8) + PADR(loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value,12);
    .AND. CAPDSTAT <> 'V'
    lcExSin1= loFormSet.lcExSin1
    lcExSin2= loFormSet.lcExSin2
    SUM ALL napdamnt , (napdamnt &lcExSin1 nExRate &lcExSin2 nCurrUnit) TO lnTotAmnt , lnEqvAmnt ;
      FOR cVendCode+cInvNo+STR(nApDLinNo,4) = PADR(loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE,8) + PADR(loFormSet.AriaForm1.kbInvNo.KeyTextBox.VALUE,12);
      .AND. CAPDSTAT <> 'V'
    *B608685,1 WAM 09/10/2008 (End)

    ll2Return =   (lnTotAmnt = 0) .AND. (lnEqvAmnt =0)
  ENDIF
  SELECT (lnOldAls)
  SET EXACT &lcOldExt

  RETURN ll2Return
  *-- End of lfChckVoid


*!*************************************************************
*! Name      : lfLockPerd
*! Developer : Ahmad Shoukry Mohammed (ASM)
*! Date      : 8/16/2004
*! Purpose   : To Check if period is locked or not
*!*************************************************************
*! Parameters: The FormSet
*!*************************************************************
*! Returns   : True if period is locked Or False if period is not
*!*************************************************************
FUNCTION lfLockPerd
LPARAMETERS loFormSet

*Check posting date if it is in Closed period before Voiding the invoice [Begin]
*B609565,1 WAM 04/10/2011 Read posting date when void invoice in all cases

*!*	lcDistPrd = loFormSet.lcDistPrd
*!*	lcDistYer = loFormSet.lcDistYer
*!*	llLokPer = loFormSet.llLokPer
*!*	=lfVlDate(oAriaApplication.PrntCompanyID , @lcDistPrd , @lcDistYer , loFormSet.AriaForm1.DtPostDate.Value , @llLokPer)
*!*	loFormSet.lcDistPrd = lcDistPrd
*!*	loFormSet.lcDistYer = lcDistYer
*!*	loFormSet.llLokPer = llLokPer
*!*	  
*!*	*-- Check to see if this period and year is locked 
*!*	IF loFormSet.llLokPer
*!*	  *Message : " The posting date falls within a locked period.  "
*!*	  *          " You cannot change invoice status to Void, "
*!*	  *          " unless you enter a voiding date "
*!*	  *          " that falls within an open period. "    
*!*	  *Buttons : "                    <    Ok    >                "
*!*	  =gfModalGen("INM04163B00000" , "DIALOG" , 'invoice status to Void, unless you ' + ;
*!*	                                            'enter a voiding date that falls ' +;
*!*	                                            'within an open period')
*B609565,1 WAM 04/10/2011 (End)

  loFormSet.ldVoidDate = oAriaApplication.SystemDate  &&lower
  *DO (oAriaApplication.ScreenHome + oAriaApplication.ActiveModuleID + '\APVoidDt.SPX')
  DO FORM (oAriaApplication.ScreenHome+"\AP\APVoidDt.SCX") WITH loFormSet.AriaForm1

*B609565,1 WAM 04/10/2011 Read posting date when void invoice
*!*	  loFormSet.llEnterScr = .T.     && Raise flag to ensure that screen was entered
*!*	ENDIF
*B609565,1 WAM 04/10/2011 (End)

RETURN loFormSet.llVoidDate
*-- End of lfLockPerd


  *!***************************************************************************
  *! Name      : lfvOKDate
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 8/22/2004
  *! Purpose   : Valid for OK Command button of the APVoidDt Screen
  *!*************************************************************
  *! Parameters: The FormSet, The Calling Form
  *!***************************************************************************
  *! Returns   : True or False
  *!***************************************************************************
FUNCTION lfvOKDate
  LPARAMETERS loFormSet, loForm

  LOCAL lcDistPrd, lcDistYer, llLokPer
  *-- If date is Empty
  IF EMPTY(loFormSet.ldVoidDate)
    *Message : " You have to select a date. "
    *Buttons : "         <    Ok    >       "
    = gfModalGen('INM44078B00000','Dialog')
    loFormSet.ldVoidDate = oAriaApplication.SystemDate  &&lower
    loForm.dtVoidDate.SETFOCUS()
    RETURN .F.
  ENDIF

  *B129328,1 WSH 08/15/2005 Update the llLokPer property only if the lfVlDate function returned True. [Start]
  *loFormSet.llLokPer = .F.
  *B129328,1 WSH 08/15/2005 [End]

  lcDistPrd = loFormSet.lcDistPrd
  lcDistYer = loFormSet.lcDistYer
  llLokPer = loFormSet.llLokPer
  IF !lfVlDate(oAriaApplication.PrntCompanyID, @lcDistPrd, @lcDistYer , loFormSet.ldVoidDate , @llLokPer)

    *B129328,1 WSH 08/15/2005 Update the void dates properties only if the lfVlDate function returned True. [Start]
    *loFormSet.lcDistPrd = lcDistPrd
    *loFormSet.lcDistYer = lcDistYer
    *loFormSet.llLokPer = llLokPer
    *B129328,1 WSH 08/15/2005 [End]

    *Message : " The voiding date should be within the posting window. "
    *Buttons : "                      <    Ok    >                     "
    =gfModalGen('TRM04113B00000', 'DIALOG', "voiding ")
    loFormSet.ldVoidDate = oAriaApplication.SystemDate  &&lower
    loForm.dtVoidDate.SETFOCUS()
    RETURN .F.
  ENDIF

  *B129328,1 WSH 08/15/2005 Update the void dates properties only if the lfVlDate function returned True. [Start]
  loFormSet.lcDistPrd = lcDistPrd
  loFormSet.lcDistYer = lcDistYer
  loFormSet.llLokPer  = llLokPer
  *B129328,1 WSH 08/15/2005 [End]

  *-- if Period and Year is found in Fiscal period file
  IF loFormSet.llLokPer
    *Message : " This date falls in a locked period."
    *Buttons : "            <    Ok    >            "
    = gfModalGen('TRM01258B00000','Dialog')
    loFormSet.ldVoidDate = oAriaApplication.SystemDate
    loForm.dtVoidDate.SETFOCUS()
    RETURN .F.
  ELSE
    *-- If either Invoice date or Posting date is greater than the new Date entered
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *!*	  IF loFormSet.AriaForm1.DtInvDate.Value > loFormSet.ldVoidDate OR ;
    *!*	    loFormSet.AriaForm1.DtPostDate.Value > loFormSet.ldVoidDate
    IF loFormSet.AriaForm1.pgfpayInv.pgHead.DtInvDate.VALUE > loFormSet.ldVoidDate OR ;
        loFormSet.AriaForm1.DtPostDate.VALUE > loFormSet.ldVoidDate
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      *Message : " The voiding date cannot precede invoice date or posting date."
      *Buttons : "                   <    Ok    >                   "
      =gfModalGen("TRM04028B00000","DIALOG",'The voiding |invoice date or posting ')
      loFormSet.ldVoidDate = oAriaApplication.SystemDate  &&lower
      loForm.dtVoidDate.SETFOCUS()
      RETURN .F.
    ELSE    && invoice date and posting date is less than new date and also period is not locked and date is not empty
      loFormSet.llVoidDate = .T.     && new posting date is approved
      *CLEAR READ
    ENDIF
  ENDIF

  RETURN .T.
  *-- End of lfvOKDate

  ***SS2

  *!*************************************************************
  *! Name      : lfChckACst
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 8/16/2004
  *! Purpose   : To calculate the actual cost and check
  *!             that none of the actual cost will have a negative amount
  *!*************************************************************
  *! Parameters: The FormSet
  *!*************************************************************
  *! Returns            : .T. If none of the actual cost will have
  *!                          a negative amount.
  *!                      .F. Otherwise.
  *!*************************************************************
FUNCTION lfChckACst
  LPARAMETERS loFormSet

  PRIVATE llReturn  , lcExStatus , lcFullStat , lcCDXFile , lcMssgText ,;
    lcHdrFile , lcHActFild , lcHFActFld , lcHKeyVal , lnActCstNo ,;
    lcDetFile , lcDActFild , lcDFActFld , lcDKey    , lcDForCond ,;
    lcDKeyVal , lcDQtyFild , m.cIMTyp   , lcBomType , lnAmntChng ,;
    lnCount   , lcCount

  llReturn = .T.

  STORE '' TO lcExStatus , lcFullStat , lcCDXFile , lcMssgText

  lcFullStat = SET('FULLPATH')
  SET FULLPATH ON

  *-- Create a temp. file to hold the calculated actual cost for PO and CT
  *-- header files.

  *B608412,1 WAM 01/20/2008 Include cost 6 & 7 while add invoice lines
  *CREATE CURSOR (loFormSet.lcActCstHd) ;
  (cIMTyp C(1)        , cTktNo C(6)        , Rec_No C(36)    ,;
  nActCost1 N(13,3)  , nActCost2 N(13,3)  , nActCost3 N(13,3) ,;
  nActCost4 N(13,3)  , nActCost5 N(13,3)  ,;
  nFActCost1 N(13,3) , nFActCost2 N(13,3) , nFActCost3 N(13,3) ,;
  nFActCost4 N(13,3) , nFActCost5 N(13,3)) &&Sql1: nRecNo should be C(36)
  CREATE CURSOR (loFormSet.lcActCstHd) ;
    (cIMTyp C(1)        , cTktNo C(6)        , Rec_No C(36)    ,;
    nActCost1 N(13,3)  , nActCost2 N(13,3)  , nActCost3 N(13,3) ,;
    nActCost4 N(13,3)  , nActCost5 N(13,3)  , nActCost6 N(13,3) , nActCost7 N(13,3) ,;
    nFActCost1 N(13,3) , nFActCost2 N(13,3) , nFActCost3 N(13,3) ,;
    nFActCost4 N(13,3) , nFActCost5 N(13,3) , nFActCost6 N(13,3) , nFActCost7 N(13,3)) &&Sql1: nRecNo should be C(36)
  *B608412,1 WAM 01/20/2008 (End)

  ZAP
  lcCDXFile = STRTRAN(DBF() , '.TMP' , '.CDX')
*B609356,1 SMA 07/22/2010 remove of clause to prevent empty *.cdx files from creation.....[BEGIN]
*INDEX ON cIMTyp + cTktNo TAG (loFormSet.lcActCstHd) OF (lcCDXFile)
INDEX ON cIMTyp + cTktNo TAG (loFormSet.lcActCstHd) 
*B609356,1 SMA 07/22/2010 remove of clause to prevent empty *.cdx files from creation.....[END]

  *B608412,1 WAM 01/20/2008 Include cost 6 & 7 while add invoice lines
  *CREATE CURSOR (loFormSet.lcActCstDt) ;
  (cIMTyp C(1)        , cTktNo C(6)        , Rec_No C(36)    ,;
  cRSession C(6)     , cShipNo C(6)       , cItem C(19),  cColor C(6) ,;
  cLineNo C(6)       , nTotQty N(10,3)    ,;
  nActCost1 N(13,6)  , nActCost2 N(13,6)  , nActCost3 N(13,6) ,;
  nActCost4 N(13,6)  , nActCost5 N(13,6)  ,;
  nFActCost1 N(13,6) , nFActCost2 N(13,6) , nFActCost3 N(13,6) ,;
  nFActCost4 N(13,6) , nFActCost5 N(13,6)) &&Sql2: nRecNo should be C(36) and check cColor
  CREATE CURSOR (loFormSet.lcActCstDt) ;
    (cIMTyp C(1)        , cTktNo C(6)        , Rec_No C(36)    ,;
    cRSession C(6)     , cShipNo C(6)       , cItem C(19),  cColor C(6) ,;
    cLineNo C(6)       , nTotQty N(10,3)    ,;
    nActCost1 N(13,6)  , nActCost2 N(13,6)  , nActCost3 N(13,6) ,;
    nActCost4 N(13,6)  , nActCost5 N(13,6)  , nActCost6 N(13,6), nActCost7 N(13,6),;
    nFActCost1 N(13,6) , nFActCost2 N(13,6) , nFActCost3 N(13,6) ,;
    nFActCost4 N(13,6) , nFActCost5 N(13,6) , nFActCost6 N(13,6) , nFActCost7 N(13,6)) &&Sql2: nRecNo should be C(36) and check cColor
  *B608412,1 WAM 01/20/2008 (End)

  ZAP
  lcCDXFile = STRTRAN(DBF() , '.TMP' , '.CDX')
*B609356,1 SMA 07/22/2010 remove of clause to prevent empty *.cdx files from creation.....[BEGIN]
*INDEX ON cIMTyp + cRSession + cShipNo + cTKtNo + cItem + cColor + cLineNo ;
         TAG (loFormSet.lcActCstDt) OF (lcCDXFile) &&Sql3: Check cColor field
  INDEX ON cIMTyp + cRSession + cShipNo + cTKtNo + cItem + cColor + cLineNo ;
         TAG (loFormSet.lcActCstDt)  &&Sql3: Check cColor field
*B609356,1 SMA 07/22/2010 remove of clause to prevent empty *.cdx files from creation.....[END]
  SET FULLPATH &lcFullStat

  lcExStatus = SET('EXACT')
  SET EXACT OFF

  *-- Set the needed order tags
  IF ('I' $ loFormSet.lcVenInvTypes OR 'R' $ loFormSet.lcVenInvTypes) AND USED("POSHDR")
    *Old: SET ORDER TO TAG POSHDR IN POSHDR
    loFormSet.POSHDR.SetOrder('POSHDR') &&Sql4: Check Tag CBUSDOCU+CSTYTYPE+PO (CSTYTYPE+PO)
    *Old: SET ORDER TO TAG POSREC IN POSLN
    loFormSet.POSLN.SetOrder('POSREC') &&Sql5: Check Tag ;
    *CBUSDOCU+CSTYTYPE+PO+CRSESSION+SHIPNO+CINVTYPE+STYLE+STR(LINENO,6)+TRANCD+CSTYGRADE ;
    (CSTYTYPE+PO+CRSESSION+SHIPNO+STYLE+STR(LINENO,6)+TRANCD)
  ENDIF
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	IF 'MF' $ oAriaApplication.CompanyInstalledModules AND ;
  *!*	   loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value = oAriaApplication.BaseCurrency AND ;
  *!*	   'M' $ loFormSet.lcVenInvTypes
  IF 'MF' $ oAriaApplication.CompanyInstalledModules AND ;
      loFormSet.AriaForm1.pgfpayInv.pgHead.kbCurrCode.KeyTextBox.VALUE = oAriaApplication.BaseCurrency AND ;
      'M' $ loFormSet.lcVenInvTypes
 *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    *Old: SET ORDER TO TAG CUTTKTH IN CUTTKTH
    loFormSet.CUTTKTH.SetOrder('POSHDR') &&Sql6: Check Tag CBUSDOCU+CSTYTYPE+PO (CUTTKT)
    *Old: SET ORDER TO TAG CUTREC  IN CUTTKTL
    loFormSet.CUTTKTL.SetOrder('POSREC') &&Sql7: Check Tag (CRSESSION+CUTTKT+STYLE+TRANCD)
  ENDIF

  IF ('L' $ loFormSet.lcVenInvTypes OR 'F' $ loFormSet.lcVenInvTypes) AND USED("POFHDR")
    *Old: SET ORDER TO TAG POFHDR IN POFHDR
    loFormSet.POFHDR.SetOrder('POSHDR') &&Sql8: Check Tag CBUSDOCU+CSTYTYPE+PO (CMATTYPE+POMAT)
    *Old: SET ORDER TO TAG POFREC IN POFLN
    loFormSet.POFLN.SetOrder('POSREC') &&Sql9: Check Tag (CMATTYPE+POMAT+CRSESSION+FABRIC+COLOR+TRANCD)
  ENDIF

  *-- Recall the deleted records
  SELECT (loFormSet.lcAPInvTkt)
  RECALL ALL

  *-- Recall the deleted records and set the needed order tag
  SELECT (loFormSet.lcApVInvDt)
  RECALL ALL

  *Fix bug when Saving the debit memo againest Return PO [BEGIN]
  SELECT (loFormSet.lcAPInvTkt)
  REPLACE ALL nAPAplAmnt WITH nAPAplAmnt * -1,;
    nAPAplPric WITH nAPAplPric * -1 FOR (cIMTyp $ 'RF' AND (nAPAplAmnt < 0 ))

  SELECT (loFormSet.lcApVInvDt)
  REPLACE ALL nApAprAmnt WITH nApAprAmnt * -1,;
    nApAprPric WITH nApAprPric * -1,;
    nApPrice   WITH nApPrice   * -1,;
    nApAmnt    WITH nApAmnt    * -1 FOR (cIMTyp $ 'RF' AND (nApAprAmnt < 0 ))
  *Fix bug when Saving the debit memo againest Return PO [END]
  SET ORDER TO TAG ITEM
  GO TOP

  *-- Do while there is no troubles in the records locking and the end of file
  *-- has not been reached yet.
  DO WHILE llReturn .AND. !EOF()

    *-- lcHdrFile   Variable to hold the name of the header file for the
    *--             current document type.
    *-- lcHActFild  Variable to hold the name of the actual cost field in the
    *--             header file for the current document type.
    *-- lcHFActFld  Variable to hold the name of the actual cost in foreign
    *--             currency field in the header file for the current
    *--             document type.
    *-- lcHKeyVal   Variable to hold the key value to be used while searching
    *--             for the record that will be updated in the header file.
    *-- lcDetFile   Variable to hold the name of the detail file for the
    *--             current document type.
    *-- lcDActFild  Variable to hold the name of the actual cost field in the
    *--             detail file for the current document type.
    *-- lcDFActFld  Variable to hold the name of the actual cost in foreign
    *--             currency field in the detail file for the current
    *--             document type.
    *-- lcDKey      Variable to hold the expression that will be used to get
    *--             the key value that will be used for searching for the
    *--             record that will be updated in the detail file.
    *-- lcDForCond  Variable to hold a string of the expression that will be
    *--             used as the FOR expression while searching for the record
    *--             that will be updated in the detail file.
    *-- lcDQtyFild  Variable to hold the name of the total quantity field in
    *--             the detail file for the current document type.

    STORE '' TO lcHdrFile  , lcHActFild , lcHFActFld , lcHKeyVal  ,;
      lcDetFile  , lcDActFild , lcDFActFld , lcDKey     ,;
      lcDForCond , lcDQtyFild


    *-- lnActCstNo  Variable to hold the number of actual cost fields for the
    *--             current document type.

    STORE 0  TO lnActCstNo

    DO CASE
        *-- Case of document type "General Expense"
      CASE cIMTyp = 'G'
        SEEK 'H'
        IF RECNO(0) <> 0
          GO RECNO(0)
        ENDIF
        LOOP

        *-- Case of document types "Style Purchase Order", "Style Purchase
        *-- Order Return" and "Shipment"
      CASE INLIST(cIMTyp , 'I' , 'R' , 'S')


        lcHdrFile  = 'POSHDR'
        lcHActFild = 'nAct_Cost'
        lcHFActFld = 'nFActCost'
        lcHKeyVal  = IIF(cIMTyp = 'R' , 'RP' , 'PP') &&Sql10: Check Key


        *B608412,1 WAM 01/20/2008 Include cost 6 & 7 while add invoice lines
        *lnActCstNo  = 5
        lnActCstNo  = 7
        *B608412,1 WAM 01/20/2008 (End)

        lcDetFile  = 'POSLN'
        lcDActFild = 'nAct_Cost'
        lcDFActFld = 'nFactCost'

        *(Begin) Assigning the appropriate values
        *and setting the correct index in case
        *of shipment.
        IF cIMTyp <> 'S'
          *CBUSDOCU+CSTYTYPE+PO+CRSESSION+SHIPNO+CINVTYPE+STYLE+STR(LINENO,6)+TRANCD+CSTYGRADE
          lcDKey     = "IIF(m.cIMTyp = 'R' , 'RP' , 'PP') + cTKtNo + cRSession" &&Sql11: Check Key
        ELSE
          *Old: SET ORDER TO TAG POSHREC IN POSLN
          loFormSet.POSLN.SetOrder('POSHREC')  &&Sql12: Check Tag ;
          *SHIPNO+CRSESSION+CBUSDOCU+CSTYTYPE+PO+CINVTYPE+STYLE+STR(LINENO,6)+TRANCD ;
          (SHIPNO+CRSESSION+CSTYTYPE+PO+STYLE+STR(LINENO,6)+TRANCD)
          lcDKey = "EVALUATE(loFormSet.lcApVInvDt+'.ShipNo') + cRSession + 'PP'" &&Sql13: Check Key
        ENDIF

        IF cIMTyp <> 'S'
          lcDForCond = "cInvType='0001' AND Style = EVALUATE(loFormSet.lcAPInvTkt+'.Item') AND "+;
            "STR(LineNo , 6) = STR(EVALUATE(loFormSet.lcAPInvTkt+'.LineNo') , 6)"
        ELSE
          lcDForCond = "PO = cTKtNo AND cInvType='0001' AND Style = EVALUATE(loFormSet.lcAPInvTkt+'.Item') AND "+;
            "STR(LineNo , 6) = STR(EVALUATE(loFormSet.lcAPInvTkt+'.LineNo') , 6)"
        ENDIF

        lcDQtyFild = 'TotQty'

        *-- Case of document type "Cutting Ticket"
      CASE cIMTyp = 'M'
        lcHdrFile  = 'CUTTKTH'
        lcHActFild = 'nAct_Cost'
        lcHKeyVal  = 'PU' &&Sql14: Check Key
        *B608412,1 WAM 01/20/2008 Include cost 6 & 7 while add invoice lines
        *lnActCstNo = 5
        lnActCstNo = 7
        *B608412,1 WAM 01/20/2008 (End)

        lcDetFile  = 'CUTTKTL'
        lcDActFild = 'nAct_Cost'
        *CBUSDOCU+CSTYTYPE+PO+CRSESSION+SHIPNO+CINVTYPE+STYLE+STR(LINENO,6)+TRANCD+CSTYGRADE
        lcDKey     = "'PU' + cTKtNo + cRSession" &&Sql15: Check Key
        lcDForCond = "cInvType='0001' AND Style = EVALUATE(loFormSet.lcAPInvTkt+'.Item') AND "+;
          "STR(LineNo , 6) = STR(EVALUATE(loFormSet.lcAPInvTkt+'.LineNo') , 6)"
        lcDQtyFild = 'TotQty'

        *-- Case of document types "Material PO" and "Material PO Return"
      CASE INLIST(cIMTyp , 'L' , 'F')
        lcHdrFile  = 'POFHDR'
        lcHActFild = 'nAct_Cost'
        lcHFActFld = 'nFActCost'
        lcHKeyVal  = IIF(cIMTyp = 'L' , 'PM' , 'RM') &&Sql16: Check Key
        lnActCstNo = 5
        lcDetFile  = 'POFLN'
        lcDActFild = 'nAct_Cost'
        lcDFActFld = 'nFactCost'
        *CBUSDOCU+CSTYTYPE+PO+CRSESSION+SHIPNO+CINVTYPE+STYLE+STR(LINENO,6)+TRANCD+CSTYGRADE
        lcDKey     = "IIF(cIMTyp = 'L' , 'PM' , 'RM') + cTKtNo + cRSession" &&Sql17: Check Key
        lcDForCond = "cInvType='0002' AND Style = lfupditem(EVALUATE(loFormSet.lcAPInvTkt+'.Item'),EVALUATE(loFormSet.lcAPInvTkt+'.Color')) AND "+;
          "STR(LineNo , 6) = STR(EVALUATE(loFormSet.lcAPInvTkt+'.LineNo') , 6)"
        lcDQtyFild = 'TotQty'

        *Fix the contribution process  to save the invoice [Begin]
      CASE INLIST(cIMTyp , 'T')
        lcAlias = ALIAS()
        lcHdrFile  = 'MMFGORDH'
        lcHActFild = 'nAct_Cost'
        lcHKeyVal  = 'PF' &&Sql18: Check Key
        lnActCstNo = 5
        lcDetFile  = 'MMFGORDD'
        lcDActFild = 'nAct_Cost'
        *CBUSDOCU+CSTYTYPE+PO+CRSESSION+SHIPNO+CINVTYPE+STYLE+STR(LINENO,6)+TRANCD+CSTYGRADE
        lcDKey     = "'PF' + cTKtNo + cRSession"
        lcDForCond = "cInvType='0002' AND Style = lfupditem(EVALUATE(loFormSet.lcAPInvTkt+'.Item'),EVALUATE(loFormSet.lcAPInvTkt+'.Color')) AND "+;
          "STR(LineNo , 6) = STR(EVALUATE(loFormSet.lcAPInvTkt+'.LineNo') , 6)"
        lcDQtyFild = 'TotQty'
        *Old: lcDKey     = "cRSession + cTKtNo + SUBSTR(ITEM , 1 , 7) + Color"
        *Old: lcDForCond = ".T."
        *Old: SELECT (lcDetFile)
        *Old: SET ORDER TO TAG Mfgrec
        *!* loFormSet.MMFGORDD.SetOrder('Mfgrec') &&Sql20: Check Tag (CRSESSION+CMFGORDNO+CFABRIC+COLOR+TRANCD)
        SELECT (lcAlias)
        *Fix the contribution process  to save the invoice [End]
        *Add Adorment order to invoice line [Begin]
      CASE INLIST(cIMTyp , 'A' )
        lcHdrFile  = 'POSHDR'
        lcHActFild = 'nAct_Cost'
        lcHFActFld = 'nFActCost'
        lcHKeyVal  = 'PA' &&Sql21: Check Key
        lnActCstNo  = 5
        lcDetFile  = 'POSLN'
        lcDActFild = 'nAct_Cost'
        lcDFActFld = 'nFactCost'
        *CBUSDOCU+CSTYTYPE+PO+CRSESSION+SHIPNO+CINVTYPE+STYLE+STR(LINENO,6)+TRANCD+CSTYGRADE
        lcDKey     = "'PA' + cTKtNo + cRSession" +;
          "EVALUATE(loFormSet.lcApVInvDt+'.ShipNo') + '0001' + EVALUATE(loFormSet.lcAPInvTkt+'.Item') "+;
          "STR(EVALUATE(loFormSet.lcAPInvTkt+'.LineNo') , 6)" &&Sql22: Check Key
        lcDForCond = ".T."
        lcDQtyFild = 'TotQty'

      CASE INLIST(cIMTyp , 'D' )
        lcHdrFile  = 'POSHDR'
        lcHActFild = 'nAct_Cost'
        lcHFActFld = 'nFActCost'
        lcHKeyVal  = 'PD' &&Sql23: Check Key
        lnActCstNo  = 5
        lcDetFile  = 'POSLN'
        lcDActFild = 'nAct_Cost'
        lcDFActFld = 'nFactCost'
        *CBUSDOCU+CSTYTYPE+PO+CRSESSION+SHIPNO+CINVTYPE+STYLE+STR(LINENO,6)+TRANCD+CSTYGRADE
        lcDKey     = "'PD' + cTKtNo + cRSession + " +;
          "EVALUATE(loFormSet.lcApVInvDt+'.ShipNo') + '0001' + EVALUATE(loFormSet.lcAPInvTkt+'.Item') "+;
          "STR(EVALUATE(loFormSet.lcAPInvTkt+'.LineNo') , 6)" &&Sql24: Check Key
        lcDForCond = ".T."
        lcDQtyFild = 'TotQty'

    ENDCASE

    m.cIMTyp = cIMTyp

    *-- Scan while there no troubles in the records locking and the document
    *-- type didn't change for the records with status <> same
    *-- Note: The seek() function in the for condition is not used as a
    *--       condition it's used to replace the record pointer on the first
    *--       corresponding record in the file (lcAPInvTkt).
    SCAN WHILE llReturn .AND. cIMTyp = m.cIMTyp;
        FOR cStatus <> 'S' .AND.;
        SEEK(cVendCode + cApInvNo + cAPVILNo , loFormSet.lcAPInvTkt)

      *-- Flag to know if the record has been deleted
      llDeleted = (cStatus='D') OR ((nRecNo = 0) AND (cStatus= 'S'))
      *-- Variable to hold the record number of the corresponding record in
      *-- the master file
      lnRecNo   = nRecNo

      *-- Replace the record pointer on the corresponding record in the
      *-- master file.
      IF BETWEEN( lnRecNo ,1, RECCOUNT('APVINVDT'))
        GO lnRecNo IN APVINVDT
      ENDIF

      lcBomType  = cBomType

      *-- Get the change that has been made to the applied amount for this
      *-- record
      lnAmntChng = IIF(llDeleted   , 0 , nApAprAmnt) -;
        IIF(lnRecNo = 0 , 0 , APVINVDT.nApAprAmnt)

      *(Begin) Adding the IF command to check if
      *invoicing by shimpment the do lfUpdPoHAc()
      *that will update the PosHdr actual cost
      IF cIMTyp = "S"
        *-- This function is used to update the actual cost for the poshdr
        *-- file in case of invoicing by shimpment.
        =lfUpdPoHAC(loFormSet)
      ELSE

        *-- If there is a header file that should be updated for the current
        *-- document type.
        IF !EMPTY(lcHdrFile)

          *-- If there is no records for this document number in the actual
          *-- cost temp. header file
          IF !SEEK(m.cIMTyp + cTktNo , loFormSet.lcActCstHd)
            m.cTktNo = cTktNo

            *-- Go to the record that will be updated in the header file
            SELECT (lcHdrFile)
            *(Begin) Changing the seek command to be
            *IF seek in order to don't try to lock the
            *record or update the actual cost in the
            * header file in case of not seek in the
            *header file

            *SEEK lcHKeyVal + m.cTktNo
            *Old: IF SEEK (lcHKeyVal + m.cTktNo)
            IF loFormSet.&lcHdrFile..SEEK (lcHKeyVal + m.cTktNo)  &&Sql27: Check Key

              *-- Attempt to lock the record
              IF .T. && gfObj_Lock(.T.) is not needed
                m.Rec_No = REC_NO &&Sql28: Check RowId

                *B608412,1 WAM 01/20/2008 Include cost 6 & 7 while add invoice lines
                *STORE 0 TO m.nActCost1  , m.nActCost2  , m.nActCost3 ,;
                m.nActCost4  , m.nActCost5  ,;
                m.nFActCost1 , m.nFActCost2 , m.nFActCost3 ,;
                m.nFActCost4 , m.nFActCost5
                STORE 0 TO m.nActCost1  , m.nActCost2  , m.nActCost3 ,;
                  m.nActCost4  , m.nActCost5  , m.nActCost6, m.nActCost7,;
                  m.nFActCost1 , m.nFActCost2 , m.nFActCost3 ,;
                  m.nFActCost4 , m.nFActCost5 , m.nFActCost6, m.nFActCost7
                *B608412,1 WAM 01/20/2008 (End)

                *-- If there is no fields for the actual cost in foreign currency
                IF EMPTY(lcHFActFld)
                  *-- Get the actual cost
                  FOR lnCount = 1 TO lnActCstNo
                    lcCount            = ALLTRIM(STR(lnCount))
                    m.nActCost&lcCount = &lcHActFild.&lcCount
                  ENDFOR
                ELSE    && Else [If there is fields for the actual cost in foreign currency]
                  *-- Get the actual cost
                  FOR lnCount = 1 TO lnActCstNo
                    lcCount             = ALLTRIM(STR(lnCount))
                    m.nActCost&lcCount  = &lcHActFild.&lcCount
                    m.nFActCost&lcCount = &lcHFActFld.&lcCount
                  ENDFOR
                ENDIF

                *-- Add a corresponding record in the temp. file
                INSERT INTO (loFormSet.lcActCstHd) FROM MEMVAR
              ELSE    && Else [If the attempt to lock the record failed]
                llReturn = .F.
                EXIT
              ENDIF    && End of IF gfObj_Lock(.T.)

            ENDIF

          ENDIF    && End of IF !SEEK(m.cIMTyp + cTktNo , loFormSet.lcActCstHd)

          *-- Update total actual cost in the temp. header file
          SELECT (loFormSet.lcActCstHd)

          lcTemp = '(lnAmntChng'+loFormSet.lcExSin1+'loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.Value'+;
            +loFormSet.lcExSin2+'apinvhdr.ncurrunit)'
          REPLACE nActCost&lcBomType WITH nActCost&lcBomType + &lcTemp

          *-- Update total actual cost in foreign currency in the temp. header
          *-- file
          IF !EMPTY(lcHFActFld)
            REPLACE nFActCost&lcBomType WITH nFActCost&lcBomType + lnAmntChng
          ENDIF    && End of IF !EMPTY(lcHFActFld)
        ENDIF    && End of IF !EMPTY(lcHdrFile)

      ENDIF
      SELECT (loFormSet.lcAPInvTkt)
      *-- Scan the corresponding records in the detail file (lcAPInvTkt) with
      *-- receiving session not empty.

      SCAN REST;
          WHILE cVendCode + cApInvNo + cApVILNo = EVALUATE(loFormSet.lcApVInvDt+'.cVendCode') +;
          EVALUATE(loFormSet.lcApVInvDt+'.cApInvNo') + EVALUATE(loFormSet.lcApVInvDt+'.cAPVILNo');
          FOR !EMPTY(cRSession)

        *-- Flag to know if the record has been deleted
        llDeleted = (cStatus='D') OR ((nRecNo = 0) AND (cStatus= 'S'))
        *-- Variable to hold the record number of the corresponding record in
        *-- the master file
        lnRecNo   = nRecNo

        *-- Replace the record pointer on the corresponding record in the
        *-- master file.
        IF BETWEEN(lnRecNo ,1,RECCOUNT('APINVTKT'))
          GO lnRecNo IN APINVTKT
        ENDIF

        *-- Get the change that has been made to the applied amount for this
        *-- record

        lnAmntChng = IIF(llDeleted   , 0 , nApAplAmnt) -;
          IIF(lnRecNo = 0 , 0 , APINVTKT.nApAplAmnt)

        *-- If there is no records for this document number in the actual
        *-- cost temp. detail file


        IF !SEEK(cIMTyp + cRSession + EVALUATE(loFormSet.lcApVInvDt+'.ShipNo') + cTKtNo + ;
            ITEM + COLOR + STR(LINENO,6) , loFormSet.lcActCstDt)

          *B608412,1 WAM 01/20/2008 Include cost 6 & 7 while add invoice lines
          *STORE 0 TO m.nActCost1  , m.nActCost2  , m.nActCost3 ,;
          m.nActCost4  , m.nActCost5  ,;
          m.nFActCost1 , m.nFActCost2 , m.nFActCost3 ,;
          m.nFActCost4 , m.nFActCost5
          STORE 0 TO m.nActCost1  , m.nActCost2  , m.nActCost3 ,;
            m.nActCost4  , m.nActCost5  , m.nActCost6, m.nActCost7,;
            m.nFActCost1 , m.nFActCost2 , m.nFActCost3 ,;
            m.nFActCost4 , m.nFActCost5 , m.nFActCost6, m.nFActCost7
          *B608412,1 WAM 01/20/2008 (End)

          m.cIMTyp    = cIMTyp
          m.cRSession = cRSession
          m.cShipNo   = EVALUATE(loFormSet.lcApVInvDt+'.ShipNo')
          m.cTktNo    = cTKtNo
          m.cItem     = ITEM
          m.cColor    = COLOR
          m.cLineNo   = STR(LINENO,6)
          *-- Go to the record that will be updated in the header file
          lcDKeyVal = EVALUATE(lcDKey)
          SELECT (lcDetFile)
          *Old:LLSEEK = SEEK (lcDKeyVal)
          LLSEEK = loFormSet.&lcDetFile..SEEK (lcDKeyVal)  &&Sql29: Check Key
          *Old: LOCATE REST;
          WHILE EVALUATE(SYS(14,VAL(SYS(21)))) = lcDKeyVal;
          FOR EVALUATE(lcDForCond)
          SELECT (lcDetFile)
          LOCATE FOR EVALUATE(lcDForCond)
          *MESSAGEBOX(lcDKey+CHR(13)+lcDKeyVal+CHR(13)+IIF(EOF(),'Eof','Not Eof')+CHR(13)+lcDetFile+CHR(13)+lcDForCond)
          *GO TOP
          *MESSAGEBOX(PADR(RECCOUNT(),10)+CHR(13)+;
          lfupditem(EVALUATE(loFormSet.lcAPInvTkt+'.Item'),EVALUATE(loFormSet.lcAPInvTkt+'.Color'))+CHR(13)+;
          STR(EVALUATE(loFormSet.lcAPInvTkt+'.LineNo') , 6)+CHR(13)+style+CHR(13)+STR(LineNo,6))
          *-- Attempt to lock the record
          IF !EOF() && gfObj_Lock(.T.) is not needed
            m.Rec_No    = REC_NO &&Sql30: Check RowID
            m.nTotQty   = &lcDQtyFild

            *-- If there is no fields for the actual cost in foreign currency
            IF EMPTY(lcDFActFld)

              *-- Get the actual cost
              FOR lnCount = 1 TO lnActCstNo
                lcCount            = ALLTRIM(STR(lnCount))
                m.nActCost&lcCount = &lcDActFild.&lcCount
              ENDFOR    && End of FOR lnCount = 1 TO lnActCstNo
            ELSE    && Else [If there is fields for the actual cost in foreign currency]

              *-- Get the actual cost
              FOR lnCount = 1 TO lnActCstNo
                lcCount             = ALLTRIM(STR(lnCount))
                m.nActCost&lcCount  = &lcDActFild.&lcCount
                m.nFActCost&lcCount = &lcDFActFld.&lcCount
              ENDFOR    && End of FOR lnCount = 1 TO lnActCstNo
            ENDIF    && End of IF EMPTY(lcDFActFld)

            *-- Add a corresponding record in the temp. file
            INSERT INTO (loFormSet.lcActCstDt) FROM MEMVAR
          ELSE    && Else [If the attempt to lock the record failed]
            llReturn = .F.
            EXIT
          ENDIF    && End of IF gfObj_Lock(.T.)
        ENDIF    && End of IF !SEEK(cIMTyp + cRSession + ...

        SELECT (loFormSet.lcActCstDt)

        *-- Update total actual cost in the temp. detail file
        lcTemp = '((IIF(nTotQty=0,0,lnAmntChng / nTotQty)) '+loFormSet.lcExSin1+;
          'loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.Value'+loFormSet.lcExSin2+'apinvhdr.ncurrunit)'
        REPLACE nActCost&lcBomType WITH nActCost&lcBomType + &lcTemp

        *-- Update total actual cost in foreign currency in the temp. detail
        *-- file
        IF !EMPTY(lcDFActFld)
          REPLACE nFActCost&lcBomType WITH nFActCost&lcBomType +;
            (IIF(nTotQty=0,0,lnAmntChng / nTotQty))

        ENDIF    && End of IF !EMPTY(lcDFActFld)
      ENDSCAN    && End of SCAN REST WHILE cVendCode + cApInvNo + cApVILNo ...

      SELECT (loFormSet.lcApVInvDt)
    ENDSCAN    && End of   SCAN WHILE llReturn .AND. cIMTyp = m.cIMTyp ...
  ENDDO    && End of DO WHILE llReturn .AND. !EOF()

  *-- If there was no troubles found in the records locking
  IF llReturn

    *-- Search for a record with negative actual cost in the temp. actual
    *-- cost header file
    SELECT (loFormSet.lcActCstHd)
    *B608412,1 WAM 01/20/2008 Include cost 6 & 7 while add invoice lines
    *LOCATE FOR nActCost1 < 0 .OR.;
    nActCost2 < 0 .OR.;
    nActCost3 < 0 .OR.;
    nActCost4 < 0 .OR.;
    nActCost5 < 0
    LOCATE FOR nActCost1 < 0 .OR.;
      nActCost2 < 0 .OR.;
      nActCost3 < 0 .OR.;
      nActCost4 < 0 .OR.;
      nActCost5 < 0 .OR.;
      nActCost6 < 0 .OR.;
      nActCost7 < 0
    *B608412,1 WAM 01/20/2008 (End)

    *-- If there is a record with negative actual cost in the temp. actual
    *-- cost header file
    IF FOUND()
      llReturn  = .F.

      *-- Get the variable part of the error message
      DO CASE
        CASE cIMTyp = 'I'
          lcMssgText = 'style purchase order'

        CASE cIMTyp = 'R'
          lcMssgText = 'style purchase order return'

        CASE cIMTyp = 'M'
          lcMssgText = 'cutting ticket'

        CASE cIMTyp = 'L'
          lcMssgText = 'material PO'

        CASE cIMTyp = 'F'
          lcMssgText = 'material PO return'
        CASE cIMTyp = 'T'
          lcMssgText = 'material MFG order'
        CASE cIMTyp = 'A'
          lcMssgText = 'Ador P/O'
        CASE cIMTyp = 'D'
          lcMssgText = 'Dye P/O'

      ENDCASE
      lcMssgText = lcMssgText + ' No. ' + cTKtNo

      *-- Message : 04188
      *-- "The debit amount applied to (lcMssgText) will produce a negative "
      *-- "actual cost. Cannot proceed with the saving process.             "
      *-- Button : 00000
      *-- "                          <    Ok    >                           "
      =gfModalGen("TRM04188B00000" , "DIALOG" , lcMssgText)
    ENDIF    && End of IF FOUND()
  ENDIF    && End of IF llReturn

  *-- If there was no troubles found in the records locking and no records
  *-- with negative actual cost found in the temp. actual cost header file.
  IF llReturn

    *-- Search for a record with negative actual cost in the temp. actual
    *-- cost detail file.
    SELECT (loFormSet.lcActCstDt)
    *B608412,1 WAM 01/20/2008 Include cost 6 & 7 while add invoice lines
    *LOCATE FOR nActCost1 < 0 .OR.;
    nActCost2 < 0 .OR.;
    nActCost3 < 0 .OR.;
    nActCost4 < 0 .OR.;
    nActCost5 < 0
    LOCATE FOR nActCost1 < 0 .OR.;
      nActCost2 < 0 .OR.;
      nActCost3 < 0 .OR.;
      nActCost4 < 0 .OR.;
      nActCost5 < 0 .OR.;
      nActCost6 < 0 .OR.;
      nActCost7 < 0
    *B608412,1 WAM 01/20/2008 Include cost 6 & 7 while add invoice lines

    *-- If there is a record with negative actual cost in the temp. actual
    *-- cost detail file
    IF FOUND()
      llReturn  = .F.

      *-- Get the variable part of the error message
      DO CASE
        CASE cIMTyp = 'I'
          lcMssgText = 'style purchase order No. ' + cTKtNo +;
            ', receiving session No. ' + cRSession +;
            ', line No. ' + ALLTRIM(cLineNo)

        CASE cIMTyp = 'R'
          lcMssgText = 'style purchase order return No. ' + cTKtNo +;
            ', receiving session No. ' + cRSession +;
            ', line No. ' + ALLTRIM(cLineNo)

        CASE cIMTyp = 'S'
          lcMssgText = 'shipment No. ' + cShipNo +;
            ', receiving session No. ' + cRSession +;
            ', style purchase order No. ' + cTKtNo +;
            ', line No. ' + ALLTRIM(cLineNo)

        CASE cIMTyp = 'M'
          lcMssgText = 'cutting ticket No. ' + cTKtNo +;
            ', receiving session No. ' + cRSession +;
            ', line No. ' + ALLTRIM(cLineNo)

        CASE cIMTyp = 'L'
          lcMssgText = 'material PO No. ' + cTKtNo +;
            ', receiving session No. ' + cRSession +;
            ', line No. ' + ALLTRIM(cLineNo)

        CASE cIMTyp = 'F'
          lcMssgText = 'material PO return No. ' + cTKtNo +;
            ', receiving session No. ' + cRSession +;
            ', line No. ' + ALLTRIM(cLineNo)
        CASE cIMTyp = 'T'
          lcMssgText = 'material MFG order No. ' + cTKtNo +;
            ', receiving session No. ' + cRSession
        CASE cIMTyp = 'A'
          lcMssgText = 'Adorment order No. ' + cTKtNo +;
            ', receiving session No. ' + cRSession +;
            ', line No. ' + ALLTRIM(cLineNo)
        CASE cIMTyp = 'D'
          lcMssgText = 'Dying order No. ' + cTKtNo +;
            ', receiving session No. ' + cRSession +;
            ', line No. ' + ALLTRIM(cLineNo)

      ENDCASE

      *-- Message : 04188
      *-- "The debit amount applied to (lcMssgText) will produce a negative "
      *-- "actual cost. Cannot proceed with the saving process.             "
      *-- Button : 00000
      *-- "                          <    Ok    >                           "
      =gfModalGen("TRM04188B00000" , "DIALOG" , lcMssgText)
    ENDIF    && End of IF FOUND()
  ENDIF    && End of IF llReturn

  *-- If troubles where found in the records locking or some of the records
  *-- in the temp. actual cost header file or detail file where found.
  IF !llReturn

    *Fix bug when Saving the debit memo againest Return PO [BEGIN]
    SELECT (loFormSet.lcAPInvTkt)
    REPLACE ALL nAPAplAmnt WITH nAPAplAmnt * -1,;
      nAPAplPric WITH nAPAplPric * -1 FOR (cIMTyp $ 'RF' AND (nAPAplAmnt > 0 ))

    SELECT (loFormSet.lcApVInvDt)
    REPLACE ALL nApAprAmnt WITH nApAprAmnt * -1,;
      nApAprPric WITH nApAprPric * -1,;
      nApPrice   WITH nApPrice   * -1,;
      nApAmnt    WITH nApAmnt    * -1 FOR (cIMTyp $ 'RF' AND (nApAprAmnt > 0 ))
    *Fix bug when Saving the debit memo againest Return PO [END]

    *-- Delete the records that have status same or deleted from the temp.
    *-- files (loFormSet.lcApVInvDt) and (lcAPInvTkt)
    SELECT (loFormSet.lcApVInvDt)
    DELETE ALL FOR INLIST(cStatus,'D','S')
    SELECT (loFormSet.lcAPInvTkt)
    DELETE ALL FOR INLIST(cStatus,'D','S')

    *-- Unlock the records that had been locked
    =lfUnLckPOF(loFormSet)
  ENDIF    && End of IF !llReturn

  RETURN llReturn
  *-- End of lfChckACst


  *!*************************************************************
  *! Name      : lfInvAdjust
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 8/16/2004
  *! Purpose   : To Add invoice adjustment
  *!*************************************************************
  *! Parameters: The FormSet
  *!*************************************************************
  *! Returns   : None
  *!*************************************************************
FUNCTION lfInvAdjust
  LPARAMETERS loFormSet

  PRIVATE lnAlias,llAdjust,lnTOldApr,lcInvAdjNo,lcCashAct,lnAdjAmnt,lnAccAmnt,;
    lcApDGlAct,llAdjustment

  lnAlias = SELECT()
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *=gfOpenFile(oAriaApplication.DataDir+'ApPaymnt','Typmethdoc','SH')
  =gfOpenTable('ApPaymnt','Typmethdoc','SH')
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[END]
  =CURSORSETPROP("Buffering",5,'ApPaymnt')
  lcExStatus = SET('EXACT')
  SET EXACT OFF

  llAdjust  = .F.
  lnTOldApr =0
  IF loFormSet.ActiveMode="E"
    WAIT 'Checking for Previous adjustments' WINDOW NOWAIT
    SELECT APVINVDT
    SET ORDER TO TAG Orgvinv
    =SEEK(PADR(loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE,8)+PADR(loFormSet.AriaForm1.kbInvNo.KeyTextBox.VALUE,12))
    SUM REST IIF(CIMTYP $ 'RF',-nApAPrAmnt,nApAPrAmnt) TO lnTOldApr ;
      WHILE cVendCode+cApInvNo+cAPVILNo = PADR(loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE,8)+PADR(loFormSet.AriaForm1.kbInvNo.KeyTextBox.VALUE,12)
    SELECT (loFormSet.lcApVInvDt)
    SCAN
      IF NRECNO > 0  AND BETWEEN(NRECNO,1,RECCOUNT('ApVInvDt'))
        lnRecNo = NRECNO
        GOTO lnRecNo IN 'ApVInvDt'

        *Invoice amount not equal to the old amount (Invoice amount changed). [Begin]
        IF nApAprAmnt <> ApVInvDt.nApAprAmnt OR nApPrice <> ApVInvDt.nApPrice
          *Invoice amount not equal to the old amount (Invoice amount changed). [End]

          llAdjust = .T.
          EXIT
        ENDIF
      ENDIF
    ENDSCAN
    IF llAdjust OR (lnTOldApr<>0 AND loFormSet.lnTAprAmt <> lnTOldApr)
      =lfVAdjust(loFormSet)
    ENDIF
    WAIT CLEAR
  ENDIF
  IF loFormSet.lnTAprAmt=lnTOldApr AND !llAdjust
    SET EXACT &lcExStatus
    SELECT (lnAlias)
    RETURN
  ENDIF
  WAIT 'Saving adjustment' WINDOW NOWAIT
  lcInvAdjNo = lfGetAdjNo(loFormSet)
  DO CASE
    CASE !EMPTY(STRTRAN(STRTRAN(apinvhdr.cchkglacc,'-'),'0'))
      lcCashAct = apinvhdr.cchkglacc
    CASE !EMPTY(APVENDOR.CCASHACCT)
      lcCashAct = APVENDOR.CCASHACCT
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *  CASE !EMPTY(loFormSet.AriaForm1.cboDivision.Value) .AND. !EMPTY(APDIV.CCASHACCT)
    CASE !EMPTY(loFormSet.AriaForm1.pgfpayInv.pgHead.cboDivision.VALUE) .AND. !EMPTY(APDIV.CCASHACCT)
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      lcCashAct = APDIV.CCASHACCT
    OTHERWISE
      lcCashAct = APSETUP.CCASHACCT
  ENDCASE
  SELECT (loFormSet.lcApVInvDt)
  SET ORDER TO TAG ADJUST
  lnAdjAmnt = 0
  GO TOP
  llAdjustment = .F.
  DO WHILE !EOF()
    lcApDGlAct = cApDGlAct

    *Do not care with adjustments in deleted records, only sum with new added,modified or selected records
    SUM REST (ROUND(nAPAMnt,2)-ROUND(nApAprAmnt,2))*IIF(CIMTYP $ 'RF',-1,1) ;
      TO   lnAccAmnt WHILE cApDGlAct = lcApDGlAct ;
      FOR CSTATUS $ 'AMS'
    IF lnAccAmnt <> 0
      SELECT (loFormSet.lcTmpDist)
      APPEND BLANK
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *!*	    REPLACE CVENDCODE WITH loFormSet.AriaForm1.KBVendCode.KeyTextBox.Value  ,;
      *!*	            CINVNO    WITH loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value  ,;
      *!*	            DAPDTRDAT WITH loFormSet.AriaForm1.DtPostDate.Value ,;
      *!*	            LAPDPOST  WITH .F.        ,;
      *!*	            CAPDGLACT WITH lcApDGlAct ,;
      *!*	            CAPDACTID WITH 'J'        ,;
      *!*	            CAPDREF   WITH lcInvAdjNo ,;
      *!*	            CSTATUS   WITH 'A'        ,;
      *!*	            CFISFYEAR WITH loFormSet.lcDistYer  ,;
      *!*	            CFSPPRDID WITH loFormSet.lcDistPrd  ,;
      *!*	            CAPSESSNO WITH loFormSet.lcSequence ,;
      *!*	            CAPDTRTYP WITH 'H'        ,;
      *!*	            CCURRCODE WITH loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value ,;
      *!*	            NEXRATE   WITH loFormSet.AriaForm1.txtNexRate.Value ,;
      *!*	            NCURRUNIT WITH apinvhdr.ncurrunit ,;
      *!*	            NAPDAMNT  WITH -lnAccAmnt
      *!*	    lcTemp = '-lnAccAmnt'+loFormSet.lcExSin1+'loFormSet.AriaForm1.txtNexRate.Value'+;
      *!*	             loFormSet.lcExSin2+'apinvhdr.ncurrunit'
      REPLACE CVENDCODE WITH loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE  ,;
        CINVNO    WITH loFormSet.AriaForm1.kbInvNo.KeyTextBox.VALUE  ,;
        DAPDTRDAT WITH loFormSet.AriaForm1.DtPostDate.VALUE ,;
        LAPDPOST  WITH .F.        ,;
        CAPDGLACT WITH lcApDGlAct ,;
        CAPDACTID WITH 'J'        ,;
        CAPDREF   WITH lcInvAdjNo ,;
        CSTATUS   WITH 'A'        ,;
        CFISFYEAR WITH loFormSet.lcDistYer  ,;
        CFSPPRDID WITH loFormSet.lcDistPrd  ,;
        CAPSESSNO WITH loFormSet.lcSequence ,;
        CAPDTRTYP WITH 'H'        ,;
        CCURRCODE WITH loFormSet.AriaForm1.pgfpayInv.pgHead.kbCurrCode.KeyTextBox.VALUE ,;
        NEXRATE   WITH loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.VALUE ,;
        NCURRUNIT WITH apinvhdr.ncurrunit ,;
        NAPDAMNT  WITH -lnAccAmnt
      lcTemp = '-lnAccAmnt'+loFormSet.lcExSin1+'loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.Value'+;
        loFormSet.lcExSin2+'apinvhdr.ncurrunit'

      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      REPLACE NEQVAMNT  WITH &lcTemp
      =gfAdd_Info(loFormSet.lcTmpDist)
      llAdjustment = .T.
    ENDIF
    lnAdjAmnt = lnAdjAmnt + lnAccAmnt
    SELECT (loFormSet.lcApVInvDt)
  ENDDO
  IF llAdjustment
    SELECT (loFormSet.lcTmpDist)
    APPEND BLANK
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *!*	  REPLACE CVENDCODE WITH loFormSet.AriaForm1.KBVendCode.KeyTextBox.Value  ,;
    *!*	          CINVNO    WITH loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value  ,;
    *!*	          DAPDTRDAT WITH loFormSet.AriaForm1.DtPostDate.Value ,;
    *!*	          LAPDPOST  WITH .F.        ,;
    *!*	          CAPDGLACT WITH loFormSet.DistLines.glAPActCode.KeyTextBox.Value ,;
    *!*	          CAPDACTID WITH 'A'        ,;
    *!*	          CAPDREF   WITH lcInvAdjNo ,;
    *!*	          CFISFYEAR WITH loFormSet.lcDistYer  ,;
    *!*	          CFSPPRDID WITH loFormSet.lcDistPrd  ,;
    *!*	          CSTATUS   WITH 'A'        ,;
    *!*	          CAPSESSNO WITH loFormSet.lcSequence ,;
    *!*	          CAPDTRTYP WITH 'H'        ,;
    *!*	          CCURRCODE WITH loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value ,;
    *!*	          NEXRATE   WITH loFormSet.AriaForm1.txtNexRate.Value ,;
    *!*	          NCURRUNIT WITH apinvhdr.ncurrunit ,;
    *!*	          NAPDAMNT  WITH lnAdjAmnt
    *!*	  lcTemp = 'lnAdjAmnt'+loFormSet.lcExSin1+'loFormSet.AriaForm1.txtNexRate.Value'+;
    *!*	           loFormSet.lcExSin2+'apinvhdr.ncurrunit'

    REPLACE CVENDCODE WITH loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE  ,;
      CINVNO    WITH loFormSet.AriaForm1.kbInvNo.KeyTextBox.VALUE  ,;
      DAPDTRDAT WITH loFormSet.AriaForm1.DtPostDate.VALUE ,;
      LAPDPOST  WITH .F.        ,;
      CAPDGLACT WITH loFormSet.AriaForm1.pgfpayInv.pgDist.glAPActCode.KeyTextBox.VALUE ,;
      CAPDACTID WITH 'A'        ,;
      CAPDREF   WITH lcInvAdjNo ,;
      CFISFYEAR WITH loFormSet.lcDistYer  ,;
      CFSPPRDID WITH loFormSet.lcDistPrd  ,;
      CSTATUS   WITH 'A'        ,;
      CAPSESSNO WITH loFormSet.lcSequence ,;
      CAPDTRTYP WITH 'H'        ,;
      CCURRCODE WITH loFormSet.AriaForm1.pgfpayInv.pgHead.kbCurrCode.KeyTextBox.VALUE ,;
      NEXRATE   WITH loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.VALUE ,;
      NCURRUNIT WITH apinvhdr.ncurrunit ,;
      NAPDAMNT  WITH lnAdjAmnt

    lcTemp = 'lnAdjAmnt'+loFormSet.lcExSin1+'loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.Value'+;
      loFormSet.lcExSin2+'apinvhdr.ncurrunit'
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    REPLACE NEQVAMNT  WITH &lcTemp
    =gfAdd_Info(loFormSet.lcTmpDist)
    APPEND BLANK
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *!*	  REPLACE CVENDCODE WITH loFormSet.AriaForm1.KBVendCode.KeyTextBox.Value  ,;
    *!*	          CINVNO    WITH loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value  ,;
    *!*	          DAPDTRDAT WITH loFormSet.AriaForm1.DtPostDate.Value ,;
    *!*	          LAPDPOST  WITH .F.        ,;
    *!*	          CAPDGLACT WITH lcCashAct  ,;
    *!*	          CAPDACTID WITH 'C'        ,;
    *!*	          CSTATUS   WITH 'A'        ,;
    *!*	          CAPDREF   WITH lcInvAdjNo ,;
    *!*	          CFISFYEAR WITH loFormSet.lcDistYer  ,;
    *!*	          CFSPPRDID WITH loFormSet.lcDistPrd  ,;
    *!*	          CAPSESSNO WITH loFormSet.lcSequence ,;
    *!*	          CAPDTRTYP WITH 'H'        ,;
    *!*	          CCURRCODE WITH loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value ,;
    *!*	          NEXRATE   WITH loFormSet.AriaForm1.txtNexRate.Value ,;
    *!*	          NCURRUNIT WITH apinvhdr.ncurrunit ,;
    *!*	          NAPDAMNT  WITH 0          ,;
    *!*	          NEQVAMNT  WITH 0
    REPLACE CVENDCODE WITH loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE  ,;
      CINVNO    WITH loFormSet.AriaForm1.kbInvNo.KeyTextBox.VALUE  ,;
      DAPDTRDAT WITH loFormSet.AriaForm1.DtPostDate.VALUE ,;
      LAPDPOST  WITH .F.        ,;
      CAPDGLACT WITH lcCashAct  ,;
      CAPDACTID WITH 'C'        ,;
      CSTATUS   WITH 'A'        ,;
      CAPDREF   WITH lcInvAdjNo ,;
      CFISFYEAR WITH loFormSet.lcDistYer  ,;
      CFSPPRDID WITH loFormSet.lcDistPrd  ,;
      CAPSESSNO WITH loFormSet.lcSequence ,;
      CAPDTRTYP WITH 'H'        ,;
      CCURRCODE WITH loFormSet.AriaForm1.pgfpayInv.pgHead.kbCurrCode.KeyTextBox.VALUE ,;
      NEXRATE   WITH loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.VALUE ,;
      NCURRUNIT WITH apinvhdr.ncurrunit ,;
      NAPDAMNT  WITH 0          ,;
      NEQVAMNT  WITH 0
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    =gfAdd_Info(loFormSet.lcTmpDist)

    *! B130111,1 ASM 11/01/2005 Allow the User to Edit an Invoice whose posted date is locked, but make entries on system date [Start]
    IF loFormSet.llLokPer
      lfCheckTmpDist(loFormSet)
    ENDIF
    *! B130111,1 ASM 11/01/2005 Allow the User to Edit an Invoice whose posted date is locked, but make entries on system date [End]
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *=gfTmp2Mast('APDIST',loFormSet.lcTmpDist)
      *!*	  INSERT INTO ('ApPaymnt') ;
    *!*	         (cPayType,cPAyMeth,cPayDocNo,cPayStat,dpayDate,cFisFYear,cFspprdid,;
    *!*	          cPayClNo,cPayComp,npayadj,cpayrecst,ccurrcode,ncurrunit,nexrate) VALUES ;
    *!*	         ('P','H',lcInvAdjNo,'',loFormSet.AriaForm1.DtPostDate.Value,loFormSet.lcDistYer,loFormSet.lcDistPrd,;
    *!*	          loFormSet.AriaForm1.KBVendCode.KeyTextBox.Value,ApVendor.cVenComp,lnAdjAmnt,'O',loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value,apinvhdr.ncurrunit,loFormSet.AriaForm1.txtNexRate.Value)
    lfTmp2Mast('APDIST',loFormSet.lcTmpDist)
    =gfSEEK(PADR(loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE,8),'ApVendor')
  
    INSERT INTO ('ApPaymnt') ;
      (cPayType,cPAyMeth,cPayDocNo,cPayStat,dpayDate,cFisFYear,cFspprdid,;
      cPayClNo,cPayComp,npayadj,cpayrecst,ccurrcode,ncurrunit,nexrate) VALUES ;
      ('P','H',lcInvAdjNo,'',loFormSet.AriaForm1.DtPostDate.VALUE,loFormSet.lcDistYer,loFormSet.lcDistPrd,;
      loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE,ApVendor.cVenComp,lnAdjAmnt,'O',loFormSet.AriaForm1.pgfpayInv.pgHead.kbCurrCode.KeyTextBox.VALUE,apinvhdr.ncurrunit,loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.VALUE)
    =gfAdd_Info('ApPaymnt')
     SELECT ApPaymnt
    =gfreplace('')
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

   


    SELECT ApInvHdr
    =RLOCK()
    REPLACE nInvAdj WITH nInvAdj + lnAdjAmnt
    UNLOCK
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    =gfreplace('')
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

    SELECT ApVendor
    =RLOCK()
    REPLACE nVenBal WITH nVenBal - lnAdjAmnt
    UNLOCK
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    =gfreplace('')
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

    SELECT ApVenHst
    =SEEK(PADR(loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE,8)+loFormSet.lcDistYer)
    =RLOCK()
    REPLACE nVnHAdj WITH nVnHAdj + lnAdjAmnt
    UNLOCK
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    =gfreplace('')
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[ENd]
  ENDIF
  WAIT CLEAR
  SET EXACT &lcExStatus
  SELECT (lnAlias)

  RETURN
  *-- End of lfInvAdjust


  *!*************************************************************
  *! Name      : lfUpdFiles
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 8/16/2004
  *! Purpose   : To Update Master Files
  *!*************************************************************
  *! Parameters: The FormSet
  *!*************************************************************
  *! Returns   : None
  *!*************************************************************
FUNCTION lfUpdFiles
  LPARAMETERS loFormSet

  PRIVATE lcExStatus

  *Add this line to update the actual cost fields in the Style PO,
  *Material PO and Cut Ticket header and detail files using the
  *temp. files that was created by the function lfChckACst (), to
  *calculate the actual cost and check for negative actual cost
  *before saving [Begin]
  =lfUpdatPOF(loFormSet)
  *Add this line to update the actual cost fields [End]

  lcExStatus = SET('EXACT')
  SET EXACT OFF
  =lfOpenFile('BOMCOST','BOMCOST',loFormSet) &&Sql Check Tag ;
  *CINVTYPE+ITEM+CWARECODE+CDYELOT+CRSESSION+CISESSION ;
  (ITEM+ICLR+CWARECODE+CDYELOT+CRSESSION+CISESSION)

  =lfOpenFile('CTKTBOM','CTKTBOM',loFormSet) &&Sql Check Tag ;
  *CIMTYP+CUTTKT+TYP+CINVTYPE+ITEM+MFGCODE+DYELOT ;
  (CIMTYP+CUTTKT+TYP+ITEM+ICLR+MFGCODE+DYELOT)

  *Old: SET ORDER TO TAG Bomcstkt IN BOMCOST
  loFormSet.BOMCOST.SetOrder('Bomcstkt') &&Sql33: Check Tag ;
  *CBOMTYPE+CIMTYP+CTKTNO+CINVTYPE+ITEM+MFGCODE+CWARECODE+CDYELOT+CRSESSION+CISESSION ;
  (CBOMTYPE+CIMTYP+CTKTNO+ITEM+ICLR+MFGCODE+CWARECODE+CDYELOT+CRSESSION+CISESSION)
  *Old: SET ORDER TO TAG CTKTBOM IN CTKTBOM
  loFormSet.CTKTBOM.SetOrder('CTKTBOM') &&Sql34: Check Tag ;
  *CIMTYP+CUTTKT+TYP+CINVTYPE+ITEM+MFGCODE+DYELOT ;
  (CIMTYP+CUTTKT+TYP+ITEM+ICLR+MFGCODE+DYELOT)

  IF ('I' $ loFormSet.lcVenInvTypes OR 'R' $ loFormSet.lcVenInvTypes ) AND USED("POSHDR")
    *Old: SET ORDER TO TAG POSHDR IN POSHDR
    loFormSet.POSHDR.SetOrder('POSHDR') &&Sql35: Check Tag CBUSDOCU+CSTYTYPE+PO (CSTYTYPE+PO)
    *Old: SET ORDER TO TAG POSREC IN POSLN
    loFormSet.POSLN.SetOrder('POSREC') &&Sql36: Check Tag ;
    *CBUSDOCU+CSTYTYPE+PO+CRSESSION+SHIPNO+CINVTYPE+STYLE+STR(LINENO,6)+TRANCD+CSTYGRADE ;
    (CSTYTYPE+PO+CRSESSION+SHIPNO+STYLE+STR(LINENO,6)+TRANCD)
  ENDIF
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *IF 'MF' $ oAriaApplication.CompanyInstalledModules AND loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value = oAriaApplication.BaseCurrency AND 'M' $ loFormSet.lcVenInvTypes
  IF 'MF' $ oAriaApplication.CompanyInstalledModules AND loFormSet.AriaForm1.pgfpayInv.pgHead.kbCurrCode.KeyTextBox.VALUE = oAriaApplication.BaseCurrency AND 'M' $ loFormSet.lcVenInvTypes
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    *Old: SET ORDER TO TAG CUTTKTH IN CUTTKTH
    loFormSet.CUTTKTH.SetOrder('POSHDR') &&Sql37: Check Tag CBUSDOCU+CSTYTYPE+PO (CUTTKT)
    *Old: SET ORDER TO TAG CUTREC  IN CUTTKTL
    loFormSet.CUTTKTL.SetOrder('POSREC') &&Sql38: Check Tag ;
    *CBUSDOCU+CSTYTYPE+PO+CRSESSION+SHIPNO+CINVTYPE+STYLE+STR(LINENO,6)+TRANCD+CSTYGRADE ;
    (CRSESSION+CUTTKT+STYLE+TRANCD)
  ENDIF
  IF ('L' $ loFormSet.lcVenInvTypes OR 'F' $ loFormSet.lcVenInvTypes) AND USED("POFHDR")
    =lfOpenFile('MATINVJL','MATINVJL',loFormSet)
    *Old: SET ORDER TO TAG POFHDR IN POFHDR
    loFormSet.POFHDR.SetOrder('POSHDR') &&Sql39: Check Tag CBUSDOCU+CSTYTYPE+PO (CMATTYPE+POMAT)
    *Old: SET ORDER TO TAG POFREC IN POFLN
    loFormSet.POFLN.SetOrder('POSREC') &&Sql40: Check Tag ;
    *CBUSDOCU+CSTYTYPE+PO+CRSESSION+SHIPNO+CINVTYPE+STYLE+STR(LINENO,6)+TRANCD+CSTYGRADE ;
    (CMATTYPE+POMAT+CRSESSION+FABRIC+COLOR+TRANCD)
  ENDIF
  *Fix the contribution process [Begin]
  *Old": SELECT BOMLINE
  *Old: SET ORDER TO TAG BOMPOREC IN BOMLINE
  loFormSet.BOMLINE.SetOrder('BOMPOREC') &&Sql41: Check Tag ;
  *CIMTYP+CTYPE+CBOMTYP+MFGCODE+CTKTNO+CRSESSION+SHIPNO+STR(LINENO,6)+CINVTYPE+STYLE+CSTYGRADE ;
  (CIMTYP+CTYPE+CBOMTYP+MFGCODE+CTKTNO+CRSESSION+SHIPNO+STR(LINENO,6)+STYLE+SCLR+CSTYGRADE)
  *Fix the contribution process [End]
  SELECT (loFormSet.lcAPInvTkt)
  RECALL ALL
  SELECT (loFormSet.lcApVInvDt)
  RECALL ALL

  *Fix bug when Saving the debit memo againest Return PO [BEGIN]
  SELECT (loFormSet.lcAPInvTkt)
  REPLACE ALL nAPAplAmnt WITH nAPAplAmnt * -1,;
    nAPAplPric WITH nAPAplPric * -1 FOR (cIMTyp $ 'RF' AND (nAPAplAmnt < 0 ))

  SELECT (loFormSet.lcApVInvDt)
  REPLACE ALL nApAprAmnt WITH nApAprAmnt * -1,;
    nApAprPric WITH nApAprPric * -1,;
    nApPrice   WITH nApPrice   * -1,;
    nApAmnt    WITH nApAmnt    * -1 FOR (cIMTyp $ 'RF' AND (nApAprAmnt < 0 ))
  *Fix bug when Saving the debit memo againest Return PO [END]


  SCAN FOR cStatus <> 'S' AND SEEK(cVendCode+cApInvNo+cAPVILNo,loFormSet.lcAPInvTkt)

    *Spliting the files updates in case of Shipmnet [Begin] .
    IF EVALUATE(loFormSet.lcApVInvDt+'.cIMTyp')= 'S'
      =lfUpdShip(loFormSet)
      SELECT (loFormSet.lcApVInvDt)
      LOOP
    ENDIF
    *Spliting the files updates in case of Shipmnet [End].

    *We need to update the CTKTBOM and BOMCOST file even if there is no contibution [start]
    * IF EMPTY(&lcAPInvTkt..cRSession) AND &loFormSet.lcApVInvDt..cIMTyp = 'S'
    *    LOOP
    *  ENDIF
    *We need to update the CTKTBOM and BOMCOST file even if there is no contibution [End]



    llDeleted = (cStatus='D') OR (cStatus='S' AND EMPTY(nRecNo))
    lnRecNo   = nRecNo

    IF BETWEEN(lnRecNo ,1,RECCOUNT('APVINVDT'))
      SELECT APVINVDT
      GO lnRecNo
    ENDIF

    IF !INLIST(EVALUATE(loFormSet.lcApVInvDt+'.cIMTyp'),'L','F','R')

      *CIMTYP+CUTTKT+TYP+CINVTYPE+ITEM+MFGCODE+DYELOT
      IF loFormSet.cTktBom.SEEK(IIF(EVALUATE(loFormSet.lcApVInvDt+'.cIMTyp')="S","I",;
          EVALUATE(loFormSet.lcApVInvDt+'.cIMTyp'))+EVALUATE(loFormSet.lcApVInvDt+'.ctktno')+;
          EVALUATE(loFormSet.lcApVInvDt+'.cbomtype')+SPACE(4)+SPACE(19)+;
          EVALUATE(loFormSet.lcApVInvDt+'.cOprCode')+SPACE(10)) &&Sql53: Check Key
        loFormSet.cTktBom.REPLACE()
        SELECT (loFormSet.cTktBom.lcCursorUpdate)
        REPLACE ISSUE_QTY WITH ISSUE_QTY - IIF(lnRecNo=0,0,APVINVDT.nApTAprQty) + IIF(llDeleted,0,EVALUATE(loFormSet.lcApVInvDt+'.nApTAprQty')),;
          USED_QTY  WITH USED_QTY  - IIF(lnRecNo=0,0,APVINVDT.nApTAprQty) + IIF(llDeleted,0,EVALUATE(loFormSet.lcApVInvDt+'.nApTAprQty'))
        SELECT cTktBom
      ENDIF

      *Add these lines to update this record of BOMCOST file
      *with the uncontributed amount only, and not with the
      *approved amount [Begin]

      *-- If the Invoice line was deleted or if the uncontributed amount was
      *-- changed.
      IF llDeleted .OR.;
          (EMPTY(EVALUATE(loFormSet.lcAPInvTkt+'.cRSession')) .AND. EVALUATE(loFormSet.lcAPInvTkt+'.cStatus') <> 'S')



        IF BETWEEN(EVALUATE(loFormSet.lcAPInvTkt+'.nRecNo') ,1,RECCOUNT('APINVTKT'))
          GO EVALUATE(loFormSet.lcAPInvTkt+'.nRecNo') IN APINVTKT
        ENDIF
        *Add these lines to update this record of BOMCOST [End]

        *Update BOMCOST file
        SELECT BOMCOST

        lcKey = EVALUATE(loFormSet.lcApVInvDt+'.cbomtype')+;
          IIF(EVALUATE(loFormSet.lcApVInvDt+'.cIMTyp')="S","I",EVALUATE(loFormSet.lcApVInvDt+'.cIMTyp'))+;
          EVALUATE(loFormSet.lcApVInvDt+'.ctktno')+SPACE(4)+SPACE(19)+;
          EVALUATE(loFormSet.lcApVInvDt+'.cOprCode')+SPACE(6)+SPACE(10)+SPACE(6)+SPACE(6)

        *CBOMTYPE+CIMTYP+CTKTNO+CINVTYPE+ITEM+MFGCODE+CWARECODE+CDYELOT+CRSESSION+CISESSION
        =loFormSet.BOMCOST.SEEK(EVALUATE(loFormSet.lcApVInvDt+'.cbomtype')+;
          IIF(EVALUATE(loFormSet.lcApVInvDt+'.cIMTyp')="S","I",EVALUATE(loFormSet.lcApVInvDt+'.cIMTyp'))+;
          EVALUATE(loFormSet.lcApVInvDt+'.ctktno')+SPACE(4)+SPACE(19)+;
          EVALUATE(loFormSet.lcApVInvDt+'.cOprCode')+SPACE(6)+SPACE(10)+SPACE(6)+SPACE(6)) &&Sql54: Check Key
        LOCATE ALL FOR cVendCode+cApInvNo = PADR(loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE,8)+PADR(loFormSet.AriaForm1.kbInvNo.KeyTextBox.VALUE,12) &&Sql55: ICLR Field not found

        DO CASE

            *Change this condition to update this record of BOMCOST
            *file with the uncontributed amount only, and not with
            *the approved amount [Begin]
          CASE !llDeleted AND !FOUND() .AND. EVALUATE(loFormSet.lcAPInvTkt+'.cStatus') <> 'D'
            *Change this condition to update this record of BOMCOST [End]

            IF !SEEK(IIF(EVALUATE(loFormSet.lcApVInvDt+'.cIMTyp')="S","I",EVALUATE(loFormSet.lcApVInvDt+'.cIMTyp'))+;
                IIF(EVALUATE(loFormSet.lcApVInvDt+'.cIMTyp')="S",EVALUATE(loFormSet.lcAPInvTkt+'.ctktno'),EVALUATE(loFormSet.lcApVInvDt+'.ctktno'))+;
                'N'+EVALUATE(loFormSet.lcApVInvDt+'.cbomtype')+SPACE(4)+SPACE(19)+EVALUATE(loFormSet.lcApVInvDt+'.cOprCode')+;
                SPACE(LEN(COPRCODE))+SPACE(LEN(CLOTNO))+SPACE(LEN(CISESSION))+SPACE(LEN(CRSESSION))+;
                PADR(loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE,8)+PADR(loFormSet.AriaForm1.kbInvNo.KeyTextBox.VALUE,12),;
                loFormSet.BOMCOST.lcCursorUpdate)

              loFormSet.BOMCOST.APPEND('REPLACE CBOMTYPE WITH ""')

            ENDIF

            SELECT (loFormSet.BOMCOST.lcCursorUpdate)
            *B608489,1 WAM 03/23/2008 Fix updating total quantity in bomcost
            *REPLACE CBOMTYPE  WITH EVALUATE(loFormSet.lcApVInvDt+'.cbomtype') ,;
            CIMTYP    WITH IIF(EVALUATE(loFormSet.lcApVInvDt+'.cIMTyp')="S","I",;
            EVALUATE(loFormSet.lcApVInvDt+'.cIMTyp')),;
            CTKTNO    WITH IIF(EVALUATE(loFormSet.lcApVInvDt+'.cIMTyp')="S",;
            EVALUATE(loFormSet.lcAPInvTkt+'.ctktno'),EVALUATE(loFormSet.lcApVInvDt+'.ctktno')),;
            CINVTYPE  WITH ''                    ,;
            ITEM      WITH ''                    ,;
            MFGCODE   WITH EVALUATE(loFormSet.lcApVInvDt+'.cOprCode') ,;
            CWARECODE WITH ''                    ,;
            CDYELOT   WITH ''                    ,;
            CRSESSION WITH SPACE(6)  ,;
            CVENDCODE WITH loFormSet.AriaForm1.KBVendCode.KeyTextBox.Value ,;
            CAPINVNO  WITH loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value ,;
            CISESSION WITH ''        ,;
            SHIPNO    WITH ''        ,;
            DTRANDATE WITH loFormSet.AriaForm1.DtPostDate.Value,;
            CCOSTTYPE WITH EVALUATE(loFormSet.lcApVInvDt+'.cCostType')  ,;
            NTOTQTY   WITH EVALUATE(loFormSet.lcAPInvTkt+'.nAPTAplQty') -;
            IIF(EVALUATE(loFormSet.lcAPInvTkt+'.nRecNo') = 0 , 0 ,;
            APINVTKT.nAPTAplQty) ,;
            NTOTCST   WITH EVALUATE(loFormSet.lcAPInvTkt+'.nAPAplAmnt') -;
            IIF(EVALUATE(loFormSet.lcAPInvTkt+'.nRecNo') = 0 , 0 ,;
            APINVTKT.nAPAplAmnt) ,;
            NUNITCST  WITH EVALUATE(loFormSet.lcAPInvTkt+'.nAPAplPric') -;
            IIF(EVALUATE(loFormSet.lcAPInvTkt+'.nRecNo') = 0 , 0 ,;
            APINVTKT.nAPAplPric) ,;
            NTOTACST  WITH NTOTCST  ,;
            NUNITACST WITH NUNITCST ,;
            Actualize WITH 'N' &&Sql56: ICLR Field not found
            REPLACE CBOMTYPE  WITH EVALUATE(loFormSet.lcApVInvDt+'.cbomtype') ,;
              CIMTYP    WITH IIF(EVALUATE(loFormSet.lcApVInvDt+'.cIMTyp')="S","I",;
              EVALUATE(loFormSet.lcApVInvDt+'.cIMTyp')),;
              CTKTNO    WITH IIF(EVALUATE(loFormSet.lcApVInvDt+'.cIMTyp')="S",;
              EVALUATE(loFormSet.lcAPInvTkt+'.ctktno'),EVALUATE(loFormSet.lcApVInvDt+'.ctktno')),;
              CINVTYPE  WITH ''                    ,;
              ITEM      WITH ''                    ,;
              MFGCODE   WITH EVALUATE(loFormSet.lcApVInvDt+'.cOprCode') ,;
              CWARECODE WITH ''                    ,;
              CDYELOT   WITH ''                    ,;
              CRSESSION WITH SPACE(6)  ,;
              CVENDCODE WITH loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE ,;
              CAPINVNO  WITH loFormSet.AriaForm1.kbInvNo.KeyTextBox.VALUE ,;
              CISESSION WITH ''        ,;
              SHIPNO    WITH ''        ,;
              DTRANDATE WITH loFormSet.AriaForm1.DtPostDate.VALUE,;
              CCOSTTYPE WITH EVALUATE(loFormSet.lcApVInvDt+'.cCostType')  ,;
              NTOTQTY   WITH NTOTQTY+EVALUATE(loFormSet.lcAPInvTkt+'.nAPTAplQty') -;
              IIF(EVALUATE(loFormSet.lcAPInvTkt+'.nRecNo') = 0 , 0 ,;
              APINVTKT.nAPTAplQty) ,;
              NTOTCST   WITH NTOTCST+EVALUATE(loFormSet.lcAPInvTkt+'.nAPAplAmnt') -;
              IIF(EVALUATE(loFormSet.lcAPInvTkt+'.nRecNo') = 0 , 0 ,;
              APINVTKT.nAPAplAmnt) ,;
              NUNITCST  WITH IIF(NTOTQTY=0,0,NTOTCST/NTOTQTY)  ,;
              NTOTACST  WITH NTOTCST  ,;
              NUNITACST WITH NUNITCST ,;
              Actualize WITH 'N' &&Sql56: ICLR Field not found
            *B608489,1 WAM 03/23/2008 (End)
            SELECT BOMCOST

          CASE !llDeleted AND FOUND()

            *Update unit cost in bocost file [Begin]
            *Change this line to update this record of BOMCOST file
            *with the uncontributed amount only, and not with the
            *approved amount [Begin]
            loFormSet.BOMCOST.REPLACE()
            SELECT (loFormSet.BOMCOST.lcCursorUpdate)
            REPLACE NTOTQTY   WITH NTOTQTY +;
              IIF(EVALUATE(loFormSet.lcAPInvTkt+'.cStatus') = 'D' , 0 ,;
              EVALUATE(loFormSet.lcAPInvTkt+'.nAPTAplQty')) -;
              IIF(EVALUATE(loFormSet.lcAPInvTkt+'.nRecNo') = 0 , 0 ,;
              APINVTKT.nAPTAplQty) ,;
              NTOTCST   WITH NTOTCST +;
              IIF(EVALUATE(loFormSet.lcAPInvTkt+'.cStatus') = 'D' , 0 ,;
              EVALUATE(loFormSet.lcAPInvTkt+'.nAPAplAmnt')) -;
              IIF(EVALUATE(loFormSet.lcAPInvTkt+'.nRecNo') = 0 , 0 ,;
              APINVTKT.nAPAplAmnt) ,;
              NUNITCST  WITH IIF(EVALUATE(loFormSet.lcAPInvTkt+'.cStatus') = 'D' , 0 ,;
              NTOTCST/NTOTQTY);
              NTOTACST  WITH NTOTCST  ,;
              NUNITACST WITH NUNITCST



            IF (EVALUATE(loFormSet.lcAPInvTkt+'.cStatus') = 'D') .OR. (NTOTQTY = 0)
              DELETE
            ENDIF
            SELECT BOMCOST

          CASE llDeleted AND FOUND()
            *Change this line to update this record of BOMCOST
            *file with the uncontributed amount only, and not with
            *the approved amount
            *Note: Note that this line could hold the uncontributed
            *amount of more than one invoice line [Begin]
            loFormSet.BOMCOST.REPLACE()
            SELECT (loFormSet.BOMCOST.lcCursorUpdate)
            REPLACE NTOTQTY   WITH NTOTQTY -;
              IIF(EVALUATE(loFormSet.lcAPInvTkt+'.nRecNo') = 0 , 0 ,;
              APINVTKT.nAPTAplQty) ,;
              NTOTCST   WITH NTOTCST -;
              IIF(EVALUATE(loFormSet.lcAPInvTkt+'.nRecNo') = 0 , 0 ,;
              APINVTKT.nAPAplAmnt) ,;
              NUNITCST  WITH NUNITCST -;
              IIF(EVALUATE(loFormSet.lcAPInvTkt+'.nRecNo') = 0 , 0 ,;
              APINVTKT.nAPAplPric) ,;
              NTOTACST  WITH NTOTCST  ,;
              NUNITACST WITH NUNITCST

            IF (EVALUATE(loFormSet.lcAPInvTkt+'.cStatus') = 'D') .OR. (NTOTQTY = 0)
              DELETE
            ENDIF
            SELECT BOMCOST

        ENDCASE

        *Add this if condition to update this record of BOMCOST file
        *with the uncontributed amount only, and not with the
        *approved amount [Begin]
      ENDIF    && End of IF EMPTY(&loFormSet.lcAPInvTkt..cRSession) .AND. ...
      *Add this if condition to update this record of BOMCOST [End]

      *Update BOMLINE file
      SELECT (loFormSet.lcAPInvTkt)
      SCAN REST WHILE cVendCode+cApInvNo+cAPVILNo = ;
          EVALUATE(loFormSet.lcApVInvDt+'.cVendCode')+;
          EVALUATE(loFormSet.lcApVInvDt+'.cApInvNo')+EVALUATE(loFormSet.lcApVInvDt+'.cAPVILNo') ;
          FOR   !EMPTY(cRSession)
        llDeleted = (cStatus='D') OR (cStatus='S' AND EMPTY(nRecNo))
        lnRecNo = nRecNo

        IF !llDeleted AND BETWEEN(lnRecNo ,1,RECCOUNT('APINVTKT'))
          SELECT APINVTKT
          GO lnRecNo
        ENDIF
        SELECT BomLine
        *CIMTYP+CTYPE+CBOMTYP+MFGCODE+CTKTNO+CRSESSION+SHIPNO+STR(LINENO,6)+CINVTYPE+STYLE+CSTYGRADE
        =loFormSet.BomLine.SEEK(EVALUATE(loFormSet.lcApVInvDt+'.cIMTyp')+"3"+EVALUATE(loFormSet.lcApVInvDt+'.cBomType')+;
          EVALUATE(loFormSet.lcApVInvDt+'.cOprCode')+EVALUATE(loFormSet.lcApVInvDt+'.ctktno')+;
          EVALUATE(loFormSet.lcAPInvTkt+'.cRSession')+EVALUATE(loFormSet.lcApVInvDt+'.shipno')+;
          STR(EVALUATE(loFormSet.lcApInvTkt+'.LineNo'),6)+;
          IIF(EVALUATE(loFormSet.lcApVInvDt+'.cIMTyp')='T','0002','0001')+;
          EVALUATE(loFormSet.lcApInvTkt+'.Item')) &&Sql57: Check Key

        DO CASE
          CASE !llDeleted AND !FOUND()
           *! B609219,1 MMT 04/22/2010 error while Update in Payable invoice screen if Same PO Line rec. to diff. loc. in Same session[Start]
 		   SELECT (loFormSet.BomLine.lcCursorUpdate)		    
           lnNewLineNo = 0
		   SCAN FOR ;
		      CIMTYP+CTYPE+CTKTNO+SHIPNO+STR(LINENO,6)+CBOMTYP+CINVTYPE+STYLE+CINVTYPC+ITEM+MFGCODE+CRSESSION+CSTYGRADE+STR(NLINENO,4)=;
		      IIF(EVALUATE(loFormSet.lcApVInvDt+'.cIMTyp')="S","I",;
               EVALUATE(loFormSet.lcApVInvDt+'.cIMTyp'))+'3'+IIF(EVALUATE(loFormSet.lcApVInvDt+'.cIMTyp')="S",;
                      EVALUATE(loFormSet.lcAPInvTkt+'.ctktno'),EVALUATE(loFormSet.lcApVInvDt+'.ctktno'))+EVALUATE(loFormSet.lcApVInvDt+'.shipno')+STR(EVALUATE(loFormSet.lcAPInvTkt+'.LineNo'),6)+;
		      EVALUATE(loFormSet.lcApVInvDt+'.cBomType')+IIF(EVALUATE(loFormSet.lcApVInvDt+'.cIMTyp')='T','0002','0001') +PADR(IIF(EVALUATE(loFormSet.lcApVInvDt+'.cIMTyp')='T',;
                               lfupditem(EVALUATE(loFormSet.lcAPInvTkt+'.Item'),EVALUATE(loFormSet.lcAPInvTkt+'.Color')),;
                               EVALUATE(loFormSet.lcAPInvTkt+'.Item')),19)+;
		      Space(4)+SPACE(19)+EVALUATE(loFormSet.lcApVInvDt+'.cOprCode')+EVALUATE(loFormSet.lcAPInvTkt+'.cRSession')+SPACE(1)
		      
		      lnNewLineNo = MAX(IIF(ISNULL(nLineNo),0,nLineNo),lnNewLineNo)
		   ENDSCAN
		   lnNewLineNo = lnNewLineNo + 1
           *! B609219,1 MMT 04/22/2010 error while Update in Payable invoice screen if Same PO Line rec. to diff. loc. in Same session[End]
        
            loFormSet.BomLine.APPEND('REPLACE cimtyp WITH ""')

            SELECT (loFormSet.BomLine.lcCursorUpdate)
            REPLACE cimtyp    WITH IIF(EVALUATE(loFormSet.lcApVInvDt+'.cIMTyp')="S","I",;
              EVALUATE(loFormSet.lcApVInvDt+'.cIMTyp')) ,;
              ctype     WITH '3'                   ,;
              cbomtyp   WITH EVALUATE(loFormSet.lcApVInvDt+'.cBomType') ,;
              mfgcode   WITH EVALUATE(loFormSet.lcApVInvDt+'.cOprCode') ,;
              ctktno    WITH IIF(EVALUATE(loFormSet.lcApVInvDt+'.cIMTyp')="S",;
              EVALUATE(loFormSet.lcAPInvTkt+'.ctktno'),EVALUATE(loFormSet.lcApVInvDt+'.ctktno')),;
              crsession WITH EVALUATE(loFormSet.lcAPInvTkt+'.cRSession'),;
              shipno    WITH EVALUATE(loFormSet.lcApVInvDt+'.shipno')   ,;
              LINENO    WITH EVALUATE(loFormSet.lcAPInvTkt+'.LineNo')   ,;
              CINVTYPE  WITH IIF(EVALUATE(loFormSet.lcApVInvDt+'.cIMTyp')='T','0002','0001')    ,;
              STYLE     WITH IIF(EVALUATE(loFormSet.lcApVInvDt+'.cIMTyp')='T',;
              lfupditem(EVALUATE(loFormSet.lcAPInvTkt+'.Item'),EVALUATE(loFormSet.lcAPInvTkt+'.Color')),;
              EVALUATE(loFormSet.lcAPInvTkt+'.Item'))     ,;
              cCatgTyp  WITH EVALUATE(loFormSet.lcApVInvDt+'.cCostType'),;
              UnitQty   WITH  1 ,;
              StyQty    WITH EVALUATE(loFormSet.lcAPInvTkt+'.nApTAplQty') ,;
              ItemQty   WITH StyQty ,;
              ItemAmt   WITH EVALUATE(loFormSet.lcAPInvTkt+'.nApAplAmnt') ,;
              UnitCost  WITH IIF(ItemQty=0,0,ItemAmt/ItemQty) &&Sql58: SCLR Field not found

           *! B609219,1 MMT 04/22/2010 error while Update in Payable invoice screen if Same PO Line rec. to diff. loc. in Same session[Start]
           REPLACE nLineNo WITH lnNewLineNo 
           *! B609219,1 MMT 04/22/2010 error while Update in Payable invoice screen if Same PO Line rec. to diff. loc. in Same session[End]        
           
            * B608833,1 HES 04/01/2009 Add Standared Fields for POMLINE File[T20081001.0001]
            =gfAdd_Info(loFormSet.BomLine.lcCursorUpdate)
            * B608833,1 HES 04/01/2009 Add Standared Fields for POMLINE File[T20081001.0001]

            SELECT BomLine

            *add style info to bomline [End]

          CASE !llDeleted AND FOUND()
            *Fix bug when Saving the debit memo againest Return PO [BEGIN]
            loFormSet.BomLine.REPLACE()
            SELECT (loFormSet.BomLine.lcCursorUpdate)
            IF loFormSet.llDebitM AND !(EVALUATE(loFormSet.lcApVInvDt+'.cIMTyp') $'RF')
              REPLACE StyQty   WITH StyQty - IIF(lnRecNo=0,0,APINVTKT.nApTAplQty) - ;
                IIF(EVALUATE(loFormSet.lcAPInvTkt+'.nApTAplQty') >=StyQty,0,EVALUATE(loFormSet.lcAPInvTkt+'.nApTAplQty')),;
                ItemQty  WITH StyQty ,;
                ItemAmt  WITH ItemAmt -IIF(lnRecNo=0,0,APINVTKT.nApAplAmnt) + EVALUATE(loFormSet.lcAPInvTkt+'.nApAplAmnt') ,;
                UnitCost WITH IIF(ItemQty=0,0,ItemAmt/ItemQty)
            ELSE
              REPLACE StyQty   WITH StyQty - IIF(lnRecNo=0,0,APINVTKT.nApTAplQty) + EVALUATE(loFormSet.lcAPInvTkt+'.nApTAplQty') ,;
                ItemQty  WITH StyQty ,;
                ItemAmt  WITH ItemAmt -IIF(lnRecNo=0,0,APINVTKT.nApAplAmnt) + EVALUATE(loFormSet.lcAPInvTkt+'.nApAplAmnt') ,;
                UnitCost WITH IIF(ItemQty=0,0,ItemAmt/ItemQty)
            ENDIF
            * B608833,1 HES 04/01/2009 Add Standared Fields for POMLINE File[T20081001.0001]
            =gfAdd_Info(loFormSet.BomLine.lcCursorUpdate)
            * B608833,1 HES 04/01/2009 Add Standared Fields for POMLINE File[T20081001.0001]

            SELECT BomLine
            *Fix bug when Saving the debit memo againest Return PO [ENd]

          CASE llDeleted AND FOUND()
            *Fix bug when Saving the debit memo againest Return PO [BEGIN]

            *Fix the contribution process [Begin]
            *DELETE
            loFormSet.BomLine.REPLACE()
            SELECT (loFormSet.BomLine.lcCursorUpdate)
            IF loFormSet.llDebitM AND !(EVALUATE(loFormSet.lcApVInvDt+'.cIMTyp') $'RF')
              REPLACE StyQty   WITH StyQty +  IIF(EVALUATE(loFormSet.lcAPInvTkt+'.nApTAplQty') >=StyQty,0,EVALUATE(loFormSet.lcAPInvTkt+'.nApTAplQty')) ,;
                ItemQty  WITH StyQty ,;
                ItemAmt  WITH ItemAmt - EVALUATE(loFormSet.lcAPInvTkt+'.nApAplAmnt') ,;
                UnitCost WITH IIF(ItemQty=0,0,ItemAmt/ItemQty)
            ELSE
              REPLACE StyQty   WITH StyQty - EVALUATE(loFormSet.lcAPInvTkt+'.nApTAplQty') ,;
                ItemQty  WITH StyQty ,;
                ItemAmt  WITH ItemAmt - EVALUATE(loFormSet.lcAPInvTkt+'.nApAplAmnt') ,;
                UnitCost WITH IIF(ItemQty=0,0,ItemAmt/ItemQty)
            ENDIF
            * B608833,1 HES 04/01/2009 Add Standared Fields for POMLINE File[T20081001.0001]
            =gfAdd_Info(loFormSet.BomLine.lcCursorUpdate)
            * B608833,1 HES 04/01/2009 Add Standared Fields for POMLINE File[T20081001.0001]

            *Fix bug when Saving the debit memo againest Return PO [ENd]
            IF ItemQty = 0
              DELETE
            ENDIF
            SELECT BomLine
            *Fix the contribution process [End]
        ENDCASE
        *Update BOMCOST file
        SELECT BOMCOST

        lcKey = EVALUATE(loFormSet.lcApVInvDt+'.cbomtype')+;
          IIF(EVALUATE(loFormSet.lcApVInvDt+'.cIMTyp')="S","I"+;
          EVALUATE(lcApInvTkt+'.ctktno'),EVALUATE(loFormSet.lcApVInvDt+'.cIMTyp')+;
          EVALUATE(loFormSet.lcApVInvDt+'.ctktno'))+SPACE(4)+SPACE(19)+;
          EVALUATE(loFormSet.lcApVInvDt+'.cOprCode')+SPACE(6)+SPACE(10)+;
          EVALUATE(loFormSet.lcAPInvTkt+'.cRSession')+SPACE(6)

        *CBOMTYPE+CIMTYP+CTKTNO+CINVTYPE+ITEM+MFGCODE+CWARECODE+CDYELOT+CRSESSION+CISESSION
        =loFormSet.BOMCOST.SEEK(EVALUATE(loFormSet.lcApVInvDt+'.cbomtype')+;
          IIF(EVALUATE(loFormSet.lcApVInvDt+'.cIMTyp')="S","I"+EVALUATE(lcApInvTkt+'.ctktno'),;
          EVALUATE(loFormSet.lcApVInvDt+'.cIMTyp')+EVALUATE(loFormSet.lcApVInvDt+'.ctktno'))+;
          SPACE(4)+SPACE(19)+;
          EVALUATE(loFormSet.lcApVInvDt+'.cOprCode')+SPACE(6)+SPACE(10)+;
          EVALUATE(loFormSet.lcAPInvTkt+'.cRSession')+SPACE(6)) &&Sql59: Check Key

        LOCATE ALL FOR cVendCode+cApInvNo = PADR(loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE,8)+PADR(loFormSet.AriaForm1.kbInvNo.KeyTextBox.VALUE,12)

        DO CASE
          CASE !llDeleted AND !FOUND()
            IF !SEEK(IIF(EVALUATE(loFormSet.lcApVInvDt+'.cIMTyp')="S","I",EVALUATE(loFormSet.lcApVInvDt+'.cIMTyp'))+;
                IIF(EVALUATE(loFormSet.lcApVInvDt+'.cIMTyp')="S", EVALUATE(loFormSet.lcApInvTkt+'.ctktno') ,EVALUATE(loFormSet.lcApVInvDt+'.ctktno') )+;
                'Y'+EVALUATE(loFormSet.lcApVInvDt+'.cbomtype')+SPACE(4)+SPACE(19)+EVALUATE(loFormSet.lcApVInvDt+'.cOprCode')+;
                SPACE(LEN(COPRCODE))+SPACE(LEN(CLOTNO))+SPACE(LEN(CISESSION))+EVALUATE(loFormSet.lcAPInvTkt+'.cRSession')+;
                PADR(loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE,8)+PADR(loFormSet.AriaForm1.kbInvNo.KeyTextBox.VALUE,12), ;
                loFormSet.BOMCOST.lcCursorUpdate)

              loFormSet.BOMCOST.APPEND('REPLACE CBOMTYPE  WITH ""')

            ENDIF

            SELECT (loFormSet.BOMCOST.lcCursorUpdate)
            *B608489,1 WAM 03/23/2008 Fix updating total quantity in bomcost
            *REPLACE CBOMTYPE  WITH EVALUATE(loFormSet.lcApVInvDt+'.cbomtype') ,;
            CIMTYP    WITH IIF(EVALUATE(loFormSet.lcApVInvDt+'.cIMTyp')="S","I",EVALUATE(loFormSet.lcApVInvDt+'.cIMTyp')) ,;
            CTKTNO    WITH IIF(EVALUATE(loFormSet.lcApVInvDt+'.cIMTyp')="S", EVALUATE(loFormSet.lcApInvTkt+'.ctktno') ,EVALUATE(loFormSet.lcApVInvDt+'.ctktno') ),;
            CINVTYPE  WITH ''  ,;
            ITEM      WITH ''                    ,;
            MFGCODE   WITH EVALUATE(loFormSet.lcApVInvDt+'.cOprCode') ,;
            CWARECODE WITH ''                    ,;
            CDYELOT   WITH ''                    ,;
            CRSESSION WITH EVALUATE(loFormSet.lcAPInvTkt+'.cRSession'),;
            CVENDCODE WITH loFormSet.AriaForm1.KBVendCode.KeyTextBox.Value ,;
            CAPINVNO  WITH loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value ,;
            CISESSION WITH ''        ,;
            SHIPNO    WITH ''        ,;
            DTRANDATE WITH loFormSet.AriaForm1.DtPostDate.Value,;
            CCOSTTYPE WITH EVALUATE(loFormSet.lcApVInvDt+'.cCostType') ,;
            NTOTQTY   WITH EVALUATE(loFormSet.lcAPInvTkt+'.nApTAplQty') ,;
            NTOTCST   WITH EVALUATE(loFormSet.lcAPInvTkt+'.nApAplAmnt') ,;
            NUNITCST  WITH IIF(NTOTQTY=0,0,NTOTCST/NTOTQTY)  ,;
            NTOTACST  WITH NTOTCST  ,;
            NUNITACST WITH NUNITCST ,;
            Actualize WITH 'Y' &&Sql60: ICLR Field not found
            REPLACE CBOMTYPE  WITH EVALUATE(loFormSet.lcApVInvDt+'.cbomtype') ,;
              CIMTYP    WITH IIF(EVALUATE(loFormSet.lcApVInvDt+'.cIMTyp')="S","I",EVALUATE(loFormSet.lcApVInvDt+'.cIMTyp')) ,;
              CTKTNO    WITH IIF(EVALUATE(loFormSet.lcApVInvDt+'.cIMTyp')="S", EVALUATE(loFormSet.lcApInvTkt+'.ctktno') ,EVALUATE(loFormSet.lcApVInvDt+'.ctktno') ),;
              CINVTYPE  WITH ''  ,;
              ITEM      WITH ''                    ,;
              MFGCODE   WITH EVALUATE(loFormSet.lcApVInvDt+'.cOprCode') ,;
              CWARECODE WITH ''                    ,;
              CDYELOT   WITH ''                    ,;
              CRSESSION WITH EVALUATE(loFormSet.lcAPInvTkt+'.cRSession'),;
              CVENDCODE WITH loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE ,;
              CAPINVNO  WITH loFormSet.AriaForm1.kbInvNo.KeyTextBox.VALUE ,;
              CISESSION WITH ''        ,;
              SHIPNO    WITH ''        ,;
              DTRANDATE WITH loFormSet.AriaForm1.DtPostDate.VALUE,;
              CCOSTTYPE WITH EVALUATE(loFormSet.lcApVInvDt+'.cCostType') ,;
              NTOTQTY   WITH NTOTQTY+EVALUATE(loFormSet.lcAPInvTkt+'.nApTAplQty') ,;
              NTOTCST   WITH NTOTCST+EVALUATE(loFormSet.lcAPInvTkt+'.nApAplAmnt') ,;
              NUNITCST  WITH IIF(NTOTQTY=0,0,NTOTCST/NTOTQTY)  ,;
              NTOTACST  WITH NTOTCST  ,;
              NUNITACST WITH NUNITCST ,;
              Actualize WITH 'Y' &&Sql60: ICLR Field not found
            *B608489,1 WAM 03/23/2008 (End)
            SELECT BOMCOST

          CASE !llDeleted AND FOUND()

            loFormSet.BOMCOST.REPLACE()
            SELECT (loFormSet.BOMCOST.lcCursorUpdate)
            REPLACE NTOTQTY   WITH NTOTQTY - IIF(lnRecNo=0,0,APINVTKT.nApTAplQty) + EVALUATE(loFormSet.lcAPInvTkt+'.nApTAplQty') ,;
              NTOTCST   WITH NTOTCST - IIF(lnRecNo=0,0,APINVTKT.nApAplAmnt) + EVALUATE(loFormSet.lcAPInvTkt+'.nApAplAmnt') ,;
              NUNITCST  WITH IIF(NTOTQTY=0,0,NTOTCST/NTOTQTY)  ,;
              NTOTACST  WITH NTOTCST  ,;
              NUNITACST WITH NUNITCST ,;
              Actualize WITH 'Y'
            SELECT BOMCOST

          CASE llDeleted AND FOUND()
            *Fix the contribution process [Begin]
            *DELETE
            loFormSet.BOMCOST.REPLACE()
            SELECT (loFormSet.BOMCOST.lcCursorUpdate)
            REPLACE NTOTQTY   WITH NTOTQTY -  IIF(lnRecNo=0,0,EVALUATE(loFormSet.lcAPInvTkt+'.nApTAplQty')) ,;
              NTOTCST   WITH NTOTCST -  IIF(lnRecNo=0,0,EVALUATE(loFormSet.lcAPInvTkt+'.nApAplAmnt')) ,;
              NUNITCST  WITH IIF(NTOTQTY=0,0,NTOTCST/NTOTQTY)  ,;
              NTOTACST  WITH NTOTCST  ,;
              NUNITACST WITH NUNITCST ,;
              Actualize WITH 'Y'
            IF NTOTQTY = 0
              DELETE
            ENDIF
            SELECT BOMCOST
            *Fix the contribution process [End]
        ENDCASE
      ENDSCAN
    ENDIF
  ENDSCAN
  SELECT (loFormSet.lcApVInvDt)
  DELETE ALL FOR INLIST(cStatus,'D','S')
  SELECT (loFormSet.lcAPInvTkt)
  DELETE ALL FOR INLIST(cStatus,'D','S')
  *Update Invoice Details File
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *=gfTmp2Mast('APVINVDT',loFormSet.lcApVInvDt)
  =lfTmp2Mast('APVINVDT',loFormSet.lcApVInvDt)
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  *Update Invoice Applied Tickets File
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *=gfTmp2Mast('APINVTKT',loFormSet.lcAPInvTkt)
  =lfTmp2Mast('APINVTKT',loFormSet.lcAPInvTkt)
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]


  *Set the approperiate tag
  SET ORDER TO TAG (loFormSet.lcAPInvTkt) IN (loFormSet.lcAPInvTkt)
  SET EXACT &lcExStatus

  RETURN
  *-- End of lfUpdFiles


  *!*************************************************************
  *! Name      : lfUpdPoHAC
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 8/16/2004
  *! Purpose   : To update the actual cost in the poshdr file in case
  *!             of invoicing by shipment.
  *!*************************************************************
  *! Parameters: The FormSet
  *!*************************************************************
  *! Returns   : None
  *!*************************************************************
FUNCTION lfUpdPoHAC
  LPARAMETERS loFormSet

  PRIVATE lnAlias

  lnAlias = SELECT()

  IF !EMPTY(lcHdrFile)
    *-- Scan the corresponding records in the detail file (lcAPInvTkt) with
    *-- receiving session not empty.
    SELECT (loFormSet.lcAPInvTkt)



    SCAN REST;
        WHILE cVendCode + cApInvNo + cApVILNo = EVALUATE(loFormSet.lcApVInvDt+'.cVendCode') +;
        EVALUATE(loFormSet.lcApVInvDt+'.cApInvNo') + EVALUATE(loFormSet.lcApVInvDt+'.cAPVILNo')


      *-- Flag to know if the record has been deleted
      llDeleted = (cStatus='D')
      *-- Variable to hold the record number of the corresponding record in
      *-- the master file
      lnRecNo   = nRecNo

      *-- Replace the record pointer on the corresponding record in the
      *-- master file.
      IF BETWEEN(lnRecNo ,1,RECCOUNT('APINVTKT'))
        GO lnRecNo IN APINVTKT
      ENDIF    && End of IF lnRecNo > 0

      lnAmntChng = IIF(llDeleted   , 0 , nApAplAmnt) -;
        IIF(lnRecNo = 0 , 0 , APINVTKT.nApAplAmnt)

      *-- If there is no records for this document number in the actual
      *-- cost temp. header file
      IF !SEEK(m.cIMTyp + cTktNo , loFormSet.lcActCstHd)
        m.cTktNo = cTktNo

        SELECT (lcHdrFile)
        *Old: IF SEEK (lcHKeyVal + m.cTktNo)
        IF loFormSet.&lcHdrFile..SEEK(lcHKeyVal + m.cTktNo) &&Sql25: Check Key
          *-- Attempt to lock the record
          IF .T. && gfObj_Lock(.T.) is not needed
            m.Rec_No = REC_NO  &&Sql26: Check RowID

            *B608412,1 WAM 01/20/2008 Include cost 6 & 7 while add invoice lines
            *STORE 0 TO m.nActCost1  , m.nActCost2  , m.nActCost3 ,;
            m.nActCost4  , m.nActCost5  ,;
            m.nFActCost1 , m.nFActCost2 , m.nFActCost3 ,;
            m.nFActCost4 , m.nFActCost5
            STORE 0 TO m.nActCost1 , m.nActCost2 , m.nActCost3 , m.nActCost4 , m.nActCost5 , m.nActCost6 , m.nActCost7 ,;
              m.nFActCost1, m.nFActCost2, m.nFActCost3, m.nFActCost4, m.nFActCost5, m.nFActCost6, m.nFActCost7
            *B608412,1 WAM 01/20/2008 (End)

            *-- If there is no fields for the actual cost in foreign currency
            IF EMPTY(lcHFActFld)
              *-- Get the actual cost
              FOR lnCount = 1 TO lnActCstNo
                lcCount            = ALLTRIM(STR(lnCount))
                m.nActCost&lcCount = &lcHActFild.&lcCount
              ENDFOR
            ELSE    && Else [If there is fields for the actual cost in foreign currency]
              *-- Get the actual cost
              FOR lnCount = 1 TO lnActCstNo
                lcCount             = ALLTRIM(STR(lnCount))
                m.nActCost&lcCount  = &lcHActFild.&lcCount
                m.nFActCost&lcCount = &lcHFActFld.&lcCount
              ENDFOR
            ENDIF    && End of IF EMPTY(lcHFActFld)

            *-- Add a corresponding record in the temp. file
            INSERT INTO (loFormSet.lcActCstHd) FROM MEMVAR
          ELSE    && Else [If the attempt to lock the record failed]
            llReturn = .F.
          ENDIF    && End of IF gfObj_Lock(.T.)
        ENDIF
      ENDIF    && End of IF !SEEK(m.cIMTyp + cTktNo , loFormSet.lcActCstHd)

      *-- Update total actual cost in the temp. header file
      SELECT (loFormSet.lcActCstHd)
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *!*	    lcTemp = '(lnAmntChng'+loFormSet.lcExSin1+'loFormSet.AriaForm1.txtNexRate.Value'+;
      *!*	             loFormSet.lcExSin2+'apinvhdr.ncurrunit)'
      lcTemp = '(lnAmntChng'+loFormSet.lcExSin1+'loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.Value'+;
        loFormSet.lcExSin2+'apinvhdr.ncurrunit)'
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      REPLACE nActCost&lcBomType WITH nActCost&lcBomType + &lcTemp

      *-- Update total actual cost in foreign currency in the temp. header
      *-- file
      IF !EMPTY(lcHFActFld)
        REPLACE nFActCost&lcBomType WITH nFActCost&lcBomType + lnAmntChng
      ENDIF    && End of IF !EMPTY(lcHFActFld)
    ENDSCAN
  ENDIF    && End of IF !EMPTY(lcHdrFile)

  SELECT (loFormSet.lcApVInvDt)
  =SEEK(cVendCode + cApInvNo + cAPVILNo , loFormSet.lcAPInvTkt)

  SELECT (lnAlias)

  RETURN
  *-- End of lfUpdPoHAC

  *!*************************************************************
  *! Name      : lfUnLckPOF
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 8/16/2004
  *! Purpose   : To unlock the records that we have locked
  *!             in the PO files and CT files (POSHDR, POSLN,
  *!             CUTTKTH, CUTTKTL, POFHDR and POFLN).
  *!*************************************************************
  *! Parameters: The FormSet
  *!*************************************************************
  *! Returns   : None
  *!*************************************************************
FUNCTION lfUnLckPOF
  LPARAMETERS loFormSet

  PRIVATE lcFile , lcIMTyp , lnRecNo

  *-- Unlock the header files [Begin]
  SELECT (loFormSet.lcActCstHd)
  GO TOP

  DO WHILE !EOF()
    STORE '' TO lcFile , lcIMTyp

    *-- Get the name of the header file of the current document type to
    *-- unlock the records that had been locked in it
    DO CASE
        *-- Case of document types "Style Purchase Order" and "Style Purchase
        *-- Order Return"

      CASE INLIST(cIMTyp , 'I' , 'R','S')

        lcFile = 'POSHDR'
        *-- Case of document type "Cutting Ticket"
      CASE cIMTyp = 'M'
        lcFile = 'CUTTKTH'
        *-- Case of document types "Material PO" and "Material PO Return"
      CASE INLIST(cIMTyp , 'L' , 'F')
        lcFile = 'POFHDR'
        *Add Adorment order to invoice line [Begin]
      CASE INLIST(cIMTyp , 'A','D')
        lcFile = 'POSHDR'
        *Add Adorment order to invoice line [end]
    ENDCASE

    lcIMTyp = cIMTyp

    *-- Scan while the document type didn't change
    SCAN WHILE cIMTyp = lcIMTyp

      *-- Unlock the records that had been locked in the master file
      lnRecNo = Rec_No
      SELECT (lcFile)
      *GO lnRecNo
      LOCATE FOR Rec_No = lnRecNo
      =gfObj_Lock(.F.)
      SELECT (loFormSet.lcActCstHd)
    ENDSCAN
  ENDDO

  *-- Erase the actual cost header temp. file
  USE

  *-- Unlock the header files [End]

  *-- Unlock the detail files [Begin]
  SELECT (loFormSet.lcActCstDt)
  GO TOP

  DO WHILE !EOF()
    STORE '' TO lcFile , lcIMTyp

    *-- Get the name of the detail file for the current document type to
    *-- unlock the records that had been locked in it
    DO CASE
        *-- Case of document types "Style Purchase Order" and "Style Purchase
        *-- Order Return"
      CASE INLIST(cIMTyp , 'I' , 'R' , 'S')
        lcFile = 'POSLN'
        *-- Case of document type "Cutting Ticket"
      CASE cIMTyp = 'M'
        lcFile = 'CUTTKTL'
        *-- Case of document types "Material PO" and "Material PO Return"
      CASE INLIST(cIMTyp , 'L' , 'F')
        lcFile = 'POFLN'
        *E301995,1 Alb Add Adorment order to invoice line [Begin]
      CASE INLIST(cIMTyp , 'A','D')
        lcFile = 'POSLN'
        *E301995,1 Alb Add Adorment order to invoice line [end]
    ENDCASE

    lcIMTyp = cIMTyp

    *-- Scan while the document type didn't change
    SCAN WHILE cIMTyp = lcIMTyp

      *-- Unlock the records that had been locked in the master file
      lnRecNo = Rec_No
      SELECT (lcFile)
      *GO lnRecNo
      LOCATE FOR Rec_No = lnRecNo
      =gfObj_Lock(.F.)
      SELECT (loFormSet.lcActCstDt)
    ENDSCAN
  ENDDO

  *-- Erase the actual cost detail temp. file
  USE

  *-- Unlock the detail files [End]


  RETURN
  *-- End of lfUnLckPOF


  *!*************************************************************
  *! Name      : lfVAdjust
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 8/16/2004
  *! Purpose   : To Void invoice adjustment
  *!*************************************************************
  *! Parameters: The FormSet
  *!*************************************************************
  *! Returns   : None
  *!*************************************************************
FUNCTION lfVAdjust
  LPARAMETERS loFormSet

  WAIT 'Voiding Previous adjustment...' WINDOW NOWAIT

  *check for Adjustment if Positive or Negative. [Begin]
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *IF ApInvHdr.nInvAdj <> 0 AND SEEK(PADR(loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value,12)+PADR(loFormSet.AriaForm1.KBVendCode.KeyTextBox.Value,8)+'H','APDIST')
  IF ApInvHdr.nInvAdj <> 0 AND gfSEEK(PADR(loFormSet.AriaForm1.kbInvNo.KeyTextBox.VALUE,12)+PADR(loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE,8)+'H','APDIST')
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    *check for Adjustment if Positive or Negative. [End]
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *  =SEEK(PADR(loFormSet.AriaForm1.KBVendCode.KeyTextBox.Value,8),'ApVendor')
    =gfSEEK(PADR(loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE,8),'ApVendor')
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    SELECT APDIST
    LOCATE REST WHILE cInvNo+cVendCode+cApdtrtyp = PADR(loFormSet.AriaForm1.kbInvNo.KeyTextBox.VALUE,12)+PADR(loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE,8)+'H' ;
      FOR   cApDActId='C' AND cAPDStat <> 'V' AND ;
      nApDAmnt =0   AND LEFT(cApDRef,3)='ADJ'
    lcApDRef = cApDRef
    SELECT ApPaymnt
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *  =SEEK('P'+ApDIST.cApDTRTYP+APDIST.cApDRef)
    =gfSEEK('P'+ApDIST.cApDTRTYP+APDIST.cApDRef)
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    LOCATE REST WHILE cpaytype+cpaymeth+cpaydocno+cbnkcode+cchkacct = ;
      'P'+ApDIST.cApDTRTYP+APDIST.cApDRef ;
      FOR cPayClNo = PADR(loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE,8) AND cPayStat <> 'V' AND nPayAmnt = 0
    IF FOUND()
      SELECT APDIST
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *=SEEK(PADR(loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value,12)+PADR(loFormSet.AriaForm1.KBVendCode.KeyTextBox.Value,8)+'H')
      =gfSEEK(PADR(loFormSet.AriaForm1.kbInvNo.KeyTextBox.VALUE,12)+PADR(loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE,8)+'H')
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      SCAN REST WHILE cInvNo+cVendCode+cApdtrtyp = PADR(loFormSet.AriaForm1.kbInvNo.KeyTextBox.VALUE,12)+PADR(loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE,8)+'H' ;
          FOR   cAPDStat <> 'V' AND cApDRef = lcApDRef
        =RLOCK()
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        *REPLACE cAPDStat WITH 'V'
        gfREPLACE("cAPDStat WITH 'V'")
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
        UNLOCK
        SCATTER MEMVAR
        IF m.cApDActId='J'
          SELECT ApInvHdr
          =RLOCK()
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
          * REPLACE nInvAdj WITH nInvAdj + m.nApDAmnt
          gfREPLACE("nInvAdj WITH nInvAdj + m.nApDAmnt")
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
          UNLOCK
          SELECT ApVendor
          =RLOCK()
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
          *REPLACE nVenBal WITH nVenBal - m.nApDAmnt
          gfREPLACE("nVenBal WITH nVenBal - m.nApDAmnt")
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
          UNLOCK
          SELECT ApVenHst
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
          *=SEEK(PADR(loFormSet.AriaForm1.KBVendCode.KeyTextBox.Value,8)+loFormSet.lcDistYer)
          =gfSEEK(PADR(loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE,8)+loFormSet.lcDistYer)
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
          =RLOCK()
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
          *REPLACE nVnHAdj WITH nVnHAdj + m.nApDAmnt
          gfREPLACE('nVnHAdj WITH nVnHAdj + m.nApDAmnt')
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
          UNLOCK
        ENDIF
        m.nApDAmnt = -m.nApDAmnt
        m.nEqvAmnt = -m.nEqvAmnt
        m.cStatus  = 'A'
        INSERT INTO (loFormSet.lcTmpDist) FROM MEMVAR
        =gfAdd_Info(loFormSet.lcTmpDist)
      ENDSCAN
      SELECT ApPaymnt
      =RLOCK()
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *    REPLACE cPayStat  WITH 'V' ,;
      dPayVDate WITH oAriaApplication.SystemDate
      gfREPLACE("cPayStat  WITH 'V' ,"+;
        "dPayVDate WITH oAriaApplication.SystemDate")
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      
      UNLOCK
      *! B130111,1 ASM 11/01/2005 Allow the User to Edit an Invoice whose posted date is locked, but make entries on system date [Start]
      IF loFormSet.llLokPer
        lfCheckTmpDist(loFormSet)
      ENDIF
      *! B130111,1 ASM 11/01/2005 Allow the User to Edit an Invoice whose posted date is locked, but make entries on system date [End]
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *=gfTmp2Mast('APDIST',loFormSet.lcTmpDist)
      =lfTmp2Mast('APDIST',loFormSet.lcTmpDist)
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    ENDIF
  ENDIF
  WAIT CLEAR

  RETURN
  *-- End of lfVAdjust


  *!*************************************************************
  *! Name      : lfGetAdjNo
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 8/16/2004
  *! Purpose   : To Get next adjustment number
  *!*************************************************************
  *! Parameters: The FormSet
  *!*************************************************************
  *! Returns   : None
  *!*************************************************************
FUNCTION lfGetAdjNo
  LPARAMETERS loFormSet

  PRIVATE lnLastAdj,lcLastAdj

  SELECT MAX(SUBSTR(cApdRef,4)),LEFT(capdref,3) AS ADJ FROM APDIST ;
    WHERE cinvno+cvendcode+capdtrtyp=PADR(loFormSet.AriaForm1.kbInvNo.KeyTextBox.VALUE,12)+PADR(loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE,8)+'H' AND;
    LEFT(capdref,3)='ADJ' GROUP BY ADJ INTO ARRAY lcLastAdj
  IF _TALLY = 0
    lcLastAdj = '0'
  ENDIF
  lnLastAdj = INT(VAL(lcLastAdj))+1
  DO WHILE .T.
    SELECT ApPaymnt
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *  =SEEK('P'+ApInvHdr.cVenPMeth+'ADJ'+PADL(lnLastAdj,5,'0'))
    =gfSEEK('P'+ApInvHdr.cVenPMeth+'ADJ'+PADL(lnLastAdj,5,'0'))
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    LOCATE REST WHILE cpaytype+cpaymeth+cpaydocno+cbnkcode+cchkacct = ;
      'P'+'H'+'ADJ'+PADL(lnLastAdj,5,'0') ;
      FOR   cPayClNo = PADR(loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE,8)
    *Incorect paymnt method in appaymnt file
    IF FOUND()
      lnLastAdj = lnLastAdj +1
    ELSE
      EXIT
    ENDIF
  ENDDO

  RETURN('ADJ'+PADL(lnLastAdj,5,'0'))
  *-- End of lfGetAdjNo


  *!*************************************************************
  *! Name      : lfUpDatPOF
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 8/16/2004
  *! Purpose   : To Update the PO files and CT files
  *!             (POSHDR, POSLN, CUTTKTH, CUTTKTL, POFHDR and POFLN).
  *!*************************************************************
  *! Parameters: The FormSet
  *!*************************************************************
  *! Returns   : None
  *!*************************************************************
FUNCTION lfUpdatPOF
  LPARAMETERS loFormSet

  PRIVATE lcFile , lcIMTyp , lnRecNo , lcScatFlds , lcGathFlds , laScatVal

  *-- Update and unlock the header files [Begin]
  SELECT (loFormSet.lcActCstHd)
  GO TOP

  DO WHILE !EOF()
    STORE '' TO lcFile , lcIMTyp , lcScatFlds , lcGathFlds
    DIMENSION laScatVal[1]
    laScatVal = 0

    *-- Get the name of the header file, the scatter fields and the gather
    *-- fields for the current document type to update it and unlock the
    *-- records that had been locked.
    DO CASE
        *-- Case of document types "Style Purchase Order" and "Style Purchase
        *-- Order Return" and "Shipment"

      CASE INLIST(cIMTyp , 'I' , 'R','S')

        lcFile     = 'POSHDR'
        *B608412,1 WAM 01/20/2008 Include cost 6 & 7 while add invoice lines
        *lcScatFlds = 'nActCost1 , nActCost2 , nActCost3 , nActCost4 , nActCost5 , '+;
        'nFActCost1 , nFActCost2 , nFActCost3, nFActCost4 , nFActCost5'
        *lcGathFlds = 'nAct_Cost1 , nAct_Cost2 , nAct_Cost3 , nAct_Cost4 , nAct_Cost5 , '+;
        'nFActCost1 , nFActCost2 , nFActCost3, nFActCost4 , nFActCost5'
        lcScatFlds = 'nActCost1, nActCost2, nActCost3, nActCost4, nActCost5, nActCost6, nActCost7,'+;
          'nFActCost1, nFActCost2, nFActCost3, nFActCost4, nFActCost5, nFActCost6, nFActCost7'
        lcGathFlds = 'nAct_Cost1, nAct_Cost2, nAct_Cost3, nAct_Cost4, nAct_Cost5, nAct_Cost6, nAct_Cost7,'+;
          'nFActCost1, nFActCost2, nFActCost3, nFActCost4, nFActCost5, nFActCost6, nFActCost7'
        *B608412,1 WAM 01/20/2008 (End)

        *-- Case of document type "Cutting Ticket"
      CASE cIMTyp = 'M'
        lcFile = 'CUTTKTH'
        *B608412,1 WAM 01/20/2008 Include cost 6 & 7 while add invoice lines
        *lcScatFlds = 'nActCost1 , nActCost2 , nActCost3 , nActCost4 , nActCost5 , '+;
        'nFActCost1 , nFActCost2 , nFActCost3, nFActCost4 , nFActCost5'
        *lcGathFlds = 'nAct_Cost1 , nAct_Cost2 , nAct_Cost3 , nAct_Cost4 , nAct_Cost5 , '+;
        'nFActCost1 , nFActCost2 , nFActCost3, nFActCost4 , nFActCost5'
        lcScatFlds = 'nActCost1 , nActCost2 , nActCost3 , nActCost4 , nActCost5 , nActCost6 , nActCost7 , '+;
          'nFActCost1, nFActCost2, nFActCost3, nFActCost4, nFActCost5, nFActCost6, nFActCost7'
        lcGathFlds = 'nAct_Cost1, nAct_Cost2, nAct_Cost3, nAct_Cost4, nAct_Cost5, nAct_Cost6, nAct_Cost7,'+;
          'nFActCost1, nFActCost2, nFActCost3, nFActCost4, nFActCost5, nFActCost6, nFActCost7'
        *B608412,1 WAM 01/20/2008 (End)

        *-- Case of document types "Material PO" and "Material PO Return"
      CASE INLIST(cIMTyp , 'L' , 'F')
        lcFile = 'POFHDR'
        lcScatFlds = 'nActCost1 , nActCost2 , nActCost3 , nActCost4 , nActCost5 , '+;
          'nFActCost1 , nFActCost2 , nFActCost3, nFActCost4 , nFActCost5'

        lcGathFlds = 'nAct_Cost1 , nAct_Cost2 , nAct_Cost3 , nAct_Cost4 , nAct_Cost5 , '+;
          'nFActCost1 , nFActCost2 , nFActCost3, nFActCost4 , nFActCost5'
        *ALB Fix the contribution process  to save the invoice [Begin]
        *-- Case of document type "Material Cutting Ticket"
      CASE cIMTyp = 'T'
        lcFile = 'MMFGORDH'
        lcScatFlds = 'nActCost1 , nActCost2 , nActCost3 , nActCost4 , nActCost5 , '+;
          'nFActCost1 , nFActCost2 , nFActCost3, nFActCost4 , nFActCost5'

        lcGathFlds = 'nAct_Cost1 , nAct_Cost2 , nAct_Cost3 , nAct_Cost4 , nAct_Cost5 , '+;
          'nFActCost1 , nFActCost2 , nFActCost3, nFActCost4 , nFActCost5'
        *Fix the contribution process  to save the invoice [End]
        *Add Adorment order to invoice line [Begin]
      CASE INLIST(cIMTyp , 'A','D')
        lcFile     = 'POSHDR'
        lcScatFlds = 'nActCost1 , nActCost2 , nActCost3 , nActCost4 , nActCost5 , '+;
          'nFActCost1 , nFActCost2 , nFActCost3, nFActCost4 , nFActCost5'

        lcGathFlds = 'nAct_Cost1 , nAct_Cost2 , nAct_Cost3 , nAct_Cost4 , nAct_Cost5 , '+;
          'nFActCost1 , nFActCost2 , nFActCost3, nFActCost4 , nFActCost5'
        *Add Adorment order to invoice line [end]
    ENDCASE

    lcIMTyp = cIMTyp
    *-- Scan while the document type didn't change
    SCAN WHILE cIMTyp = lcIMTyp

      *-- Update the records of the master file
      SCATTER FIELDS &lcScatFlds TO laScatVal
      lcRec_No = Rec_No
      SELECT (lcFile)
      *Old: GO lnRecNo
      loFormSet.&lcFile..GoRec(lcRec_No) &&Sql31: Check RowID
      loFormSet.&lcFile..REPLACE()
      SELECT (loFormSet.&lcFile..lcCursorUpdate)
      GATHER FIELDS &lcGathFlds FROM laScatVal
      SELECT (lcFile)
      *-- Unlock the records that had been locked in the master file
      =gfObj_Lock(.F.)
      SELECT (loFormSet.lcActCstHd)
    ENDSCAN
  ENDDO

  *-- Erase the actual cost header temp. file
  USE

  *-- Update and unlock the header files [End]


  *-- Update and unlock the detail files [Begin]
  SELECT (loFormSet.lcActCstDt)
  GO TOP

  DO WHILE !EOF()
    STORE '' TO lcFile , lcIMTyp , lcScatFlds , lcGathFlds
    DIMENSION laScatVal[1]
    laScatVal = 0

    *-- Get the name of the detail file, the scatter fields and the gather
    *-- fields for the current document type to update it and unlock the
    *-- records that had been locked.
    DO CASE
        *-- Case of document types "Style Purchase Order" and "Style Purchase
        *-- Order Return" and "Shipment"

      CASE INLIST(cIMTyp , 'I' , 'R','S')
        *B603738,1 KHM 07/20/2000 (End)

        lcFile     = 'POSLN'
        *B608412,1 WAM 01/20/2008 Include cost 6 & 7 while add invoice lines
        *lcScatFlds = 'nActCost1 , nActCost2 , nActCost3 , nActCost4 , nActCost5 , '+;
        'nFActCost1 , nFActCost2 , nFActCost3, nFActCost4 , nFActCost5'
        *lcGathFlds = 'nAct_Cost1 , nAct_Cost2 , nAct_Cost3 , nAct_Cost4 , nAct_Cost5 , '+;
        'nFActCost1 , nFActCost2 , nFActCost3, nFActCost4 , nFActCost5'

        lcScatFlds = 'nActCost1 , nActCost2 , nActCost3 , nActCost4 , nActCost5 , nActCost6 , nActCost7 ,'+;
          'nFActCost1, nFActCost2, nFActCost3, nFActCost4, nFActCost5, nFActCost6, nFActCost7'
        lcGathFlds = 'nAct_Cost1, nAct_Cost2, nAct_Cost3, nAct_Cost4, nAct_Cost5, nAct_Cost6, nAct_Cost7,'+;
          'nFActCost1, nFActCost2, nFActCost3, nFActCost4, nFActCost5, nFActCost6, nFActCost7'
        *B608412,1 WAM 01/20/2008 (End)

        *-- Case of document type "Cutting Ticket"
      CASE cIMTyp = 'M'
        lcFile = 'CUTTKTL'

        *B608412,1 WAM 01/20/2008 Include cost 6 & 7 while add invoice lines
        *lcScatFlds = 'nActCost1 , nActCost2 , nActCost3 , nActCost4 , nActCost5 , '+;
        'nFActCost1 , nFActCost2 , nFActCost3, nFActCost4 , nFActCost5'
        *lcGathFlds = 'nAct_Cost1 , nAct_Cost2 , nAct_Cost3 , nAct_Cost4 , nAct_Cost5 , '+;
        'nFActCost1 , nFActCost2 , nFActCost3, nFActCost4 , nFActCost5'

        lcScatFlds = 'nActCost1 , nActCost2 , nActCost3 , nActCost4 , nActCost5 , nActCost6 , nActCost7 ,'+;
          'nFActCost1, nFActCost2, nFActCost3, nFActCost4, nFActCost5, nFActCost6, nFActCost7'
        lcGathFlds = 'nAct_Cost1, nAct_Cost2, nAct_Cost3, nAct_Cost4, nAct_Cost5, nAct_Cost6, nAct_Cost7,'+;
          'nFActCost1, nFActCost2, nFActCost3, nFActCost4, nFActCost5, nFActCost6, nFActCost7'
        *B608412,1 WAM 01/20/2008 (End)

        *-- Case of document types "Material PO" and "Material PO Return"
      CASE INLIST(cIMTyp , 'L' , 'F')
        lcFile = 'POFLN'
        lcScatFlds = 'nActCost1 , nActCost2 , nActCost3 , nActCost4 , nActCost5 , '+;
          'nFActCost1 , nFActCost2 , nFActCost3, nFActCost4 , nFActCost5'

        lcGathFlds = 'nAct_Cost1 , nAct_Cost2 , nAct_Cost3 , nAct_Cost4 , nAct_Cost5 , '+;
          'nFActCost1 , nFActCost2 , nFActCost3, nFActCost4 , nFActCost5'
        *-- Case of document type "Material Cutting Ticket"
      CASE cIMTyp = 'T'
        lcFile = 'MMFGORDD'
        lcScatFlds = 'nActCost1 , nActCost2 , nActCost3 , nActCost4 , nActCost5 , '+;
          'nFActCost1 , nFActCost2 , nFActCost3, nFActCost4 , nFActCost5'

        lcGathFlds = 'nAct_Cost1 , nAct_Cost2 , nAct_Cost3 , nAct_Cost4 , nAct_Cost5 , '+;
          'nFActCost1 , nFActCost2 , nFActCost3, nFActCost4 , nFActCost5'
      CASE INLIST(cIMTyp , 'A','D')
        lcFile     = 'POSLN'
        lcScatFlds = 'nActCost1 , nActCost2 , nActCost3 , nActCost4 , nActCost5 , '+;
          'nFActCost1 , nFActCost2 , nFActCost3, nFActCost4 , nFActCost5'

        lcGathFlds = 'nAct_Cost1 , nAct_Cost2 , nAct_Cost3 , nAct_Cost4 , nAct_Cost5 , '+;
          'nFActCost1 , nFActCost2 , nFActCost3, nFActCost4 , nFActCost5'
    ENDCASE

    lcIMTyp = cIMTyp

    *-- Scan while the document type didn't change
    SCAN WHILE cIMTyp = lcIMTyp
      *-- Update the records of the master file
      SCATTER FIELDS &lcScatFlds TO laScatVal
      lcRec_No = Rec_No
      SELECT (lcFile)
      *Old: GO lnRecNo
      loFormSet.&lcFile..GoRec(lcRec_No) &&Sql32: Check RowID
      loFormSet.&lcFile..REPLACE()
      SELECT (loFormSet.&lcFile..lcCursorUpdate)
      GATHER FIELDS &lcGathFlds FROM laScatVal
      SELECT (lcFile)

      *-- Unlock the records that had been locked in the master file
      =gfObj_Lock(.F.)
      SELECT (loFormSet.lcActCstDt)
    ENDSCAN
  ENDDO

  *-- Erase the actual cost detail temp. file
  USE
  *-- Update and unlock the detail files [End]

  RETURN
  *-- End of lfUpDatPOF


  *!*************************************************************
  *! Name      : lfOpenFile
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 8/16/2004
  *! Purpose   : To Open files and store name of files opened
  *!*************************************************************
  *! Parameters: lcFile, lcTag, loFormSet
  *!*************************************************************
  *! Returns   : None
  *!*************************************************************
FUNCTION lfOpenFile
  PARAMETERS lcFile, lcTag, loFormSet
  LOCAL lcSql

  lcFile = UPPER(lcFile)
  lcTag = UPPER(lcTag)

  DO CASE

    CASE lcFile='FABRIC'
      IF TYPE('loFormSet.FABRIC')<>'O'
        loFormSet.FABRIC = CREATEOBJECT("RemoteTable",'Item','Style','Fabric')
      ELSE
        loFormSet.FABRIC.SetOrder('Style')
      ENDIF

    CASE lcFile='FABDYE'
      IF TYPE('loFormSet.FABDYE')<>'O'
        loFormSet.FABDYE = CREATEOBJECT("RemoteTable",'ItemLoc','StyDye','FabDye')
      ELSE
        loFormSet.FABDYE.SetOrder('StyDye')
      ENDIF

    CASE lcFile='SHPMTHDR'
      IF TYPE('loFormSet.SHPMTHDR')<>'O'
        loFormSet.SHPMTHDR = CREATEOBJECT("RemoteTable",lcFile,lcTag,lcFile)
      ELSE
        loFormSet.SHPMTHDR.SetOrder(lcTag)
      ENDIF

    CASE lcFile='MFGOPRDT'
      IF TYPE('loFormSet.MFGOPRDT')<>'O'
        loFormSet.MFGOPRDT = CREATEOBJECT("RemoteTable",lcFile,lcTag,lcFile)
      ELSE
        loFormSet.MFGOPRDT.SetOrder(lcTag)
      ENDIF

    CASE lcFile='POSHDR'
      IF TYPE('loFormSet.POSHDR')<>'O'
        loFormSet.POSHDR = CREATEOBJECT("RemoteTable",lcFile,lcTag,lcFile)
      ELSE
        loFormSet.POSHDR.SetOrder(lcTag)
      ENDIF

    CASE lcFile='POSLN'
      IF TYPE('loFormSet.POSLN')<>'O'
        loFormSet.POSLN = CREATEOBJECT("RemoteTable",lcFile,lcTag,lcFile)
      ELSE
        loFormSet.POSLN.SetOrder(lcTag)
      ENDIF

    CASE lcFile='CUTTKTH'
      IF TYPE('loFormSet.CUTTKTH')<>'O'
        loFormSet.CUTTKTH = CREATEOBJECT("RemoteTable",'POSHDR',lcTag,'CUTTKTH')
      ELSE
        loFormSet.CUTTKTH.SetOrder(lcTag)
      ENDIF

    CASE lcFile='CUTTKTL'
      IF TYPE('loFormSet.CUTTKTL')<>'O'
        loFormSet.CUTTKTL = CREATEOBJECT("RemoteTable",'POSLN',lcTag,'CUTTKTL')
      ELSE
        loFormSet.CUTTKTL.SetOrder(lcTag)
      ENDIF

    CASE lcFile='POFHDR'
      IF TYPE('loFormSet.POFHDR')<>'O'
        loFormSet.POFHDR = CREATEOBJECT("RemoteTable",'POSHDR',lcTag,'POFHDR')
      ELSE
        loFormSet.POFHDR.SetOrder(lcTag)
      ENDIF

    CASE lcFile='POFLN'
      IF TYPE('loFormSet.POFLN')<>'O'
        loFormSet.POFLN = CREATEOBJECT("RemoteTable",'POSLN',lcTag,'POFLN')
      ELSE
        loFormSet.POFLN.SetOrder(lcTag)
      ENDIF

    CASE lcFile='MMFGORDH'
      IF TYPE('loFormSet.MMFGORDH')<>'O'
        loFormSet.MMFGORDH = CREATEOBJECT("RemoteTable",'POSHDR',lcTag,'MMFGORDH')
      ELSE
        loFormSet.MMFGORDH.SetOrder(lcTag)
      ENDIF

    CASE lcFile='MMFGORDD'
      IF TYPE('loFormSet.MMFGORDD')<>'O'
        loFormSet.MMFGORDD = CREATEOBJECT("RemoteTable",'POSLN',lcTag,'MMFGORDD')
      ELSE
        loFormSet.MMFGORDD.SetOrder(lcTag)
      ENDIF

    CASE lcFile='BOMCOST'
      IF TYPE('loFormSet.BOMCOST')<>'O'
        loFormSet.BOMCOST = CREATEOBJECT("RemoteTable",lcFile,lcTag,lcFile)
      ELSE
        loFormSet.BOMCOST.SetOrder(lcTag)
      ENDIF

    CASE lcFile='CTKTBOM'
      IF TYPE('loFormSet.CTKTBOM')<>'O'
        loFormSet.CTKTBOM = CREATEOBJECT("RemoteTable",lcFile,lcTag,lcFile)
      ELSE
        loFormSet.CTKTBOM.SetOrder(lcTag)
      ENDIF

    CASE lcFile='BOMLINE'
      IF TYPE('loFormSet.BOMLINE')<>'O'
        loFormSet.BOMLINE = CREATEOBJECT("RemoteTable",lcFile,lcTag,lcFile)
      ELSE
        loFormSet.BOMLINE.SetOrder(lcTag)
      ENDIF

    OTHERWISE
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *gfOpenFile(oAriaApplication.DataDir+lcFile,lcTag,'SH')
      gfOpenTable(lcFile,lcTag,'SH')
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  ENDCASE

  RETURN
  *-- End of lfOpenFile

  *!*************************************************************
  *! Name      : lfUpdShip
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 8/16/2004
  *! Purpose   : To Update cTktBom,BomCost and BomLine in case of Shipment
  *!*************************************************************
  *! Parameters: The FormSet
  *!*************************************************************
  *! Returns   : None
  *!*************************************************************
FUNCTION lfUpdShip
  LPARAMETERS loFormSet

  PRIVATE lcInvDtKey , lnRecNo , llDeleted , lcOrder

  SELECT BOMLINE
  lcOrder =  ORDER()
  *Old: SET ORDER TO (lcOrder)
  *Old: SET ORDER TO TAG Bomshrec
  loFormSet.BOMLINE.SetOrder('Bomshrec') &&Sql42: Check Tag ;
  *CIMTYP+CTYPE+CBOMTYP+MFGCODE+SHIPNO+CRSESSION+CTKTNO+STR(LINENO,6)+CINVTYPE+STYLE+CSTYGRADE ;
  (CIMTYP+CTYPE+CBOMTYP+MFGCODE+SHIPNO+CRSESSION+CTKTNO+STR(LINENO,6)+STYLE+SCLR+CSTYGRADE)

  lcInvDtKey= EVALUATE(loFormSet.lcApVInvDt+'.cVendCode')+EVALUATE(loFormSet.lcApVInvDt+'.cApInvNo')+;
    EVALUATE(loFormSet.lcApVInvDt+'.cAPVILNo')
  llDeleted = (EVALUATE(loFormSet.lcApVInvDt+'.cStatus')='D')
  lnRecNo   = EVALUATE(loFormSet.lcApVInvDt+'.nRecNo')

  SELECT (loFormSet.lcApVInvDt)
  IF lnRecNo > 0  AND BETWEEN( lnRecNo , 1 , RECCOUNT('APVINVDT'))
    SELECT APVINVDT
    GO lnRecNo
  ENDIF

  SELECT (loFormSet.lcAPInvTkt)
  =SEEK(lcInvDtKey)
  SCAN REST  WHILE cVendCode+cApInvNo+cAPVILNo= lcInvDtKey FOR EVALUATE(loFormSet.lcAPInvTkt+'.cStatus') <> 'S'
    SELECT (loFormSet.lcAPInvTkt)
    llDeleted = (EVALUATE(loFormSet.lcApVInvDt+'.cStatus')='D')
    lnRecNo   =  EVALUATE(loFormSet.lcApVInvDt+'.nRecNo')

    * Go to the corresponding record in master file in case of deleted line.
    IF BETWEEN(EVALUATE(loFormSet.lcAPInvTkt+'.nRecNo'),1,RECCOUNT('APInvTkt'))
      GO EVALUATE(loFormSet.lcAPInvTkt+'.nRecNo') IN APINVTKT
    ENDIF
    *CIMTYP+CUTTKT+TYP+CINVTYPE+ITEM+MFGCODE+DYELOT
    IF loFormSet.cTktBom.SEEK("I"+EVALUATE(loFormSet.lcAPInvTkt+'.ctktno')+EVALUATE(loFormSet.lcApVInvDt+'.cbomtype')+;
        SPACE(4)+SPACE(19)+EVALUATE(loFormSet.lcApVInvDt+'.cOprCode')+SPACE(10)) &&Sql43: Check Key

      SELECT cTktBom
      DO CASE
        CASE EVALUATE(loFormSet.lcAPInvTkt+'.cStatus') ='D' AND EVALUATE(loFormSet.lcAPInvTkt+'.nRecNo') <> 0
          IF BETWEEN(EVALUATE(loFormSet.lcAPInvTkt+'.nRecNo'),1,RECCOUNT('APInvTkt'))
            GO EVALUATE(loFormSet.lcAPInvTkt+'.nRecNo') IN APINVTKT
            loFormSet.cTktBom.REPLACE()
            SELECT (loFormSet.cTktBom.lcCursorUpdate)
            REPLACE ISSUE_QTY WITH  MAX(ISSUE_QTY-APInvTkt.nApTAplQty,0 ),;
              USED_QTY  WITH  MAX(ISSUE_QTY-APInvTkt.nApTAplQty,0 )
            SELECT cTktBom
          ENDIF
        CASE EVALUATE(loFormSet.lcAPInvTkt+'.cStatus') ='M' AND EVALUATE(loFormSet.lcAPInvTkt+'.nRecNo') <> 0
          IF BETWEEN(EVALUATE(loFormSet.lcAPInvTkt+'.nRecNo'),1,RECCOUNT('APInvTkt'))
            GO EVALUATE(loFormSet.lcAPInvTkt+'.nRecNo') IN APINVTKT
            loFormSet.cTktBom.REPLACE()
            SELECT (loFormSet.cTktBom.lcCursorUpdate)
            REPLACE ISSUE_QTY WITH (ISSUE_QTY - APInvTkt.nApTAplQty )+ EVALUATE(loFormSet.lcAPInvTkt+'.nApTAplQty'),;
              USED_QTY  WITH (USED_QTY  - APInvTkt.nApTAplQty )+ EVALUATE(loFormSet.lcAPInvTkt+'.nApTAplQty')
            SELECT cTktBom
          ENDIF
        OTHERWISE
          **&lcAPInvTkt..cStatus ='A'
          loFormSet.cTktBom.REPLACE()
          SELECT (loFormSet.cTktBom.lcCursorUpdate)
          REPLACE ISSUE_QTY WITH ISSUE_QTY +  EVALUATE(loFormSet.lcAPInvTkt+'.nApTAplQty'),;
            USED_QTY  WITH USED_QTY  +  EVALUATE(loFormSet.lcAPInvTkt+'.nApTAplQty')
          SELECT cTktBom
      ENDCASE
    ENDIF
    *-- If the Invoice line was deleted or if the uncontributed amount was
    *-- changed.
    IF llDeleted .OR. (EMPTY(EVALUATE(loFormSet.lcAPInvTkt+'.cRSession')) .AND. EVALUATE(loFormSet.lcAPInvTkt+'.cStatus') <> 'S')
      SELECT BOMCOST

      *CBOMTYPE+CIMTYP+CTKTNO+CINVTYPE+ITEM+MFGCODE+CWARECODE+CDYELOT+CRSESSION+CISESSION
      =loFormSet.BOMCOST.SEEK(EVALUATE(loFormSet.lcApVInvDt+'.cbomtype')+"I"+EVALUATE(loFormSet.lcAPInvTkt+'.ctktno')+;
        SPACE(4)+SPACE(19)+EVALUATE(loFormSet.lcApVInvDt+'.cOprCode')+SPACE(6)+SPACE(10)+;
        SPACE(6)+SPACE(6)) &&Sql44: Check Key

      LOCATE ALL FOR cVendCode+cApInvNo = PADR(loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE,8)+PADR(loFormSet.AriaForm1.kbInvNo.KeyTextBox.VALUE,12) &&Sql45: ICLR Field does not exist

      DO CASE
        CASE !llDeleted AND !FOUND() .AND. EVALUATE(loFormSet.lcAPInvTkt+'.cStatus') <> 'D'
          IF !SEEK("I"+EVALUATE(loFormSet.lcAPInvTkt+'.ctktno')+'N'+EVALUATE(loFormSet.lcApVInvDt+'.cbomtype')+;
              SPACE(4)+SPACE(19)+EVALUATE(loFormSet.lcApVInvDt+'.cOprCode')+SPACE(LEN(COPRCODE))+;
              SPACE(LEN(CLOTNO))+SPACE(LEN(CISESSION))+SPACE(LEN(CRSESSION))+;
              PADR(loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE,8)+PADR(loFormSet.AriaForm1.kbInvNo.KeyTextBox.VALUE,12), ;
              loFormSet.BOMCOST.lcCursorUpdate)

            loFormSet.BOMCOST.APPEND('REPLACE CBOMTYPE  WITH ""')

          ENDIF
          SELECT (loFormSet.BOMCOST.lcCursorUpdate)
          *B608651,1 WAM 08/11/2008 Accumulate cost in BOMCOST
          *REPLACE CBOMTYPE  WITH EVALUATE(loFormSet.lcApVInvDt+'.cbomtype') ,;
          CIMTYP    WITH "I"                   ,;
          CTKTNO    WITH EVALUATE(loFormSet.lcAPInvTkt+'.ctktno')   ,;
          CINVTYPE  WITH ''                    ,;
          ITEM      WITH ''                    ,;
          MFGCODE   WITH EVALUATE(loFormSet.lcApVInvDt+'.cOprCode') ,;
          CWARECODE WITH ''                    ,;
          CDYELOT   WITH ''                    ,;
          CRSESSION WITH SPACE(6)  ,;
          CVENDCODE WITH loFormSet.AriaForm1.KBVendCode.KeyTextBox.Value ,;
          CAPINVNO  WITH loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value ,;
          CISESSION WITH ''        ,;
          SHIPNO    WITH ''        ,;
          DTRANDATE WITH loFormSet.AriaForm1.DtPostDate.Value,;
          CCOSTTYPE WITH EVALUATE(loFormSet.lcApVInvDt+'.cCostType')  ,;
          NTOTQTY   WITH EVALUATE(loFormSet.lcAPInvTkt+'.nAPTAplQty') -;
          IIF(EVALUATE(loFormSet.lcAPInvTkt+'.nRecNo') = 0 , 0 ,;
          APINVTKT.nAPTAplQty) ,;
          NTOTCST   WITH EVALUATE(loFormSet.lcAPInvTkt+'.nAPAplAmnt') -;
          IIF(EVALUATE(loFormSet.lcAPInvTkt+'.nRecNo') = 0 , 0 ,;
          APINVTKT.nAPAplAmnt) ,;
          NUNITCST  WITH EVALUATE(loFormSet.lcAPInvTkt+'.nAPAplPric') -;
          IIF(EVALUATE(loFormSet.lcAPInvTkt+'.nRecNo') = 0 , 0 ,;
          APINVTKT.nAPAplPric) ,;
          NTOTACST  WITH NTOTCST  ,;
          NUNITACST WITH NUNITCST ,;
          Actualize WITH 'N' &&Sql46: ICLR Field does not exist

          REPLACE CBOMTYPE  WITH EVALUATE(loFormSet.lcApVInvDt+'.cbomtype') ,;
            CIMTYP    WITH "I"                   ,;
            CTKTNO    WITH EVALUATE(loFormSet.lcAPInvTkt+'.ctktno')   ,;
            CINVTYPE  WITH ''                    ,;
            ITEM      WITH ''                    ,;
            MFGCODE   WITH EVALUATE(loFormSet.lcApVInvDt+'.cOprCode') ,;
            CWARECODE WITH ''                    ,;
            CDYELOT   WITH ''                    ,;
            CRSESSION WITH SPACE(6)  ,;
            CVENDCODE WITH loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE ,;
            CAPINVNO  WITH loFormSet.AriaForm1.kbInvNo.KeyTextBox.VALUE ,;
            CISESSION WITH ''        ,;
            SHIPNO    WITH ''        ,;
            DTRANDATE WITH loFormSet.AriaForm1.DtPostDate.VALUE,;
            CCOSTTYPE WITH EVALUATE(loFormSet.lcApVInvDt+'.cCostType')  ,;
            NTOTQTY   WITH NTOTQTY + EVALUATE(loFormSet.lcAPInvTkt+'.nAPTAplQty') -;
            IIF(EVALUATE(loFormSet.lcAPInvTkt+'.nRecNo') = 0 , 0 ,;
            APINVTKT.nAPTAplQty) ,;
            NTOTCST   WITH NTOTCST + EVALUATE(loFormSet.lcAPInvTkt+'.nAPAplAmnt') -;
            IIF(EVALUATE(loFormSet.lcAPInvTkt+'.nRecNo') = 0 , 0 ,;
            APINVTKT.nAPAplAmnt) ,;
            NUNITCST  WITH IIF(NTOTQTY=0,0,NTOTCST/NTOTQTY) ,;
            NTOTACST  WITH NTOTCST  ,;
            NUNITACST WITH NUNITCST ,;
            Actualize WITH 'N' &&Sql46: ICLR Field does not exist
          *B608651,1 WAM 08/11/2008 (End)

          SELECT BOMCOST
        CASE !llDeleted AND FOUND()

          loFormSet.BOMCOST.REPLACE()
          SELECT (loFormSet.BOMCOST.lcCursorUpdate)

          REPLACE NTOTQTY   WITH NTOTQTY +;
            IIF(EVALUATE(loFormSet.lcAPInvTkt+'.cStatus') = 'D' , 0 ,;
            EVALUATE(loFormSet.lcAPInvTkt+'.nAPTAplQty')) -;
            IIF(EVALUATE(loFormSet.lcAPInvTkt+'.nRecNo') = 0 , 0 ,;
            APINVTKT.nAPTAplQty) ,;
            NTOTCST   WITH NTOTCST +;
            IIF(EVALUATE(loFormSet.lcAPInvTkt+'.cStatus') = 'D' , 0 ,;
            EVALUATE(loFormSet.lcAPInvTkt+'.nAPAplAmnt')) -;
            IIF(EVALUATE(loFormSet.lcAPInvTkt+'.nRecNo') = 0 , 0 ,;
            APINVTKT.nAPAplAmnt) ,;
            NUNITCST  WITH NUNITCST +;
            IIF(EVALUATE(loFormSet.lcAPInvTkt+'.cStatus ')= 'D' , 0 ,;
            EVALUATE(loFormSet.lcAPInvTkt+'.nAPAplPric')) -;
            IIF(EVALUATE(loFormSet.lcAPInvTkt+'.nRecNo') = 0 , 0 ,;
            APINVTKT.nAPAplPric) ,;
            NTOTACST  WITH NTOTCST  ,;
            NUNITACST WITH NUNITCST
          IF NTOTQTY = 0
            DELETE
          ENDIF
          SELECT BOMCOST

        CASE llDeleted AND FOUND()
          loFormSet.BOMCOST.REPLACE()
          SELECT (loFormSet.BOMCOST.lcCursorUpdate)
          REPLACE NTOTQTY   WITH NTOTQTY -;
            IIF(EVALUATE(loFormSet.lcAPInvTkt+'.nRecNo') = 0 , 0 ,;
            APINVTKT.nAPTAplQty) ,;
            NTOTCST   WITH NTOTCST -;
            IIF(EVALUATE(loFormSet.lcAPInvTkt+'.nRecNo') = 0 , 0 ,;
            APINVTKT.nAPAplAmnt) ,;
            NUNITCST  WITH NUNITCST -;
            IIF(EVALUATE(loFormSet.lcAPInvTkt+'.nRecNo') = 0 , 0 ,;
            APINVTKT.nAPAplPric) ,;
            NTOTACST  WITH NTOTCST  ,;
            NUNITACST WITH NUNITCST

          IF NTOTQTY = 0
            DELETE
          ENDIF
          SELECT BOMCOST
      ENDCASE
    ENDIF    && End of IF EMPTY(&loFormSet.lcAPInvTkt..cRSession) .AND. ...

    SELECT (loFormSet.lcAPInvTkt)
    IF !EMPTY(EVALUATE(loFormSet.lcAPInvTkt+'.cRSession'))
      llDeleted = (cStatus='D')
      lnRecNo = nRecNo
      IF !llDeleted AND BETWEEN(lnRecNo ,1, RECCOUNT('APINVTKT'))
        SELECT APINVTKT
        GO lnRecNo
      ENDIF

      SELECT BomLine
      *CIMTYP+CTYPE+CBOMTYP+MFGCODE+SHIPNO+CRSESSION+CTKTNO+STR(LINENO,6)+CINVTYPE+STYLE+CSTYGRADE
      =loFormSet.BomLine.SEEK("I"+"3"+EVALUATE(loFormSet.lcApVInvDt+'.cBomType')+EVALUATE(loFormSet.lcApVInvDt+'.cOprCode')+;
        EVALUATE(loFormSet.lcApVInvDt+'.shipno')+EVALUATE(loFormSet.lcAPInvTkt+'.cRSession')+;
        EVALUATE(loFormSet.lcApInvTkt+'.ctktno')+;
        STR(EVALUATE(loFormSet.lcApInvTkt+'.LineNo'),6)+;
        '0001'+EVALUATE(loFormSet.lcApInvTkt+'.Item')) &&Sql47: Check Key

      DO CASE
        CASE !llDeleted AND !FOUND()
          loFormSet.BomLine.APPEND('REPLACE cimtyp    WITH "I"')
          SELECT (loFormSet.BomLine.lcCursorUpdate)
          REPLACE cimtyp    WITH "I"                   ,;
            ctype     WITH '3'                   ,;
            cbomtyp   WITH EVALUATE(loFormSet.lcApVInvDt+'.cBomType') ,;
            mfgcode   WITH EVALUATE(loFormSet.lcApVInvDt+'.cOprCode') ,;
            ctktno    WITH EVALUATE(loFormSet.lcAPInvTkt+'.ctktno')   ,;
            crsession WITH EVALUATE(loFormSet.lcAPInvTkt+'.cRSession'),;
            shipno    WITH EVALUATE(loFormSet.lcApVInvDt+'.shipno')   ,;
            LINENO    WITH EVALUATE(loFormSet.lcAPInvTkt+'.LineNo')   ,;
            CINVTYPE  WITH '0001'    ,;
            STYLE     WITH EVALUATE(loFormSet.lcAPInvTkt+'.Item')     ,;
            cCatgTyp  WITH EVALUATE(loFormSet.lcApVInvDt+'.cCostType'),;
            UnitQty   WITH  1 ,;
            StyQty    WITH EVALUATE(loFormSet.lcAPInvTkt+'.nApTAplQty') ,;
            ItemQty   WITH StyQty ,;
            ItemAmt   WITH EVALUATE(loFormSet.lcAPInvTkt+'.nApAplAmnt') ,;
            UnitCost  WITH IIF(ItemQty=0,0,ItemAmt/ItemQty) &&Sql48: SCLR Field does not exist

          * B608833,1 HES 04/01/2009 Add Standared Fields for POMLINE File[T20081001.0001]
          =gfAdd_Info(loFormSet.BomLine.lcCursorUpdate)
          * B608833,1 HES 04/01/2009 Add Standared Fields for POMLINE File[T20081001.0001]

          SELECT BomLine

        CASE !llDeleted AND FOUND()
          loFormSet.BomLine.REPLACE()
          SELECT (loFormSet.BomLine.lcCursorUpdate)
          REPLACE StyQty   WITH StyQty - IIF(lnRecNo=0,0,APINVTKT.nApTAplQty) + EVALUATE(loFormSet.lcAPInvTkt+'.nApTAplQty') ,;
            ItemQty  WITH StyQty ,;
            ItemAmt  WITH ItemAmt -IIF(lnRecNo=0,0,APINVTKT.nApAplAmnt) + EVALUATE(loFormSet.lcAPInvTkt+'.nApAplAmnt') ,;
            UnitCost WITH IIF(ItemQty=0,0,ItemAmt/ItemQty)

          * B608833,1 HES 04/01/2009 Add Standared Fields for POMLINE File[T20081001.0001]
          =gfAdd_Info(loFormSet.BomLine.lcCursorUpdate)
          * B608833,1 HES 04/01/2009 Add Standared Fields for POMLINE File[T20081001.0001]

          SELECT BomLine
        CASE llDeleted AND FOUND()
          *SELECT (loFormSet.BomLine.lcCursorUpdate)
          *DELETE
          loFormSet.BomLine.DELETE()

      ENDCASE

      SELECT BOMCOST
      *CBOMTYPE+CIMTYP+CTKTNO+CINVTYPE+ITEM+MFGCODE+CWARECODE+CDYELOT+CRSESSION+CISESSION
      =loFormSet.BOMCOST.SEEK(EVALUATE(loFormSet.lcApVInvDt+'.cbomtype')+"I"+EVALUATE(loFormSet.lcApInvTkt+'.ctktno')+;
        SPACE(4)+SPACE(19)+EVALUATE(loFormSet.lcApVInvDt+'.cOprCode')+;
        SPACE(6)+SPACE(10)+EVALUATE(loFormSet.lcAPInvTkt+'.cRSession')+SPACE(6)) &&Sql49: Check Key
      LOCATE ALL FOR cVendCode+cApInvNo = PADR(loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE,8)+PADR(loFormSet.AriaForm1.kbInvNo.KeyTextBox.VALUE,12) &&Sql50: ICLR Field not found

      DO CASE
        CASE !llDeleted AND !FOUND()
          IF !SEEK("I"+EVALUATE(loFormSet.lcApInvTkt+'.ctktno')+'Y'+EVALUATE(loFormSet.lcApVInvDt+'.cbomtype')+;
              SPACE(4)+SPACE(19)+EVALUATE(loFormSet.lcApVInvDt+'.cOprCode')+SPACE(LEN(COPRCODE))+;
              SPACE(LEN(CLOTNO))+SPACE(LEN(CISESSION))+EVALUATE(loFormSet.lcAPInvTkt+'.cRSession')+;
              PADR(loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE,8)+PADR(loFormSet.AriaForm1.kbInvNo.KeyTextBox.VALUE,12),;
              loFormSet.BOMCOST.lcCursorUpdate)
            loFormSet.BOMCOST.APPEND('REPLACE CBOMTYPE  WITH ""')
          ENDIF

          SELECT (loFormSet.BOMCOST.lcCursorUpdate)
          *B608651,1 WAM 08/11/2008 Accumulate cost in BOMCOST
          *REPLACE CBOMTYPE  WITH EVALUATE(loFormSet.lcApVInvDt+'.cbomtype') ,;
          CIMTYP    WITH "I"                   ,;
          CTKTNO    WITH EVALUATE(loFormSet.lcApInvTkt+'.ctktno')   ,;
          CINVTYPE  WITH ''                    ,;
          ITEM      WITH ''                    ,;
          MFGCODE   WITH EVALUATE(loFormSet.lcApVInvDt+'.cOprCode') ,;
          CWARECODE WITH ''                    ,;
          CDYELOT   WITH ''                    ,;
          CRSESSION WITH EVALUATE(loFormSet.lcAPInvTkt+'.cRSession'),;
          CVENDCODE WITH loFormSet.AriaForm1.KBVendCode.KeyTextBox.Value ,;
          CAPINVNO  WITH loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value ,;
          CISESSION WITH ''        ,;
          SHIPNO    WITH ''        ,;
          DTRANDATE WITH loFormSet.AriaForm1.DtPostDate.Value,;
          CCOSTTYPE WITH EVALUATE(loFormSet.lcApVInvDt+'.cCostType') ,;
          NTOTQTY   WITH EVALUATE(loFormSet.lcAPInvTkt+'.nApTAplQty') ,;
          NTOTCST   WITH EVALUATE(loFormSet.lcAPInvTkt+'.nApAplAmnt') ,;
          NUNITCST  WITH IIF(NTOTQTY=0,0,NTOTCST/NTOTQTY)  ,;
          NTOTACST  WITH NTOTCST  ,;
          NUNITACST WITH NUNITCST ,;
          Actualize WITH 'Y' &&Sql51: ICLR Field not found

          REPLACE CBOMTYPE  WITH EVALUATE(loFormSet.lcApVInvDt+'.cbomtype') ,;
            CIMTYP    WITH "I"                   ,;
            CTKTNO    WITH EVALUATE(loFormSet.lcApInvTkt+'.ctktno')   ,;
            CINVTYPE  WITH ''                    ,;
            ITEM      WITH ''                    ,;
            MFGCODE   WITH EVALUATE(loFormSet.lcApVInvDt+'.cOprCode') ,;
            CWARECODE WITH ''                    ,;
            CDYELOT   WITH ''                    ,;
            CRSESSION WITH EVALUATE(loFormSet.lcAPInvTkt+'.cRSession'),;
            CVENDCODE WITH loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE ,;
            CAPINVNO  WITH loFormSet.AriaForm1.kbInvNo.KeyTextBox.VALUE ,;
            CISESSION WITH ''        ,;
            SHIPNO    WITH ''        ,;
            DTRANDATE WITH loFormSet.AriaForm1.DtPostDate.VALUE,;
            CCOSTTYPE WITH EVALUATE(loFormSet.lcApVInvDt+'.cCostType') ,;
            NTOTQTY   WITH NTOTQTY + EVALUATE(loFormSet.lcAPInvTkt+'.nApTAplQty') ,;
            NTOTCST   WITH NTOTCST + EVALUATE(loFormSet.lcAPInvTkt+'.nApAplAmnt') ,;
            NUNITCST  WITH IIF(NTOTQTY=0,0,NTOTCST/NTOTQTY)  ,;
            NTOTACST  WITH NTOTCST  ,;
            NUNITACST WITH NUNITCST ,;
            Actualize WITH 'Y' &&Sql51: ICLR Field not found

          *B608651,1 WAM 08/11/2008 (End)
          SELECT BOMCOST
          *B605493,1 SSH 10/Feb/2002 Incorrect update for BOMCOST.DTRANDATE.
        CASE !llDeleted AND FOUND()
          loFormSet.BOMCOST.REPLACE()
          SELECT (loFormSet.BOMCOST.lcCursorUpdate)
          REPLACE NTOTQTY   WITH NTOTQTY - IIF(lnRecNo=0,0,APINVTKT.nApTAplQty) + EVALUATE(loFormSet.lcAPInvTkt+'.nApTAplQty') ,;
            NTOTCST   WITH NTOTCST - IIF(lnRecNo=0,0,APINVTKT.nApAplAmnt) + EVALUATE(loFormSet.lcAPInvTkt+'.nApAplAmnt') ,;
            NUNITCST  WITH IIF(NTOTQTY=0,0,NTOTCST/NTOTQTY)  ,;
            NTOTACST  WITH NTOTCST  ,;
            NUNITACST WITH NUNITCST ,;
            Actualize WITH 'Y'

          SELECT BOMCOST
        CASE llDeleted AND FOUND()
          *SELECT (loFormSet.BOMCOST.lcCursorUpdate)
          *DELETE
          loFormSet.BOMCOST.DELETE()
      ENDCASE
    ENDIF   && End of If !EMPTY(&loFormSet.lcAPInvTkt..cRSession)
  ENDSCAN


  SELECT BOMLINE
  *Old: SET ORDER TO (lcOrder)
  loFormSet.BOMLINE.SetOrder(lcOrder) &&Sql52: Check Tag

  SELECT (loFormSet.lcApVInvDt)

  RETURN
  *-- End of lfUpdShip


  ***SS2

  ***sss***

  ***LLL***

  *!*************************************************************
  *! Name      : lfvInvLines
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 8/30/2004
  *! Purpose   : Called from the Click Event of the cmdInvLines Button.
  *!*************************************************************
  *! Parameters: loFormSet
  *!*************************************************************
  *! Returns   : None
  *!*************************************************************
FUNCTION lfvInvLines
  LPARAMETERS loFormSet
  *Prevent the user from entering the
  *          "Invoice Detail" screen if the company is using multi-currency
  *          and the currency field is empty
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *IF gfGetMemVar('LLMULCURR') .AND. EMPTY(loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value)
  IF gfGetMemVar('LLMULCURR') .AND. EMPTY(loFormSet.AriaForm1.pgfpayInv.pgHead.kbCurrCode.KeyTextBox.VALUE)
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    ** MESSAGE : " You have to enter the ."
    **           "          Ok           "
    **  = 'invoice currency'
    =gfModalGen("TRM04066B00000" , "DIALOG" , "invoice currency")

    *Old: _CUROBJ = OBJNUM(loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value)
    *Old: SHOW GET loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value  &&lower &&Revise
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *loFormSet.AriaForm1.kbCurrCode.KeyTextBox.SetFocus()
    loFormSet.AriaForm1.pgfpayInv.pgHead.kbCurrCode.KeyTextBox.SETFOCUS()
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[END]
  ELSE
    DO FORM (oAriaApplication.ScreenHome+"\AP\APINVDT.SCX") WITH loFormSet.AriaForm1
  ENDIF
  RETURN
  *-- End of lfvInvLines

  *!*************************************************************
  *! Name      : lfInvDtInit
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 8/30/2004
  *! Purpose   : Called from the Init Event of the APINVDT Screen.
  *!*************************************************************
  *! Parameters: The FormSet of APPYINV.SCX, The Form of APINVDT.SCX
  *!*************************************************************
  *! Returns   : True or False
  *!*************************************************************
FUNCTION lfInvDtInit
  LPARAMETERS loFormSet, loForm
  LOCAL lnL, lnC
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	RELEASE PAD _INQUIRY OF (loFormSet.cHostFormName)
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  *ASM, Add Properties to the form [Start]
  lcAllVar = 'lcCstType,lcTktType,lcOprCode,laOprLots,llDefQtyDt,llDefAuApr,llDefEdApr,'+;
    'lcAutoMode,lcScrMode,lcDetMode,lcInvQTot,lcInvQDet,lcAprQDet,lcAprQty,'+;
    'lcAprPri,lcWIPStat,laTktType,lnAlias'

  DIMENSION laAllVar[1,1]
  STORE '' TO laAllVar
  =gfSubStr(lcAllVar,@laAllVar,',')

  LOCAL lnI
  FOR lnI = 1 TO ALEN(laAllVar,1)
    IF LOWER(LEFT(laAllVar[lnI,1],2)) <> 'la'
      PRIVATE &laAllVar[lnI,1].
    ENDIF
  ENDFOR
  DIMENSION laOprLots[1], laTktType[1,3]

  =lfAddPro(loForm)
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *loForm.AddProperty('loRec')
  IF loFormSet.activemode = 'S'
    RETURN
  ENDIF
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  *ASM, Add Properties to the form [End]

  *Old: PRIVATE lnAlias

  STORE .F. TO loFormSet.llZoomInvD   && Zoom Invoice Detail Browse
  loForm.lcCstType  = ''
  loForm.lcOprCode  = ''
  loFormSet.lcCodeFilt = ''
  loForm.lnAlias = SELECT()
  STORE '' TO lcBrowseTl,lcLinkCode
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	DECLARE laBrowArr[1],loForm.laOprLots[1]
  *!*	STORE 'N/A' TO loForm.laOprLots[1]
  DECLARE laBrowArr[1],loFormSet.laOprLots[1]
  STORE 'N/A' TO loFormSet.laOprLots[1]
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

  *Old: lcSize1 = 'Size1'
  *Old: lcSize2 = 'Size2'
  *Old: lcSize3 = 'Size3'
  *Old: lcSize4 = 'Size4'
  *Old: lcSize5 = 'Size5'
  *Old: lcSize6 = 'Size6'
  *Old: lcSize7 = 'Size7'
  *Old: lcSize8 = 'Size8'

  STORE 1 TO loForm.cboCostType.VALUE
  *Old: STORE 0 TO lnMarker
  loForm.lcTktType = 'M'
  lcInvDtBr = 'Invoice Details'
  lcInvZoom = 'Zoom Invoice Details'
  lcStyHdr   = gfItemMask("HI")
  lnStyLngth = LEN(lcStyHdr)

  SELECT CODES
  *Old :loFormSet.lcCodeFilt = SET('FILTER')
  *Old :SET FILTER TO
  *Invoice lines called
  loFormSet.llUpdInvLn = .T.
  *Update exchange rate and unit signs.
  lcExSin2=loFormSet.lcExSin2
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *loFormSet.lcExSin1   = gfGetExSin(@lcExSin2,loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value)
  loFormSet.lcExSin1   = gfGetExSin(@lcExSin2,loFormSet.AriaForm1.pgfpayInv.pgHead.kbCurrCode.KeyTextBox.VALUE)
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  loFormSet.lcExSin2=lcExSin2

  STORE 1 TO loForm.cboTktType.VALUE,loForm.cboLotNo.VALUE
  =lfOpenFile('Style','Style',loFormSet)
  *Set GL_LINK approperiate tag
  =IIF(loFormSet.laSetups[3,2]='Y',lfOpenFile('GL_LINK','GL_LINK',loFormSet),.T.)
  *Q1: Was StyDye Table Changed ?
  =IIF(loFormSet.laSetups[1,2]='Y',lfOpenFile('STYDYE','STYDYE',loFormSet),.T.)
  =lfOpenFile('Scale','Scale',loFormSet)
  =lfOpenFile('BOMLINE','BOMLINE',loFormSet)
  SELECT STYLE
  *ASM, No need to set relation into scale because we will use scale with the material
  *SET RELATION TO 'S'+Scale INTO Scale
  DECLARE loFormSet.laCostType[1]
  STORE '' TO loFormSet.laCostType, lcOldValue, loForm.kbInvTktNo.KeyTextBox.VALUE
  lnTktNo = 0
  IF 'G' $ loFormSet.lcVenInvTypes
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *!*	  DECLARE loForm.laTktType[1,3]
    *!*	  loForm.laTktType[1,1]='General Expense'
    *!*	  loForm.laTktType[1,2]='G'
    *!*	  loForm.laTktType[1,3]='Document#'
    DECLARE loFormSet.laTktType[1,3]
    loFormSet.laTktType[1,1]='General Expense'
    loFormSet.laTktType[1,2]='G'
    loFormSet.laTktType[1,3]='Document#'
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    lnTktNo = 1
  ENDIF
  *If Style Purchase Orders Module is Installed
  IF ('PO' $ oAriaApplication.CompanyInstalledModules AND INLIST(loFormSet.lcVenInvTypes,'I','S','R','A','D'))
    =lfOpenFile('POSHDR','POSHDR',loFormSet) &&Sql Check Tag CBUSDOCU+CSTYTYPE+PO (CSTYTYPE+PO)
    =lfOpenFile('POSLN','POSLN',loFormSet) &&Sql Check Tag ;
    *CBUSDOCU+CSTYTYPE+PO+CINVTYPE+STYLE+STR(LINENO,6)+TRANCD ;
    (CSTYTYPE+PO+STYLE+STR(LINENO,6)+TRANCD)
    =lfOpenFile('MFGOPRDT','MFGOPRDT',loFormSet) &&Sql ChecK Tag ;
    *CIMTYP+CTKTNO+COPRCODE+CLOTNO+TRANCD ;
    (CIMTYP+CTKTNO+COPRCODE+CLOTNO+TRANCD)
    *Adjust Ticket Types Popup
    IF 'I' $ loFormSet.lcVenInvTypes
      lnTktNo = lnTktNo + 1
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *!*	    DIMENSION loForm.laTktType[lnTktNo,3]
      *!*	    loForm.laTktType[lnTktNo,1]='Style Purchase Order'
      *!*	    loForm.laTktType[lnTktNo,2]='I'
      *!*	    loForm.laTktType[lnTktNo,3]='Style PO#'
      DIMENSION loFormSet.laTktType[lnTktNo,3]
      loFormSet.laTktType[lnTktNo,1]='Style Purchase Order'
      loFormSet.laTktType[lnTktNo,2]='I'
      loFormSet.laTktType[lnTktNo,3]='Style PO#'
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    ENDIF
    IF 'R' $ loFormSet.lcVenInvTypes
      lnTktNo = lnTktNo + 1
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *!*	    DIMENSION loForm.laTktType[lnTktNo,3]
      *!*	    loForm.laTktType[lnTktNo,1]='Style Purchase Order Return'
      *!*	    loForm.laTktType[lnTktNo,2]='R'
      *!*	    loForm.laTktType[lnTktNo,3]='Style PO Return#'
      DIMENSION loFormSet.laTktType[lnTktNo,3]
      loFormSet.laTktType[lnTktNo,1]='Style Purchase Order Return'
      loFormSet.laTktType[lnTktNo,2]='R'
      loFormSet.laTktType[lnTktNo,3]='Style PO Return#'
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    ENDIF
    IF 'S' $ loFormSet.lcVenInvTypes
      =lfOpenFile('SHPMTHDR','SHPMTHDR',loFormSet) &&Sql Check Tag CBUSDOCU+CSHPTYPE+SHIPNO (SHIPNO)
      lnTktNo = lnTktNo + 1
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *!*	    DIMENSION loForm.laTktType[lnTktNo,3]
      *!*	    loForm.laTktType[lnTktNo,1]='Shipment'
      *!*	    loForm.laTktType[lnTktNo,2]='S'
      *!*	    loForm.laTktType[lnTktNo,3]='Shipment#'
      DIMENSION loFormSet.laTktType[lnTktNo,3]
      loFormSet.laTktType[lnTktNo,1]='Shipment'
      loFormSet.laTktType[lnTktNo,2]='S'
      loFormSet.laTktType[lnTktNo,3]='Shipment#'
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    ENDIF
  ENDIF
  *If Style Manufacturing Module is Installed and invoicing with base currency
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	IF 'MF' $ oAriaApplication.CompanyInstalledModules AND ;
  *!*	  loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value = oAriaApplication.BaseCurrency AND ;
  *!*	  'M' $ loFormSet.lcVenInvTypes
  IF 'MF' $ oAriaApplication.CompanyInstalledModules AND ;
      loFormSet.AriaForm1.pgfpayInv.pgHead.kbCurrCode.KeyTextBox.VALUE = oAriaApplication.BaseCurrency AND ;
      'M' $ loFormSet.lcVenInvTypes
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    =lfOpenFile('CUTTKTH','POSHDR',loFormSet) &&Sql61: Check Tag  CBUSDOCU+CSTYTYPE+PO (CUTTKT)
    =lfOpenFile('CUTTKTL','POSLN',loFormSet) &&Sql62: Check Tag ;
    *CBUSDOCU+CSTYTYPE+PO+CINVTYPE+STYLE+STR(LINENO,6)+TRANCD ;
    (CUTTKT+STYLE+DYELOT+TRANCD)
    =lfOpenFile('MFGOPRDT','MFGOPRDT',loFormSet) &&Sql62: Check Tag ;
    *CIMTYP+CTKTNO+COPRCODE+CLOTNO+TRANCD (CIMTYP+CTKTNO+COPRCODE+CLOTNO+TRANCD)

    *Adjust Ticket Types Popup
    lnTktNo = lnTktNo + 1
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *!*	  DIMENSION loForm.laTktType[lnTktNo,3]
    *!*	  loForm.laTktType[lnTktNo,1]='Cutting Ticket'
    *!*	  loForm.laTktType[lnTktNo,2]='M'
    *!*	  loForm.laTktType[lnTktNo,3]='Cutting Ticket#'
    DIMENSION loFormSet.laTktType[lnTktNo,3]
    loFormSet.laTktType[lnTktNo,1]='Cutting Ticket'
    loFormSet.laTktType[lnTktNo,2]='M'
    loFormSet.laTktType[lnTktNo,3]='Cutting Ticket#'
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    IF 'A' $ loFormSet.lcVenInvTypes
      lnTktNo = lnTktNo + 1
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *!*	    DIMENSION loForm.laTktType[lnTktNo,3]
      *!*	    loForm.laTktType[lnTktNo,1]='Adornment Order'
      *!*	    loForm.laTktType[lnTktNo,2]='A'
      *!*	    loForm.laTktType[lnTktNo,3]='Ador P/O#'
      DIMENSION loFormSet.laTktType[lnTktNo,3]
      loFormSet.laTktType[lnTktNo,1]='Adornment Order'
      loFormSet.laTktType[lnTktNo,2]='A'
      loFormSet.laTktType[lnTktNo,3]='Ador P/O#'
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    ENDIF
    IF 'D' $ loFormSet.lcVenInvTypes
      lnTktNo = lnTktNo + 1
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *!*	    DIMENSION loForm.laTktType[lnTktNo,3]
      *!*	    loForm.laTktType[lnTktNo,1]='Dying Order'
      *!*	    loForm.laTktType[lnTktNo,2]='D'
      *!*	    loForm.laTktType[lnTktNo,3]='Dye P/O#'
      DIMENSION loFormSet.laTktType[lnTktNo,3]
      loFormSet.laTktType[lnTktNo,1]='Dying Order'
      loFormSet.laTktType[lnTktNo,2]='D'
      loFormSet.laTktType[lnTktNo,3]='Dye P/O#'
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    ENDIF

  ENDIF
  *If Material Module is Installed
  IF 'MA' $ oAriaApplication.CompanyInstalledModules AND ;
      ('L' $ loFormSet.lcVenInvTypes OR 'T' $ loFormSet.lcVenInvTypes OR 'F' $ loFormSet.lcVenInvTypes)
    =lfOpenFile('Fabric','Style',loFormSet) &&Sql Check Tag CINVTYPE+STYLE (FABRIC+COLOR)
    =IIF(loFormSet.laSetups[2,2]='Y',lfOpenFile('FabDye','StyDye',loFormSet),.T.) &&Sql Check Tag ;
    *CINVTYPE+STYLE+CWARECODE+DYELOT (FABRIC+COLOR+CWARECODE+DYELOT)
    =lfOpenFile('POFHDR','POSHDR',loFormSet) &&Sql63: Check Tag CBUSDOCU+CSTYTYPE+PO (CMATTYPE+POMAT)
    =lfOpenFile('POFLN','POSLN',loFormSet) &&Sql64: Check Tag ;
    *CBUSDOCU+CSTYTYPE+PO+CINVTYPE+STYLE+STR(LINENO,6)+TRANCD ;
    (CMATTYPE+POMAT+FABRIC+COLOR+TRANCD)
    =lfOpenFile('MFGOPRDT','MFGOPRDT',loFormSet)&&Sql64: Check Tag ;
    *CIMTYP+CTKTNO+COPRCODE+CLOTNO+TRANCD (CIMTYP+CTKTNO+COPRCODE+CLOTNO+TRANCD)
    IF 'L' $ loFormSet.lcVenInvTypes
      *Adjust Ticket Types Popup
      lnTktNo = lnTktNo + 1
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *!*	    DIMENSION loForm.laTktType[lnTktNo,3]
      *!*	    loForm.laTktType[lnTktNo,1]='Material PO'
      *!*	    loForm.laTktType[lnTktNo,2]='L'
      *!*	    loForm.laTktType[lnTktNo,3]='Material PO#'
      DIMENSION loFormSet.laTktType[lnTktNo,3]
      loFormSet.laTktType[lnTktNo,1]='Material PO'
      loFormSet.laTktType[lnTktNo,2]='L'
      loFormSet.laTktType[lnTktNo,3]='Material PO#'
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[END]
    ENDIF
    IF 'F' $ loFormSet.lcVenInvTypes
      *Adjust Ticket Types Popup
      lnTktNo = lnTktNo + 1
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *!*	    DIMENSION loForm.laTktType[lnTktNo,3]
      *!*	    loForm.laTktType[lnTktNo,1]='Material PO Return'
      *!*	    loForm.laTktType[lnTktNo,2]='F'
      *!*	    loForm.laTktType[lnTktNo,3]='Material PO Return#'
      DIMENSION loFormSet.laTktType[lnTktNo,3]
      loFormSet.laTktType[lnTktNo,1]='Material PO Return'
      loFormSet.laTktType[lnTktNo,2]='F'
      loFormSet.laTktType[lnTktNo,3]='Material PO Return#'
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    ENDIF
    *Only when invoicing with base currency
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *  IF 'T' $ loFormSet.lcVenInvTypes AND ;
    *loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value = oAriaApplication.BaseCurrency
    IF 'T' $ loFormSet.lcVenInvTypes AND ;
        loFormSet.AriaForm1.pgfpayInv.pgHead.kbCurrCode.KeyTextBox.VALUE = oAriaApplication.BaseCurrency
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      =lfOpenFile('MMFGORDH','POSHDR',loFormSet) &&Sql65: Check Tag CBUSDOCU+CSTYTYPE+PO (CMFGORDNO)
      =lfOpenFile('MMFGORDD','POSLN',loFormSet) &&Sql66: Check Tag ;
      *CBUSDOCU+CSTYTYPE+PO+CINVTYPE+STYLE+STR(LINENO,6)+TRANCD ;
      (CMFGORDNO+CFABRIC+COLOR+DYELOT+TRANCD)
      lnTktNo = lnTktNo + 1
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *!*	    DIMENSION loForm.laTktType[lnTktNo,3]
      *!*	    loForm.laTktType[lnTktNo,1]='Material MFG Order'
      *!*	    loForm.laTktType[lnTktNo,2]='T'
      *!*	    loForm.laTktType[lnTktNo,3]='Order#'
      DIMENSION loFormSet.laTktType[lnTktNo,3]
      loFormSet.laTktType[lnTktNo,1]='Material MFG Order'
      loFormSet.laTktType[lnTktNo,2]='T'
      loFormSet.laTktType[lnTktNo,3]='Order#'
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    ENDIF
  ENDIF

  *Restore Screen Defaults
  STORE .T. TO llDefQtyDt, llDefAuApr, llDefEdApr
  lcResDir = ADDBS(ALLTRIM(oAriaApplication.resourcehome)+ALLTRIM(oariaApplication.User_ID))
  IF FILE(lcResDir+"APVINVDT.MEM")
    RESTORE ADDITIVE FROM (lcResDir+"APVINVDT.MEM")
  ENDIF
  loForm.llDefQtyDt = llDefQtyDt
  loForm.llDefAuApr = llDefAuApr
  loForm.llDefEdApr = llDefEdApr
  *STORE '' TO lcFabric,lcFabClr,lcFabDye,lcFabDesc,lcStyle,lcStyDye,lcStyDesc
  *Q2: Is This Correct Replacment for the Previous Line ?
  STORE '' TO loForm.cntItem.VALUE, loForm.kbDyelot.KeyTextBox.VALUE, loForm.txtStyDesc.VALUE

  IF loFormSet.ActiveMode="V"

    SELECT 'APVINVDT'
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *SET ORDER TO TAG Orgvinv
    gfSETORDER('Orgvinv')
    =gfSeek(PADR(loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE,8)+ ;
      PADR(loFormSet.AriaForm1.kbInvNo.KeyTextBox.VALUE,12))
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    *!*    lcFilt = KEY()+"='"+PADR(loFormSet.AriaForm1.KBVendCode.KeyTextBox.Value,8)+;
    *!*             PADR(loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value,12)+"'"
    *!*    SET FILTER TO &lcFilt
    SELECT * FROM APVINVDT WHERE CVENDCODE+CAPINVNO+CAPVILNO = ;
      PADR(loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE,8)+ ;
      PADR(loFormSet.AriaForm1.kbInvNo.KeyTextBox.VALUE,12) ;
      ORDER BY CVENDCODE, CAPINVNO, CAPVILNO INTO CURSOR APVINVDT2
    SELECT APVINVDT2
    INDEX ON CVENDCODE+CAPINVNO+CAPVILNO TAG Orgvinv
  ELSE
    SELECT (loFormSet.lcAPvInvDt)
    SET ORDER TO TAG (loFormSet.lcAPvInvDt)
  ENDIF
  =SEEK(PADR(loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE,8)+PADR(loFormSet.AriaForm1.kbInvNo.KeyTextBox.VALUE,12))
  SUM REST IIF(CIMTYP $ 'RF' AND loFormSet.ActiveMode="V",-ROUND(nAPAMnt,2),ROUND(nAPAMnt,2)),;
    IIF(CIMTYP $ 'RF' AND loFormSet.ActiveMode="V",-ROUND(nApAprAmnt,2),ROUND(nApAprAmnt,2)) TO loFormSet.lnTInvAmt,loFormSet.lnTAprAmt ;
    WHILE cVendCode+cApInvNo+cAPVILNo = PADR(loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE,8)+PADR(loFormSet.AriaForm1.kbInvNo.KeyTextBox.VALUE,12)

  =SEEK(PADR(loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE,8)+PADR(loFormSet.AriaForm1.kbInvNo.KeyTextBox.VALUE,12))
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *SCATTER NAME loForm.loRec
  SCATTER NAME loFormSet.loRec
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[END]

  loForm.lcAutoMode= IIF(loFormSet.ActiveMode="V" OR loFormSet.lcVenInvTypes=='G','DISABLE','ENABLE')
  loForm.lcScrMode = IIF(loFormSet.ActiveMode="V",'DISABLE','ENABLE')
  loForm.lcDetMode = IIF(loFormSet.ActiveMode="V" OR EOF(),'DISABLE','ENABLE')
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	loForm.lcInvQTot = IIF(loFormSet.ActiveMode="V" OR EOF() OR (loForm.llDefQtyDt AND INLIST(loForm.loRec.cIMTyp,'I','S','M','R','A','D')),'DISABLE','ENABLE')
  *!*	loForm.lcInvQDet = IIF(loFormSet.ActiveMode="V" OR EOF() OR !INLIST(loForm.loRec.cIMTyp,'I','S','M','R','A','D') OR !loForm.llDefQtyDt,'DISABLE','ENABLE')
  *!*	loForm.lcAprQDet = IIF(loFormSet.ActiveMode="V" OR EOF() OR !INLIST(loForm.loRec.cIMTyp,'I','S','M','R','A','D') OR !loForm.llDefQtyDt OR !loForm.llDefEdApr,'DISABLE','ENABLE')
  *!*	loForm.lcAprQty  = IIF(loFormSet.ActiveMode="V" OR EOF() OR !loForm.llDefEdApr OR (loForm.llDefQtyDt AND INLIST(loForm.loRec.cIMTyp,'I','S','M','R','A','D')),'DISABLE','ENABLE')
  loForm.lcInvQTot = IIF(loFormSet.ActiveMode="V" OR EOF() OR (loForm.llDefQtyDt AND INLIST(loFormSet.loRec.cIMTyp,'I','S','M','R','A','D')),'DISABLE','ENABLE')
  loForm.lcInvQDet = IIF(loFormSet.ActiveMode="V" OR EOF() OR !INLIST(loFormSet.loRec.cIMTyp,'I','S','M','R','A','D') OR !loForm.llDefQtyDt,'DISABLE','ENABLE')
  loForm.lcAprQDet = IIF(loFormSet.ActiveMode="V" OR EOF() OR !INLIST(loFormSet.loRec.cIMTyp,'I','S','M','R','A','D') OR !loForm.llDefQtyDt OR !loForm.llDefEdApr,'DISABLE','ENABLE')
  loForm.lcAprQty  = IIF(loFormSet.ActiveMode="V" OR EOF() OR !loForm.llDefEdApr OR (loForm.llDefQtyDt AND INLIST(loFormSet.loRec.cIMTyp,'I','S','M','R','A','D')),'DISABLE','ENABLE')
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  loForm.lcAprPri  = IIF(loFormSet.ActiveMode="V" OR EOF() OR !loForm.llDefEdApr,'DISABLE','ENABLE')
  loForm.lcWIPStat = IIF(loFormSet.ActiveMode="V" OR EOF(),'DISABLE','ENABLE')
  
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *loForm.lblGlAct.Caption= IIF(loForm.loRec.cIMTyp='G','GL Account','WIP Account')
  *IF lnTktNo = 0 
  loForm.lblGlAct.CAPTION= IIF(loFormSet.loRec.cIMTyp='G','GL Account','WIP Account')
  IF lnTktNo = 0 
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    *Message : 04182
    *Vendor  has no access to use Detailed Invoices.
    *You may only use Distribution Lines option instead.
    *Button : 00000
    *Ok*
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*!*	    =gfModalGen("TRM04182B00000","DIALOG",loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE)
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    *Old: SHOW GET pbAPVInvDt DISABLE &&Revise
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *loFormSet.AriaForm1.cmdInvLines.Enabled = .F.
    loFormSet.AriaForm1.pgfpayInv.pgDet.ENABLED = .F.
    loFormSet.AriaForm1.pgfpayInv.ACTIVEPAGE = 1
    loFormSet.llshowmsg = .T.
    RETURN .F.
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    loFormSet.lcVenInvTypes =''
  ELSE

    *ASM, Hide Tax Code Accoring To Vendor
    STORE (APVENDOR.CTAXTYPE <> 'T') TO loForm.lblTaxCode.VISIBLE, loForm.lblTaxColon.VISIBLE, ;
      loForm.cboTaxCode.VISIBLE
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    loFormSet.llitempos = .T.
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    *ASM, Reposition the cntItem and txtItem controls
    loForm.cntItem.TOP = loForm.cntStyle.TOP
    loForm.cntItem.LEFT = loForm.cntStyle.LEFT

    WITH loForm.grdInvDtLines
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      .RECORDSOURCE = ''
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[ENd]
      .COLUMNCOUNT = 0
      .RECORDSOURCE = IIF(loFormSet.ActiveMode="V",'APVINVDT2',loFormSet.lcAPvInvDt)
      .COLUMNCOUNT = 7

      .column1.WIDTH = 110
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *.column1.ControlSource = "IIF(EMPTY(cBomType),'',lfCostDesc(ThisFormSet.CallingForm.Parent))"
      .column1.CONTROLSOURCE = "IIF(EMPTY(cBomType),'',lfCostDesc(ThisFormSet))"
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      .column1.Header1.CAPTION = 'Cost Type'

      .column2.WIDTH = 90
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *.column2.ControlSource = "IIF(CIMTYP $ 'RF' AND ThisFormSet.CallingForm.Parent.ActiveMode='V' ,-nApTotQty,nApTotQty)"
      .column2.CONTROLSOURCE = "IIF(CIMTYP $ 'RF' AND ThisFormSet.ActiveMode='V' ,-nApTotQty,nApTotQty)"
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      .column2.Header1.CAPTION = 'Inv. Qty.'

      .column3.WIDTH = 90
      .column3.CONTROLSOURCE = "nApPrice"
      .column3.Header1.CAPTION = 'Inv. Price'

      .column4.WIDTH = 90
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *.column4.ControlSource = "ROUND(IIF(CIMTYP $ 'RF' AND ThisFormSet.CallingForm.Parent.ActiveMode='V',-nApAmnt,nApAmnt),2)"
      .column4.CONTROLSOURCE = "ROUND(IIF(CIMTYP $ 'RF' AND ThisFormSet.ActiveMode='V',-nApAmnt,nApAmnt),2)"
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      .column4.Header1.CAPTION = 'Inv. Amount'

      .column5.WIDTH = 90
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *.column5.ControlSource = "IIF(CIMTYP $ 'RF' AND ThisFormSet.CallingForm.Parent.ActiveMode='V',-nApTAprQty,nApTAprQty)"
      .column5.CONTROLSOURCE = "IIF(CIMTYP $ 'RF' AND ThisFormSet.ActiveMode='V',-nApTAprQty,nApTAprQty)"
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      .column5.Header1.CAPTION = 'Appr. Qty.'

      .column6.WIDTH = 90
      .column6.CONTROLSOURCE = "nApAprPric"
      .column6.Header1.CAPTION = 'Appr. Price'

      .column7.WIDTH = 90
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *.column7.ControlSource = "ROUND(IIF(CIMTYP $ 'RF' AND ThisFormSet.CallingForm.Parent.ActiveMode='V',-nApAprAmnt,nApAprAmnt),2)"
      .column7.CONTROLSOURCE = "ROUND(IIF(CIMTYP $ 'RF' AND ThisFormSet.ActiveMode='V',-nApAprAmnt,nApAprAmnt),2)"
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      .column7.Header1.CAPTION = 'Appr. Amount'

    ENDWITH

  ENDIF
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  loForm.grdInvDtLines.REFRESH
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[ENd]

  RETURN lnTktNo > 0
  *-- End of lfInvDtInit

  *!*************************************************************
  *! Name      : lfCostDesc
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 8/30/2004
  *! Purpose   : Get Cost Type Description
  *!*************************************************************
  *!Parameters :  The FormSet of APPYINV.SCX
  *!*************************************************************
  *! Returns            :  Cost Type Description
  *!*************************************************************
FUNCTION lfCostDesc
  LPARAMETERS loFormSet
  LOCAL lcAryName

  lcAryName = 'loFormSet.la'+IIF(INLIST(CIMTyp,'S','R'),'I',IIF(CIMTYP='F','L',IIF(CIMTYP='D','M',CIMTYP)))+'CSTTYPE'
  RETURN EVAL(lcAryName+"[ASUBSCRIPT("+lcAryName+",ASCAN("+lcAryName+",cBomType),1),1]")
  *-- End of lfCostDesc

  *!*************************************************************
  *! Name      : lfInvDtDestroty
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 8/30/2004
  *! Purpose   : Called from the Destroy Event of the APINVDT Screen.
  *!*************************************************************
  *! Parameters: The FormSet of APPYINV.SCX, The Form of APINVDT.SCX
  *!*************************************************************
  *! Returns   : None
  *!*************************************************************
FUNCTION lfInvDtDestroty
  LPARAMETERS loFormSet, loForm

  *Rebuild the TmpDist file in case there is Shipmnet [Start]
  IF loFormSet.ActiveMode="E" OR loFormSet.ActiveMode="A"
    =lfUpdDist(loFormSet, loForm)
  ENDIF
  *Rebuild the TmpDist file in case there is Shipmnet [END]

  *Save Screen Defaults
  llDefQtyDt = loForm.llDefQtyDt
  llDefAuApr = loForm.llDefAuApr
  llDefEdApr = loForm.llDefEdApr

  lcResDir = ADDBS(ALLTRIM(oAriaApplication.resourcehome)+ALLTRIM(oariaApplication.User_ID))
  SAVE ALL LIKE llDef* TO (lcResDir+"APVINVDT.MEM")
  SELECT STYLE
  *ASM, no need to set relation into Scale because we will use it with the material
  *SET RELATION OFF INTO Scale
  *Restore Previous Options Menu Pad.
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *=loFormSet.mOptionMenu()
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  *Old: SELECT CODES
  *Old: SET FILTER TO &loFormSet.lcCodeFilt
  SELECT (loForm.lnAlias)

  RETURN
  *-- End of lfInvDtDestroty


  *!*************************************************************
  *! Name      : lfgrdInvDtAfterRowCol
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 8/30/2004
  *! Purpose   : Called from the AfterRowCol Event of the Grid in the APINVDT Screen.
  *!*************************************************************
  *! Parameters: The FormSet of APPYINV.SCX, The Form of APINVDT.SCX
  *!*************************************************************
  *! Returns   : None
  *!*************************************************************
FUNCTION lfgrdInvDtAfterRowCol
  LPARAMETERS loFormSet, loForm

  IF loFormSet.ActiveMode="E" AND !EMPTY(EVALUATE(loFormSet.lcAPvInvDt+'.CTKTNO'))
    loFormSet.llClosed = lfvCheck(loFormSet,loForm)
  ENDIF
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *=SEEK(cVendCode+cApInvNo+cAPVILNo,IIF(loFormSet.ActiveMode="V",'APDIST',loFormSet.lcTmpDist))
  SELECT(IIF(loFormSet.ActiveMode="V",'APVINVDT2',loFormSet.lcAPvInvDt))
  IF loFormSet.ActiveMode="V"
    =gfSEEK(cVendCode+cApInvNo+cAPVILNo,'APDIST')
  ELSE
    =SEEK(cVendCode+cApInvNo+cAPVILNo,loFormSet.lcTmpDist)
  ENDIF
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[END]
  lcExStat=SET('EXACT')
  SET EXACT ON

  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *loForm.cboTktType.Value = IIF(EMPTY(cIMTyp),1,ASUBSCRIPT(loForm.laTktType,ASCAN(loForm.laTktType,cImTyp),1))
  loForm.cboTktType.VALUE = IIF(EMPTY(cIMTyp),1,ASUBSCRIPT(loFormSet.laTktType,ASCAN(loFormSet.laTktType,cImTyp),1))
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

  SET EXACT &lcExStat
  *Old: lnMarker = RECNO()
  *Old:IF loFormSet.llZoomInvD
  *SHOW WINDOW (lcInvZoom) REFRESH SAME
  *Old:ELSE
  *Old:SCATTER MEMVAR
  *Old:  =lfShowWind()
  *SHOW WINDOW (lcInvDtBr) REFRESH
  *Old:ENDIF
  IF EOF()
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *SCATTER NAME loForm.loRec BLANK
    SCATTER NAME loFormSet.loRec BLANK
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[END]
    STORE 0 TO loFormSet.lnTAprAmt, loFormSet.lnTInvAmt
  ELSE
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *SCATTER NAME loForm.loRec
    SCATTER NAME loFormSet.loRec
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  ENDIF
  =lfShowWind(loFormSet,loForm)
  loForm.REFRESH()

  RETURN
  *-- End of lfgrdInvDtAfterRowCol


  *:*************************************************************
  *: Name      : lfvCheck
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 8/30/2004
  *: Purpose   : Disable the Invoice detail screen for closed PO
  *!*************************************************************
  *! Parameters: The FormSet of APPYINV.SCX, The Form of APINVDT.SCX
  *:*************************************************************
  *: Returns            : llClosed
  *!*************************************************************
FUNCTION lfvCheck
  LPARAMETERS loFormSet, loForm
  

  s=SECONDS()

  lcTemp = loFormSet.lcAPvInvDt

  lnOldAls = SELECT(0)
  DO CASE
      *-- Style PO and Style Return PO
    CASE INLIST(&lcTemp..cIMTyp,'I','R')
      =loFormSet.POSHDR.SEEK(IIF(&lcTemp..cIMTyp='I','PP','RP')+&lcTemp..CTKTNO) &&Sql67: Check Key
      loFormSet.llClosed = (POSHDR.STATUS = 'S')

      *-- Shipment
    CASE INLIST(&lcTemp..cIMTyp,'S')
      =loFormSet.POSHDR.SEEK('PP'+&lcTemp..CTKTNO) &&Sql68: Check Key
      loFormSet.llClosed = (POSHDR.STATUS = 'S')

      *-- Material PO and Return Material PO
    CASE INLIST(&lcTemp..cIMTyp,'L','F')
      =loFormSet.POFHDR.SEEK(IIF(&lcTemp..cIMTyp='L','PM','RM')+&lcTemp..CTKTNO) &&Sql69: Check Key
      loFormSet.llClosed = (POFHDR.STATUS = 'L')

      *-- Cutting Ticket
    CASE INLIST(&lcTemp..cIMTyp,'M')
      =loFormSet.CUTTKTH.SEEK('PU'+&lcTemp..CTKTNO) &&Sql70: Check Key
      loFormSet.llClosed = (CUTTKTH.STATUS = 'S')
      *-- Material MFG
    CASE INLIST(&lcTemp..cIMTyp,'T')
      =loFormSet.MMFGORDH.SEEK('PF'+&lcTemp..CTKTNO) &&Sql71: Check Key
      loFormSet.llClosed = (MMFGORDH.STATUS = 'S')
  ENDCASE

  loForm.lcAutoMode= IIF(loFormSet.llClosed,'DISABLE','ENABLE')
  loForm.lcScrMode = IIF(loFormSet.llClosed,'DISABLE','ENABLE')
  loForm.lcDetMode = IIF(loFormSet.llClosed,'DISABLE','ENABLE')
  loForm.lcInvQTot = IIF(loFormSet.llClosed,'DISABLE','ENABLE')
  loForm.lcInvQDet = IIF(loFormSet.llClosed,'DISABLE','ENABLE')
  loForm.lcAprQDet = IIF(loFormSet.llClosed,'DISABLE','ENABLE')
  loForm.lcAprQty  = IIF(loFormSet.llClosed,'DISABLE','ENABLE')
  loForm.lcAprPri  = IIF(loFormSet.llClosed,'DISABLE','ENABLE')
  loForm.lcWIPStat = IIF(loFormSet.llClosed,'DISABLE','ENABLE')

  SELECT (lnOldAls)
  
  RETURN loFormSet.llClosed
  *-- End of lfvCheck

  *!*************************************************************
  *! Name      : lfShowWind
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 8/30/2004
  *! Purpose   : Refresh Controls of the APINVDT Screen.
  *!*************************************************************
  *! Parameters: The FormSet of APPYINV.SCX, The Form of APINVDT.SCX
  *!*************************************************************
  *! Returns   : None
  *!*************************************************************
FUNCTION lfShowWind
  LPARAMETERS loFormSet, loForm

  SELECT (IIF(loFormSet.ActiveMode="V",'APVINVDT2',loFormSet.lcAPvInvDt))

  loForm.lcDetMode = IIF(loFormSet.ActiveMode="V" OR EOF() OR loFormSet.llClosed,'DISABLE','ENABLE')

  loForm.lcInvQTot = IIF(loFormSet.ActiveMode="V" OR EOF() OR loFormSet.llClosed OR (loForm.llDefQtyDt AND INLIST(cIMTyp,'I','S','M','R','A','D') AND !EMPTY(ITEM)),'DISABLE','ENABLE')
  *loForm.lcInvQDet = IIF(loFormSet.ActiveMode="V" OR EOF() OR loFormSet.llClosed OR !INLIST(cIMTyp,'I','S','M','R','A','D') OR !loForm.llDefQtyDt,'DISABLE','ENABLE')
  *loForm.lcAprQDet = IIF(loFormSet.ActiveMode="V" OR EOF() OR loFormSet.llClosed OR !INLIST(cIMTyp,'I','S','M','R','A','D') OR !loForm.llDefQtyDt OR !loForm.llDefEdApr,'DISABLE','ENABLE')
  loForm.lcInvQDet = IIF(loFormSet.ActiveMode="V" OR EOF() OR loFormSet.llClosed OR !INLIST(cIMTyp,'I','S','M','R','A','D','T','L','F') OR !loForm.llDefQtyDt,'DISABLE','ENABLE')
  loForm.lcAprQDet = IIF(loFormSet.ActiveMode="V" OR EOF() OR loFormSet.llClosed OR !INLIST(cIMTyp,'I','S','M','R','A','D','T','L','F') OR !loForm.llDefQtyDt OR !loForm.llDefEdApr,'DISABLE','ENABLE')
  loForm.lcAprQty  = IIF(loFormSet.ActiveMode="V" OR EOF() OR !loForm.llDefEdApr OR loFormSet.llClosed OR (loForm.llDefQtyDt AND INLIST(cIMTyp,'I','S','M','R','A','D')  AND !EMPTY(ITEM)),'DISABLE','ENABLE')

  loForm.lcAprPri  = IIF(loFormSet.ActiveMode="V" OR EOF() OR !loForm.llDefEdApr OR loFormSet.llClosed,'DISABLE','ENABLE')
  loForm.lcWIPStat = IIF(loFormSet.ActiveMode="V" OR EOF() OR loFormSet.llClosed,'DISABLE','ENABLE')


  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *loForm.lblGlAct.Caption= IIF(loForm.loRec.cIMTyp='G','GL Account','WIP Account')
  *!*	IF loFormSet.llZoomInvD
  *!*	  loForm.grdInvDtLines.Height = loForm.cnt12.Top - (loForm.grdInvDtLines.Top+5)
  *!*	ELSE
  *!*	  loForm.grdInvDtLines.Height = loForm.cnt13.Top - (loForm.grdInvDtLines.Top+5)
  *!*	ENDIF
  loForm.lblGlAct.CAPTION= IIF(loFormSet.loRec.cIMTyp='G','GL Account','WIP Account')
  IF loFormSet.llZoomInvD
    loForm.grdInvDtLines.HEIGHT = loForm.cnt12.TOP +  loForm.cnt12.HEIGHT
    WITH loForm
      STORE .F. TO  .lblaprexrat.VISIBLE,.lblColon3.VISIBLE, .cboTktType.VISIBLE, .Arialabel14.VISIBLE,;
        .Arialabel15.VISIBLE,.cboCostType.VISIBLE,.Arialabel12.VISIBLE,.Arialabel13.VISIBLE,;
        .cboMFGOpr.VISIBLE,.lblTktType.VISIBLE,.kbInvTktNo.VISIBLE,.Arialabel11.VISIBLE,;
        .cboLotNo.VISIBLE,.txtTInvAmt.VISIBLE,.Ariashape1.VISIBLE,.cnt13.VISIBLE,;
        .cnt21.VISIBLE,.cntStyle.VISIBLE,.lblDyelot.VISIBLE,.kbDyelot.VISIBLE,;
        .Ariashape2.VISIBLE,.cmdNew.VISIBLE,.cmdAuto.VISIBLE,.cmdRemove.VISIBLE,;
        .cmdContribute.VISIBLE,.cmdMultiApprove.VISIBLE,.txtItem.VISIBLE,.txtStyDesc.VISIBLE,;
        .lblTaxCode.VISIBLE,.lblTaxColon.VISIBLE,.cboTaxCode.VISIBLE,.lblGlAct.VISIBLE,;
        .Arialabel16.VISIBLE,.cnt11.VISIBLE,.glApDGlAct.VISIBLE,.txtActName.VISIBLE,.cnt22.VISIBLE,;
        .cnt12.VISIBLE,.Arialabel4.VISIBLE,.Arialabel5.VISIBLE,.Arialabel10.VISIBLE,.lblReq_Qty.VISIBLE,;
        .lblUsed_Qty.VISIBLE,.lbl1.VISIBLE,.lbl2.VISIBLE,.txtAPPrice.VISIBLE,.txtAPTotQty.VISIBLE,;
        .txtAPTAprQty.VISIBLE,.txtApAmnt.VISIBLE,.txtAPAprAmnt.VISIBLE,.txtAPAprPric.VISIBLE,.cntAP_Qty.VISIBLE,;
        .cntAPApr_Qty.VISIBLE,.lblitem.VISIBLE,.cntItem.VISIBLE,.txtTAprAmt.VISIBLE
    ENDWITH
  ELSE
    loForm.grdInvDtLines.HEIGHT = loForm.cnt13.TOP -  5
    WITH loForm
      STORE .T. TO  .lblaprexrat.VISIBLE,.lblColon3.VISIBLE, .cboTktType.VISIBLE, .Arialabel14.VISIBLE,;
        .Arialabel15.VISIBLE,.cboCostType.VISIBLE,.Arialabel12.VISIBLE,.Arialabel13.VISIBLE,;
        .cboMFGOpr.VISIBLE,.lblTktType.VISIBLE,.kbInvTktNo.VISIBLE,.Arialabel11.VISIBLE,;
        .cboLotNo.VISIBLE,.txtTInvAmt.VISIBLE,.Ariashape1.VISIBLE,.cnt13.VISIBLE,;
        .cnt21.VISIBLE,.cntStyle.VISIBLE,.lblDyelot.VISIBLE,.kbDyelot.VISIBLE,;
        .Ariashape2.VISIBLE,.cmdNew.VISIBLE,.cmdAuto.VISIBLE,.cmdRemove.VISIBLE,;
        .cmdContribute.VISIBLE,.cmdMultiApprove.VISIBLE,.txtItem.VISIBLE,.txtStyDesc.VISIBLE,;
        .lblTaxCode.VISIBLE,.lblTaxColon.VISIBLE,.cboTaxCode.VISIBLE,.lblGlAct.VISIBLE,;
        .Arialabel16.VISIBLE,.cnt11.VISIBLE,.glApDGlAct.VISIBLE,.txtActName.VISIBLE,.cnt22.VISIBLE,;
        .cnt12.VISIBLE,.Arialabel4.VISIBLE,.Arialabel5.VISIBLE,.Arialabel10.VISIBLE,.lblReq_Qty.VISIBLE,;
        .lblUsed_Qty.VISIBLE,.lbl1.VISIBLE,.lbl2.VISIBLE,.txtAPPrice.VISIBLE,.txtAPTotQty.VISIBLE,;
        .txtAPTAprQty.VISIBLE,.txtApAmnt.VISIBLE,.txtAPAprAmnt.VISIBLE,.txtAPAprPric.VISIBLE,.cntAP_Qty.VISIBLE,;
        .cntAPApr_Qty.VISIBLE,.lblitem.VISIBLE,.cntItem.VISIBLE,.txtTAprAmt.VISIBLE
    ENDWITH
  ENDIF
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  =lfGetCstEle(loFormSet, loForm)
  *Fix problem in AP Invoice lines that tax code applies to all lines [Begin]
  *Q3: Should I use the aria combobox instead of ariacodes ?
  DIMENSION laCodes[ALEN(loFormSet.laCodes,1),ALEN(loFormSet.laCodes,2)]
  =ACOPY(loFormSet.laCodes,laCodes)
  *! B608409,1 SSH 01/16/2008 Incorect Taxes in distribution line screen
  *IF EMPTY(EVALUATE(loFormSet.lcAPVInvDt+'.CTAXCODE'))
  laCodes[2,7] = IIF(loFormSet.ActiveMode="V",'APVINVDT2',loFormSet.lcAPvInvDt)
  laCodes[2,8] = IIF(loFormSet.ActiveMode="V",'Orgvinv',loFormSet.lcAPvInvDt)
  IF EMPTY(CTAXCODE)
    *! B608409,1 SSH 01/16/2008 Incorect Taxes in distribution line screen
    =gfwCodePop(@laCodes,'CTAXCODE','N')
  ELSE
    =gfwCodePop(@laCodes,'CTAXCODE','T')
  ENDIF
  =ACOPY(laCodes,loFormSet.laCodes)

  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *IF loForm.loRec.cCostType = 'M'
  IF loFormSet.loRec.cCostType = 'M'
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    *Display the cost title in Invoice line in edit and view mode [Begin]
    =gfwCodePop(@laCodes,'MFGCODE','T')
    =ACOPY(laCodes,loFormSet.laCodes)
    *Display the cost title in Invoice line in edit and view mode [End]
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *=lfRefLot(loForm.loRec.cLotNo,loForm)
    =lfRefLot(loFormSet,loFormSet.loRec.cLotNo,loForm)
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[END]
  ELSE
    *=gfwCodePop(@laCodes,'MFGCODE','N')
  ENDIF
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *loForm.kbInvTktNo.KeyTextBox.Value = IIF(loForm.loRec.cIMTyp='S',loForm.loRec.ShipNo,loForm.loRec.cTktNo)
  loForm.kbInvTktNo.KeyTextBox.VALUE = IIF(loFormSet.loRec.cIMTyp='S',loFormSet.loRec.ShipNo,loFormSet.loRec.cTktNo)
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[END]
  *Old: SHOW GETS WINDOW 'APINVD13' DISABLE ONLY &&Revise
  =lfcntShowGet(loForm,13,'Enabled',.F.)
  *Old: SHOW GET ibInvDet     ENABLE &&Revise
  *Old: SHOW GET m.nAPPrice   &loForm.lcDetMode &&Revise
  loForm.txtAPPrice.ENABLED = (loForm.lcDetMode='ENABLE')

  *-- If the document type is Material PO, Material PO Return or Material
  *-- MFG Order.
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *IF INLIST(loForm.loRec.cImTyp,'T','L','F')
  IF INLIST(loFormSet.loRec.cImTyp,'T','L','F')
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

    *-- Disable the Get Field that has no decimal points.
    *Old: SHOW OBJECT OBJNUM(m.nAPTotQty) + 1 DISABLE
    *-- Use the Get Field that has decimal points.
    *Old: loFormSet.lnQtyObj = OBJNUM(m.nAPTotQty)
    *Old: SHOW OBJECT loFormSet.lnQtyObj &loForm.lcInvQTot
    loForm.txtAPTotQty.INPUTMASK = "9999999.999"
    loForm.txtAPTotQty.ENABLED = (loForm.lcInvQTot='ENABLE')

  ELSE    && Else (If the document type is anything but Material PO, Material PO Return and Material MFG Order.)

    *-- Disable the Get Field that has decimal points.
    *Old: SHOW OBJECT OBJNUM(m.nAPTotQty) DISABLE
    *-- Use the Get Field that has no decimal points.
    *Old: loFormSet.lnQtyObj = OBJNUM(m.nAPTotQty) + 1
    *Old: SHOW OBJECT loFormSet.lnQtyObj &loForm.lcInvQTot
    loForm.txtAPTotQty.INPUTMASK = "9999999"
    loForm.txtAPTotQty.ENABLED = (loForm.lcInvQTot='ENABLE')

  ENDIF

  *Old: SHOW GET m.nApAmnt    &loForm.lcDetMode
  loForm.txtApAmnt.ENABLED = (loForm.lcDetMode='ENABLE')
  *Show Approved Amount
  *Old: SHOW GET m.nAPAprPric &loForm.lcAprPri
  loForm.txtAPAprPric.ENABLED = (loForm.lcAprPri='ENABLE')

  *-- If the document type is Material PO, Material PO Return or Material
  *-- MFG Order.
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *IF INLIST(loForm.loRec.cImTyp,'T','L','F')
  IF INLIST(LOFORMSET.loRec.cImTyp,'T','L','F')
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

    *-- Disable the Get Field that has no decimal points.
    *Old: SHOW OBJECT OBJNUM(m.nApTAprQty) + 1 DISABLE
    *-- Use the Get Field that has decimal points.
    *Old: loFormSet.lnApQtyObj = OBJNUM(m.nApTAprQty)
    *Old: SHOW OBJECT loFormSet.lnApQtyObj &loForm.lcAprQty
    loForm.txtAPTAprQty.INPUTMASK = "9999999.999"
    loForm.txtAPTAprQty.ENABLED = (loForm.lcAprQty='ENABLE')

  ELSE    && Else (If the document type is anything but Material PO, Material PO Return and Material MFG Order.)

    *-- Disable the Get Field that has decimal points.
    *Old: SHOW OBJECT OBJNUM(m.nApTAprQty) DISABLE
    *-- Use the Get Field that has no decimal points.
    *Old: loFormSet.lnApQtyObj = OBJNUM(m.nApTAprQty) + 1
    *Old: SHOW OBJECT loFormSet.lnApQtyObj &loForm.lcAprQty  &&lower
    loForm.txtAPTAprQty.INPUTMASK = "9999999"
    loForm.txtAPTAprQty.ENABLED = (loForm.lcAprQty='ENABLE')

  ENDIF    && End of IF INLIST(m.cImTyp,'T','L','F')

  *Old: SHOW GET m.nAPAprAmnt &loForm.lcAprPri &&Revise
  loForm.txtAPAprAmnt.ENABLED = (loForm.lcAprPri='ENABLE')
  DO CASE
      *Free Format Invoice
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *CASE INLIST(loForm.loRec.cIMTyp,'G',' ')
    CASE INLIST(loFormSet.loRec.cIMTyp,'G',' ')
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      *HIDE WINDOW 'APINVD21','APINVD22','APINVD23' SAME
      *Old: SHOW GETS WINDOW 'APINVD21' DISABLE ONLY &&Revise
      =lfcntShowGet(loForm,21,'Visible',.F.)
      =lfcntShowGet(loForm,21,'Enabled',.F.)
      *Old: SHOW GETS WINDOW 'APINVD22' DISABLE ONLY &&Revise
      =lfcntShowGet(loForm,22,'Visible',.F.)
      =lfcntShowGet(loForm,22,'Enabled',.F.)
      *Old: SHOW GETS WINDOW 'APINVD23' DISABLE ONLY &&Revise
      =lfcntShowGet(loForm,23,'Visible',.F.)
      =lfcntShowGet(loForm,23,'Enabled',.F.)
      *SHOW WINDOW 'APINVD24' TOP
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      IF !(loFormSet.ActiveMode $ "EA" AND loFormSet.llZoomInvD)
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
        =lfcntShowGet(loForm,24,'Visible',.T.)
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      ENDIF
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[END]
      *Old: SHOW GETS WINDOW 'APINVD24' &loForm.lcDetMode ONLY &&Revise
      =lfcntShowGet(loForm,24,'Enabled',(loForm.lcDetMode='ENABLE'))
      IF APVENDOR.CTAXTYPE<>'T'
        *=gfwCodePop(@laCodes,'CTAXCODE','T'),.T.)
        *Fix problem in AP Invoice lines that tax code applies to all lines [Begin]
        DIMENSION laCodes[ALEN(loFormSet.laCodes,1),ALEN(loFormSet.laCodes,2)]
        =ACOPY(loFormSet.laCodes,laCodes)
        =gfwCodePop(@laCodes,'CTAXCODE','L')
        =ACOPY(laCodes,loFormSet.laCodes)
        IF loFormSet.ActiveMode="V"
          IF !EMPTY(APVInvDt.CTAXCODE)
            *loFormSet.lnTaxCode = ASUBSCRIPT(loFormSet.laTaxCode,ASCAN(loFormSet.laTaxCode,APVInvDt.CTAXCODE),1)
            loFormSet.lnTaxCode = ASUBSCRIPT(loFormSet.laTaxCode,ASCAN(loFormSet.laTaxCode,APVInvDt2.CTAXCODE),1)
            *Old: SHOW GET loFormSet.lnTaxCode &&Revise
            loForm.cboTaxCode.VISIBLE = .T.
            loForm.cboTaxCode.REFRESH()
          ENDIF
        ENDIF
        *Fix problem in AP Invoice lines that tax code applies to all lines [End]
        loForm.lcWIPStat = IIF(loFormSet.ActiveMode="V" OR EOF() OR ;
          !EMPTY(EVALUATE(loFormSet.lcTmpDist+'.CTAXCODE')),'DISABLE','ENABLE')
      ENDIF


      *Invoice Applied To Style PO, Shipments or Cutting Tickets
      *Add Adorment/Dying/MMFG order to invoice line
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *CASE INLIST(loForm.loRec.cIMTyp,'I','S','M','R','A','D')
    CASE INLIST(loFormSet.loRec.cIMTyp,'I','S','M','R','A','D')
	*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[ENd]
      *HIDE WINDOW 'APINVD23','APINVD24' SAME
      =lfcntShowGet(loForm,23,'Visible',.F.)
      =lfcntShowGet(loForm,24,'Visible',.F.)
      *Old: SHOW GETS WINDOW 'APINVD23' DISABLE ONLY &&Revise
      *Old: SHOW GETS WINDOW 'APINVD24' DISABLE ONLY &&Revise
      =lfcntShowGet(loForm,23,'Enabled',.F.)
      =lfcntShowGet(loForm,24,'Enabled',.F.)
      *SHOW WINDOW 'APINVD21' TOP
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      IF !(loFormSet.ActiveMode $ "EA" AND loFormSet.llZoomInvD)
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
        =lfcntShowGet(loForm,21,'Visible',.T.)
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      ENDIF
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      STORE ITEM     TO loForm.cntStyle.VALUE
      STORE cDyelot  TO loForm.kbDyelot.KeyTextBox.VALUE
      STORE cApVIDes TO loForm.txtStyDesc.VALUE
      *Old: SHOW GETS WINDOW 'APINVD21' &loForm.lcScrMode ONLY  &&lower &&Revise
      =lfcntShowGet(loForm,21,'Enabled',(loForm.lcScrMode='ENABLE'))

      *B606054,1 ALB Control the Style [Begin]
      *Old: SHOW GET ibStyle    DISABLE &&Revise
      *Old: SHOW GET lcStyle    DISABLE &&Revise
      *Old: SHOW GET lcStyDye   DISABLE &&Revise
      *Old: SHOW GET ibStyDye   DISABLE &&Revise
      *Old: SHOW GET lcFabric   DISABLE &&Revise
      *Old: SHOW GET lcFabClr   DISABLE &&Revise
      *Old: SHOW GET ibFabric   DISABLE &&Revise
      *Old: SHOW GET ibFabClr   DISABLE &&Revise
      STORE .F. TO loForm.cntStyle.ENABLED, loForm.cntItem.ENABLED, loForm.kbDyelot.ENABLED

      *Get the correct WIP account with shipment ticket [Begin]
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *loForm.lcWIPStat = IIF(EMPTY(loForm.loRec.cAPDGLAct),'DISABLE','ENABLE')
      *loForm.glApDGlAct.Enabled = (loForm.lcWIPStat='ENABLE')
      loForm.lcWIPStat = IIF(EMPTY(loFormSet.loRec.cAPDGLAct) ,'DISABLE','ENABLE')
      *Old: SHOW GET m.cAPDGLAct &loForm.lcWIPStat.  &&Revise
      loForm.glApDGlAct.ENABLED = (loForm.lcWIPStat='ENABLE') AND loFormSet.ActiveMode $'EA'
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      *Get the correct WIP account with shipment ticket [end]

      IF !SEEK(loForm.cntStyle.VALUE,'Style') OR STYLE.cDye_Flg <> 'Y'
        *Old: SHOW GET lcStyDye DISABLE &&Revise
        loForm.kbDyelot.ENABLED = .F.
      ENDIF
      IF loForm.llDefQtyDt
        *Show Quantity per size
        *SHOW WINDOW 'APINVD22' TOP
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        IF  !(loFormSet.ActiveMode $ "EA" AND loFormSet.llZoomInvD)
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
          =lfcntShowGet(loForm,22,'Visible',.T.)
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        ENDIF
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
        *=lfRefresh('APINVD22')
        *Old: SHOW GET m.nAPQty1  &loForm.lcInvQDet  &&Revise
        *Old: SHOW GET m.nAPQty2  &loForm.lcInvQDet  &&Revise
        *Old: SHOW GET m.nAPQty3  &loForm.lcInvQDet  &&Revise
        *Old: SHOW GET m.nAPQty4  &loForm.lcInvQDet  &&Revise
        *Old: SHOW GET m.nAPQty5  &loForm.lcInvQDet  &&Revise
        *Old: SHOW GET m.nAPQty6  &loForm.lcInvQDet  &&Revise
        *Old: SHOW GET m.nAPQty7  &loForm.lcInvQDet  &&Revise
        *Old: SHOW GET m.nAPQty8  &loForm.lcInvQDet  &&Revise
        loForm.cntAP_Qty.ENABLED = (loForm.lcInvQDet='ENABLE')
        *Old: SHOW GET m.nAPAprQty1 &loForm.lcAprQDet  &&Revise
        *Old: SHOW GET m.nAPAprQty2 &loForm.lcAprQDet  &&Revise
        *Old: SHOW GET m.nAPAprQty3 &loForm.lcAprQDet  &&Revise
        *Old: SHOW GET m.nAPAprQty4 &loForm.lcAprQDet  &&Revise
        *Old: SHOW GET m.nAPAprQty5 &loForm.lcAprQDet  &&Revise
        *Old: SHOW GET m.nAPAprQty6 &loForm.lcAprQDet  &&Revise
        *Old: SHOW GET m.nAPAprQty7 &loForm.lcAprQDet  &&Revise
        *Old: SHOW GET m.nAPAprQty8 &loForm.lcAprQDet  &&Revise
        loForm.cntAPApr_Qty.ENABLED = (loForm.lcAprQDet='ENABLE')
      ELSE
        *Hide Quantity per size
        *HIDE WINDOW 'APINVD22' SAME
        =lfcntShowGet(loForm,22,'Visible',.F.)
        *Old: SHOW GETS WINDOW 'APINVD22' DISABLE ONLY &&Revise
        =lfcntShowGet(loForm,22,'Enabled',.F.)
      ENDIF
      *Invoice Applied To Material PO or Material MFG Orders
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *CASE INLIST(loForm.loRec.cImTyp,'T','L','F')
    CASE INLIST(loFormSet.loRec.cImTyp,'T','L','F')
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      *HIDE WINDOW 'APINVD21','APINVD22','APINVD24' SAME
      =lfcntShowGet(loForm,21,'Visible',.F.)
      *=lfcntShowGet(loForm,22,'Visible',.F.) &&Boho
      =lfcntShowGet(loForm,24,'Visible',.F.)
      *Old: SHOW GETS WINDOW 'APINVD21' DISABLE ONLY &&Revise
      *Old: SHOW GETS WINDOW 'APINVD22' DISABLE ONLY &&Revise
      *Old: SHOW GETS WINDOW 'APINVD24' DISABLE ONLY &&Revise
      =lfcntShowGet(loForm,21,'Enabled',.F.)
      *=lfcntShowGet(loForm,22,'Enabled',.F.) &&Boho
      =lfcntShowGet(loForm,24,'Enabled',.F.)
      *STORE SUBSTR(Item,1,7) TO lcFabric
      *STORE Color    TO lcFabClr
      *STORE cDyelot  TO lcFabDye
      *STORE cApVIDes TO lcFabDesc
      *Q4: is this replacment ok ?
      STORE lfupditem(ITEM,COLOR) TO loForm.cntItem.VALUE
      STORE cDyelot  TO loForm.kbDyelot.KeyTextBox.VALUE
      STORE cApVIDes TO loForm.txtStyDesc.VALUE
      *Control the cut tickit [Begin]
      *SHOW GET ibTktNo    &lcScrMode
      *SHOW GET lcInvTktNo &lcScrMode
      loForm.kbInvTktNo.ENABLED = (loForm.lcScrMode='ENABLE')
      *B606054,1 ALB Control the cut tickit [End]
      *SHOW WINDOW 'APINVD23' TOP
      *Old: SHOW GETS WINDOW 'APINVD23' &loForm.lcScrMode ONLY  &&Revise
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      IF !(loFormSet.ActiveMode $ "EA" AND loFormSet.llZoomInvD)
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
        =lfcntShowGet(loForm,23,'Visible',.T.)
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      ENDIF
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[END]
      =lfcntShowGet(loForm,23,'Enabled',(loForm.lcScrMode='ENABLE'))
      *Q5: What will we do Here ?
      *adalb IF EMPTY(lcFabric)
      *Old: SHOW GET ibFabClr DISABLE &&Revise
      *Old: SHOW GET lcFabClr DISABLE &&Revise
      *Old: SHOW GET ibFabric DISABLE &&Revise
      *Old: SHOW GET lcFabric DISABLE &&Revise
      *ENDIF
      *Q6: What will we do Here ?
      *CINVTYPE+STYLE
      IF !loFormSet.Fabric.SEEK('0002'+loForm.cntItem.VALUE) OR Fabric.cDye_Flg <> 'Y'  &&Sql73: Check Key
        *Old: SHOW GET ibFabDye DISABLE &&Revise
        *Old: SHOW GET lcFabDye DISABLE &&Revise
        loForm.kbDyelot.ENABLED = .F.
      ENDIF
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *IF loForm.llDefQtyDt
      IF loForm.llDefQtyDt AND !(loFormSet.ActiveMode $ "EA" AND loFormSet.llZoomInvD)
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
        =lfcntShowGet(loForm,22,'Visible',.T.)
        loForm.cntAP_Qty.ENABLED = (loForm.lcInvQDet='ENABLE')
        loForm.cntAPApr_Qty.ENABLED = (loForm.lcAprQDet='ENABLE')
      ELSE
        =lfcntShowGet(loForm,22,'Visible',.F.)
        =lfcntShowGet(loForm,22,'Enabled',.F.)
      ENDIF

  ENDCASE

  *Old: SHOW GET ibWIPAcnt   &loForm.lcWIPStat   &&Revise
  *Old: SHOW GET m.cApDGlAct &loForm.lcWIPStat   &&Revise
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *loForm.glApDGlAct.Enabled = (loForm.lcWIPStat='ENABLE')
  loForm.glApDGlAct.ENABLED = (loForm.lcWIPStat='ENABLE')AND loFormSet.ActiveMode $'EA'
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  *SHOW GET pbNewLine   &lcScrMode
  IF loFormSet.ActiveMode="E"
    *Old: SHOW GET pbNewLine ENABLE &&Revise
    loForm.cmdNew.ENABLED = .T.
  ELSE
    *Old: SHOW GET pbNewLine &loForm.lcScrMode  &&Revise
    loForm.cmdNew.ENABLED = (loForm.lcScrMode='ENABLE')
  ENDIF
  *=lfRefresh('APINVDT1')

  IF loFormSet.lcVenInvTypes=='G'
    *Old: SHOW GET pbAuto DISABLE &&Revise
    loForm.cmdAuto.ENABLED = .F.
  ELSE
    *SHOW GET pbAuto &lcScrMode
    loForm.cmdAuto.ENABLED = (loForm.lcScrMode='ENABLE')
    IF loFormSet.ActiveMode="E"
      *Old: SHOW GET pbAuto ENABLE &&Revise
      loForm.cmdAuto.ENABLED = .T.
    ELSE
      *Old: SHOW GET pbAuto &loForm.lcScrMode &&Revise
      loForm.cmdAuto.ENABLED = (loForm.lcScrMode='ENABLE')
    ENDIF
  ENDIF
  *Old: SHOW GET pbRemLine &loForm.lcDetMode  &&lower &&Revise
  loForm.cmdRemove.ENABLED = (loForm.lcDetMode='ENABLE')

  *Change this IF condition to give the user the capability to add
  *          debit memo lines, compare the absolute values [Begin]
  *IF !EMPTY(lcInvTktNo) AND nApAprAmnt > 0 AND m.cImTyp <> 'G'
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *IF !EMPTY(loForm.kbInvTktNo.KeyTextBox.Value) AND ABS(nApAprAmnt) > 0 AND loForm.loRec.cImTyp <> 'G'
  IF !EMPTY(loForm.kbInvTktNo.KeyTextBox.VALUE) AND ABS(nApAprAmnt) > 0 AND loFormSet.loRec.cImTyp <> 'G'
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    *Change this IF condition to give the user the capability [End]

    *Old: SHOW GET pbContrib ENABLE &&Revise
    loForm.cmdContribute.ENABLED = .T.
  ELSE
    *Old: SHOW GET pbContrib DISABLE &&Revise
    loForm.cmdContribute.ENABLED = .F.
  ENDIF
  *Old: SHOW GET pbApprove &loForm.lcDetMode &&Revise
  loForm.cmdMultiApprove.ENABLED = (loForm.lcDetMode='ENABLE')
  *Old: SHOW GET pbClose ENABLE &&Revise
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *loForm.cmdClose.Enabled = .T.
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[end]
  RETURN
  *-- End of lfShowWind


  *!*************************************************************
  *! Name      : lfcntShowGet
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 8/30/2004
  *! Purpose   : To Change a Property (Enabled or Visible) of a group of Controls
  *!             that are logically on the same container.
  *!*************************************************************
  *! Parameters: The Form of APINVDT.SCX, The Container No., Property Name, Property Value
  *!*************************************************************
  *! Returns   : None
  *!*************************************************************
FUNCTION lfcntShowGet
  LPARAMETERS loForm, lnCntNo, lcProperty, llValue
  DO CASE
    CASE lnCntNo=13
      loForm.cboTktType.&lcProperty.=llValue
      loForm.cboCostType.&lcProperty.=llValue
      loForm.cboMFGOpr.&lcProperty.=llValue
      loForm.kbInvTktNo.&lcProperty.=llValue
      loForm.cboLotNo.&lcProperty.=llValue
    CASE lnCntNo=21
      loForm.cntStyle.&lcProperty.=llValue
      loForm.kbDyelot.&lcProperty.=llValue
      loForm.lblDyelot.&lcProperty.=llValue
      loForm.txtStyDesc.&lcProperty.=llValue
    CASE lnCntNo=22
      loForm.cntAP_Qty.&lcProperty.=llValue
      loForm.cntAPApr_Qty.&lcProperty.=llValue
    CASE lnCntNo=23
      loForm.cntItem.&lcProperty.=llValue
      loForm.kbDyelot.&lcProperty.=llValue
      loForm.lblDyelot.&lcProperty.=llValue
      loForm.txtStyDesc.&lcProperty.=llValue
    CASE lnCntNo=24
      loForm.lblItem.&lcProperty.=llValue
      loForm.txtItem.&lcProperty.=llValue
      loForm.lblTaxCode.&lcProperty.=llValue
      loForm.lblTaxColon.&lcProperty.=llValue
      loForm.cboTaxCode.&lcProperty.=llValue
      loForm.txtStyDesc.&lcProperty.=llValue
  ENDCASE

  RETURN
  *-- End of lfcntShowGet


  *!*************************************************************
  *! Name      : lfRefLot
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 08/30/2004
  *! Purpose   : Refresh Operation Lot
  *!*************************************************************
  *! Parameters:  lcLot, The Form of APINVDT.SCX
  *!*************************************************************
  *! Returns   :  None
  *!*************************************************************
FUNCTION lfRefLot
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *PARAMETERS lcLot, loForm
  PARAMETERS loFormSet,lcLot, loForm
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  LOCAL lcSqlStatement, lnResult, lcAlias
  lcAlias = ALIAS()
  *CIMTYP+CTKTNO+COPRCODE+CLOTNO+TRANCD
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	lcSqlStatement = "SELECT DISTINCT cLotNo FROM MFGOPRDT (INDEX=MFGOPRDT) WHERE "+;
  *!*	                 "CIMTYP='"+loForm.loRec.cIMTyp+"' AND CTKTNO='"+loForm.loRec.cTktNo+"' "+;
  *!*	                 "AND COPRCODE='"+loForm.loRec.cOprCode+"'"
  *!*	lnResult=oAriaApplication.remotecompanydata.sqlrun(lcSqlStatement,'Lots','MFGOPRDT',;
  oAriaApplication.ActiveCompanyConStr,3,'SAVE',loForm.DataSessionID)

  lcSqlStatement = "SELECT DISTINCT cLotNo FROM MFGOPRDT (INDEX=MFGOPRDT) WHERE "+;
    "CIMTYP='"+loFormSet.loRec.cIMTyp+"' AND CTKTNO='"+loFormSet.loRec.cTktNo+"' "+;
    "AND COPRCODE='"+loFormSet.loRec.cOprCode+"'"
  lnResult=oAriaApplication.remotecompanydata.sqlrun(lcSqlStatement,'Lots','MFGOPRDT',;
    oAriaApplication.ActiveCompanyConStr,3,'SAVE',loFormSet.DATASESSIONID)

  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  IF lnResult<1
    oAriaApplication.remotecompanydata.CheckRetResult("execute",lnResult,.T.)
    IF !EMPTY(lcAlias)
      SELECT (lcAlias)
    ENDIF
    *AIT WINDOW LINENO()
    RETURN .F.
  ENDIF
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *SELECT cLotNo FROM Lots INTO ARRAY loForm.laOprLots &&Sql74: Must use SqlRun
  SELECT cLotNo FROM Lots INTO ARRAY loFormSet.laOprLots &&Sql74: Must use SqlRun
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  USE IN Lots
  IF !EMPTY(lcAlias)
    SELECT (lcAlias)
  ENDIF
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *loForm.cboLotNo.Value = ASCAN(loForm.laOprLots,lcLot)
  loForm.cboLotNo.VALUE = ASCAN(loFormSet.laOprLots,lcLot)
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[ENd]


  RETURN
  *-- End of lfRefLot


  *!*************************************************************
  *! Name      : lfLots
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 08/30/2004
  *! Purpose   : Get Operation Lots
  *!*************************************************************
  *! Parameters:  The Form of APINVDT.SCX
  *!*************************************************************
  *! Returns   :  None
  *!*************************************************************
FUNCTION lfLots
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *LPARAMETERS loForm
  LPARAMETERS loFormSet,loForm
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  PRIVATE lnLots

  LOCAL lcSqlStatement, lnResult, lcAlias
  lcAlias = ALIAS()
  *CIMTYP+CTKTNO+COPRCODE+CLOTNO+TRANCD
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	lcSqlStatement = "SELECT DISTINCT cLotNo FROM MFGOPRDT (INDEX=MFGOPRDT) WHERE "+;
  *!*	                 "CIMTYP='"+loForm.loRec.cIMTyp+"' AND CTKTNO='"+loForm.loRec.cTktNo+"' "+;
  *!*	                 "AND COPRCODE='"+loForm.loRec.cOprCode+"'"
  *!*	lnResult=oAriaApplication.remotecompanydata.sqlrun(lcSqlStatement,'Lots','MFGOPRDT',;
  *!*	         oAriaApplication.ActiveCompanyConStr,3,'SAVE',loForm.DataSessionID)
  lcSqlStatement = "SELECT DISTINCT cLotNo FROM MFGOPRDT (INDEX=MFGOPRDT) WHERE "+;
    "CIMTYP='"+loFormSet.loRec.cIMTyp+"' AND CTKTNO='"+loFormSet.loRec.cTktNo+"' "+;
    "AND COPRCODE='"+loFormSet.loRec.cOprCode+"'"
  lnResult=oAriaApplication.remotecompanydata.sqlrun(lcSqlStatement,'Lots','MFGOPRDT',;
    oAriaApplication.ActiveCompanyConStr,3,'SAVE',loFormSet.DATASESSIONID)
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  IF lnResult<1
    oAriaApplication.remotecompanydata.CheckRetResult("execute",lnResult,.T.)
    IF !EMPTY(lcAlias)
      SELECT (lcAlias)
    ENDIF
    *AIT WINDOW LINENO()
    RETURN .F.
  ENDIF

  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *SELECT DISTINCT cLotNo FROM Lots INTO ARRAY loForm.laOprLots  &&Sql75: Must use SqlRun
  SELECT DISTINCT cLotNo FROM Lots INTO ARRAY loFormSet.laOprLots  &&Sql75: Must use SqlRun
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  USE IN Lots
  IF !EMPTY(lcAlias)
    SELECT (lcAlias)
  ENDIF
  lnLots = _TALLY
  DO CASE
    CASE lnLots = 0
      loForm.cboLotNo.VALUE = 0
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *loForm.loRec.cLotNo = SPACE(2)
      loFormSet.loRec.cLotNo = SPACE(2)
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    OTHERWISE
      loForm.cboLotNo.VALUE = 1
      *B608159,1 WAM 07/12/2007 Rebuild lots popup after collecting operation lots
      loForm.cboLotNo.REQUERY
      *B608159,1 WAM 07/12/2007 (End)
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *loForm.loRec.cLotNo = loForm.laOprLots[1]
      loFormSet.loRec.cLotNo = loFormSet.laOprLots[1]
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  ENDCASE
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	REPLACE cStatus WITH IIF(cStatus='S' AND cLotNo <> loForm.loRec.cLotNo,'M',cStatus) ,;
  *!*	        cLotNo  WITH loForm.loRec.cLotNo
  REPLACE cStatus WITH IIF(cStatus='S' AND cLotNo <> loFormSet.loRec.cLotNo,'M',cStatus) ,;
    cLotNo  WITH loFormSet.loRec.cLotNo
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  RETURN(lnLots > 1)
  *-- End of lfLots

  *!*************************************************************
  *! Name      : lfGetCstEle
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 08/30/2004
  *! Purpose   : Get Available Cost Elements for selected Ticket
  *!*************************************************************
  *! Parameters:  The FormSet of APPYINV.SCX, The Form of APINVDT.SCX
  *!*************************************************************
  *! Returns   :  None
  *!*************************************************************
FUNCTION lfGetCstEle
  LPARAMETERS loFormSet, loForm

  LOCAL lcAry, lnL, lnC


  DECLARE loFormSet.laCostType[1]
  STORE 'N/A' TO loFormSet.laCostType
  DO CASE
      *Invoice Applied To Style PO, Shipments or Cutting Tickets
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *!*	  CASE INLIST(loForm.loRec.cIMTyp,'I','S','M','R')
      *!*	    lcAry=IIF(loForm.loRec.cIMTyp='M','loFormSet.laMCstType','loFormSet.laICstType')
    CASE INLIST(loFormSet.loRec.cIMTyp,'I','S','M','R')
      lcAry=IIF(loFormSet.loRec.cIMTyp='M','loFormSet.laMCstType','loFormSet.laICstType')
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      DECLARE loFormSet.laCostType[ALEN(&lcAry,1),3]
      =ACOPY(&lcAry,loFormSet.laCostType)
      loForm.cboCostType.REQUERY()
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *loForm.cboCostType.Value=IIF(EMPTY(loForm.loRec.cBomType),1,ASUBSCRIPT(loFormSet.laCostType,ASCAN(loFormSet.laCostType,loForm.loRec.cBomType),1))
      loForm.cboCostType.VALUE=IIF(EMPTY(loFormSet.loRec.cBomType),1,ASUBSCRIPT(loFormSet.laCostType,ASCAN(loFormSet.laCostType,loFormSet.loRec.cBomType),1))
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      *Invoice Applied To Material PO or Material MFG Orders
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *!*	  CASE INLIST(loForm.loRec.cImTyp,'T','L','F')
      *!*	    lcAry=IIF(loForm.loRec.cIMTyp='T','loFormSet.laTCstType','loFormSet.laLCstType')
    CASE INLIST(loFormSet.loRec.cImTyp,'T','L','F')
      lcAry=IIF(loFormSet.loRec.cIMTyp='T','loFormSet.laTCstType','loFormSet.laLCstType')
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      DECLARE loFormSet.laCostType[ALEN(&lcAry,1),3]
      =ACOPY(&lcAry,loFormSet.laCostType)
      loForm.cboCostType.REQUERY()
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *loForm.cboCostType.Value=IIF(EMPTY(loForm.loRec.cBomType),1,ASUBSCRIPT(loFormSet.laCostType,ASCAN(loFormSet.laCostType,loForm.loRec.cBomType),1))
      *!*	  CASE INLIST(loForm.loRec.cIMTyp,'A')
      *!*	    lcAry=IIF(loForm.loRec.cIMTyp='A','loFormSet.laACstType','loFormSet.laICstType')
      loForm.cboCostType.VALUE=IIF(EMPTY(loFormSet.loRec.cBomType),1,ASUBSCRIPT(loFormSet.laCostType,ASCAN(loFormSet.laCostType,loFormSet.loRec.cBomType),1))
    CASE INLIST(loFormSet.loRec.cIMTyp,'A')
      lcAry=IIF(loFormSet.loRec.cIMTyp='A','loFormSet.laACstType','loFormSet.laICstType')
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      DECLARE loFormSet.laCostType[ALEN(&lcAry,1),3]
      =ACOPY(&lcAry,loFormSet.laCostType)
      loForm.cboCostType.REQUERY()
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *loForm.cboCostType.Value=IIF(EMPTY(loForm.loRec.cBomType),1,ASUBSCRIPT(loFormSet.laCostType,ASCAN(loFormSet.laCostType,loForm.loRec.cBomType),1))
      *!*	  CASE INLIST(loForm.loRec.cIMTyp,'D')
      *!*	    lcAry=IIF(loForm.loRec.cIMTyp='D','loFormSet.laMCstType','loFormSet.laICstType')
      loForm.cboCostType.VALUE=IIF(EMPTY(loFormSet.loRec.cBomType),1,ASUBSCRIPT(loFormSet.laCostType,ASCAN(loFormSet.laCostType,loFormSet.loRec.cBomType),1))
    CASE INLIST(loFormSet.loRec.cIMTyp,'D')
      lcAry=IIF(loFormSet.loRec.cIMTyp='D','loFormSet.laMCstType','loFormSet.laICstType')
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      DECLARE loFormSet.laCostType[ALEN(&lcAry,1),3]
      =ACOPY&lcAry,loFormSet.laCostType)
      loForm.cboCostType.REQUERY()
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *!*	    loForm.cboCostType.Value=IIF(EMPTY(loForm.loRec.cBomType),1,ASUBSCRIPT(loFormSet.laCostType,ASCAN(loFormSet.laCostType,loForm.loRec.cBomType),1))
      loForm.cboCostType.VALUE=IIF(EMPTY(loFormSet.loRec.cBomType),1,ASUBSCRIPT(loFormSet.laCostType,ASCAN(loFormSet.laCostType,loFormSet.loRec.cBomType),1))
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[ENd]

  ENDCASE

  RETURN
  *-- End of lfGetCstEle


  *!*************************************************************
  *! Name      : lfUpdDist
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 08/30/2004
  *! Purpose   : Update Temporary AP Distribution file in case of Shipment.
  *!*************************************************************
  *! Parameters: The FormSet of APPYINV.SCX, The Form of APINVDT.SCX
  *!*************************************************************
  *! Returns   : None
  *!*************************************************************
  *Amin, If the invoice line detail is contributed we should update the Apdist with
  *line for each contirbuted account. This should be per vendor+invoice in case of
  *Shipmnet only   [start]
FUNCTION lfUpdDist
  LPARAMETERS loFormSet, loForm

  PRIVATE lnAlias , lcInvLineNo , lcApdLinNo , lcGlAccount , lnAmount, lnTotCntAmt
  STORE '' TO lnAlias , lcInvLineNo , lcApdLinNo , lcGlAccount
  STORE 0  TO lnAmount , lnTotCntAmt
  lnAlias = SELECT()
  *Add Adorment order to invoice line [Begin]
  SELECT (loFormSet.lcAPInvTkt)
  * No need to rebuild the TmpDist file if there is no contributed Shipment.
  *LOCATE FOR cImTyp = "S"  AND !EMPTY(cRsession)
  *IF EOF()
  * Nothing do to with this invoice. The TempDist file should be ok
  *  RETURN
  *ENDIF
  *E301995,1 Alb Add Adorment order to invoice line [end]

  * Before rebuilding the Temp.Dist file we should zap it.
  SELECT (loFormSet.lcTmpDist)
  ZAP
  APPEND BLANK
  gfAdd_Info(loFormSet.lcTmpDist)
  *ASM, Fix the bug that he stores blank in capacct [Start]
  
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *REPLACE apinvhdr.capacct WITH ;
  IIF(!EMPTY(APVENDOR.cAPAcct) , APVENDOR.cAPAcct ,;
  IIF(SEEK(loFormSet.AriaForm1.cboDivision.Value , 'APDIV') .AND.;
  !EMPTY(APDIV.cAPAcct) , APDIV.cAPAcct ,APSETUP.cAPAcct)) IN apinvhdr
  *loFormSet.DistLines.glAPActCode.KeyTextBox.Value = apinvhdr.capacct
  SELECT  apinvhdr
  gfREPLACE("capacct WITH '"+;
    IIF(!EMPTY(APVENDOR.cAPAcct) , APVENDOR.cAPAcct ,;
    IIF(gfSEEK(loFormSet.AriaForm1.pgfpayInv.pgHead.cboDivision.VALUE , 'APDIV') .AND.;
    !EMPTY(APDIV.cAPAcct) , APDIV.cAPAcct ,APSETUP.cAPAcct))+"'")
  SELECT (loFormSet.lcTmpDist)
  loFormSet.AriaForm1.pgfpayInv.pgDist.glAPActCode.KeyTextBox.VALUE = apinvhdr.capacct
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  *ASM, Fix the bug that he stores blank in capacct [End]
  
   *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	REPLACE CVENDCODE WITH loFormSet.AriaForm1.KBVendCode.KeyTextBox.Value  ,;
  *!*	        CINVNO    WITH loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value  ,;
  *!*	        DAPDTRDAT WITH loFormSet.AriaForm1.DtPostDate.Value ,;
  *!*	        LAPDPOST  WITH .F.        ,;
  *!*	        CAPDGLACT WITH loFormSet.DistLines.glAPActCode.KeyTextBox.Value ,;
  *!*	        CAPDACTID WITH 'A'        ,;
  *!*	        CAPDREF   WITH loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value  ,;
  *!*	        CFISFYEAR WITH loFormSet.lcDistYer  ,;
  *!*	        CFSPPRDID WITH loFormSet.lcDistPrd  ,;
  *!*	        CAPSESSNO WITH loFormSet.lcSequence ,;
  *!*	        NAPDLINNO WITH 0          ,;
  *!*	        CAPDTRTYP WITH 'I'        ,;
  *!*	        CSTATUS   WITH 'A'        ,;
  *!*	        CCURRCODE WITH loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value ,;
  *!*	        NEXRATE   WITH loFormSet.AriaForm1.txtNexRate.Value ,;
  *!*	        NCURRUNIT WITH apinvhdr.ncurrunit ,;
  *!*	        NAPDAMNT WITH -loFormSet.AriaForm1.txtInvAmount.Value
  *!*	lcTemp = '-loFormSet.AriaForm1.txtInvAmount.Value'+loFormSet.lcExSin1+;
  *!*	  'loFormSet.AriaForm1.txtNexRate.Value'+loFormSet.lcExSin2+'apinvhdr.ncurrunit'
  REPLACE CVENDCODE WITH loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE  ,;
    CINVNO    WITH loFormSet.AriaForm1.kbInvNo.KeyTextBox.VALUE  ,;
    DAPDTRDAT WITH loFormSet.AriaForm1.DtPostDate.VALUE ,;
    LAPDPOST  WITH .F.        ,;
    CAPDGLACT WITH loFormSet.AriaForm1.pgfpayInv.pgDist.glAPActCode.KeyTextBox.VALUE ,;
    CAPDACTID WITH 'A'        ,;
    CAPDREF   WITH loFormSet.AriaForm1.kbInvNo.KeyTextBox.VALUE  ,;
    CFISFYEAR WITH loFormSet.lcDistYer  ,;
    CFSPPRDID WITH loFormSet.lcDistPrd  ,;
    CAPSESSNO WITH loFormSet.lcSequence ,;
    NAPDLINNO WITH 0          ,;
    CAPDTRTYP WITH 'I'        ,;
    CSTATUS   WITH 'A'        ,;
    CCURRCODE WITH loFormSet.AriaForm1.pgfpayInv.pgHead.kbCurrCode.KeyTextBox.VALUE ,;
    NEXRATE   WITH loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.VALUE ,;
    NCURRUNIT WITH apinvhdr.ncurrunit ,;
    NAPDAMNT WITH -loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.VALUE

  lcTemp = '-loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.Value'+loFormSet.lcExSin1+;
    'loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.Value'+loFormSet.lcExSin2+'apinvhdr.ncurrunit'
   *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  REPLACE NEQVAMNT WITH EVALUATE(lcTemp)

  SELECT (loFormSet.lcAPvInvDt)
  SCAN
    lcInvLineNo = EVALUATE(loFormSet.lcAPvInvDt+'.cAPVILNo')
    lnTotCntAmt = 0
    SELECT (loFormSet.lcAPInvTkt)
    *If there is Contributed Shipmnet, update TmpDist with the lines from invoicetkt
    IF SEEK(PADR(loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE,8)+PADR(loFormSet.AriaForm1.kbInvNo.KeyTextBox.VALUE,12)+lcInvLineNo)  AND ;
        EVALUATE(loFormSet.lcAPInvTkt+'.cImTyp') = "S"  AND !EMPTY(EVALUATE(loFormSet.lcAPInvTkt+'.cRsession')) AND ;
        !EMPTY(EVALUATE(loFormSet.lcAPInvTkt+'.cTktNo'))

      SCAN REST WHILE cVendCode+cApInvNo+cApvilNo= PADR(loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE,8)+PADR(loFormSet.AriaForm1.kbInvNo.KeyTextBox.VALUE,12)+lcInvLineNo ;
          FOR EVALUATE(loFormSet.lcAPInvTkt+'.cImTyp') = "S" AND !EMPTY(EVALUATE(loFormSet.lcAPInvTkt+'.cRsession')) AND  !EMPTY(EVALUATE(loFormSet.lcAPInvTkt+'.cTktNo'))
        *Fix the contribution process  to save the invoice [Begin]
        lnTotCntAmt = lnTotCntAmt + ROUND(EVALUATE(loFormSet.lcAPInvTkt+'.nApaplAmnt'),2)
        *ALB Fix the contribution process  to save the invoice [End]
        lnAmount    = EVALUATE(loFormSet.lcAPInvTkt+'.nApaplAmnt')

        *Refresh the WIP account when changing
        lcGlAccount = EVALUATE(loFormSet.lcAPInvTkt+'.cApdGlAct')

        lcApdLinNo = EVALUATE(loFormSet.lcAPInvTkt+'.cApdLinNo')
        SELECT (loFormSet.lcTmpDist)
        IF !SEEK(PADR(loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE,8)+PADR(loFormSet.AriaForm1.kbInvNo.KeyTextBox.VALUE,12)+lcApdLinNo)
          IF lnAmount <> 0
            APPEND BLANK
            gfAdd_Info(loFormSet.lcTmpDist)
            *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
            *!*	          REPLACE CVENDCODE WITH loFormSet.AriaForm1.KBVendCode.KeyTextBox.Value  ,;
            *!*	                  CINVNO    WITH loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value  ,;
            *!*	                  DAPDTRDAT WITH loFormSet.AriaForm1.DtPostDate.Value ,;
            *!*	                  LAPDPOST  WITH .F.        ,;
            *!*	                  CAPDACTID WITH 'D'        ,;
            *!*	                  CAPDREF   WITH loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value  ,;
            *!*	                  CFISFYEAR WITH loFormSet.lcDistYer  ,;
            *!*	                  CFSPPRDID WITH loFormSet.lcDistPrd  ,;
            *!*	                  CAPSESSNO WITH loFormSet.lcSequence ,;
            *!*	                  CAPDTRTYP WITH 'I'        ,;
            *!*	                  CSTATUS   WITH 'A'        ,;
            *!*	                  NAPDLINNO WITH VAL(lcApdLinNo) ,;
            *!*	                  CCURRCODE WITH loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value ,;
            *!*	                  NEXRATE   WITH loFormSet.AriaForm1.txtNexRate.Value ,;
            *!*	                  NCURRUNIT WITH apinvhdr.ncurrunit ,;
            *!*	                  CAPDGLACT WITH lcGlAccount,;
            *!*	                  NAPDAMNT  WITH lnAmount
            *!*	          lcTemp = 'lnAmount'+loFormSet.lcExSin1+'loFormSet.AriaForm1.txtNexRate.Value'+loFormSet.lcExSin2+'apinvhdr.ncurrunit'
            *!*	          REPLACE NEQVAMNT  WITH EVALUATE(lcTemp),;
            *!*	                  CTAXCODE  WITH IIF(ApVendor.cTaxType<>'T',;
            *!*	                  IIF(loForm.laTktType[loForm.cboTktType.Value,2]='G' AND !loFormSet.llAutoScr,loFormSet.laTaxCode[loFormSet.lnTaxCode,2],''),'')
            REPLACE CVENDCODE WITH loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE  ,;
              CINVNO    WITH loFormSet.AriaForm1.kbInvNo.KeyTextBox.VALUE  ,;
              DAPDTRDAT WITH loFormSet.AriaForm1.DtPostDate.VALUE ,;
              LAPDPOST  WITH .F.        ,;
              CAPDACTID WITH 'D'        ,;
              CAPDREF   WITH loFormSet.AriaForm1.kbInvNo.KeyTextBox.VALUE  ,;
              CFISFYEAR WITH loFormSet.lcDistYer  ,;
              CFSPPRDID WITH loFormSet.lcDistPrd  ,;
              CAPSESSNO WITH loFormSet.lcSequence ,;
              CAPDTRTYP WITH 'I'        ,;
              CSTATUS   WITH 'A'        ,;
              NAPDLINNO WITH VAL(lcApdLinNo) ,;
              CCURRCODE WITH loFormSet.AriaForm1.pgfpayInv.pgHead.kbCurrCode.KeyTextBox.VALUE ,;
              NEXRATE   WITH loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.VALUE ,;
              NCURRUNIT WITH apinvhdr.ncurrunit ,;
              CAPDGLACT WITH lcGlAccount,;
              NAPDAMNT  WITH lnAmount


            lcTemp = 'lnAmount'+loFormSet.lcExSin1+'loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.Value'+loFormSet.lcExSin2+'apinvhdr.ncurrunit'
                  
            REPLACE NEQVAMNT  WITH EVALUATE(lcTemp),;
              CTAXCODE  WITH IIF(ApVendor.cTaxType<>'T',;
              IIF(loFormSet.laTktType[loForm.cboTktType.Value,2]='G' AND !loFormSet.llAutoScr,loFormSet.laTaxCode[loFormSet.lnTaxCode,2],''),'')
            *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
            
            REPLACE CTAXCODE WITH IIF(ApVendor.cTaxType<>'T',;
              IIF(EVALUATE(loFormSet.lcAPvInvDt+'.CIMTYP')='G' AND !loFormSet.llAutoScr,EVALUATE(loFormSet.lcAPvInvDt+'.CTaxCode'),''),'')
          ENDIF    && End of IF lnAmount <> 0
        ELSE
          * The following part is to handle the old records that were created thru old version.
          * That is becasue the new fields NAPDLINNO and CAPDGLACT were created and updated thru the new version
          * and it replaced with the value of APINVDTL.cAPVILNo and APINVDTL.cApdGlAct respectively.
          IF lnAmount <> 0
            IF lcGlAccount = EVALUATE(loFormSet.lcTmpDist+'.cApdGlAct')
              lcFld = loFormSet.lcTmpDist+'.NAPDAMNT'
              REPLACE &lcFld  WITH EVALUATE(loFormSet.lcTmpDist+'.NAPDAMNT')  + lnAmount
              lcFld = loFormSet.lcTmpDist+'.NEQVAMNT'
              *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
              *!*	            lcTemp='lnAmount'+loFormSet.lcExSin1+'loFormSet.AriaForm1.txtNexRate.Value'+loFormSet.lcExSin2+'apinvhdr.ncurrunit'
              lcTemp='lnAmount'+loFormSet.lcExSin1+'loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.Value'+loFormSet.lcExSin2+'apinvhdr.ncurrunit'
              *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
              REPLACE &lcFld WITH EVALUATE(loFormSet.lcTmpDist+'.NEQVAMNT')  + EVALUATE(lcTemp)
              gfAdd_Info(loFormSet.lcTmpDist)
            ELSE
              APPEND BLANK
              gfAdd_Info(loFormSet.lcTmpDist)
              *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
              *!*	            REPLACE CVENDCODE WITH loFormSet.AriaForm1.KBVendCode.KeyTextBox.Value  ,;
              *!*	                    CINVNO    WITH loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value  ,;
              *!*	                    DAPDTRDAT WITH loFormSet.AriaForm1.DtPostDate.Value ,;
              *!*	                    LAPDPOST  WITH .F.        ,;
              *!*	                    CAPDACTID WITH 'D'        ,;
              *!*	                    CAPDREF   WITH loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value  ,;
              *!*	                    CFISFYEAR WITH loFormSet.lcDistYer  ,;
              *!*	                    CFSPPRDID WITH loFormSet.lcDistPrd  ,;
              *!*	                    CAPSESSNO WITH loFormSet.lcSequence ,;
              *!*	                    CAPDTRTYP WITH 'I'        ,;
              *!*	                    CSTATUS   WITH 'A'        ,;
              *!*	                    NAPDLINNO WITH VAL(lcApdLinNo) ,;
              *!*	                    CCURRCODE WITH loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value ,;
              *!*	                    NEXRATE   WITH loFormSet.AriaForm1.txtNexRate.Value ,;
              *!*	                    NCURRUNIT WITH apinvhdr.ncurrunit ,;
              *!*	                    CAPDGLACT WITH lcGlAccount,;
              *!*	                    NAPDAMNT  WITH lnAmount
              *!*	            lcTemp = 'lnAmount'+loFormSet.lcExSin1+'loFormSet.AriaForm1.txtNexRate.Value'+loFormSet.lcExSin2+'apinvhdr.ncurrunit'
              *!*	            REPLACE NEQVAMNT  WITH EVALUATE(lcTemp),;
              *!*	                    CTAXCODE  WITH IIF(ApVendor.cTaxType<>'T',;
              *!*	                    IIF(loForm.laTktType[loForm.cboTktType.Value,2]='G' AND !loFormSet.llAutoScr,loFormSet.laTaxCode[loFormSet.lnTaxCode,2],''),'')
              REPLACE CVENDCODE WITH loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE  ,;
                CINVNO    WITH loFormSet.AriaForm1.kbInvNo.KeyTextBox.VALUE  ,;
                DAPDTRDAT WITH loFormSet.AriaForm1.DtPostDate.VALUE ,;
                LAPDPOST  WITH .F.        ,;
                CAPDACTID WITH 'D'        ,;
                CAPDREF   WITH loFormSet.AriaForm1.kbInvNo.KeyTextBox.VALUE  ,;
                CFISFYEAR WITH loFormSet.lcDistYer  ,;
                CFSPPRDID WITH loFormSet.lcDistPrd  ,;
                CAPSESSNO WITH loFormSet.lcSequence ,;
                CAPDTRTYP WITH 'I'        ,;
                CSTATUS   WITH 'A'        ,;
                NAPDLINNO WITH VAL(lcApdLinNo) ,;
                CCURRCODE WITH loFormSet.AriaForm1.pgfpayInv.pgHead.kbCurrCode.KeyTextBox.VALUE ,;
                NEXRATE   WITH loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.VALUE ,;
                NCURRUNIT WITH apinvhdr.ncurrunit ,;
                CAPDGLACT WITH lcGlAccount,;
                NAPDAMNT  WITH lnAmount
              lcTemp = 'lnAmount'+loFormSet.lcExSin1+'loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.Value'+loFormSet.lcExSin2+'apinvhdr.ncurrunit'
              REPLACE NEQVAMNT  WITH EVALUATE(lcTemp),;
                CTAXCODE  WITH IIF(ApVendor.cTaxType<>'T',;
                IIF(loFormSet.laTktType[loForm.cboTktType.Value,2]='G' AND !loFormSet.llAutoScr,loFormSet.laTaxCode[loFormSet.lnTaxCode,2],''),'')
              *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
              REPLACE CTAXCODE WITH IIF(ApVendor.cTaxType<>'T',;
                IIF(EVALUATE(loFormSet.lcAPvInvDt+'.CIMTYP')='G' AND !loFormSet.llAutoScr,EVALUATE(loFormSet.lcAPvInvDt+'.CTaxCode'),''),'')
            ENDIF   && End of IF lcGlAccount = &loFormSet.lcTmpDist..cApdGlAct
          ENDIF    && End of IF lnAmount <> 0
        ENDIF      &&End of IF !SEEK(PADR(loFormSet.AriaForm1.KBVendCode.KeyTextBox.Value,8)+PADR(loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value,12)+lcApdLinNo)
      ENDSCAN
      * If the total contribued amount is not equal to the invoice amount. add new line with the
      * difference.
      IF lnTotCntAmt <> 0 .AND. lnTotCntAmt <> EVALUATE(loFormSet.lcAPvInvDt+'.nAPAMnt')
        lnAmount    =  ABS(EVALUATE(loFormSet.lcAPvInvDt+'.nAPAMnt')) - ABS(lnTotCntAmt)

        SELECT (loFormSet.lcTmpDist)
        *fIX THE APDIST TO ADD THE DIFF. AT THE END OF THE RECORD [BEGIN]
        *APPEND BLANK
        *REPLACE CVENDCODE WITH laData[1]  ,;
        CINVNO    WITH loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value  ,;
        DAPDTRDAT WITH loFormSet.AriaForm1.DtPostDate.Value ,;
        LAPDPOST  WITH .F.        ,;
        CAPDACTID WITH 'D'        ,;
        CAPDREF   WITH loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value  ,;
        CFISFYEAR WITH loFormSet.lcDistYer  ,;
        CFSPPRDID WITH loFormSet.lcDistPrd  ,;
        CAPSESSNO WITH loFormSet.lcSequence ,;
        CAPDTRTYP WITH 'I'        ,;
        CSTATUS   WITH 'A'        ,;
        NAPDLINNO WITH 0          ,;
        CCURRCODE WITH loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value ,;
        NEXRATE   WITH loFormSet.AriaForm1.txtNexRate.Value ,;
        NCURRUNIT WITH apinvhdr.ncurrunit ,;
        CAPDGLACT WITH &loFormSet.lcAPvInvDt..cApdGlAct,;
        NAPDAMNT  WITH lnAmount    ,;
        NEQVAMNT  WITH lnAmount &loFormSet.lcExSin1 loFormSet.AriaForm1.txtNexRate.Value &loFormSet.lcExSin2 apinvhdr.ncurrunit,;
        CTAXCODE  WITH IIF(ApVendor.cTaxType<>'T',;
        IIF(loForm.laTktType[loForm.cboTktType.Value,2]='G' AND !loFormSet.llAutoScr,loFormSet.laTaxCode[loFormSet.lnTaxCode,2],''),'')
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        *!*	      lcTemp = 'lnAmount'+loFormSet.lcExSin1+'loFormSet.AriaForm1.txtNexRate.Value'+loFormSet.lcExSin2+'apinvhdr.ncurrunit'
        lcTemp = 'lnAmount'+loFormSet.lcExSin1+'loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.Value'+loFormSet.lcExSin2+'apinvhdr.ncurrunit'
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
        REPLACE NAPDAMNT  WITH NAPDAMNT + lnAmount    ,;
          NEQVAMNT  WITH NEQVAMNT + EVALUATE(lcTemp)
        gfAdd_Info(loFormSet.lcTmpDist)
        *fIX THE APDIST TO ADD THE DIFF. AT THE END OF THE RECORD [END]
      ENDIF   &&End of IF lnTotCntAmt <> 0 .AND. lnTotCntAmt <> &loFormSet.lcAPvInvDt..nAPAMnt
    ELSE
      *Fix bug when Saving the debit memo againest Return PO [BEGIN]
      lnAmount    = EVALUATE(loFormSet.lcAPvInvDt+'.nAPAMnt')
      *lnAmount    = &lcAPvInvDt..nAPAMnt * IIF(&lcAPvInvDt..CIMTYP $'RF',-1,1)
      *Fix bug when Saving the debit memo againest Return PO [END]

      lcGlAccount = EVALUATE(loFormSet.lcAPvInvDt+'.cApdGlAct')
      lcInvLineNo = EVALUATE(loFormSet.lcAPvInvDt+'.cAPVILNo')
      SELECT (loFormSet.lcTmpDist)
      **! B608492,1 SSH Allow Zero record in case of General Exp.
      *IF !SEEK(PADR(loFormSet.AriaForm1.KBVendCode.KeyTextBox.Value,8)+PADR(loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value,12)+lcInvLineNo) AND lnAmount <> 0
      IF !SEEK(PADR(loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE,8)+PADR(loFormSet.AriaForm1.kbInvNo.KeyTextBox.VALUE,12)+lcInvLineNo)

        IF EVALUATE(loFormSet.lcAPvInvDt+'.cImTyp') = "G" OR (lnAmount <> 0)
          **! B608492,1 SSH Allow Zero record in case of General Exp.
          APPEND BLANK
          gfAdd_Info(loFormSet.lcTmpDist)
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
          *!*	        REPLACE CVENDCODE WITH loFormSet.AriaForm1.KBVendCode.KeyTextBox.Value  ,;
          *!*	                CINVNO    WITH loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value  ,;
          *!*	                DAPDTRDAT WITH loFormSet.AriaForm1.DtPostDate.Value ,;
          *!*	                LAPDPOST  WITH .F.        ,;
          *!*	                CAPDACTID WITH 'D'        ,;
          *!*	                CAPDREF   WITH loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value  ,;
          *!*	                CFISFYEAR WITH loFormSet.lcDistYer  ,;
          *!*	                CFSPPRDID WITH loFormSet.lcDistPrd  ,;
          *!*	                CAPSESSNO WITH loFormSet.lcSequence ,;
          *!*	                CAPDTRTYP WITH 'I'        ,;
          *!*	                CSTATUS   WITH 'A'        ,;
          *!*	                NAPDLINNO WITH VAL(lcInvLineNo),;
          *!*	                CCURRCODE WITH loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value ,;
          *!*	                NEXRATE   WITH loFormSet.AriaForm1.txtNexRate.Value ,;
          *!*	                NCURRUNIT WITH apinvhdr.ncurrunit ,;
          *!*	                CAPDGLACT WITH lcGlAccount,;
          *!*	                NAPDAMNT  WITH lnAmount
          *!*	        lcTemp = 'lnAmount'+loFormSet.lcExSin1+'loFormSet.AriaForm1.txtNexRate.Value'+loFormSet.lcExSin2+'apinvhdr.ncurrunit'
          *!*	        REPLACE NEQVAMNT  WITH EVALUATE(lcTemp),;
          *!*	                CTAXCODE  WITH IIF(ApVendor.cTaxType<>'T',;
          *!*	                IIF(loForm.laTktType[loForm.cboTktType.Value,2]='G',loFormSet.laTaxCode[loFormSet.lnTaxCode,2],''),'')
          REPLACE CVENDCODE WITH loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE  ,;
            CINVNO    WITH loFormSet.AriaForm1.kbInvNo.KeyTextBox.VALUE  ,;
            DAPDTRDAT WITH loFormSet.AriaForm1.DtPostDate.VALUE ,;
            LAPDPOST  WITH .F.        ,;
            CAPDACTID WITH 'D'        ,;
            CAPDREF   WITH loFormSet.AriaForm1.kbInvNo.KeyTextBox.VALUE  ,;
            CFISFYEAR WITH loFormSet.lcDistYer  ,;
            CFSPPRDID WITH loFormSet.lcDistPrd  ,;
            CAPSESSNO WITH loFormSet.lcSequence ,;
            CAPDTRTYP WITH 'I'        ,;
            CSTATUS   WITH 'A'        ,;
            NAPDLINNO WITH VAL(lcInvLineNo),;
            CCURRCODE WITH loFormSet.AriaForm1.pgfpayInv.pgHead.kbCurrCode.KeyTextBox.VALUE ,;
            NEXRATE   WITH loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.VALUE ,;
            NCURRUNIT WITH apinvhdr.ncurrunit ,;
            CAPDGLACT WITH lcGlAccount,;
            NAPDAMNT  WITH lnAmount
          lcTemp = 'lnAmount'+loFormSet.lcExSin1+'loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.Value'+loFormSet.lcExSin2+'apinvhdr.ncurrunit'
 
          REPLACE NEQVAMNT  WITH EVALUATE(lcTemp),;
            CTAXCODE  WITH IIF(ApVendor.cTaxType<>'T',;
            IIF(loFormSet.laTktType[loForm.cboTktType.Value,2]='G',loFormSet.laTaxCode[loFormSet.lnTaxCode,2],''),'')
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
          *Fix problem in AP Invoice lines that tax code applies to all lines [Begin]
          REPLACE CTAXCODE WITH IIF(ApVendor.cTaxType<>'T',;
            IIF(EVALUATE(loFormSet.lcAPvInvDt+'.CIMTYP')='G' AND !loFormSet.llAutoScr,EVALUATE(loFormSet.lcAPvInvDt+'.CTaxCode'),''),'')
          *Fix problem in AP Invoice lines that tax code applies to all lines [End]
        ENDIF
      ENDIF
    ENDIF
  ENDSCAN

  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *SELECT *,SPACE(60) AS 'CDISCRIP',;
  'S' AS 'cStatus',;
  SPACE(1) AS 'cUpdSerNo',;
  RECNO() AS 'NRECNO';
  FROM (oAriaApplication.DataDir+'APDIST') ;
  WHERE CINVNO + CVENDCODE + cAPDTrTyp = loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value + loFormSet.AriaForm1.KBVendCode.KeyTextBox.Value + "I"  ;
  AND CAPDSTAT <> 'V';
  INTO DBF (oAriaApplication.WorkDir+loFormSet.lcTmpDist2)
  =gfSqlRun("SELECT * From APDIST Where CINVNO = '"+;
    loFormSet.AriaForm1.kbInvNo.KeyTextBox.VALUE +;
    "' AND CVENDCODE ='"+ loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE +"' AND cAPDTrTyp ='I' AND CAPDSTAT <> 'V'",'APDIST',.F.,'APDST_Tmp')

  SELECT *,SPACE(60) AS 'CDISCRIP',;
    'S' AS 'cStatus',;
    SPACE(1) AS 'cUpdSerNo',;
    RECNO() AS 'NRECNO';
    FROM APDST_Tmp ;
    WHERE CINVNO + CVENDCODE + cAPDTrTyp = loFormSet.AriaForm1.kbInvNo.KeyTextBox.VALUE + loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE + "I"  ;
    AND CAPDSTAT <> 'V';
    INTO DBF (oAriaApplication.WorkDir+loFormSet.lcTmpDist2)
 *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

  SELECT (loFormSet.lcTmpDist2)
  REPLACE ALL CAPDSTAT  WITH 'V' ,;
    CSTATUS   WITH 'M'



  SELECT (loFormSet.lcTmpDist2)
  * Void all records in the TmpDist file
  **! B608492,1 SSH Allow Zero record in case of General Exp.
  SCAN &&FOR nApdAmnt <> 0

    SELECT (loFormSet.lcTmpDist2)
    SCATTER MEMVAR MEMO

    SELECT (loFormSet.lcTmpDist)
    APPEND BLANK
    GATHER MEMVAR MEMO

    * Add reverse line.
    m.cStatus   = 'V'
    m.cBatchNo  = ' '
    m.cTrnSledn = ' '
    m.cStatus   = 'A'
    m.nEntryNo  = 0
    m.lAPDPost  = .F.
    m.nApdAmnt  = -1 * m.nApdAmnt
    m.nEqvAmnt  = -1 * m.nEqvAmnt
    m.CAPSESSNO = loFormSet.lcSequence
    APPEND BLANK
    GATHER MEMVAR MEMO
  ENDSCAN

  SELECT (lnAlias)
  RETURN
  *-- End of lfUpdDist


  ***LLL***


  ***NNN***


  *!*************************************************************
  *! Name      : lfvNInvLine
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 09/02/2004
  *! Purpose   : Called form the Click Evenet of the New Button in APINVDT.SCX
  *!*************************************************************
  *! Parameters:  The FormSet of APPYINV.SCX, The Form of APINVDT.SCX
  *!*************************************************************
  *! Returns   :  None
  *!*************************************************************
FUNCTION lfvNInvLine
  LPARAMETERS loFormSet, loForm

  *?AMIN
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *SCATTER NAME loForm.loRec BLANK
  SELECT(IIF(loFormSet.ActiveMode="V",'APVINVDT2',loFormSet.lcAPvInvDt))
  SCATTER NAME loFormSet.loRec BLANK
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  *Old: SHOW GETS DISABLE ONLY &&Revise
  WITH loForm
    STORE .F. TO .cboCostType.ENABLED, .cboMFGOpr.ENABLED, .kbInvTktNo.ENABLED, .cboLotNo.ENABLED, ;
      .cntStyle.ENABLED, .cntItem.ENABLED, .kbDyelot.ENABLED, .txtItem.ENABLED, .txtStyDesc.ENABLED, ;
      .glApDGlAct.ENABLED, .cntAP_Qty.ENABLED, .cntAPApr_Qty.ENABLED, .cmdAuto.ENABLED, ;
      .cmdRemove.ENABLED, .cmdContribute.ENABLED, .cmdMultiApprove.ENABLED
  ENDWITH
  loForm.REFRESH()
  *Old: SHOW GET loForm.cboTktType.Value ENABLE  &&lower &&Revise
  loForm.cboTktType.ENABLED = .T.
  *Old: _CUROBJ = OBJNUM(loForm.cboTktType.Value)  &&lower&&Old CurObj
  loForm.cboTktType.SETFOCUS()
  RETURN
  *-- End of lfvNInvLine


  *!*************************************************************
  *! Name      : lfvTktType
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 09/02/2004
  *! Purpose   : Validate applied ticket type (cboTktType) in APINVDT.SCX
  *!*************************************************************
  *! Parameters:  The FormSet of APPYINV.SCX, The Form of APINVDT.SCX
  *!*************************************************************
  *! Returns   :  None
  *!*************************************************************
FUNCTION lfvTktType
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *LPARAMETERS loFormSet, loForm
  PARAMETERS loFormSet, loForm
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *SCATTER NAME loForm.loRec BLANK
  SELECT(IIF(loFormSet.ActiveMode="V",'APVINVDT2',loFormSet.lcAPvInvDt))
  SCATTER NAME loFormSet.loRec BLANK
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  loForm.REFRESH()

  DIMENSION laCodes[ALEN(loFormSet.laCodes,1),ALEN(loFormSet.laCodes,2)]
  =ACOPY(loFormSet.laCodes,laCodes)
  =gfwCodePop(@laCodes,'MFGCODE','N')
  =ACOPY(laCodes,loFormSet.laCodes)

  =IIF(APVENDOR.CTAXTYPE<>'T',gfwCodePop(@laCodes,'CTAXCODE','N'),.T.)
  =ACOPY(laCodes,loFormSet.laCodes)
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *loForm.loRec.cIMTyp = loForm.laTktType[loForm.cboTktType.Value,2]
  *IF loForm.loRec.cIMTyp = 'G'
  loFormSet.loRec.cIMTyp = loFormSet.laTktType[loForm.cboTktType.Value,2]
  IF loFormSet.loRec.cIMTyp = 'G'
   *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    *Add this line to refresh the default Expense Account [Begin]

    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *  loFormSet.lcDistAcct = IIF(!EMPTY(APVENDOR.cExpAcct) , APVENDOR.cExpAcct ,;
    IIF(SEEK(loFormSet.AriaForm1.cboDivision.Value , 'APDIV') .AND.;
    !EMPTY(APDIV.cExpAcct) , APDIV.cExpAcct ,;
    APSETUP.cExpAcct))
    loFormSet.lcDistAcct = IIF(!EMPTY(APVENDOR.cExpAcct) , APVENDOR.cExpAcct ,;
      IIF(gfSEEK(loFormSet.AriaForm1.pgfpayInv.pgHead.cboDivision.VALUE , 'APDIV') .AND.;
      !EMPTY(APDIV.cExpAcct) , APDIV.cExpAcct ,;
      APSETUP.cExpAcct))
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    *Add this line to refresh the default Expense Account [End]

    *Get the next sequence line no. [Start]
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *REPLACE apinvhdr.nlastvilno WITH lfGetMaxLin(loFormSet, loForm) IN apinvhdr
    SELECT apinvhdr
    gfREPLACE("nlastvilno WITH lfGetMaxLin(loFormSet, loForm)")
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    *Get the next sequence line no. [End]
    SELECT (loFormSet.lcAPvInvDt)
    REPLACE apinvhdr.nlastvilno WITH apinvhdr.nlastvilno + 1 IN apinvhdr
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *!*	  *loForm.loRec.cStatus   = 'A'
    *!*	  loForm.loRec.cVendCode = loFormSet.AriaForm1.KBVendCode.KeyTextBox.Value
    *!*	  loForm.loRec.cAPInvNo  = loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value
    *!*	  loForm.loRec.cApVILNo  = STR(apinvhdr.nlastvilno,4)
    *!*	  loForm.loRec.cApDGlAct = loFormSet.lcDistAcct
    loFormSet.loRec.cStatus   = 'A'
    loFormSet.loRec.cVendCode = loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE
    loFormSet.loRec.cAPInvNo  = loFormSet.AriaForm1.kbInvNo.KeyTextBox.VALUE
    loFormSet.loRec.cApVILNo  = STR(apinvhdr.nlastvilno,4)
    loFormSet.loRec.cApDGlAct = loFormSet.lcDistAcct
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[ENd]
    
    =IIF(APVENDOR.CTAXTYPE<>'T',gfwCodePop(@laCodes,'CTAXCODE','D'),.T.)
    =ACOPY(laCodes,loFormSet.laCodes)
    
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *!*	  INSERT INTO (loFormSet.lcAPvInvDt) FROM NAME loForm.loRec
    *!*	  =lfUpdApDist(loFormSet,loForm,loForm.loRec.cApVILNo,0,loForm.loRec.cApDGlAct,loForm.loRec.cIMTyp)
    INSERT INTO (loFormSet.lcAPvInvDt) FROM NAME loFormSet.loRec
    =lfUpdApDist(loFormSet,loForm,loFormSet.loRec.cApVILNo,0,loFormSet.loRec.cApDGlAct,loFormSet.loRec.cIMTyp)
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    
    lfgrdInvDtAfterRowCol(loFormSet,loForm)
    *B608528,1 MHM 04/21/2008 Invoice Lines-cannot amend the GL account for General Expense Item[Start]
    loForm.glApDGlAct.ENABLED = .T.
    IF apvendor.ctaxtype = 'T'
      loForm.cbotaxCode.VISIBLE= .F.
      loForm.lbltaxCode.VISIBLE = .F.
      loForm.lblTaxColon.VISIBLE = .F.
    ENDIF
    * B608528,1 MHM 04/21/2008 Invoice Lines-cannot amend the GL account for General Expense Item[END]
  ELSE
    =lfGetCstEle(loFormSet, loForm)
    *Old: =lfRefresh('APINVD13')
    *Old: SHOW GET loForm.cboCostType.Value ENABLE  &&Revise
    loForm.cboCostType.ENABLED = .T.
    loForm.REFRESH()
  ENDIF
  RETURN 1
  *-- End of lfvTktType


  *!*************************************************************
  *! Name      : lfvCostType
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 09/02/2004
  *! Purpose   : Validate Invoiced Cost type (cboCostType) in APINVDT.SCX
  *!*************************************************************
  *! Parameters:  The FormSet of APPYINV.SCX, The Form of APINVDT.SCX
  *!*************************************************************
  *! Returns   :  None
  *!*************************************************************
FUNCTION lfvCostType
  LPARAMETERS loFormSet, loForm

  *Get the next sequence line no. [Start]
  REPLACE apinvhdr.nlastvilno WITH lfGetMaxLin(loFormSet, loForm) IN apinvhdr
  *Get the next sequence line no. [End]
  SELECT (loFormSet.lcAPvInvDt)
  REPLACE apinvhdr.nlastvilno WITH apinvhdr.nlastvilno + 1 IN apinvhdr
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	loForm.loRec.cStatus   = 'A'
  *!*	loForm.loRec.cVendCode = loFormSet.AriaForm1.KBVendCode.KeyTextBox.Value
  *!*	loForm.loRec.cAPInvNo  = loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value
  *!*	loForm.loRec.cApVILNo  = STR(apinvhdr.nlastvilno,4)
  *!*	loForm.loRec.cIMTyp    = loForm.laTktType[loForm.cboTktType.Value,2]
  *!*	loForm.loRec.cBomType  = loFormSet.laCostType[loForm.cboCostType.Value,2]
  *!*	loForm.loRec.cCostType = loFormSet.laCostType[loForm.cboCostType.Value,3]
  *!*	loForm.loRec.cApDGlAct = loFormSet.lcDistAcct
  *!*	IF loForm.loRec.cCostType = 'M'
  loFormSet.loRec.cStatus   = 'A'
  loFormSet.loRec.cVendCode = loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE
  loFormSet.loRec.cAPInvNo  = loFormSet.AriaForm1.kbInvNo.KeyTextBox.VALUE
  loFormSet.loRec.cApVILNo  = STR(apinvhdr.nlastvilno,4)
  loFormSet.loRec.cIMTyp    = loFormSet.laTktType[loForm.cboTktType.Value,2]
  loFormSet.loRec.cBomType  = loFormSet.laCostType[loForm.cboCostType.Value,2]
  loFormSet.loRec.cCostType = loFormSet.laCostType[loForm.cboCostType.Value,3]
  loFormSet.loRec.cApDGlAct = loFormSet.lcDistAcct
  IF loFormSet.loRec.cCostType = 'M'
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    DIMENSION laCodes[ALEN(loFormSet.laCodes,1),ALEN(loFormSet.laCodes,2)]
    =ACOPY(loFormSet.laCodes,laCodes)
    =gfwCodePop(@laCodes,'MFGCODE','D')
    =ACOPY(laCodes,loFormSet.laCodes)
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *  loForm.loRec.cOprCode = loFormSet.laMfgCode[loFormSet.lnMfgOpr,2]
    loFormSet.loRec.cOprCode = loFormSet.laMfgCode[loFormSet.lnMfgOpr,2]
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    *Old: SHOW GET loFormSet.lnMfgOpr ENABLE &&Revise
    loForm.cboMFGOpr.REQUERY()
    loForm.cboMFGOpr.ENABLED = .T.
  ELSE
    DIMENSION laCodes[ALEN(loFormSet.laCodes,1),ALEN(loFormSet.laCodes,2)]
    =ACOPY(loFormSet.laCodes,laCodes)
    =gfwCodePop(@laCodes,'MFGCODE','N')
    =ACOPY(laCodes,loFormSet.laCodes)
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *!*	  loForm.loRec.cOprCode = REPLICATE(IIF(loForm.loRec.cCostType='P','*',;
    *!*	      IIF(loForm.loRec.cCostType='D','#',' ')),6)
    *!*	  INSERT INTO (loFormSet.lcAPvInvDt) FROM NAME loForm.loRec
    loFormSet.loRec.cOprCode = REPLICATE(IIF(loFormSet.loRec.cCostType='P','*',;
      IIF(loFormSet.loRec.cCostType='D','#',' ')),6)
    INSERT INTO (loFormSet.lcAPvInvDt) FROM NAME loFormSet.loRec
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    lfgrdInvDtAfterRowCol(loFormSet,loForm)
    *Control the cut tickit and style [Begin]
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *IF INLIST(loForm.loRec.cIMTyp,'I','S','M','A','D','R')
    IF INLIST(loFormSet.loRec.cIMTyp,'I','S','M','A','D','R')
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      *Old: SHOW GET ibStyle    ENABLE &&Revise
      *Old: SHOW GET lcStyle    ENABLE &&Revise
      *Old: SHOW GET ibStyDye   ENABLE &&Revise
      *Old: SHOW GET lcStyDye   ENABLE &&Revise
      STORE .F. TO loForm.cntItem.VISIBLE, loForm.txtItem.VISIBLE
      STORE .T. TO loForm.cntStyle.VISIBLE, loForm.cntStyle.ENABLED
      loForm.kbDyelot.ENABLED = .T.
    ELSE
      *Old: SHOW GET lcFabric   ENABLE &&Revise
      *Old: SHOW GET lcFabClr   ENABLE &&Revise
      *Old: SHOW GET ibFabric   ENABLE &&Revise
      *Old: SHOW GET ibFabClr   ENABLE &&Revise
      *Old: SHOW GET ibFabDye   ENABLE &&Revise
      *Old: SHOW GET lcFabDye   ENABLE &&Revise
      STORE .F. TO loForm.cntStyle.VISIBLE, loForm.txtItem.VISIBLE
      STORE .T. TO loForm.cntItem.VISIBLE, loForm.cntItem.ENABLED
      loForm.kbDyelot.ENABLED = .T.
    ENDIF
    *Old: SHOW GET ibTktNo    ENABLE &&Revise
    *Old: SHOW GET loForm.kbInvTktNo.KeyTextBox.Value ENABLE&&Revise
    loForm.kbInvTktNo.ENABLED = .T.
    *Control the cut tickit and style [End]

  ENDIF
  loForm.REFRESH()
  SELECT (loFormSet.lcAPvInvDt)

  RETURN 1
  *-- End of lfvCostType


  *!*************************************************************
  *! Name      : lfvMfgOpr
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 09/02/2004
  *! Purpose   : Validate MFG Operation (cboMFGOpr) in APINVDT.SCX
  *!*************************************************************
  *! Parameters:  The FormSet of APPYINV.SCX, The Form of APINVDT.SCX
  *!*************************************************************
  *! Returns   :  None
  *!*************************************************************
FUNCTION lfvMfgOpr
  LPARAMETERS loFormSet, loForm
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *loForm.loRec.cOprCode = loFormSet.laMfgCode[loFormSet.lnMfgOpr,2]
  loFormSet.loRec.cOprCode = loFormSet.laMfgCode[loFormSet.lnMfgOpr,2]
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[ENd]
  DIMENSION laMfgRFld[ALEN(loFormSet.laMfgRFld,1),ALEN(loFormSet.laMfgRFld,2)]
  =ACOPY(loFormSet.laMfgRFld,laMfgRFld)

  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *=gfRltFld(loForm.loRec.cOprCode,@laMfgRFld,'MFGCODE')
  =gfRltFld(loFormSet.loRec.cOprCode,@laMfgRFld,'MFGCODE')
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[ENd]

  =ACOPY(laMfgRFld,loFormSet.laMfgRFld)
  IF !EMPTY(loFormSet.lcMfgGlAcnt)
    *Message : 04152
    *MFG Code has been setup to be applied directly through the
    *cost sheet program
    *Button : 00000
    *Ok
    =gfModalGen("TRM04152B00000","DIALOG",loFormSet.laMfgCode[loFormSet.lnMfgOpr,1])
    
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *loForm.loRec.cOprCode = cOprCode
    loFormSet.loRec.cOprCode = cOprCode
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    
    *Old: SHOW GET loFormSet.lnMfgOpr &&Revise
    loForm.cboMFGOpr.REFRESH()
    loForm.REFRESH()
    RETURN 0
  ENDIF
  
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *INSERT INTO (loFormSet.lcAPvInvDt) FROM NAME loForm.loRec
  INSERT INTO (loFormSet.lcAPvInvDt) FROM NAME loFormSet.loRec
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  
  lfgrdInvDtAfterRowCol(loFormSet,loForm)
  *Control the cut tickit and style [Begin]
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *IF INLIST(loForm.loRec.cIMTyp,'I','S','M','D')
  IF INLIST(loFormSet.loRec.cIMTyp,'I','S','M','D')
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    *E301995,1 Alb Add Adorment/Dying/MMFG order to invoice line [END]
    *Old: SHOW GET ibStyle    ENABLE &&Revise
    *Old: SHOW GET lcStyle    ENABLE &&Revise
    *Old: SHOW GET ibStyDye   ENABLE &&Revise
    *Old: SHOW GET lcStyDye   ENABLE &&Revise
    STORE .F. TO loForm.cntItem.VISIBLE, loForm.txtItem.VISIBLE
    STORE .T. TO loForm.cntStyle.VISIBLE, loForm.cntStyle.ENABLED
    loForm.kbDyelot.ENABLED = .T.
  ELSE
    *Old: SHOW GET lcFabric   ENABLE &&Revise
    *Old: SHOW GET lcFabClr   ENABLE &&Revise
    *Old: SHOW GET ibFabric   ENABLE &&Revise
    *Old: SHOW GET ibFabClr   ENABLE &&Revise
    *Old: SHOW GET ibFabDye   ENABLE &&Revise
    *Old: SHOW GET lcFabDye   ENABLE &&Revise
    STORE .F. TO loForm.cntStyle.VISIBLE, loForm.txtItem.VISIBLE
    STORE .T. TO loForm.cntItem.VISIBLE, loForm.cntItem.ENABLED
    loForm.kbDyelot.ENABLED = .T.
  ENDIF
  *Old: SHOW GET ibTktNo    ENABLE &&Revise
  *Old: SHOW GET loForm.kbInvTktNo.KeyTextBox.Value ENABLE  &&lower &&Revise
  loForm.kbInvTktNo.ENABLED = .T.
  *Control the cut tickit and style [End]
  loForm.REFRESH()
  SELECT (loFormSet.lcAPvInvDt)
  RETURN 1
  *-- End of lfvMfgOpr

  *!*************************************************************
  *! Name      : lfvAplTkt
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 09/02/2004
  *! Purpose   : Validate Ticket Applied to Invoice Line (kbInvTktNo) in APINVDT.SCX
  *!*************************************************************
  *! Parameters:  The FormSet of APPYINV.SCX, The Form of APINVDT.SCX
  *!*************************************************************
  *! Returns   :  None
  *!*************************************************************
FUNCTION lfvAplTkt
  LPARAMETERS loFormSet, loForm


  loFormSet.llBrowse = loForm.kbInvTktNo.Selectedfrombrowse
  *Store the exist value of cTktNo.
  loFormSet.lcCutTktNo = cTktNo

  PRIVATE lcBrFields,lcLinkCode
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	IF loForm.kbInvTktNo.KeyTextBox.Value <> IIF(loForm.loRec.cIMTyp='S',ShipNO,cTktNo) AND ;
  *!*	    lfIsContrib(loFormSet, loForm)
  IF loForm.kbInvTktNo.KeyTextBox.VALUE <> IIF(loFormSet.loRec.cIMTyp='S',ShipNO,cTktNo) AND ;
      lfIsContrib(loFormSet, loForm)
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    loFormSet.llBrowse = .F.
    loForm.kbInvTktNo.Selectedfrombrowse = .F.
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *loForm.kbInvTktNo.KeyTextBox.Value = IIF(loForm.loRec.cIMTyp='S',ShipNo,cTktNo)
    loForm.kbInvTktNo.KeyTextBox.VALUE = IIF(loFormSet.loRec.cIMTyp='S',ShipNo,cTktNo)
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    loForm.REFRESH()
    RETURN
  ENDIF
  lcLinkCode = SPACE(6)
  kbInvTktNo = loForm.kbInvTktNo.KeyTextBox.VALUE
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *=lfvTicket(loFormSet,loForm,loForm.laTktType[loForm.cboTktType.Value,2],@kbInvTktNo,@lcLinkCode,loForm.loRec.cCostType)
  =lfvTicket(loFormSet,loForm,loFormSet.laTktType[loForm.cboTktType.Value,2],@kbInvTktNo,@lcLinkCode,loFormSet.loRec.cCostType)
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  loForm.kbInvTktNo.KeyTextBox.VALUE = kbInvTktNo
  
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *IF loForm.kbInvTktNo.KeyTextBox.Value <> IIF(loForm.loRec.cIMTyp='S',ShipNO,cTktNo)
  IF loForm.kbInvTktNo.KeyTextBox.VALUE <> IIF(loFormSet.loRec.cIMTyp='S',ShipNO,cTktNo)
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  
    *Assign the new Ticket no to cTktNo [Begin]
    IF !EMPTY(loForm.kbInvTktNo.KeyTextBox.VALUE)
    
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *loForm.loRec.cTktNo = loForm.kbInvTktNo.KeyTextBox.Value
      loFormSet.loRec.cTktNo = loForm.kbInvTktNo.KeyTextBox.VALUE
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      
    ELSE
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *loForm.loRec.cTktNo = loFormSet.lcCutTktNo
      loFormSet.loRec.cTktNo = loFormSet.lcCutTktNo
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    ENDIF


    *If Item has been entered, Check if this Item exists in the select Ticket
    IF !EMPTY(loForm.kbInvTktNo.KeyTextBox.VALUE) AND !EMPTY(ITEM)
    
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *!*	    IF !lfItemQty(loFormSet,loForm,loForm.loRec.cIMTyp,loForm.kbInvTktNo.KeyTextBox.Value,loForm.loRec.cLotNo,;
      *!*	       loForm.loRec.cBomType,loForm.loRec.cOprCode,loForm.loRec.Item,loForm.loRec.Color,;
      *!*	       loForm.loRec.cDyelot)
      *!*	      loForm.kbInvTktNo.KeyTextBox.Value = IIF(loForm.loRec.cIMTyp='S',ShipNo,cTktNo)
      IF !lfItemQty(loFormSet,loForm,loFormSet.loRec.cIMTyp,loForm.kbInvTktNo.KeyTextBox.VALUE,loFormSet.loRec.cLotNo,;
          loFormSet.loRec.cBomType,loFormSet.loRec.cOprCode,loFormSet.loRec.ITEM,loFormSet.loRec.COLOR,;
          loFormSet.loRec.cDyelot)
        loForm.kbInvTktNo.KeyTextBox.VALUE = IIF(loFormSet.loRec.cIMTyp='S',ShipNo,cTktNo)
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
        loForm.REFRESH()
        RETURN
      ENDIF
      =lfShowWind(loFormSet, loForm)
    ENDIF
    IF loFormSet.laSetups[3,2]='Y'
      IF !SEEK(lcLinkCode+'013','GL_LINK')
        =SEEK('DEFDEF'+'013','GL_LINK')
      ENDIF
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *STORE GL_Link.GlAcnt TO loForm.loRec.cApDGlAct
      STORE GL_Link.GlAcnt TO loFormSet.loRec.cApDGlAct
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    ELSE
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *        STORE loFormSet.lcDistAcct TO loForm.loRec.cApDGlAct
      STORE loFormSet.lcDistAcct TO loFormSet.loRec.cApDGlAct
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    ENDIF
    *Change the defaulte WIP Account to LFNM Account (ENGLAND)[Begin]
    *IF ASCAN(laEvntTrig , PADR('UPDTAPGL',10)) <> 0
    *=gfDoTriger('APPYINV',PADR('UPDTAPGL',10))
    *ENDIF
    *Change the defaulte WIP Account to LFNM Account (ENGLAND)[end]
    SELECT (loFormSet.lcAPvInvDt)
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *!*	  REPLACE cTktNo    WITH IIF(loForm.loRec.cIMTyp='S','',loForm.kbInvTktNo.KeyTextBox.Value) ,;
    *!*	          ShipNO    WITH IIF(loForm.loRec.cIMTyp='S',loForm.kbInvTktNo.KeyTextBox.Value,'') ,;
    *!*	          cApDGlAct WITH loForm.loRec.cApDGlAct ,;
    *!*	          cStatus   WITH IIF(cStatus='S','M',cStatus)
    *!*	  loForm.loRec.cTktNo = cTKtNo
    *!*	  loForm.loRec.ShipNo = ShipNo
    *!*	  IF !EMPTY(loForm.kbInvTktNo.KeyTextBox.Value) AND loForm.loRec.cCostType='M' AND lfLots(loForm)
    REPLACE cTktNo    WITH IIF(loFormSet.loRec.cIMTyp='S','',loForm.kbInvTktNo.KeyTextBox.VALUE) ,;
      ShipNO    WITH IIF(loFormSet.loRec.cIMTyp='S',loForm.kbInvTktNo.KeyTextBox.VALUE,'') ,;
      cApDGlAct WITH loFormSet.loRec.cApDGlAct ,;
      cStatus   WITH IIF(cStatus='S','M',cStatus)
    loFormSet.loRec.cTktNo = cTKtNo
    loFormSet.loRec.ShipNo = ShipNo
    IF !EMPTY(loForm.kbInvTktNo.KeyTextBox.VALUE) AND loFormSet.loRec.cCostType='M' AND lfLots(loFormSet,loForm)
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      *Old: SHOW GET loForm.cboLotNo.Value ENABLE  &&lower &&Revise
      loForm.cboLotNo.ENABLED = .T.
    ELSE
      *Old: SHOW GET loForm.cboLotNo.Value DISABLE  &&lower &&Revise
      loForm.cboLotNo.ENABLED = .F.
    ENDIF
    IF EMPTY(loForm.kbInvTktNo.KeyTextBox.VALUE)
      *Old: SHOW GET ibWIPAcnt   DISABLE &&Revise
      *Old: SHOW GET m.cApDGlAct DISABLE &&Revise
      loForm.glApDGlAct.ENABLED = .F.
    ELSE
      =lfUpdAplTkt(loFormSet, loForm)
      *Old: SHOW GET ibWIPAcnt   ENABLE &&Revise
      *Old: SHOW GET m.cApDGlAct ENABLE &&Revise
      loForm.glApDGlAct.ENABLED = .T.
      *Old: SHOW GET ibTktNo    DISABLE &&Revise
      *Old: SHOW GET loForm.kbInvTktNo.KeyTextBox.Value DISABLE  &&lower &&Revise
      loForm.kbInvTktNo.ENABLED = .F.
    ENDIF
  ENDIF
  loFormSet.llBrowse = .F.
  loForm.kbInvTktNo.Selectedfrombrowse = .F.

  loForm.REFRESH()

  RETURN
  *-- End of lfvAplTkt


  *!*************************************************************
  *! Name      : lfIsContrib
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 09/02/2004
  *! Purpose   : Check if this invoice line has been contrinuted
  *!*************************************************************
  *! Parameters:  The FormSet of APPYINV.SCX, The Form of APINVDT.SCX
  *!*************************************************************
  *! Returns   :  True/Flase
  *!*************************************************************
FUNCTION lfIsContrib
  LPARAMETERS loFormSet, loForm

  PRIVATE lnAlias
  lnAlias = SELECT()
  SELECT (loFormSet.lcAPInvTkt)
  lcTemp = loFormSet.lcAPvInvDt+'.cVendCode+'+loFormSet.lcAPvInvDt+'.cApInvNo+'+;
    loFormSet.lcAPvInvDt+'.cApVILNo'
  =SEEK(EVALUATE(lcTemp))
  LOCATE REST WHILE cVendCode+cApInvNo+cApVILNo=EVALUATE(lcTemp) FOR !EMPTY(cRSession)
  IF FOUND()
    *Message : 04174
    *This Invoice line has been contributed. Cannot Modify.
    *Button : 00000
    * Ok
    =gfModalGen("TRM04174B00000","DIALOG")
  ENDIF
  SELECT (lnAlias)
  RETURN (FOUND(loFormSet.lcAPInvTkt))
  *-- End of lfIsContrib


  *!*************************************************************
  *! Name      : lfvLotNo
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 09/02/2004
  *! Purpose   : Validate Operation Lot #
  *!*************************************************************
  *! Parameters:  The FormSet of APPYINV.SCX, The Form of APINVDT.SCX
  *!*************************************************************
  *! Returns   :  None
  *!*************************************************************
FUNCTION lfvLotNo
  LPARAMETERS loFormSet, loForm

  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	loForm.loRec.cLotNo = loForm.laOprLots[loForm.cboLotNo.Value]
  *!*	IF loForm.loRec.cLotNo <> cLotNo
  *!*	  REPLACE cLotNo  WITH loForm.loRec.cLotNo ,;
  *!*	          cStatus WITH IIF(cStatus='S','M',cStatus)
  loFormSet.loRec.cLotNo = loFormSet.laOprLots[loForm.cboLotNo.Value]
  IF loFormSet.loRec.cLotNo <> cLotNo
    REPLACE cLotNo  WITH loFormSet.loRec.cLotNo ,;
      cStatus WITH IIF(cStatus='S','M',cStatus)
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  ENDIF
  loForm.REFRESH()
  RETURN
  *-- End of lfvLotNo


  *!*************************************************************
  *! Name      : lfvTicket
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 09/02/2004
  *! Purpose   : Validate Tickets
  *!*************************************************************
  *! Parameters:  The FormSet of APPYINV.SCX, The Form of APINVDT.SCX,
  *!              lcType     : Ticket Type
  *!                                   'S' : Shipment
  *!                                   'I' : Style PO
  *!                                   'R' : Style PO Return
  *!                                   'M' : Style Cutting Ticket
  *!                                   'L' : Material PO
  *!                                   'F' : Material PO Return
  *!                                   'T' : Material MFG Order
  *!              lcTicket   : Ticket #
  *!              lcLinkCode : WIP Link Code
  *!              lcCstType  : Cost Type
  *!*************************************************************
  *! Returns   :  None
  *!*************************************************************
FUNCTION lfvTicket
  PARAMETERS loFormSet, loForm, lcType, lcTicket, lcLinkCode, lcCstType

  PRIVATE lcBrFields, lnAlias, lcBusDoc, lcWorkOrder, lcBrowseCursor, lcbrowsetitle, ;
    lcBrowseTableName, lcBrowseIndexExpression, lcBrowseIndexFields, lcBrowseIndexName, ;
    lcBrowseKey, lcBrowseAliasName, lcBrowseFields


  lnAlias = SELECT()
  *Fix problem in AP Invoice lines that tax code applies to all lines[Begin]
  lnVendRecNo = RECNO('APVENDOR')
  *Fix problem in AP Invoice lines that tax code applies to all lines[End]
  DO CASE
      *Style Purchase Order
    CASE INLIST(lcType,'A','D','I','R')
      lcBusDoc = IIF(lcType='R','R','P')
      lcWorkOrder=IIF(INLIST(lcType,'A','D'),lcType,'P')
      lcBrowseCursor = loFormSet.POSHDR.lcCursorView
      lcbrowsetitle  = 'PO'
      lcBrowseTableName = "POSHDR"
      lcBrowseIndexExpression = "CBUSDOCU+CSTYTYPE+PO"
      lcBrowseIndexFields     = "CBUSDOCU,CSTYTYPE,PO"
      lcBrowseIndexName       = "POSHDR"
      lcBrowseKey             = lcBusDoc + lcWorkOrder
      lcBrowseAliasName       = loFormSet.POSHDR.lcCursorView
      lcBrowseFields = "PO        :R:10:H='PO #' ,"+;
        "Status    :R: 3:H='S' ,"+;
        "Vendor    :R:10:H='Vendor' ,"+;
        "Entered   :R:12:H='Entered' ,"+;
        "Complete  :R:12:H='Complete' ,"+;
        "nStyOrder :R:10:H='Total Qty.' ,"+;
        "POTotal   :R:15:H='Amount' ,"+;
        "Receive   :R:10:H='Receive' ,"+;
        "Open      :R:10:H='Open' "

      *Style Shipments
    CASE lcType = 'S'
      lcBusDoc = 'P'
      lcWorkOrder='P'
      lcBrowseCursor = loFormSet.SHPMTHDR.lcCursorView
      lcbrowsetitle  = 'Shipment'
      lcBrowseTableName = "SHPMTHDR"
      lcBrowseIndexExpression = "CBUSDOCU+CSHPTYPE+SHIPNO"
      lcBrowseIndexFields     = "CBUSDOCU,CSHPTYPE,SHIPNO"
      lcBrowseIndexName       = "SHPMTHDR"
      lcBrowseKey             = lcBusDoc + lcWorkOrder
      lcBrowseAliasName       = loFormSet.SHPMTHDR.lcCursorView
      lcBrowseFields = "ShipNo:H='Shipment #', Status, Entered:13, Cartons,"+;
        "AirWayB:H='Air-way Bill#', ETA:H='E.T.A.':13,"+;
        "TotQtyHdr:H='In-Transit', Recv_Stk:H='Received',"+;
        "Recv_Dam:H='Damaged', Recv_Can:H='Canceled',"+;
        "cVessel:h='Airline / Vessel' ,Reference"
      *Style Cutting Tickets
    CASE lcType = 'M'
      lcBusDoc = 'P'
      lcWorkOrder='U'
      lcBrowseCursor = loFormSet.CUTTKTH.lcCursorView
      lcbrowsetitle  = 'PO'
      lcBrowseTableName = "POSHDR"
      lcBrowseIndexExpression = "CBUSDOCU+CSTYTYPE+PO"
      lcBrowseIndexFields     = "CBUSDOCU,CSTYTYPE,PO"
      lcBrowseIndexName       = "POSHDR"
      lcBrowseKey             = lcBusDoc + lcWorkOrder
      lcBrowseAliasName       = loFormSet.CUTTKTH.lcCursorView
      lcBrowseFields = "PO  :H='Cutkt'   ,"+;
        "Style   :H='Style'   ,"+;
        "Status  :H='S'       ,"+;
        "Entered :H='Issue'   ,"+;
        "Complete:H='Complete',"+;
        "Season  :H='Se'      ,"+;
        "cDivision:H='Di'     ,"+;
        "NSTYORDER :H='Budget':P='999999',"+;
        "RECEIVE :H='Recvd' :P='999999',"+;
        "DAMAGE :H='Damged':P='999999',"+;
        "OPEN :H='Open'  :P='999999' "

      *Material Purchase Orders
    CASE INLIST(lcType,'L','F')
      lcBusDoc = IIF(lcType='F','R','P')
      lcWorkOrder='M'
      lcBrowseCursor = loFormSet.POFHDR.lcCursorView
      lcbrowsetitle  = 'PO'
      lcBrowseTableName = "POSHDR"
      lcBrowseIndexExpression = "CBUSDOCU+CSTYTYPE+PO"
      lcBrowseIndexFields     = "CBUSDOCU,CSTYTYPE,PO"
      lcBrowseIndexName       = "POSHDR"
      lcBrowseKey             = lcBusDoc + lcWorkOrder
      lcBrowseAliasName       = loFormSet.POFHDR.lcCursorView
      lcBrowseFields = "PO        :R:10:H='PO #' ,"+;
        "Status    :R: 3:H='S' ,"+;
        "Vendor    :R:10:H='Vendor' ,"+;
        "Complete  :R:12:H='Complete' ,"+;
        "NSTYORDER :R:10:H='Total Qty.' ,"+;
        "POTotal   :R:15:H='Amount' ,"+;
        "Receive   :R:10:H='Receive' ,"+;
        "Open      :R:10:H='Open' "

      *Material MFG Orders
    CASE lcType = 'T'
      lcBusDoc = 'P'
      lcWorkOrder='F'
      lcBrowseCursor = loFormSet.MMFGORDH.lcCursorView
      lcbrowsetitle  = 'PO'
      lcBrowseTableName = "POSHDR"
      lcBrowseIndexExpression = "CBUSDOCU+CSTYTYPE+PO"
      lcBrowseIndexFields     = "CBUSDOCU,CSTYTYPE,PO"
      lcBrowseIndexName       = "POSHDR"
      lcBrowseKey             = lcBusDoc + lcWorkOrder
      lcBrowseAliasName       = loFormSet.MMFGORDH.lcCursorView
      lcBrowseFields = "PO:H='Order#',"+;
        "Style  :H='"+gfitemmask('HM','','0002')+"',"+;
        IIF(gfGetMemVar('M_WareHouse') = 'Y',;
        "cWareCode:H='Warehouse',","")+;
        "Status   :H='S',"+;
        "Entered  :H='Entered',"+;
        "Complete :H='Complete'"
  ENDCASE

  IF EMPTY(lcTicket) OR ALLTRIM(lcTicket)=='?' OR !loFormSet.&lcBrowseCursor..SEEK(lcBusDoc+lcWorkOrder+lcTicket)
    PRIVATE llSelected
    SELECT (lcBrowseCursor)
    llSelected = .F.
    lcStr="DO FORM BROWSE WITH lcbrowsefields, lcbrowsetitle, lcBusDoc+lcWorkOrder, .F.,"+;
      ".F., .T., .F., .F., .F., .F., .F., .F., .F., .F., .F., .F., .F., lcBrowseTableName,"+;
      "'SQL', lcBrowseTableName, .F., lcBusDoc+lcWorkOrder+ALLTRIM(lcTicket)"+;
      "TO llSelected"
    gfExecute(lcStr)
    IF llSelected
      lcTicket = IIF(lcType='S',EVALUATE(lcBrowseCursor+'.SHIPNO'),EVALUATE(lcBrowseCursor+'.PO'))
    ELSE
      lcTicket = ""
    ENDIF
  ENDIF

  IF lcType='S'
    lcLinkCode = IIF(EMPTY(lcTicket),SPACE(6),SUBSTR(lfGetGlLnk(lcTicket,loForm.cntStyle.VALUE,''),1,6))
  ELSE
    lcLinkCode = IIF(EMPTY(lcTicket),SPACE(6),&lcBrowseCursor..Link_Code)
  ENDIF

  lcTicket=IIF(lfChkCstCur(loFormSet,loForm,lcType,lcTicket,lcCstType),lcTicket,loFormSet.lcCutTktNo)

  *Fix problem in AP Invoice lines that tax code applies to all lines[Begin]
  SELECT APVENDOR
  IF BETWEEN(lnVendRecNo,1,RECCOUNT())
    GOTO (lnVendRecNo)
  ENDIF
  *Fix problem in AP Invoice lines that tax code applies to all lines[End]

  SELECT (lnAlias)
  RETURN
  *-- End of lfvTicket


  *!*************************************************************
  *! Name      : lfChkCstCur
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 09/02/2004
  *! Purpose   : Check Ticket Currency againest Invoice Currency
  *!*************************************************************
  *! Parameters: The FormSet of APPYINV.SCX, The Form of APINVDT.SCX,
  *!                      lcTktType  : Ticket Type
  *!                                   'S' : Shipment
  *!                                   'I' : Style PO
  *!                                   'R' : Style PO Return
  *!                                   'M' : Style Cutting Ticket
  *!                                   'L' : Material PO
  *!                                   'F' : Material PO Return
  *!                                   'T' : Material MFG Order
  *!                                   'A' : Adorment Order
  *!                                   'D' : Dying Order
  *!                       lcTicket   : Ticket #
  *!                       lcCstType  : Cost Type
  *!*************************************************************
  *! Returns   :  None
  *!*************************************************************
FUNCTION lfChkCstCur
  LPARAMETERS loFormSet, loForm, lcTktType, lcTicket, lcCstType
  LOCAL lcSqlStatement, lnResult, lcAlias
  lcAlias = ALIAS()

  DO CASE
    CASE INLIST(lcTktType,'S') AND !EMPTY(lcTicket)
      IF lcCstType $ 'PD'
        *CBUSDOCU+CSTYTYPE+PO &&POSHDR
        *CBUSDOCU+CSTYTYPE+PO+CRSESSION+SHIPNO+CINVTYPE+STYLE+STR(LINENO,6)+TRANCD+CSTYGRADE &&POSREC
        lcSqlStatement = "SELECT POSHDR.* FROM POSHDR (INDEX=POSHDR), POSLN (INDEX=POSREC) WHERE "+;
          "POSHDR.CBUSDOCU='P' AND POSHDR.CSTYTYPE='P' AND "+;
          "POSLN.CBUSDOCU='P' AND POSLN.CSTYTYPE='P' AND POSHDR.PO=POSLN.PO AND "+;
          "POSLN.shipno='"+lcTicket+"'"
        lnResult=oAriaApplication.remotecompanydata.sqlrun(lcSqlStatement,'PoCursor','',;
          oAriaApplication.ActiveCompanyConStr,3,'SAVE',loForm.DATASESSIONID)
        IF lnResult<1
          oAriaApplication.remotecompanydata.CheckRetResult("execute",lnResult,.T.)
          IF !EMPTY(lcAlias)
            SELECT (lcAlias)
          ENDIF
          *AIT WINDOW LINENO()
          RETURN .F.
        ENDIF

        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        *!*	      SELECT * FROM PoCursor ;
        *!*	         WHERE IIF(lcCstType = 'P',cpricecur,cdutycur) <> loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value ;
        *!*	         INTO ARRAY laDummyArr &&Sql76: Must use SqlRun
        SELECT * FROM PoCursor ;
          WHERE IIF(lcCstType = 'P',cpricecur,cdutycur) <> loFormSet.AriaForm1.pgfpayInv.pgHead.kbCurrCode.KeyTextBox.VALUE ;
          INTO ARRAY laDummyArr &&Sql76: Must use SqlRun
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

        USE IN PoCursor
        IF !EMPTY(lcAlias)
          SELECT (lcAlias)
        ENDIF
        IF _TALLY > 0
          =gfModalGen(.F.,'DIALOG',.F.,.F.,;
            'Placing an invoice for a shipment that includes Purchase Orders with several currencies'+;
            'is not allowed. Please use the option to invoice by Purchase Orders.')
          RETURN(.F.)
        ENDIF
      ENDIF

    CASE INLIST(lcTktType,'I','R') AND !EMPTY(lcTicket) AND loFormSet.POSHDR.SEEK(IIF(lcTktType='I','PP','RP')+lcTicket) &&Sql77: Check Key
      IF POSHDR.STATUS = 'B'
        *Message : 04177
        *Purchase Order# 9999 has a 'BID' Status. Invoicing is not allowed
        *Button : 00000
        *Ok
        =gfModalGen("TRM04177B00000","DIALOG",'Purchase Order')
        RETURN(.F.)
      ENDIF
      IF lcTktType = 'I' AND POSHDR.STATUS = 'H'
        *Message : 04169
        *Cost Sheet has not been generated for Purchase Order.
        *Button : 00000
        *Ok
        =gfModalGen("TRM04169B00000","DIALOG",'Purchase Order')
        RETURN(.F.)
      ENDIF
      *Message : 04176
      *Purchase Order has been canceled.
      *Button : 00000
      *Ok
      IF (POSHDR.STATUS='X' AND gfModalGen("TRM04176B00000","DIALOG",'Purchase Order|canceled')=1) OR ;
          (POSHDR.STATUS='S' AND gfModalGen("TRM04176B00000","DIALOG",'Purchase Order|closed')=1)
        RETURN(.F.)
      ENDIF

      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *    IF lcCstType ='P' AND PADR(loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value,3) <> POSHDR.cPriceCur
      IF lcCstType ='P' AND PADR(loFormSet.AriaForm1.pgfpayInv.pgHead.kbCurrCode.KeyTextBox.VALUE,3) <> POSHDR.cPriceCur
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
        *Message : 04168
        *Only Purchase Orders with Price in xxxx are allowed.
        *Button : 00000
        *Ok
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        *=gfModalGen("TRM04168B00000","DIALOG",'Purchase Orders|Price|'+loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value)
        =gfModalGen("TRM04168B00000","DIALOG",'Purchase Orders|Price|'+loFormSet.AriaForm1.pgfpayInv.pgHead.kbCurrCode.KeyTextBox.VALUE)
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
        RETURN(.F.)
      ENDIF
      *B608489,1 WAM 03/23/2008 Don't compare duty currency from POSHDR. Currency is saved in the BOMLINE table
      *!*	    IF lcCstType ='D' AND PADR(loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value,3) <> POSHDR.cDutyCur
      *!*	      *Message : 04168
      *!*	      *Only Purchase Orders with Duty in xxxx are allowed.
      *!*	      *Button : 00000
      *!*	      *Ok
      *!*	      =gfModalGen("TRM04168B00000","DIALOG",'Purchase Orders|Duty|'+loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value)
      *!*	      RETURN(.F.)
      *!*	    ENDIF
      *!*
      *!*	    *(Begin) Adding the checking of the invoice
      *!*	    *currency with the duty currency when selecting
      *!*	    *Misc. as the Misc. currency will be treated
      *!*	    *as the duty currency.
      *!*	    IF lcCstType ='M' AND PADR(loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value,3) <> POSHDR.cDutyCur
      *!*	      *-- Only Purchase Orders with Misc. in xxxx are allowed.
      *!*	      =gfModalGen("TRM04168B00000","DIALOG",'Purchase Orders|Misc.|'+loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value)
      *!*	      RETURN(.F.)
      *!*	    ENDIF
      *!*	    *Adding the checking of the invoice (End)
      *B608489,1 WAM 03/23/2008 (End)

    CASE lcTktType ='M' AND !EMPTY(lcTicket) AND loFormSet.CUTTKTH.SEEK('PU'+lcTicket) &&Sql78: Check Key
      *Message : 04176
      *Cutting Ticket has been canceled.
      *Button : 00000
      *Ok
      IF (CUTTKTH.STATUS='X' AND gfModalGen("TRM04176B00000","DIALOG",'Cutting Ticket|canceled')=1) OR ;
          (CUTTKTH.STATUS='S' AND gfModalGen("TRM04176B00000","DIALOG",'Cutting Ticket|closed')=1)
        RETURN(.F.)
      ENDIF
      IF CUTTKTH.STATUS = 'H'
        *Message : 04169
        *Cost Sheet has not been generated for Cutting Ticket.
        *Button : 00000
        *Ok
        =gfModalGen("TRM04169B00000","DIALOG",'Cutting Ticket')
        RETURN(.F.)
      ENDIF
    CASE lcTktType ='T' AND !EMPTY(lcTicket) AND loFormSet.MMFGORDH.SEEK('PF'+lcTicket) &&Sql79: Check Key
      *Message : 04176
      *Material MFG Order has been canceled.
      *Button : 00000
      *Ok
      IF (MMFGORDH.STATUS='X' AND gfModalGen("TRM04176B00000","DIALOG",'Material MFG Order|canceled')=1) OR ;
          (MMFGORDH.STATUS='S' AND gfModalGen("TRM04176B00000","DIALOG",'Material MFG Order|closed')=1)
        RETURN(.F.)
      ENDIF
      IF MMFGORDH.STATUS = 'H'
        *Message : 04169
        *Cost Sheet has not been generated for Material MFG Order.
        *Button : 00000
        *Ok
        =gfModalGen("TRM04169B00000","DIALOG",'Material MFG Order')
        RETURN(.F.)
      ENDIF
    CASE INLIST(lcTktType,'L','F') AND !EMPTY(lcTicket) AND loFormSet.POFHDR.SEEK(IIF(lcTktType='L','PM','RM')+lcTicket) &&Sql80: Check Key
      IF POFHDR.STATUS = 'B'
        *Message : 04177
        *Purchase Order# 9999 has a 'BID' Status. Invoicing is not allowed
        *Button : 00000
        *Ok
        =gfModalGen("TRM04177B00000","DIALOG",'Purchase Order')
        RETURN(.F.)
      ENDIF
      *Message : 04176
      *Material Purchase Order has been canceled.
      *Button : 00000
      *Ok
      IF (POFHDR.STATUS='X' AND gfModalGen("TRM04176B00000","DIALOG",'Material Purchase Order|canceled')=1) OR ;
          (POFHDR.STATUS='S' AND gfModalGen("TRM04176B00000","DIALOG",'Material Purchase Order|closed')=1)
        RETURN(.F.)
      ENDIF

      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *    IF lcCstType ='P' AND PADR(loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value,3) <> POFHDR.cPriceCur
      IF lcCstType ='P' AND PADR(loFormSet.AriaForm1.pgfpayInv.pgHead.kbCurrCode.KeyTextBox.VALUE,3) <> POFHDR.cPriceCur
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
        *Message : 04168
        *Only Purchase Orders with Price in xxxx are allowed.
        *Button : 00000
        *Ok
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        *=gfModalGen("TRM04168B00000","DIALOG",'Purchase Orders|Price|'+loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value)
        =gfModalGen("TRM04168B00000","DIALOG",'Purchase Orders|Price|'+loFormSet.AriaForm1.pgfpayInv.pgHead.kbCurrCode.KeyTextBox.VALUE)
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
        RETURN(.F.)
      ENDIF

      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *IF lcCstType ='D' AND PADR(loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value,3) <> POFHDR.cDutyCur
      IF lcCstType ='D' AND PADR(loFormSet.AriaForm1.pgfpayInv.pgHead.kbCurrCode.KeyTextBox.VALUE,3) <> POFHDR.cDutyCur
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
        *Message : 04168
        *Only Purchase Orders with Duty in xxxx are allowed.
        *Button : 00000
        *Ok
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        *=gfModalGen("TRM04168B00000","DIALOG",'Purchase Orders|Duty|'+loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value)
        =gfModalGen("TRM04168B00000","DIALOG",'Purchase Orders|Duty|'+loFormSet.AriaForm1.pgfpayInv.pgHead.kbCurrCode.KeyTextBox.VALUE)
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
        RETURN(.F.)
      ENDIF
      *(Begin) Adding the checking of the invoice
      *currency with the duty currency when selecting
      *Misc. as the Misc. currency will be treated
      *as the duty currency.
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *IF lcCstType ='M' AND PADR(loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value,3) <> POFHDR.cDutyCur
      IF lcCstType ='M' AND PADR(loFormSet.AriaForm1.pgfpayInv.pgHead.kbCurrCode.KeyTextBox.VALUE,3) <> POFHDR.cDutyCur
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
        *-- Only Purchase Orders with Misc. in xxxx are allowed.
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        *=gfModalGen("TRM04168B00000","DIALOG",'Purchase Orders|Misc.|'+loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value)
        =gfModalGen("TRM04168B00000","DIALOG",'Purchase Orders|Misc.|'+loFormSet.AriaForm1.pgfpayInv.pgHead.kbCurrCode.KeyTextBox.VALUE)
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
        RETURN(.F.)
      ENDIF
      * Adding the checking of the invoice (End)

    CASE INLIST(lcTktType,'D','A') AND !EMPTY(lcTicket) AND loFormSet.POSHDR.SEEK('P'+lcTktType+lcTicket) &&Sql81: Check Key
      lcDesc = IIF(lcTktType = 'D','Dying','Adorment')
      IF POSHDR.STATUS = 'B'
        *Message : 04177
        *Dying Order# 9999 has a 'BID' Status. Invoicing is not allowed
        *Button : 00000
        *Ok
        =gfModalGen("TRM04177B00000","DIALOG",'Dying Order')
        RETURN(.F.)
      ENDIF
      IF POSHDR.STATUS = 'H'
        *Message : 04169
        *Cost Sheet has not been generated for Dying Order.
        *Button : 00000
        *Ok
        =gfModalGen("TRM04169B00000","DIALOG",lcDesc +' Order')
        RETURN(.F.)
      ENDIF
      *Message : 04176
      *Dying Order has been canceled.
      *Button : 00000
      *Ok
      IF (POSHDR.STATUS='X' AND gfModalGen("TRM04176B00000","DIALOG",lcDesc +' Order|canceled')=1) OR ;
          (POSHDR.STATUS='S' AND gfModalGen("TRM04176B00000","DIALOG",lcDesc +' Order|closed')=1)
        RETURN(.F.)
      ENDIF
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *IF lcCstType ='P' AND PADR(loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value,3) <> POSHDR.cPriceCur
      IF lcCstType ='P' AND PADR(loFormSet.AriaForm1.pgfpayInv.pgHead.kbCurrCode.KeyTextBox.VALUE,3) <> POSHDR.cPriceCur
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
        *Message : 04168
        *Only Purchase Orders with Price in xxxx are allowed.
        *Button : 00000
        *Ok
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        *=gfModalGen("TRM04168B00000","DIALOG",lcDesc +' Orders|Price|'+loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value)
        =gfModalGen("TRM04168B00000","DIALOG",lcDesc +' Orders|Price|'+loFormSet.AriaForm1.pgfpayInv.pgHead.kbCurrCode.KeyTextBox.VALUE)
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
        RETURN(.F.)
      ENDIF
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *IF lcCstType ='D' AND PADR(loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value,3) <> POSHDR.cDutyCur
      IF lcCstType ='D' AND PADR(loFormSet.AriaForm1.pgfpayInv.pgHead.kbCurrCode.KeyTextBox.VALUE,3) <> POSHDR.cDutyCur
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
        *Message : 04168
        *Only Purchase Orders with Duty in xxxx are allowed.
        *Button : 00000
        *Ok
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        *=gfModalGen("TRM04168B00000","DIALOG",lcDesc +' Orders|Duty|'+loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value)
        =gfModalGen("TRM04168B00000","DIALOG",lcDesc +' Orders|Duty|'+loFormSet.AriaForm1.pgfpayInv.pgHead.kbCurrCode.KeyTextBox.VALUE)
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
        RETURN(.F.)
      ENDIF
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *IF lcCstType ='M' AND PADR(loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value,3) <> POSHDR.cDutyCur
      IF lcCstType ='M' AND PADR(loFormSet.AriaForm1.pgfpayInv.pgHead.kbCurrCode.KeyTextBox.VALUE,3) <> POSHDR.cDutyCur
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
        *-- Only Dying Orders with Misc. in xxxx are allowed.
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        *=gfModalGen("TRM04168B00000","DIALOG",lcDesc +' Orders|Misc.|'+loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value)
        =gfModalGen("TRM04168B00000","DIALOG",lcDesc +' Orders|Misc.|'+loFormSet.AriaForm1.pgfpayInv.pgHead.kbCurrCode.KeyTextBox.VALUE)
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
        RETURN(.F.)
      ENDIF
  ENDCASE

  RETURN
  *-- End of lfChkCstCur


  *!*************************************************************
  *! Name      : lfvInvPrice
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 09/02/2004
  *! Purpose   : Invoice Price
  *!*************************************************************
  *! Parameters:  The FormSet of APPYINV.SCX, The Form of APINVDT.SCX
  *!*************************************************************
  *! Returns   :  None
  *!*************************************************************
FUNCTION lfvInvPrice
  LPARAMETERS loFormSet, loForm
  *Fix bug when Saving the debit memo againest Return PO [BEGIN]
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	IF (loForm.loRec.cIMTyp $ 'RF' OR loFormSet.llDebitM) AND (loForm.loRec.nAPPrice > 0)
  *!*	  loForm.loRec.nAPPrice = loForm.loRec.nAPPrice * -1
  IF (loFormSet.loRec.cIMTyp $ 'RF' OR loFormSet.llDebitM) AND (loFormSet.loRec.nAPPrice > 0)
    loFormSet.loRec.nAPPrice = loFormSet.loRec.nAPPrice * -1
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  ENDIF
  *Fix bug when Saving the debit memo againest Return PO [END]
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *IF loForm.loRec.nAPPrice <> nAPPrice
  SELECT(IIF(loFormSet.ActiveMode="V",'APVINVDT2',loFormSet.lcAPvInvDt))
  IF loFormSet.loRec.nAPPrice <> nAPPrice
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    *Add these lines to make sure that the "Invoice Unit Cost" and
    *the "Approved Unit Cost" have the same sign [Begin]

    *-- If the "Invoice Unit Cost" and the "Approved Unit Cost" have
    *-- different signs
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *!*	  IF SIGN(loForm.loRec.nAPPrice) <> 0 .AND. SIGN(loForm.loRec.nAPAprPric) <> 0 .AND.;
    *!*	     SIGN(loForm.loRec.nAPPrice) <> SIGN(loForm.loRec.nAPAprPric)
    IF SIGN(loFormSet.loRec.nAPPrice) <> 0 .AND. SIGN(loFormSet.loRec.nAPAprPric) <> 0 .AND.;
        SIGN(loFormSet.loRec.nAPPrice) <> SIGN(loFormSet.loRec.nAPAprPric)
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      *-- Message : 04187
      *-- "Invoice unit cost and approved unit cost must have the same sign."
      *-- Button : 00000
      *-- "                          <    Ok    >                           "
      =gfModalGen('TRM04187B00000' , 'ALERT')
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *loForm.loRec.nAPPrice = nAPPrice        && Restore the old value
      loFormSet.loRec.nAPPrice = nAPPrice        && Restore the old value
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      RETURN
    ENDIF
    *Add these lines to make sure that the "Invoice Unit Cost" [End]
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *!*	  loForm.loRec.nAPAprPric = IIF(loForm.llDefAuApr,loForm.loRec.nAPPrice,loForm.loRec.nAPAprPric)
    *!*	  loForm.loRec.nAPAprPric = IIF(lfChkAplTkt(loFormSet,loForm,''),loForm.loRec.nAPAprPric,nAPAprPric)
    *!*	  loForm.loRec.nApAmnt    = loForm.loRec.nAPTotQty*loForm.loRec.nAPPrice
    *!*	  loForm.loRec.nAPAprAmnt = loForm.loRec.nApTAprQty*loForm.loRec.nAPAprPric
    loFormSet.loRec.nAPAprPric = IIF(loForm.llDefAuApr,loFormSet.loRec.nAPPrice,loFormSet.loRec.nAPAprPric)
    loFormSet.loRec.nAPAprPric = IIF(lfChkAplTkt(loFormSet,loForm,''),loFormSet.loRec.nAPAprPric,nAPAprPric)
    loFormSet.loRec.nApAmnt    = loFormSet.loRec.nAPTotQty*loFormSet.loRec.nAPPrice
    loFormSet.loRec.nAPAprAmnt = loFormSet.loRec.nApTAprQty*loFormSet.loRec.nAPAprPric
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    
    *Fix bug when Saving the debit memo againest Return PO [BEGIN]
    
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *!*	  loFormSet.lnTInvAmt = loFormSet.lnTInvAmt + (ROUND(loForm.loRec.nApAmnt,2) - ROUND(nAPAMnt,2))
    *!*	  loFormSet.lnTAprAmt = loFormSet.lnTAprAmt + (ROUND(loForm.loRec.nAPAprAmnt,2)- ROUND(nApAprAmnt,2))
    loFormSet.lnTInvAmt = loFormSet.lnTInvAmt + (ROUND(loFormSet.loRec.nApAmnt,2) - ROUND(nAPAMnt,2))
    loFormSet.lnTAprAmt = loFormSet.lnTAprAmt + (ROUND(loFormSet.loRec.nAPAprAmnt,2)- ROUND(nApAprAmnt,2))
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    
    *Fix bug when Saving the debit memo againest Return PO [END]

    *=lfRefresh('APINVD10')
    *Fix bug when Saving the debit memo againest Return PO [BEGIN]
    PRIVATE lnDiffAmnt
    
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *!*	  lnDiffAmnt =  (ROUND(loForm.loRec.nApAmnt,2) - ROUND(nAPAMnt,2)) * IIF((loForm.loRec.cIMTyp $ 'RF'),1,IIF(loFormSet.llDebitM,-1,1))
    *!*	  =lfUpdApDist(loFormSet,loForm,cApVILNo,lnDiffAmnt,cApDGlAct,loForm.loRec.cIMTyp)
    lnDiffAmnt =  (ROUND(loFormSet.loRec.nApAmnt,2) - ROUND(nAPAMnt,2)) * IIF((loFormSet.loRec.cIMTyp $ 'RF'),1,IIF(loFormSet.llDebitM,-1,1))
    =lfUpdApDist(loFormSet,loForm,cApVILNo,lnDiffAmnt,cApDGlAct,loFormSet.loRec.cIMTyp)
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    
    *Fix bug when Saving the debit memo againest Return PO [END]

    =IIF(loForm.llDefAuApr,lfUpdAplTkt(loFormSet, loForm),.T.)
    
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *!*	  REPLACE nAPPrice   WITH loForm.loRec.nAPPrice   ,;
    *!*	          nAPAprPric WITH loForm.loRec.nAPAprPric ,;
    *!*	          nApAmnt    WITH loForm.loRec.nApAmnt    ,;
    *!*	          nAPAprAmnt WITH loForm.loRec.nAPAprAmnt ,;
    *!*	          cStatus  WITH IIF(cStatus='S','M',cStatus)
    REPLACE nAPPrice   WITH loFormSet.loRec.nAPPrice   ,;
      nAPAprPric WITH loFormSet.loRec.nAPAprPric ,;
      nApAmnt    WITH loFormSet.loRec.nApAmnt    ,;
      nAPAprAmnt WITH loFormSet.loRec.nAPAprAmnt ,;
      cStatus  WITH IIF(cStatus='S','M',cStatus)
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    *Old: SHOW GET loForm.loRec.nApAmnt ENABLE &&Revise
    loForm.txtApAmnt.ENABLED = .T.
    IF loForm.llDefEdApr  &&lower
      *Old: SHOW GET loForm.loRec.nAPAprPric ENABLE &&Revise
      *Old: SHOW GET loForm.loRec.nAPAprAmnt ENABLE &&Revise
      STORE .T. TO loForm.txtAPAprPric.ENABLED, loForm.txtAPAprAmnt.ENABLED
    ELSE
      *Old: SHOW GET loForm.loRec.nAPAprPric DISABLE &&Revise
      *Old: SHOW GET loForm.loRec.nAPAprAmnt DISABLE &&Revise
      STORE .F. TO loForm.txtAPAprPric.ENABLED, loForm.txtAPAprAmnt.ENABLED
    ENDIF
  ENDIF
  loForm.REFRESH()

  RETURN
  *-- End of lfvInvPrice


  *!*************************************************************
  *! Name      : lfvAprPrice
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 09/02/2004
  *! Purpose   : Invoice Approved Price
  *!*************************************************************
  *! Parameters:  The FormSet of APPYINV.SCX, The Form of APINVDT.SCX
  *!*************************************************************
  *! Returns   :  None
  *!*************************************************************
FUNCTION lfvAprPrice
  LPARAMETERS loFormSet, loForm

  *Fix bug when Saving the debit memo againest Return PO [BEGIN]
  *! E302623,3 MMT 01/03/2010 Convert Payable invoice screen to use SQL tables[Start]
  SELECT(IIF(loFormSet.ActiveMode="V",'APVINVDT2',loFormSet.lcAPvInvDt))
  *! E302623,3 MMT 01/03/2010 Convert Payable invoice screen to use SQL tables[End]
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	IF (loForm.loRec.cIMTyp $ 'RF' OR loFormSet.llDebitM) AND (loForm.loRec.nAPAprPric > 0)
  *!*	  loForm.loRec.nAPAprPric = loForm.loRec.nAPAprPric * -1
  IF (loFormSet.loRec.cIMTyp $ 'RF' OR loFormSet.llDebitM) AND (loFormSet.loRec.nAPAprPric > 0)
    loFormSet.loRec.nAPAprPric = loFormSet.loRec.nAPAprPric * -1
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  ENDIF
  *Fix bug when Saving the debit memo againest Return PO [END]

  *Fix bug when Saving the debit memo againest Return PO [BEGIN]
  
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *IF ABS((loForm.loRec.nAPAprPric * loForm.loRec.nApTAprQty)) > ABS(loForm.loRec.nApAmnt)
  IF ABS((loFormSet.loRec.nAPAprPric * loFormSet.loRec.nApTAprQty)) > ABS(loFormSet.loRec.nApAmnt)
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

    =gfModalGen(.F.,'DIALOG',.F.,.F.,'The approved amount should be less than or equal to the invoice amount')
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *loForm.loRec.nAPAprPric = nAPAprPric
    loFormSet.loRec.nAPAprPric = nAPAprPric
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[END]
    RETURN
  ENDIF
  *Fix bug when Saving the debit memo againest Return PO [END]

  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *loForm.loRec.nAPAprPric = IIF(lfChkAplTkt(loFormSet,loForm,''),loForm.loRec.nAPAprPric,nAPAprPric)
  *IF loForm.loRec.nAPAprPric <> nAPAprPric
  loFormSet.loRec.nAPAprPric = IIF(lfChkAplTkt(loFormSet,loForm,''),loFormSet.loRec.nAPAprPric,nAPAprPric)
  IF loFormSet.loRec.nAPAprPric <> nAPAprPric
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    *Add these lines to make sure that the "Invoice Unit Cost" and
    *          the "Approved Unit Cost" have the same sign [Begin]

    *-- If the "Invoice Unit Cost" and the "Approved Unit Cost" have
    *-- different signs
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *!*	  IF SIGN(loForm.loRec.nAPPrice) <> 0 .AND. SIGN(loForm.loRec.nAPAprPric) <> 0 .AND.;
    *!*	     SIGN(loForm.loRec.nAPPrice) <> SIGN(loForm.loRec.nAPAprPric)
    IF SIGN(loFormSet.loRec.nAPPrice) <> 0 .AND. SIGN(loFormSet.loRec.nAPAprPric) <> 0 .AND.;
        SIGN(loFormSet.loRec.nAPPrice) <> SIGN(loFormSet.loRec.nAPAprPric)
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[END]
      *-- Message : 04187
      *-- "Invoice unit cost and approved unit cost must have the same sign."
      *-- Button : 00000
      *-- "                          <    Ok    >                           "
      =gfModalGen('TRM04187B00000' , 'ALERT')
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      * loForm.loRec.nAPAprPric = nAPAprPric        && Restore the old value
      loFormSet.loRec.nAPAprPric = nAPAprPric        && Restore the old value
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      RETURN
    ENDIF
    *Add these lines to make sure that the "Invoice Unit Cost" [End]
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *!*	  loForm.loRec.nAPAprAmnt = loForm.loRec.nApTAprQty*loForm.loRec.nAPAprPric
    *!*	  loFormSet.lnTAprAmt    = loFormSet.lnTAprAmt  + (ROUND(loForm.loRec.nAPAprAmnt,2) - ROUND(nApAprAmnt,2))
    loFormSET.loRec.nAPAprAmnt = loFormSet.loRec.nApTAprQty*loFormSet.loRec.nAPAprPric
    loFormSet.lnTAprAmt    = loFormSet.lnTAprAmt  + (ROUND(loFormSet.loRec.nAPAprAmnt,2) - ROUND(nApAprAmnt,2))
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    
    *=lfRefresh('APINVD10')
    =lfUpdAplTkt(loFormSet, loForm)

    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *!*	  REPLACE nAPAprPric WITH loForm.loRec.nAPAprPric ,;
    *!*	          nAPAprAmnt WITH loForm.loRec.nAPAprAmnt ,;
    *!*	          cStatus  WITH IIF(cStatus='S','M',cStatus)
    REPLACE nAPAprPric WITH loFormSet.loRec.nAPAprPric ,;
      nAPAprAmnt WITH loFormSet.loRec.nAPAprAmnt ,;
      cStatus  WITH IIF(cStatus='S','M',cStatus)
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    *Old: SHOW GET loForm.loRec.nAPAprAmnt ENABLE &&Revise
    loForm.txtAPAprAmnt.ENABLED = .T.
    *SHOW WINDOW (lcInvDtBr) REFRESH SAME
  ENDIF
  loForm.REFRESH()

  RETURN
  *-- End of lfvAprPrice


  *!*************************************************************
  *! Name      : lfvInvTQty
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 09/02/2004
  *! Purpose   : Invoice line total Quantity
  *!*************************************************************
  *! Parameters:  The FormSet of APPYINV.SCX, The Form of APINVDT.SCX
  *!*************************************************************
  *! Returns   :  None
  *!*************************************************************
FUNCTION lfvInvTQty
  LPARAMETERS loFormSet, loForm

  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	IF loForm.loRec.nAPTotQty <> nAPTotQty
  *!*	  loForm.loRec.nApTAprQty = IIF(loForm.llDefAuApr,loForm.loRec.nAPTotQty,loForm.loRec.nApTAprQty)
  *!*	  loForm.loRec.nApTAprQty = IIF(lfChkAplTkt(loFormSet,loForm,''),loForm.loRec.nApTAprQty,nApTAprQty)
  *!*	  loForm.loRec.nApAmnt    = loForm.loRec.nAPTotQty*loForm.loRec.nAPPrice
  *!*	  loForm.loRec.nAPAprAmnt = loForm.loRec.nApTAprQty*loForm.loRec.nAPAprPric
  *!*	  loFormSet.lnTInvAmt = loFormSet.lnTInvAmt + (ROUND(loForm.loRec.nApAmnt,2) - ROUND(nAPAMnt,2))*IIF(loForm.loRec.cIMTyp $ 'RF',-1,1)
  *!*	  loFormSet.lnTAprAmt = loFormSet.lnTAprAmt + (ROUND(loForm.loRec.nAPAprAmnt,2)- ROUND(nApAprAmnt,2))*IIF(loForm.loRec.cIMTyp $ 'RF',-1,1)
  
  *! E302623,3 MMT 01/03/2010 Convert Payable invoice screen to use SQL tables[Start]
  SELECT(IIF(loFormSet.ActiveMode="V",'APVINVDT2',loFormSet.lcAPvInvDt))
  *! E302623,3 MMT 01/03/2010 Convert Payable invoice screen to use SQL tables[End]
  IF loFormSet.loRec.nAPTotQty <> nAPTotQty
    loFormSet.loRec.nApTAprQty = IIF(loForm.llDefAuApr,loFormSet.loRec.nAPTotQty,loFormSet.loRec.nApTAprQty)
    loFormSet.loRec.nApTAprQty = IIF(lfChkAplTkt(loFormSet,loForm,''),loFormSet.loRec.nApTAprQty,nApTAprQty)
    loFormSet.loRec.nApAmnt    = loFormSet.loRec.nAPTotQty*loFormSet.loRec.nAPPrice
    loFormSet.loRec.nAPAprAmnt = loFormSet.loRec.nApTAprQty*loFormSet.loRec.nAPAprPric
    loFormSet.lnTInvAmt = loFormSet.lnTInvAmt + (ROUND(loFormSet.loRec.nApAmnt,2) - ROUND(nAPAMnt,2))*IIF(loFormSet.loRec.cIMTyp $ 'RF',-1,1)
    loFormSet.lnTAprAmt = loFormSet.lnTAprAmt + (ROUND(loFormSet.loRec.nAPAprAmnt,2)- ROUND(nApAprAmnt,2))*IIF(loFormSet.loRec.cIMTyp $ 'RF',-1,1)
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

    *=lfRefresh('APINVD10')
    PRIVATE lnDiffAmnt
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *!*	  lnDiffAmnt =  (ROUND(loForm.loRec.nApAmnt,2) - ROUND(nAPAMnt,2)) * IIF((loForm.loRec.cIMTyp $ 'RF'),1,IIF(loFormSet.llDebitM,-1,1))
    *!*	  =lfUpdApDist(loFormSet,loForm,cApVILNo,lnDiffAmnt,cApDGlAct,loForm.loRec.cIMTyp)
    lnDiffAmnt =  (ROUND(loFormSet.loRec.nApAmnt,2) - ROUND(nAPAMnt,2)) * IIF((loFormSet.loRec.cIMTyp $ 'RF'),1,IIF(loFormSet.llDebitM,-1,1))
    =lfUpdApDist(loFormSet,loForm,cApVILNo,lnDiffAmnt,cApDGlAct,loFormSet.loRec.cIMTyp)
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    
    =IIF(loForm.llDefAuApr,lfUpdAplTkt(loFormSet, loForm),.T.)
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *!*	  REPLACE nAPTotQty  WITH loForm.loRec.nAPTotQty  ,;
    *!*	          nApTAprQty WITH loForm.loRec.nApTAprQty ,;
    *!*	          nApAmnt    WITH loForm.loRec.nApAmnt    ,;
    *!*	          nAPAprAmnt WITH loForm.loRec.nAPAprAmnt ,;
    *!*	          cStatus  WITH IIF(cStatus='S','M',cStatus)
    REPLACE nAPTotQty  WITH loFormSet.loRec.nAPTotQty  ,;
      nApTAprQty WITH loFormSet.loRec.nApTAprQty ,;
      nApAmnt    WITH loFormSet.loRec.nApAmnt    ,;
      nAPAprAmnt WITH loFormSet.loRec.nAPAprAmnt ,;
      cStatus  WITH IIF(cStatus='S','M',cStatus)
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    *Old: SHOW GET loForm.loRec.nApAmnt ENABLE &&Revise
    loForm.txtApAmnt.ENABLED = .T.
    IF loForm.llDefEdApr

      *B602830,1 Change this line because we are going to switch between 2 Get
      *          Fields for the "Approve Quantity" to be able to add the
      *          decimal points to the "Approve Quantity" in the case of
      *          document types Material PO, Material PO Return and
      *          Material MFG Order [Begin]
      *SHOW GET loForm.loRec.nApTAprQty ENABLE
      loForm.txtApTAprQty.ENABLED = .T.
      *SHOW OBJECT loFormSet.lnApQtyObj ENABLE
      *B602830,1 Change this line because we are going to switch between 2 [End]

      *Old: SHOW GET loForm.loRec.nAPAprAmnt ENABLE &&Revise
      loForm.txtAPAprAmnt.ENABLED = .T.
    ELSE

      *B602830,1 Change this line because we are going to switch between 2 Get
      *          Fields for the "Approve Quantity" to be able to add the
      *          decimal points to the "Approve Quantity" in the case of
      *          document types Material PO, Material PO Return and
      *          Material MFG Order [Begin]
      *SHOW GET loForm.loRec.nApTAprQty DISABLE
      loForm.txtApTAprQty.ENABLED = .F.
      *SHOW OBJECT loFormSet.lnApQtyObj DISABLE
      *B602830,1 Change this line because we are going to switch between 2 [End]

      *Old: SHOW GET loForm.loRec.nAPAprAmnt DISABLE &&Revise
      loForm.txtAPAprAmnt.ENABLED = .F.
    ENDIF
  ENDIF
  loForm.REFRESH()

  RETURN
  *-- End of lfvInvTQty


  *!*************************************************************
  *! Name      : lfvAprTQty
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 09/02/2004
  *! Purpose   : Invoice line total Approved Quantity
  *!*************************************************************
  *! Parameters:  The FormSet of APPYINV.SCX, The Form of APINVDT.SCX
  *!*************************************************************
  *! Returns   :  None
  *!*************************************************************
FUNCTION lfvAprTQty
  LPARAMETERS loFormSet, loForm

  *The Approved Amount in invoice line should be <= the inv. amount [Begin]
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	IF (loForm.loRec.nAPAprPric * loForm.loRec.nApTAprQty) > loForm.loRec.nApAmnt
  *!*	  =gfModalGen(.F.,'DIALOG',.F.,.F.,'The approved amount should be less than or equal invoice amount')
  *!*	  loForm.loRec.nApTAprQty = nApTAprQty
  *! E302623,3 MMT 01/03/2010 Convert Payable invoice screen to use SQL tables[Start]
  SELECT(IIF(loFormSet.ActiveMode="V",'APVINVDT2',loFormSet.lcAPvInvDt))
  *! E302623,3 MMT 01/03/2010 Convert Payable invoice screen to use SQL tables[End]
  IF (loFormSet.loRec.nAPAprPric * loFormSet.loRec.nApTAprQty) > loFormSet.loRec.nApAmnt
    =gfModalGen(.F.,'DIALOG',.F.,.F.,'The approved amount should be less than or equal invoice amount')
    loFormSet.loRec.nApTAprQty = nApTAprQty
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    RETURN
  ENDIF
  *The Approved Amount in invoice line should be <= the inv. amount [end]

  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	loForm.loRec.nApTAprQty = IIF(lfChkAplTkt(loFormSet,loForm,''),loForm.loRec.nApTAprQty,nApTAprQty)
  *!*	IF loForm.loRec.nApTAprQty <> nApTAprQty
  *!*	  loForm.loRec.nAPAprAmnt = loForm.loRec.nApTAprQty*loForm.loRec.nAPAprPric
  *!*	  loFormSet.lnTAprAmt = loFormSet.lnTAprAmt +(ROUND(loForm.loRec.nAPAprAmnt,2)- ROUND(nApAprAmnt,2))*IIF(loForm.loRec.cIMTyp $ 'RF',-1,1)
  loFormSet.loRec.nApTAprQty = IIF(lfChkAplTkt(loFormSet,loForm,''),loFormSet.loRec.nApTAprQty,nApTAprQty)
  IF loFormSet.loRec.nApTAprQty <> nApTAprQty
    loFormSet.loRec.nAPAprAmnt = loFormSet.loRec.nApTAprQty*loFormSet.loRec.nAPAprPric
    loFormSet.lnTAprAmt = loFormSet.lnTAprAmt +(ROUND(loFormSet.loRec.nAPAprAmnt,2)- ROUND(nApAprAmnt,2))*IIF(loFormSet.loRec.cIMTyp $ 'RF',-1,1)
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    *=lfRefresh('APINVD10')
    =lfUpdAplTkt(loFormSet, loForm)
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *!*	  REPLACE nApTAprQty WITH loForm.loRec.nApTAprQty ,;
    *!*	          nAPAprAmnt WITH loForm.loRec.nAPAprAmnt ,;
    *!*	          cStatus  WITH IIF(cStatus='S','M',cStatus)
    REPLACE nApTAprQty WITH loFormSet.loRec.nApTAprQty ,;
      nAPAprAmnt WITH loFormSet.loRec.nAPAprAmnt ,;
      cStatus  WITH IIF(cStatus='S','M',cStatus)
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    *Old: SHOW GET loForm.loRec.nAPAprAmnt ENABLE &&Revise
    loForm.txtAPAprAmnt.ENABLED = .T.
  ENDIF
  loForm.REFRESH()

  RETURN
  *-- End of lfvAprTQty


  *!*************************************************************
  *! Name      : lfvInvAmnt
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 09/02/2004
  *! Purpose   : Invoice line total Amount
  *!*************************************************************
  *! Parameters:  The FormSet of APPYINV.SCX, The Form of APINVDT.SCX
  *!*************************************************************
  *! Returns   :  None
  *!*************************************************************
FUNCTION lfvInvAmnt
  LPARAMETERS loFormSet, loForm
  *Fix bug when Saving the debit memo againest Return PO [BEGIN]
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	IF (loForm.loRec.cIMTyp $ 'RF' OR loFormSet.llDebitM) AND (loForm.loRec.nApAmnt > 0)
  *!*	  loForm.loRec.nApAmnt = loForm.loRec.nApAmnt * -1
  *! E302623,3 MMT 01/03/2010 Convert Payable invoice screen to use SQL tables[Start]
  IF loFormSet.ActiveMode="V"
    RETURN 
  ENDIF
  SELECT(IIF(loFormSet.ActiveMode="V",'APVINVDT2',loFormSet.lcAPvInvDt))
  *! E302623,3 MMT 01/03/2010 Convert Payable invoice screen to use SQL tables[End]
  IF (loFormSet.loRec.cIMTyp $ 'RF' OR loFormSet.llDebitM) AND (loFormSet.loRec.nApAmnt > 0)
    loFormSet.loRec.nApAmnt = loFormSet.loRec.nApAmnt * -1
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  ENDIF
  *Fix bug when Saving the debit memo againest Return PO [END]
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *IF loForm.loRec.nApAmnt <> nApAmnt
  IF loFormSet.loRec.nApAmnt <> nApAmnt
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    * Add these lines to make sure that the "Invoice Amount" and
    *          the "Approved Amount" have the same sign [Begin]

    *-- If the "Invoice Amount" and the "Approved Amount" have
    *-- different signs
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *!*	  IF SIGN(loForm.loRec.nApAmnt) <> 0 .AND. SIGN(loForm.loRec.nAPAprAmnt) <> 0 .AND.;
    *!*	     SIGN(loForm.loRec.nApAmnt) <> SIGN(loForm.loRec.nAPAprAmnt)
    IF SIGN(loFormSet.loRec.nApAmnt) <> 0 .AND. SIGN(loFormSet.loRec.nAPAprAmnt) <> 0 .AND.;
        SIGN(loFormSet.loRec.nApAmnt) <> SIGN(loFormSet.loRec.nAPAprAmnt)
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

      *-- Message : 04186
      *-- "Invoice amount and approved amount must have the same sign."
      *-- Button : 00000
      *-- "                          <    Ok    >                     "
      =gfModalGen('TRM04186B00000' , 'ALERT')

      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *loForm.loRec.nApAmnt = nApAmnt        && Restore the old value
      loFormSet.loRec.nApAmnt = nApAmnt        && Restore the old value
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

      RETURN
    ENDIF
    *Add these lines to make sure that the "Invoice Amount" [End]

    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *!*	  loForm.loRec.nAPTotQty  = IIF(loForm.loRec.nAPTotQty=0,1,loForm.loRec.nAPTotQty)
    *!*	  *MAN Added the following line
    *!*	  loForm.loRec.nApAmnt = loForm.loRec.nApAmnt * 1.000
    *!*	  loForm.loRec.nAPPrice   = loForm.loRec.nApAmnt/loForm.loRec.nAPTotQty
    loFormSet.loRec.nAPTotQty  = IIF(loFormSet.loRec.nAPTotQty=0,1,loFormSet.loRec.nAPTotQty)
    *MAN Added the following line
    loFormSet.loRec.nApAmnt = loFormSet.loRec.nApAmnt * 1.000
    loFormSet.loRec.nAPPrice   = loFormSet.loRec.nApAmnt/loFormSet.loRec.nAPTotQty
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    *Change these lines to make sure that the "Approved Amount" could
    *          not be less than the "Contributed Amount" [Begin]
    *loForm.loRec.nAPAprAmnt = IIF(llDefAuApr,loForm.loRec.nApAmnt,loForm.loRec.nAPAprAmnt)
    *loForm.loRec.nApTAprQty = IIF(llDefAuApr AND loForm.loRec.nApTAprQty=0,1,loForm.loRec.nApTAprQty)
    *loForm.loRec.nAPAprPric = IIF(loForm.loRec.nApTAprQty=0,0,loForm.loRec.nAPAprAmnt/loForm.loRec.nApTAprQty)

    *-- If Automatic Approve
    IF loForm.llDefAuApr

      *-- If there is no "Approved Amount" (there is no "Contributed Amount")
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *!*	    IF loForm.loRec.nAPAprAmnt = 0
      *!*	      *-- Default the "Approved Amount" with the "Invoice Amount"
      *!*	      loForm.loRec.nAPAprAmnt = loForm.loRec.nApAmnt
      *!*	      *-- Default the "Approved Quantity" with 1 if it's empty otherwise
      *!*	      *-- live it as it is
      *!*	      loForm.loRec.nApTAprQty = IIF(loForm.loRec.nApTAprQty = 0 , 1 , loForm.loRec.nApTAprQty)
      *!*	      *-- Calculate the "Approved Unit Cost"
      *!*	      loForm.loRec.nAPAprPric = loForm.loRec.nAPAprAmnt / loForm.loRec.nApTAprQty
      IF loFormSet.loRec.nAPAprAmnt = 0
        *-- Default the "Approved Amount" with the "Invoice Amount"
        loFormSet.loRec.nAPAprAmnt = loFormSet.loRec.nApAmnt
        *-- Default the "Approved Quantity" with 1 if it's empty otherwise
        *-- live it as it is
        loFormSet.loRec.nApTAprQty = IIF(loFormSet.loRec.nApTAprQty = 0 , 1 , loFormSet.loRec.nApTAprQty)
        *-- Calculate the "Approved Unit Cost"
        loFormSet.loRec.nAPAprPric = loFormSet.loRec.nAPAprAmnt / loFormSet.loRec.nApTAprQty
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      ELSE    && Else (If there is an "Approved Amount")
        *-- Calculate the "Approved Unit Cost" using the "Invoice Amount"
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        *loForm.loRec.nAPAprPric = loForm.loRec.nApAmnt / loForm.loRec.nApTAprQty
        loFormSet.loRec.nAPAprPric = loFormSet.loRec.nApAmnt / loFormSet.loRec.nApTAprQty
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
        *-- If the new "Approved Unit Cost" - that was calculated using the
        *-- "Invoice Amount" - produced an "Approved Amount" greater than
        *-- the "Contributed Amount"
        IF !lfChkAplTkt(loFormSet,loForm,'')
          *-- Restore the old "Approved Unit Cost"
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
          *loForm.loRec.nAPAprPric = nAPAprPric
          loFormSet.loRec.nAPAprPric = nAPAprPric
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
        ELSE
          *-- Default the "Approved Amount" with the "Invoice Amount"
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
          *loForm.loRec.nAPAprAmnt = loForm.loRec.nApAmnt
          loFormSet.loRec.nAPAprAmnt = loFormSet.loRec.nApAmnt
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
        ENDIF
      ENDIF
    ENDIF
    *Change these lines to make sure that the "Approved Amount" [End]

    *Fix bug when Saving the debit memo againest Return PO [BEGIN]
    *lnTInvAmt = lnTInvAmt + (ROUND(loForm.loRec.nApAmnt,2)- ROUND(nAPAMnt,2))*IIF(loForm.loRec.cIMTyp $ 'RF',-1,1)
    *lnTAprAmt = lnTAprAmt + (ROUND(loForm.loRec.nAPAprAmnt,2)- ROUND(nApAprAmnt,2))*IIF(loForm.loRec.cIMTyp $ 'RF',-1,1)
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *!*	  loFormSet.lnTInvAmt = loFormSet.lnTInvAmt + (ROUND(loForm.loRec.nApAmnt,2)- ROUND(nAPAMnt,2))
    *!*	  loFormSet.lnTAprAmt = loFormSet.lnTAprAmt + (ROUND(loForm.loRec.nAPAprAmnt,2)- ROUND(nApAprAmnt,2))
    loFormSet.lnTInvAmt = loFormSet.lnTInvAmt + (ROUND(loFormSet.loRec.nApAmnt,2)- ROUND(nAPAMnt,2))
    loFormSet.lnTAprAmt = loFormSet.lnTAprAmt + (ROUND(loFormSet.loRec.nAPAprAmnt,2)- ROUND(nApAprAmnt,2))
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    *Fix bug when Saving the debit memo againest Return PO [END]

    *=lfRefresh('APINVD10')
    *Fix bug when Saving the debit memo againest Return PO [BEGIN]
    PRIVATE lnDiffAmnt
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *!*	  lnDiffAmnt =  (ROUND(loForm.loRec.nApAmnt,2) - ROUND(nAPAMnt,2)) * IIF((loForm.loRec.cIMTyp $ 'RF'),1,IIF(loFormSet.llDebitM,-1,1))
    *!*	  =lfUpdApDist(loFormSet,loForm,cApVILNo,lnDiffAmnt,cApDGlAct,loForm.loRec.cIMTyp)
    lnDiffAmnt =  (ROUND(loFormSet.loRec.nApAmnt,2) - ROUND(nAPAMnt,2)) * IIF((loFormSet.loRec.cIMTyp $ 'RF'),1,IIF(loFormSet.llDebitM,-1,1))
    =lfUpdApDist(loFormSet,loForm,cApVILNo,lnDiffAmnt,cApDGlAct,loFormSet.loRec.cIMTyp)
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    *Fix bug when Saving the debit memo againest Return PO [END]

    =IIF(loForm.llDefAuApr,lfUpdAplTkt(loFormSet, loForm),.T.)
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *!*	  REPLACE nAPPrice   WITH loForm.loRec.nAPPrice   ,;
    *!*	          nAPTotQty  WITH loForm.loRec.nAPTotQty  ,;
    *!*	          nApAmnt    WITH loForm.loRec.nApAmnt    ,;
    *!*	          nAPAprPric WITH loForm.loRec.nAPAprPric ,;
    *!*	          nApTAprQty WITH loForm.loRec.nApTAprQty ,;
    *!*	          nAPAprAmnt WITH loForm.loRec.nAPAprAmnt ,;
    *!*	          cStatus  WITH IIF(cStatus='S','M',cStatus)
   
    REPLACE nAPPrice   WITH loFormSet.loRec.nAPPrice   ,;
      nAPTotQty  WITH loFormSet.loRec.nAPTotQty  ,;
      nApAmnt    WITH loFormSet.loRec.nApAmnt    ,;
      nAPAprPric WITH loFormSet.loRec.nAPAprPric ,;
      nApTAprQty WITH loFormSet.loRec.nApTAprQty ,;
      nAPAprAmnt WITH loFormSet.loRec.nAPAprAmnt ,;
      cStatus  WITH IIF(cStatus='S','M',cStatus)
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    *Old: SHOW GET loForm.loRec.nAPPrice  ENABLE &&Revise
    loForm.txtAPPrice.ENABLED = .T.

    *Change this line because we are going to switch between 2 Get
    *          Fields for the "Invoice Quantity" to be able to add the
    *          decimal points to the "Invoice Quantity" in the case of
    *          document types Material PO, Material PO Return and
    *          Material MFG Order [Begin]
    *SHOW GET loForm.loRec.nAPTotQty &lcInvQTot
    loForm.txtAPTotQty.ENABLED = (loForm.lcInvQTot='ENABLE')
    *SHOW OBJECT loFormSet.lnQtyObj &loForm.lcInvQTot
    *Change this line because we are going to switch between 2 [End]

    IF loForm.llDefEdApr
      *Old: SHOW GET loForm.loRec.nAPAprPric ENABLE &&Revise
      loForm.txtAPAprPric.ENABLED = .T.

      *Change this line because we are going to switch between 2 Get
      *          Fields for the "Approve Quantity" to be able to add the
      *          decimal points to the "Approve Quantity" in the case of
      *          document types Material PO, Material PO Return and
      *          Material MFG Order [Begin]
      *SHOW GEt loForm.loRec.nApTAprQty &lcAprQty
      loForm.txtApTAprQty.ENABLED = (loForm.lcAprQty='ENABLE')
      *SHOW OBJECT loFormSet.lnApQtyObj &loForm.lcAprQty
      *Change this line because we are going to switch between 2 [End]

      *Old: SHOW GET loForm.loRec.nAPAprAmnt ENABLE &&Revise
      loForm.txtAPAprAmnt.ENABLED = .T.
    ELSE
      *Old: SHOW GET loForm.loRec.nAPAprPric DISABLE &&Revise
      loForm.txtAPAprPric.ENABLED = .F.

      *Change this line because we are going to switch between 2 Get
      *          Fields for the "Approve Quantity" to be able to add the
      *          decimal points to the "Approve Quantity" in the case of
      *          document types Material PO, Material PO Return and
      *          Material MFG Order [Begin]
      *SHOW GEt loForm.loRec.nApTAprQty DISABLE
      loForm.txtApTAprQty.ENABLED = .F.
      *SHOW OBJECT loFormSet.lnApQtyObj DISABLE
      *Change this line because we are going to switch between 2 [End]

      *Old: SHOW GET loForm.loRec.nAPAprAmnt DISABLE &&Revise
      loForm.txtAPAprAmnt.ENABLED = .F.
    ENDIF
  ENDIF
  loForm.REFRESH()

  RETURN
  *-- End of lfvInvAmnt


  *!*************************************************************
  *! Name      : lfvAprAmnt
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 09/02/2004
  *! Purpose   : Invoice line total Approved Amount
  *!*************************************************************
  *! Parameters:  The FormSet of APPYINV.SCX, The Form of APINVDT.SCX
  *!*************************************************************
  *! Returns   :  None
  *!*************************************************************
FUNCTION lfvAprAmnt
  LPARAMETERS loFormSet, loForm

  *Fix bug when Saving the debit memo againest Return PO [BEGIN]
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	IF (loForm.loRec.cIMTyp $ 'RF'OR loFormSet.llDebitM) AND (loForm.loRec.nAPAprAmnt > 0)
  *!*	  loForm.loRec.nAPAprAmnt = loForm.loRec.nAPAprAmnt * -1
  *! E302623,3 MMT 01/03/2010 Convert Payable invoice screen to use SQL tables[Start]
  SELECT(IIF(loFormSet.ActiveMode="V",'APVINVDT2',loFormSet.lcAPvInvDt))
  *! E302623,3 MMT 01/03/2010 Convert Payable invoice screen to use SQL tables[End]
  IF (loFormSet.loRec.cIMTyp $ 'RF'OR loFormSet.llDebitM) AND (loFormSet.loRec.nAPAprAmnt > 0)
    loFormSet.loRec.nAPAprAmnt = loFormSet.loRec.nAPAprAmnt * -1
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  ENDIF
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *IF ABS(loForm.loRec.nAPAprAmnt) > ABS(loForm.loRec.nApAmnt)
  IF ABS(loFormSet.loRec.nAPAprAmnt) > ABS(loFormSet.loRec.nApAmnt)
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    =gfModalGen(.F.,'DIALOG',.F.,.F.,'The approved amount should be less than or equal invoice amount')
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *loForm.loRec.nAPAprAmnt = nAPAprAmnt
    loFormSet.loRec.nAPAprAmnt = nAPAprAmnt
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    RETURN
  ENDIF
  *Fix bug when Saving the debit memo againest Return PO [END]

  *MAN
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *loForm.loRec.nAPAprAmnt = IIF(lfChkAplTkt(loFormSet,loForm,''),loForm.loRec.nAPAprAmnt,nAPAprAmnt)
  *IF loForm.loRec.nAPAprAmnt <> nAPAprAmnt
  loFormSet.loRec.nAPAprAmnt = IIF(lfChkAplTkt(loFormSet,loForm,''),loFormSet.loRec.nAPAprAmnt,nAPAprAmnt)
  IF loFormSet.loRec.nAPAprAmnt <> nAPAprAmnt
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    *Add these lines to make sure that the "Invoice Amount" and
    *          the "Approved Amount" have the same sign [Begin]

    *-- If the "Invoice Amount" and the "Approved Amount" have
    *-- different signs
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *!*	  IF SIGN(loForm.loRec.nApAmnt) <> 0 .AND. SIGN(loForm.loRec.nAPAprAmnt) <> 0 .AND.;
    *!*	     SIGN(loForm.loRec.nApAmnt) <> SIGN(loForm.loRec.nAPAprAmnt)
    IF SIGN(loFormSet.loRec.nApAmnt) <> 0 .AND. SIGN(loFormSet.loRec.nAPAprAmnt) <> 0 .AND.;
        SIGN(loFormSet.loRec.nApAmnt) <> SIGN(loFormSet.loRec.nAPAprAmnt)
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[END]
      *-- Message : 04186
      *-- "Invoice amount and approved amount must have the same sign."
      *-- Button : 00000
      *-- "                          <    Ok    >                     "
      =gfModalGen('TRM04186B00000' , 'ALERT')
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *loForm.loRec.nAPAprAmnt = nAPAprAmnt        && Restore the old value
      loFormSet.loRec.nAPAprAmnt = nAPAprAmnt        && Restore the old value
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[END]
      RETURN
    ENDIF
    *Add these lines to make sure that the "Invoice Amount" [End]

    *MAN Added the following line
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *!*	  loForm.loRec.nAPAprAmnt = loForm.loRec.nAPAprAmnt * 1.000
    *!*	  loForm.loRec.nApTAprQty = IIF(loForm.loRec.nApTAprQty=0,1,loForm.loRec.nApTAprQty)
    *!*	  loForm.loRec.nAPAprPric = loForm.loRec.nAPAprAmnt/loForm.loRec.nApTAprQty
    *!*	  loFormSet.lnTAprAmt = loFormSet.lnTAprAmt + (ROUND(loForm.loRec.nAPAprAmnt,2)- ROUND(nApAprAmnt,2))
    loFormSet.loRec.nAPAprAmnt = loFormSet.loRec.nAPAprAmnt * 1.000
    loFormSet.loRec.nApTAprQty = IIF(loFormSet.loRec.nApTAprQty=0,1,loFormSet.loRec.nApTAprQty)
    loFormSet.loRec.nAPAprPric = loFormSet.loRec.nAPAprAmnt/loFormSet.loRec.nApTAprQty
    loFormSet.lnTAprAmt = loFormSet.lnTAprAmt + (ROUND(loFormSet.loRec.nAPAprAmnt,2)- ROUND(nApAprAmnt,2))
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[END]
    *=lfRefresh('APINVD10')
    =lfUpdAplTkt(loFormSet, loForm)
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *!*	  REPLACE nAPAprPric WITH loForm.loRec.nAPAprPric ,;
    *!*	          nApTAprQty WITH loForm.loRec.nApTAprQty ,;
    *!*	          nAPAprAmnt WITH loForm.loRec.nAPAprAmnt ,;
    *!*	          cStatus  WITH IIF(cStatus='S','M',cStatus)
    REPLACE nAPAprPric WITH loFormSet.loRec.nAPAprPric ,;
      nApTAprQty WITH loFormSet.loRec.nApTAprQty ,;
      nAPAprAmnt WITH loFormSet.loRec.nAPAprAmnt ,;
      cStatus  WITH IIF(cStatus='S','M',cStatus)
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    *Old: SHOW GET loForm.loRec.nAPAprPric ENABLE &&Revise
    loForm.txtAPAprPric.ENABLED = .T.

    *Change this line because we are going to switch between 2 Get
    *          Fields for the "Approve Quantity" to be able to add the
    *          decimal points to the "Approve Quantity" in the case of
    *          document types Material PO, Material PO Return and
    *          Material MFG Order [Begin]
    *SHOW GEt loForm.loRec.nApTAprQty &lcAprQty
    loForm.txtApTAprQty.ENABLED = (loForm.lcAprQty='ENABLE')
    *SHOW OBJECT loFormSet.lnApQtyObj &loForm.lcAprQty  &&lower
    *Change this line because we are going to switch between 2 [End]

  ENDIF
  loForm.REFRESH()

  RETURN
  *-- End of lfvAprAmnt

  *!*************************************************************
  *! Name      : lfvStyle
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 09/02/2004
  *! Purpose   : Validate styles
  *!*************************************************************
  *! Parameters:  The FormSet of APPYINV.SCX, The Form of APINVDT.SCX
  *!*************************************************************
  *! Returns   :  None
  *!*************************************************************
FUNCTION lfvStyle
  LPARAMETERS loFormSet, loForm, llBrowse, lnItemPart, lcValue, lcOldValue, lcStyleVal
  LOCAL lcEmptyItem

  lcEmptyItem=STRTRAN(gfItemMask("PI"),'X',' ')
  loFormSet.llBrowse = llBrowse
  IF !loFormSet.llBrowse AND loForm.cntStyle.txtitem.VALUE=lcEmptyItem
    RETURN
  ENDIF
  loForm.cntStyle.VALUE = loForm.cntStyle.txtitem.VALUE

  IF lfIsContrib(loFormSet, loForm)
    loForm.cntStyle.VALUE=ITEM
    loFormSet.llBrowse = .F.
    *loForm.cntStyle.SelectedFromBrowse = .F.
    loForm.REFRESH()
    RETURN
  ENDIF
  IF EMPTY(loForm.kbInvTktNo.KeyTextBox.VALUE)
    IF loFormSet.llBrowse .OR. (!loForm.cntStyle.VALUE=lcEmptyItem AND !SEEK(loForm.cntStyle.VALUE,'STYLE'))
      loForm.cntStyle.VALUE = loForm.cntStyle.mStyleBrow('I',loForm.cntStyle.VALUE)
      loForm.cntStyle.VALUE = IIF(loForm.cntStyle.VALUE=lcEmptyItem,ITEM,loForm.cntStyle.VALUE)
    ENDIF
    loFormSet.llBrowse = .F.
    *loForm.cntStyle.SelectedFromBrowse = .F.
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *IF loForm.cntStyle.Value = loForm.loRec.Item
    IF loForm.cntStyle.VALUE = loFormSet.loRec.ITEM
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      loForm.REFRESH()
      RETURN
    ENDIF
    =SEEK(loForm.cntStyle.VALUE,'Style') &&ASM, Make sure Sytle table is correctly positioned
    IF !loForm.cntStyle.VALUE=lcEmptyItem
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *  IF loForm.loRec.cIMTyp='M' AND !Style.Make
      IF loFormSet.loRec.cIMTyp='M' AND !STYLE.MAKE
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
        *Message : 04173
        *Only Manufacturing Styles are allowed
        *Button : 00000
        *Ok
        =gfModalGen("TRM04173B00000","DIALOG",'Manufacturing Styles')
        loForm.cntStyle.VALUE = ITEM
        loForm.REFRESH()
        RETURN
      ENDIF
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *IF INLIST(loForm.loRec.cIMTyp,'I','S','R') AND Style.Make
      IF INLIST(loFormSet.loRec.cIMTyp,'I','S','R') AND STYLE.MAKE
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
        *Message : 04173
        *Only Importing Styles are allowed
        *Button : 00000
        *Ok
        =gfModalGen("TRM04173B00000","DIALOG",'Importing Styles')
        loForm.cntStyle.VALUE = ITEM
        loForm.REFRESH()
        RETURN
      ENDIF
    ENDIF
  ELSE
    loForm.cntStyle.VALUE = IIF(loFormSet.llBrowse,'?',loForm.cntStyle.VALUE)
    loFormSet.llBrowse = .F.
    *loForm.cntStyle.SelectedFromBrowse = .F.
    lcStyle = loForm.cntStyle.VALUE
    lcStyDye = loForm.kbDyelot.KeyTextBox.VALUE
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *!*	  IF !lfItemQty(loFormSet,loForm,loForm.loRec.cIMTyp,loForm.kbInvTktNo.KeyTextBox.Value,loForm.loRec.cLotNo,;
    *!*	      loForm.loRec.cBomType,loForm.loRec.cOprCode,@lcStyle,SPACE(6),@lcStyDye)
    IF !lfItemQty(loFormSet,loForm,loFormSet.loRec.cIMTyp,loForm.kbInvTktNo.KeyTextBox.VALUE,loFormSet.loRec.cLotNo,;
        loFormSet.loRec.cBomType,loFormSet.loRec.cOprCode,@lcStyle,SPACE(6),@lcStyDye)
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      loForm.cntStyle.VALUE = lcStyle
      loForm.kbDyelot.KeyTextBox.VALUE = lcStyDye
      loForm.cntStyle.VALUE = ITEM
      loForm.REFRESH()
      RETURN
    ELSE
      loForm.cntStyle.VALUE = lcStyle
      loForm.kbDyelot.KeyTextBox.VALUE = lcStyDye
    ENDIF
  ENDIF
  =SEEK(loForm.cntStyle.VALUE,'Style')
  loForm.txtStyDesc.VALUE = STYLE.Desc1
  IF EMPTY(loForm.cntStyle.VALUE) OR STYLE.cDye_Flg <> 'Y'
    STORE SPACE(10) TO loForm.kbDyelot.KeyTextBox.VALUE
  ENDIF

  *Get the correct WIP account with shipment ticket [Begin]
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *IF !EMPTY(loForm.cntStyle.Value) AND loForm.loRec.cIMTyp = 'S'
  IF !EMPTY(loForm.cntStyle.VALUE) AND loFormSet.loRec.cIMTyp = 'S'
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    lcLinkCode = IIF(EMPTY(loForm.kbInvTktNo.KeyTextBox.VALUE),SPACE(6),;
      SUBSTR(lfGetGlLnk(loForm.kbInvTktNo.KeyTextBox.VALUE,loForm.cntStyle.VALUE,''),1,6))
    IF !SEEK(lcLinkCode+'013','GL_LINK')
      =SEEK('DEFDEF'+'013','GL_LINK')
    ENDIF
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *  STORE GL_Link.GlAcnt TO loForm.loRec.cApDGlAct
    STORE GL_Link.GlAcnt TO loFormSet.loRec.cApDGlAct
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    SELECT (loFormSet.lcAPvInvDt)
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *!*	  IF cApDGlAct <> loForm.loRec.cApDGlAct
    *!*	    =lfUpdApDist(loFormSet,loForm,cApVILNo,0,loForm.loRec.cApDGlAct,loForm.loRec.cIMTyp)
    *!*	    REPLACE cApDGlAct WITH loForm.loRec.cApDGlAct ,;
    *!*	            cStatus   WITH IIF(cStatus='S','M',cStatus)
    IF cApDGlAct <> loFormSet.loRec.cApDGlAct
      =lfUpdApDist(loFormSet,loForm,cApVILNo,0,loFormSet.loRec.cApDGlAct,loFormSet.loRec.cIMTyp)
      REPLACE cApDGlAct WITH loFormSet.loRec.cApDGlAct ,;
        cStatus   WITH IIF(cStatus='S','M',cStatus)
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    ENDIF
  ENDIF
  *Get the correct WIP account with shipment ticket [end]

  *=lfRefresh('APINVD10')
  SELECT (loFormSet.lcAPvInvDt)
  REPLACE ITEM     WITH loForm.cntStyle.VALUE   ,;
    cDyelot  WITH loForm.kbDyelot.KeyTextBox.VALUE  ,;
    cAPVIDes WITH loForm.txtStyDesc.VALUE ,;
    cStatus  WITH IIF(cStatus='S','M',cStatus)

  *?Amin
  *update MFgOper with proper value   [Start]
  IF EVALUATE(loFormSet.lcAPvInvDt+'.cOprCode') = REPLICATE('*',6)
    REPLACE cOprCode WITH IIF(!STYLE.lDetCost,PADR('*'+EVALUATE(loFormSet.lcAPvInvDt+'.cBomType'),6),;
      EVALUATE(loFormSet.lcAPvInvDt+'.cOprCode'))
  ENDIF
  IF EVALUATE(loFormSet.lcAPvInvDt+'.cOprCode')  =REPLICATE('#',6)
    REPLACE cOprCode WITH IIF(!STYLE.lDetCost,PADR('*'+EVALUATE(loFormSet.lcAPvInvDt+'.cBomType'),6),;
      EVALUATE(loFormSet.lcAPvInvDt+'.cOprCode'))
  ENDIF
  *update MFgOper with proper value   [End]

  =lfShowWind(loFormSet,loForm)
  loForm.REFRESH()

  RETURN
  *-- End of lfvStyle


  *!*************************************************************
  *! Name      : lfvStyDye
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 09/02/2004
  *! Purpose   : Validate style Dyelots
  *!*************************************************************
  *! Parameters:  The FormSet of APPYINV.SCX, The Form of APINVDT.SCX
  *!*************************************************************
  *! Returns   :  None
  *!*************************************************************
FUNCTION lfvStyDye
  LPARAMETERS loFormSet, loForm

  loFormSet.llBrowse = loForm.kbDyelot.SelectedFromBrowse

  IF !EMPTY(loForm.kbInvTktNo.KeyTextBox.VALUE)
    loForm.kbDyelot.KeyTextBox.VALUE = IIF(loFormSet.llBrowse,'?',loForm.kbDyelot.KeyTextBox.VALUE)
    loFormSet.llBrowse = .F.
    loForm.kbDyelot.SelectedFromBrowse = .F.
    lcStyle = loForm.cntStyle.VALUE
    lcStyDye = loForm.kbDyelot.KeyTextBox.VALUE
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *!*	  IF !lfItemQty(loFormSet,loForm,loForm.loRec.cIMTyp,loForm.kbInvTktNo.KeyTextBox.Value,loForm.loRec.cLotNo,loForm.loRec.cBomType,loForm.loRec.cOprCode,;
    *!*	               @lcStyle,SPACE(6),@lcStyDye)
    IF !lfItemQty(loFormSet,loForm,loFormSet.loRec.cIMTyp,loForm.kbInvTktNo.KeyTextBox.VALUE,loFormSet.loRec.cLotNo,loFormSet.loRec.cBomType,loFormSet.loRec.cOprCode,;
        @lcStyle,SPACE(6),@lcStyDye)
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      lcStyDye = cDyelot
      loForm.cntStyle.VALUE = lcStyle
      loForm.kbDyelot.KeyTextBox.VALUE = lcStyDye
      loForm.REFRESH()
      RETURN
    ELSE
      loForm.cntStyle.VALUE = lcStyle
      loForm.kbDyelot.KeyTextBox.VALUE = lcStyDye
    ENDIF
  ENDIF
  =SEEK(lloForm.cntStyle.VALUE,'Style')
  loForm.txtStyDesc.VALUE = STYLE.Desc1
  *Old: SHOW GET lcStyDesc &&Revise
  *=lfRefresh('APINVD10')
  SELECT (loFormSet.lcAPvInvDt)
  REPLACE ITEM     WITH loForm.cntStyle.VALUE   ,;
    cDyelot  WITH loForm.kbDyelot.KeyTextBox.VALUE  ,;
    cAPVIDes WITH loForm.txtStyDesc.VALUE ,;
    cStatus  WITH IIF(cStatus='S','M',cStatus)

  =lfShowWind(loFormSet,loForm)
  loForm.REFRESH()

  RETURN
  *-- End of lfvStyDye


  *!*************************************************************
  *! Name      : lfvFabric
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 09/02/2004
  *! Purpose   : Validate Fabrics
  *!*************************************************************
  *! Parameters:  The FormSet of APPYINV.SCX, The Form of APINVDT.SCX
  *!*************************************************************
  *! Returns   :  None
  *!*************************************************************
FUNCTION lfvFabric
  LPARAMETERS loFormSet, loForm, llBrowse, lnItemPart, lcValue, lcOldValue, lcStyleVal

  loForm.cntItem.VALUE = loForm.cntItem.txtitem.VALUE

  loFormSet.llBrowse = llBrowse
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *IF !loFormSet.llBrowse AND loForm.cntItem.Value=lfupditem(loForm.loRec.Item,loForm.loRec.Color)
  IF !loFormSet.llBrowse AND loForm.cntItem.VALUE=lfupditem(loFormSet.loRec.ITEM,loFormSet.loRec.COLOR)
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    RETURN
  ENDIF
  IF lfIsContrib(loFormSet, loForm)
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *  loForm.cntItem.Value = lfupditem(loForm.loRec.Item,loForm.loRec.Color)
    loForm.cntItem.VALUE = lfupditem(loFormSet.loRec.ITEM,loFormSet.loRec.COLOR)
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    loFormSet.llBrowse = .F.
    *loForm.cntItem.SelectedFromBrowse = .F.
    loForm.REFRESH()
    RETURN
  ENDIF
  IF EMPTY(loForm.kbInvTktNo.KeyTextBox.VALUE)
    **CINVTYPE+STYLE
    IF loFormSet.llBrowse .OR. !loFormSet.FABRIC.SEEK('0002'+loForm.cntItem.VALUE) &&Sql82: Check Key
      loForm.cntItem.VALUE = loForm.cntItem.mStyleBrow('I',loForm.cntItem.VALUE)
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *loForm.cntItem.Value = IIF(EMPTY(loForm.cntItem.Value),lfupditem(loForm.loRec.Item,loForm.loRec.Color),loForm.cntItem.Value)
      loForm.cntItem.VALUE = IIF(EMPTY(loForm.cntItem.VALUE),lfupditem(loFormSet.loRec.ITEM,loFormSet.loRec.COLOR),loForm.cntItem.VALUE)
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[ENd]
    ENDIF
    SELECT (loFormSet.lcAPvInvDt)
    loFormSet.llBrowse = .F.
    *loForm.cntItem.SelectedFromBrowse = .F.
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *IF loForm.cntItem.Value = lfupditem(loForm.loRec.Item,loForm.loRec.Color)
    IF loForm.cntItem.VALUE = lfupditem(loFormSet.loRec.ITEM,loFormSet.loRec.COLOR)
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      loForm.REFRESH()
      RETURN
    ENDIF
    **CINVTYPE+STYLE
    =loFormSet.Fabric.SEEK('0002'+loForm.cntItem.VALUE) &&Sql83: Check Key
    IF !EMPTY(loForm.cntItem.VALUE)
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *  IF INLIST(loForm.loRec.cIMTyp,'L','F') AND Fabric.Make
      IF INLIST(loFormSet.loRec.cIMTyp,'L','F') AND Fabric.MAKE
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
        *Message : 04173
        *Only Importing Materials are allowed
        *Button : 00000
        *Ok
        =gfModalGen("TRM04173B00000","DIALOG",'Importing Materials')
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        *loForm.cntItem.Value = lfupditem(loForm.loRec.Item,loForm.loRec.Color)
        loForm.cntItem.VALUE = lfupditem(loFormSet.loRec.ITEM,loFormSet.loRec.COLOR)
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
        loForm.REFRESH()
        RETURN
      ENDIF
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *IF loForm.loRec.cIMTyp = 'T' AND !Fabric.Make
      IF loFormSet.loRec.cIMTyp = 'T' AND !Fabric.MAKE
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
        *Message : 04173
        *Only Manufacturing Materials are allowed
        *Button : 00000
        *Ok
        =gfModalGen("TRM04173B00000","DIALOG",'Manufacturing Materials')
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        *loForm.cntItem.Value = lfupditem(loForm.loRec.Item,loForm.loRec.Color)
        loForm.cntItem.VALUE = lfupditem(loFormSet.loRec.ITEM,loFormSet.loRec.COLOR)
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
        loForm.REFRESH()
        RETURN
      ENDIF
    ENDIF
  ELSE
    loForm.cntItem.VALUE = IIF(loFormSet.llBrowse,'?',loForm.cntItem.VALUE)
    lcFabric = loForm.cntItem.cMajor
    lcFabClr = loForm.cntItem.cNonMajor
    lcFabDye = loForm.kbDyeLot.KeyTextBox.VALUE
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *!*	  IF !lfItemQty(loFormSet,loForm,loForm.loRec.cIMTyp,loForm.kbInvTktNo.KeyTextBox.Value,loForm.loRec.cLotNo,;
    *!*	       loForm.loRec.cBomType,loForm.loRec.cOprCode,@lcFabric, @lcFabClr,@lcFabDye)
    *!*	    loForm.cntItem.Value = lfupditem(loForm.loRec.Item,loForm.loRec.Color)
    IF !lfItemQty(loFormSet,loForm,loFormSet.loRec.cIMTyp,loForm.kbInvTktNo.KeyTextBox.VALUE,loFormSet.loRec.cLotNo,;
        loFormSet.loRec.cBomType,loFormSet.loRec.cOprCode,@lcFabric, @lcFabClr,@lcFabDye)
      loForm.cntItem.VALUE = lfupditem(loFormSet.loRec.ITEM,loFormSet.loRec.COLOR)
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      loForm.kbDyeLot.KeyTextBox.VALUE = lcFabDye
    ELSE
      loForm.cntItem.VALUE = lfupditem(lcFabric, lcFabClr)
      loForm.kbDyeLot.KeyTextBox.VALUE = lcFabDye
    ENDIF
  ENDIF
  *CINVTYPE+STYLE
  =loFormSet.FABRIC.SEEK('0002'+loForm.cntItem.VALUE) &&Sql84: Check Key
  loForm.kbDyeLot.KeyTextBox.VALUE = IIF(Fabric.cDye_Flg='Y',loForm.kbDyeLot.KeyTextBox.VALUE,SPACE(10))
  loForm.txtStyDesc.VALUE = Fabric.DESC
  *Old: SHOW GET lcFabDesc &&Revise
  *Old: SHOW GET lcFabric &&Revise
  REPLACE ITEM     WITH loForm.cntItem.cMajor  ,;
    COLOR    WITH loForm.cntItem.cNonMajor  ,;
    cDyelot  WITH loForm.kbDyeLot.KeyTextBox.VALUE  ,;
    cAPVIDes WITH loForm.txtStyDesc.VALUE ,;
    cStatus  WITH IIF(cStatus='S','M',cStatus)
  *=lfRefresh('APINVD10')
  *=lfShowWind()
  =lfShowWind(loFormSet,loForm)
  loForm.REFRESH()

  RETURN
  *-- End of lfvFabric


  *!***************************************************************************************
  *! Name      : lfvFabDye
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 09/02/2004
  *! Purpose   : Validate Fabric/Color/Dyelots
  *!*************************************************************
  *! Parameters:  The FormSet of APPYINV.SCX, The Form of APINVDT.SCX
  *!*************************************************************
  *! Returns   :  None
  *!*************************************************************
FUNCTION lfvFabDye
  LPARAMETERS loFormSet, loForm

  loFormSet.llBrowse = loForm.kbDyeLot.SelectedFromBrowse

  IF EMPTY(loForm.kbInvTktNo.KeyTextBox.VALUE)
    SELECT FABDYE
    *CINVTYPE+STYLE+CWARECODE+DYELOT
    =loFormSet.FABDYE.SEEK('0002'+loForm.cntItem.VALUE)  &&Sql85: Check Key
    LOCATE REST WHILE STYLE+cwarecode+dyelot = loForm.cntItem.VALUE FOR Dyelot = loForm.kbDyelot.KeyTextBox.VALUE
    IF loFormSet.llBrowse OR !FOUND()
      lcFabDye = loForm.kbDyelot.KeyTextBox.VALUE
      =FDYEBROW(loForm.cntItem.cMajor,loForm.cntItem.cNonMajor,@lcFabDye,.T.)
      loForm.kbDyelot.KeyTextBox.VALUE = lcFabDye
    ENDIF
    loFormSet.llBrowse = .F.
    loForm.kbDyeLot.SelectedFromBrowse = .F.
  ELSE
    loForm.kbDyelot.KeyTextBox.VALUE = IIF(loFormSet.llBrowse,'?',loForm.kbDyelot.KeyTextBox.VALUE)
    loFormSet.llBrowse = .F.
    loForm.kbDyeLot.SelectedFromBrowse = .F.
    lcFabric = loForm.cntItem.cMajor
    lcFabClr = loForm.cntItem.cNonMajor
    lcFabDye = loForm.kbDyeLot.KeyTextBox.VALUE
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *!*	  IF !lfItemQty(loFormSet,loForm,loForm.loRec.cIMTyp,loForm.kbInvTktNo.KeyTextBox.Value,loForm.loRec.cLotNo,;
    *!*	     loForm.loRec.cBomType,loForm.loRec.cOprCode,@lcFabric,@lcFabClr,@lcFabDye)
    IF !lfItemQty(loFormSet,loForm,loFormSET.loRec.cIMTyp,loForm.kbInvTktNo.KeyTextBox.VALUE,loFormSet.loRec.cLotNo,;
        loFormSet.loRec.cBomType,loFormSet.loRec.cOprCode,@lcFabric,@lcFabClr,@lcFabDye)
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      lcFabDye = cDyelot
      loForm.cntItem.VALUE = lfupditem(lcFabric,lcFabClr)
      loForm.kbDyeLot.KeyTextBox.VALUE = lcFabDye
      loForm.REFRESH()
      RETURN
    ELSE
      loForm.cntItem.VALUE = lfupditem(lcFabric,lcFabClr)
      loForm.kbDyeLot.KeyTextBox.VALUE = lcFabDye
    ENDIF
  ENDIF
  *CINVTYPE+STYLE
  =loFormSet.FABRIC.SEEK('0002'+loForm.cntItem.VALUE) &&Sql86: Check Key
  loForm.txtStyDesc.VALUE = Fabric.DESC
  *Old: SHOW GET lcFabDesc &&Revise
  *Old: SHOW GET lcFabric &&Revise
  SELECT (loFormSet.lcAPvInvDt)
  REPLACE ITEM     WITH loForm.cntItem.cMajor  ,;
    COLOR    WITH loForm.cntItem.cNonMajor  ,;
    cDyelot  WITH loForm.kbDyeLot.KeyTextBox.VALUE  ,;
    cAPVIDes WITH loForm.txtStyDesc.VALUE ,;
    cStatus  WITH IIF(cStatus='S','M',cStatus)
  *=lfRefresh('APINVD10')
  =lfShowWind(loFormSet,loForm)
  loForm.REFRESH()

  RETURN
  *-- End of lfvFabDye


  *!*************************************************************
  *! Name      : lfvItem
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 09/02/2004
  *! Purpose   : Validate Free Formate Invoice item
  *!*************************************************************
  *! Parameters:  The FormSet of APPYINV.SCX, The Form of APINVDT.SCX
  *!*************************************************************
  *! Returns   :  None
  *!*************************************************************
FUNCTION lfvItem
  LPARAMETERS loFormSet, loForm
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	IF Item <> loForm.loRec.Item
  *!*	  REPLACE Item WITH loForm.loRec.Item ,;
  *!*	          cStatus WITH IIF(cStatus='S','M',cStatus)
  SELECT(IIF(loFormSet.ActiveMode="V",'APVINVDT2',loFormSet.lcAPvInvDt))
  IF ITEM <> loFormSet.loRec.ITEM
    REPLACE ITEM WITH loFormSet.loRec.ITEM ,;
      cStatus WITH IIF(cStatus='S','M',cStatus)
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  ENDIF

  RETURN
  *-- End of lfvItem


  *!*************************************************************
  *! Name      : lfvItemDesc
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 09/02/2004
  *! Purpose   : Validate Free Formate Invoice item Description
  *!*************************************************************
  *! Parameters:  The FormSet of APPYINV.SCX, The Form of APINVDT.SCX
  *!*************************************************************
  *! Returns   :  None
  *!*************************************************************
FUNCTION lfvItemDesc
  LPARAMETERS loFormSet, loForm

  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	IF cAPVIDes <> loForm.loRec.cAPVIDes
  *!*	  REPLACE cAPVIDes WITH loForm.loRec.cAPVIDes ,;
  *!*	          cStatus  WITH IIF(cStatus='S','M',cStatus)
  SELECT(IIF(loFormSet.ActiveMode="V",'APVINVDT2',loFormSet.lcAPvInvDt))
  IF cAPVIDes <> loFormSet.loRec.cAPVIDes
    REPLACE cAPVIDes WITH loFormSet.loRec.cAPVIDes ,;
      cStatus  WITH IIF(cStatus='S','M',cStatus)
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  ENDIF

  RETURN
  *-- End of lfvItemDesc


  *!*************************************************************
  *! Name      : lfWLTaxCode
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 09/02/2004
  *! Purpose   : Called From the When Event of Invoice Line Tax Code in APINVDT.SCX
  *!*************************************************************
  *! Parameters:  The FormSet of APPYINV.SCX, The Form of APINVDT.SCX
  *!*************************************************************
  *! Returns   :  None
  *!*************************************************************
FUNCTION lfWLTaxCode
  LPARAMETERS loFormSet, loForm

  DIMENSION laCodes[ALEN(loFormSet.laCodes,1),ALEN(loFormSet.laCodes,2)]
  =ACOPY(loFormSet.laCodes,laCodes)
  gfwCodePop(@laCodes,'CTAXCODE','L')
  =ACOPY(laCodes,loFormSet.laCodes)
  loForm.cboTaxCode.REQUERY()

  RETURN
  *-- End of lfWLTaxCode


  *!*************************************************************
  *! Name      : lfvLTaxCode
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 09/02/2004
  *! Purpose   : Validate Invoice Line Tax Code (cboTaxCode) in APINVDT.SCX
  *!*************************************************************
  *! Parameters:  The FormSet of APPYINV.SCX, The Form of APINVDT.SCX
  *!*************************************************************
  *! Returns   :  None
  *!*************************************************************
FUNCTION lfvLTaxCode
  LPARAMETERS loFormSet, loForm
  *LPARAMETERS loFormSet, loForm

  =SEEK(cVendCode+cApInvNo+cAPVILNo,loFormSet.lcTmpDist)
  *B608574,1 05/28/2008 AKA,  Fix the problem adding tax code on AP invoice lines [start]
  *IF EVALUATE(loFormSet.lcTmpDist+'.CTAXCODE') <> loFormSet.laTaxCode[loFormSet.lnTaxCode,2]
  IF (ALLTRIM(loFormSet.laTaxCode[loFormSet.lnTaxCode,1]) <>"N/A")
    *B608574,1 05/28/2008 AKA,  Fix the problem adding tax code on AP invoice lines [End]
    *! B608409,1 SSH 01/16/2008 Incorect Taxes in distribution line screen
    *!*	  DIMENSION laTaxAry[ALEN(loFormSet.laTaxAry,1),ALEN(loFormSet.laTaxAry,2)]
    *!*	  =ACOPY(loFormSet.laTaxAry,laTaxAry)

    PRIVATE cTempRetVal
    DIMENSION laTaxAry[1,2]
    cTempRetVal=""
    laTaxAry[1,1]="CGLINPACCT"
    laTaxAry[1,2]="cTempRetVal"
    =gfRltFld(loFormSet.laTaxCode[loFormSet.lnTaxCode,2],@laTaxAry,'CTAXCODE')
    loFormSet.lcApdGLAct=cTempRetVal
    *!*	   =ACOPY(laTaxAry,loFormSet.laTaxAry)
    *! B608409,1 SSH 01/16/2008 Incorect Taxes in distribution line screen
    loFormSet.lcApdGLAct = IIF(!EMPTY(STRTRAN(STRTRAN(loFormSet.lcApdGlAct,'-'),'0')),;
      SUBSTR(loFormSet.lcApdGlAct,1,LEN(ALLTRIM(loFormSet.AriaForm1.ap1.lcemptyacc))), loFormSet.AriaForm1.ap1.lcemptyacc)

    *Message : 04091
    *G/L Input Account xxxx for tax xxxx is not found in the chart of
    *account. You cannot select this tax code
    *Button : 00000
    *Ok
    IF loFormSet.AriaForm1.ap1.llApGlLink .AND. !SEEK(loFormSet.lcApdGLAct, 'lcLinkChar')
      =gfModalGen("TRM04091B00000","DIALOG",ALLTRIM(loFormSet.lcApdGLAct)+'|'+ALLTRIM(loFormSet.laTaxCode[loFormSet.lnTaxCode,1]))
      DIMENSION laCodes[ALEN(loFormSet.laCodes,1),ALEN(loFormSet.laCodes,2)]
      =ACOPY(loFormSet.laCodes,laCodes)
      =gfwCodePop(@laCodes,'CTAXCODE','T')
      =ACOPY(laCodes,loFormSet.laCodes)
      RETURN
    ENDIF
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *loForm.loRec.cApDGlAct = loFormSet.lcApdGLAct
    loFormSet.loRec.cApDGlAct = loFormSet.lcApdGLAct
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    SELECT (loFormSet.lcAPvInvDt)
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *!*	  IF cApDGlAct <> loForm.loRec.cApDGlAct
    *!*	    REPLACE cApDGlAct WITH loForm.loRec.cApDGlAct ,;
    *!*	            cStatus   WITH IIF(cStatus='S','M',cStatus)
    IF cApDGlAct <> loFormSet.loRec.cApDGlAct
      REPLACE cApDGlAct WITH loFormSet.loRec.cApDGlAct ,;
        cStatus   WITH IIF(cStatus='S','M',cStatus)
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    ENDIF
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *=lfUpdApDist(loFormSet,loForm,cApVILNo,0,cApDGlAct,loForm.loRec.cIMTyp)
    =lfUpdApDist(loFormSet,loForm,cApVILNo,0,cApDGlAct,loFormSet.loRec.cIMTyp)
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  ENDIF

  SELECT (loFormSet.lcAPvInvDt)
  REPLACE CTaxCode  WITH ALLTRIM(loFormSet.laTaxCode[loFormSet.lnTaxCode,2])
  IF EMPTY(loFormSet.laTaxCode[loFormSet.lnTaxCode,2])
    IF loFormSet.laSetups[3,2]='Y'
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *!*	    STORE loFormSet.lcDistAcct TO loForm.loRec.cApDGlAct
      *!*	    IF cApDGlAct <> loForm.loRec.cApDGlAct
      *!*	      REPLACE cApDGlAct WITH loForm.loRec.cApDGlAct ,;
      *!*	              cStatus   WITH IIF(cStatus='S','M',cStatus)
      STORE loFormSet.lcDistAcct TO loFormSet.loRec.cApDGlAct
      IF cApDGlAct <> loFormSet.loRec.cApDGlAct
        REPLACE cApDGlAct WITH loFormSet.loRec.cApDGlAct ,;
          cStatus   WITH IIF(cStatus='S','M',cStatus)
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      ENDIF
    ENDIF
    *Old: SHOW GET ibWIPAcnt   ENABLE &&Revise
    *Old: SHOW GET m.cApDGlAct ENABLE &&Revise
    loForm.glApDGlAct.ENABLED = .T.
  ELSE
    *Old: SHOW GET ibWIPAcnt   DISABLE &&Revise
    *Old: SHOW GET m.cApDGlAct DISABLE &&Revise
    loForm.glApDGlAct.ENABLED = .F.
  ENDIF
  loForm.REFRESH()

  RETURN
  *-- End of lfvLTaxCode


  *!*************************************************************
  *! Name      : lfvInvQty
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 09/02/2004
  *! Purpose   : Validate Invoice Size Quantity (cntAP_Qty) in APINVDT.SCX
  *!*************************************************************
  *! Parameters:  The FormSet of APPYINV.SCX, The Form of APINVDT.SCX, lnSize : Style Size Number
  *!*************************************************************
  *! Returns   :  None
  *!*************************************************************
FUNCTION lfvInvQty
  LPARAMETERS loFormSet, loForm, lnSize
  PRIVATE lcSize

  IF !BETWEEN(lnSize,1,8)
    RETURN
  ENDIF

  lcSize = STR(lnSize,1)
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	IF loForm.loRec.nAPQty&lcSize <> nAPQty&lcSize
  *!*	  loForm.loRec.nAPAprQty&lcSize = IIF(loForm.llDefAuApr,loForm.loRec.nAPQty&lcSize,loForm.loRec.nAPAprQty&lcSize)
  *!*	  loForm.loRec.nAPAprQty&lcSize = IIF(lfChkAplTkt(loFormSet,loForm,lcSize),loForm.loRec.nAPAprQty&lcSize,nAPAprQty&lcSize)
  *!*	  loForm.loRec.nApTAprQty= loForm.loRec.nAPAprQty1+loForm.loRec.nAPAprQty2+loForm.loRec.nAPAprQty3+;
  *!*	     loForm.loRec.nAPAprQty4+loForm.loRec.nAPAprQty5+loForm.loRec.nAPAprQty6+;
  *!*	     loForm.loRec.nAPAprQty7+loForm.loRec.nAPAprQty8
  *!*	  loForm.loRec.nAPTotQty = loForm.loRec.nAPQty1+loForm.loRec.nAPQty2+loForm.loRec.nAPQty3+;
  *!*	     loForm.loRec.nAPQty4+loForm.loRec.nAPQty5+loForm.loRec.nAPQty6+loForm.loRec.nAPQty7+;
  *!*	     loForm.loRec.nAPQty8

  *!*	  loForm.loRec.nApAmnt   = loForm.loRec.nAPTotQty*loForm.loRec.nAPPrice
  *!*	  loForm.loRec.nAPAprAmnt= loForm.loRec.nApTAprQty*loForm.loRec.nAPAprPric
  *!*	  loFormSet.lnTInvAmt = loFormSet.lnTInvAmt + (ROUND(loForm.loRec.nApAmnt,2)- ROUND(nAPAMnt,2))
  *!*	  loFormSet.lnTAprAmt = loFormSet.lnTAprAmt + (ROUND(loForm.loRec.nAPAprAmnt,2)- ROUND(nApAprAmnt,2))
  SELECT (loFormSet.lcAPvInvDt)
  IF loFormSet.loRec.nAPQty&lcSize <> nAPQty&lcSize
    loFormSet.loRec.nAPAprQty&lcSize = IIF(loForm.llDefAuApr,loFormSet.loRec.nAPQty&lcSize,loFormSet.loRec.nAPAprQty&lcSize)
    loFormSet.loRec.nAPAprQty&lcSize = IIF(lfChkAplTkt(loFormSet,loForm,lcSize),loFormSet.loRec.nAPAprQty&lcSize,nAPAprQty&lcSize)
    loFormSet.loRec.nApTAprQty= loFormSet.loRec.nAPAprQty1+loFormSet.loRec.nAPAprQty2+loFormSet.loRec.nAPAprQty3+;
      loFormSet.loRec.nAPAprQty4+loFormSet.loRec.nAPAprQty5+loFormSet.loRec.nAPAprQty6+;
      loFormSet.loRec.nAPAprQty7+loFormSet.loRec.nAPAprQty8
    loFormSet.loRec.nAPTotQty = loFormSet.loRec.nAPQty1+loFormSet.loRec.nAPQty2+loFormSet.loRec.nAPQty3+;
      loFormSet.loRec.nAPQty4+loFormSet.loRec.nAPQty5+loFormSet.loRec.nAPQty6+loFormSet.loRec.nAPQty7+;
      loFormSet.loRec.nAPQty8

    loFormSet.loRec.nApAmnt   = loFormSet.loRec.nAPTotQty*loFormSet.loRec.nAPPrice
    loFormSet.loRec.nAPAprAmnt= loFormSet.loRec.nApTAprQty*loFormSet.loRec.nAPAprPric
    loFormSet.lnTInvAmt = loFormSet.lnTInvAmt + (ROUND(loFormSet.loRec.nApAmnt,2)- ROUND(nAPAMnt,2))
    loFormSet.lnTAprAmt = loFormSet.lnTAprAmt + (ROUND(loFormSet.loRec.nAPAprAmnt,2)- ROUND(nApAprAmnt,2))
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    *=lfRefresh('APINVD10')

    PRIVATE lnDiffAmnt
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *!*	  lnDiffAmnt =  (ROUND(loForm.loRec.nApAmnt,2) - ROUND(nAPAMnt,2)) * IIF((loForm.loRec.cIMTyp $ 'RF'),IIF(loFormSet.llDebitM,1,1),IIF(loFormSet.llDebitM,-1,1))
    *!*	  =lfUpdApDist(loFormSet,loForm,cApVILNo,lnDiffAmnt,cApDGlAct,loForm.loRec.cIMTyp)
    lnDiffAmnt =  (ROUND(loFormSet.loRec.nApAmnt,2) - ROUND(nAPAMnt,2)) * IIF((loFormSet.loRec.cIMTyp $ 'RF'),IIF(loFormSet.llDebitM,1,1),IIF(loFormSet.llDebitM,-1,1))
    =lfUpdApDist(loFormSet,loForm,cApVILNo,lnDiffAmnt,cApDGlAct,loFormSet.loRec.cIMTyp)
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    =IIF(loForm.llDefAuApr,lfUpdAplTkt(loFormSet, loForm),.T.)
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *!*	  REPLACE nAPQty&lcSize    WITH loForm.loRec.nAPQty&lcSize  ,;
    *!*	          nAPAprQty&lcSize WITH loForm.loRec.nAPAprQty&lcSize ,;
    *!*	          nAPTotQty  WITH loForm.loRec.nAPTotQty  ,;
    *!*	          nApTAprQty WITH loForm.loRec.nApTAprQty ,;
    *!*	          nApAmnt    WITH loForm.loRec.nApAmnt    ,;
    *!*	          nAPAprAmnt WITH loForm.loRec.nAPAprAmnt ,;
    *!*	          cStatus   WITH IIF(cStatus='S','M',cStatus)
    REPLACE nAPQty&lcSize    WITH loFormSet.loRec.nAPQty&lcSize  ,;
      nAPAprQty&lcSize WITH loFormSet.loRec.nAPAprQty&lcSize ,;
      nAPTotQty  WITH loFormSet.loRec.nAPTotQty  ,;
      nApTAprQty WITH loFormSet.loRec.nApTAprQty ,;
      nApAmnt    WITH loFormSet.loRec.nApAmnt    ,;
      nAPAprAmnt WITH loFormSet.loRec.nAPAprAmnt ,;
      cStatus   WITH IIF(cStatus='S','M',cStatus)
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    *Change this line because we are going to switch between 2 Get
    *          Fields for the "Invoice Quantity" to be able to add the
    *          decimal points to the "Invoice Quantity" in the case of
    *          document types Material PO, Material PO Return and
    *          Material MFG Order [Begin]
    *SHOW GET loForm.loRec.nAPTotQty  DISABLE
    loForm.txtAPTotQty.ENABLED = .F.
    *SHOW OBJECT loFormSet.lnQtyObj DISABLE
    *Change this line because we are going to switch between 2 [End]

    *Old: SHOW GET loForm.loRec.nApAmnt    ENABLE &&Revise
    loForm.txtApAmnt.ENABLED = .T.

    *Change this line because we are going to switch between 2 Get
    *          Fields for the "Approve Quantity" to be able to add the
    *          decimal points to the "Approve Quantity" in the case of
    *          document types Material PO, Material PO Return and
    *          Material MFG Order [Begin]
    *SHOW GET loForm.loRec.nApTAprQty DISABLE
    loForm.txtApTAprQty.ENABLED = .F.
    *SHOW OBJECT loFormSet.lnApQtyObj DISABLE
    *Change this line because we are going to switch between 2 [End]

    IF loForm.llDefEdApr
      *Old: SHOW GET m.nAPAprQty&lcSize ENABLE &&Revise
      loForm.cntAPApr_Qty.txtqty&lcsize..ENABLED = .T.
      *Old: SHOW GET loForm.loRec.nAPAprAmnt ENABLE &&Revise
      loForm.txtAPAprAmnt.ENABLED = .T.
    ELSE
      *Old: SHOW GET m.nAPAprQty&lcSize DISABLE &&Revise
      loForm.cntAPApr_Qty.txtqty&lcsize..ENABLED = .F.
      *Old: SHOW GET loForm.loRec.nAPAprAmnt DISABLE &&Revise
      loForm.txtAPAprAmnt.ENABLED = .F.
    ENDIF
    *SHOW WINDOW (lcInvDtBr) REFRESH SAME
  ENDIF
  loForm.REFRESH()

  RETURN
  *-- End of lfvInvQty


  *!*************************************************************
  *! Name      : lfvAprQty
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 09/02/2004
  *! Purpose   : Validate Invoice Approved Size Quantity (cntAPApr_Qty) in APINVDT.SCX
  *!*************************************************************
  *! Parameters:  The FormSet of APPYINV.SCX, The Form of APINVDT.SCX, lnSize : Style Size Number
  *!*************************************************************
  *! Returns   :  None
  *!*************************************************************
FUNCTION lfvAprQty
  LPARAMETERS loFormSet, loForm, lnSize
  PRIVATE lcSize

  IF !BETWEEN(lnSize,1,8)
    RETURN
  ENDIF

  lcSize = STR(lnSize,1)
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	loForm.loRec.nAPAprQty&lcSize = IIF(lfChkAplTkt(loFormSet,loForm,lcSize),loForm.loRec.nAPAprQty&lcSize,nAPAprQty&lcSize)
  *!*	IF loForm.loRec.nAPAprQty&lcSize <> nAPAprQty&lcSize
  *!*	  loForm.loRec.nApTAprQty = loForm.loRec.nAPAprQty1+loForm.loRec.nAPAprQty2+;
  *!*	    loForm.loRec.nAPAprQty3+loForm.loRec.nAPAprQty4+loForm.loRec.nAPAprQty5+;
  *!*	    loForm.loRec.nAPAprQty6+loForm.loRec.nAPAprQty7+loForm.loRec.nAPAprQty8
  *!*	  loForm.loRec.nAPAprAmnt = loForm.loRec.nApTAprQty*loForm.loRec.nAPAprPric
  *!*	  loFormSet.lnTAprAmt = loFormSet.lnTAprAmt  + (ROUND(loForm.loRec.nAPAprAmnt,2)- ROUND(nApAprAmnt,2))*IIF(loForm.loRec.cIMTyp $ 'RF',-1,1)
  loFormSet.loRec.nAPAprQty&lcSize = IIF(lfChkAplTkt(loFormSet,loForm,lcSize),loFormSet.loRec.nAPAprQty&lcSize,nAPAprQty&lcSize)
  IF loFormSet.loRec.nAPAprQty&lcSize <> nAPAprQty&lcSize
    loFormSet.loRec.nApTAprQty = loFormSet.loRec.nAPAprQty1+loFormSet.loRec.nAPAprQty2+;
      loFormSet.loRec.nAPAprQty3+loFormSet.loRec.nAPAprQty4+loFormSet.loRec.nAPAprQty5+;
      loFormSet.loRec.nAPAprQty6+loFormSet.loRec.nAPAprQty7+loFormSet.loRec.nAPAprQty8
    loFormSet.loRec.nAPAprAmnt = loFormSet.loRec.nApTAprQty*loFormSet.loRec.nAPAprPric
    loFormSet.lnTAprAmt = loFormSet.lnTAprAmt  + (ROUND(loFormSet.loRec.nAPAprAmnt,2)- ROUND(nApAprAmnt,2))*IIF(loFormSet.loRec.cIMTyp $ 'RF',-1,1)
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    *=lfRefresh('APINVD10')
    =lfUpdAplTkt(loFormSet, loForm)
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *!*	  REPLACE nAPAprQty&lcSize WITH loForm.loRec.nAPAprQty&lcSize ,;
    *!*	          nApTAprQty WITH loForm.loRec.nApTAprQty ,;
    *!*	          nAPAprAmnt WITH loForm.loRec.nAPAprAmnt ,;
    *!*	          cStatus   WITH IIF(cStatus='S','M',cStatus)
    REPLACE nAPAprQty&lcSize WITH loFormSet.loRec.nAPAprQty&lcSize ,;
      nApTAprQty WITH loFormSet.loRec.nApTAprQty ,;
      nAPAprAmnt WITH loFormSet.loRec.nAPAprAmnt ,;
      cStatus   WITH IIF(cStatus='S','M',cStatus)
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    *Change this line because we are going to switch between 2 Get
    *          Fields for the "Approve Quantity" to be able to add the
    *          decimal points to the "Approve Quantity" in the case of
    *          document types Material PO, Material PO Return and
    *          Material MFG Order [Begin]
    *SHOW GET loForm.loRec.nApTAprQty DISABLE
    loForm.txtApTAprQty.ENABLED = .F.
    *SHOW OBJECT loFormSet.lnApQtyObj DISABLE
    *Change this line because we are going to switch between 2 [End]

    *Old: SHOW GET loForm.loRec.nAPAprAmnt ENABLE &&Revise
    loForm.txtAPAprAmnt.ENABLED = .T.
    *SHOW WINDOW (lcInvDtBr) REFRESH SAME
  ENDIF
  loForm.REFRESH()

  RETURN
  *-- End of lfvAprQty


  *!*************************************************************
  *! Name      : lfvWipAcnt
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 09/02/2004
  *! Purpose   : Validate GL Account
  *!*************************************************************
  *! Parameters:  The FormSet of APPYINV.SCX, The Form of APINVDT.SCX
  *!*************************************************************
  *! Returns   :  None
  *!*************************************************************
FUNCTION lfvWipAcnt
  LPARAMETERS loFormSet, loForm

  loFormSet.llBrowse = loForm.glApDGlAct.SelectedFromBrowse

  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	IF EMPTY(STRTRAN(STRTRAN(loForm.loRec.cApDGlAct,'-'),'0'))
  *!*	  loForm.loRec.cApDGlAct = cApDGlAct
  IF EMPTY(STRTRAN(STRTRAN(loFormSet.loRec.cApDGlAct,'-'),'0'))
    loFormSet.loRec.cApDGlAct = cApDGlAct
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  ENDIF
  loFormSet.llBrowse=.F.
  loForm.glApDGlAct.SelectedFromBrowse = .F.

  SELECT (loFormSet.lcAPvInvDt)
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	IF cApDGlAct <> loForm.loRec.cApDGlAct
  *!*	  =lfUpdApDist(loFormSet,loForm,cApVILNo,0,loForm.loRec.cApDGlAct,loForm.loRec.cIMTyp)
  *!*	  REPLACE cApDGlAct WITH loForm.loRec.cApDGlAct ,;
  *!*	          cStatus   WITH IIF(cStatus='S','M',cStatus)
  IF cApDGlAct <> loFormSet.loRec.cApDGlAct
    =lfUpdApDist(loFormSet,loForm,cApVILNo,0,loFormSet.loRec.cApDGlAct,loFormSet.loRec.cIMTyp)
    REPLACE cApDGlAct WITH loFormSet.loRec.cApDGlAct ,;
      cStatus   WITH IIF(cStatus='S','M',cStatus)
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  ENDIF
  *Update InvoiceTkt with GL account and Dist. line [Start]
  =IIF(loForm.llDefAuApr,lfUpdAplTkt(loFormSet, loForm),.T.)
  *Update InvoiceTkt with GL account and Dist. line [End]

  SELECT (loFormSet.lcAPvInvDt)
  loForm.REFRESH()

  RETURN
  *-- End of lfvWipAcnt


  *!*************************************************************
  *! Name      : lfvRInvLine
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 09/02/2004
  *! Purpose   : Remove Invoice Line
  *!*************************************************************
  *! Parameters:  The FormSet of APPYINV.SCX, The Form of APINVDT.SCX
  *!*************************************************************
  *! Returns   :  None
  *!*************************************************************
FUNCTION lfvRInvLine
  LPARAMETERS loFormSet, loForm

  IF gfModalGen("QRM00007B00007","ALERT") = 1
    loFormSet.lnTInvAmt = loFormSet.lnTInvAmt - ROUND(EVALUATE(loFormSet.lcapvinvdt+'.nApAmnt'),2)
    loFormSet.lnTAprAmt = loFormSet.lnTAprAmt - ROUND(EVALUATE(loFormSet.lcapvinvdt+'.nApAprAmnt'),2)

    IF SEEK(EVALUATE(loFormSet.lcAPvInvDt+'.cVendCode')+EVALUATE(loFormSet.lcAPvInvDt+'.cApInvNo')+;
        EVALUATE(loFormSet.lcAPvInvDt+'.cAPVILNo'),loFormSet.lcAPInvTkt)

      SELECT (loFormSet.lcAPInvTkt)
      SCAN REST WHILE cVendCode+cApInvNo+cAPVILNo = ;
          EVALUATE(loFormSet.lcAPvInvDt+'.cVendCode')+EVALUATE(loFormSet.lcAPvInvDt+'.cApInvNo')+;
          EVALUATE(loFormSet.lcAPvInvDt+'.cAPVILNo')
        REPLACE CSTATUS WITH IIF(!EMPTY(nrecno),'D','S')
        DELETE
      ENDSCAN
    ENDIF
    PRIVATE lnAmAmunt
    lnAmAmunt = ROUND(EVALUATE(loFormSet.lcAPvInvDt+'.nAPAMnt'),2) * IIF(loFormSet.llDebitM ,1,-1) * ;
      IIF(EVALUATE(loFormSet.lcAPvInvDt+'.CIMTYP') $ 'RF' AND loFormSet.llDebitM,-1,1)
    =lfUpdApDist(loFormSet,loForm,EVALUATE(loFormSet.lcAPvInvDt+'.cApVILNo'),lnAmAmunt,;
      EVALUATE(loFormSet.lcAPvInvDt+'.cApDGlAct'),EVALUATE(loFormSet.lcAPvInvDt+'.cIMTyp'))

    SELECT (loFormSet.lcAPvInvDt)
    REPLACE CSTATUS WITH IIF(CSTATUS='A','S','D')
    DELETE
    SKIP
    IF EOF()
      *Old: SHOW GET pbRemLine DISABLE &&Revise
      loForm.cmdRemove.ENABLED = .F.
      GO TOP
    ENDIF
    lfgrdInvDtAfterRowCol(loFormSet,loForm)
    *=lfRefresh('APINVD10')
  ENDIF
  loForm.REFRESH()

  RETURN
  *-- End of lfvRInvLine


  *!*************************************************************
  *! Name      : lfGetMaxLin
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 09/02/2004
  *! Purpose   : Get the maximum line no from invoicetkt and update LaData[52]
  *!*************************************************************
  *! Parameters:  The FormSet of APPYINV.SCX, The Form of APINVDT.SCX
  *!*************************************************************
  *! Returns   :  None
  *!*************************************************************
FUNCTION lfGetMaxLin
  LPARAMETERS loFormSet, loForm
  *! B129626,1 ASM 04/24/2005 AP Invoice Error message if line with zero exists [Start]
  LOCAL ARRAY laMaxDistLn[1]
  *! B129626,1 ASM 04/24/2005 AP Invoice Error message if line with zero exists [End]

  PRIVATE lcSumStr, lcSumKey , lnDistLnNo  , lnRecNo , lnGenType , lcArea

  lcArea = SELECT()
  lnDistLnNo = 0
  lnGenType  = 0
  lcSumKey = "cVendCode+cApInvNo"
  lcSumStr = ALLTRIM(loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE) +ALLTRIM(loFormSet.AriaForm1.kbInvNo.KeyTextBox.VALUE)

  SET DELETE OFF
  *! B129626,1 ASM 04/24/2005 AP Invoice Error message if line with zero exists [Start]
  laMaxDistLn = .F.
  *! B129626,1 ASM 04/24/2005 AP Invoice Error message if line with zero exists [End]
  SELECT MAX(VAL(cApdLinNo)) FROM (loFormSet.lcAPInvTkt) WHERE ALLTRIM(cVendCode)+ALLTRIM(cApInvNo) = lcSumStr  ;
    INTO ARRAY laMaxDistLn
  SET DELETE ON

  IF _TALLY <> 0  AND laMaxDistLn[1] > 0
    lnDistLnNo = laMaxDistLn[1]
  ENDIF

  SELECT (loFormSet.lcAPvInvDt)
  lnRecNo = RECNO()
  *! B129626,1 ASM 04/24/2005 AP Invoice Error message if line with zero exists [Start]
  SET DELETE OFF
  *! B129626,1 ASM 04/24/2005 AP Invoice Error message if line with zero exists [End]
  COUNT TO lnGenType FOR cImTyp = 'G'
  *! B129626,1 ASM 04/24/2005 AP Invoice Error message if line with zero exists [Start]
  SET DELETE ON
  *! B129626,1 ASM 04/24/2005 AP Invoice Error message if line with zero exists [End]
  IF BETWEEN (lnRecNo , 1 , RECCOUNT())
    GOTO lnRecNo
  ENDIF

  SELECT (lcArea)
  RETURN lnDistLnNo + lnGenType
  *-- End of lfGetMaxLin


  *!*************************************************************
  *! Name      : lfUpdApDist
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 09/02/2004
  *! Purpose   : Update AP Distribution
  *!*************************************************************
  *! Parameters:  The FormSet of APPYINV.SCX, The Form of APINVDT.SCX
  *!                       lcInvLineNo : Invoice Line#
  *!                       lnAmount    : Amount
  *!                       lcGlAccount : Gl Account
  *!                       llRemvLine  : .T., Remove the line.
  *!                                     Otherwise, Add or Edit the line.
  *!*************************************************************
  *! Returns   :  None
  *!*************************************************************
FUNCTION lfUpdApDist
  LPARAMETERS loFormSet, loForm, lcInvLineNo, lnAmount, lcGlAccount, lcType
  *!*	ACTIVATE WINDOW trace
  *!*	susp
  PRIVATE lnAlias
  lnAlias = SELECT()
  PRIVATE lnOApdAmnt
  lnOApdAmnt  = 0

  lnAmount = lnAmount * IIF(loFormSet.llDebitM AND !(lcType $ 'RF') ,-1,1)

  SELECT (loFormSet.lcTmpDist)
  IF !SEEK(PADR(loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE,8)+PADR(loFormSet.AriaForm1.kbInvNo.KeyTextBox.VALUE,12)+STR(0,4))
    APPEND BLANK
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *!*	  REPLACE CVENDCODE WITH loFormSet.AriaForm1.KBVendCode.KeyTextBox.Value  ,;
    *!*	          CINVNO    WITH loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value  ,;
    *!*	          DAPDTRDAT WITH loFormSet.AriaForm1.DtPostDate.Value ,;
    *!*	          LAPDPOST  WITH .F.        ,;
    *!*	          CAPDGLACT WITH loFormSet.DistLines.glAPActCode.KeyTextBox.Value ,;
    *!*	          CAPDACTID WITH 'A'        ,;
    *!*	          CAPDREF   WITH loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value  ,;
    *!*	          CFISFYEAR WITH loFormSet.lcDistYer  ,;
    *!*	          CFSPPRDID WITH loFormSet.lcDistPrd  ,;
    *!*	          CAPSESSNO WITH loFormSet.lcSequence ,;
    *!*	          CAPDTRTYP WITH 'I'        ,;
    *!*	          CSTATUS   WITH 'A'        ,;
    *!*	          CCURRCODE WITH loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value ,;
    *!*	          NEXRATE   WITH loFormSet.AriaForm1.txtNexRate.Value ,;
    *!*	          NCURRUNIT WITH apinvhdr.ncurrunit ,;
    *!*	          NAPDAMNT WITH -loFormSet.AriaForm1.txtInvAmount.Value
    *!*	  lcTemp = '-loFormSet.AriaForm1.txtInvAmount.Value'+loFormSet.lcExSin1+;
    *!*	     'loFormSet.AriaForm1.txtNexRate.Value'+loFormSet.lcExSin2+'apinvhdr.ncurrunit'
    REPLACE CVENDCODE WITH loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE  ,;
      CINVNO    WITH loFormSet.AriaForm1.kbInvNo.KeyTextBox.VALUE  ,;
      DAPDTRDAT WITH loFormSet.AriaForm1.DtPostDate.VALUE ,;
      LAPDPOST  WITH .F.        ,;
      CAPDGLACT WITH loFormSet.AriaForm1.pgfpayInv.pgDist.glAPActCode.KeyTextBox.VALUE ,;
      CAPDACTID WITH 'A'        ,;
      CAPDREF   WITH loFormSet.AriaForm1.kbInvNo.KeyTextBox.VALUE  ,;
      CFISFYEAR WITH loFormSet.lcDistYer  ,;
      CFSPPRDID WITH loFormSet.lcDistPrd  ,;
      CAPSESSNO WITH loFormSet.lcSequence ,;
      CAPDTRTYP WITH 'I'        ,;
      CSTATUS   WITH 'A'        ,;
      CCURRCODE WITH loFormSet.AriaForm1.pgfpayInv.pgHead.kbCurrCode.KeyTextBox.VALUE ,;
      NEXRATE   WITH loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.VALUE ,;
      NCURRUNIT WITH apinvhdr.ncurrunit ,;
      NAPDAMNT WITH -loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.VALUE
    lcTemp = '-loFormSet.AriaForm1.pgfpayInv.pgHead.txtInvAmount.Value'+loFormSet.lcExSin1+;
      'loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.Value'+loFormSet.lcExSin2+'apinvhdr.ncurrunit'
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    REPLACE NEQVAMNT WITH EVALUATE(lcTemp)
  ENDIF
  IF !SEEK(PADR(loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE,8)+PADR(loFormSet.AriaForm1.kbInvNo.KeyTextBox.VALUE,12)+lcInvLineNo)
    *  IF lnAmount <> 0

    APPEND BLANK
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *!*	    REPLACE CVENDCODE WITH loFormSet.AriaForm1.KBVendCode.KeyTextBox.Value  ,;
    *!*	            CINVNO    WITH loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value  ,;
    *!*	            DAPDTRDAT WITH loFormSet.AriaForm1.DtPostDate.Value ,;
    *!*	            LAPDPOST  WITH .F.        ,;
    *!*	            CAPDACTID WITH 'D'        ,;
    *!*	            CAPDREF   WITH loFormSet.AriaForm1.kbInvNo.KeyTextBox.Value  ,;
    *!*	            CFISFYEAR WITH loFormSet.lcDistYer  ,;
    *!*	            CFSPPRDID WITH loFormSet.lcDistPrd  ,;
    *!*	            CAPSESSNO WITH loFormSet.lcSequence ,;
    *!*	            CAPDTRTYP WITH 'I'        ,;
    *!*	            CSTATUS   WITH 'A'        ,;
    *!*	            NAPDLINNO WITH VAL(lcInvLineNo) ,;
    *!*	            CCURRCODE WITH loFormSet.AriaForm1.kbCurrCode.KeyTextBox.Value ,;
    *!*	            NEXRATE   WITH loFormSet.AriaForm1.txtNexRate.Value ,;
    *!*	            NCURRUNIT WITH apinvhdr.ncurrunit ,;
    *!*	            CAPDGLACT WITH lcGlAccount,;
    *!*	            NAPDAMNT  WITH lnAmount
    *!*	    lcTemp = 'lnAmount'+loFormSet.lcExSin1+'loFormSet.AriaForm1.txtNexRate.Value'+;
    *!*	       loFormSet.lcExSin2+'apinvhdr.ncurrunit'
    *    REPLACE NEQVAMNT  WITH EVALUATE(lcTemp), ;
    CTAXCODE  WITH IIF(ApVendor.cTaxType<>'T',;
    IIF(loForm.laTktType[loForm.cboTktType.Value,2]='G' AND !loFormSet.llAutoScr,loFormSet.laTaxCode[loFormSet.lnTaxCode,2],''),'')
    REPLACE CVENDCODE WITH loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE  ,;
      CINVNO    WITH loFormSet.AriaForm1.kbInvNo.KeyTextBox.VALUE  ,;
      DAPDTRDAT WITH loFormSet.AriaForm1.DtPostDate.VALUE ,;
      LAPDPOST  WITH .F.        ,;
      CAPDACTID WITH 'D'        ,;
      CAPDREF   WITH loFormSet.AriaForm1.kbInvNo.KeyTextBox.VALUE  ,;
      CFISFYEAR WITH loFormSet.lcDistYer  ,;
      CFSPPRDID WITH loFormSet.lcDistPrd  ,;
      CAPSESSNO WITH loFormSet.lcSequence ,;
      CAPDTRTYP WITH 'I'        ,;
      CSTATUS   WITH 'A'        ,;
      NAPDLINNO WITH VAL(lcInvLineNo) ,;
      CCURRCODE WITH loFormSet.AriaForm1.pgfpayInv.pgHead.kbCurrCode.KeyTextBox.VALUE ,;
      NEXRATE   WITH loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.VALUE ,;
      NCURRUNIT WITH apinvhdr.ncurrunit ,;
      CAPDGLACT WITH lcGlAccount,;
      NAPDAMNT  WITH lnAmount
    lcTemp = 'lnAmount'+loFormSet.lcExSin1+'loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.Value'+;
      loFormSet.lcExSin2+'apinvhdr.ncurrunit'

    REPLACE NEQVAMNT  WITH EVALUATE(lcTemp), ;
      CTAXCODE  WITH IIF(ApVendor.cTaxType<>'T',;
      IIF(loFormset.laTktType[loForm.cboTktType.Value,2]='G' AND !loFormSet.llAutoScr,loFormSet.laTaxCode[loFormSet.lnTaxCode,2],''),'')
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    *  ENDIF

  ELSE
    LOCATE REST WHILE cVendCode+cInvNo+STR(nApDLinNo,4) = ;
      PADR(loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE,8)+PADR(loFormSet.AriaForm1.kbInvNo.KeyTextBox.VALUE,12)+lcInvLineNo FOR CAPDSTAT <> 'V'
    lnOApdAmnt = nApdAmnt

    IF cStatus = 'A'
      REPLACE CAPDGLACT WITH lcGlAccount,;
        NAPDAMNT  WITH NAPDAMNT + lnAmount
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *!*	    lcTemp = 'lnAmount'+loFormSet.lcExSin1+'loFormSet.AriaForm1.txtNexRate.Value'+;
      *!*	      loFormSet.lcExSin2+'apinvhdr.ncurrunit'
      *!*	    REPLACE NEQVAMNT  WITH NEQVAMNT + EVALUATE(lcTemp),;
      *!*	            CTAXCODE  WITH IIF(ApVendor.cTaxType<>'T',;
      *!*	            IIF(loForm.laTktType[loForm.cboTktType.Value,2]='G' AND !loFormSet.llAutoScr,loFormSet.laTaxCode[loFormSet.lnTaxCode,2],''),'')
      lcTemp = 'lnAmount'+loFormSet.lcExSin1+'loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.Value'+;
        loFormSet.lcExSin2+'apinvhdr.ncurrunit'
      REPLACE NEQVAMNT  WITH NEQVAMNT + EVALUATE(lcTemp),;
        CTAXCODE  WITH IIF(ApVendor.cTaxType<>'T',;
        IIF(loFormSet.laTktType[loForm.cboTktType.Value,2]='G' AND !loFormSet.llAutoScr,loFormSet.laTaxCode[loFormSet.lnTaxCode,2],''),'')
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[END]
      IF NAPDAMNT=0
        REPLACE cStatus WITH 'S'
        DELETE
      ENDIF
    ELSE
      *Void Modified Line
      REPLACE CAPDSTAT  WITH 'V' ,;
        CSTATUS   WITH 'M' ,;
        CAPSESSNO WITH loFormSet.lcSequence
      SCATTER MEMVAR MEMO
      m.cStatus   = 'A'
      m.cBatchNo  = ' '
      m.cTrnSledn = ' '
      m.nEntryNo  = 0
      m.lAPDPost  = .F.
      m.nApdAmnt  = -1 * m.nApdAmnt
      m.nEqvAmnt  = -1 * m.nEqvAmnt
      APPEND BLANK
      GATHER MEMVAR MEMO

      *Add New Line
      m.cApDGlAct = lcGlAccount
      m.cApdStat  = ' '
      m.nApdAmnt  = -1 * m.nApdAmnt + lnAmount
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *!*	    lcTemp = 'lnAmount'+loFormSet.lcExSin1+'loFormSet.AriaForm1.txtNexRate.Value'+;
      *!*	     loFormSet.lcExSin2+'apinvhdr.ncurrunit'
      lcTemp = 'lnAmount'+loFormSet.lcExSin1+'loFormSet.AriaForm1.pgfpayInv.pgHead.txtNexRate.Value'+;
        loFormSet.lcExSin2+'apinvhdr.ncurrunit'
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      m.nEqvAmnt  = -1 * m.nEqvAmnt + EVALUATE(lcTemp)
      **! B608492,1 SSH Allow Zero amount.
      IF .T. &&m.nApdAmnt <> 0
        APPEND BLANK
        GATHER MEMVAR MEMO
      ELSE
        lnOApdAmnt = 0
      ENDIF
    ENDIF
  ENDIF
  loFormSet.lnDistAmnt = loFormSet.lnDistAmnt + nApdAmnt - lnOApdAmnt

  SELECT (lnAlias)

  RETURN
  *-- End of lfUpdApDist


  *!*************************************************************
  *! Name      : lfItemQty
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 09/02/2004
  *! Purpose   : Default Invoice line quantity and amount with ticket budget
  *!             quantity after deducting invoices applied to this ticket
  *!*************************************************************
  *! Parameters:  The FormSet of APPYINV.SCX, The Form of APINVDT.SCX,
  *!                       lcTktType  : Ticket Type
  *!                       lcTicketNo : Ticket#
  *!                       lcLotNo    : Lot#
  *!                       lcCostType : Cost Type
  *!                       lcMfgCode  : MFG Operation
  *!                       lcItem     : Item
  *!                       lcColor    : Color
  *!                       lcDyelot   : Dyelot
  *!*************************************************************
  *! Return     : None
  *!*************************************************************
FUNCTION lfItemQty
  LPARAMETERS loFormSet ,loForm ,lcTktType ,lcTicketNo ,lcLotNo ,lcCostType ,lcMfgCode ,;
    lcItem, lcColor, lcDyelot
  PRIVATE lcInvLineNo, lcBrFields

  lcInvLineNo = EVALUATE(loFormSet.lcAPvInvDt+'.cApVILNo')
  IF !lfGenInvLn(loFormSet,loForm,lcTktType,lcTicketNo,lcMfgCode,lcLotNo,SPACE(6),lcCostType,;
      lcItem,lcColor,lcDyelot)
    =lfGenInvLn(loFormSet,loForm,lcTktType,lcTicketNo,lcMfgCode,lcLotNo,SPACE(6),lcCostType,'','','')
    SELECT (loFormSet.lcAutoInv)
    lcBrFields = "nTktQty :H='Bud. Qty',nTktCst :H= 'Bud. Cost',nTktAmnt :H='Bud. Amnt',"
    lcBrFields = lcBrFields+"nInvQty :H='Inv. Qty.',nInvCst=IIF(nInvQty=0,0,nInvAmnt/nInvQty) :P='999999999.999' :H='Inv. Cost',nInvAmnt :H='Inv. Amnt.',"
    lcBrFields = lcBrFields+"nAplQty :H='Apl. Qty.',nAplCst=IIF(nAplQty =0,0,nAplAmnt/nAplQty ) :P='999999999.999' :H='Inv. Cost',nAplAmnt :H='Apl. Amnt.'"
    IF INLIST(lcTktType,'S','I','M','R','A','D')
      lcBrFields = "Item :H='"+loForm.cntStyle.lblItemHeader.CAPTION+"',"+;
        IIF(loFormSet.laSetups[1,2]='Y',"cDyelot :H='Dyelot',",'')+lcBrFields
    ELSE
      lcBrFields = "cItem=SUBSTR(Item,1,"+ALLTRIM(STR(loFormSet.lnFabMajLen))+") :H='Fabric',Color :H='Color',"+;
        IIF(loFormSet.laSetups[2,2]='Y',"cDyelot :H='Dyelot',",'')+lcBrFields
    ENDIF
    IF !ARIABROW('','Ticket Items',gnBrHSRow1,;
        gnBrHSCol1,gnBrHSRow2,gnBrHSCol2,'','','Item','laBrowArr')
      SELECT (loFormSet.lcAPvInvDt)
      =SEEK(PADR(loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE,8)+PADR(loFormSet.AriaForm1.kbInvNo.KeyTextBox.VALUE,12)+lcInvLineNo)
      RETURN(.F.)
    ENDIF
  ENDIF
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	STORE EVALUATE(loFormSet.lcAutoInv+'.Item')    TO lcItem, loForm.loRec.Item
  *!*	STORE EVALUATE(loFormSet.lcAutoInv+'.Color')   TO lcColor, loForm.loRec.Color
  *!*	STORE EVALUATE(loFormSet.lcAutoInv+'.cDyelot') TO lcDyelot, loForm.loRec.cDyelot
  STORE EVALUATE(loFormSet.lcAutoInv+'.Item')    TO lcItem, loFormSet.loRec.ITEM
  STORE EVALUATE(loFormSet.lcAutoInv+'.Color')   TO lcColor, loFormSet.loRec.COLOR
  STORE EVALUATE(loFormSet.lcAutoInv+'.cDyelot') TO lcDyelot, loFormSet.loRec.cDyelot
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  
  SELECT (loFormSet.lcAPvInvDt)
  =SEEK(PADR(loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE,8)+PADR(loFormSet.AriaForm1.kbInvNo.KeyTextBox.VALUE,12)+lcInvLineNo)
  IF lcItem+lcColor+lcDyelot = EVALUATE(loFormSet.lcAPvInvDt+'.Item')+;
      EVALUATE(loFormSet.lcAPvInvDt+'.Color')+EVALUATE(loFormSet.lcAPvInvDt+'.cDyelot')
    RETURN(.F.)
  ENDIF
  
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	STORE EVALUATE(loFormSet.lcAutoInv+'.nInvQty')  TO loForm.loRec.nAPTotQty
  *!*	STORE EVALUATE(loFormSet.lcAutoInv+'.nInvAmnt') TO loForm.loRec.nApAmnt
  *!*	STORE EVALUATE(loFormSet.lcAutoInv+'.LineNo')  TO loForm.loRec.LineNo
  *!*	STORE IIF(loForm.loRec.nAPTotQty=0,0,loForm.loRec.nApAmnt/loForm.loRec.nAPTotQty) TO ;
  *!*	   loForm.loRec.nAPPrice
  STORE EVALUATE(loFormSet.lcAutoInv+'.nInvQty')  TO loFormSet.loRec.nAPTotQty
  STORE EVALUATE(loFormSet.lcAutoInv+'.nInvAmnt') TO loFormSet.loRec.nApAmnt
  STORE EVALUATE(loFormSet.lcAutoInv+'.LineNo')  TO loFormSet.loRec.LINENO
  STORE IIF(loFormSet.loRec.nAPTotQty=0,0,loFormSet.loRec.nApAmnt/loFormSet.loRec.nAPTotQty) TO ;
    loFormSet.loRec.nAPPrice
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  IF INLIST(lcTktType,'I','S','M','R','A','D')
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *!*	  STORE EVALUATE(loFormSet.lcAutoInv+'.nInvQty1') TO loForm.loRec.nAPQty1
    *!*	  STORE EVALUATE(loFormSet.lcAutoInv+'.nInvQty2') TO loForm.loRec.nAPQty2
    *!*	  STORE EVALUATE(loFormSet.lcAutoInv+'.nInvQty3') TO loForm.loRec.nAPQty3
    *!*	  STORE EVALUATE(loFormSet.lcAutoInv+'.nInvQty4') TO loForm.loRec.nAPQty4
    *!*	  STORE EVALUATE(loFormSet.lcAutoInv+'.nInvQty5') TO loForm.loRec.nAPQty5
    *!*	  STORE EVALUATE(loFormSet.lcAutoInv+'.nInvQty6') TO loForm.loRec.nAPQty6
    *!*	  STORE EVALUATE(loFormSet.lcAutoInv+'.nInvQty7') TO loForm.loRec.nAPQty7
    *!*	  STORE EVALUATE(loFormSet.lcAutoInv+'.nInvQty8') TO loForm.loRec.nAPQty8
    STORE EVALUATE(loFormSet.lcAutoInv+'.nInvQty1') TO loFormSet.loRec.nAPQty1
    STORE EVALUATE(loFormSet.lcAutoInv+'.nInvQty2') TO loFormSet.loRec.nAPQty2
    STORE EVALUATE(loFormSet.lcAutoInv+'.nInvQty3') TO loFormSet.loRec.nAPQty3
    STORE EVALUATE(loFormSet.lcAutoInv+'.nInvQty4') TO loFormSet.loRec.nAPQty4
    STORE EVALUATE(loFormSet.lcAutoInv+'.nInvQty5') TO loFormSet.loRec.nAPQty5
    STORE EVALUATE(loFormSet.lcAutoInv+'.nInvQty6') TO loFormSet.loRec.nAPQty6
    STORE EVALUATE(loFormSet.lcAutoInv+'.nInvQty7') TO loFormSet.loRec.nAPQty7
    STORE EVALUATE(loFormSet.lcAutoInv+'.nInvQty8') TO loFormSet.loRec.nAPQty8
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  ENDIF
  IF loForm.llDefAuApr
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *!*	  STORE loForm.loRec.nAPTotQty TO loForm.loRec.nApTAprQty
    *!*	  STORE loForm.loRec.nAPPrice  TO loForm.loRec.nAPAprPric
    *!*	  STORE loForm.loRec.nApAmnt   TO loForm.loRec.nAPAprAmnt
    STORE loFormSet.loRec.nAPTotQty TO loFormSet.loRec.nApTAprQty
    STORE loFormSet.loRec.nAPPrice  TO loFormSet.loRec.nAPAprPric
    STORE loFormSet.loRec.nApAmnt   TO loFormSet.loRec.nAPAprAmnt
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    IF INLIST(lcTktType,'I','S','M','R','A','D')
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *!*	    STORE loForm.loRec.nAPQty1 TO loForm.loRec.nAPAprQty1
      *!*	    STORE loForm.loRec.nAPQty2 TO loForm.loRec.nAPAprQty2
      *!*	    STORE loForm.loRec.nAPQty3 TO loForm.loRec.nAPAprQty3
      *!*	    STORE loForm.loRec.nAPQty4 TO loForm.loRec.nAPAprQty4
      *!*	    STORE loForm.loRec.nAPQty5 TO loForm.loRec.nAPAprQty5
      *!*	    STORE loForm.loRec.nAPQty6 TO loForm.loRec.nAPAprQty6
      *!*	    STORE loForm.loRec.nAPQty7 TO loForm.loRec.nAPAprQty7
      *!*	    STORE loForm.loRec.nAPQty8 TO loForm.loRec.nAPAprQty8
      STORE loFormSet.loRec.nAPQty1 TO loFormSet.loRec.nAPAprQty1
      STORE loFormSet.loRec.nAPQty2 TO loFormSet.loRec.nAPAprQty2
      STORE loFormSet.loRec.nAPQty3 TO loFormSet.loRec.nAPAprQty3
      STORE loFormSet.loRec.nAPQty4 TO loFormSet.loRec.nAPAprQty4
      STORE loFormSet.loRec.nAPQty5 TO loFormSet.loRec.nAPAprQty5
      STORE loFormSet.loRec.nAPQty6 TO loFormSet.loRec.nAPAprQty6
      STORE loFormSet.loRec.nAPQty7 TO loFormSet.loRec.nAPAprQty7
      STORE loFormSet.loRec.nAPQty8 TO loFormSet.loRec.nAPAprQty8
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[end]
    ENDIF
  ENDIF
  *B607416,1 ALB Fix bug when Saving the debit memo againest Return PO [BEGIN]
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	loForm.loRec.nAPPrice   = loForm.loRec.nAPPrice   * IIF((loForm.loRec.cIMTyp $ 'RF') OR loFormSet.llDebitM ,-1,1)
  *!*	loForm.loRec.nApAmnt    = loForm.loRec.nApAmnt    * IIF((loForm.loRec.cIMTyp $ 'RF') OR loFormSet.llDebitM ,-1,1)
  *!*	loForm.loRec.nAPAprPric = loForm.loRec.nAPAprPric * IIF((loForm.loRec.cIMTyp $ 'RF') OR loFormSet.llDebitM ,-1,1)
  *!*	loForm.loRec.nAPAprAmnt = loForm.loRec.nAPAprAmnt * IIF((loForm.loRec.cIMTyp $ 'RF') OR loFormSet.llDebitM ,-1,1)
  *!*	loFormSet.lnTInvAmt = loFormSet.lnTInvAmt + (ROUND(loForm.loRec.nApAmnt,2)- ROUND(nAPAMnt,2))
  *!*	loFormSet.lnTAprAmt = loFormSet.lnTAprAmt + (ROUND(loForm.loRec.nAPAprAmnt,2)- ROUND(nApAprAmnt,2))
  loFormSet.loRec.nAPPrice   = loFormSet.loRec.nAPPrice   * IIF((loFormSet.loRec.cIMTyp $ 'RF') OR loFormSet.llDebitM ,-1,1)
  loFormSet.loRec.nApAmnt    = loFormSet.loRec.nApAmnt    * IIF((loFormSet.loRec.cIMTyp $ 'RF') OR loFormSet.llDebitM ,-1,1)
  loFormSet.loRec.nAPAprPric = loFormSet.loRec.nAPAprPric * IIF((loFormSet.loRec.cIMTyp $ 'RF') OR loFormSet.llDebitM ,-1,1)
  loFormSet.loRec.nAPAprAmnt = loFormSet.loRec.nAPAprAmnt * IIF((loFormSet.loRec.cIMTyp $ 'RF') OR loFormSet.llDebitM ,-1,1)
  loFormSet.lnTInvAmt = loFormSet.lnTInvAmt + (ROUND(loFormSet.loRec.nApAmnt,2)- ROUND(nAPAMnt,2))
  loFormSet.lnTAprAmt = loFormSet.lnTAprAmt + (ROUND(loFormSet.loRec.nAPAprAmnt,2)- ROUND(nApAprAmnt,2))
 *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[ENd]
  PRIVATE lnDiffAmnt
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	lnDiffAmnt =  (ROUND(loForm.loRec.nApAmnt,2) - ROUND(nAPAMnt,2)) * IIF((loForm.loRec.cIMTyp $ 'RF'),1,IIF(loFormSet.llDebitM,-1,1))
  lnDiffAmnt =  (ROUND(loFormSet.loRec.nApAmnt,2) - ROUND(nAPAMnt,2)) * IIF((loFormSet.loRec.cIMTyp $ 'RF'),1,IIF(loFormSet.llDebitM,-1,1))
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  =lfUpdApDist(loFormSet,loForm,cApVILNo,lnDiffAmnt,cApDGlAct,lcTktType)

  =lfUpdAplTkt(loFormSet, loForm)
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *GATHER NAME loForm.loRec
  GATHER NAME loFormSet.loRec
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[ENd]
  RETURN
  *-- End of lfItemQty


  *!*************************************************************
  *! Name      : lfUpdAplTkt
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 09/02/2004
  *! Purpose   : Update Ticket Applied Quantity & Amount
  *!*************************************************************
  *! Parameters:  The FormSet of APPYINV.SCX, The Form of APINVDT.SCX
  *!*************************************************************
  *! Returns   :  None
  *!*************************************************************
FUNCTION lfUpdAplTkt
  LPARAMETERS loFormSet, loForm

  PRIVATE lnAlias

  *?AMIN
  IF EMPTY(EVALUATE(loFormSet.lcAPvInvDt+'.cTktNo')) AND ;
      EMPTY(EVALUATE(loFormSet.lcAPvInvDt+'.ShipNo'))
    RETURN
  ENDIF

  PRIVATE lnCurAls,lcPInvLNo,laContTot, llUpdTktL
  lcPInvLNo = EVALUATE(loFormSet.lcAPvInvDt+'.cApVILNo')
  lnCurAls  = SELECT(0)
  SELECT COUNT(*),SUM(IIF(!EMPTY(cRsession),nApAplAmnt,0)) ;
    FROM (loFormSet.lcAPInvTkt)             ;
    WHERE cVendCode         + cApInvNo           + cApVILNo  + cRSession= ;
    PADR(loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE,8) + PADR(loFormSet.AriaForm1.kbInvNo.KeyTextBox.VALUE,12) + lcPInvLNo + ""  ;
    INTO ARRAY laContTot

  IF _TALLY <> 0 AND laContTot[1] = 1 AND ;
      SEEK(PADR(loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE,8)+;
      PADR(loFormSet.AriaForm1.kbInvNo.KeyTextBox.VALUE,12)+;
      EVALUATE(loFormSet.lcAPvInvDt+'.cApVILNo'),loFormSet.lcAPInvTkt) AND ;
      !EMPTY(EVALUATE(loFormSet.lcAPInvTkt+'.cRSession')) AND ;
      !(EVALUATE(loFormSet.lcAPInvTkt+'.nApAplAmnt') = 0 )
    llUpdTktL = .F.
  ELSE
    llUpdTktL = .T.
  ENDIF

  IF llUpdTktL
    lnAlias = SELECT()
    SELECT (loFormSet.lcAPInvTkt)

    *Add these lines to restore the old uncontributed record, if there
    *          is one.
    *          Note: we will restore the old record for 2 purposes.
    *          1 - To minimize the size of the file
    *          2 - To be able to add the uncontributed record from the
    *          "Contribution" screen easily by restoring the old one. [Begin]
    lcSetDelet = SET('DELETED')        && Save the SET DELETED status
    SET DELETED OFF
    *Add these lines to restore the old uncontributed record [End]

    IF !SEEK(PADR(loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE,8)+;
        PADR(loFormSet.AriaForm1.kbInvNo.KeyTextBox.VALUE,12)+;
        EVALUATE(loFormSet.lcAPvInvDt+'.cApVILNo')+SPACE(6))

      INSERT INTO (loFormSet.lcAPInvTkt) (cVendCode,cApInvNo,cApVILNo,cStatus,cIMTyp,cTktNo) VALUES  ;
        (loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE,;
        loFormSet.AriaForm1.kbInvNo.KeyTextBox.VALUE,;
        EVALUATE(loFormSet.lcAPvInvDt+'.cApVILNo'),'A',;
        EVALUATE(loFormSet.lcAPvInvDt+'.cIMTyp'),EVALUATE(loFormSet.lcAPvInvDt+'.cTktNo'))

      *Add the else condition to restore the old uncontributed record,
      *          if there is one.
      *          Note: we will restore the old record for 2 purposes.
      *          1 - To minimize the size of the file
      *          2 - To be able to add the uncontributed record from the
      *          "Contribution" screen easily by restoring the old one. [Begin]
    ELSE    && Else (if there is uncontribitued amount line)
      *-- if the uncontribitued amount line is deleted
      IF DELETED()
        RECALL        && Recall the deleted record
        REPLACE cStatus WITH IIF(nRecNo = 0 , 'A' , 'M')
      ENDIF    && End of IF DELETED()
      *Add the else condition to restore the old uncontributed [End]

    ENDIF

    *Add this line to restore the old uncontributed record, if there
    *          is one.
    *          Note: we will restore the old record for 2 purposes.
    *          1 - To minimize the size of the file
    *          2 - To be able to add the uncontributed record from the
    *          "Contribution" screen easily by restoring the old one. [Begin]
    SET DELETED &lcSetDelet        && Restore the old SET DELETED status
    *Add this lines to restore the old uncontributed record [End]

    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *!*	  REPLACE LineNo     WITH loForm.loRec.LineNo     ,;
    *!*	          Item       WITH loForm.loRec.Item       ,;
    *!*	          Color      WITH loForm.loRec.Color      ,;
    *!*	          cDyelot    WITH loForm.loRec.cDyelot    ,;
    *!*	          nApAplQty1 WITH nApAplQty1 - EVALUATE(loFormSet.lcAPvInvDt+'.nApAprQty1') + loForm.loRec.nApAprQty1 ,;
    *!*	          nApAplQty2 WITH nApAplQty2 - EVALUATE(loFormSet.lcAPvInvDt+'.nApAprQty2') + loForm.loRec.nApAprQty2 ,;
    *!*	          nApAplQty3 WITH nApAplQty3 - EVALUATE(loFormSet.lcAPvInvDt+'.nApAprQty3') + loForm.loRec.nApAprQty3 ,;
    *!*	          nApAplQty4 WITH nApAplQty4 - EVALUATE(loFormSet.lcAPvInvDt+'.nApAprQty4') + loForm.loRec.nApAprQty4 ,;
    *!*	          nApAplQty5 WITH nApAplQty5 - EVALUATE(loFormSet.lcAPvInvDt+'.nApAprQty5') + loForm.loRec.nApAprQty5 ,;
    *!*	          nApAplQty6 WITH nApAplQty6 - EVALUATE(loFormSet.lcAPvInvDt+'.nApAprQty6') + loForm.loRec.nApAprQty6 ,;
    *!*	          nApAplQty7 WITH nApAplQty7 - EVALUATE(loFormSet.lcAPvInvDt+'.nApAprQty7') + loForm.loRec.nApAprQty7 ,;
    *!*	          nApAplQty8 WITH nApAplQty8 - EVALUATE(loFormSet.lcAPvInvDt+'.nApAprQty8') + loForm.loRec.nApAprQty8 ,;
    *!*	          nApTAplQty WITH nApTAplQty - EVALUATE(loFormSet.lcAPvInvDt+'.nApTAprQty') + loForm.loRec.nApTAprQty ,;
    *!*	          nApAPlPric WITH loForm.loRec.nAPAprPric ,;
    *!*	          nApAplAmnt WITH nApAplAmnt - EVALUATE(loFormSet.lcAPvInvDt+'.nApApRAmnt') + loForm.loRec.nAPAprPric*loForm.loRec.nApTAprQty,;
    *!*	          cStatus    WITH IIF(cStatus='S','M',cStatus)
    REPLACE LINENO     WITH loFormSet.loRec.LINENO     ,;
      ITEM       WITH loFormSet.loRec.ITEM       ,;
      COLOR      WITH loFormSet.loRec.COLOR      ,;
      cDyelot    WITH loFormSet.loRec.cDyelot    ,;
      nApAplQty1 WITH nApAplQty1 - EVALUATE(loFormSet.lcAPvInvDt+'.nApAprQty1') + loFormSet.loRec.nApAprQty1 ,;
      nApAplQty2 WITH nApAplQty2 - EVALUATE(loFormSet.lcAPvInvDt+'.nApAprQty2') + loFormSet.loRec.nApAprQty2 ,;
      nApAplQty3 WITH nApAplQty3 - EVALUATE(loFormSet.lcAPvInvDt+'.nApAprQty3') + loFormSet.loRec.nApAprQty3 ,;
      nApAplQty4 WITH nApAplQty4 - EVALUATE(loFormSet.lcAPvInvDt+'.nApAprQty4') + loFormSet.loRec.nApAprQty4 ,;
      nApAplQty5 WITH nApAplQty5 - EVALUATE(loFormSet.lcAPvInvDt+'.nApAprQty5') + loFormSet.loRec.nApAprQty5 ,;
      nApAplQty6 WITH nApAplQty6 - EVALUATE(loFormSet.lcAPvInvDt+'.nApAprQty6') + loFormSet.loRec.nApAprQty6 ,;
      nApAplQty7 WITH nApAplQty7 - EVALUATE(loFormSet.lcAPvInvDt+'.nApAprQty7') + loFormSet.loRec.nApAprQty7 ,;
      nApAplQty8 WITH nApAplQty8 - EVALUATE(loFormSet.lcAPvInvDt+'.nApAprQty8') + loFormSet.loRec.nApAprQty8 ,;
      nApTAplQty WITH nApTAplQty - EVALUATE(loFormSet.lcAPvInvDt+'.nApTAprQty') + loFormSet.loRec.nApTAprQty ,;
      nApAPlPric WITH loFormSet.loRec.nAPAprPric ,;
      nApAplAmnt WITH nApAplAmnt - EVALUATE(loFormSet.lcAPvInvDt+'.nApApRAmnt') + loFormSet.loRec.nAPAprPric*loFormSet.loRec.nApTAprQty,;
      cStatus    WITH IIF(cStatus='S','M',cStatus)
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    *Amin Update the InvoiceTkt with the Gl account and the Dist. line [Start]
    REPLACE cApdGlAct  WITH EVALUATE(loFormSet.lcAPvInvDt+'.cApDGlAct') ,;
      cApdLinNo  WITH EVALUATE(loFormSet.lcAPvInvDt+'.cApVILNo')
    *Amin Update the InvoiceTkt with the Gl account and the Dist. line [End]

    *Add this line to delete the uncontributed record if the whole
    *          amount was contributed [Begin]
    IF nApAplAmnt = 0
      DELETE
      REPLACE cStatus WITH IIF(nRecNo = 0 , 'S' , 'D')
    ENDIF
    *Add this line to delete the uncontributed record [End]

    SELECT (lnAlias)
  ENDIF
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	IF ABS(loForm.loRec.nAPAprAmnt) > 0 AND ;
  *!*	   IIF(EVALUATE(loFormSet.lcAPvInvDt+'.cIMTyp') = 'S' , !EMPTY(EVALUATE(loFormSet.lcAPvInvDt+'.ShipNO')) ,;
  *!*	       !EMPTY(EVALUATE(loFormSet.lcAPvInvDt+'.cTktNo')))
  IF ABS(loFormSet.loRec.nAPAprAmnt) > 0 AND ;
      IIF(EVALUATE(loFormSet.lcAPvInvDt+'.cIMTyp') = 'S' , !EMPTY(EVALUATE(loFormSet.lcAPvInvDt+'.ShipNO')) ,;
      !EMPTY(EVALUATE(loFormSet.lcAPvInvDt+'.cTktNo')))
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    *Old: SHOW GET pbContrib ENABLE &&Revise
    loForm.cmdContribute.ENABLED = .T.
  ELSE
    *Old: SHOW GET pbContrib DISABLE &&Revise
    loForm.cmdContribute.ENABLED = .F.
  ENDIF

  RETURN
  *-- End of lfUpdAplTkt


  *:********************************************************************
  *: Name      : lfGetGlLnk
  *: Developer : Ahmad Shoukry Mohammed (ASM)
  *: Date      : 09/02/2004
  *: Purpose   : Return the Due Date
  *:********************************************************************
  *: Returns   : lcGl_Link
  *:********************************************************************
  *:B607278,1 ALB Get the correct WIP account with shipment ticket

FUNCTION lfGetGlLnk
  PARAMETER lcShipNo,lcStyleCode,lcReSess
  PRIVATE lcGl_Link

  LOCAL lcSqlStatement, lnResult, lcAlias
  lcAlias = ALIAS()
  *CBUSDOCU+CSTYTYPE+PO &&POSHDR
  *CBUSDOCU+CSTYTYPE+PO+CRSESSION+SHIPNO+CINVTYPE+STYLE+STR(LINENO,6)+TRANCD+CSTYGRADE &&POSREC
  lcSqlStatement = "SELECT POSHDR.LINK_CODE, POSLN.STYLE FROM POSHDR (INDEX=POSHDR), POSLN (INDEX=POSREC) WHERE "+;
    "POSHDR.CBUSDOCU='P' AND POSHDR.CSTYTYPE='P' AND "+;
    "POSLN.CBUSDOCU='P' AND POSLN.CSTYTYPE='P' AND POSHDR.PO=POSLN.PO AND "+;
    "POSLN.shipno='"+lcShipNo+"' AND CRSESSION='"+lcReSess+"'"
  lnResult=oAriaApplication.remotecompanydata.sqlrun(lcSqlStatement,'ShipCursor','',;
    oAriaApplication.ActiveCompanyConStr,3,'SAVE',SET("Datasession"))
  IF lnResult<1
    oAriaApplication.remotecompanydata.CheckRetResult("execute",lnResult,.T.)
    IF !EMPTY(lcAlias)
      SELECT (lcAlias)
    ENDIF
    *AIT WINDOW LINENO()
    RETURN .F.
  ENDIF


  STORE ' ' TO lcGl_Link

  SELECT LINK_CODE FROM ShipCursor ;
    WHERE IIF(EMPTY(lcStyleCode),.T.,STYLE= lcStyleCode) ;
    GROUP BY 1 INTO ARRAY laGl_Link &&Sql87: Must use SqlRun
  USE IN ShipCursor
  IF !EMPTY(lcAlias)
    SELECT (lcAlias)
  ENDIF

  IF _TALLY > 0
    lcGl_Link = laGl_Link[1,1]+ALLTRIM(STR(_TALLY))
  ENDIF
  RETURN lcGl_Link
  *-- End of lfGetGlLnk


  *!*************************************************************
  *! Name      : lfChkAplTkt
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 09/02/2004
  *! Purpose   : Check Approved Quantity/Amount againest Contributed Quantity/Amount
  *!*************************************************************
  *! Parameters: The FormSet of APPYINV.SCX, The Form of APINVDT.SCX, lcSize
  *!*************************************************************
  *! Returns   :  None
  *!*************************************************************
FUNCTION lfChkAplTkt
  LPARAMETERS loFormSet, loForm, lcSize

  PRIVATE lnCurAls,lcPInvLNo,laContTot
  lcPInvLNo = EVALUATE(loFormSet.lcAPvInvDt+'.cApVILNo')
  lnCurAls  = SELECT(0)
  SELECT COUNT(*),SUM(nApAplQty1),SUM(nApAplQty2),SUM(nApAplQty3),SUM(nApAplQty4),;
    SUM(nApAplQty5),SUM(nApAplQty6),SUM(nApAplQty7),SUM(nApAplQty8),;
    SUM(nApAplAmnt),SUM(IIF(!EMPTY(cRsession),nApAplAmnt,0)) ;
    FROM (loFormSet.lcAPInvTkt)             ;
    WHERE cVendCode         + cApInvNo           + cApVILNo  + cRSession= ;
    PADR(loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE,8) + PADR(loFormSet.AriaForm1.kbInvNo.KeyTextBox.VALUE,12) + lcPInvLNo + ""         ;
    INTO ARRAY laContTot

  *-- No Contribution
  IF _TALLY = 0 OR laContTot[11] = 0 OR ISNULL(laContTot[11])
    RETURN
  ENDIF
  SELECT (loFormSet.lcAPInvTkt)
  *-- If there is only one contributed line update the contribution generated
  *-- from the automatic option.
  IF laContTot[1] = 1 AND SEEK(PADR(loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE,8)+;
      PADR(loFormSet.AriaForm1.kbInvNo.KeyTextBox.VALUE,12)+;
      EVALUATE(loFormSet.lcAPvInvDt+'.cApVILNo')) ;
      AND !EMPTY(EVALUATE(loFormSet.lcAPInvTkt+'.cRSession'))

    SELECT (loFormSet.lcAPInvTkt)
    *-- Update the contribution.
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *!*	  REPLACE nApAplQty1 WITH loForm.loRec.nApAprQty1, nApAplQty2 WITH loForm.loRec.nApAprQty2,;
    *!*	          nApAplQty3 WITH loForm.loRec.nApAprQty3, nApAplQty4 WITH loForm.loRec.nApAprQty4,;
    *!*	          nApAplQty5 WITH loForm.loRec.nApAprQty5, nApAplQty6 WITH loForm.loRec.nApAprQty6,;
    *!*	          nApAplQty7 WITH loForm.loRec.nApAprQty7, nApAplQty8 WITH loForm.loRec.nApAprQty8,;
    *!*	          nApTAplQty WITH loForm.loRec.nApTAprQty, nApAplPric WITH loForm.loRec.nAPAprPric,;
    *!*	          nApAplAmnt WITH loForm.loRec.nApTAprQty * loForm.loRec.nAPAprPric               ,;
    *!*	          cStatus    WITH IIF(cStatus='S','M',cStatus)
    REPLACE nApAplQty1 WITH loFormSet.loRec.nApAprQty1, nApAplQty2 WITH loFormSet.loRec.nApAprQty2,;
      nApAplQty3 WITH loFormSet.loRec.nApAprQty3, nApAplQty4 WITH loFormSet.loRec.nApAprQty4,;
      nApAplQty5 WITH loFormSet.loRec.nApAprQty5, nApAplQty6 WITH loFormSet.loRec.nApAprQty6,;
      nApAplQty7 WITH loFormSet.loRec.nApAprQty7, nApAplQty8 WITH loFormSet.loRec.nApAprQty8,;
      nApTAplQty WITH loFormSet.loRec.nApTAprQty, nApAplPric WITH loFormSet.loRec.nAPAprPric,;
      nApAplAmnt WITH loFormSet.loRec.nApTAprQty * loFormSet.loRec.nAPAprPric               ,;
      cStatus    WITH IIF(cStatus='S','M',cStatus)
   *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    SELECT (lnCurAls)
    RETURN
  ENDIF
  SELECT (lnCurAls)


  IF SEEK(PADR(loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE,8)+;
      PADR(loFormSet.AriaForm1.kbInvNo.KeyTextBox.VALUE,12)+;
      EVALUATE(loFormSet.lcAPvInvDt+'.cApVILNo')+SPACE(6),loFormSet.lcAPInvTkt)

    *Add these lines to make sure that the "Approved Amount" and
    *          the "Applied Amount" have the same sign [Begin]

    *-- Calculate the new approved amount
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *!*	  lnNAprAmnt = IIF(EMPTY(lcSize) , loForm.loRec.nApTAprQty * loForm.loRec.nAPAprPric ,;
    *!*	                   loForm.loRec.nAPAprAmnt - (nAPAprQty&lcSize * loForm.loRec.nAPAprPric) +;
    *!*	                   (loForm.loRec.nAPAprQty&lcSize * loForm.loRec.nAPAprPric))
    lnNAprAmnt = IIF(EMPTY(lcSize) , loFormSet.loRec.nApTAprQty * loFormSet.loRec.nAPAprPric ,;
      loFormSet.loRec.nAPAprAmnt - (nAPAprQty&lcSize * loFormSet.loRec.nAPAprPric) +;
      (loFormSet.loRec.nAPAprQty&lcSize * loFormSet.loRec.nAPAprPric))
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    *-- If the "Approved Amount" and the "Applied Amount" have
    *-- different signs.
    *-- Note that the "Applied Amount" have the same sign as the old
    *-- "Approved Amount".
    IF SIGN(lnNAprAmnt) <> 0 .AND.;
        SIGN(lnNAprAmnt) <> SIGN(nAPAprAmnt)

      *-- Message : 04185
      *-- "Invoice amount and approved amount must have the same sign."
      *-- Button : 00000
      *-- "                          <    Ok    >                     "
      =gfModalGen('TRM04185B00000' , 'ALERT')

      RETURN (.F.)
    ENDIF    && End of IF SIGN(lnNAprAmnt) <> 0 .AND. ...
    *Add these lines to make sure that the "Approved Amount" [End]
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *!*	  IF !EMPTY(lcSize) AND loForm.loRec.nApAprQty&lcSize < ;
    *!*	     nApAprQty&lcSize-EVALUATE(loFormSet.lcAPInvTkt+'.nApAplQty'+lcSize)
    IF !EMPTY(lcSize) AND loFormSet.loRec.nApAprQty&lcSize < ;
        nApAprQty&lcSize-EVALUATE(loFormSet.lcAPInvTkt+'.nApAplQty'+lcSize)
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      *Message : 04167
      *Approved Quantity Cannot be less than Contributed Quantity
      *Button : 00000
      *Ok
      =gfModalGen("TRM04167B00000","DIALOG",'quantity')
      RETURN (.F.)
    ENDIF
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *  IF loForm.loRec.nApTAprQty < nApTAprQty-EVALUATE(loFormSet.lcAPInvTkt+'.nApTAplQty')
    IF loFormSet.loRec.nApTAprQty < nApTAprQty-EVALUATE(loFormSet.lcAPInvTkt+'.nApTAplQty')
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      *Message : 04167
      *Approved Quantity Cannot be less than Contributed Quantity
      *Button : 00000
      *Ok
      =gfModalGen("TRM04167B00000","DIALOG",'quantity')
      RETURN (.F.)
    ENDIF
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *!*	  IF ABS(loForm.loRec.nApTAprQty * loForm.loRec.nAPAprPric) < ABS(nApTAprQty * nApAprPric -;
    *!*	     EVALUATE(loFormSet.lcAPInvTkt+'.nApTAplQty') * EVALUATE(loFormSet.lcAPInvTkt+'.nApAPlPric'))
    IF ABS(loFormSet.loRec.nApTAprQty * loFormSet.loRec.nAPAprPric) < ABS(nApTAprQty * nApAprPric -;
        EVALUATE(loFormSet.lcAPInvTkt+'.nApTAplQty') * EVALUATE(loFormSet.lcAPInvTkt+'.nApAPlPric'))
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      *Message : 04167
      *Approved amount Cannot be less than Contributed amount.
      *Button : 00000
      *Ok

      *Change this line to add the second variable part of the
      *          message [Begin]
      *=gfModalGen("TRM04167B00000","DIALOG",'amount')
      =gfModalGen("TRM04167B00000" , "DIALOG" , 'amount|amount')
      *Change this line to add the second variable part [End]

      RETURN (.F.)
    ENDIF
    *-- MAN Added the else condition
    *-- If there is no record with empty rec. session that means that amount is fully
    *-- contributed, therefore we have to check if the new approved amount is less
    *-- than the current approved amount which match the contributed amount.
  ELSE

    *Add this line to calculate the new approved amount [Begin]
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *!*	  lnNAprAmnt = IIF(EMPTY(lcSize) , loForm.loRec.nApTAprQty * loForm.loRec.nAPAprPric ,;
    *!*	                   loForm.loRec.nAPAprAmnt - (nAPAprQty&lcSize * loForm.loRec.nAPAprPric) +;
    *!*	                   (loForm.loRec.nAPAprQty&lcSize * loForm.loRec.nAPAprPric))
    lnNAprAmnt = IIF(EMPTY(lcSize) , loFormSet.loRec.nApTAprQty * loFormSet.loRec.nAPAprPric ,;
      loFormSet.loRec.nAPAprAmnt - (nAPAprQty&lcSize * loFormSet.loRec.nAPAprPric) +;
      (loFormSet.loRec.nAPAprQty&lcSize * loFormSet.loRec.nAPAprPric))
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
    *Add this line to compare the new approved amount [Begin]

    *Add these lines to make sure that the "Approved Amount" and
    *          the "Applied Amount" have the same sign [Begin]

    *-- If the "Approved Amount" and the "Applied Amount" have
    *-- different signs.
    *-- Note that the "Applied Amount" have the same sign as the old
    *-- "Approved Amount".
    IF SIGN(lnNAprAmnt) <> 0 .AND.;
        SIGN(lnNAprAmnt) <> SIGN(nAPAprAmnt)

      *-- Message : 04185
      *-- "Invoice amount and approved amount must have the same sign."
      *-- Button : 00000
      *-- "                          <    Ok    >                     "
      =gfModalGen('TRM04185B00000' , 'ALERT')

      RETURN (.F.)
    ENDIF    && End of IF SIGN(lnNAprAmnt) <> 0 .AND. ...
    *Add these lines to make sure that the "Approved Amount" [End]

    IF ABS(lnNAprAmnt) < ABS(nAPAprAmnt)

      *B602830,1 Change this line to add the second variable part of the
      *          message [Begin]
      *=gfModalGen("TRM04167B00000","DIALOG",'amount')
      =gfModalGen("TRM04167B00000","DIALOG",'amount|amount')
      *B602830,1 Change this line to add the second variable part [End]

      RETURN (.F.)
    ENDIF
  ENDIF

  RETURN
  *-- End of lfChkAplTkt


  *!*************************************************************
  *! Name      : lfGenInvLn
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 09/02/2004
  *! Purpose   : Select Document Lines to Invoice.
  *!*************************************************************
  *! Parameters:  The FormSet of APPYINV.SCX, The Form of APINVDT.SCX,
  *!                       lcTktType    : Ticket Type
  *!                       lcTicket     : Ticket#
  *!                       lcOperation : MFG Operation
  *!                       lcLotNo      : Lot#
  *!                       lcRSession   : Session#
  *!                       lcCostType   : Cost Type
  *!                       lcItem       : Item
  *!                       lcColor      : Color
  *!                       lcDyelot     : Dyelot
  *!                       llDetails    : Shipment Details
  *!*************************************************************
  *! Returns   :  None
  *!*************************************************************
FUNCTION lfGenInvLn
  LPARAMETERS loFormSet, loForm, lcTktType, lcTicket, lcOperation, lcLotNo, lcRSession, ;
    lcCostType, lcItem, lcColor, lcDyelot, llDetails

  lcCostType = ALLTRIM(lcCostType)

  PRIVATE    lnAlias,lcTktFile,lcTktItem,lcTktColor,lcTktDyelot,lcTktTotQty,;
    lnApQTy1,lnApQTy2,lnApQTy3,lnApQTy4,lnApQTy5,lnApQTy6,lnApQTy7,;
    lnApQTy8,lnApTotQty,lnApAmount,lnUnitCost,lcMfgCode
  *Old: SET ORDER TO TAG BOMPOREC IN BOMLINE
  loFormSet.BOMLINE.SetOrder('BOMPOREC') &&Sql87: Check Tag ;
  *CIMTYP+CTYPE+CBOMTYP+MFGCODE+CTKTNO+CRSESSION+SHIPNO+STR(LINENO,6)+CINVTYPE+STYLE+CSTYGRADE ;
  (CIMTYP+CTYPE+CBOMTYP+MFGCODE+CTKTNO+CRSESSION+SHIPNO+STR(LINENO,6)+STYLE+SCLR+CSTYGRADE)
  lnAlias = SELECT()
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *SET ORDER TO TAG ITEM IN APVINVDT
  SELECT APVINVDT
  gfSETORDER('ITEM')
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  lcRSession = PADR(lcRSession,6)
  *B608100,1 WAM 05/28/2007 Get Fabric color code
  lcFabItem = ''
  *B608100,1 WAM 05/28/2007 (End)

  DO CASE
    CASE INLIST(lcTktType,'A','D')
      lcTktFile   = 'POSLN'
      lcFileTag   = 'POSREC' &&Sql88: Check Tag ;
      *CBUSDOCU+CSTYTYPE+PO+CRSESSION+SHIPNO+CINVTYPE+STYLE+STR(LINENO,6)+TRANCD+CSTYGRADE ;
      (CSTYTYPE+PO+CRSESSION+SHIPNO+STYLE+STR(LINENO,6)+TRANCD)
      lcTktIdx    = 'CBUSDOCU+CSTYTYPE+PO+CRSESSION+SHIPNO+CINVTYPE+STYLE+STR(LINENO,6)+TRANCD'
      lcTktKey    = 'P'+lcTktType+lcTicket+lcRSession+SPACE(6)+IIF(EMPTY(lcItem),'','0001'+ALLTRIM(lcItem)) &&Sql89: Check Key
      loFormSet.lcForCond   = IIF(EMPTY(lcRSession),"TranCd='1'","TranCd $ '24'")
      lcTktItem   = 'POSLN.Style'
      lcTktColor  = 'SPACE(6)'
      lcTktDyelot = 'POSLN.Dyelot'
      lcTktTotQty = 'POSLN.TotQty'
      lcTktLine   = 'STR(POSLN.LINENO,6)'
      lcGrade     = 'POSLN.cStyGrade'

    CASE INLIST(lcTktType,'I','R')  && Style PO & Style PO Returns
      lcTktFile   = 'POSLN'
      lcFileTag   = 'POSREC' &&Sql90: Check Tag ;
      *CBUSDOCU+CSTYTYPE+PO+CRSESSION+SHIPNO+CINVTYPE+STYLE+STR(LINENO,6)+TRANCD+CSTYGRADE ;
      (CSTYTYPE+PO+CRSESSION+SHIPNO+STYLE+STR(LINENO,6)+TRANCD)
      lcTktIdx    = 'CBUSDOCU+CSTYTYPE+PO+CRSESSION+SHIPNO+CINVTYPE+STYLE+STR(LINENO,6)+TRANCD'
      lcTktKey    = IIF(lcTktType='I','PP','RP')+lcTicket+lcRSession &&Sql91: Check Key
      loFormSet.lcForCond   = IIF(EMPTY(lcRSession),"TranCd='1'","TranCd $ '24'")
      loFormSet.lcForCond   = loFormSet.lcForCond+IIF(EMPTY(lcItem),""," AND CINVTYPE ='0001'AND Style=lcItem")
      lcTktItem   = 'POSLN.Style'
      lcTktColor  = 'SPACE(6)'
      lcTktDyelot = 'POSLN.Dyelot'
      lcTktTotQty = 'POSLN.TotQty'
      lcTktLine   = 'STR(POSLN.LINENO,6)'
      lcGrade     = 'POSLN.cStyGrade'
    CASE lcTktType= 'S'              && Shipments
      lcTktFile   = 'POSLN'
      lcFileTag   = 'POSHREC' &&Sql92: Check Tag ;
      *SHIPNO+CRSESSION+CBUSDOCU+CSTYTYPE+PO+CINVTYPE+STYLE+STR(LINENO,6)+TRANCD ;
      (SHIPNO+CRSESSION+CSTYTYPE+PO+STYLE+STR(LINENO,6)+TRANCD)
      lcTktIdx    = 'SHIPNO+CRSESSION+CBUSDOCU+CSTYTYPE+PO+CINVTYPE+STYLE+STR(LINENO,6)+TRANCD'
      lcTktKey    = lcTicket+IIF(EMPTY(lcRSession),'',lcRSession+'PP') &&Sql93: Check Key

      *B608730,1 WAM 10/23/2008 Don't include cancel lines
      *loFormSet.lcForCond   = '.T.' && IIF(EMPTY(lcRSession),"TranCd='3'","TranCd $ '24'")
      loFormSet.lcForCond   = IIF(EMPTY(lcRSession),".T.","TranCd $ '24'")
      *B608730,1 WAM 10/23/2008 (End)

      loFormSet.lcForCond   = loFormSet.lcForCond+IIF(EMPTY(lcItem),""," AND CINVTYPE ='0001'AND Style=lcItem")
      lcTktItem   = 'POSLN.Style'
      lcTktColor  = 'SPACE(6)'
      lcTktDyelot = 'POSLN.Dyelot'
      lcTktTotQty = 'POSLN.TotQty'
      lcTktLine   = 'STR(POSLN.LINENO,6)'
      lcGrade     = 'POSLN.cStyGrade'
    CASE lcTktType= 'M'               && Cutting Tickets
      lcTktFile   = 'CUTTKTL'
      lcFileTag   = 'POSREC' &&Sql94: Check Tag ;
      *CBUSDOCU+CSTYTYPE+PO+CRSESSION+SHIPNO+CINVTYPE+STYLE+STR(LINENO,6)+TRANCD+CSTYGRADE ;
      (CRSESSION+CUTTKT+STYLE+TRANCD)
      lcTktIdx    = 'CBUSDOCU+CSTYTYPE+PO+CRSESSION+SHIPNO+CINVTYPE+STYLE+STR(LINENO,6)+TRANCD'
      lcTktKey    = 'PU'+lcTicket+lcRSession+SPACE(6)+IIF(EMPTY(lcItem),'','0001'+ALLTRIM(lcItem))
      loFormSet.lcForCond   = "Dyelot=ALLTRIM(lcDyelot) AND "+IIF(EMPTY(lcRSession),"TranCd='1'","TranCd $ '24'") &&Sql95: Check Key
      lcTktItem   = 'CUTTKTL.Style'
      lcTktColor  = 'SPACE(6)'
      lcTktDyelot = 'CUTTKTL.Dyelot'
      lcTktTotQty = 'CUTTKTL.TotQty'
      lcTktLine   = 'STR(CUTTKTL.LINENO,6)'
      lcGrade     = 'CUTTKTL.cStyGrade'

    CASE lcTktType= 'T'                && Material Orders

      lcTktFile   = 'MMFGORDD'
      lcFileTag   = 'POSREC' &&Sql96: Check Tag ;
      *CBUSDOCU+CSTYTYPE+PO+CRSESSION+SHIPNO+CINVTYPE+STYLE+STR(LINENO,6)+TRANCD+CSTYGRADE ;
      (CRSESSION+CMFGORDNO+CFABRIC+COLOR+TRANCD)
      lcTktIdx    = 'CBUSDOCU+CSTYTYPE+PO+CRSESSION+SHIPNO+CINVTYPE+STYLE+STR(LINENO,6)+TRANCD'
      lcTktKey    =  'PF'+lcTicket+lcRSession+SPACE(6)+IIF(EMPTY(lcItem),"",'0002'+lfupditem(SUBSTR(lcItem,1,loFormSet.lnFabMajLen),ALLTRIM(lcColor))) &&Sql97: Check Key
      loFormSet.lcForCond   = "Dyelot=ALLTRIM(lcDyelot) AND "+IIF(EMPTY(lcRSession),"TranCd='1'","TranCd $ '24'")

      *B608100,1 WAM 05/28/2007 Get Fabric color code
      *lcTktItem   = 'MMFGORDD.Style'
      *lcTktColor  = 'SPACE(6)'
      lcFabItem   = 'MMFGORDD.Style'
      lcTktItem   = 'LEFT(MMFGORDD.Style,loFormSet.lnFabMajLen)'
      lcTktColor  = 'SUBSTR(MMFGORDD.Style,loFormSet.lnFabClrStart,loFormSet.lnFabClrLen)'
      *B608100,1 WAM 05/28/2007 (End)

      lcTktDyelot = 'MMFGORDD.Dyelot'
      lcTktTotQty = 'MMFGORDD.TotQty'
      lcTktLine   = 'STR(0,6)'

      lcGrade     = 'MMFGORDD.cStyGrade'
    CASE INLIST(lcTktType,'L','F')     && Material PO & Material PO Retuns
      lcTktFile   = 'POFLN'
      lcFileTag   = 'POSREC' &&Sql98: Check Tag ;
      *CBUSDOCU+CSTYTYPE+PO+CRSESSION+SHIPNO+CINVTYPE+STYLE+STR(LINENO,6)+TRANCD+CSTYGRADE ;
      (CMATTYPE+POMAT+CRSESSION+FABRIC+COLOR+TRANCD)
      lcTktIdx    = 'CBUSDOCU+CSTYTYPE+PO+CRSESSION+SHIPNO+CINVTYPE+STYLE+STR(LINENO,6)+TRANCD'
      lcTktKey    =  IIF(lcTktType='L','PM','RM')+lcTicket+lcRSession+SPACE(6)+IIF(EMPTY(lcItem),'',;
        '0002'+lfupditem(SUBSTR(lcItem,1,loFormSet.lnFabMajLen),ALLTRIM(lcColor))) &&Sql99: Check Key
      loFormSet.lcForCond   = "Dyelot=ALLTRIM(lcDyelot) AND "+IIF(EMPTY(lcRSession),"TranCd='1'","TranCd $ '24'")

      *B608100,1 WAM 05/28/2007 Get Fabric color code
      *lcTktItem   = 'POFLN.Style'
      *lcTktColor  = 'SPACE(6)'
      lcFabItem   = 'POFLN.Style'
      lcTktItem   = 'LEFT(POFLN.Style,loFormSet.lnFabMajLen)'
      lcTktColor  = 'SUBSTR(POFLN.Style,loFormSet.lnFabClrStart,loFormSet.lnFabClrLen)'
      *B608100,1 WAM 05/28/2007 (End)

      lcTktDyelot = 'POFLN.Dyelot'
      lcTktTotQty = 'POFLN.TotQty'
      lcTktLine   = 'STR(POFLN.LINENO,6)'
      lcGrade     = 'POFLN.cStyGrade'
  ENDCASE

  SELECT (loFormSet.lcAutoInv)
  DELETE ALL
  IF EMPTY(lcLotNo)
    *Old: SET ORDER TO TAG (lcFileTag)
    loFormSet.&lcTktFile..SetOrder(lcFileTag)
    *=SEEK(lcTktKey)
    loFormSet.&lcTktFile..SEEK(lcTktKey)
    SELECT (lcTktFile)
    SCAN REST WHILE &lcTktIdx = lcTktKey FOR EVALUATE(loFormSet.lcForCond)
      *Get invoiced amount applied againest this item
      SELECT APVINVDT
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *!*	    =SEEK(lcTktType+lcTicket+lcLotNo+EVAL(lcTktLine)+lcCostType+lcOperation+;
      *!*	          PADR(EVAL(lcTktItem),19)+EVAL(lcTktColor)+EVAL(lcTktDyelot))
      =gfSEEK(lcTktType+lcTicket+lcLotNo+EVAL(lcTktLine)+lcCostType+lcOperation+;
        PADR(EVAL(lcTktItem),19)+EVAL(lcTktColor)+EVAL(lcTktDyelot))
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
      IF EMPTY(lcRSession)
        SUM REST IIF(nApPrice>0,nApQty1,-nApQty1),IIF(nApPrice>0,nApQty2,-nApQty2),IIF(nApPrice>0,nApQty3,-nApQty3),;
          IIF(nApPrice>0,nApQty4,-nApQty4),IIF(nApPrice>0,nApQty5,-nApQty5),IIF(nApPrice>0,nApQty6,-nApQty6),;
          IIF(nApPrice>0,nApQty7,-nApQty7),IIF(nApPrice>0,nApQty8,-nApQty8),IIF(nApPrice>0,nApTotQty,-nApTotQty),;
          nApTotQty*nApPrice TO lnApQTy1,lnApQTy2,lnApQTy3,lnApQTy4,lnApQTy5,lnApQTy6,lnApQTy7,lnApQTy8,lnApTotQty,lnApAmount;
          WHILE cIMTyp+cTktNO+cLotNo+cBomType+cOprCode+ITEM+COLOR+cDyelot= ;
          lcTktType+lcTicket+SPACE(2)+lcCostType+lcOperation+;
          PADR(EVAL(lcTktItem),19)+EVAL(lcTktColor)+EVAL(lcTktDyelot)
      ELSE && !EMPTY(lcRSession)
        STORE 0 TO lnApQTy1,lnApQTy2,lnApQTy3,lnApQTy4,lnApQTy5,lnApQTy6,;
          lnApQTy7,lnApQTy8,lnApTotQty,lnApAmount
        SCAN REST WHILE cIMTyp+cTktNO+cLotNo+STR(LINENO,6)+cBomType+cOprCode+ITEM+COLOR+cDyelot= ;
            lcTktType+lcTicket+SPACE(2)+EVAL(lcTktLine)+lcCostType+lcOperation+;
            PADR(EVAL(lcTktItem),19)+EVAL(lcTktColor)+EVAL(lcTktDyelot)

          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
          *        IF SEEK(cVendCode+cApInvNo+cApVILNo+lcRSession,'APINVTKT')
          IF gfSEEK(cVendCode+cApInvNo+cApVILNo+lcRSession,'APINVTKT')
          *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
            SELECT APINVTKT
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
*!*	            SCAN REST WHILE cVendCode+cApInvNo+cApVILNo+cRSession = ;
*!*	                EVALUATE(loFormSet.lcAPvInvDt+'.cVendCode')+;
*!*	                EVALUATE(loFormSet.lcAPvInvDt+'.cApInvNo')+;
*!*	                EVALUATE(loFormSet.lcAPvInvDt+'.cApVILNo')+lcRSession
            SCAN REST WHILE CVENDCODE+CAPINVNO+CAPVILNO+CRSESSION+cimtyp+ctktno+STR(lineno,6)= ;
                EVALUATE(loFormSet.lcAPvInvDt+'.cVendCode')+;
                EVALUATE(loFormSet.lcAPvInvDt+'.cApInvNo')+;
                EVALUATE(loFormSet.lcAPvInvDt+'.cApVILNo')+lcRSession
*! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
              lnApQTy1   = lnApQTy1   + nApAPlQty1
              lnApQTy2   = lnApQTy2   + nApAPlQty2
              lnApQTy3   = lnApQTy3   + nApAPlQty3
              lnApQTy4   = lnApQTy4   + nApAPlQty4
              lnApQTy5   = lnApQTy5   + nApAPlQty5
              lnApQTy6   = lnApQTy6   + nApAPlQty6
              lnApQTy7   = lnApQTy7   + nApAPlQty7
              lnApQTy8   = lnApQTy8   + nApAPlQty8
              lnApTotQty = lnApTotQty + nApTAplQty
              lnApAmount = lnApAmount + nApAPlAmnt
            ENDSCAN
          ENDIF
        ENDSCAN
      ENDIF &&EMPTY(lcRSession)
      *Get Ticket estimated amount or session received amount
      DO CASE
        CASE INLIST(lcTktType,'L','F')
          lnAmount = IIF(EMPTY(lcRSession),;
            EVAL('POFLN.nFCost'+lcCostType),;
            EVAL('POFLN.nFLanCost'+lcCostType))*&lcTktTotQty
        CASE INLIST(lcTktType,'A','D')
          lnAmount = IIF(EMPTY(lcRSession),;
            EVAL('POSLN.nFCost'+lcCostType),;
            EVAL('POSLN.nFLanCost'+lcCostType))*&lcTktTotQty
        CASE lcTktType='R'
          lnAmount = IIF(EMPTY(lcRSession),;
            EVAL('POSLN.nFCost'+lcCostType),;
            EVAL('POSLN.nFLanCost'+lcCostType))*&lcTktTotQty
        OTHERWISE

          lcMfgCode=lcOperation
          IF INLIST(lcTktType,'S','I','M') AND lcOperation=REPLICATE('*',6)
            =SEEK(PADR(&lcTktItem,19),'STYLE')
            IF EOF('Style')
              *WAIT WINDOW PADR(&lcTktItem,19)+'Not Found 1'
              MESSAGEBOX('Style '+PADR(&lcTktItem,19)+' not found in the Styles Table'+CHR(13)+'You can not Contribution this style.')
            ENDIF
            lcMfgCode=IIF(!STYLE.lDetCost,PADR('*1',6),lcOperation)
          ENDIF
          IF INLIST(lcTktType,'S','I','M') AND lcOperation=REPLICATE('#',6)
            =SEEK(PADR(&lcTktItem,19),'STYLE')
            lcMfgCode=IIF(!STYLE.lDetCost,PADR('*2',6),lcOperation)
            IF EOF('Style')
              *WAIT WINDOW PADR(&lcTktItem,19)+'Not Found 2'
              MESSAGEBOX('Style '+PADR(&lcTktItem,19)+' not found in the Styles Table'+CHR(13)+'You can not Contribution this style.')
            ENDIF
          ENDIF
          SELECT BOMLINE
          *CIMTYP+CTYPE+CBOMTYP+MFGCODE+CTKTNO+CRSESSION+SHIPNO+STR(LINENO,6)+CINVTYPE+STYLE+CSTYGRADE

          *B608730,1 WAM 10/23/2008 Fix cost calculation when assign PO to invoice by Auto option
          *lcTemp = IIF(lcTktType='S','I',lcTktType)+IIF(EMPTY(lcRSession),'1','2')+;
          lcCostType+lcMfgCode+IIF(lcTktType='S',POSLN.PO,lcTicket)+lcRSession+;
          IIF(lcTktType='S' AND !EMPTY(lcRSession),lcTicket,SPACE(6))+;
          IIF(INLIST(lcTktType,'M','I','S','T'),STR(&lcTktFile..LineNo,6),SPACE(6))+;
          IIF(INLIST(lcTktType,'L','F','T'),'0002','0001')+PADR(EVALUATE(lcTktItem),19)
          lcTemp = IIF(lcTktType='S','I',lcTktType)+IIF(EMPTY(lcRSession),'1','2')+;
            lcCostType+lcMfgCode+IIF(lcTktType='S',POSLN.PO,lcTicket)+lcRSession+;
            IIF(EMPTY(lcRSession), SPACE(6),IIF(lcTktType='S',lcTicket,POSLN.SHIPNO))+;
            IIF(INLIST(lcTktType,'M','I','S','T'),STR(&lcTktFile..LINENO,6),SPACE(6))+;
            IIF(INLIST(lcTktType,'L','F','T'),'0002','0001')+PADR(EVALUATE(lcTktItem),19)
          *B608730,1 WAM 10/23/2008 (End)


          =loFormSet.BOMLINE.SEEK(lcTemp)
          SELECT BOMLINE
          *B608730,1 WAM 10/23/2008 Fix cost calculation when assign PO to invoice by Auto option
          *SUM REST UnitCost*UnitQty*&lcTktTotQty TO lnAmount WHILE ;
          cimtyp+ctype+cbomtyp+mfgcode+ctktno+crsession+shipno+STR(lineno,6)+cinvtype+style+cstygrade=;
          IIF(lcTktType='S','I',lcTktType)+IIF(EMPTY(lcRSession),'1','2')+;
          lcCostType+lcMfgCode+IIF(lcTktType='S',POSLN.PO,lcTicket)+;
          lcRSession+IIF(lcTktType='S' AND !EMPTY(lcRSession),lcTicket,SPACE(6))+;
          IIF(INLIST(lcTktType,'M','I','S','T'),STR(&lcTktFile..LineNo,6),SPACE(6))+;
          IIF(INLIST(lcTktType,'L','F','T'),'0002','0001')+PADR(EVALUATE(lcTktItem),19)+IIF(lcTktType='T','','1')

          SUM REST UnitCost*UnitQty*&lcTktTotQty TO lnAmount WHILE ;
            cimtyp+ctype+cbomtyp+mfgcode+ctktno+crsession+shipno+STR(LINENO,6)+cinvtype+STYLE+cstygrade=;
            IIF(lcTktType='S','I',lcTktType)+IIF(EMPTY(lcRSession),'1','2')+;
            lcCostType+lcMfgCode+IIF(lcTktType='S',POSLN.PO,lcTicket)+;
            lcRSession+IIF(EMPTY(lcRSession), SPACE(6),IIF(lcTktType='S',lcTicket,POSLN.SHIPNO))+;
            IIF(INLIST(lcTktType,'M','I','S','T'),STR(&lcTktFile..LINENO,6),SPACE(6))+;
            IIF(INLIST(lcTktType,'L','F','T'),'0002','0001')+PADR(EVALUATE(lcTktItem),19)+IIF(lcTktType='T','','1')
          *B608730,1 WAM 10/23/2008 (End)

          *B121306,1 NNA 01/22/2004  (End)
          *E301995,1 Alb Add Adorment/Dying/MMFG order to invoice line [END]
          *B607161,1 ASH 04/14/2003 (End)
          *B607341,1 ALB Fix Bug happend by bug# B607161,1 and fix the original bug [END]

      ENDCASE
      SELECT (loFormSet.lcAutoInv)
      *B608599,1 WAM 07/01/2008 Use the proper index
      *IF !SEEK(&lcTktItem+&lcTktFile..cWareCode+&lcTktDyelot+IIF(lcTktType='S' AND llDetails,POSLN.PO,SPACE(6)))
      IF !SEEK(&lcTktItem+&lcTktFile..cWareCode+&lcTktDyelot+IIF(lcTktType='S' AND llDetails,POSLN.PO,SPACE(6)),loFormSet.lcAutoInv,loFormSet.lcAutoInv)
        *B608599,1 WAM 07/01/2008 (End)

        APPEND BLANK
        *B999999,1 ASM Fix error that showed when trying to select item/color for shipment 4545 [Start]
        *REPLACE cSelect   WITH IIF(lcTktType= 'S' .AND. loFormSet.POSHDR.SEEK("PP"+POSLN.PO) .AND. POSHDR.Status="S","",""),;
        cTktNo    WITH IIF(lcTktType='S' AND llDetails,POSLN.PO,'') ,;
        cRecvType WITH IIF(EMPTY(lcRSession),'',IIF(&lcTktFile..TranCd='2','R',IIF(&lcGrade='2','S','D'))) ,;
        Item      WITH IIF(INLIST(lcTktType,'L','F','T'),LEFT(&lcTktItem,12),PADR(&lcTktItem,19))   ,;
        Color     WITH IIF(INLIST(lcTktType,'L','F','T'),SUBSTR(&lcTktItem,14),'')  ,;
        cDyelot   WITH &lcTktDyelot ,;
        cWareCode WITH &lcTktFile..cWareCode ,;
        LineNo    WITH IIF(lcTktType='T',0,EVALUATE(lcTktFile+'.LineNo'))

        *B608100,1 WAM 05/28/2007 fix bug or wrong browse ticket items when adding invoice lines
        *REPLACE cSelect   WITH IIF(lcTktType= 'S' .AND. loFormSet.POSHDR.SEEK("PP"+POSLN.PO) .AND. POSHDR.Status="S","",""),;
        cTktNo    WITH IIF(lcTktType='S' AND llDetails,POSLN.PO,'') ,;
        cRecvType WITH IIF(EMPTY(lcRSession),'',IIF(EVALUATE(lcTktFile+'.TranCd')='2','R',IIF(EVALUATE(lcGrade)='2','S','D'))), ;
        Item      WITH IIF(INLIST(lcTktType,'L','F','T'),LEFT(EVALUATE(lcTktItem),12),PADR(EVALUATE(lcTktItem),19))   ,;
        Color     WITH IIF(INLIST(lcTktType,'L','F','T'),SUBSTR(EVALUATE(lcTktItem),14),'')  ,;
        cDyelot   WITH EVALUATE(lcTktDyelot) ,;
        cWareCode WITH EVALUATE(lcTktFile+'.cWareCode') ,;
        LineNo    WITH IIF(lcTktType='T',0,EVALUATE(lcTktFile+'.LineNo'))
        REPLACE cSelect   WITH IIF(lcTktType= 'S' .AND. loFormSet.POSHDR.SEEK("PP"+POSLN.PO) .AND. POSHDR.STATUS="S","",""),;
          cTktNo    WITH IIF(lcTktType='S' AND llDetails,POSLN.PO,'') ,;
          cRecvType WITH IIF(EMPTY(lcRSession),'',IIF(EVALUATE(lcTktFile+'.TranCd')='2','R',IIF(EVALUATE(lcGrade)='2','S','D'))), ;
          ITEM      WITH IIF(INLIST(lcTktType,'L','F','T'),EVALUATE(lcFabItem),EVALUATE(lcTktItem)) ,;
          COLOR     WITH EVALUATE(lcTktColor) ,;
          cDyelot   WITH EVALUATE(lcTktDyelot) ,;
          cWareCode WITH EVALUATE(lcTktFile+'.cWareCode') ,;
          LINENO    WITH IIF(lcTktType='T',0,EVALUATE(lcTktFile+'.LineNo'))
        *B608100,1 WAM 05/28/2007 (End)
        *B999999,1 ASM Fix error that showed when trying to select item/color for shipment 4545 [End]
        IF lcTktType='S' AND !EMPTY(cTktNo)
          SELECT POSHDR
          lcPosHdr = ORDER()
          lnPosRcNo = REC_NO &&Sql101: Check Row_ID
          *Old: SET ORDER TO TAG Poshdr
          loFormSet.POSHDR.SetOrder('Poshdr') &&Sql102:  CBUSDOCU+CSTYTYPE+PO (CSTYTYPE+PO)
          IF loFormSet.POSHDR.SEEK('PP'+POSLN.PO) &&Sql102: Check Key
            lcTemp = loFormSet.lcAutoInv+'.cWIPAcct'
            REPLACE &lcTemp WITH ;
              IIF(!EMPTY(loFormSet.lcApdGLAct),;
              loFormSet.lcApdGLAct,lfvAASAct(POSHDR.LINK_CODE,"013")) IN (loFormSet.lcAutoInv)
          ENDIF
          SELECT POSHDR
          *Old: SET ORDER TO (lcPosHdr)
          loFormSet.POSHDR.SetOrder(lcPosHdr)
          *Old: IF BETWEEN(lnPosRcNo , 1, RECCOUNT() )
          *Old: GOTO lnPosRcNo
          *Old: ENDIF
          IF !EMPTY(lnPosRcNo)
            loFormSet.POSHDR.GoRec(lnPosRcNo)
          ENDIF
          SELECT (loFormSet.lcAutoInv)
        ENDIF
      ENDIF
      REPLACE nTktQty   WITH nTktQty + &lcTktTotQty ,;
        nTktAmnt  WITH nTktAmnt+ lnAmount,;
        nTktCst   WITH IIF(nTktQty=0,0,nTktAmnt/nTktQty) ,;
        nAplQty   WITH nAplQty+lnApTotQty ,;
        nAplAmnt  WITH nAplAmnt+lnApAmount ,;
        nInvQty   WITH nInvQty+MAX(&lcTktTotQty-lnApTotQty,0),;
        nInvAmnt  WITH nInvAmnt+MAX(lnAmount-lnApAmount,0)
      IF INLIST(lcTktType,'I','S','M','R','A','D')
        REPLACE nTktQty1 WITH nTktQty1+&lcTktFile..Qty1 ,;
          nTktQty2 WITH nTktQty2+&lcTktFile..Qty2 ,;
          nTktQty3 WITH nTktQty3+&lcTktFile..Qty3 ,;
          nTktQty4 WITH nTktQty4+&lcTktFile..Qty4 ,;
          nTktQty5 WITH nTktQty5+&lcTktFile..Qty5 ,;
          nTktQty6 WITH nTktQty6+&lcTktFile..Qty6 ,;
          nTktQty7 WITH nTktQty7+&lcTktFile..Qty7 ,;
          nTktQty8 WITH nTktQty8+&lcTktFile..Qty8 ,;
          nAplQty1 WITH nAplQty1+lnApQTy1  ,;
          nAplQty2 WITH nAplQty2+lnApQTy2  ,;
          nAplQty3 WITH nAplQty3+lnApQTy3  ,;
          nAplQty4 WITH nAplQty4+lnApQTy4  ,;
          nAplQty5 WITH nAplQty5+lnApQTy5  ,;
          nAplQty6 WITH nAplQty6+lnApQTy6  ,;
          nAplQty7 WITH nAplQty7+lnApQTy7  ,;
          nAplQty8 WITH nAplQty8+lnApQTy8
        REPLACE nInvQty1 WITH nInvQty1+MAX(&lcTktFile..Qty1-lnApQty1,0),;
          nInvQty2 WITH nInvQty2+MAX(&lcTktFile..Qty2-lnApQty2,0),;
          nInvQty3 WITH nInvQty3+MAX(&lcTktFile..Qty3-lnApQty3,0),;
          nInvQty4 WITH nInvQty4+MAX(&lcTktFile..Qty4-lnApQty4,0),;
          nInvQty5 WITH nInvQty5+MAX(&lcTktFile..Qty5-lnApQty5,0),;
          nInvQty6 WITH nInvQty6+MAX(&lcTktFile..Qty6-lnApQty6,0),;
          nInvQty7 WITH nInvQty7+MAX(&lcTktFile..Qty7-lnApQty7,0),;
          nInvQty8 WITH nInvQty8+MAX(&lcTktFile..Qty8-lnApQty8,0)
      ENDIF
    ENDSCAN
  ELSE && !EMPTY(lcLotNo)
    SELECT MFGOPRDT
    *CIMTYP+CTKTNO+COPRCODE+CLOTNO+TRANCD
    loFormSet.MFGOPRDT.SEEK(lcTktType+lcTicket+lcOperation+lcLotNo+'1') &&Sql103: Check Key
    *! B039743,1 ASM 09/26/2005 Invoice screen gives error messege When Choosing Lines with lcLots [Start]
    *SCAN REST WHILE cIMTyp+cTktNo+cOprCode+cLotNo+TranCd = ;
    lcTktType+lcTicket+lcOperation+lcLotNo+'1' ;
    FOR style = lfupditem(lcItem,lcColor)

    *B608100,1 WAM 05/28/2007 fix bug or wrong browse ticket items when adding invoice lines
    *SCAN REST WHILE cIMTyp+cTktNo+cOprCode+cLotNo+TranCd = ;
    lcTktType+lcTicket+lcOperation+lcLotNo+'1' ;
    FOR Item = lfupditem(lcItem,lcColor)
    SCAN REST WHILE cIMTyp+cTktNo+cOprCode+cLotNo+TranCd = ;
        lcTktType+lcTicket+lcOperation+lcLotNo+'1' ;
        FOR IIF(EMPTY(lcItem),.T.,IIF(INLIST(lcTktType,'L','F','T'),ITEM = lfupditem(lcItem,lcColor),ITEM = lcItem))
      *B608100,1 WAM 05/28/2007 (End)

      *! B039743,1 ASM 09/26/2005 Invoice screen gives error messege When Choosing Lines with lcLots [End]
      SELECT APVINVDT
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
      *=SEEK(lcTktType+lcTicket+lcLotNo)
      =gfSEEK(lcTktType+lcTicket+lcLotNo)
      *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]

      *B608100,1 WAM 05/28/2007 fix bug or wrong browse ticket items when adding invoice lines
      *SUM REST nApQty1,nApQty2,nApQty3,nApQty4,nApQty5,nApQty6,nApQty7,nApQty8,nApTotQty,nApTotQty*nApPrice;
      TO lnApQTy1,lnApQTy2,lnApQTy3,lnApQTy4,lnApQTy5,lnApQTy6,lnApQTy7,lnApQTy8,lnApTotQty,lnApAmount;
      WHILE cIMTyp+cTktNO+cLotNo+STR(LineNO,6)+cBomType+cOprCode+Item+Color+cDyelot= ;
      lcTktType+lcTicket+lcLotNo ;
      FOR cBomType+cOprCode+Item+Color =;
      lcCostType+lcOperation+PADR(left(MFGOPRDT.Style,12),19)+SUBSTR(MFGOPRDT.Style,14)
      SUM REST nApQty1,nApQty2,nApQty3,nApQty4,nApQty5,nApQty6,nApQty7,nApQty8,nApTotQty,nApTotQty*nApPrice;
        TO lnApQTy1,lnApQTy2,lnApQTy3,lnApQTy4,lnApQTy5,lnApQTy6,lnApQTy7,lnApQTy8,lnApTotQty,lnApAmount;
        WHILE cIMTyp+cTktNO+cLotNo+STR(LINENO,6)+cBomType+cOprCode+ITEM+COLOR+cDyelot= ;
        lcTktType+lcTicket+lcLotNo ;
        FOR cBomType+cOprCode+ITEM+COLOR =;
        lcCostType+lcOperation+IIF(INLIST(lcTktType,'L','F','T'),PADR(LEFT(MFGOPRDT.ITEM,loFormSet.lnFabMajLen),19),PADR(MFGOPRDT.ITEM,19))+;
        IIF(INLIST(lcTktType,'L','F','T'),SUBSTR(MFGOPRDT.ITEM,loFormSet.lnFabClrStart,loFormSet.lnFabClrLen),'')
      *B608100,1 WAM 05/28/2007 (End)

      lcMfgCode=lcOperation
      IF INLIST(lcTktType,'S','I','M','A','D') AND lcOperation=REPLICATE('*',6)
        =SEEK(PADR(&lcTktItem,19),'STYLE')
        lcMfgCode=IIF(!STYLE.lDetCost,PADR('*1',6),lcOperation)
      ENDIF
      IF INLIST(lcTktType,'S','I','M','A','D') AND lcOperation=REPLICATE('#',6)
        =SEEK(PADR(&lcTktItem,19),'STYLE')
        lcMfgCode=IIF(!STYLE.lDetCost,PADR('*2',6),lcOperation)
      ENDIF
      SELECT BomLine
      **CIMTYP+CTYPE+CBOMTYP+MFGCODE+CTKTNO+CRSESSION+SHIPNO+STR(LINENO,6)+CINVTYPE+STYLE+CSTYGRADE
      loFormSet.BomLine.SEEK(lcTktType+'1'+lcCostType+lcMfgCode+lcTicket+lcRSession+SPACE(6)) &&Sql104: Check Key
      *! B039743,1 ASM 09/26/2005 Invoice screen gives error messege When Choosing Lines with lcLots [Start]
      *LOCATE REST WHILE ;
      cIMTyp+cType+cBomTyp+MfgCode+cTktNo+cRSession+ShipNo+STR(LineNo,6)+Style=;
      lcTktType+'1'+lcCostType+lcMfgCode+lcTicket+lcRSession+SPACE(6) ;
      FOR Style = MFGOPRDT.Style
      LOCATE REST WHILE ;
        cIMTyp+cType+cBomTyp+MfgCode+cTktNo+cRSession+ShipNo+STR(LINENO,6)+STYLE=;
        lcTktType+'1'+lcCostType+lcMfgCode+lcTicket+lcRSession+SPACE(6) ;
        FOR STYLE = MFGOPRDT.ITEM
      *! B039743,1 ASM 09/26/2005 Invoice screen gives error messege When Choosing Lines with lcLots [End]
      SELECT (loFormSet.lcAutoInv)
      APPEND BLANK


      *B608100,1 WAM 05/28/2007 fix bug or wrong browse ticket items when adding invoice lines
      *REPLACE cSelect  WITH IIF(lcTktType= 'S' .AND. loFormSet.POSHDR.SEEK("PP"+MFGOPRDT.cTktNo) .AND. POSHDR.Status="S","",""),; &&sql Check Key
      ITEM     WITH LEFT(MFGOPRDT.STYLE,12),;
        COLOR    WITH SUBSTR(MFGOPRDT.COLOR,14),;
        nTktQty1 WITH MFGOPRDT.nLotQty1,;
        nTktQty2 WITH MFGOPRDT.nLotQty2,;
        nTktQty3 WITH MFGOPRDT.nLotQty3,;
        nTktQty4 WITH MFGOPRDT.nLotQty4,;
        nTktQty5 WITH MFGOPRDT.nLotQty5,;
        nTktQty6 WITH MFGOPRDT.nLotQty6,;
        nTktQty7 WITH MFGOPRDT.nLotQty7,;
        nTktQty8 WITH MFGOPRDT.nLotQty8,;
        nTktQty  WITH MFGOPRDT.nLotTotQty,;
        nTktCst  WITH BomLine.UnitCost ,;
        nTktAmnt WITH MFGOPRDT.nLotTotQty*BomLine.UnitCost,;
        nAplQty1 WITH lnApQTy1  ,;
        nAplQty2 WITH lnApQTy2  ,;
        nAplQty3 WITH lnApQTy3  ,;
        nAplQty4 WITH lnApQTy4  ,;
        nAplQty5 WITH lnApQTy5  ,;
        nAplQty6 WITH lnApQTy6  ,;
        nAplQty7 WITH lnApQTy7  ,;
        nAplQty8 WITH lnApQTy8  ,;
        nAplQty  WITH lnApTotQty ,;
        nAplAmnt WITH lnApAmount ,;
        nInvQty1 WITH MAX(MFGOPRDT.nLotQty1-lnApQty1,0),;
        nInvQty2 WITH MAX(MFGOPRDT.nLotQty2-lnApQty2,0),;
        nInvQty3 WITH MAX(MFGOPRDT.nLotQty3-lnApQty3,0),;
        nInvQty4 WITH MAX(MFGOPRDT.nLotQty4-lnApQty4,0),;
        nInvQty5 WITH MAX(MFGOPRDT.nLotQty5-lnApQty5,0),;
        nInvQty6 WITH MAX(MFGOPRDT.nLotQty6-lnApQty6,0),;
        nInvQty7 WITH MAX(MFGOPRDT.nLotQty7-lnApQty7,0),;
        nInvQty8 WITH MAX(MFGOPRDT.nLotQty8-lnApQty8,0),;
        nInvQty  WITH MAX(MFGOPRDT.nLotTotQty-lnApTotQty,0),;
        nInvAmnt WITH MAX(MFGOPRDT.nLotTotQty*BomLine.UnitCost-lnApAmount,0)

      REPLACE cSelect  WITH IIF(lcTktType= 'S' .AND. loFormSet.POSHDR.SEEK("PP"+MFGOPRDT.cTktNo) .AND. POSHDR.STATUS="S","",""),; &&sql Check Key
      ITEM     WITH MFGOPRDT.ITEM   ,;
        COLOR    WITH IIF(INLIST(lcTktType,'L','F','T'),SUBSTR(MFGOPRDT.ITEM,loFormSet.lnFabClrStart,loFormSet.lnFabClrLen),'')  ,;
        nTktQty1 WITH MFGOPRDT.nLotQty1,;
        nTktQty2 WITH MFGOPRDT.nLotQty2,;
        nTktQty3 WITH MFGOPRDT.nLotQty3,;
        nTktQty4 WITH MFGOPRDT.nLotQty4,;
        nTktQty5 WITH MFGOPRDT.nLotQty5,;
        nTktQty6 WITH MFGOPRDT.nLotQty6,;
        nTktQty7 WITH MFGOPRDT.nLotQty7,;
        nTktQty8 WITH MFGOPRDT.nLotQty8,;
        nTktQty  WITH MFGOPRDT.nLotTotQty,;
        nTktCst  WITH BomLine.UnitCost ,;
        nTktAmnt WITH MFGOPRDT.nLotTotQty*BomLine.UnitCost,;
        nAplQty1 WITH lnApQTy1  ,;
        nAplQty2 WITH lnApQTy2  ,;
        nAplQty3 WITH lnApQTy3  ,;
        nAplQty4 WITH lnApQTy4  ,;
        nAplQty5 WITH lnApQTy5  ,;
        nAplQty6 WITH lnApQTy6  ,;
        nAplQty7 WITH lnApQTy7  ,;
        nAplQty8 WITH lnApQTy8  ,;
        nAplQty  WITH lnApTotQty ,;
        nAplAmnt WITH lnApAmount ,;
        nInvQty1 WITH MAX(MFGOPRDT.nLotQty1-lnApQty1,0),;
        nInvQty2 WITH MAX(MFGOPRDT.nLotQty2-lnApQty2,0),;
        nInvQty3 WITH MAX(MFGOPRDT.nLotQty3-lnApQty3,0),;
        nInvQty4 WITH MAX(MFGOPRDT.nLotQty4-lnApQty4,0),;
        nInvQty5 WITH MAX(MFGOPRDT.nLotQty5-lnApQty5,0),;
        nInvQty6 WITH MAX(MFGOPRDT.nLotQty6-lnApQty6,0),;
        nInvQty7 WITH MAX(MFGOPRDT.nLotQty7-lnApQty7,0),;
        nInvQty8 WITH MAX(MFGOPRDT.nLotQty8-lnApQty8,0),;
        nInvQty  WITH MAX(MFGOPRDT.nLotTotQty-lnApTotQty,0),;
        nInvAmnt WITH MAX(MFGOPRDT.nLotTotQty*BomLine.UnitCost-lnApAmount,0)

      *B608100,1 WAM 05/28/2007 (End)
    ENDSCAN
  ENDIF
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  SELECT APVINVDT
  gfSETORDER('Orgvinv')
 *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  GO TOP IN (loFormSet.lcAutoInv)
  SELECT (lnAlias)

  RETURN(!EOF(loFormSet.lcAutoInv))
  *-- End of lfGenInvLn


  *!*************************************************************
  *! Name      : lfvAASAct
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 09/02/2004
  *! Purpose   : To get the WIP account based on Gl link.
  *!*************************************************************
  *! Parameters: The FormSet of APPYINV.SCX, The Form of APINVDT.SCX, lcLinkCode, lcCatKey
  *!*************************************************************
  *B603827,1 AKA 10/23/2001
  *!*************************************************************
FUNCTION lfvAASAct
  LPARAMETERS loFormSet, loForm, lcLinkCode, lcCatKey

  PRIVATE lcGlAcnt
  lcGlAcnt= ''
  IF loFormSet.AriaForm1.ap1.llApGlLink
    IF SEEK(lcLinkCode+lcCatKey,'GL_LINK')
      lcGlAcnt = GL_LINK.GLACNT
      IF !SEEK(lcGlAcnt,'lcLinkChar')
        lcGlAcnt = ''
      ENDIF
    ELSE
      =SEEK('DEFDEF','GL_LINK')
      lcGlAcnt = GL_LINK.GLACNT
    ENDIF
  ELSE
    STORE loFormSet.lcDistAcct TO lcGlAcnt
  ENDIF

  RETURN lcGlAcnt
  *-- End of lfvAASAct

  ***NNN***



  ***AAA***

  *!*************************************************************
  *! Name      : lfAutoInit
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 09/12/2004
  *! Purpose   : Called From theInit Event of the Auto Button of APInvDt.SCx
  *!*************************************************************
  *! Parameters: The FormSet of APPYINV.SCX, The Form of APINVDT.SCX, The Form of APAINVD.SCX
  *!*************************************************************
  *! Returns   :  None
  *!*************************************************************
FUNCTION lfAutoInit
  LPARAMETERS loFormSet, loForm, loAutoForm

  *ASM, Add Properties to the form [Start]
  lcAllVar = "llFirst,laAplCst,laTickets,laAplLots,lcMfgCode,lcAplLotNo,lcWIPAcnt"

  DIMENSION laAllVar[1,1]
  STORE '' TO laAllVar
  =gfSubStr(lcAllVar,@laAllVar,',')

  LOCAL lnI
  FOR lnI = 1 TO ALEN(laAllVar,1)
    IF LOWER(LEFT(laAllVar[lnI,1],2)) <> 'la'
      PRIVATE &laAllVar[lnI,1].
    ENDIF
  ENDFOR
  DECLARE laAplCst[1,3], laTickets[1,3], laAplLots[1]

  =lfAddPro(loAutoForm)

  *ASM, Add Properties to the form [End]

  loAutoForm.llFirst = .T.
  lcAInvDtBr = 'Document Lines'
  STORE 0         TO loAutoForm.cboLotNo.VALUE
  STORE SPACE(24) TO loAutoForm.glApDGlAct.KeyTextBox.VALUE
  STORE SPACE(6)  TO loAutoForm.kbInvTktNo.KeyTextBox.VALUE
  STORE 1         TO loAutoForm.cboTktType.VALUE, loAutoForm.cboCostType.VALUE, loAutoForm.cboMFGOpr.VALUE
  STORE ''        TO loAutoForm.laAplCst, loAutoForm.lcMfgCode, loAutoForm.kbRSession.KeyTextBox.VALUE, loAutoForm.lcWIPAcnt
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *STORE 'N/A'     TO loForm.laOprLots[1]
  STORE 'N/A'     TO loFormSet.laOprLots[1]
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  STORE SPACE(2)  TO loAutoForm.lcAplLotNo
  loAutoForm.laTickets[1,1] = 'Select Document Type'
  loAutoForm.laTickets[1,2] = ' '
  loAutoForm.laTickets[1,3] = 'Document#'
  loAutoForm.laAplCst[1,1]  = 'Select Cost Type'
  loAutoForm.laAplCst[1,2]  = ' '
  loAutoForm.laAplCst[1,3]  = ' '
  *Old: SET ORDER TO TAG BOMPOREC IN BOMLINE
  loFormSet.BOMLINE.SetOrder('BOMPOREC') &&Sql105: Check Tag ;
  *CIMTYP+CTYPE+CBOMTYP+MFGCODE+CTKTNO+CRSESSION+SHIPNO+STR(LINENO,6)+CINVTYPE+STYLE+CSTYGRADE ;
  (CIMTYP+CTYPE+CBOMTYP+MFGCODE+CTKTNO+CRSESSION+SHIPNO+STR(LINENO,6)+STYLE+SCLR+CSTYGRADE)
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  loFormSet.laCodes[1,2] = "_Screen.ActiveForm.Parent.CallingFormSet.laMfgCode"
  loFormSet.laCodes[1,3] = "_Screen.ActiveForm.cboMFGOpr.Value"
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  SELECT (loFormSet.lcAutoInv)
  ZAP

  *ASM, Initally Disable the Controls [Begin]
  WITH loAutoForm
    STORE .F. TO .cboTktType.ENABLED, .kbInvTktNo.ENABLED, .cboCostType.ENABLED, ;
      .cboMFGOpr.ENABLED, .kbRSession.ENABLED, .cboLotNo.ENABLED, .glApDGlAct.ENABLED, ;
      .cmdGenerate.ENABLED, .cmdClear.ENABLED
    STORE .F. TO .cmdSelect.ENABLED, .cmdSelAll.ENABLED, .cmdSelNone.ENABLED, .cmdInvert.ENABLED, ;
      .cmdProceed.ENABLED, .cmdClose.ENABLED
  ENDWITH
  STORE .T. TO loAutoForm.cboTktType.ENABLED, loAutoForm.cmdClose.ENABLED
  *ASM, Initally Disable the Controls [End]

  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  loFormSet.laMfgRFld[1,2] = '_Screen.ActiveForm.Parent.CallingFormSet.lcMfgGlAcnt'
  *loFormSet.laMfgRFld[1,2] = '_Screen.ActiveForm.Parent.lcMfgGlAcnt'
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]


  SET ENGINEBEHAVIOR 70

  *Raise Flag to .T. while we are in this screen
  loFormSet.llAutoScr = .T.

  RETURN
  *-- End of lfAutoInit


  *!*************************************************************
  *! Name      : lfAutoDestroy
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 09/12/2004
  *! Purpose   : Called From the Destroy Event of APAINVD.SCx
  *!*************************************************************
  *! Parameters: The FormSet of APPYINV.SCX, The Form of APINVDT.SCX, The Form of APAINVD.SCX
  *!*************************************************************
  *! Returns   :  None
  *!*************************************************************
FUNCTION lfAutoDestroy
  LPARAMETERS loFormSet, loForm, loAutoForm

  loFormSet.llAutoScr = .F.

  SELECT(loFormSet.lcAPvInvDt)
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*	loFormSet.laCodes[1,2] = "_Screen.ActiveForm.Parent.CallingForm.Parent.laMfgCode"
  *!*	loFormSet.laCodes[1,3] = "_Screen.ActiveForm.Parent.CallingForm.Parent.lnMfgOpr"
  *!*	loFormSet.laMfgRFld[1,2] = '_Screen.ActiveForm.Parent.CallingForm.Parent.lcMfgGlAcnt'
  loFormSet.laCodes[1,2] = "_Screen.ActiveForm.Parent.laMfgCode"
  loFormSet.laCodes[1,3] = "_Screen.ActiveForm.Parent.lnMfgOpr"
  loFormSet.laMfgRFld[1,2] = '_Screen.ActiveForm.Parent.lcMfgGlAcnt'
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  *=lfwInvDt(loFormSet, loForm, loAutoForm)
  *=lfRefresh('APINVD10')

  RETURN
  *-- End of lfvAutoDestroy


  *!*************************************************************
  *! Name      : lfAInvBrow
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 09/12/2004
  *! Purpose   : Browse Ticket lines to invoice in APAINVD.SCX
  *!*************************************************************
  *! Parameters: The FormSet of APPYINV.SCX, The Form of APINVDT.SCX, The Form of APAINVD.SCX
  *!*************************************************************
  *! Returns   :  None
  *!*************************************************************
FUNCTION lfAInvBrow
  LPARAMETERS loFormSet, loForm, loAutoForm
  LOCAL lnCol

  SELECT (loFormSet.lcAutoInv)
  WITH loAutoForm.grdAutoLines

    .COLUMNCOUNT = 0
    .RECORDSOURCE = loFormSet.lcAutoInv
    lnCol='0'
    lnCol = ALLTRIM(STR(VAL(lnCol)+1))
    .COLUMNCOUNT = VAL(lnCol)
    .COLUMN&lnCol..CONTROLSOURCE = "CSELECT"
    .COLUMN&lnCol..Header1.CAPTION = ' '
    .COLUMN&lnCol..WIDTH = 15

    DO CASE
      CASE EMPTY(loAutoForm.laTickets[1,2])
        lnCol = ALLTRIM(STR(VAL(lnCol)+1))
        .COLUMNCOUNT = VAL(lnCol)
        .COLUMN&lnCol..CONTROLSOURCE = "Item"
        .COLUMN&lnCol..Header1.CAPTION = 'Item'
        .COLUMN&lnCol..WIDTH = 100
      CASE INLIST(loAutoForm.laTickets[loAutoForm.cboTktType.Value,2],'T','L','F')
        lnCol = ALLTRIM(STR(VAL(lnCol)+1))
        .COLUMNCOUNT = VAL(lnCol)
        .COLUMN&lnCol..CONTROLSOURCE = "SUBSTR(Item,1,"+ALLTRIM(STR(loFormSet.lnFabMajLen))+")"
        .COLUMN&lnCol..Header1.CAPTION = 'Fabric'
        .COLUMN&lnCol..WIDTH = 70
        lnCol = ALLTRIM(STR(VAL(lnCol)+1))
        .COLUMNCOUNT = VAL(lnCol)
        .COLUMN&lnCol..CONTROLSOURCE = "Color"
        .COLUMN&lnCol..Header1.CAPTION = 'Color'
        IF loFormSet.laSetups[2,2]='Y'
          lnCol = ALLTRIM(STR(VAL(lnCol)+1))
          .COLUMNCOUNT = VAL(lnCol)
          .COLUMN&lnCol..CONTROLSOURCE = "cDyelot"
          .COLUMN&lnCol..Header1.CAPTION = 'Dyelot'
          .COLUMN&lnCol..WIDTH = 30
        ENDIF
      CASE INLIST(loAutoForm.laTickets[loAutoForm.cboTktType.Value,2],'S','I','M','R','A','D')
        IF loAutoForm.laTickets[loAutoForm.cboTktType.Value,2]='S'
          lnCol = ALLTRIM(STR(VAL(lnCol)+1))
          .COLUMNCOUNT = VAL(lnCol)
          .COLUMN&lnCol..CONTROLSOURCE = "cTktNo"
          .COLUMN&lnCol..Header1.CAPTION = 'PO#'
          lnCol = ALLTRIM(STR(VAL(lnCol)+1))
          .COLUMNCOUNT = VAL(lnCol)
          .COLUMN&lnCol..CONTROLSOURCE = "cWIPAcct"
          .COLUMN&lnCol..Header1.CAPTION = 'WIP A/C'
        ENDIF
        lnCol = ALLTRIM(STR(VAL(lnCol)+1))
        .COLUMNCOUNT = VAL(lnCol)
        .COLUMN&lnCol..CONTROLSOURCE = "Item"
        .COLUMN&lnCol..Header1.CAPTION = loForm.cntStyle.lblItemHeader.CAPTION
        .COLUMN&lnCol..WIDTH = 100
        IF loFormSet.laSetups[1,2]='Y'
          lnCol = ALLTRIM(STR(VAL(lnCol)+1))
          .COLUMNCOUNT = VAL(lnCol)
          .COLUMN&lnCol..CONTROLSOURCE = "cDyelot"
          .COLUMN&lnCol..Header1.CAPTION = 'Dyelot'
        ENDIF
    ENDCASE

    IF EMPTY(loAutoForm.kbRSession.KeyTextBox.VALUE)
      lnCol = ALLTRIM(STR(VAL(lnCol)+1))
      .COLUMNCOUNT = VAL(lnCol)
      .COLUMN&lnCol..CONTROLSOURCE = "nTktQty"
      .COLUMN&lnCol..Header1.CAPTION = 'Bud. Qty.'
      lnCol = ALLTRIM(STR(VAL(lnCol)+1))
      .COLUMNCOUNT = VAL(lnCol)
      .COLUMN&lnCol..CONTROLSOURCE = "nTktCst"
      .COLUMN&lnCol..Header1.CAPTION = 'Bud. Cost'
      lnCol = ALLTRIM(STR(VAL(lnCol)+1))
      .COLUMNCOUNT = VAL(lnCol)
      .COLUMN&lnCol..CONTROLSOURCE = "nTktAmnt"
      .COLUMN&lnCol..Header1.CAPTION = 'Bud. Amnt.'
    ELSE
      lnCol = ALLTRIM(STR(VAL(lnCol)+1))
      .COLUMNCOUNT = VAL(lnCol)
      .COLUMN&lnCol..CONTROLSOURCE = "IIF(cRecvType='R','Receive',IIF(cRecvType='S','Sec Qlty.','Damaged'))"
      .COLUMN&lnCol..Header1.CAPTION = 'Type'
      lnCol = ALLTRIM(STR(VAL(lnCol)+1))
      .COLUMNCOUNT = VAL(lnCol)
      .COLUMN&lnCol..CONTROLSOURCE = "nTktQty"
      .COLUMN&lnCol..Header1.CAPTION = 'Rec. Qty.'
      lnCol = ALLTRIM(STR(VAL(lnCol)+1))
      .COLUMNCOUNT = VAL(lnCol)
      .COLUMN&lnCol..CONTROLSOURCE = "nTktCst"
      .COLUMN&lnCol..Header1.CAPTION = 'Rec. Cost'
      lnCol = ALLTRIM(STR(VAL(lnCol)+1))
      .COLUMNCOUNT = VAL(lnCol)
      .COLUMN&lnCol..CONTROLSOURCE = "ROUND(nTktAmnt,2)"
      .COLUMN&lnCol..Header1.CAPTION = 'Rec. Amnt.'

      loForm.lcTktType = loAutoForm.laTickets[loAutoForm.cboTktType.Value,2]
      IF loForm.lcTktType $ 'RF'
        lnCol = ALLTRIM(STR(VAL(lnCol)+1))
        .COLUMNCOUNT = VAL(lnCol)
        .COLUMN&lnCol..CONTROLSOURCE = "IIF(cRecvType='R','Receive',IIF(cRecvType='S','Sec Qlty.','Damaged'))"
        .COLUMN&lnCol..Header1.CAPTION = 'Type'
        lnCol = ALLTRIM(STR(VAL(lnCol)+1))
        .COLUMNCOUNT = VAL(lnCol)
        .COLUMN&lnCol..CONTROLSOURCE = "nTktQty"
        .COLUMN&lnCol..Header1.CAPTION = 'Issue Qty.'
        lnCol = ALLTRIM(STR(VAL(lnCol)+1))
        .COLUMNCOUNT = VAL(lnCol)
        .COLUMN&lnCol..CONTROLSOURCE = "nTktCst"
        .COLUMN&lnCol..Header1.CAPTION = 'Issue Cost'
        lnCol = ALLTRIM(STR(VAL(lnCol)+1))
        .COLUMNCOUNT = VAL(lnCol)
        .COLUMN&lnCol..CONTROLSOURCE = "ROUND(nTktAmnt,2)"
        .COLUMN&lnCol..Header1.CAPTION = 'Issue Amnt.'
      ENDIF
    ENDIF

    lnCol = ALLTRIM(STR(VAL(lnCol)+1))
    .COLUMNCOUNT = VAL(lnCol)
    .COLUMN&lnCol..CONTROLSOURCE = "nInvQty"
    .COLUMN&lnCol..Header1.CAPTION = 'Inv. Qty.'
    lnCol = ALLTRIM(STR(VAL(lnCol)+1))
    .COLUMNCOUNT = VAL(lnCol)
    .COLUMN&lnCol..CONTROLSOURCE = "IIF(nInvQty=0,0,nInvAmnt/nInvQty)"
    .COLUMN&lnCol..Header1.CAPTION = 'Inv. Cost'
    .COLUMN&lnCol..INPUTMASK='999999999.999'
    lnCol = ALLTRIM(STR(VAL(lnCol)+1))
    .COLUMNCOUNT = VAL(lnCol)
    .COLUMN&lnCol..CONTROLSOURCE = "ROUND(nInvAmnt,2)"
    .COLUMN&lnCol..Header1.CAPTION = 'Inv. Amnt.'
    lnCol = ALLTRIM(STR(VAL(lnCol)+1))
    .COLUMNCOUNT = VAL(lnCol)
    .COLUMN&lnCol..CONTROLSOURCE = "nAplQty"
    .COLUMN&lnCol..Header1.CAPTION = 'Apl. Qty.'
    lnCol = ALLTRIM(STR(VAL(lnCol)+1))
    .COLUMNCOUNT = VAL(lnCol)
    .COLUMN&lnCol..CONTROLSOURCE = "IIF(nAplQty=0,0,nAplAmnt/nAplQty)"
    .COLUMN&lnCol..Header1.CAPTION = 'Apl. Cost'
    lnCol = ALLTRIM(STR(VAL(lnCol)+1))
    .COLUMNCOUNT = VAL(lnCol)
    .COLUMN&lnCol..CONTROLSOURCE = "ROUND(nAplAmnt,2)"
    .COLUMN&lnCol..Header1.CAPTION = 'Apl. Amnt.'

    IF INLIST(loAutoForm.laTickets[loAutoForm.cboTktType.Value,2],'S','I','M','R','A','D')

      FOR lnC=1 TO 8
        lnCol = ALLTRIM(STR(VAL(lnCol)+1))
        .COLUMNCOUNT = VAL(lnCol)
        .COLUMN&lnCol..CONTROLSOURCE = "nTktQty"+ALLTRIM(STR(lnC))
        .COLUMN&lnCol..Header1.CAPTION = 'Doc Qty'+ALLTRIM(STR(lnC))
      NEXT

      FOR lnC=1 TO 8
        lnCol = ALLTRIM(STR(VAL(lnCol)+1))
        .COLUMNCOUNT = VAL(lnCol)
        .COLUMN&lnCol..CONTROLSOURCE = "nInvQty"+ALLTRIM(STR(lnC))
        .COLUMN&lnCol..Header1.CAPTION = 'Inv Qty'+ALLTRIM(STR(lnC))
      NEXT

      FOR lnC=1 TO 8
        lnCol = ALLTRIM(STR(VAL(lnCol)+1))
        .COLUMNCOUNT = VAL(lnCol)
        .COLUMN&lnCol..CONTROLSOURCE = "nAplQty"+ALLTRIM(STR(lnC))
        .COLUMN&lnCol..Header1.CAPTION = 'Apl Qty'+ALLTRIM(STR(lnC))
      NEXT

    ENDIF

  ENDWITH

  RETURN
  *-- End of lfAInvBrow



  *!*************************************************************
  *! Name      : lfwAInvDt
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 09/12/2004
  *! Purpose   : Called from the AfterRowColChange Event of the grid in APAINVD.SCX
  *!*************************************************************
  *! Parameters: The FormSet of APPYINV.SCX, The Form of APINVDT.SCX, The Form of APAINVD.SCX
  *!*************************************************************
  *! Returns   :  None
  *!*************************************************************
FUNCTION lfwAInvDt
  LPARAMETERS loFormSet, loForm, loAutoForm

  IF cSelect = SPACE(1)
    *Old: SHOW GET pbSelect,1 PROMPT '\<Select' &&Revise
    loAutoForm.cmdSelect.CAPTION='\<Select'
  ELSE
    *Old: SHOW GET pbSelect,1 PROMPT 'Un\<Select' &&Revise
    loAutoForm.cmdSelect.CAPTION='Un\<Select'
  ENDIF


  *Do not edit any invoices which have a closed PO in case of Auto Contr Shipment case
  *IF loAutoForm.laTickets[loAutoForm.cboTktType.Value,2] = "S"  .AND. SEEK("P"+CtktNo,"POSHDR") .AND. ;
  POSHDR.Status = "S"
  IF loAutoForm.laTickets[loAutoForm.cboTktType.Value,2] = "S"  .AND. ;
      loFormSet.POSHDR.SEEK("PP"+CtktNo) .AND. POSHDR.STATUS = "S"
    REPLACE cSelect WITH IIF(cSelect <> SPACE(1) ,SPACE(1),cSelect)
    *Old: SHOW GET pbSelect  DISABLE &&Revise
    *Old: SHOW GET pbSelAll  DISABLE &&Revise
    *Old: SHOW GET pbSelNone DISABLE &&Revise
    *Old: SHOW GET pbInvert  DISABLE &&Revise
    STORE .F. TO loAutoForm.cmdSelect.ENABLED, loAutoForm.cmdSelAll.ENABLED, ;
      loAutoForm.cmdSelNone.ENABLED, loAutoForm.cmdInvert.ENABLED
  ELSE
    *Old: SHOW GET pbSelect  ENABLE &&Revise
    *Old: SHOW GET pbSelAll  ENABLE &&Revise
    *Old: SHOW GET pbSelNone ENABLE &&Revise
    *Old: SHOW GET pbInvert  ENABLE &&Revise
    STORE .T. TO loAutoForm.cmdSelect.ENABLED, loAutoForm.cmdSelAll.ENABLED, ;
      loAutoForm.cmdSelNone.ENABLED, loAutoForm.cmdInvert.ENABLED
  ENDIF

  RETURN
  *-- End of lfwAInvDt


  *!*************************************************************
  *! Name      : lfwATktType
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 09/12/2004
  *! Purpose   : Create Array with available Document Types. Called from the When event
  *!             of cboTktType in APAINVD.SCX
  *!*************************************************************
  *! Parameters: The FormSet of APPYINV.SCX, The Form of APINVDT.SCX, The Form of APAINVD.SCX
  *!*************************************************************
  *! Returns   :  None
  *!*************************************************************
FUNCTION lfwATktType
  LPARAMETERS loFormSet, loForm, loAutoForm

  IF loAutoForm.llFirst
    loAutoForm.llFirst = .F.
    RETURN(.F.)
  ENDIF
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *IF loForm.laTktType[1,2]='G'
  *!*	  DECLARE loAutoForm.laTickets[ALEN(loForm.laTktType,1)-1,3]
  *!*	  =ACOPY(loForm.laTktType,loAutoForm.laTickets,4)
  IF loFormSet.laTktType[1,2]='G'
    DECLARE loAutoForm.laTickets[ALEN(loFormSet.laTktType,1)-1,3]
    =ACOPY(loFormSet.laTktType,loAutoForm.laTickets,4)
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  ELSE
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
    *!*	  DECLARE loAutoForm.laTickets[ALEN(loForm.laTktType,1),3]
    *!*	  =ACOPY(loForm.laTktType,loAutoForm.laTickets)
    DECLARE loAutoForm.laTickets[ALEN(loFormSet.laTktType,1),3]
    =ACOPY(loFormSet.laTktType,loAutoForm.laTickets)
    *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  ENDIF
  *Old: SHOW GET loAutoForm.cboTktType  &&Revise
  loAutoForm.cboTktType.REQUERY()

  RETURN
  *-- End of lfwATktType



  *!*************************************************************
  *! Name      : lfvATktType
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 09/12/2004
  *! Purpose   : Validate Selected Document Types. Called from the Valid event
  *!             of cboTktType in APAINVD.SCX
  *!*************************************************************
  *! Parameters: The FormSet of APPYINV.SCX, The Form of APINVDT.SCX, The Form of APAINVD.SCX
  *!*************************************************************
  *! Returns   :  None
  *!*************************************************************
FUNCTION lfvATktType
  LPARAMETERS loFormSet, loForm, loAutoForm

  *=lfRefresh('APAINVD0')
  *Old: SHOW GET loAutoForm.cboTktType DISABLE  &&Revise
  *Old: SHOW GET ibTktNo  ENABLE &&Revise
  *Old: SHOW GET loAutoForm.kbInvTktNo  ENABLE  &&Revise
  *SHOW GET lnAplCst ENABLE
  loAutoForm.cboTktType.ENABLED = .F.
  loAutoForm.kbInvTktNo.ENABLED = .T.

  RETURN 1
  *-- End of lfvATktType



  *!*************************************************************
  *! Name      : lfvAutoTkt
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 09/12/2004
  *! Purpose   : Validate Selected Document #. Called from the Valid event
  *!             of kbInvTktNo in APAINVD.SCX
  *!*************************************************************
  *! Parameters: The FormSet of APPYINV.SCX, The Form of APINVDT.SCX, The Form of APAINVD.SCX
  *!*************************************************************
  *! Returns   :  None
  *!*************************************************************
FUNCTION lfvAutoTkt
  LPARAMETERS loFormSet, loForm, loAutoForm

  loFormSet.llBrowse = loAutoForm.kbInvTktNo.Selectedfrombrowse

  PRIVATE lcLinkCode
  STORE SPACE(6) TO lcLinkCode
  kbInvTktNo=loAutoForm.kbInvTktNo.KeyTextBox.VALUE
  =lfvTicket(loFormSet,loForm,loAutoForm.laTickets[loAutoForm.cboTktType.Value,2],@kbInvTktNo,@lcLinkCode,;
    loAutoForm.laAplCst[loAutoForm.cboCostType.Value,2])
  loAutoForm.kbInvTktNo.KeyTextBox.VALUE=kbInvTktNo
  IF loFormSet.laSetups[3,2]='Y'
    IF !SEEK(lcLinkCode+'013','GL_LINK')
      =SEEK('DEFDEF'+'013','GL_LINK')
    ENDIF
    STORE GL_Link.GlAcnt TO loAutoForm.glApDGlAct.KeyTextBox.VALUE,loAutoForm.lcWIPAcnt
  ELSE
    STORE loFormSet.lcDistAcct TO loAutoForm.glApDGlAct.KeyTextBox.VALUE,loAutoForm.lcWIPAcnt
  ENDIF

  IF !EMPTY(loAutoForm.kbInvTktNo.KeyTextBox.VALUE)
    *Old: SHOW GET ibTktNo  DISABLE &&Revise
    *Old: SHOW GET loAutoForm.kbInvTktNo  DISABLE  &&Revise
    *Old: SHOW GET loAutoForm.cboCostType ENABLE   &&Revise
    loAutoForm.kbInvTktNo.ENABLED = .F.
    loAutoForm.cboCostType.ENABLED = .T.
  ENDIF
  loFormSet.llBrowse = .F.
  loAutoForm.kbInvTktNo.Selectedfrombrowse = .F.

  RETURN
  *-- End of lfvAutoTkt


  *!*************************************************************
  *! Name      : lfwAplCst
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 09/12/2004
  *! Purpose   : Create Array with available cost types. Called from the When event
  *!             of cboCostType in APAINVD.SCX
  *!*************************************************************
  *! Parameters: The FormSet of APPYINV.SCX, The Form of APINVDT.SCX, The Form of APAINVD.SCX
  *!*************************************************************
  *! Returns   :  None
  *!*************************************************************
FUNCTION lfwAplCst
  LPARAMETERS loFormSet, loForm, loAutoForm

  IF EMPTY(loAutoForm.laAplCst[1,2])
    DO CASE
      CASE INLIST(loAutoForm.laTickets[loAutoForm.cboTktType.Value,2],'I','S','M','R')
        lcAryName = IIF(loAutoForm.laTickets[loAutoForm.cboTktType.Value,2]='M','loFormSet.laMCstType','loFormSet.laICstType')
        DECLARE loAutoForm.laAplCst[ALEN(&lcAryName,1),3]
        =ACOPY(&lcAryName,loAutoForm.laAplCst)

      CASE INLIST(loAutoForm.laTickets[loAutoForm.cboTktType.Value,2],'T','L','F')
        lcAryName = IIF(loAutoForm.laTickets[loAutoForm.cboTktType.Value,2]='T','loFormSet.laTCstType','loFormSet.laLCstType')
        DECLARE loAutoForm.laAplCst[ALEN(&lcAryName,1),3]
        =ACOPY(&lcAryName,loAutoForm.laAplCst)

      CASE INLIST(loAutoForm.laTickets[loAutoForm.cboTktType.Value,2],'A')
        lcAryName = IIF(loAutoForm.laTickets[loAutoForm.cboTktType.Value,2]='A','loFormSet.laACstType','loFormSet.laICstType')
        DECLARE loAutoForm.laAplCst[ALEN(&lcAryName,1),3]
        =ACOPY(&lcAryName,loAutoForm.laAplCst)

      CASE INLIST(loAutoForm.laTickets[loAutoForm.cboTktType.Value,2],'D')
        lcAryName = IIF(loAutoForm.laTickets[loAutoForm.cboTktType.Value,2]='D','loFormSet.laMCstType','loFormSet.laICstType')
        DECLARE loAutoForm.laAplCst[ALEN(&lcAryName,1),3]
        =ACOPY(&lcAryName,loAutoForm.laAplCst)

    ENDCASE
    *Old: SHOW GET loAutoForm.cboCostType  &&Revise
    loAutoForm.cboCostType.REQUERY()

  ENDIF

  RETURN
  *-- End of lfwAplCst


  *!*************************************************************
  *! Name      : lfvAplCst
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 09/12/2004
  *! Purpose   : Validate Selected Cost Type. Called from the Valid event
  *!             of cboCostType in APAINVD.SCX
  *!*************************************************************
  *! Parameters: The FormSet of APPYINV.SCX, The Form of APINVDT.SCX, The Form of APAINVD.SCX
  *!*************************************************************
  *! Returns   :  None
  *!*************************************************************
FUNCTION lfvAplCst
  LPARAMETERS loFormSet, loForm, loAutoForm

  IF loAutoForm.laAplCst[loAutoForm.cboCostType.Value,3] = 'M'
    loAutoForm.cboMFGOpr.VALUE =1
    DIMENSION lacode[ALEN(loFormSet.laCodes,1),ALEN(loFormSet.laCodes,2)]
    =ACOPY(loFormSet.laCodes,laCodes)
    =gfwCodePop(@laCodes,'MFGCODE','L')
    =ACOPY(laCodes,loFormSet.laCodes)
    loAutoForm.lcMfgCode=loFormSet.laMfgCode[loAutoForm.cboMFGOpr.Value,2]

    *Old: SHOW GET loAutoForm.cboMFGOpr ENABLE  &&Revise
    *Check that the Document currency same as invoice currency [BEGIN]
    *Old: SHOW GET loAutoForm.cboCostType   DISABLE   &&Revise
    *Old: SHOW GET ibRSession ENABLE &&Revise
    *Old: SHOW GET loAutoForm.kbRSession ENABLE  &&Revise
    *Old: SHOW GET ibWIPAcnt  ENABLE &&Revise
    *Old: SHOW GET loAutoForm.glApDGlAct.KeyTextBox.Value ENABLE &&Revise
    *Old: SHOW GET pbGenerate ENABLE &&Revise
    loAutoForm.cboCostType.ENABLED = .F.
    STORE .T. TO loAutoForm.cboMFGOpr.ENABLED, loAutoForm.kbRSession.ENABLED, ;
      loAutoForm.glApDGlAct.ENABLED, loAutoForm.cmdGenerate.ENABLED
    *Check that the Document currency same as invoice currency [END]
  ELSE
    *Check that the Document currency same as invoice currency [BEGIN]
    IF lfChkCstCur(loFormSet,loForm,loAutoForm.laTickets[loAutoForm.cboTktType.Value,2],;
        loAutoForm.kbInvTktNo.KeyTextBox.VALUE,;
        loAutoForm.laAplCst[loAutoForm.cboCostType.Value,3])
      DIMENSION lacode[ALEN(loFormSet.laCodes,1),ALEN(loFormSet.laCodes,2)]
      =ACOPY(loFormSet.laCodes,laCodes)
      =gfwCodePop(@laCodes,'MFGCODE','N')
      =ACOPY(laCodes,loFormSet.laCodes)
      *Old: SHOW GET loAutoForm.cboMFGOpr DISABLE   &&Revise
      loAutoForm.cboMFGOpr.ENABLED = .F.
      loAutoForm.lcMfgCode=REPLICATE(IIF(loAutoForm.laAplCst[loAutoForm.cboCostType.Value,3]='P','*',;
        IIF(loAutoForm.laAplCst[loAutoForm.cboCostType.Value,3]='D','#',' ')),6)
      *Old: SHOW GET loAutoForm.cboCostType   DISABLE  &&Revise
      *Old: SHOW GET ibRSession ENABLE &&Revise
      *Old: SHOW GET loAutoForm.kbRSession ENABLE  &&Revise
      *Old: SHOW GET ibWIPAcnt  ENABLE &&Revise
      *Old: SHOW GET loAutoForm.glApDGlAct.KeyTextBox.Value ENABLE &&Revise
      *Old: SHOW GET pbGenerate ENABLE &&Revise
      loAutoForm.cboCostType.ENABLED = .F.
      STORE .T. TO loAutoForm.kbRSession.ENABLED, loAutoForm.glApDGlAct.ENABLED, ;
        loAutoForm.cmdGenerate.ENABLED
    ELSE
      *Old: SHOW GET ibTktNo  ENABLE &&Revise
      *Old: SHOW GET loAutoForm.kbInvTktNo  ENABLE   &&Revise
      *Old: SHOW GET loAutoForm.cboCostType DISABLE   &&Revise
      *_CUROBJ = OBJNUM(loAutoForm.kbInvTktNo)  &&Old CurObj
      loAutoForm.kbInvTktNo.ENABLED = .T.
      loAutoForm.cboCostType.ENABLED = .F.
      loAutoForm.kbInvTktNo.KeyTextBox.SETFOCUS()
    ENDIF
    *Check that the Document currency same as invoice currency [END]
  ENDIF

  RETURN 1
  *-- End of lfvAplCst

  *!*************************************************************
  *! Name      : lfwAplOpr
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 09/12/2004
  *! Purpose   : Called from the When event of cboMFGOpr in APAINVD.SCX
  *!*************************************************************
  *! Parameters: The FormSet of APPYINV.SCX, The Form of APINVDT.SCX, The Form of APAINVD.SCX
  *!*************************************************************
  *! Returns   :  None
  *!*************************************************************
FUNCTION lfwAplOpr
  LPARAMETERS loFormSet, loForm, loAutoForm

  DIMENSION laCodes[ALEN(loFormSet.laCodes,1),ALEN(loFormSet.laCodes,2)]
  =ACOPY(loFormSet.laCodes,laCodes)
  =gfwCodePop(@laCodes,'MFGCODE','L')
  =ACOPY(laCodes,loFormSet.laCodes)
  loAutoForm.cboMFGOpr.REQUERY()
  RETURN
  *-- End of lfwAplOpr


  *!*************************************************************
  *! Name      : lfvAplOpr
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 09/12/2004
  *! Purpose   : Validate Selected MFG Operation. Called from the Valid event
  *!             of cboMFGOpr in APAINVD.SCX
  *!*************************************************************
  *! Parameters: The FormSet of APPYINV.SCX, The Form of APINVDT.SCX, The Form of APAINVD.SCX
  *!*************************************************************
  *! Returns   :  None
  *!*************************************************************
FUNCTION lfvAplOpr
  LPARAMETERS loFormSet, loForm, loAutoForm

  loAutoForm.lcMfgCode=loFormSet.laMfgCode[loAutoForm.cboMFGOpr.Value,2]
  DIMENSION laMfgRFld[ALEN(loFormSet.laMfgRFld,1),ALEN(loFormSet.laMfgRFld,2)]
  =ACOPY(loFormSet.laMfgRFld,laMfgRFld)
  =gfRltFld(loAutoForm.lcMfgCode,@laMfgRFld,'MFGCODE')
  =ACOPY(laMfgRFld,loFormSet.laMfgRFld)
  IF !EMPTY(loFormSet.lcMfgGlAcnt)
    *Message : 04152
    *MFG Code has been setup to be applied directly through the
    *cost sheet program
    *Button : 00000
    *Ok
    =gfModalGen("TRM04152B00000","DIALOG",loFormSet.laMfgCode[loAutoForm.cboMFGOpr.Value,1])
    RETURN
  ENDIF
  LOCAL lcSqlStatement, lnResult, lcAlias
  lcAlias = ALIAS()
  *CIMTYP+CTKTNO+COPRCODE+CLOTNO+TRANCD
  lcSqlStatement = "SELECT DISTINCT cLotNo FROM MFGOPRDT (INDEX=MFGOPRDT) WHERE "+;
    "CIMTYP='"+loAutoForm.laTickets[loAutoForm.cboTktType.Value,2]+;
    "' AND CTKTNO='"+loAutoForm.kbInvTktNo.KeyTextBox.VALUE+"' "+;
    "AND COPRCODE='"+loAutoForm.lcMfgCode+"'"
  lnResult=oAriaApplication.remotecompanydata.sqlrun(lcSqlStatement,'Lots','MFGOPRDT',;
    oAriaApplication.ActiveCompanyConStr,3,'SAVE',loFormSet.DATASESSIONID)
  IF lnResult<1
    oAriaApplication.remotecompanydata.CheckRetResult("execute",lnResult,.T.)
    IF !EMPTY(lcAlias)
      SELECT (lcAlias)
    ENDIF
    *AIT WINDOW LINENO()
    RETURN .F.
  ENDIF


  SELECT cLotNo FROM Lots INTO ARRAY loAutoForm.laAplLots &&Sql106: Must use SqlRun
  USE IN Lots
  IF !EMPTY(lcAlias)
    SELECT (lcAlias)
  ENDIF

  loAutoForm.cboLotNo.VALUE = 1
  DO CASE
    CASE _TALLY = 0
      DECLARE loAutoForm.laAplLots[1]
      loAutoForm.laAplLots[1] = 'N/A'
      *Old: SHOW GET loAutoForm.cboLotNo DISABLE  &&Revise
      loAutoForm.cboLotNo.ENABLED = .F.
    CASE _TALLY = 1
      *Old: SHOW GET loAutoForm.cboLotNo DISABLE  &&Revise
      loAutoForm.cboLotNo.ENABLED = .F.
    OTHERWISE
      *Old: SHOW GET loAutoForm.cboLotNo ENABLE  &&Revise
      loAutoForm.cboLotNo.ENABLED = .T.
  ENDCASE
  *(Begin) Enabling the RSession object in case
  *of there are no lots or one and only one lot.
  IF _TALLY <= 1
    loAutoForm.lcAplLotNo = SPACE(2)
    *Old: SHOW GET ibRSession ENABLE &&Revise
    *Old: SHOW GET loAutoForm.kbRSession ENABLE  &&Revise
    loAutoForm.kbRSession.ENABLED = .T.
  ELSE
    loAutoForm.lcAplLotNo = loAutoForm.laAplLots[loAutoForm.cboLotNo.Value]
    STORE '' TO loAutoForm.kbRSession.KeyTextBox.VALUE
    *Old: SHOW GET ibRSession DISABLE &&Revise
    *Old: SHOW GET loAutoForm.kbRSession DISABLE  &&Revise
    loAutoForm.kbRSession.ENABLED = .F.
  ENDIF

  *Change the defaulte WIP Account to LFNM Account (ENGLAND)[Begin]
  *IF ASCAN(laEvntTrig , PADR('UPDAAPGL',10)) <> 0
  *=gfDoTriger('APPYINV',PADR('UPDAAPGL',10))
  *ENDIF
  *Change the defaulte WIP Account to LFNM Account (ENGLAND)[end]

  RETURN 1
  *-- End of lfvAplOpr


  *!*************************************************************
  *! Name      : lfvAplLotNo
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 09/12/2004
  *! Purpose   : Validate Selected MFG Operation Lot#. Called from the Valid event
  *!             of cboLotNo in APAINVD.SCX
  *!*************************************************************
  *! Parameters: The FormSet of APPYINV.SCX, The Form of APINVDT.SCX, The Form of APAINVD.SCX
  *!*************************************************************
  *! Returns   :  None
  *!*************************************************************
FUNCTION lfvAplLotNo
  LPARAMETERS loFormSet, loForm, loAutoForm

  loAutoForm.lcAplLotNo = loAutoForm.laAplLots[loAutoForm.cboLotNo.Value]

  RETURN 1
  *-- End of lfvAplLotNo


  *!*************************************************************
  *! Name      : lfvRSession
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 09/12/2004
  *! Purpose   : Validate Selected Document Receiving Session. Called from the Valid event
  *!             of kbRSession in APAINVD.SCX
  *!*************************************************************
  *! Parameters: The FormSet of APPYINV.SCX, The Form of APINVDT.SCX, The Form of APAINVD.SCX,
  *!                       lcType    : Document Type
  *!                       lcTicket  : Document #
  *!                       llClrRead : Terminate Read
  *!*************************************************************
  *! Returns   :  None
  *!*************************************************************
FUNCTION lfvRSession
  LPARAMETERS loFormSet, loForm, loAutoForm, lcType, lcTicket, llClrRead, lcItem, lcColor, lcCstType

  LOCAL lcSqlStatement, lnResult, lcAlias, llRetVal
  llRetVal = .T.

  lcAlias = ALIAS()

  loFormSet.llBrowse = loAutoForm.kbRSession.SelectedFromBrowse

  *Fix bug when Saving the debit memo againest Return PO [BEGIN]
  PRIVATE lcBrFields,lcFile_Ttl,lcRcvSess
  STORE '' TO lcBrFields,lcFile_Ttl,lcRcvSess
  lcRcvSess = gfTempName()
  *Fix bug when Saving the debit memo againest Return PO [END]

  SET ENGINEBEHAVIOR 70

  DO CASE
    CASE INLIST(lcType,'I','R','A','D')
      *Old: SET ORDER TO TAG Posrec IN POSLN
      loFormSet.POSLN.SetOrder('POSREC') &&Sql106: Check Tag ;
      *CBUSDOCU+CSTYTYPE+PO+CRSESSION+SHIPNO+CINVTYPE+STYLE+STR(LINENO,6)+TRANCD+CSTYGRADE ;
      (CSTYTYPE+PO+CRSESSION+SHIPNO+STYLE+STR(LINENO,6)+TRANCD)
      lcTemp = IIF(lcType='R','R','P')+IIF(INLIST(lcType,'A','D'),lcType,'P')
      IF loFormSet.llBrowse OR (!EMPTY(loAutoForm.kbRSession.KeyTextBox.VALUE) AND ;
          !loFormSet.POSLN.SEEK(lcTemp+lcTicket+loAutoForm.kbRSession.KeyTextBox.VALUE+SPACE(6)+;
          IIF(EMPTY(lcItem),"",'0001'+ALLTRIM(lcItem)))) &&Sql107: Check Key
        lcSqlStatement = "SELECT * FROM POSLN (INDEX=POSREC) WHERE "+;
          "CBUSDOCU='"+LEFT(lcTemp,1)+"' AND CSTYTYPE='"+RIGHT(lcTemp,1)+"' "+;
          "AND PO='"+lcTicket+"'"
        lnResult=oAriaApplication.remotecompanydata.sqlrun(lcSqlStatement,'RcvSess','POSLN',;
          oAriaApplication.ActiveCompanyConStr,3,'SAVE',loFormSet.DATASESSIONID)
        IF lnResult<1
          oAriaApplication.remotecompanydata.CheckRetResult("execute",lnResult,.T.)
          IF !EMPTY(lcAlias)
            SELECT (lcAlias)
          ENDIF
          *AIT WINDOW LINENO()
          RETURN .F.
        ENDIF

        SET ENGINEBEHAVIOR 70

        SELECT cRSession ,DATE ,SUM(TotQTy) AS nRecQty, SUM(TotQty*NFLANCOST&lcCstType) AS nRecAmnt ;
          FROM RcvSess WHERE !EMPTY(cRSession) AND CINVTYPE+STYLE=IIF(EMPTY(lcItem),'','0001'+ALLTRIM(lcItem)) AND ;
          IIF(lcType = 'A',trancd<>'6',.T.) ;
          GROUP BY cStyType,Po,cRSession INTO DBF (oAriaApplication.WorkDir+lcRcvSess)  &&Sql108: Must use SqlRun
        USE IN RcvSess

        *Fix bug when Saving the debit memo againest Return PO [END]
        loFormSet.llBrowse = .T.
        loAutoForm.kbRSession.SelectedFromBrowse = .T.
      ENDIF
      *Old: SET ORDER TO TAG PosLn IN POSLN
      loFormSet.POSLN.SetOrder('POSLN') &&Sql109: Check Tag ;
      *CBUSDOCU+CSTYTYPE+PO+CINVTYPE+STYLE+STR(LINENO,6)+TRANCD ;
      (CSTYTYPE+PO+STYLE+STR(LINENO,6)+TRANCD)
    CASE lcType='S'
      *Old: SET ORDER TO TAG Poshrec IN POSLN
      loFormSet.POSLN.SetOrder('POSHREC') &&Sql110: Check Tag ;
      *SHIPNO+CRSESSION+CBUSDOCU+CSTYTYPE+PO+CINVTYPE+STYLE+STR(LINENO,6)+TRANCD ;
      (SHIPNO+CRSESSION+CSTYTYPE+PO+STYLE+STR(LINENO,6)+TRANCD)
      IF loFormSet.llBrowse OR (!EMPTY(loAutoForm.kbRSession.KeyTextBox.VALUE) AND ;
          !loFormSet.POSLN.SEEK(lcTicket+loAutoForm.kbRSession.KeyTextBox.VALUE)) &&Sql111: Check Key
        lcSqlStatement = "SELECT * FROM POSLN (INDEX=POSHREC) WHERE SHIPNO='"+lcTicket+"'"
        lnResult=oAriaApplication.remotecompanydata.sqlrun(lcSqlStatement,'RcvSess','POSLN',;
          oAriaApplication.ActiveCompanyConStr,3,'SAVE',loFormSet.DATASESSIONID)
        IF lnResult<1
          oAriaApplication.remotecompanydata.CheckRetResult("execute",lnResult,.T.)
          IF !EMPTY(lcAlias)
            SELECT (lcAlias)
          ENDIF
          *AIT WINDOW LINENO()
          RETURN .F.
        ENDIF
        SELECT cRSession ,DATE ,SUM(TotQTy) AS nRecQty, SUM(TotQty*NFLANCOST&lcCstType) AS nRecAmnt ;
          FROM RcvSess WHERE !EMPTY(cRSession) AND CINVTYPE+STYLE=IIF(EMPTY(lcItem),'','0001'+ALLTRIM(lcItem)) ;
          GROUP BY ShipNo,cRSession INTO DBF (oAriaApplication.WorkDir+lcRcvSess)  &&Sql112: Must use SqlRun
        USE IN RcvSess

        loFormSet.llBrowse = .T.
        loAutoForm.kbRSession.SelectedFromBrowse = .T.
      ENDIF
      *Old: SET ORDER TO TAG PosLn IN POSLN
      loFormSet.POSLN.SetOrder('POSLN') &&Sql113: Check Tag ;
      *CBUSDOCU+CSTYTYPE+PO+CINVTYPE+STYLE+STR(LINENO,6)+TRANCD ;
      (CSTYTYPE+PO+STYLE+STR(LINENO,6)+TRANCD)
    CASE lcType='M'
      *Old: SET ORDER TO TAG Cutrec IN CutTktL
      loFormSet.CutTktL.SetOrder('POSREC') &&Sql114: Check Tag ;
      *CBUSDOCU+CSTYTYPE+PO+CRSESSION+SHIPNO+CINVTYPE+STYLE+STR(LINENO,6)+TRANCD+CSTYGRADE ;
      (CRSESSION+CUTTKT+STYLE+TRANCD)
      IF loFormSet.llBrowse OR (!EMPTY(loAutoForm.kbRSession.KeyTextBox.VALUE) AND ;
          !loFormSet.CutTktL.SEEK('PU'+lcTicket+loAutoForm.kbRSession.KeyTextBox.VALUE+;
          IIF(EMPTY(lcItem),'','0001'+ALLTRIM(lcItem))))    &&Sql115: Check Key
        lcSqlStatement = "SELECT * FROM POSLN (INDEX=POSREC) WHERE "+;
          "CBUSDOCU='P' AND CSTYTYPE='U'"+;
          "AND PO='"+lcTicket+"'"
        lnResult=oAriaApplication.remotecompanydata.sqlrun(lcSqlStatement,'RcvSess','POSLN',;
          oAriaApplication.ActiveCompanyConStr,3,'SAVE',loFormSet.DATASESSIONID)
        IF lnResult<1
          oAriaApplication.remotecompanydata.CheckRetResult("execute",lnResult,.T.)
          IF !EMPTY(lcAlias)
            SELECT (lcAlias)
          ENDIF
          *AIT WINDOW LINENO()
          RETURN .F.
        ENDIF

        SELECT cRSession, DATE, SUM(TotQTy) AS nRecQty, SUM(TotQty*nICost&lcCstType) AS nRecAmnt ;
          FROM RcvSess  WHERE !EMPTY(cRSession) AND CINVTYPE+STYLE=IIF(EMPTY(lcItem),'','0001'+ALLTRIM(lcItem)) ;
          GROUP BY PO,cRSession INTO DBF (oAriaApplication.WorkDir+lcRcvSess)  &&Sql116: Must use SqlRun
        USE IN RcvSess
        loFormSet.llBrowse = .T.
        loAutoForm.kbRSession.SelectedFromBrowse = .T.
      ENDIF
      *Old: SET ORDER TO TAG CutTktL IN CutTktL
      loFormSet.CutTktL.SetOrder('POSREC') &&Sql117: Check Tag ;
      *CBUSDOCU+CSTYTYPE+PO+CRSESSION+SHIPNO+CINVTYPE+STYLE+STR(LINENO,6)+TRANCD+CSTYGRADE ;
      (CUTTKT+STYLE+DYELOT+TRANCD)
    CASE INLIST(lcType,'L','F')
      SELECT POFLN
      *Old: SET ORDER TO TAG POFREC
      loFormSet.POFLN.SetOrder('POSREC') &&Sql118: Check Tag ;
      *CBUSDOCU+CSTYTYPE+PO+CRSESSION+SHIPNO+CINVTYPE+STYLE+STR(LINENO,6)+TRANCD+CSTYGRADE ;
      (CMATTYPE+POMAT+CRSESSION+FABRIC+COLOR+TRANCD)
      lcTemp = IIF(lcType='L','PM','RM')
      IF loFormSet.llBrowse OR (!EMPTY(loAutoForm.kbRSession.KeyTextBox.VALUE) AND ;
          !loFormSet.POFLN.SEEK(lcTemp+lcTicket+loAutoForm.kbRSession.KeyTextBox.VALUE+;
          IIF(EMPTY(lcItem),'','0002'+lfupditem(SUBSTR(lcItem,1,loFormSet.lnFabMajLen),lcColor)))) &&Sql119: Check Key
        lcSqlStatement = "SELECT * FROM POSLN (INDEX=POSREC) WHERE "+;
          "CBUSDOCU='"+LEFT(lcTemp,1)+"' AND CSTYTYPE='"+RIGHT(lcTemp,1)+"' "+;
          "AND PO='"+lcTicket+"'"
        lnResult=oAriaApplication.remotecompanydata.sqlrun(lcSqlStatement,'RcvSess','POSLN',;
          oAriaApplication.ActiveCompanyConStr,3,'SAVE',loFormSet.DATASESSIONID)
        IF lnResult<1
          oAriaApplication.remotecompanydata.CheckRetResult("execute",lnResult,.T.)
          IF !EMPTY(lcAlias)
            SELECT (lcAlias)
          ENDIF
          *AIT WINDOW LINENO()
          RETURN .F.
        ENDIF

        SELECT cRSession,DATE,SUM(TotQty) AS nRecQty, SUM(TotQty*NFLANCOST&lcCstType) AS nRecAmnt;
          FROM RcvSess WHERE !EMPTY(cRSession) AND CINVTYPE+STYLE=IIF(EMPTY(lcItem),'','0002'+lfupditem(SUBSTR(lcItem,1,loFormSet.lnFabMajLen),lcColor)) ;
          GROUP BY PO,cRSession INTO DBF (oAriaApplication.WorkDir+lcRcvSess)  &&Sql120: Must use SqlRun
        USE IN RcvSess
        loFormSet.llBrowse = .T.
        loAutoForm.kbRSession.SelectedFromBrowse = .T.
      ENDIF
    CASE lcType='T'
      *Fix the contribution process  to save the invoice [Begin]
      SELECT MMFGORDD
      *SET ORDER TO TAG MMFGORDD
      loFormSet.MMFGORDD.SetOrder('POSLN') &&Sql121: Check Tag ;
      *CBUSDOCU+CSTYTYPE+PO+CINVTYPE+STYLE+STR(LINENO,6)+TRANCD ;
      (CMFGORDNO+CFABRIC+COLOR+DYELOT+TRANCD)
      IF loFormSet.llBrowse OR (!EMPTY(loAutoForm.kbRSession.KeyTextBox.VALUE) AND ;
          !loFormSet.MMFGORDD.SEEK('PF'+lcTicket+loAutoForm.kbRSession.KeyTextBox.VALUE+IIF(EMPTY(lcItem),'','0002'+lfupditem(SUBSTR(lcItem,1,loFormSet.lnFabMajLen),lcColor))))  &&Sql122: Check Key
        lcSqlStatement = "SELECT * FROM POSLN (INDEX=POSREC) WHERE "+;
          "CBUSDOCU='P' AND CSTYTYPE='F' "+;
          "AND PO='"+lcTicket+"'"
        lnResult=oAriaApplication.remotecompanydata.sqlrun(lcSqlStatement,'RcvSess','POSLN',;
          oAriaApplication.ActiveCompanyConStr,3,'SAVE',loFormSet.DATASESSIONID)
        IF lnResult<1
          oAriaApplication.remotecompanydata.CheckRetResult("execute",lnResult,.T.)
          IF !EMPTY(lcAlias)
            SELECT (lcAlias)
          ENDIF
          *AIT WINDOW LINENO()
          RETURN .F.
        ENDIF

        SELECT cRSession,Drecvdate AS DATE,SUM(TotQty) AS nRecQty,;
          SUM(TotQty*nLan_Cost&lcCstType) AS nRecAmnt;
          FROM RcvSess WHERE !EMPTY(cRSession) AND ;
          CINVTYPE+STYLE=IIF(EMPTY(lcItem),'','0002'+lfupditem(SUBSTR(lcItem,1,loFormSet.lnFabMajLen),lcColor)) ;
          GROUP BY cRSession INTO DBF (oAriaApplication.WorkDir+lcRcvSess)  &&Sql123: Must use SqlRun
        USE IN RcvSess
        loFormSet.llBrowse = .T.
        loAutoForm.kbRSession.SelectedFromBrowse = .T.
      ENDIF
  ENDCASE
  IF loFormSet.llBrowse
    IF llClrRead
      CLEAR READ
      RETURN
    ENDIF

    *Fix bug when Saving the debit memo againest Return PO [BEGIN]
    *ASM, Checking if there is no records to display [Start]
    IF EOF()
      loAutoForm.kbRSession.KeyTextBox.VALUE=SPACE(LEN(cRSession))
      =gfModalGen('TRM38180B00000','DIALOG')
      llRetVal = .F.
    ELSE
      lcFile_Ttl = IIF(lcType$'RF','Issuing Sessions','Receiving Sessions')
      IF lcType $ 'RF'
        lcBrFields = [cRSession :R:H = "Session#", Date :R:H = "Date", nRecQty :R:H = "Iss. Qty", nRecAmnt :R:H = "Iss. Amount"]
      ELSE
        lcBrFields = [cRSession :R:H = "Session#", Date :R:H = "Date", nRecQty :R:H = "Rcv. Qty", nRecAmnt :R:H = "Rcv. Amount"]
      ENDIF
      loAutoForm.kbRSession.KeyTextBox.VALUE = ;
        IIF(ARIABROW('',lcFile_Ttl,gnBrHSRow1,gnBrHSCol1,gnBrHSRow2,gnBrHSCol2,'','','cRSession',;
        'laBrowArr'),cRSession,SPACE(6))
    ENDIF
    *ASM, Checking if there is no records to display [End]
    *Fix bug when Saving the debit memo againest Return PO [END]

    IF USED(lcRcvSess)
      USE IN (lcRcvSess)
      ERASE (oAriaApplication.WorkDir+lcRcvSess)
    ENDIF

  ENDIF

  IF !EMPTY(lcAlias)
    SELECT (lcAlias)
  ENDIF

  loFormSet.llBrowse = .F.
  loAutoForm.kbRSession.SelectedFromBrowse = .F.
  *Get the correct WIP account with shipment ticket [Begin]
  IF lcType = 'S' AND !llClrRead
    lcLinkCodN = IIF(EMPTY(lcTicket),SPACE(6),lfGetGlLnk(lcTicket,'',loAutoForm.kbRSession.KeyTextBox.VALUE))
    lcLinkCode = SUBSTR(lcLinkCodN,1,6)
    IF VAL(SUBSTR(lcLinkCodN,7)) > 1
      lcMasse = IIF(EMPTY(loAutoForm.kbRSession.KeyTextBox.VALUE),"This shipment","This receiving session")
      lcMasse = lcMasse + " has more than one WIP account."+;
        " Would you like to keep the PO's using their default WIP accounts, or assign one WIP account for all PO's? "
      IF gfModalGen("TRM00000B04013","DIALOG",.F.,.F.,lcMasse ) = 1
        lcOldAlias = ALIAS()
        *STORE '' TO loAutoForm.glApDGlAct.KeyTextBox.Value,loAutoForm.lcWIPAcnt
        STORE '' TO loFormSet.lcApdGLAct,loAutoForm.lcWIPAcnt
        SELECT (loFormSet.lcAPVInvDt)
        REPLACE cAPDGLAct WITH ''
        *Old: SHOW GET ibWIPAcnt   DISABLE &&Revise
        *Old: SHOW GET loAutoForm.glApDGlAct.KeyTextBox.Value  DISABLE &&Revise
        *Old: SHOW GET m.cApDGlAct DISABLE &&Revise
        STORE .F. TO loAutoForm.glApDGlAct.ENABLED, loForm.glApDGlAct.ENABLED
      ENDIF
    ELSE
      IF !SEEK(lcLinkCode+'013','GL_LINK')
        =SEEK('DEFDEF'+'013','GL_LINK')
      ENDIF
      *STORE GL_Link.GlAcnt TO loAutoForm.glApDGlAct.KeyTextBox.Value,loAutoForm.lcWIPAcnt
      IF TYPE('loAutoForm.lcWIPAcnt')<>'U'
        STORE GL_Link.GlAcnt TO loFormSet.lcApdGLAct,loAutoForm.lcWIPAcnt
      ELSE
        STORE GL_Link.GlAcnt TO loFormSet.lcApdGLAct
      ENDIF
      *Old: SHOW GET loAutoForm.glApDGlAct.KeyTextBox.Value &&Revise
    ENDIF
  ENDIF
  *Get the correct WIP account with shipment ticket [end]

  RETURN llRetVal
  *-- End of lfvRSession


  *!*************************************************************
  *! Name      : lfvAutoGen
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 09/12/2004
  *! Purpose   : Select Document Lines to Invoice. Called from the Click event
  *!             of the Generate Button in APAINVD.SCX
  *!*************************************************************
  *! Parameters: The FormSet of APPYINV.SCX, The Form of APINVDT.SCX, The Form of APAINVD.SCX
  *!*************************************************************
  *! Returns   :  None
  *!*************************************************************
FUNCTION lfvAutoGen
  LPARAMETERS loFormSet, loForm, loAutoForm

  *Check only when costing type is MFG Codes
  IF loAutoForm.laAplCst[loAutoForm.cboCostType.Value,3] = 'M'
    DIMENSION laMfgRFld[ALEN(loFormSet.laMfgRFld,1),ALEN(loFormSet.laMfgRFld,2)]
    =ACOPY(loFormSet.laMfgRFld,laMfgRFld)
    =gfRltFld(loAutoForm.lcMfgCode,@laMfgRFld,'MFGCODE')
    =ACOPY(laMfgRFld,loFormSet.laMfgRFld)
    IF !EMPTY(loFormSet.lcMfgGlAcnt)
      *Message : 04152
      *MFG Code has been setup to be applied directly through the
      *cost sheet program
      *Button : 00000
      *Ok
      =gfModalGen("TRM04152B00000","DIALOG",loFormSet.laMfgCode[loAutoForm.cboMFGOpr.Value,1])
      RETURN
    ENDIF
  ENDIF
  =lfGenInvLn(loFormSet,loForm,loAutoForm.laTickets[loAutoForm.cboTktType.Value,2],;
    loAutoForm.kbInvTktNo.KeyTextBox.VALUE,loAutoForm.lcMfgCode,loAutoForm.lcAplLotNo,;
    loAutoForm.kbRSession.KeyTextBox.VALUE,;
    loAutoForm.laAplCst[loAutoForm.cboCostType.Value,2],'','','',.T.)
  SELECT (loFormSet.lcAutoInv)
  IF EOF()
  ELSE
    *Old: SHOW GETS WINDOW 'APAINVD0' DISABLE &&Revise
    *Old: SHOW GET ibAInvDet ENABLE &&Revise
    *Old: SHOW GET pbClear   ENABLE &&Revise
    *Old: SHOW GETS WINDOW 'APAINVD2' ENABLE &&Revise
    *Old: SHOW GET pbSelAll DISABLE &&Revise
    WITH loAutoForm
      STORE .F. TO .cboTktType.ENABLED, .kbInvTktNo.ENABLED, .cboCostType.ENABLED, ;
        .cboMFGOpr.ENABLED, .kbRSession.ENABLED, .cboLotNo.ENABLED, .glApDGlAct.ENABLED, ;
        .cmdGenerate.ENABLED, .cmdClear.ENABLED
      .cmdClear.ENABLED = .T.
      STORE .T. TO .cmdSelect.ENABLED , .cmdSelAll.ENABLED, .cmdSelNone.ENABLED, ;
        .cmdInvert.ENABLED, .cmdProceed.ENABLED, .cmdClose.ENABLED
      .cmdSelAll.ENABLED = .F.
    ENDWITH
    =lfAInvBrow(loFormSet, loForm, loAutoForm)
  ENDIF
  =lfwAInvDt(loFormSet, loForm, loAutoForm)

  *! C201079,1 MMT 12/02/2008 Add disribution button to Ap invoice screen[Start]
  IF ASCAN(loFormSet.laEvntTrig,PADR('REFDISTBUT',10),1,ALEN(loFormSet.laEvntTrig,1),1) > 0
    loFormAuto = loAutoForm
    loFormSet.mDoTrigger(PADR('REFDISTBUT',10))
  ENDIF
  *! C201079,1 MMT 12/02/2008 Add disribution button to Ap invoice screen[End]


  RETURN
  *-- End of lfvAutoGen


  *!*************************************************************
  *! Name      : lfClrInvLn
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 09/12/2004
  *! Purpose   : Clear Selected Document Lines. Called from the Click event
  *!             of the Clear Button in APAINVD.SCX
  *!*************************************************************
  *! Parameters: The FormSet of APPYINV.SCX, The Form of APINVDT.SCX, The Form of APAINVD.SCX
  *!*************************************************************
  *! Returns   :  None
  *!*************************************************************
FUNCTION  lfClrInvLn
  LPARAMETERS loFormSet, loForm, loAutoForm

  DECLARE loAutoForm.laAplCst[1,3],loAutoForm.laTickets[1,3],loAutoForm.laAplLots[1]
  STORE 0         TO loAutoForm.cboLotNo.VALUE
  STORE SPACE(24) TO loAutoForm.glApDGlAct.KeyTextBox.VALUE
  STORE SPACE(6)  TO loAutoForm.kbInvTktNo.KeyTextBox.VALUE
  STORE 1         TO loAutoForm.cboTktType.VALUE,loAutoForm.cboCostType.VALUE
  STORE ''        TO loAutoForm.lcMfgCode,loAutoForm.kbRSession.KeyTextBox.VALUE
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *STORE 'N/A'     TO loForm.laOprLots[1]
  STORE 'N/A'     TO loFormSet.laOprLots[1]
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  STORE SPACE(2)  TO loAutoForm.lcAplLotNo
  loAutoForm.laTickets[1,1] = 'Select Document Type'
  loAutoForm.laTickets[1,2] = ' '
  loAutoForm.laTickets[1,3] = 'Document#'
  loAutoForm.laAplCst[1,1]  = 'Select Cost Type'
  loAutoForm.laAplCst[1,2]  = ' '
  loAutoForm.laAplCst[1,3]  = ' '

  SELECT (loFormSet.lcAutoInv)
  ZAP
  =lfAInvBrow(loFormSet, loForm, loAutoForm)
  *=lfRefresh('APAINVD0')
  *Old: SHOW GETS WINDOW 'APAINVD0' DISABLE ONLY &&Revise
  *Old: SHOW GETS WINDOW 'APAINVD2' DISABLE ONLY &&Revise
  *Old: SHOW GET ibAInvDet  ENABLE &&Revise
  WITH loAutoForm
    STORE .F. TO .cboTktType.ENABLED, .kbInvTktNo.ENABLED, .cboCostType.ENABLED, ;
      .cboMFGOpr.ENABLED, .kbRSession.ENABLED, .cboLotNo.ENABLED, .glApDGlAct.ENABLED, ;
      .cmdGenerate.ENABLED, .cmdClear.ENABLED
    STORE .F. TO .cmdSelect.ENABLED, .cmdSelAll.ENABLED, .cmdSelNone.ENABLED, .cmdInvert.ENABLED, ;
      .cmdProceed.ENABLED, .cmdClose.ENABLED
  ENDWITH
  *Old: SHOW GET loAutoForm.cboTktType.Value   ENABLE  &&Revise
  *Old: SHOW GET pbCancel   ENABLE &&Revise
  STORE .T. TO loAutoForm.cboTktType.ENABLED, loAutoForm.cmdClose.ENABLED
  DIMENSION laCodes[ALEN(loFormSet.laCodes,1),ALEN(loFormSet.laCodes,2)]
  =ACOPY(loFormSet.laCodes,laCodes)
  =gfwCodePop(@laCodes,'MFGCODE','N')
  =ACOPY(laCodes,loFormSet.laCodes)
  *_CUROBJ = OBJNUM(ibAInvDet)&&Old CurObj

  *! C201079,1 MMT 12/02/2008 Add disribution button to Ap invoice screen[Start]
  IF ASCAN(loFormSet.laEvntTrig,PADR('REFDISTBUT',10),1,ALEN(loFormSet.laEvntTrig,1),1) > 0
    loFormAuto = loAutoForm
    loFormSet.mDoTrigger(PADR('REFDISTBUT',10))
  ENDIF
  *! C201079,1 MMT 12/02/2008 Add disribution button to Ap invoice screen[End]


  RETURN
  *-- End of lfClrInvLn


  *!*************************************************************
  *! Name      : lfvSelect
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 09/12/2004
  *! Purpose   : Select Some Ticket line to Invoice. Called from the Click event
  *!             of the Select Button(s) in APAINVD.SCX
  *!*************************************************************
  *! Parameters: The FormSet of APPYINV.SCX, The Form of APINVDT.SCX, The Form of APAINVD.SCX,
  *!                       lcType  : 'S' : Select/UnSelect
  *!                               : 'A' : Select All
  *!                               : 'N' : Select None
  *!                               : 'V' : Invert
  *!*************************************************************
  *! Returns   :  None
  *!*************************************************************
FUNCTION lfvSelect
  LPARAMETERS loFormSet, loForm, loAutoForm, lcType
  PRIVATE lcDataSel,lcDataUSel,lcData,cKey

  lcKey=ITEM+cWareCode+cDyelot
  DO CASE
    CASE lcType = 'S'
      *Do not edit any invoices which have a closed PO in case of Auto Contr.
      IF !(loAutoForm.laTickets[loAutoForm.cboTktType.Value,2] = "S"  .AND. loFormSet.POSHDR.SEEK("PP"+CtktNo) .AND. POSHDR.STATUS = "S") &&Sql124: Check Key
        REPLACE cSelect WITH IIF(cSelect=SPACE(1),"",SPACE(1))
      ENDIF
    CASE lcType = 'A'
      *Do not edit any invoices which have a closed PO in case of Auto Contr.
      REPLACE ALL cSelect WITH IIF(!(loAutoForm.laTickets[loAutoForm.cboTktType.Value,2] = "S"  .AND. loFormSet.POSHDR.SEEK("PP"+CtktNo) .AND. POSHDR.STATUS = "S"),"","") &&Sql125: Check Key
    CASE lcType = 'N'
      REPLACE ALL cSelect WITH SPACE(1)
    CASE lcType = 'V'
      REPLACE ALL cSelect WITH IIF(cSelect=SPACE(1) .AND. !(loAutoForm.laTickets[loAutoForm.cboTktType.Value,2] = "S"  .AND. loFormSet.POSHDR.SEEK("PP"+CtktNo) .AND. POSHDR.STATUS = "S"),"",SPACE(1)) &&Sql126: Check Key
  ENDCASE
  SET ORDER TO TAG 'SELECT'
  lcDataSel   = IIF(SEEK(""),'ENABLE','DISABLE')
  lcDataUSel  = IIF(SEEK(' '),'ENABLE','DISABLE')
  SET ORDER TO TAG (loFormSet.lcAutoInv)
  =SEEK(lcKey)
  lcData  = IIF(EOF(),'DISABLE','ENABLE')
  *Old: SHOW GET pbSelAll  &lcDataUSel &&Revise
  *Old: SHOW GET pbSelNone &lcDataSel &&Revise
  *Old: SHOW GET pbInvert  &lcData &&Revise
  *Old: SHOW GET pbProceed &lcDataSel &&Revise
  loAutoForm.cmdSelAll.ENABLED=(lcDataUSel='ENABLE')
  loAutoForm.cmdSelNone.ENABLED=(lcDataSel='ENABLE')
  loAutoForm.cmdInvert.ENABLED=(lcData='ENABLE')
  loAutoForm.cmdProceed.ENABLED=(lcDataSel='ENABLE')

  IF cSelect = SPACE(1)
    *Old: SHOW GET pbSelect,1 PROMPT '\<Select' &lcData &&Revise
    loAutoForm.cmdSelect.CAPTION='\<Select'
    loAutoForm.cmdSelect.ENABLED=(lcData='ENABLE')
  ELSE
    *Old: SHOW GET pbSelect,1 PROMPT 'Un\<Select' &lcData &&Revise
    loAutoForm.cmdSelect.CAPTION='Un\<Select'
    loAutoForm.cmdSelect.ENABLED=(lcData='ENABLE')
  ENDIF

  *! C201079,1 MMT 12/02/2008 Add disribution button to Ap invoice screen[Start]
  IF ASCAN(loFormSet.laEvntTrig,PADR('REFDISTBUT',10),1,ALEN(loFormSet.laEvntTrig,1),1) > 0
    loFormAuto = loAutoForm
    loFormSet.mDoTrigger(PADR('REFDISTBUT',10))
  ENDIF
  *! C201079,1 MMT 12/02/2008 Add disribution button to Ap invoice screen[End]


  RETURN
  *-- End of lfvSelect


  *!*************************************************************
  *! Name      : lfvProAuto
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 09/12/2004
  *! Purpose   : Create Invoice Lines Automatically. Called from the Click event
  *!             of the Proceed Button in APAINVD.SCX
  *!*************************************************************
  *! Parameters: The FormSet of APPYINV.SCX, The Form of APINVDT.SCX, The Form of APAINVD.SCX
  *!*************************************************************
  *! Returns   :  None
  *!*************************************************************
FUNCTION lfvProAuto
  LPARAMETERS loFormSet, loForm, loAutoForm

  PRIVATE lcItem , lcWipAcct

  SET ORDER TO TAG ITEM IN (loFormSet.lcAPvInvDt)
  SELECT (loFormSet.lcAutoInv)
  SET ORDER TO TAG 'SELECT'
  =SEEK("")

  *Get the Max. line from invoicetkt  [Start]
  *laData[52] = lfGetMaxLin()
  *Get the Max. line invoicetkt [End]
  SCAN REST WHILE cSelect+ITEM+cWareCode+cDyelot = ""
    lcItem = IIF(INLIST(loAutoForm.laTickets[loAutoForm.cboTktType.Value,2],'L','T','F'),PADR(SUBSTR(ITEM,1,loFormSet.lnFabMajLen),19),ITEM)
    SELECT (loFormSet.lcAPvInvDt)
    *Initiale lcWipAcct.[Start]
    lcWipAcct = IIF(  loAutoForm.laTickets[loAutoForm.cboTktType.Value,2]= 'S'  ,EVALUATE(loFormSet.lcAutoInv+'.cWIPAcct') , loAutoForm.glApDGlAct.KeyTextBox.VALUE)
    *Initiale lcWipAcct.[END]
    IF !SEEK(loAutoForm.laTickets[loAutoForm.cboTktType.Value,2]+loAutoForm.kbInvTktNo.KeyTextBox.VALUE+loAutoForm.lcAplLotNo+STR(EVALUATE(loFormSet.lcAutoInv+'.LineNo'),6)+;
        loAutoForm.laAplCst[loAutoForm.cboCostType.Value,2]+loAutoForm.lcMfgCode+lcItem+EVALUATE(loFormSet.lcAutoInv+'.Color')+EVALUATE(loFormSet.lcAutoInv+'.cDyelot'))
      lcAPVIDes = ''
      DO CASE
        CASE INLIST(loAutoForm.laTickets[loAutoForm.cboTktType.Value,2],'I','S','M','R','D','A')
          =SEEK(lcItem,'Style')
          lcAPVIDes = STYLE.Desc1
        CASE INLIST(loAutoForm.laTickets[loAutoForm.cboTktType.Value,2],'T','L','F')
          =loFormSet.FABRIC.SEEK('0002'+lfupditem(SUBSTR(lcItem,1,loFormSet.lnFabMajLen),EVALUATE(loFormSet.lcAutoInv+'.Color'))) &&Sql127: Check Key
          lcAPVIDes = Fabric.DESC
      ENDCASE
      REPLACE apinvhdr.nlastvilno WITH  apinvhdr.nlastvilno + 1 IN apinvhdr
      APPEND BLANK


      lcWipAcct = IIF(  loAutoForm.laTickets[loAutoForm.cboTktType.Value,2]= 'S'  ,;
        EVALUATE(loFormSet.lcAutoInv+'.cWIPAcct') , loAutoForm.glApDGlAct.KeyTextBox.VALUE)

      =SEEK(lcItem,'Style')
      IF loAutoForm.lcMfgCode =REPLICATE('*',6)
        loAutoForm.lcMfgCode=IIF(!STYLE.lDetCost,PADR('*'+loAutoForm.laAplCst[loAutoForm.cboCostType.Value,2],6),loAutoForm.lcMfgCode )
      ENDIF
      IF loAutoForm.lcMfgCode =REPLICATE('#',6)
        loAutoForm.lcMfgCode=IIF(!STYLE.lDetCost,PADR('*'+loAutoForm.laAplCst[loAutoForm.cboCostType.Value,2],6),loAutoForm.lcMfgCode )
      ENDIF

      REPLACE cStatus    WITH 'A'  ,;
        cVendCode  WITH loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE ,;
        cAPInvNo   WITH loFormSet.AriaForm1.kbInvNo.KeyTextBox.VALUE ,;
        cApVILNo   WITH STR(apinvhdr.nlastvilno,4) ,;
        cIMTyp     WITH loAutoForm.laTickets[loAutoForm.cboTktType.Value,2] ,;
        LINENO     WITH EVALUATE(loFormSet.lcAutoInv+'.LineNo')   ,;
        cBomType   WITH loAutoForm.laAplCst[loAutoForm.cboCostType.Value,2]  ,;
        cCostType  WITH loAutoForm.laAplCst[loAutoForm.cboCostType.Value,3]  ,;
        cOprCode   WITH loAutoForm.lcMfgCode   ,;
        cTktNo     WITH IIF(cIMTyp='S',EVALUATE(loFormSet.lcAutoInv+'.cTktNo'),loAutoForm.kbInvTktNo.KeyTextBox.VALUE) ,;
        ShipNo     WITH IIF(cIMTyp='S',loAutoForm.kbInvTktNo.KeyTextBox.VALUE,'') ,;
        cLotNo     WITH loAutoForm.lcAplLotNo  ,;
        ITEM       WITH lcItem      ,;
        COLOR      WITH EVALUATE(loFormSet.lcAutoInv+'.Color') ,;
        cDyelot    WITH EVALUATE(loFormSet.lcAutoInv+'.cDyelot'),;
        cAPVIDes   WITH lcAPVIDes ,;
        cApDGlAct  WITH lcWipAcct ,;
        CLOTNO     WITH IIF(cIMTyp='D',loAutoForm.laAplLots[loAutoForm.cboLotNo.Value],'')
    ENDIF
    lnDisAmnt = EVALUATE(loFormSet.lcAutoInv+'.nInvAmnt') * IIF(loAutoForm.laTickets[loAutoForm.cboTktType.Value,2] $ 'RF',-1,1)
    =lfUpdApDist(loFormSet,loForm,cApVILNo,lnDisAmnt,lcWipAcct,loAutoForm.laTickets[loAutoForm.cboTktType.Value,2])

    REPLACE nAPQty1    WITH nAPQty1 + EVALUATE(loFormSet.lcAutoInv+'.nInvQty1')   ,;
      nAPQty2    WITH nAPQty2 + EVALUATE(loFormSet.lcAutoInv+'.nInvQty2')   ,;
      nAPQty3    WITH nAPQty3 + EVALUATE(loFormSet.lcAutoInv+'.nInvQty3')   ,;
      nAPQty4    WITH nAPQty4 + EVALUATE(loFormSet.lcAutoInv+'.nInvQty4')   ,;
      nAPQty5    WITH nAPQty5 + EVALUATE(loFormSet.lcAutoInv+'.nInvQty5')   ,;
      nAPQty6    WITH nAPQty6 + EVALUATE(loFormSet.lcAutoInv+'.nInvQty6')   ,;
      nAPQty7    WITH nAPQty7 + EVALUATE(loFormSet.lcAutoInv+'.nInvQty7')   ,;
      nAPQty8    WITH nAPQty8 + EVALUATE(loFormSet.lcAutoInv+'.nInvQty8')   ,;
      nApTotQty  WITH nApTotQty + EVALUATE(loFormSet.lcAutoInv+'.nInvQty')  ,;
      nApAmnt    WITH nApAmnt + EVALUATE(loFormSet.lcAutoInv+'.nInvAmnt')   ,;
      nApPrice   WITH IIF(nApTotQty=0,0,nApAmnt/nApTotQty)
    IF !EMPTY(loAutoForm.kbRSession.KeyTextBox.VALUE) OR loForm.llDefAuApr
      REPLACE nAPAprQty1 WITH nAPAprQty1 + EVALUATE(loFormSet.lcAutoInv+'.nInvQty1') ,;
        nAPAprQty2 WITH nAPAprQty2 + EVALUATE(loFormSet.lcAutoInv+'.nInvQty2') ,;
        nAPAprQty3 WITH nAPAprQty3 + EVALUATE(loFormSet.lcAutoInv+'.nInvQty3') ,;
        nAPAprQty4 WITH nAPAprQty4 + EVALUATE(loFormSet.lcAutoInv+'.nInvQty4') ,;
        nAPAprQty5 WITH nAPAprQty5 + EVALUATE(loFormSet.lcAutoInv+'.nInvQty5') ,;
        nAPAprQty6 WITH nAPAprQty6 + EVALUATE(loFormSet.lcAutoInv+'.nInvQty6') ,;
        nAPAprQty7 WITH nAPAprQty7 + EVALUATE(loFormSet.lcAutoInv+'.nInvQty7') ,;
        nAPAprQty8 WITH nAPAprQty8 + EVALUATE(loFormSet.lcAutoInv+'.nInvQty8') ,;
        nApTAprQty WITH nApTAprQty + EVALUATE(loFormSet.lcAutoInv+'.nInvQty')  ,;
        nAPAprAmnt WITH nAPAprAmnt + EVALUATE(loFormSet.lcAutoInv+'.nInvAmnt') ,;
        nAPAprPric WITH IIF(nApTAprQty=0,0,nAPAprAmnt/nApTAprQty)
    ENDIF
    REPLACE nApAmnt    WITH nApAmnt    * IIF((loAutoForm.laTickets[loAutoForm.cboTktType.Value,2] $ 'RF') OR loFormSet.llDebitM ,-1,1),;
      nApPrice   WITH nApPrice   * IIF((loAutoForm.laTickets[loAutoForm.cboTktType.Value,2] $ 'RF') OR loFormSet.llDebitM ,-1,1),;
      nAPAprAmnt WITH nAPAprAmnt * IIF((loAutoForm.laTickets[loAutoForm.cboTktType.Value,2] $ 'RF') OR loFormSet.llDebitM ,-1,1),;
      nAPAprPric WITH nAPAprPric * IIF((loAutoForm.laTickets[loAutoForm.cboTktType.Value,2] $ 'RF') OR loFormSet.llDebitM ,-1,1)
    loFormSet.lnTAprAmt = loFormSet.lnTAprAmt + ROUND(EVALUATE(loFormSet.lcAutoInv+'.nInvAmnt')*IIF((loAutoForm.laTickets[loAutoForm.cboTktType.Value,2] $ 'RF') OR loFormSet.llDebitM ,-1,1),2)
    loFormSet.lnTInvAmt = loFormSet.lnTInvAmt + ROUND(EVALUATE(loFormSet.lcAutoInv+'.nInvAmnt')*IIF((loAutoForm.laTickets[loAutoForm.cboTktType.Value,2] $ 'RF') OR loFormSet.llDebitM ,-1,1),2)

    SELECT (loFormSet.lcAPInvTkt)
    IF !SEEK(PADR(loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE,8)+PADR(loFormSet.AriaForm1.kbInvNo.KeyTextBox.VALUE,12)+EVALUATE(loFormSet.lcAPvInvDt+'.cApVILNo')+loAutoForm.kbRSession.KeyTextBox.VALUE)

      INSERT INTO (loFormSet.lcAPInvTkt) ;
        (cVendCode,cApInvNo,cApVILNo,cRSession,ITEM,COLOR,cWareCode,cDyelot,;
        cStatus,LINENO,cIMTyp,cTktNo,cRecvType,cApdlinNo,cApdGlAct) VALUES  ;
        (loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE,loFormSet.AriaForm1.kbInvNo.KeyTextBox.VALUE,EVALUATE(loFormSet.lcAPvInvDt+'.cApVILNo'),loAutoForm.kbRSession.KeyTextBox.VALUE,;
        EVALUATE(loFormSet.lcAPvInvDt+'.Item'),EVALUATE(loFormSet.lcAPvInvDt+'.Color'),EVALUATE(loFormSet.lcAutoInv+'.cWareCode'),;
        EVALUATE(loFormSet.lcAutoInv+'.cDyelot'),'A',EVALUATE(loFormSet.lcAutoInv+'.LineNo'),loAutoForm.laTickets[loAutoForm.cboTktType.Value,2],;
        IIF(loAutoForm.laTickets[loAutoForm.cboTktType.Value,2]='S',EVALUATE(loFormSet.lcAutoInv+'.cTktNo'),loAutoForm.kbInvTktNo.KeyTextBox.VALUE),;
        EVALUATE(loFormSet.lcAutoInv+'.cRecvType'),EVALUATE(loFormSet.lcAPvInvDt+'.cApVILNo'),EVALUATE(loFormSet.lcAPvInvDt+'.cApDGlAct'))

    ENDIF
    REPLACE nApAplQty1 WITH nApAplQty1 + EVALUATE(loFormSet.lcAutoInv+'.nInvQty1') ,;
      nApAplQty2 WITH nApAplQty2 + EVALUATE(loFormSet.lcAutoInv+'.nInvQty2') ,;
      nApAplQty3 WITH nApAplQty3 + EVALUATE(loFormSet.lcAutoInv+'.nInvQty3') ,;
      nApAplQty4 WITH nApAplQty4 + EVALUATE(loFormSet.lcAutoInv+'.nInvQty4') ,;
      nApAplQty5 WITH nApAplQty5 + EVALUATE(loFormSet.lcAutoInv+'.nInvQty5') ,;
      nApAplQty6 WITH nApAplQty6 + EVALUATE(loFormSet.lcAutoInv+'.nInvQty6') ,;
      nApAplQty7 WITH nApAplQty7 + EVALUATE(loFormSet.lcAutoInv+'.nInvQty7') ,;
      nApAplQty8 WITH nApAplQty8 + EVALUATE(loFormSet.lcAutoInv+'.nInvQty8') ,;
      nApTAplQty WITH nApTAplQty + EVALUATE(loFormSet.lcAutoInv+'.nInvQty')  ,;
      nApAplAmnt WITH nApAplAmnt + EVALUATE(loFormSet.lcAutoInv+'.nInvAmnt') ,;
      nApAPlPric WITH IIF(nApTAplQty=0,0,nApAplAmnt/nApTAplQty)

    REPLACE nApAplAmnt WITH nApAplAmnt * IIF((loAutoForm.laTickets[loAutoForm.cboTktType.Value,2] $ 'RF') OR loFormSet.llDebitM ,-1,1),;
      nApAPlPric WITH nApAPlPric * IIF((loAutoForm.laTickets[loAutoForm.cboTktType.Value,2] $ 'RF') OR loFormSet.llDebitM ,-1,1)
  ENDSCAN
  SET ORDER TO TAG (loFormSet.lcAPvInvDt) IN (loFormSet.lcAPvInvDt)

  RETURN
  *-- End of lfvProAuto



  ***AAA***



  ***MMM***


  *!*************************************************************
  *! Name      : lfMultiInit
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 09/15/2004
  *! Purpose   : Called from the Init Event of the APIMAPR.SCX
  *!*************************************************************
  *! Parameters: The FormSet of APPYINV.SCX, The Form of APINVDT.SCX, The Form of APIMAPR.SCX
  *!*************************************************************
  *! Returns   :  None
  *!*************************************************************
FUNCTION lfMultiInit
  LPARAMETERS loFormSet, loForm, loMultiForm


  *ASM, Add Properties to the form [Start]
  lcAllVar = 'lcInvLine,llDetails,llQtyUsDec,lcQtyFldPc,loMultiRec'

  DIMENSION laAllVar[1,1]
  STORE '' TO laAllVar
  =gfSubStr(lcAllVar,@laAllVar,',')

  LOCAL lnI
  FOR lnI = 1 TO ALEN(laAllVar,1)
    IF LOWER(LEFT(laAllVar[lnI,1],2)) <> 'la'
      PRIVATE &laAllVar[lnI,1].
    ENDIF
  ENDFOR

  =lfAddPro(loMultiForm)

  *ASM, Add Properties to the form [End]

  loMultiForm.lcInvLine = EVALUATE(loFormSet.lcAPvInvDt+'.cApVILNo')
  *!ASM, Enable Detailed Qty Entering in case of Material too
  *loMultiForm.llDetails = INLIST(EVALUATE(loFormSet.lcAPvInvDt+'.cIMTyp'),'M','I','S','R') AND loForm.llDefQtyDt
  loMultiForm.llDetails = INLIST(EVALUATE(loFormSet.lcAPvInvDt+'.cIMTyp'),'M','I','S','R', 'L' , 'T' , 'F') AND loForm.llDefQtyDt

  *Add this line to check if the quantity field is going to use
  *decimal points or not, the quantity field is going to use
  *decimal points in the case of document types Material PO
  *, Material PO Return and Material MFG Order [Begin]
  loMultiForm.llQtyUsDec = INLIST(EVALUATE(loFormSet.lcAPvInvDt+'.cIMTyp') , 'L' , 'T' , 'F')
  loMultiForm.lcQtyFldPc = IIF(loMultiForm.llQtyUsDec , '9999999.999' , '9999999')
  loMultiForm.txtAPTAprQty.INPUTMASK=loMultiForm.lcQtyFldPc
  FOR lnI=1 TO 8
    lcI=ALLTRIM(STR(lnI))
    loMultiForm.cntAPApr_Qty.txtQty&lcI..INPUTMASK=loMultiForm.lcQtyFldPc
  NEXT
  *Add this line to check if the quantity field is going to use [End]

  SELECT *,RECNO() AS nLRecNo FROM (loFormSet.lcAPvInvDt) WHERE cVendCode+cApInvNo+cApVILNo =;
    PADR(loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE,8)+PADR(loFormSet.AriaForm1.kbInvNo.KeyTextBox.VALUE,12)+loMultiForm.lcInvLine ;
    INTO DBF (oAriaApplication.WorkDir+loFormSet.lcTmpApr)

  SELECT (loFormSet.lcTmpApr)

  WITH loMultiForm.grdMAprLines

    .COLUMNCOUNT = 0
    .RECORDSOURCE = loFormSet.lcTmpApr
    .COLUMNCOUNT = 6

    .column1.CONTROLSOURCE = "nApTotQty"
    .column1.Header1.CAPTION = 'Inv. Qty.'

    .column2.CONTROLSOURCE = "nApPrice"
    .column2.Header1.CAPTION = 'Inv. Price'

    .column3.CONTROLSOURCE = "ROUND(nApAmnt,2)"
    .column3.Header1.CAPTION = 'Inv. Amount'

    .column4.CONTROLSOURCE = "nApTAprQty"
    .column4.Header1.CAPTION = 'Appr. Qty.'

    .column5.CONTROLSOURCE = "nApAprPric"
    .column5.Header1.CAPTION = 'Appr. Price'

    .column6.CONTROLSOURCE = "ROUND(nApAprAmnt,2)"
    .column6.Header1.CAPTION = 'Appr. Amount'

  ENDWITH

  loMultiForm.cntAPApr_Qty.SCALE = loForm.cntAPApr_Qty.SCALE

  SCATTER NAME loMultiForm.loMultiRec
  =lfgrdMAprAfterRowCol(loFormSet, loForm, loMultiForm)


  RETURN
  *-- End of lfMultiInit


  *!*************************************************************
  *! Name      : lfgrdMAprAfterRowCol
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 09/15/2004
  *! Purpose   : Called from the AfterRowColChange Event of the grid in APIMAPR.SCX
  *!*************************************************************
  *! Parameters: The FormSet of APPYINV.SCX, The Form of APINVDT.SCX, The Form of APIMAPR.SCX
  *!*************************************************************
  *! Returns   :  None
  *!*************************************************************
FUNCTION lfgrdMAprAfterRowCol
  LPARAMETERS loFormSet, loForm, loMultiForm

  SCATTER NAME loMultiForm.loMultiRec

  IF loMultiForm.llDetails
    *=lfRefresh('APIMAPR2')
    *Old: SHOW GETS WINDOW 'APIMAPR2' ONLY &&Revise
    loMultiForm.cntAPApr_Qty.VISIBLE = .T.
    loMultiForm.txtAPTAprQty.VISIBLE = .F.
  ELSE
    *=lfRefresh('APIMAPR3')
    *Old: SHOW GETS WINDOW 'APIMAPR3' ONLY &&Revise
    loMultiForm.cntAPApr_Qty.VISIBLE = .F.
    loMultiForm.txtAPTAprQty.VISIBLE = .T.
  ENDIF

  loMultiForm.REFRESH()

  RETURN
  *-- End of lfgrdMAprAfterRowCol


  *!*************************************************************
  *! Name      : lfvNewApr
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 09/15/2004
  *! Purpose   : Called from the Click Event of the New Button in APIMAPR.SCX
  *!*************************************************************
  *! Parameters: The FormSet of APPYINV.SCX, The Form of APINVDT.SCX, The Form of APIMAPR.SCX
  *!*************************************************************
  *! Returns   :  None
  *!*************************************************************
FUNCTION lfvNewApr
  LPARAMETERS loFormSet, loForm, loMultiForm

  SELECT (loFormSet.lcAPvInvDt)
  =SEEK(PADR(loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE,8)+PADR(loFormSet.AriaForm1.kbInvNo.KeyTextBox.VALUE,12)+loMultiForm.lcInvLine)

  SCATTER NAME loMultiForm.loMultiRec ;
    FIELDS cVendCode,cApInvNo,cApVILNo,cIMTyp,cBOMType,cCostType,cOprCode,cLotNo,;
    ITEM,COLOR,cDyelot,cApVIDes,cTktNO,ShipNo,cApDGlAct ADDITIVE

  loMultiForm.loMultiRec.nApAprPric = nApPrice
  SELECT (loFormSet.lcTmpApr)
  WITH loMultiForm.loMultiRec
    SUM ALL nApAprQty1,nApAprQty2,nApAprQty3,nApAprQty4,nApAprQty5,nApAprQty6,;
      nApAprQty7,nApAprQty8 ;
      TO .nApAprQty1,.nApAprQty2, .nApAprQty3, .nApAprQty4,;
      .nApAprQty5,.nApAprQty6, .nApAprQty7,.nApAprQty8

    .nApAprQty1 = MAX(EVALUATE(loFormSet.lcAPvInvDt+'.nApQty1')-.nApAprQty1,0)
    .nApAprQty2 = MAX(EVALUATE(loFormSet.lcAPvInvDt+'.nApQty2')-.nApAprQty2,0)
    .nApAprQty3 = MAX(EVALUATE(loFormSet.lcAPvInvDt+'.nApQty3')-.nApAprQty3,0)
    .nApAprQty4 = MAX(EVALUATE(loFormSet.lcAPvInvDt+'.nApQty4')-.nApAprQty4,0)
    .nApAprQty5 = MAX(EVALUATE(loFormSet.lcAPvInvDt+'.nApQty5')-.nApAprQty5,0)
    .nApAprQty6 = MAX(EVALUATE(loFormSet.lcAPvInvDt+'.nApQty6')-.nApAprQty6,0)
    .nApAprQty7 = MAX(EVALUATE(loFormSet.lcAPvInvDt+'.nApQty7')-.nApAprQty7,0)
    .nApAprQty8 = MAX(EVALUATE(loFormSet.lcAPvInvDt+'.nApQty8')-.nApAprQty8,0)
    .nApTAprQty = .nApAprQty1+.nApAprQty2+.nApAprQty3+.nApAprQty4+;
      .nApAprQty5+.nApAprQty6+.nApAprQty7+.nApAprQty8
    .nApAprAmnt = .nApTAprQty*.nApAprPric
  ENDWITH

  SELECT (loFormSet.lcTmpApr)
  APPEND BLANK
  GATHER NAME loMultiForm.loMultiRec FIELDS cVendCode,cApInvNo,cApVILNo,cIMTyp,cBOMType,cCostType,;
    cOprCode,cLotNo,ITEM,COLOR,cDyelot,cApVIDes,cTktNO,ShipNo,cApDGlAct,nApAprPric,;
    nApAprQty1,nApAprQty2,nApAprQty3,nApAprQty4,nApAprQty5,nApAprQty6,nApAprQty7,;
    nApAprQty8,nApTAprQty,nApAprAmnt

  *Old: =lfWMApr()
  =lfgrdMAprAfterRowCol(loFormSet, loForm, loMultiForm)

  *Change this line because we are going to switch between 2 Get
  *          Fields for the "Approve Quantity" to be able to add the
  *          decimal points to the "Approve Quantity" in the case of
  *          document types Material PO, Material PO Return and
  *          Material MFG Order [Begin]
  *_CUROBJ = IIF(loMultiForm.llDetails,OBJNUM(m.nAPAprQty1),OBJNUM(m.nAPTAprQty))
  *Old: _CUROBJ = IIF(loMultiForm.llDetails , OBJNUM(m.nAPAprQty1) , loFormSet.lnApQtyObj)&&Old CurObj
  IF loMultiForm.llDetails
    loMultiForm.cntAPApr_Qty.txtQty1.SETFOCUS()
  ELSE
    loMultiForm.txtAPTAprQty.SETFOCUS()
  ENDIF
  *Change this line because we are going to switch between 2 [End]

  RETURN
  *-- End of lfvNewApr


  *!*************************************************************
  *! Name      : lfvRemApr
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 09/15/2004
  *! Purpose   : Called from the Click Event of the Remove Button in APIMAPR.SCX
  *!*************************************************************
  *! Parameters: The FormSet of APPYINV.SCX, The Form of APINVDT.SCX, The Form of APIMAPR.SCX
  *!*************************************************************
  *! Returns   :  None
  *!*************************************************************
FUNCTION lfvRemApr
  LPARAMETERS loFormSet, loForm, loMultiForm

  IF gfModalGen("QRM00007B00007","ALERT") = 1
    DELETE
    GO TOP
    *Old: =lfWMApr()
    =lfgrdMAprAfterRowCol(loFormSet, loForm, loMultiForm)
  ENDIF

  RETURN
  *-- End of lfvRemApr


  *!*************************************************************
  *! Name      : lfvMAprQty
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 09/15/2004
  *! Purpose   : Validate Approved Total Quantity in APIMAPR.SCX
  *!*************************************************************
  *! Parameters: The FormSet of APPYINV.SCX, The Form of APINVDT.SCX, The Form of APIMAPR.SCX
  *!*************************************************************
  *! Returns   :  None
  *!*************************************************************
FUNCTION lfvMAprQty
  LPARAMETERS loFormSet, loForm, loMultiForm

  WITH loMultiForm.loMultiRec
    .nAPAprPric = IIF(.nAPTAprQty=0,.nAPAprAmnt,.nAPAprPric)
    .nAPTAprQty = IIF(.nAPTAprQty=0,1,.nAPTAprQty)
    .nAPAprAmnt = .nAPTAprQty*.nAPAprPric
  ENDWITH

  *Old: SHOW GET m.nAPAprAmnt &&Revise
  loMultiForm.txtAPAprAmnt.REFRESH()

  GATHER NAME loMultiForm.loMultiRec FIELDS nAPAprAmnt,nAPTAprQty,nAPAprPric
  loMultiForm.REFRESH()

  RETURN
  *-- End of lfvMAprQty

  *!*************************************************************
  *! Name      : lfvMAprCst
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 09/15/2004
  *! Purpose   : Validate Approved Cost in APIMAPR.SCX
  *!*************************************************************
  *! Parameters: The FormSet of APPYINV.SCX, The Form of APINVDT.SCX, The Form of APIMAPR.SCX
  *!*************************************************************
  *! Returns   :  None
  *!*************************************************************
FUNCTION lfvMAprCst
  LPARAMETERS loFormSet, loForm, loMultiForm

  loMultiForm.loMultiRec.nAPAprAmnt = loMultiForm.loMultiRec.nAPTAprQty*loMultiForm.loMultiRec.nAPAprPric
  GATHER NAME loMultiForm.loMultiRec FIELDS nAPAprAmnt,nAPAprPric
  *SHOW WINDOW (lcMAPrTtl) REFRESH SAME
  loMultiForm.REFRESH()

  RETURN
  *-- End of lfvMAprCst

  *!*************************************************************
  *! Name      : lfvMAprAmnt
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 09/15/2004
  *! Purpose   : Validate Approved Amount in APIMAPR.SCX
  *!*************************************************************
  *! Parameters: The FormSet of APPYINV.SCX, The Form of APINVDT.SCX, The Form of APIMAPR.SCX
  *!*************************************************************
  *! Returns   :  None
  *!*************************************************************
FUNCTION lfvMAprAmnt
  LPARAMETERS loFormSet, loForm, loMultiForm

  WITH loMultiForm.loMultiRec
    .nAPAprAmnt = .nAPAprAmnt*1.000
    .nAPAprPric = IIF(.nAPTAprQty=0,0,.nAPAprAmnt/.nAPTAprQty)
  ENDWITH

  *Old: SHOW GET m.nAPAprPric &&Revise
  loMultiForm.txtAPAprPric.REFRESH()

  GATHER NAME loMultiForm.loMultiRec FIELDS nAPAprAmnt,nAPAprPric
  *SHOW WINDOW (lcMAPrTtl) REFRESH SAME
  loMultiForm.REFRESH()

  RETURN
  *-- End of lfvMAprAmnt

  *!*************************************************************
  *! Name      : lfvMAprSQty
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 09/15/2004
  *! Purpose   : Validate Approved Size Quantity in APIMAPR.SCX
  *!*************************************************************
  *! Parameters: The FormSet of APPYINV.SCX, The Form of APINVDT.SCX, The Form of APIMAPR.SCX
  *!*************************************************************
  *! Returns   :  None
  *!*************************************************************
FUNCTION lfvMAprSQty
  LPARAMETERS loFormSet, loForm, loMultiForm

  IF EOF(loFormSet.lcTmpApr)
    RETURN 
  ENDIF 
  WITH loMultiForm.loMultiRec
    .nAPTAprQty = .nAPAprQty1+.nAPAprQty2+.nAPAprQty3+.nAPAprQty4+;
      .nAPAprQty5+.nAPAprQty6+.nAPAprQty7+.nAPAprQty8
  ENDWITH

  GATHER NAME loMultiForm.loMultiRec FIELDS nAPAprQty1,nAPAprQty2,nAPAprQty3,nAPAprQty4,;
    nAPAprQty5,nAPAprQty6,nAPAprQty7,nAPAprQty8
  =lfvMAprQty(loFormSet, loForm, loMultiForm)
  *SHOW WINDOW (lcMAPrTtl) REFRESH SAME
  *=lfRefresh('APIMAPR2')
  loMultiForm.REFRESH()

  RETURN
  *-- End of lfvMAprSQty

  *!*************************************************************
  *! Name      : lfvProMApr
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 09/15/2004
  *! Purpose   : Called from the Click Event of the Proceed Button in APIMAPR.SCX
  *!*************************************************************
  *! Parameters: The FormSet of APPYINV.SCX, The Form of APINVDT.SCX, The Form of APIMAPR.SCX
  *!*************************************************************
  *! Returns   :  None
  *!*************************************************************
FUNCTION lfvProMApr
  LPARAMETERS loFormSet, loForm, loMultiForm

  SET DELETE OFF
  *! E302678,1 MMT 03/24/2010 Convert Payable invoice screen to use SQL tables[Start]
  SELECT(loFormSet.lcTmpApr)  
  *! E302678,1 MMT 03/24/2010 Convert Payable invoice screen to use SQL tables[End]

  WITH loMultiForm.loMultiRec
    SCAN
      DO CASE
        CASE DELETED() AND nLRecNo <> 0
          SELECT (loFormSet.lcAPvInvDt)
          GO EVALUATE(loFormSet.lcTmpApr+'.nLRecNo')
          REPLACE CSTATUS WITH IIF(CSTATUS='A','S','D')
          DELETE
          loFormSet.lnTAprAmt = loFormSet.lnTAprAmt - ROUND(nApAprAmnt,2)*IIF(.CIMTYP $ 'RF',-1,1)
        CASE !DELETED() AND nLRecNo <> 0
          SCATTER NAME loMultiForm.loMultiRec
          SELECT (loFormSet.lcAPvInvDt)
          GO EVALUATE(loFormSet.lcTmpApr+'.nLRecNo')
          .CSTATUS = IIF(cStatus='S','M',cStatus)
          loFormSet.lnTAprAmt = loFormSet.lnTAprAmt+(ROUND(.nApAprAmnt,2)-ROUND(nApAprAmnt,2))*IIF(.CIMTYP $ 'RF',-1,1)
          GATHER NAME loMultiForm.loMultiRec
        CASE !DELETED() AND nLRecNo = 0
          SCATTER NAME loMultiForm.loMultiRec
          .cStatus = 'A'
          SELECT (loFormSet.lcAPvInvDt)
          APPEND BLANK
          GATHER NAME loMultiForm.loMultiRec
          loFormSet.lnTAprAmt = loFormSet.lnTAprAmt + ROUND(.nApAprAmnt,2)
      ENDCASE
    ENDSCAN
  ENDWITH
  SET DELETE ON
  SELECT (loFormSet.lcAPvInvDt)
  SKIP 1
  SKIP -1

  RETURN
  *-- End of lfvProMApr


  ***MMM***
  ***CCC***
  *!*************************************************************
  *! Name      : lfContInit
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 11/07/2004
  *! Purpose   : Called From the Init Event of the Contribution Screen
  *!*************************************************************
  *! Parameters: The FormSet of APPYINV.SCX, The Form of APINVDT.SCX, The Form of APMATST.SCX
  *!*************************************************************
  *! Returns   :  None
  *!*************************************************************
FUNCTION lfContInit
  PARAMETERS loFormSet, loForm, loContForm

  LOCAL lcSqlStatement, lnResult, lcTemp

  *ASM, Add Properties to the form [Start]
  lcAllVar = 'laRSession,lnCntrbAmnt,lnAplAmnt,lnRecCost,lnTRecQty,lnRecAmnt,'+;
    'lnActCost,lnTActQty,lnActAmnt,lnTAplQty,'+;
    'lnRecQty1,lnRecQty2,lnRecQty3,lnRecQty4,lnRecQty5,lnRecQty6,lnRecQty7,lnRecQty8,'+;
    'lnActQty1,lnActQty2,lnActQty3,lnActQty4,lnActQty5,lnActQty6,lnActQty7,lnActQty8,'+;
    'lnAplQty1,lnAplQty2,lnAplQty3,lnAplQty4,lnAplQty5,lnAplQty6,lnAplQty7,lnAplQty8,'+;
    'kbRSession,lnAmount,rbCntrb,lcContItem,lcContClr,lcMfgCode,lcMfgTmp,llProceed,'+;
    'lnCMarker,lcCntrbBr,lcPopStat,lcRemStat,lcNewStat,lcInvLineNo,loRec,lcShipNo,lcTicket,'+;
    'lcBrowQty,lcBrowCst,llShowSize,lcRcvQty,lcLnFldName,lcAcFldName'

  DIMENSION laAllVar[1,1]
  STORE '' TO laAllVar
  =gfSubStr(lcAllVar,@laAllVar,',')

  LOCAL lnI
  FOR lnI = 1 TO ALEN(laAllVar,1)
    IF LOWER(LEFT(laAllVar[lnI,1],2)) <> 'la'
      PRIVATE &laAllVar[lnI,1].
    ENDIF
  ENDFOR
  DIMENSION laRSession[1]
  =lfAddPro(loContForm)

  *ASM, Add Properties to the form [End]
  SELECT IIF(loFormSet.ActiveMode="V",'APVINVDT2',loFormSet.lcAPvInvDt)

  lcLotNo    = cLotNo
  loContForm.lcTicket   = cTktNo
  loContForm.lcShipNo   = ShipNo
  loForm.lcCstType  = cBomType
  lcCstCatg  = cCostType
  loForm.lcOprCode  = cOprCode
  loForm.lcTktType  = CIMTYP
  loContForm.lcInvLineNo= cApVILNo
  loFormSet.lnLineNo   = LINENO
  *B608531,1 WAM 04/23/2008 Get the proper fabric/color code
  *lcItem     = IIF(INLIST(loForm.lcTktType,'S','I','M','R','A','D'),Item,SUBSTR(Item,1,loFormSet.lnFabMajLen)+Color)
  IF INLIST(loForm.lcTktType,'S','I','M','R','A','D')
    lcItem = ITEM
  ELSE
    lcItemPic = gfItemMask('PI','','0002')
    lcItem = PADR(SUBSTR(ITEM,1,loFormSet.lnFabMajLen)+SUBSTR(lcItemPic,loFormSet.lnFabMajLen+1,1)+COLOR,19)
  ENDIF
  *B608531,1 WAM 04/23/2008 (End)

  loContForm.lnCMarker  = 0
  loContForm.lcCntrbBr  = 'Contributed Lines'
  loContForm.llShowSize = loForm.llDefQtyDt AND INLIST(loForm.lcTktType,'S','I','M','R','A','D')
  lnRecNo= RECNO()
  SUM nApAprAmnt TO loContForm.lnAplAmnt FOR cvendcode+capinvno+capvilno = ;
    PADR(loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE,8)+PADR(loFormSet.AriaForm1.kbInvNo.KeyTextBox.VALUE,12)+loContForm.lcInvLineNo
  IF BETWEEN(lnRecNo,1,RECCOUNT())
    GO lnRecNo
  ENDIF
  llQtyUsDec = INLIST(loForm.lcTktType , 'L' , 'T' , 'F')
  lcQtyFldPc = IIF(llQtyUsDec , '9999999.999' , '9999999')
  STORE lcQtyFldPc TO loContForm.txtTRecQty.INPUTMASK, loContForm.txtTActQty.INPUTMASK, ;
    loContForm.txtAPTAplQty.INPUTMASK

  STORE 0 TO loContForm.lnRecQty1,loContForm.lnRecQty2,loContForm.lnRecQty3,loContForm.lnRecQty4,loContForm.lnRecQty5,loContForm.lnRecQty6,;
    loContForm.lnRecQty7,loContForm.lnRecQty8,loContForm.lnTRecQty,loContForm.lnRecCost,loContForm.lnRecAmnt,;
    loContForm.lnActQty1,loContForm.lnActQty2,loContForm.lnActQty3,loContForm.lnActQty4,loContForm.lnActQty5,loContForm.lnActQty6,;
    loContForm.lnActQty7,loContForm.lnActQty8,loContForm.lnTActQty,loContForm.lnActCost,loContForm.lnActAmnt
  IF loForm.lcTktType = 'S'
    *Old: SET ORDER TO TAG Bomshrec
    loFormSet.BOMLINE.SetOrder('Bomshrec') &&Sql ;
    *CIMTYP+CTYPE+CBOMTYP+MFGCODE+SHIPNO+CRSESSION+CTKTNO+STR(LINENO,6)+CINVTYPE+STYLE+CSTYGRADE ;
    (CIMTYP+CTYPE+CBOMTYP+MFGCODE+SHIPNO+CRSESSION+CTKTNO+STR(LINENO,6)+STYLE+SCLR+CSTYGRADE)
  ELSE
    *Old: SET ORDER TO TAG BOMPOREC IN BOMLINE
    loFormSet.BOMLINE.SetOrder('BOMPOREC') &&Sql ;
    *CIMTYP+CTYPE+CBOMTYP+MFGCODE+CTKTNO+CRSESSION+SHIPNO+STR(LINENO,6)+CINVTYPE+STYLE+CSTYGRADE ;
    (CIMTYP+CTYPE+CBOMTYP+MFGCODE+CTKTNO+CRSESSION+SHIPNO+STR(LINENO,6)+STYLE+SCLR+CSTYGRADE)
  ENDIF

  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  SELECT APInvTkt
  =gfSeek(loForm.lcTktType+loContForm.lcTicket,'apinvtkt','TICKET')
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]


  SELECT APInvTkt.cRSession,APInvTkt.ITEM,APInvTkt.COLOR,APInvTkt.cWareCode,;
    APInvTkt.cDyelot,SUM(APInvTkt.nApAplQty1) AS nAplQty1,;
    SUM(APInvTkt.nApAplQty2) AS nAplQty2,SUM(APInvTkt.nApAplQty3) AS nAplQty3,;
    SUM(APInvTkt.nApAplQty4) AS nAplQty4,SUM(APInvTkt.nApAplQty5) AS nAplQty5,;
    SUM(APInvTkt.nApAplQty6) AS nAplQty6,SUM(APInvTkt.nApAplQty7) AS nAplQty7,;
    SUM(APInvTkt.nApAplQty8) AS nAplQty8,SUM(APInvTkt.nApTAplQty) AS nAplQty,;
    SUM(APInvTkt.nApAplAmnt) AS nAplAmnt FROM APInvTkt,APVINVDT WHERE ;
    APVINVDT.cIMTyp+APVINVDT.cTktNo+APVINVDT.cLotNo+APVINVDT.cBomType+;
    APVINVDT.cOprCode+APVINVDT.ITEM+APVINVDT.COLOR+APVINVDT.cDyelot=;
    loForm.lcTktType+loContForm.lcTicket+lcLotNo+loForm.lcCstType+loForm.lcOprCode AND ;
    APInvTkt.cvendcode+APInvTkt.capinvno+APInvTkt.capvilno+APInvTkt.crsession=;
    APVINVDT.cvendcode+APVINVDT.capinvno+APVINVDT.capvilno  ;
    GROUP BY ;
    APInvTkt.cRSession,APInvTkt.ITEM,APInvTkt.COLOR,APInvTkt.cWareCode,APInvTkt.cDyelot ;
    INTO DBF (oAriaApplication.WorkDir+loFormSet.lcApplied)
  INDEX ON cRSession+ITEM+COLOR+cWareCode+cDyelot TAG (loFormSet.lcApplied)
  SELECT (loFormSet.lcApplied)
  DELETE FOR EMPTY(cRSession+ITEM+COLOR+cWareCode)

  SELECT IIF(loFormSet.ActiveMode="V",'APInvTkt',loFormSet.lcAPInvTkt)
  SET RELATION TO cRSession+ITEM+COLOR+cWareCode+cDyelot INTO (loFormSet.lcApplied)
  IF INLIST(loForm.lcTktType,'S','I','M','R','A','D')
    SET RELATION TO ITEM INTO STYLE ADDITIVE
  ENDIF



  DO CASE
    CASE loForm.lcTktType = 'S'
      loFormSet.lcFileInUse = 'POSLN'
      loContForm.lcLnFldName = 'POSLN.NFLANCOST' &&sql
      loContForm.lcAcFldName = 'POSLN.NFACTCOST'
      loContForm.lcRcvQty    = 'POSLN.TotQty'
      loFormSet.POSLN.SetOrder('POSHREC')  &&Sql ;
      *SHIPNO+CRSESSION+CBUSDOCU+CSTYTYPE+PO+CINVTYPE+STYLE+STR(LINENO,6)+TRANCD ;
      (SHIPNO+CRSESSION+CSTYTYPE+PO+STYLE+STR(LINENO,6)+TRANCD)


      *SHIPNO+CBUSDOCU+CSTYTYPE+PO+CINVTYPE+STYLE+STR(LINENO,6)+TRANCD && POSLNSH Tag
      lcSqlStatement = "SELECT * FROM POSLN (INDEX=POSLNSH) WHERE SHIPNO='"+;
        loContForm.lcShipNo+"' AND CBUSDOCU='P' AND CSTYTYPE='P'"

      lnResult=oAriaApplication.remotecompanydata.sqlrun(lcSqlStatement,'TmpPosln','POSLN',;
        oAriaApplication.ActiveCompanyConStr,3,'SAVE',loFormSet.DATASESSIONID)
      IF lnResult<1
        oAriaApplication.remotecompanydata.CheckRetResult("execute",lnResult,.T.)
        IF !EMPTY(lcAlias)
          SELECT (lcAlias)
        ENDIF
        *AIT WINDOW LINENO()
        RETURN .F.
      ENDIF
      *B608531,1 WAM 04/23/2008 Get all style/color lines
      *SELECT * FROM TmpPosln WHERE IIF(loFormSet.lnLineNo=0,.T.,;
      style+STR(lineno,6)=lcItem+STR(loFormSet.lnLineNo,6)) AND;
      clotNo=lcLotNo INTO DBF (oAriaApplication.WorkDir+loFormSet.lcTmpTkt) &&sql
      SELECT * FROM TmpPosln WHERE IIF(loFormSet.lnLineNo=0,.T.,STYLE+STR(LINENO,6)=lcItem) AND;
        clotNo=lcLotNo INTO DBF (oAriaApplication.WorkDir+loFormSet.lcTmpTkt) &&sql
      *B608531,1 WAM 04/23/2008 (End)

      INDEX ON PO+STR(LINENO,6)+cRSession+TranCd+cStyGrade TAG (loFormSet.lcTmpTkt)
      USE IN TmpPosln

      SELECT IIF(loFormSet.ActiveMode="V",'APInvTkt',loFormSet.lcAPInvTkt)
      SET RELATION TO cTktNo+STR(LINENO,6)+cRSession+IIF(cRecvType='R','21',IIF(cRecvType='S','42','43')) INTO (loFormSet.lcTmpTkt) ADDITIVE
      loContForm.lcBrowQty = loFormSet.lcTmpTkt+'.TotQty'
      loContForm.lcBrowCst = loFormSet.lcTmpTkt+'.NFLANCOST'

    CASE INLIST(loForm.lcTktType,'I','R','A','D')
      loFormSet.lcFileInUse = 'POSLN'
      loContForm.lcLnFldName = 'POSLN.NFLANCOST' &&sql
      loContForm.lcAcFldName = 'POSLN.NFACTCOST'
      loContForm.lcRcvQty    = 'POSLN.TotQty'
      *Old: SET ORDER TO TAG POSREC IN POSLN
      loFormSet.POSLN.SetOrder('POSREC') &&Sql5: Check Tag ;
      *CBUSDOCU+CSTYTYPE+PO+CRSESSION+SHIPNO+CINVTYPE+STYLE+STR(LINENO,6)+TRANCD+CSTYGRADE ;
      (CSTYTYPE+PO+CRSESSION+SHIPNO+STYLE+STR(LINENO,6)+TRANCD)

      *CBUSDOCU+CSTYTYPE+PO+CINVTYPE+STYLE+STR(LINENO,6)+TRANCD && POSLN Tag
      lcTemp = IIF(loForm.lcTktType='R','R','P')+IIF(INLIST(loForm.lcTktType,'A','D'),loForm.lcTktType,'P')
      lcSqlStatement = "SELECT * FROM POSLN (INDEX=POSLN) WHERE "+;
        "CBUSDOCU='"+LEFT(lcTemp,1)+"' AND CSTYTYPE='"+RIGHT(lcTemp,1)+"' "+;
        "AND PO='"+loContForm.lcTicket+"'"
      lnResult=oAriaApplication.remotecompanydata.sqlrun(lcSqlStatement,'TmpPosln','POSLN',;
        oAriaApplication.ActiveCompanyConStr,3,'SAVE',loFormSet.DATASESSIONID)
      IF lnResult<1
        oAriaApplication.remotecompanydata.CheckRetResult("execute",lnResult,.T.)
        IF !EMPTY(lcAlias)
          SELECT (lcAlias)
        ENDIF
        *AIT WINDOW LINENO()
        RETURN .F.
      ENDIF
      *B608531,1 WAM 04/23/2008 Get all style/color lines
      *SELECT * FROM TmpPosln WHERE IIF(loFormSet.lnLineNo=0,.T.,;
      style+STR(lineno,6)=lcItem+STR(loFormSet.lnLineNo,6)) AND;
      clotNo=lcLotNo INTO DBF (oAriaApplication.WorkDir+loFormSet.lcTmpTkt) &&sql
      SELECT * FROM TmpPosln WHERE IIF(loFormSet.lnLineNo=0,.T.,STYLE+STR(LINENO,6)=lcItem) AND;
        clotNo=lcLotNo INTO DBF (oAriaApplication.WorkDir+loFormSet.lcTmpTkt) &&sql
      *B608531,1 WAM 04/23/2008 (End)

      INDEX ON STR(LINENO,6)+cRSession+TranCd+cStyGrade TAG (loFormSet.lcTmpTkt)
      USE IN TmpPosln

      SELECT IIF(loFormSet.ActiveMode="V",'APInvTkt',loFormSet.lcAPInvTkt)
      SET RELATION TO STR(LINENO,6)+cRSession+IIF(cRecvType='R','21',IIF(cRecvType='S','42','43')) INTO (loFormSet.lcTmpTkt) ADDITIVE
      loContForm.lcBrowQty = loFormSet.lcTmpTkt+'.TotQty'
      loContForm.lcBrowCst = loFormSet.lcTmpTkt+'.NFLANCOST'

    CASE loForm.lcTktType = 'M'
      loFormSet.lcFileInUse = 'CutTktL'
      loContForm.lcLnFldName = 'CutTktL.NFLANCOST' &&sql
      loContForm.lcAcFldName = 'CutTktL.NFACTCOST'
      loContForm.lcRcvQty    = 'CutTktL.TotQty'
      *Old: SET ORDER TO TAG CUTREC IN CUTTKTL
      loFormSet.CUTTKTL.SetOrder('POSREC') &&Sql ;
      *CBUSDOCU+CSTYTYPE+PO+CRSESSION+SHIPNO+CINVTYPE+STYLE+STR(LINENO,6)+TRANCD+CSTYGRADE ;
      (CRSESSION+CUTTKT+STYLE+TRANCD)

      *CBUSDOCU+CSTYTYPE+PO+CINVTYPE+STYLE+STR(LINENO,6)+TRANCD && POSLN Tag
      lcSqlStatement = "SELECT * FROM POSLN (INDEX=POSLN) WHERE "+;
        "CBUSDOCU='P' AND CSTYTYPE='U' AND PO='"+loContForm.lcTicket+"'"
      lnResult=oAriaApplication.remotecompanydata.sqlrun(lcSqlStatement,'TmpPosln','POSLN',;
        oAriaApplication.ActiveCompanyConStr,3,'SAVE',loFormSet.DATASESSIONID)
      IF lnResult<1
        oAriaApplication.remotecompanydata.CheckRetResult("execute",lnResult,.T.)
        IF !EMPTY(lcAlias)
          SELECT (lcAlias)
        ENDIF
        *WAIT WINDOW LINENO()
        RETURN .F.
      ENDIF
      SELECT * FROM TmpPosln WHERE IIF(loFormSet.lnLineNo=0,.T.,;
        STYLE+STR(LINENO,6)=lcItem+STR(loFormSet.lnLineNo,6)) ;
        INTO DBF (oAriaApplication.WorkDir+loFormSet.lcTmpTkt) &&sql
      INDEX ON STR(LINENO,6)+cRSession+TranCd+cStyGrade TAG (loFormSet.lcTmpTkt)
      USE IN TmpPosln

      SELECT IIF(loFormSet.ActiveMode="V",'APInvTkt',loFormSet.lcAPInvTkt)
      SET RELATION TO STR(LINENO,6)+cRSession+IIF(cRecvType='R','21',IIF(cRecvType='S','42','43')) INTO (loFormSet.lcTmpTkt) ADDITIVE
      loContForm.lcBrowQty = loFormSet.lcTmpTkt+'.TotQty'
      loContForm.lcBrowCst = loFormSet.lcTmpTkt+'.NFLANCOST'

    CASE INLIST(loForm.lcTktType,'L','F')
      loFormSet.lcFileInUse = 'POFLN'
      loContForm.lcLnFldName = 'POFLN.NFLANCOST' &&sql
      loContForm.lcAcFldName = 'POFLN.NFACTCOST'
      loContForm.lcRcvQty    = 'POFLN.TOTQTY'
      *Old: SET ORDER TO TAG POFREC IN POFLN
      loFormSet.POFLN.SetOrder('POSREC') &&Sql ;
      *CBUSDOCU+CSTYTYPE+PO+CRSESSION+SHIPNO+CINVTYPE+STYLE+STR(LINENO,6)+TRANCD+CSTYGRADE ;
      (CMATTYPE+POMAT+CRSESSION+FABRIC+COLOR+TRANCD)

      lcTemp = IIF(loForm.lcTktType='L','PM','RM')
      lcSqlStatement = "SELECT * FROM POSLN (INDEX=POSLN) WHERE "+;
        "CBUSDOCU='"+LEFT(lcTemp,1)+"' AND CSTYTYPE='"+RIGHT(lcTemp,1)+"' "+;
        "AND PO='"+loContForm.lcTicket+"'"
      lnResult=oAriaApplication.remotecompanydata.sqlrun(lcSqlStatement,'TmpPosln','POSLN',;
        oAriaApplication.ActiveCompanyConStr,3,'SAVE',loFormSet.DATASESSIONID)
      IF lnResult<1
        oAriaApplication.remotecompanydata.CheckRetResult("execute",lnResult,.T.)
        IF !EMPTY(lcAlias)
          SELECT (lcAlias)
        ENDIF
        WAIT WINDOW LINENO()
        RETURN .F.
      ENDIF
      SELECT * FROM TmpPosln WHERE IIF(loFormSet.lnLineNo=0,.T.,;
        STYLE+STR(LINENO,6)=lcItem+STR(loFormSet.lnLineNo,6));
        INTO DBF (oAriaApplication.WorkDir+loFormSet.lcTmpTkt) &&sql
      INDEX ON STR(LINENO,6)+cRSession+TranCd+CSTYGRADE TAG (loFormSet.lcTmpTkt)

      USE IN TmpPosln

      SELECT IIF(loFormSet.ActiveMode="V",'APInvTkt',loFormSet.lcAPInvTkt)
      SET RELATION TO STR(LINENO,6)+cRSession+IIF(cRecvType='R','21',IIF(cRecvType='S','42','43')) INTO (loFormSet.lcTmpTkt) ADDITIVE
      loContForm.lcBrowQty = loFormSet.lcTmpTkt+'.TOTQTY'
      loContForm.lcBrowCst = loFormSet.lcTmpTkt+'.NFLANCOST'

    CASE loForm.lcTktType = 'T'
      loFormSet.lcFileInUse = 'MMFGORDD'
      loContForm.lcLnFldName = 'MMFGORDD.NFLANCOST' &&sql
      loContForm.lcAcFldName = 'MMFGORDD.NFACTCOST'
      loContForm.lcRcvQty    = 'MMFGORDD.TOTQTY'

      *CBUSDOCU+CSTYTYPE+PO+CINVTYPE+STYLE+STR(LINENO,6)+TRANCD && POSLN Tag
      lcSqlStatement = "SELECT * FROM POSLN (INDEX=POSLN) WHERE "+;
        "CBUSDOCU='P' AND CSTYTYPE='F' AND PO='"+loContForm.lcTicket+"'"
      lnResult=oAriaApplication.remotecompanydata.sqlrun(lcSqlStatement,'TmpPosln','POSLN',;
        oAriaApplication.ActiveCompanyConStr,3,'SAVE',loFormSet.DATASESSIONID)
      IF lnResult<1
        oAriaApplication.remotecompanydata.CheckRetResult("execute",lnResult,.T.)
        IF !EMPTY(lcAlias)
          SELECT (lcAlias)
        ENDIF
        WAIT WINDOW LINENO()
        RETURN .F.
      ENDIF
      SELECT * FROM TmpPosln WHERE IIF(loFormSet.lnLineNo=0,.T.,;
        STYLE+STR(LINENO,6)=lcItem+STR(loFormSet.lnLineNo,6)) ;
        INTO DBF (oAriaApplication.WorkDir+loFormSet.lcTmpTkt) &&sql
      *INDEX ON cRSession+STYLE+SPACE(12)+color+TranCd+CSTYGRADE TAG (loFormSet.lcTmpTkt)
      INDEX ON cRSession+STYLE+TranCd+CSTYGRADE TAG (loFormSet.lcTmpTkt)
      USE IN TmpPosln

      SELECT IIF(loFormSet.ActiveMode="V",'APInvTkt',loFormSet.lcAPInvTkt)
      *SET RELATION TO cRSession+item+color+IIF(cRecvType='R','21',IIF(cRecvType='S','42','43')) INTO (loFormSet.lcTmpTkt) ADDITIVE
      SET RELATION TO cRSession+STYLE+IIF(cRecvType='R','21',IIF(cRecvType='S','42','43')) INTO (loFormSet.lcTmpTkt) ADDITIVE
      loContForm.lcBrowQty = loFormSet.lcTmpTkt+'.TOTQTY'
      loContForm.lcBrowCst = loFormSet.lcTmpTkt+'.NFLANCOST'

  ENDCASE
  IF loFormSet.ActiveMode="V"
    SELECT DISTINCT cRSession FROM APINVTKT ;
      WHERE cvendcode+capinvno+capvilno+crsession = ;
      PADR(loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE,8)+PADR(loFormSet.AriaForm1.kbInvNo.KeyTextBox.VALUE,12)+loContForm.lcInvLineNo AND !EMPTY(crsession);
      INTO ARRAY loContForm.laRSession
  ELSE
    SELECT DISTINCT cRSession FROM (loFormSet.lcAPInvTkt) ;
      WHERE cvendcode+capinvno+capvilno+crsession = ;
      PADR(loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE,8)+PADR(loFormSet.AriaForm1.kbInvNo.KeyTextBox.VALUE,12)+loContForm.lcInvLineNo AND !EMPTY(crsession);
      INTO ARRAY loContForm.laRSession
  ENDIF
  SELECT IIF(loFormSet.ActiveMode="V",'APInvTkt',loFormSet.lcAPInvTkt)

  loContForm.lcPopStat = IIF(_TALLY > 0 .AND. !loFormSet.llClosed,'ENABLE','DISABLE')
  loContForm.lcRemStat = IIF(_TALLY > 0 .AND. !loFormSet.ActiveMode="V" .AND. !loFormSet.llClosed,'ENABLE','DISABLE')
  loContForm.lcNewStat = IIF(!loFormSet.ActiveMode="V" .AND. !loFormSet.llClosed,'ENABLE','DISABLE')


  IF _TALLY = 0
    DECLARE loContForm.laRSession[1]
    STORE '' TO loContForm.laRSession
  ENDIF
  loContform.cboSession.REQUERY()
  STORE 1 TO loContform.cboSession.VALUE
  SET KEY TO
  =SEEK(PADR(loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE,8)+PADR(loFormSet.AriaForm1.kbInvNo.KeyTextBox.VALUE,12)+loContForm.lcInvLineNo+SPACE(6))
  loContForm.lnCntrbAmnt = loContForm.lnAplAmnt - IIF(loFormSet.ActiveMode="V",APInvTkt.nApAplAmnt,EVALUATE(loFormSet.lcAPInvTkt+'.nApAplAmnt'))
  SET KEY TO PADR(loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE,8)+PADR(loFormSet.AriaForm1.kbInvNo.KeyTextBox.VALUE,12)+loContForm.lcInvLineNo+loContForm.laRSession[loContform.cboSession.Value]
  =SEEK(PADR(loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE,8)+PADR(loFormSet.AriaForm1.kbInvNo.KeyTextBox.VALUE,12)+loContForm.lcInvLineNo+loContForm.laRSession[loContform.cboSession.Value])
  SET FILTER TO !EMPTY(cRSession)
  GO TOP
  SCATTER NAME loContForm.loRec

  WITH loContForm.grdContLines

    .COLUMNCOUNT = 0
    .RECORDSOURCE = IIF(loFormSet.ActiveMode="V",'APInvTkt',loFormSet.lcAPInvTkt)
    lnCol='0'

    IF loForm.lcTktType='S'
      lnCol = ALLTRIM(STR(VAL(lnCol)+1))
      .COLUMNCOUNT = VAL(lnCol)
      .COLUMN&lnCol..CONTROLSOURCE = "cTktNo"
      .COLUMN&lnCol..Header1.CAPTION = 'PO#'
      .COLUMN&lnCol..WIDTH = 75

      lnCol = ALLTRIM(STR(VAL(lnCol)+1))
      .COLUMNCOUNT = VAL(lnCol)
      .COLUMN&lnCol..CONTROLSOURCE = "cApdGlAct"
      .COLUMN&lnCol..Header1.CAPTION = 'WIP Account'
      .COLUMN&lnCol..WIDTH = 75
    ENDIF

    IF INLIST(loForm.lcTktType,'I','S','M','R','A','D')
      lnCol = ALLTRIM(STR(VAL(lnCol)+1))
      .COLUMNCOUNT = VAL(lnCol)
      .COLUMN&lnCol..CONTROLSOURCE = "Item"
      .COLUMN&lnCol..Header1.CAPTION = loForm.cntStyle.lblItemHeader.CAPTION
      .COLUMN&lnCol..WIDTH = 150
    ELSE
      lnCol = ALLTRIM(STR(VAL(lnCol)+1))
      .COLUMNCOUNT = VAL(lnCol)
      .COLUMN&lnCol..CONTROLSOURCE = "SUBSTR(Item,1,"+ALLTRIM(STR(loFormSet.lnFabMajLen))+")"
      .COLUMN&lnCol..Header1.CAPTION = 'Fabric'
      .COLUMN&lnCol..WIDTH = 100
      lnCol = ALLTRIM(STR(VAL(lnCol)+1))
      .COLUMNCOUNT = VAL(lnCol)
      .COLUMN&lnCol..CONTROLSOURCE = "Color"
      .COLUMN&lnCol..Header1.CAPTION = 'Color'
      .COLUMN&lnCol..WIDTH = 75
    ENDIF

    IF loFormSet.llWareHous
      lnCol = ALLTRIM(STR(VAL(lnCol)+1))
      .COLUMNCOUNT = VAL(lnCol)
      .COLUMN&lnCol..CONTROLSOURCE = "cWareCode"
      .COLUMN&lnCol..Header1.CAPTION = 'Warehouse'
      .COLUMN&lnCol..WIDTH = 75
    ENDIF

    lnCol = ALLTRIM(STR(VAL(lnCol)+1))
    .COLUMNCOUNT = VAL(lnCol)
    .COLUMN&lnCol..CONTROLSOURCE = loContForm.lcBrowQty
    .COLUMN&lnCol..Header1.CAPTION = 'Rec. Qty'
    .COLUMN&lnCol..WIDTH = 75
    lnCol = ALLTRIM(STR(VAL(lnCol)+1))
    .COLUMNCOUNT = VAL(lnCol)
    .COLUMN&lnCol..CONTROLSOURCE = loContForm.lcBrowCst+loForm.lcCstType
    .COLUMN&lnCol..Header1.CAPTION = 'Rec. Cost'
    .COLUMN&lnCol..WIDTH = 75
    .COLUMN&lnCol..INPUTMASK = '999999.999'
    lnCol = ALLTRIM(STR(VAL(lnCol)+1))
    .COLUMNCOUNT = VAL(lnCol)
    .COLUMN&lnCol..CONTROLSOURCE = loContForm.lcBrowQty+'*'+loContForm.lcBrowCst+loForm.lcCstType
    .COLUMN&lnCol..Header1.CAPTION = IIF(loForm.lcTktType$'RF','Ex Isse Cst','Ex Rec Cst')
    .COLUMN&lnCol..WIDTH = 75
    .COLUMN&lnCol..INPUTMASK = '999999.999'

    lnCol = ALLTRIM(STR(VAL(lnCol)+1))
    .COLUMNCOUNT = VAL(lnCol)
    .COLUMN&lnCol..CONTROLSOURCE = "nApTAplQty"
    .COLUMN&lnCol..Header1.CAPTION = 'Inv. Qty.'
    .COLUMN&lnCol..WIDTH = 75
    lnCol = ALLTRIM(STR(VAL(lnCol)+1))
    .COLUMNCOUNT = VAL(lnCol)
    .COLUMN&lnCol..CONTROLSOURCE = "nApAplPric"
    .COLUMN&lnCol..Header1.CAPTION = 'Inv. Cst.'
    .COLUMN&lnCol..WIDTH = 75
    lnCol = ALLTRIM(STR(VAL(lnCol)+1))
    .COLUMNCOUNT = VAL(lnCol)
    .COLUMN&lnCol..CONTROLSOURCE = "ROUND(nApAplAmnt,2)"
    .COLUMN&lnCol..Header1.CAPTION = 'Inv. Amnt.'
    .COLUMN&lnCol..WIDTH = 75

    lnCol = ALLTRIM(STR(VAL(lnCol)+1))
    .COLUMNCOUNT = VAL(lnCol)
    .COLUMN&lnCol..CONTROLSOURCE = "ROUND("+loFormSet.lcApplied+".nAPlAmnt,2)"
    .COLUMN&lnCol..Header1.CAPTION = 'Act Cst'
    .COLUMN&lnCol..WIDTH = 75
    .COLUMN&lnCol..INPUTMASK = '9999999.999'
    lnCol = ALLTRIM(STR(VAL(lnCol)+1))
    .COLUMNCOUNT = VAL(lnCol)
    .COLUMN&lnCol..CONTROLSOURCE = "nApAplAmnt/ThisForm.lnAplAmnt*100"
    .COLUMN&lnCol..Header1.CAPTION = 'Con. %'
    .COLUMN&lnCol..WIDTH = 75
    .COLUMN&lnCol..INPUTMASK = '999.99'

  ENDWITH

  =lfWCntrbScr(loFormSet, loForm, loContForm)

  RETURN
  *-- End of lfContInit


  *!*************************************************************
  *! Name      : lfContDestroy
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 11/07/2004
  *! Purpose   : Called From the Destroy Event of the Contribution Screen
  *!*************************************************************
  *! Parameters: The FormSet of APPYINV.SCX, The Form of APINVDT.SCX, The Form of APMATST.SCX
  *!*************************************************************
  *! Returns   :  None
  *!*************************************************************
FUNCTION lfContDestroy
  PARAMETERS loFormSet, loForm, loContForm

  USE IN (loFormSet.lcApplied)
  SELECT IIF(loFormSet.ActiveMode="V",'ApInvTkt',loFormSet.lcAPInvTkt)  &&lower
  SET RELATION TO
  SET KEY TO
  SET FILTER TO
  IF !loFormSet.ActiveMode="V"

    *Add these lines to take into consideration that the
    *          uncontributed record should be deleted if the amount is totally
    *          contributed. And so, if the amount was totally contributed we
    *          are going to delete the uncontributed record, and if not we
    *          will restore this record if it has been deleted [Begin]
    lcSetDelet = SET('DELETED')
    SET DELETED OFF

    IF SEEK(PADR(loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE,8)+PADR(loFormSet.AriaForm1.kbInvNo.KeyTextBox.VALUE,12)+loContForm.lcInvLineNo+SPACE(6))
      REPLACE nApAplAmnt WITH loContForm.lnAplAmnt - loContForm.lnCntrbAmnt
    ELSE
      INSERT INTO (loFormSet.lcAPInvTkt) (cVendCode,cApInvNo,cApVILNo,cStatus,cIMTyp,cTktNo) VALUES  ;
        (loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE,;
        loFormSet.AriaForm1.kbInvNo.KeyTextBox.VALUE,EVALUATE(loFormSet.lcAPvInvDt+'.cApVILNo'),;
        'A',EVALUATE(loFormSet.lcAPvInvDt+'.cIMTyp'),EVALUATE(loFormSet.lcAPvInvDt+'.cTktNo'))

      REPLACE LINENO     WITH EVALUATE(loFormSet.lcAPvInvDt+'.LineNo')     ,;
        ITEM       WITH EVALUATE(loFormSet.lcAPvInvDt+'.Item')       ,;
        COLOR      WITH EVALUATE(loFormSet.lcAPvInvDt+'.Color')      ,;
        cDyelot    WITH EVALUATE(loFormSet.lcAPvInvDt+'.cDyelot')    ,;
        nApAplQty1 WITH EVALUATE(loFormSet.lcAPvInvDt+'.nApAprQty1') ,;
        nApAplQty2 WITH EVALUATE(loFormSet.lcAPvInvDt+'.nApAprQty2') ,;
        nApAplQty3 WITH EVALUATE(loFormSet.lcAPvInvDt+'.nApAprQty3') ,;
        nApAplQty4 WITH EVALUATE(loFormSet.lcAPvInvDt+'.nApAprQty4') ,;
        nApAplQty5 WITH EVALUATE(loFormSet.lcAPvInvDt+'.nApAprQty5') ,;
        nApAplQty6 WITH EVALUATE(loFormSet.lcAPvInvDt+'.nApAprQty6') ,;
        nApAplQty7 WITH EVALUATE(loFormSet.lcAPvInvDt+'.nApAprQty7') ,;
        nApAplQty8 WITH EVALUATE(loFormSet.lcAPvInvDt+'.nApAprQty8') ,;
        nApTAplQty WITH EVALUATE(loFormSet.lcAPvInvDt+'.nApTAprQty') ,;
        nApAPlPric WITH EVALUATE(loFormSet.lcAPvInvDt+'.nAPAprPric') ,;
        nApAplAmnt WITH loContForm.lnAplAmnt - loContForm.lnCntrbAmnt ,;
        cStatus    WITH IIF(cStatus='S','M',cStatus)
    ENDIF

    *Add these lines to take into consideration that the
    *          uncontributed record should be deleted if the amount is totally
    *          contributed. And so, if the amount was totally contributed we
    *          are going to delete the uncontributed record, and if not we
    *          will restore this record if it has been deleted [Begin]
    *-- if the amount is totally contributed


    *We should check the TmpDist file for Shipmnet [Start]

    IF loContForm.lnAplAmnt = loContForm.lnCntrbAmnt
      REPLACE cStatus WITH IIF(nRecNo = 0 , 'S' , 'D')
      DELETE        && Delete the uncontributed record
    ELSE    && Else (if the amount is partially contributed)
      RECALL        && Recall the uncontributed record
      REPLACE cStatus WITH IIF(nRecNo = 0 , 'A' , 'M')
    ENDIF

    SET DELETED &lcSetDelet        && Restore the old SET DELETED status
    *Add these lines to take into consideration [End]
  ENDIF

  *In some case the Vendor field saved with blank value. [Start]
  IF !loFormSet.ActiveMode="V"
    SELECT (loFormSet.lcAPvInvDt)
    SCAN FOR EMPTY(cVendCode) OR EMPTY(cApInvNo)
      REPLACE cVendCode WITH PADR(loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE,8),;
        cApInvNo WITH PADR(loFormSet.AriaForm1.kbInvNo.KeyTextBox.VALUE,12)
    ENDSCAN
  ENDIF
  *In some case the Vendor code field saved with blank value [End]
  SELECT IIF(loFormSet.ActiveMode="V",'APVINVDT2',loFormSet.lcAPvInvDt)
  =SEEK(PADR(loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE,8)+PADR(loFormSet.AriaForm1.kbInvNo.KeyTextBox.VALUE,12)+loContForm.lcInvLineNo)  &&lower  &&lower
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *SCATTER NAME loForm.loRec
  SCATTER NAME loFormSet.loRec
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
  *=lfShowWind(loFormSet,loForm)

  RETURN
  *-- End of lfContDestroy


  *!*************************************************************
  *! Name      : lfWCntrbScr
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 11/07/2004
  *! Purpose   : Called From the AfterRowColChange Event of the Grid in Contribution Screen
  *!*************************************************************
  *! Parameters: The FormSet of APPYINV.SCX, The Form of APINVDT.SCX, The Form of APMATST.SCX
  *!*************************************************************
  *! Returns   :  None
  *!*************************************************************
FUNCTION lfWCntrbScr
  PARAMETERS loFormSet, loForm, loContForm

  *Old: loContForm.lnCMarker = RECNO()
  *Old: SHOW WINDOW (loContForm.lcCntrbBr) REFRESH SAME
  loContForm.lnTRecQty=EVALUATE(loContForm.lcBrowQty)
  loContForm.lnRecCost=EVAL(loContForm.lcBrowCst+loForm.lcCstType)
  *MAN Added Round 2
  loContForm.lnRecAmnt=ROUND(EVALUATE(loContForm.lcBrowQty+'*'+loContForm.lcBrowCst+loForm.lcCstType),2)

  loContForm.lnTActQty=EVALUATE(loFormSet.lcApplied+'.nAplQty')
  loContForm.lnActAmnt=EVALUATE(loFormSet.lcApplied+'.nAplAmnt')
  loContForm.lnActCost=IIF(loContForm.lnTActQty=0,0,loContForm.lnActAmnt/loContForm.lnTActQty)
  SCATTER NAME loContForm.loRec

  STORE loContForm.llShowSize TO loContForm.cntRecQty.VISIBLE, loContForm.cntActQty.VISIBLE, ;
    loContForm.cntAPAplQty.VISIBLE
  IF loContForm.llShowSize
    loContForm.lnRecQty1=EVALUATE(loFormSet.lcTmpTkt+'.Qty1')
    loContForm.lnRecQty2=EVALUATE(loFormSet.lcTmpTkt+'.Qty2')
    loContForm.lnRecQty3=EVALUATE(loFormSet.lcTmpTkt+'.Qty3')
    loContForm.lnRecQty4=EVALUATE(loFormSet.lcTmpTkt+'.Qty4')
    loContForm.lnRecQty5=EVALUATE(loFormSet.lcTmpTkt+'.Qty5')
    loContForm.lnRecQty6=EVALUATE(loFormSet.lcTmpTkt+'.Qty6')
    loContForm.lnRecQty7=EVALUATE(loFormSet.lcTmpTkt+'.Qty7')
    loContForm.lnRecQty8=EVALUATE(loFormSet.lcTmpTkt+'.Qty8')
    loContForm.lnActQty1=EVALUATE(loFormSet.lcApplied+'.nAplQty1')
    loContForm.lnActQty2=EVALUATE(loFormSet.lcApplied+'.nAplQty2')
    loContForm.lnActQty3=EVALUATE(loFormSet.lcApplied+'.nAplQty3')
    loContForm.lnActQty4=EVALUATE(loFormSet.lcApplied+'.nAplQty4')
    loContForm.lnActQty5=EVALUATE(loFormSet.lcApplied+'.nAplQty5')
    loContForm.lnActQty6=EVALUATE(loFormSet.lcApplied+'.nAplQty6')
    loContForm.lnActQty7=EVALUATE(loFormSet.lcApplied+'.nAplQty7')
    loContForm.lnActQty8=EVALUATE(loFormSet.lcApplied+'.nAplQty8')
    loContForm.txtAPTAplQty.ENABLED = .F.
    *Old: =lfRefresh('APMATST2')
    loContForm.REFRESH()
  ELSE
    *Old: =lfRefresh('APMATST3')
    loContForm.txtAPTAplQty.ENABLED = .T.
    loContForm.REFRESH()
  ENDIF
  lcStatus=IIF(EMPTY(loContForm.laRSession) OR loFormSet.ActiveMode="V",'DISABLE','ENABLE')
  *Old: SHOW GET m.nApAplQty1 &lcStatus &&Revise
  *Old: SHOW GET m.nApAplQty2 &lcStatus &&Revise
  *Old: SHOW GET m.nApAplQty3 &lcStatus &&Revise
  *Old: SHOW GET m.nApAplQty4 &lcStatus &&Revise
  *Old: SHOW GET m.nApAplQty5 &lcStatus &&Revise
  *Old: SHOW GET m.nApAplQty6 &lcStatus &&Revise
  *Old: SHOW GET m.nApAplQty7 &lcStatus &&Revise
  *Old: SHOW GET m.nApAplQty8 &lcStatus &&Revise
  *Old: SHOW GET m.nApAplQty1 &lcStatus &&Revise

  *Old: SHOW GET m.nApTAplQty &lcStatus &&Revise
  *Old: SHOW GET loContForm.loRec.nAPAplPric &lcStatus &&Revise
  *Old: SHOW GET m.nApAplAmnt &lcStatus &&Revise

  WITH loContForm
    *STORE (lcStatus='ENABLE') TO .txtApTAplQty.Enabled, .txtAPAplPric.Enabled, ;
    .txtApAplAmnt.Enabled, .cntApAplQty.Enabled
    STORE (lcStatus='ENABLE') TO .txtAPAplPric.ENABLED, .txtApAplAmnt.ENABLED, .cntApAplQty.ENABLED
    .CBOSession.ENABLED = !EOF(loFormSet.lcAPInvTkt)
  ENDWITH

  RETURN
  *-- End of lfWCntrbScr


  *!*************************************************************
  *! Name      : lfvAplRSess
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 11/07/2004
  *! Purpose   : Called From the Valid Event of the Session ComboBox in Contribution Screen
  *!*************************************************************
  *! Parameters: The FormSet of APPYINV.SCX, The Form of APINVDT.SCX, The Form of APMATST.SCX
  *!*************************************************************
  *! Returns   :  None
  *!*************************************************************
FUNCTION lfvAplRSess
  PARAMETERS loFormSet, loForm, loContForm

  SET KEY TO PADR(loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE,8)+PADR(loFormSet.AriaForm1.kbInvNo.KeyTextBox.VALUE,12)+loContForm.lcInvLineNo+loContForm.laRSession[loContform.cboSession.Value]
  =SEEK(PADR(loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE,8)+PADR(loFormSet.AriaForm1.kbInvNo.KeyTextBox.VALUE,12)+loContForm.lcInvLineNo+loContForm.laRSession[loContform.cboSession.Value])
  LOCATE REST WHILE cVendCode+cApInvNo+cApVILNo+cRSession = ;
    PADR(loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE,8)+PADR(loFormSet.AriaForm1.kbInvNo.KeyTextBox.VALUE,12)+loContForm.lcInvLineNo+loContForm.laRSession[loContform.cboSession.Value] ;
    FOR !EMPTY(cRSession)
  =lfWCntrbScr(loFormSet, loForm, loContForm)

  RETURN
  *-- End of lfvAplRSess


  *!*************************************************************
  *! Name      : lfvAplQty
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 11/07/2004
  *! Purpose   : Called From the Valid Event of the Qtys Container in Contribution Screen
  *!*************************************************************
  *! Parameters: The FormSet of APPYINV.SCX, The Form of APINVDT.SCX, The Form of APMATST.SCX
  *!*************************************************************
  *! Returns   :  True / False
  *!*************************************************************
FUNCTION lfvAplQty
  PARAMETERS loFormSet, loForm, loContForm, lcSize

  LOCAL lcTemp

  IF TYPE('lcSize')='N'
    lcSize = ALLTRIM(STR(lcSize))
  ENDIF

  IF !EMPTY(lcSize) AND BETWEEN(VAL(lcSize),1,8)
    loContForm.loRec.nAPTAplQty = loContForm.loRec.nAPTAplQty-nApAplQty&lcSize+loContForm.loRec.nAPAplQty&lcSize
  ENDIF
  IF loContForm.loRec.nAPTAplQty  <> nApTAplQty
    *Message : 04171
    *The invoice quantity Cannot be greater than the received Quantity
    *Button : 00000
    *Ok

    *Message : 04172
    *Increasing the invoice quantity causes the total contributed
    *amount to be greater than the total cost
    *Button : 00000
    *Ok

    IF (loContForm.loRec.nAPTAplQty > EVALUATE(loContForm.lcBrowQty) AND ;
        gfModalGen('TRM04171B00000' , 'ALERT' ,;
        'The invoice quantity|The received quantity.') = 1) OR ;
        (ABS(loContForm.lnCntrbAmnt - nApAplAmnt + loContForm.loRec.nAPTAplQty * nApAplPric) >;
        ABS(loContForm.lnAplAmnt) AND ;
        gfModalGen('TRM04172B00000' , 'ALERT' , 'invoice quantity') = 1)

      loContForm.loRec.nAPTAplQty = nApTAplQty
      IF !EMPTY(lcSize)
        loContForm.loRec.nAPAplQty&lcSize = nApAplQty&lcSize
      ENDIF
      RETURN
    ENDIF
    loContForm.lnCntrbAmnt  = loContForm.lnCntrbAmnt - nApAplAmnt + loContForm.loRec.nAPTAplQty*nApAplPric
    *Fix the contribution process [Begin]
    IF cStatus = 'S'
      REPLACE cStatus WITH 'D'
      DELETE
      APPEND BLANK
      GATHER MEMVAR MEMO
      REPLACE cStatus WITH 'A';
        nrecno WITH 0
    ENDIF
    *Fix the contribution process [End]

    loContForm.loRec.nAPAplPric = IIF(loContForm.loRec.nAPTAplQty=0,0,loContForm.loRec.nAPAplPric)
    loContForm.loRec.nAPAplAmnt = loContForm.loRec.nAPTAplQty * loContForm.loRec.nAPAplPric
    REPLACE nApTAplQty WITH loContForm.loRec.nAPTAplQty ,;
      nApAplAmnt WITH loContForm.loRec.nAPAplAmnt ,;
      nApAplPric WITH loContForm.loRec.nAPAplPric
    IF !EMPTY(lcSize)
      REPLACE nApAplQty&lcSize WITH loContForm.loRec.nAPAplQty&lcSize
    ENDIF

    *Add these lines to update the status field to "Modified" in
    *          the temp. Invoice Detail file (lcAPvInvDt) if the user
    *          changed the contribution of the line [Begin]

    *-- If the status of the temp. Invoice Detail file (lcAPvInvDt) record
    *-- is "Same".
    lcTemp = loFormSet.lcAPvInvDt+'.cStatus'
    IF EVALUATE(loFormSet.lcAPvInvDt+'.cStatus') = 'S'
      REPLACE &lcTemp WITH 'M' IN (loFormSet.lcAPvInvDt)
    ENDIF
    *Add these lines to update the status field to "Modified" [End]

    *Old: =lfRefresh('APMATST0')
    loContForm.REFRESH()
    *Old: =IIF(loContForm.llShowSize,lfRefresh('APMATST2'),lfRefresh('APMATST3'))
    *Old: SHOW GET loContForm.loRec.nAPAplAmnt &&Revise
    *Old: SHOW GET loContForm.loRec.nAPAplPric &&Revise
    loContForm.txtApAplAmnt.REFRESH()
    loContForm.txtAPAplPric.REFRESH()

    *Old: SHOW WINDOW (loContForm.lcCntrbBr) REFRESH SAME
  ENDIF

  RETURN
  *-- End of lfvAplQty


  *!*************************************************************
  *! Name      : lfvAplPrice
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 11/07/2004
  *! Purpose   : Called From the Valid Event of the Unit Cost Control in Contribution Screen
  *!*************************************************************
  *! Parameters: The FormSet of APPYINV.SCX, The Form of APINVDT.SCX, The Form of APMATST.SCX
  *!*************************************************************
  *! Returns   :  True / False
  *!*************************************************************
FUNCTION lfvAplPrice
  PARAMETERS loFormSet, loForm, loContForm

  LOCAL lcTemp

  *Fix bug when Saving the debit memo againest Return PO [BEGIN]
  IF (loContForm.loRec.CIMTYP $ 'RF' OR loFormSet.llDebitM) AND (loContForm.loRec.nAPAplPric > 0)
    loContForm.loRec.nAPAplPric = loContForm.loRec.nAPAplPric * -1
  ENDIF
  *Fix bug when Saving the debit memo againest Return PO [END]


  IF loContForm.loRec.nAPAplPric <> nApAplPric
    *Add these lines to make sure that the "Approved Amount" and
    *          the "Applied Amount" have the same sign [Begin]

    *-- If the "Approved Amount" and the "Applied Amount" have different signs
    IF SIGN(loContForm.loRec.nAPAplPric) <> 0 .AND.;
        SIGN(loContForm.loRec.nAPAplPric) <> SIGN(EVALUATE(loFormSet.lcApVInvDt+'.nAPAprPric'))

      *-- Message : 04185
      *-- "Approved amount and applied amount must have the same sign.   "
      *-- Button : 00000
      *-- "                         <    Ok    >                         "
      =gfModalGen('TRM04185B00000' , 'ALERT')

      loContForm.loRec.nAPAplPric = nApAplPric        && Restore the old value
      RETURN
    ENDIF
    *Add these lines to make sure that the "Approved Amount" [End]

    lnOldCont = loContForm.lnCntrbAmnt
    loContForm.lnCntrbAmnt = loContForm.lnCntrbAmnt - nApAplAmnt + nApTAplQty*loContForm.loRec.nAPAplPric
    IF ABS(loContForm.lnCntrbAmnt) - ABS(nApAplAmnt) + ABS(loContForm.loRec.nAPAplAmnt) > ABS(loContForm.lnAplAmnt)

      *Message : 04172
      *Increasing the unit cost causes the total contributed
      *amount to be greater than the total cost
      *Button : 00000
      *Ok
      =gfModalGen('TRM04172B00000','ALERT','unit cost')
      loContForm.loRec.nAPAplPric = nApAplPric
      *Fix the contribution process [Begin]
      loContForm.lnCntrbAmnt = lnOldCont
      *Fix the contribution process [End]
      RETURN
    ENDIF
    IF cStatus = 'S'
      REPLACE cStatus WITH 'D'
      DELETE
      APPEND BLANK
      GATHER MEMVAR MEMO
      REPLACE cStatus WITH 'A';
        nrecno WITH 0
    ENDIF
    loContForm.loRec.nAPAplAmnt=loContForm.loRec.nAPTAplQty * loContForm.loRec.nAPAplPric
    REPLACE nApAplPric WITH loContForm.loRec.nAPAplPric,;
      nApAplAmnt WITH loContForm.loRec.nAPAplAmnt

    *Add these lines to update the status field to "Modified" in
    *          the temp. Invoice Detail file (lcAPvInvDt) if the user
    *          changed the contribution of the line [Begin]

    *-- If the status of the temp. Invoice Detail file (lcAPvInvDt) record
    *-- is "Same".
    IF EVALUATE(loFormSet.lcAPvInvDt+'.cStatus') = 'S'
      lcTemp = loFormSet.lcAPvInvDt+'.cStatus'
      REPLACE &lcTemp WITH 'M' IN (loFormSet.lcAPvInvDt)
    ENDIF
    *Add these lines to update the status field to "Modified" [End]

    *=lfRefresh('APMATST0')
    *Old: SHOW GET loContForm.loRec.nAPAplAmnt &&Revise
    loContForm.txtApAplAmnt.REFRESH()
    *SHOW WINDOW (loContForm.lcCntrbBr) REFRESH SAME
    loContForm.REFRESH()
  ENDIF

  RETURN
  *-- End of lfvAplPrice

  *!*************************************************************
  *! Name      : lfvAplAMnt
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 11/07/2004
  *! Purpose   : Called From the Valid Event of the Total Amount Control in Contribution Screen
  *!*************************************************************
  *! Parameters: The FormSet of APPYINV.SCX, The Form of APINVDT.SCX, The Form of APMATST.SCX
  *!*************************************************************
  *! Returns   :  True / False
  *!*************************************************************
FUNCTION lfvAplAMnt
  PARAMETERS loFormSet, loForm, loContForm

  LOCAL lcTemp

  *Fix bug when Saving the debit memo againest Return PO [BEGIN]
  IF (loContForm.loRec.CIMTYP $ 'RF' OR loFormSet.llDebitM) AND (loContForm.loRec.nAPAplAmnt > 0)
    loContForm.loRec.nAPAplAmnt = loContForm.loRec.nAPAplAmnt * -1
  ENDIF
  *Fix bug when Saving the debit memo againest Return PO [END]

  IF loContForm.loRec.nAPAplAmnt <> nApAplAmnt

    *Add these lines to make sure that the "Approved Amount" and
    *          the "Applied Amount" have the same sign [Begin]

    *-- If the "Approved Amount" and the "Applied Amount" have different signs
    IF SIGN(loContForm.loRec.nAPAplAmnt) <> 0 .AND.;
        SIGN(loContForm.loRec.nAPAplAmnt) <> SIGN(EVALUATE(loFormSet.lcApVInvDt+'.nAPAprAmnt'))

      *-- Message : 04185
      *-- "Approved amount and applied amount must have the same sign.   "
      *-- Button : 00000
      *-- "                         <    Ok    >                         "
      =gfModalGen('TRM04185B00000' , 'ALERT')

      loContForm.loRec.nAPAplAmnt = nApAplAmnt        && Restore the old value
      RETURN
    ENDIF
    *Add these lines to make sure that the "Approved Amount" [End]


    IF ABS(loContForm.lnCntrbAmnt - nApAplAmnt + loContForm.loRec.nAPAplAmnt) > ABS(loContForm.lnAplAmnt)
      *Message : 04123
      *The Total Contributed AMount Cannot be greater than the total cost
      *Button : 00000
      *Ok
      =gfModalGen('TRM04123B00000','ALERT')
      loContForm.loRec.nAPAplAmnt = nApAplAmnt
      RETURN
    ENDIF
    loContForm.lnCntrbAmnt = loContForm.lnCntrbAmnt - nApAplAmnt+ loContForm.loRec.nAPAplAmnt
    * MAN Added the following line
    *Fix the contribution process [Begin]
    IF cStatus = 'S'
      REPLACE cStatus WITH 'D'
      DELETE
      APPEND BLANK
      GATHER MEMVAR MEMO
      REPLACE cStatus WITH 'A';
        nrecno WITH 0
    ENDIF
    *Fix the contribution process [End]
    loContForm.loRec.nAPAplAmnt = loContForm.loRec.nAPAplAmnt * 1.000
    loContForm.loRec.nAPAplPric =IIF(nApTAplQty=0,0,loContForm.loRec.nAPAplAmnt/nApTAplQty)
    REPLACE nApAplAmnt WITH loContForm.loRec.nAPAplAmnt ,;
      nApAplPric WITH loContForm.loRec.nAPAplPric

    *Add these lines to update the status field to "Modified" in
    *          the temp. Invoice Detail file (lcAPvInvDt) if the user
    *          changed the contribution of the line [Begin]

    *-- If the status of the temp. Invoice Detail file (lcAPvInvDt) record
    *-- is "Same".
    IF EVALUATE(loFormSet.lcAPvInvDt+'.cStatus') = 'S'
      lcTemp = loFormSet.lcAPvInvDt+'.cStatus'
      REPLACE &lcTemp WITH 'M' IN (loFormSet.lcAPvInvDt)
    ENDIF
    *Add these lines to update the status field to "Modified" [End]

    *Old: =lfRefresh('APMATST0')
    *Old: SHOW GET loContForm.loRec.nAPAplPric &&Revise
    loContForm.txtAPAplPric.REFRESH()
    *SHOW WINDOW (loContForm.lcCntrbBr) REFRESH SAME
    loContForm.REFRESH()
  ENDIF

  RETURN
  *-- End of lfvAplAMnt


  *!*************************************************************
  *! Name      : lfvNewCntrb
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 11/07/2004
  *! Purpose   : Called From the Click Event of the New command button in Contribution Screen
  *!*************************************************************
  *! Parameters: The FormSet of APPYINV.SCX, The Form of APINVDT.SCX, The Form of APMATST.SCX
  *!*************************************************************
  *! Returns   :  None
  *!*************************************************************
FUNCTION lfvNewCntrb
  PARAMETERS loFormSet, loForm, loContForm

  loContForm.lcContItem = EVALUATE(loFormSet.lcAPvInvDt+'.Item')
  loContForm.lcContClr  = EVALUATE(loFormSet.lcAPvInvDt+'.Color')
  STORE SPACE(6) TO loContForm.kbRSession
  STORE loContForm.lnAplAmnt - loContForm.lnCntrbAmnt TO loContForm.lnAmount
  STORE 1 TO loContForm.rbCntrb

  DO WHILE .T.
    loContForm.llProceed=.F.
    DO FORM (oAriaApplication.ScreenHome+"\AP\APMATST5.SCX") WITH loContForm
    *ASM, I think we don't need this section of Code [Start]
    *IF loFormSet.llBrowse
    *=lfvRSession(loForm.lcTktType,IIF(lcTktType='S',loContForm.lcShipNo,loContForm.lcTicket),.F.,loContForm.lcContItem,loContForm.lcContClr,loForm.lcCstType)  &&lower  &&lower
    *lnCurObj = 3&&Old CurObj
    *LOOP
    *ENDIF
    *ASM, I think we don't need this section of Code [End]


    IF loContForm.llProceed
      IF EMPTY(loContForm.kbRSession)
        *Message : 04066
        *You have to enter the Receiving Session#
        *Button : 00000
        *Ok
        =gfModalGen('TRM04066B00000','ALERT','Receiving Session #')
        *Old: lnCurObj = 2&&Old CurObj
        LOOP
      ENDIF

      IF ABS(loContForm.lnAmount) <= 0

        *Message : 04121
        *The cost amount must be greater
        *Button : 00000
        *Ok
        =gfModalGen('TRM04121B00000','ALERT')
        *Old: lnCurObj = 3&&Old CurObj
        LOOP
      ENDIF

      *Add these lines to make sure that the "Approved Amount" and
      *          the "Applied Amount" have the same sign [Begin]

      *-- If the "Approved Amount" and the "Applied Amount" have
      *-- different signs.
      IF SIGN(loContForm.lnAmount) <> SIGN(EVALUATE(loFormSet.lcAPvInvDt+'.nApAprAmnt'))

        *-- Message : 04185
        *-- "Invoice amount and approved amount must have the same sign."
        *-- Button : 00000
        *-- "                          <    Ok    >                     "
        =gfModalGen('TRM04185B00000' , 'ALERT')

        *Old: lnCurObj = 3&&Old CurObj
        LOOP
      ENDIF
      *Add these lines to make sure that the "Approved Amount" [End]

      IF ABS(loContForm.lnAmount+loContForm.lnCntrbAmnt) > ABS(EVALUATE(loFormSet.lcAPvInvDt+'.nApAprAmnt'))
        *Message : 04175
        *Applied Amount Cannot exceed Approved Amount
        *Button : 00000
        *Ok
        =gfModalGen('TRM04175B00000','ALERT')
        *Old: lnCurObj = OBJNUM(loContForm.lnAmount)&&Old CurObj
        *Old: lnCurObj = 3&&Old CurObj
        LOOP
      ENDIF
      IF SEEK(PADR(loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE,8)+PADR(loFormSet.AriaForm1.kbInvNo.KeyTextBox.VALUE,12)+loContForm.lcInvLineNo+loContForm.kbRSession,loFormSet.lcAPInvTkt)
        *Message : 04127
        *This cost item has been applied to
        *Button : 00000
        *Ok
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
        *!*	      lcMsgTxt=loForm.laTktType[loForm.cboTktType.Value,3]+' '+;
        *!*	               EVALUATE(loFormSet.lcAPvInvDt+'.cTktNo')+' Session#: '+loContForm.kbRSession
        lcMsgTxt=loFormSet.laTktType[loForm.cboTktType.Value,3]+' '+;
          EVALUATE(loFormSet.lcAPvInvDt+'.cTktNo')+' Session#: '+loContForm.kbRSession
        *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[End]
        =gfModalGen("TRM04127B00000","DIALOG",lcMsgTxt)
        *Old: lnCurObj = 2&&Old CurObj
        LOOP
      ENDIF

      IF !INLIST(loForm.lcTktType,'L','R','F','A') AND loContForm.rbCntrb = 1
        loContForm.lcMfgCode = loForm.lcOprCode

        *ASM, Key of Boomline index in case of Shipment and non shipment
        *CIMTYP+CTYPE+CBOMTYP+MFGCODE+SHIPNO+CRSESSION+CTKTNO+STR(LINENO,6)+CINVTYPE+STYLE+CSTYGRADE ;
        *CIMTYP+CTYPE+CBOMTYP+MFGCODE+CTKTNO+CRSESSION+SHIPNO+STR(LINENO,6)+CINVTYPE+STYLE+CSTYGRADE ;

        IF EMPTY(loContForm.lcContItem)
          IF INLIST(loForm.lcTktType,'S','I','M') AND loForm.lcOprCode=REPLICATE('*',6) AND ;
              IIF(loForm.lcTktType='S',loFormSet.BOMLINE.SEEK('I2'+loForm.lcCstType+PADR('*'+loForm.lcCstType,6)+loContForm.lcShipNo+loContForm.kbRSession) OR ;
              loFormSet.BOMLINE.SEEK('I2'+loForm.lcCstType+'******'+loContForm.lcShipNo+loContForm.kbRSession),;
              loFormSet.BOMLINE.SEEK(loForm.lcTktType+'2'+loForm.lcCstType+PADR('*'+loForm.lcCstType,6)+loContForm.lcTicket+loContForm.kbRSession) OR ;
              loFormSet.BOMLINE.SEEK(loForm.lcTktType+'2'+loForm.lcCstType+'******'+loContForm.lcTicket+loContForm.kbRSession)) &&sql
            loContForm.lcMfgCode = PADR(BOMLINE.MFGCODE,6)
          ENDIF
          IF INLIST(loForm.lcTktType,'S','I','M') AND loForm.lcOprCode=REPLICATE('#',6) AND ;
              IIF(loForm.lcTktType='S',loFormSet.BOMLINE.SEEK('I2'+loForm.lcCstType+PADR('*'+loForm.lcCstType,6)+loContForm.lcShipNo+loContForm.kbRSession) OR ;
              loFormSet.BOMLINE.SEEK('I2'+loForm.lcCstType+'######'+loContForm.lcShipNo+loContForm.kbRSession),;
              loFormSet.BOMLINE.SEEK(loForm.lcTktType+'2'+loForm.lcCstType+PADR('*'+loForm.lcCstType,6)+loContForm.lcTicket+loContForm.kbRSession) OR ;
              loFormSet.BOMLINE.SEEK(loForm.lcTktType+'2'+loForm.lcCstType+'######'+loContForm.lcTicket+loContForm.kbRSession)) &&sql
            loContForm.lcMfgCode = PADR(BOMLINE.MFGCODE,6)
          ENDIF
        ELSE
          IF INLIST(loForm.lcTktType,'S','I','M') AND loForm.lcOprCode=REPLICATE('*',6)
            =SEEK(PADR(loContForm.lcContItem,19),'STYLE')
            loContForm.lcMfgCode=IIF(!STYLE.lDetCost,PADR('*'+loForm.lcCstType,6),loForm.lcOprCode)
          ENDIF
          IF INLIST(loForm.lcTktType,'S','I','M') AND loForm.lcOprCode=REPLICATE('#',6)
            =SEEK(PADR(loContForm.lcContItem,19),'STYLE')
            loContForm.lcMfgCode=IIF(!STYLE.lDetCost,PADR('*'+loForm.lcCstType,6),loForm.lcOprCode)
          ENDIF
        ENDIF
        *Check if Style is not empty [End]
        IF IIF(loForm.lcTktType='S',!loFormSet.BOMLINE.SEEK('I2'+loForm.lcCstType+loContForm.lcMfgCode+loContForm.lcShipNo+loContForm.kbRSession),;
            !loFormSet.BOMLINE.SEEK(loForm.lcTktType+'2'+loForm.lcCstType+loContForm.lcMfgCode+loContForm.lcTicket+loContForm.kbRSession)) &&sql
          *Message : 04122
          *The entered cost type does not exist in the budget for this receiving.
          *You cannot make your contribution based on the budget cost.
          *Button : 00000
          *Ok
          =gfModalGen("TRM04122B00000","DIALOG")
          *Old: lnCurObj = 4&&Old CurObj
          LOOP
        ENDIF
      ENDIF

      *Add these lines to update the status field to "Modified" in
      *          the temp. Invoice Detail file (lcAPvInvDt) if the user
      *          changed the contribution of the line [Begin]

      *-- If the status of the temp. Invoice Detail file (lcAPvInvDt) record
      *-- is "Same".
      IF EVALUATE(loFormSet.lcAPvInvDt+'.cStatus') = 'S'
        SELECT (loFormSet.lcAPvInvDt)
        REPLACE cStatus WITH 'M'
      ENDIF
      *Add these lines to update the status field to "Modified" [End]

      =lfvProCntrb(loFormSet, loForm, loContForm)
    ENDIF
    *Old: RELEASE WINDOW 'APMATST5'
    EXIT
  ENDDO

  DO CASE
    CASE loForm.lcTktType = 'S'
      *Old: SET ORDER TO TAG Poshrec IN POSLN
      loFormSet.POSLN.SetOrder('POSHREC')  &&Sql ;
      *SHIPNO+CRSESSION+CBUSDOCU+CSTYTYPE+PO+CINVTYPE+STYLE+STR(LINENO,6)+TRANCD ;
      (SHIPNO+CRSESSION+CSTYTYPE+PO+STYLE+STR(LINENO,6)+TRANCD)
    CASE INLIST(loForm.lcTktType,'I','R','A','D')
      *Old: SET ORDER TO TAG Posrec IN POSLN
      loFormSet.POSLN.SetOrder('POSREC') &&Sql ;
      *CBUSDOCU+CSTYTYPE+PO+CRSESSION+SHIPNO+CINVTYPE+STYLE+STR(LINENO,6)+TRANCD+CSTYGRADE ;
      (CSTYTYPE+PO+CRSESSION+SHIPNO+STYLE+STR(LINENO,6)+TRANCD)
    CASE loForm.lcTktType = 'M'
      *Old: SET ORDER TO TAG Cutrec IN CutTktL
      loFormSet.CUTTKTL.SetOrder('POSREC') &&Sql ;
      *CBUSDOCU+CSTYTYPE+PO+CRSESSION+SHIPNO+CINVTYPE+STYLE+STR(LINENO,6)+TRANCD+CSTYGRADE ;
      (CRSESSION+CUTTKT+STYLE+TRANCD)
    CASE INLIST(loForm.lcTktType,'L','F')
      *Old: SET ORDER TO TAG POFREC IN POFLN
      loFormSet.POFLN.SetOrder('POSREC') &&Sql ;
      *CBUSDOCU+CSTYTYPE+PO+CRSESSION+SHIPNO+CINVTYPE+STYLE+STR(LINENO,6)+TRANCD+CSTYGRADE ;
      (CMATTYPE+POMAT+CRSESSION+FABRIC+COLOR+TRANCD)
    CASE loForm.lcTktType = 'T'
      *Old: SET ORDER TO TAG MFGREC IN MMFGORDD
      loFormSet.MMFGORDD.SetOrder('POSREC') &&Sql ;
      *CBUSDOCU+CSTYTYPE+PO+CRSESSION+SHIPNO+CINVTYPE+STYLE+STR(LINENO,6)+TRANCD+CSTYGRADE

  ENDCASE

  SET ENGINEBEHAVIOR 70
  SELECT DISTINCT cRSession FROM (loFormSet.lcAPInvTkt) ;
    WHERE cvendcode+capinvno+capvilno+crsession = ;
    PADR(loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE,8)+PADR(loFormSet.AriaForm1.kbInvNo.KeyTextBox.VALUE,12)+loContForm.lcInvLineNo AND !EMPTY(crsession);
    INTO ARRAY loContForm.laRSession

  IF _TALLY = 0
    DECLARE loContForm.laRSession[1]
    STORE '' TO loContForm.laRSession
    STORE 1 TO loContform.cboSession.VALUE
    *Old: SHOW GET loContform.cboSession.Value DISABLE &&Revise
    loContform.cboSession.ENABLED = .F.
  ELSE
    STORE IIF(loContForm.llProceed,ASCAN(loContForm.laRSession,loContForm.kbRSession),loContform.cboSession.VALUE) TO loContform.cboSession.VALUE
    *Old: SHOW GET loContform.cboSession.Value ENABLE &&Revise
    loContform.cboSession.ENABLED = .T.
    *Old: SHOW GET pbRemCntrb ENABLE &&Revise
    loContForm.cmdRemove.ENABLED = .F.
  ENDIF
  SELECT (loFormSet.lcAPInvTkt)
  =lfvAplRSess(loFormSet, loForm, loContForm)
  *Old: =lfRefresh('APMATST0')
  loContForm.REFRESH()

  RETURN
  *-- End of lfvNewCntrb


  *!*************************************************************
  *! Name      : lfvRemCntrb
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 11/07/2004
  *! Purpose   : Called From the Click Event of the Remove command button in Contribution Screen
  *!*************************************************************
  *! Parameters: The FormSet of APPYINV.SCX, The Form of APINVDT.SCX, The Form of APMATST.SCX
  *!*************************************************************
  *! Returns   :  None
  *!*************************************************************
FUNCTION lfvRemCntrb
  PARAMETERS loFormSet, loForm, loContForm

  PRIVATE lnTAplQty,lnAplAmnt,lnAplQty1,lnAplQty2,lnAplQty3,;
    lnAplQty4,lnAplQty5,lnAplQty6,lnAplQty7,lnAplQty8

  IF .T.
    STORE 0 TO  lnTAplQty,lnAplAmnt,lnAplQty1,lnAplQty2,lnAplQty3,;
      lnAplQty4,lnAplQty5,lnAplQty6,lnAplQty7,lnAplQty8

    SELECT (loFormSet.lcAPInvTkt)
    =SEEK(PADR(loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE,8)+PADR(loFormSet.AriaForm1.kbInvNo.KeyTextBox.VALUE,12)+loContForm.lcInvLineNo+loContForm.laRSession[loContform.cboSession.Value])
    SCAN REST WHILE cVendCode+cApInvNo+cApVILNo+cRSession  = ;
        PADR(loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE,8)+PADR(loFormSet.AriaForm1.kbInvNo.KeyTextBox.VALUE,12)+loContForm.lcInvLineNo+loContForm.laRSession[loContform.cboSession.Value]

      lnTAplQty = lnTAplQty + nApTAplQty
      lnAplAmnt = lnAplAmnt + nApAplAmnt
      lnAplQty1 = lnAplQty1 + nApAplQty1
      lnAplQty2 = lnAplQty2 + nApAplQty2
      lnAplQty3 = lnAplQty3 + nApAplQty3
      lnAplQty4 = lnAplQty4 + nApAplQty4
      lnAplQty5 = lnAplQty5 + nApAplQty5
      lnAplQty6 = lnAplQty6 + nApAplQty6
      lnAplQty7 = lnAplQty7 + nApAplQty7
      lnAplQty8 = lnAplQty8 + nApAplQty8

      *Fix the contribution process  to save the invoice [Begin]

      REPLACE cStatus WITH IIF(!EMPTY(nrecno),'D','S')
      *Fix the contribution process  to save the invoice [End]
      DELETE
    ENDSCAN
    SET KEY TO

    =SEEK(PADR(loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE,8)+PADR(loFormSet.AriaForm1.kbInvNo.KeyTextBox.VALUE,12)+loContForm.lcInvLineNo+SPACE(6))
    REPLACE nApAplQty1 WITH nApAplQty1 + lnAplQty1 ,;
      nApAplQty2 WITH nApAplQty2 + lnAplQty2 ,;
      nApAplQty3 WITH nApAplQty3 + lnAplQty3 ,;
      nApAplQty4 WITH nApAplQty4 + lnAplQty4 ,;
      nApAplQty5 WITH nApAplQty5 + lnAplQty5 ,;
      nApAplQty6 WITH nApAplQty6 + lnAplQty6 ,;
      nApAplQty7 WITH nApAplQty7 + lnAplQty7 ,;
      nApAplQty8 WITH nApAplQty8 + lnAplQty8 ,;
      nApTAplQty WITH nApTAplQty + lnTAplQty ,;
      nApAplAmnt WITH nApAplAmnt + lnAplAmnt ,;
      nApAPlPric WITH IIF(nApTAplQty=0,0,nApAplAmnt/nApTAplQty) ,;
      cStatus    WITH IIF(cStatus='S','M',cStatus)
    loContForm.lnCntrbAmnt = loContForm.lnCntrbAmnt - lnAplAmnt

    =ADEL(loContForm.laRSession,loContform.cboSession.VALUE)
    loContform.cboSession.VALUE = 1

    *Fix the contribution process [Begin]
    SELECT (loFormSet.lcAPVInvDt)
    llSeek = SEEK(PADR(loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE,8)+PADR(loFormSet.AriaForm1.kbInvNo.KeyTextBox.VALUE,12)+loContForm.lcInvLineNo)
    IF llSeek
      REPLACE cStatus WITH IIF(cStatus='S','M',cStatus)
    ENDIF
    SELECT (loFormSet.lcAPInvTkt)
    *Fix the contribution process [End]
    IF ALEN(loContForm.laRSession) > 1
      DECLARE loContForm.laRSession[ALEN(loContForm.laRSession)-1]
      *Old: SHOW GET loContform.cboSession.Value ENABLE &&Revise
      loContForm.cboSession.ENABLED = .T.
    ELSE
      STORE '' TO loContForm.laRSession
      *Old: SHOW GET loContform.cboSession.Value DISABLE &&Revise
      loContForm.cboSession.ENABLED = .F.
      *Old: SHOW GET pbRemCntrb DISABLE &&Revise
      loContForm.cmdRemove.ENABLED = .F.
    ENDIF
    *Old: =lfRefresh('APMATST0')
    loContForm.REFRESH()
    =lfvAplRSess(loFormSet, loForm, loContForm)
  ENDIF

  RETURN
  *-- End of lfvRemCntrb




  *!*************************************************************
  *! Name      : lfvProCntrb
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 11/07/2004
  *! Purpose   : Called From the Click Event of the Proceed command button in Sub Contribution Screen
  *!*************************************************************
  *! Parameters: The FormSet of APPYINV.SCX, The Form of APINVDT.SCX, The Form of APMATST.SCX
  *!*************************************************************
  *! Returns   :  None
  *!*************************************************************
FUNCTION lfvProCntrb
  PARAMETERS loFormSet, loForm, loContForm
  PRIVATE lcRcvQty, lcLnFldName, lcAcFldName
  LOCAL loTemp

  lcRcvQty = loContForm.lcRcvQty
  lcLnFldName = loContForm.lcLnFldName
  lcAcFldName = loContForm.lcAcFldName
  SELECT (loFormSet.lcAPInvTkt)
  *Get PO style price for styles have no detail costing
  loContForm.lcMfgCode = loForm.lcOprCode

  *Get distribution line no. from invoice tkt    [Start]
  REPLACE apinvhdr.nlastvilno WITH  lfGetMaxLin(loFormSet, loForm) IN apinvhdr
  *Get distribution line no. from invoice tkt    [End]
  *ASM, Key of Bomline index in case of Shipment and non shipment
  *CIMTYP+CTYPE+CBOMTYP+MFGCODE+SHIPNO+CRSESSION+CTKTNO+STR(LINENO,6)+CINVTYPE+STYLE+CSTYGRADE ;
  *CIMTYP+CTYPE+CBOMTYP+MFGCODE+CTKTNO+CRSESSION+SHIPNO+STR(LINENO,6)+CINVTYPE+STYLE+CSTYGRADE

  IF EMPTY(loContForm.lcContItem)
    IF INLIST(loForm.lcTktType,'S','I','M') AND loForm.lcOprCode=REPLICATE('*',6) AND ;
        IIF(loForm.lcTktType='S',loFormSet.BOMLINE.SEEK('I2'+loForm.lcCstType+PADR('*'+loForm.lcCstType,6)+loContForm.lcShipNo+loContForm.kbRSession) OR ;
        loFormSet.BOMLINE.SEEK('I2'+loForm.lcCstType+'******'+loContForm.lcShipNo+loContForm.kbRSession),;
        loFormSet.BOMLINE.SEEK(loForm.lcTktType+'2'+loForm.lcCstType+PADR('*'+loForm.lcCstType,6)+loContForm.lcTicket+loContForm.kbRSession) OR ;
        loFormSet.BOMLINE.SEEK(loForm.lcTktType+'2'+loForm.lcCstType+'******'+loContForm.lcTicket+loContForm.kbRSession))
      loContForm.lcMfgCode = PADR(BOMLINE.MFGCODE,6) &&Sql
    ENDIF
    IF INLIST(loForm.lcTktType,'S','I','M') AND loForm.lcOprCode=REPLICATE('#',6) AND ;
        IIF(loForm.lcTktType='S',loFormSet.BOMLINE.SEEK('I2'+loForm.lcCstType+PADR('*'+loForm.lcCstType,6)+loContForm.lcShipNo+loContForm.kbRSession) OR ;
        loFormSet.BOMLINE.SEEK('I2'+loForm.lcCstType+'######'+loContForm.lcShipNo+loContForm.kbRSession),;
        loFormSet.BOMLINE.SEEK(loForm.lcTktType+'2'+loForm.lcCstType+PADR('*'+loForm.lcCstType,6)+loContForm.lcTicket+loContForm.kbRSession) OR ;
        loFormSet.BOMLINE.SEEK(loForm.lcTktType+'2'+loForm.lcCstType+'######'+loContForm.lcTicket+loContForm.kbRSession))
      loContForm.lcMfgCode = PADR(BOMLINE.MFGCODE,6) &&Sql
    ENDIF
  ELSE
    IF INLIST(loForm.lcTktType,'S','I','M') AND loForm.lcOprCode=REPLICATE('*',6)
      =SEEK(PADR(loContForm.lcContItem,19),'STYLE')
      loContForm.lcMfgCode=IIF(!STYLE.lDetCost,PADR('*'+loForm.lcCstType,6),loForm.lcOprCode)
    ENDIF
    IF INLIST(loForm.lcTktType,'S','I','M') AND loForm.lcOprCode=REPLICATE('#',6)
      =SEEK(PADR(loContForm.lcContItem,19),'STYLE')
      loContForm.lcMfgCode=IIF(!STYLE.lDetCost,PADR('*'+loForm.lcCstType,6),loForm.lcOprCode)
    ENDIF
  ENDIF

  *Fix the contribution process [Begin]
  lcBomOrd = ORDER('BOMLINE') &&Sql
  llSeekBom = .F.
  *ALB Fix the contribution process [End]
  DO CASE
    CASE loForm.lcTktType  = 'S'
      loFormSet.lcFileInUse = 'POSLN'
      SELECT POSLN
      loFormSet.POSLN.SetOrder('POSHREC')  &&Sql ;
      *SHIPNO+CRSESSION+CBUSDOCU+CSTYTYPE+PO+CINVTYPE+STYLE+STR(LINENO,6)+TRANCD ;
      (SHIPNO+CRSESSION+CSTYTYPE+PO+STYLE+STR(LINENO,6)+TRANCD)
      *Fix the contribution process  to save the invoice[Begin]
      loFormSet.lcForCond   = "loFormSet.PosHdr.seek('PP'+BOMLINE.CTKTNO,'POSHDR') and "+;
        "POSHDR.STATUS $ 'ACO' AND Style=ALLTRIM(EVALUATE(loFormSet.lcAPvInvDt+'.Item')) "+;
        "AND crsession = loContForm.kbRSession" &&Sql
      lcBomCond = "Bomline.cimtyp + Bomline.ctype + Bomline.cbomtyp + Bomline.mfgcode +;
                 Bomline.shipno + Bomline.crsession +ctktno+STR(lineno,6)+style+sclr+cstygrade" && Sql
      lcBomKey  = 'I2'+loForm.lcCstType+loContForm.lcMfgCode+loContForm.lcShipNo && Sql
      SELECT BOMLINE
      *Old: SET ORDER TO TAG Bomshrec
      loFormSet.BOMLINE.SetOrder('Bomshrec') &&Sql Check Tag ;
      *CIMTYP+CTYPE+CBOMTYP+MFGCODE+SHIPNO+CRSESSION+CTKTNO+STR(LINENO,6)+CINVTYPE+STYLE+CSTYGRADE ;
      (CIMTYP+CTYPE+CBOMTYP+MFGCODE+SHIPNO+CRSESSION+CTKTNO+STR(LINENO,6)+STYLE+SCLR+CSTYGRADE)
      llSeekBom = loFormSet.BOMLINE.SEEK(lcBomKey) && Sql
      *Fix the contribution process to save the invoice[END]

      loFormSet.lcCondition = 'SHIPNO+CRSESSION+CSTYTYPE+PO+STYLE+STR(LINENO,6)+TRANCD'
      lcKey       = loContForm.lcShipNo+loContForm.kbRSession


      lcItem   = 'PosLn.Style'
      lcGrade  = 'POSLN.cStyGrade'
      lcColor  = 'SPACE(6)'
      lcDyelot = 'SPACE(10)'
      *Define variable holds the header file   [Start]
      lcHdrFile= 'POSHDR'
      lcHdrOred= 'Poshdr'
      lcHdrKey = "PP"

    CASE INLIST(loForm.lcTktType,'A')
      loFormSet.lcFileInUse = 'POSLN'
      loFormSet.lcCondition = 'CSTYTYPE+PO+CRSESSION+SHIPNO+STYLE+STR(LINENO,6)+TRANCD'
      loFormSet.lcForCond   = ".T."
      SELECT POSLN
      *Old: SET ORDER TO TAG POSREC IN POSLN
      loFormSet.POSLN.SetOrder('POSREC') &&Sql Check Tag ;
      *CBUSDOCU+CSTYTYPE+PO+CRSESSION+SHIPNO+CINVTYPE+STYLE+STR(LINENO,6)+TRANCD+CSTYGRADE ;
      (CSTYTYPE+PO+CRSESSION+SHIPNO+STYLE+STR(LINENO,6)+TRANCD)
      IF loFormSet.POSLN.SEEK("PA" + loContForm.lcTicket + loContForm.kbRSession) &&Sql
        loContForm.lcShipNo = PosLn.ShipNo
      ENDIF
      lcKey      = "PA"+loContForm.lcTicket+loContForm.kbRSession+loContForm.lcShipNo+"0001"+ALLTRIM(EVALUATE(loFormSet.lcAPvInvDt+'.Item'))
      lcBomCond = "Bomline.cimtyp + Bomline.ctype + Bomline.cbomtyp + Bomline.mfgcode +;
                 Bomline.shipno + Bomline.crsession +ctktno+STR(lineno,6)+style+sclr+cstygrade" && Sql
      lcBomKey  = 'A3'+loForm.lcCstType+loContForm.lcMfgCode+loContForm.lcShipNo+loContForm.kbRSession+loContForm.lcTicket && Sql
      loFormSet.lcForCond = ".T. AND " +IIF(EMPTY(EVALUATE(loFormSet.lcAPvInvDt+'.Item')),'.T.',;
        "style = '"+EVALUATE(loFormSet.lcAPvInvDt+'.Item')+"'")

      SELECT BOMLINE
      *Old: SET ORDER TO TAG Bomshrec
      loFormSet.BOMLINE.SetOrder('Bomshrec') &&Sql Check Tag ;
      *CIMTYP+CTYPE+CBOMTYP+MFGCODE+SHIPNO+CRSESSION+CTKTNO+STR(LINENO,6)+CINVTYPE+STYLE+CSTYGRADE ;
      (CIMTYP+CTYPE+CBOMTYP+MFGCODE+SHIPNO+CRSESSION+CTKTNO+STR(LINENO,6)+STYLE+SCLR+CSTYGRADE)
      llSeekBom =loFormSet.BOMLINE.SEEK(lcBomKey) && Sql
      lcItem   = 'PosLn.Style'
      lcColor  = 'SPACE(6)'
      lcDyelot = 'SPACE(10)'
      lcGrade  = 'POSLN.cStyGrade'
      lcHdrFile= 'POSHDR'
      lcHdrOred= 'Poshdr'
      lcHdrKey = "PA"

    CASE INLIST(loForm.lcTktType,'D')
      loFormSet.lcFileInUse = 'POSLN'
      loFormSet.lcCondition = 'CSTYTYPE+PO+CRSESSION+SHIPNO+STYLE+STR(LINENO,6)+TRANCD'
      loFormSet.lcForCond   = ".T."
      SELECT POSLN
      *Old: SET ORDER TO TAG POSREC IN POSLN
      loFormSet.POSLN.SetOrder('POSREC') &&Sql Check Tag ;
      *CBUSDOCU+CSTYTYPE+PO+CRSESSION+SHIPNO+CINVTYPE+STYLE+STR(LINENO,6)+TRANCD+CSTYGRADE ;
      (CSTYTYPE+PO+CRSESSION+SHIPNO+STYLE+STR(LINENO,6)+TRANCD)
      IF loFormSet.POSLN.SEEK("PD"+ loContForm.lcTicket + loContForm.kbRSession) && Sql
        loContForm.lcShipNo = PosLn.ShipNo
      ENDIF
      lcKey      = "PD"+loContForm.lcTicket+loContForm.kbRSession+loContForm.lcShipNo+"0001"+ALLTRIM(EVALUATE(loFormSet.lcAPvInvDt+'.Item'))
      lcBomCond = "Bomline.cimtyp + Bomline.ctype + Bomline.cbomtyp + Bomline.mfgcode +;
                 Bomline.shipno + Bomline.crsession +ctktno+STR(lineno,6)+style+sclr+cstygrade" && Sql
      lcBomKey  = 'D2'+loForm.lcCstType+loContForm.lcMfgCode+loContForm.lcShipNo+loContForm.kbRSession+loContForm.lcTicket && Sql
      loFormSet.lcForCond = ".T. AND " +IIF(EMPTY(EVALUATE(loFormSet.lcAPvInvDt+'.Item')),'.T.',;
        "style = '"+EVALUATE(loFormSet.lcAPvInvDt+'.Item')+"'")

      SELECT BOMLINE
      *Old: SET ORDER TO TAG Bomshrec
      loFormSet.BOMLINE.SetOrder('Bomshrec') &&Sql Check Tag ;
      *CIMTYP+CTYPE+CBOMTYP+MFGCODE+SHIPNO+CRSESSION+CTKTNO+STR(LINENO,6)+CINVTYPE+STYLE+CSTYGRADE ;
      (CIMTYP+CTYPE+CBOMTYP+MFGCODE+SHIPNO+CRSESSION+CTKTNO+STR(LINENO,6)+STYLE+SCLR+CSTYGRADE)
      llSeekBom =loFormSet.BOMLINE.SEEK(lcBomKey) && Sql
      lcItem   = 'PosLn.Style'
      lcColor  = 'SPACE(6)'
      lcDyelot = 'SPACE(10)'
      lcGrade  = 'POSLN.cStyGrade'
      lcHdrFile= 'POSHDR'
      lcHdrOred= 'Poshdr'
      lcHdrKey = "PD"

    CASE INLIST(loForm.lcTktType,'I','R')
      loFormSet.lcFileInUse = 'POSLN'
      loFormSet.lcCondition = 'CSTYTYPE+PO+CRSESSION+SHIPNO+STYLE+STR(LINENO,6)+TRANCD'


      loFormSet.lcForCond   = ".T."
      SELECT POSLN
      loFormSet.POSLN.SetOrder('POSREC') &&Sql Check Tag ;
      *CBUSDOCU+CSTYTYPE+PO+CRSESSION+SHIPNO+CINVTYPE+STYLE+STR(LINENO,6)+TRANCD+CSTYGRADE ;
      (CSTYTYPE+PO+CRSESSION+SHIPNO+STYLE+STR(LINENO,6)+TRANCD)

      *Get Value of Ship No to add to index [Begin]
      IF loFormSet.POSLN.SEEK(IIF(loForm.lcTktType='I','PP','RP') + loContForm.lcTicket + loContForm.kbRSession) && Sql
        loContForm.lcShipNo = PosLn.ShipNo
      ENDIF
      lcKey       = IIF(loForm.lcTktType='I','PP','RP')+loContForm.lcTicket+loContForm.kbRSession+loContForm.lcShipNo+"0001"+ALLTRIM(EVALUATE(loFormSet.lcAPvInvDt+'.Item'))
      *Get Value of Ship No to add to index [End]

      lcBomCond = "Bomline.cimtyp + Bomline.ctype + Bomline.cbomtyp + Bomline.mfgcode +;
                 Bomline.shipno + Bomline.crsession +ctktno+STR(lineno,6)+style+sclr+cstygrade" && Sql
      lcBomKey  = 'I2'+loForm.lcCstType+loContForm.lcMfgCode+loContForm.lcShipNo+loContForm.kbRSession+loContForm.lcTicket && Sql

      *B608642,1 WAM 08/04/2008 Get only receiving lines
      *loFormSet.lcForCond = ".T. AND " +IIF(EMPTY(EVALUATE(loFormSet.lcAPvInvDt+'.Item')),'.T.',;
      "style = '"+EVALUATE(loFormSet.lcAPvInvDt+'.Item')+"'")
      loFormSet.lcForCond = "TRANCD='2' AND " +IIF(EMPTY(EVALUATE(loFormSet.lcAPvInvDt+'.Item')),'.T.',;
        "style = '"+EVALUATE(loFormSet.lcAPvInvDt+'.Item')+"'")
      *B608642,1 WAM 08/04/2008 Get only receiving lines

      SELECT BOMLINE
      *Old: SET ORDER TO TAG Bomshrec
      loFormSet.BOMLINE.SetOrder('Bomshrec') &&Sql Check Tag ;
      *CIMTYP+CTYPE+CBOMTYP+MFGCODE+SHIPNO+CRSESSION+CTKTNO+STR(LINENO,6)+CINVTYPE+STYLE+CSTYGRADE ;
      (CIMTYP+CTYPE+CBOMTYP+MFGCODE+SHIPNO+CRSESSION+CTKTNO+STR(LINENO,6)+STYLE+SCLR+CSTYGRADE)
      llSeekBom =loFormSet.BOMLINE.SEEK(lcBomKey) && Sql


      lcItem   = 'PosLn.Style'
      lcColor  = 'SPACE(6)'
      lcDyelot = 'SPACE(10)'
      lcGrade  = 'POSLN.cStyGrade'

      lcHdrFile= 'POSHDR'
      lcHdrOred= 'Poshdr'
      lcHdrKey = IIF(loForm.lcTktType='I','PP','RP')

    CASE loForm.lcTktType = 'M'
      loFormSet.lcFileInUse = 'CUTTKTL'
      loFormSet.lcCondition = 'CRSESSION+CUTTKT+STYLE+TRANCD'
      lcKey       = 'PU'+loContForm.lcTicket+loContForm.kbRSession+SPACE(6)+"0001"+ALLTRIM(EVALUATE(loFormSet.lcAPvInvDt+'.Item'))
      loFormSet.lcForCond   = ".T."
      SELECT CUTTKTL
      *Old: SET ORDER TO TAG CUTREC  IN CUTTKTL
      loFormSet.CUTTKTL.SetOrder('POSREC') &&Sql Check Tag ;
      *CBUSDOCU+CSTYTYPE+PO+CRSESSION+SHIPNO+CINVTYPE+STYLE+STR(LINENO,6)+TRANCD+CSTYGRADE ;
      (CSTYTYPE+PO+CRSESSION+SHIPNO+STYLE+STR(LINENO,6)+TRANCD)

      lcBomCond = "Bomline.cimtyp + Bomline.ctype + Bomline.cbomtyp + Bomline.mfgcode +Bomline.shipno +Bomline.crsession+Bomline.ctktno" && Sql
      lcBomKey  = 'M2'+loForm.lcCstType+loContForm.lcMfgCode+loContForm.lcShipNo + loContForm.kbRSession + loContForm.lcTicket && Sql

      *B608642,1 WAM 08/04/2008 Get only receiving lines
      *loFormSet.lcForCond = ".T. AND " +IIF(EMPTY(EVALUATE(loFormSet.lcAPvInvDt+'.Item')),'.T.',;
      "style = '"+EVALUATE(loFormSet.lcAPvInvDt+'.Item')+"'")
      loFormSet.lcForCond = "TRANCD='2' AND " +IIF(EMPTY(EVALUATE(loFormSet.lcAPvInvDt+'.Item')),'.T.',;
        "style = '"+EVALUATE(loFormSet.lcAPvInvDt+'.Item')+"'")
      *B608642,1 WAM 08/04/2008 (End)

      SELECT BOMLINE
      *Old: SET ORDER TO TAG Bomshrec
      loFormSet.BOMLINE.SetOrder('Bomshrec') &&Sql Check Tag ;
      *CIMTYP+CTYPE+CBOMTYP+MFGCODE+SHIPNO+CRSESSION+CTKTNO+STR(LINENO,6)+CINVTYPE+STYLE+CSTYGRADE ;
      (CIMTYP+CTYPE+CBOMTYP+MFGCODE+SHIPNO+CRSESSION+CTKTNO+STR(LINENO,6)+STYLE+SCLR+CSTYGRADE)
      llSeekBom =loFormSet.BOMLINE.SEEK(lcBomKey) && Sql


      lcItem   = 'CUTTKTL.Style'
      lcColor  = 'SPACE(6)'
      lcDyelot = 'CUTTKTL.Dyelot'
      lcGrade  = 'CUTTKTL.cStyGrade'
      lcHdrFile= 'CUTTKTH'
      lcHdrOred= 'Poshdr'
      lcHdrKey = "PU"

    CASE INLIST(loForm.lcTktType,'L','F')
      loFormSet.lcFileInUse = 'POFLN'
      *Old: SET ORDER TO TAG POFREC IN POFLN
      loFormSet.POFLN.SetOrder('POSREC') &&Sql Check Tag ;
      *CBUSDOCU+CSTYTYPE+PO+CRSESSION+SHIPNO+CINVTYPE+STYLE+STR(LINENO,6)+TRANCD+CSTYGRADE ;
      (CSTYTYPE+PO+CRSESSION+SHIPNO+STYLE+STR(LINENO,6)+TRANCD)
      loFormSet.lcCondition = 'cMatType+PoMat+cRSession+Fabric+Color+Trancd'
      *B128365,1 ASM 06/06/2005  [Start]
      *lcKey       = IIF(loForm.lcTktType='L','PM','RM')+loContForm.lcTicket+loContForm.kbRSession+SPACE(6)+"0002"+;
      IIF(EMPTY(EVALUATE(loFormSet.lcAPvInvDt+'.Item')),'',;
      lfupditem(SUBSTR(EVALUATE(loFormSet.lcAPvInvDt+'.Item'),1,7),EVALUATE(loFormSet.lcAPvInvDt+'.Color')))
      IF loFormSet.POFLN.SEEK(IIF(loForm.lcTktType='L','PM','RM') + loContForm.lcTicket + loContForm.kbRSession)
        loContForm.lcShipNo = PofLn.ShipNo
      ENDIF
      lcKey       = IIF(loForm.lcTktType='L','PM','RM')+loContForm.lcTicket+loContForm.kbRSession+loContForm.lcShipNo+"0002"+;
        IIF(EMPTY(EVALUATE(loFormSet.lcAPvInvDt+'.Item')),'',;
        lfupditem(SUBSTR(EVALUATE(loFormSet.lcAPvInvDt+'.Item'),1,loFormSet.lnFabMajLen),EVALUATE(loFormSet.lcAPvInvDt+'.Color')))
      *B128365,1 ASM 06/06/2005  [End]

      *B608642,1 WAM 08/04/2008 Get only receiving lines
      *loFormSet.lcForCond = ".T. AND " +IIF(EMPTY(EVALUATE(loFormSet.lcAPvInvDt+'.Item')),'.T.',;
      "style = '"+lfupditem(SUBSTR(EVALUATE(loFormSet.lcAPvInvDt+'.Item'),1,loFormSet.lnFabMajLen),EVALUATE(loFormSet.lcAPvInvDt+'.Color'))+"'")
      loFormSet.lcForCond = "TRANCD='2' AND " +IIF(EMPTY(EVALUATE(loFormSet.lcAPvInvDt+'.Item')),'.T.',;
        "style = '"+lfupditem(SUBSTR(EVALUATE(loFormSet.lcAPvInvDt+'.Item'),1,loFormSet.lnFabMajLen),EVALUATE(loFormSet.lcAPvInvDt+'.Color'))+"'")

      *B608642,1 WAM 08/04/2008 (End)

      lcItem      = 'left(POFLN.Style,loFormSet.lnFabMajLen)'
      lcColor     = 'substr(POFLN.Style,loFormSet.lnFabClrStart,loFormSet.lnFabClrLen)'
      lcDyelot    = 'POFLN.Dyelot'
      *lcGrade     = 'POFLN.cFabGrade'
      lcGrade     = 'POFLN.cStyGrade'
      lcHdrFile= 'POFHDR'
      lcHdrOred= 'Poshdr'
      lcHdrKey = IIF(loForm.lcTktType='L','PM','RM')
      lcBomKey = ""


    CASE loForm.lcTktType = 'T'

      loFormSet.lcFileInUse = 'MMFGORDD'
      loFormSet.lcCondition = 'cRSession+cmfgordno+cfabric+color+dyelot+trancd'
      lcKey       = 'PF'+loContForm.lcTicket+loContForm.kbRSession+SPACE(6)+"0002"+IIF(EMPTY(EVALUATE(loFormSet.lcAPvInvDt+'.Item')),'',;
        lfupditem(SUBSTR(EVALUATE(loFormSet.lcAPvInvDt+'.Item'),1,loFormSet.lnFabMajLen),EVALUATE(loFormSet.lcAPvInvDt+'.Color')))
      loFormSet.lcForCond   = ".T."
      SELECT MMFGORDD
      *Old: SET ORDER TO TAG MFGREC IN MMFGORDD
      loFormSet.MMFGORDD.SetOrder('POSREC') &&Sql Check Tag ;
      *CBUSDOCU+CSTYTYPE+PO+CRSESSION+SHIPNO+CINVTYPE+STYLE+STR(LINENO,6)+TRANCD+CSTYGRADE ;
      (CSTYTYPE+PO+CRSESSION+SHIPNO+STYLE+STR(LINENO,6)+TRANCD)
      lcBomCond = "Bomline.cimtyp + Bomline.ctype + Bomline.cbomtyp + Bomline.mfgcode +Bomline.shipno "+;
        "+Bomline.crsession+Bomline.ctktno+STR(lineno,6)+style+sclr+cstygrade"

      lcBomKey  = 'T2'+loForm.lcCstType+loContForm.lcMfgCode+loContForm.lcShipNo + loContForm.kbRSession + loContForm.lcTicket
      loFormSet.lcForCond = ".T. AND " +IIF(EMPTY(EVALUATE(loFormSet.lcAPvInvDt+'.Item')),'.T.',;
        "style = '"+lfupditem(SUBSTR(EVALUATE(loFormSet.lcAPvInvDt+'.Item'),1,loFormSet.lnFabMajLen),EVALUATE(loFormSet.lcAPvInvDt+'.Color'))+"'")
      SELECT BOMLINE
      loFormSet.BOMLINE.SetOrder('Bomshrec') &&Sql Check Tag ;
      *CIMTYP+CTYPE+CBOMTYP+MFGCODE+SHIPNO+CRSESSION+CTKTNO+STR(LINENO,6)+CINVTYPE+STYLE+CSTYGRADE ;
      (CIMTYP+CTYPE+CBOMTYP+MFGCODE+SHIPNO+CRSESSION+CTKTNO+STR(LINENO,6)+STYLE+SCLR+CSTYGRADE)
      llSeekBom =loFormSet.BOMLINE.SEEK(lcBomKey) && Sql

      lcItem      = 'left(MMFGORDD.Style,loFormSet.lnFabMajLen)'
      lcColor     = 'substr(MMFGORDD.Style,loFormSet.lnFabClrStart,loFormSet.lnFabClrLen)'
      lcDyelot    = 'MMFGORDD.Dyelot'
      *lcGrade     = 'MMFGORDD.cFabGrade'
      lcGrade     = 'MMFGORDD.cStyGrade'
      lcHdrFile= 'MMFGORDH'
      lcHdrOred= 'Poshdr'
      lcHdrKey = "PF"

  ENDCASE

  lnTotBud   = 0
  lnTItmAmt  = 0
  lnTotActCt = 0          && Total Actual Cost
  lnTotLanCt = 0          && Total Landed Cost

  DO CASE
      *Contribution Based On Budget Cost
    CASE loContForm.rbCntrb = 1
      IF INLIST(loForm.lcTktType,'L','F','R','A')
        SELECT (loFormSet.lcFileInUse)
        *Old: =SEEK(lcKey)
        loTemp = EVALUATE('loFormSet.'+loFormSet.lcFileInUse)
        loTemp.SEEK(lcKey)
        lcTemp=lcLnFldName+loForm.lcCstType+'*'+lcRcvQty
        *SUM REST &lcTemp FOR EVALUATE(loFormSet.lcForCond) TO lnTotBud
        SUM ALL &lcTemp FOR EVALUATE(loFormSet.lcForCond) TO lnTotBud
        *Old: =SEEK(lcKey)
        LOCATE
        loFormSet.lcForCond = ".T. "

        SCAN FOR EVALUATE(loFormSet.lcForCond)
          lcTemp = lcRcvQty+'*'+lcLnFldName+loForm.lcCstType
          lnTotLanCt = lnTotLanCt + &lcTemp
          lcTemp = lcRcvQty+'*'+lcAcFldName+loForm.lcCstType
          lnTotActCt = lnTotActCt + &lcTemp


          SELECT (loFormSet.lcAPInvTkt)
          APPEND BLANK
          REPLACE cStatus    WITH 'A'          ,;
            cVendCode  WITH loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE    ,;
            cApInvNo   WITH loFormSet.AriaForm1.kbInvNo.KeyTextBox.VALUE    ,;
            cRecvType  WITH IIF(&lcGrade='1','R',IIF(&lcGrade='2','S','D')) ,;
            cApVILNo   WITH loContForm.lcInvLineNo  ,;
            cIMTyp     WITH loForm.lcTktType    ,;
            cTktNo     WITH loContForm.lcTicket     ,;
            cRSession  WITH loContForm.kbRSession   ,;
            LINENO     WITH EVAL(loFormSet.lcFileInUse+'.LineNo') ,;
            ITEM       WITH &lcItem      ,;
            COLOR      WITH IIF(TYPE(lcColor)<>'U',&lcColor,'')     ,;
            cDyelot    WITH &lcDyelot    ,;
            cWareCode  WITH EVAL(loFormSet.lcFileInUse+'.cWareCode') ,;
            nApTAplQty WITH &lcRcvQty
          lcTemp = lcLnFldName+loForm.lcCstType
          REPLACE nApAPlPric WITH IIF(lnTotBud=0,0,&lcTemp*loContForm.lnAmount/lnTotBud), ;
            nApAplAmnt WITH IIF(lnTotBud=0,0,&lcTemp*&lcRcvQty/lnTotBud*loContForm.lnAmount)


          *Uppdate invoicetkt file with the WIP account in case of (S)hipment.  [Start]
          * I put this cond. "lcTktType<>'T'" untill to confirm with Khalid about how we can get
          * the gl link code for MMFGORDD file.
          REPLACE apinvhdr.nlastvilno WITH apinvhdr.nlastvilno + 1 IN apinvhdr
          REPLACE cApdGlAct WITH lfGetWIPAc(lcHdrKey+IIF(loForm.lcTktType='S',POSLN.PO,loContForm.lcTicket),lcHdrFile,lcHdrOred) ;
            cApdLinNo WITH STR(apinvhdr.nlastvilno,4)
          *Uppdate invoicetkt file with the WIP account in case of (S)hipment.  [End]

          *Get the correct WIP account with shipment ticket [Begin]
          REPLACE cApdGlAct WITH IIF(!EMPTY(EVALUATE(loFormSet.lcAPvInvDt+'.cAPDGLAct')),EVALUATE(loFormSet.lcAPvInvDt+'.cAPDGLAct'),lfGetWIPAc(lcHdrKey+IIF(loForm.lcTktType='S',POSLN.PO,loContForm.lcTicket),lcHdrFile,lcHdrOred)) ;
            cApdLinNo WITH STR(apinvhdr.nlastvilno,4)
          *Get the correct WIP account with shipment ticket [end]

          *Add this line to accumulate the value that was actually
          *          stored in the file and not the value that should be
          *          stored, to take into consideration the rounding
          *          problems [Begin]
          lnTItmAmt  = lnTItmAmt  + nApAplAmnt
          *Add this line to accumulate the value [End]

          IF INLIST(loForm.lcTktType,'R','A')
            REPLACE nApAplQty1 WITH POSLN.Qty1 ,;
              nApAplQty2 WITH POSLN.Qty2 ,;
              nApAplQty3 WITH POSLN.Qty3 ,;
              nApAplQty4 WITH POSLN.Qty4 ,;
              nApAplQty5 WITH POSLN.Qty5 ,;
              nApAplQty6 WITH POSLN.Qty6 ,;
              nApAplQty7 WITH POSLN.Qty7 ,;
              nApAplQty8 WITH POSLN.Qty8
          ENDIF
        ENDSCAN
      ELSE
        *Fix the contribution process  to save the invoice[Begin]
        IF !llSeekBom
          *Old: SET ORDER TO TAG &lcBomOrd IN BOMLINE && Sql
          loFormSet.BOMLINE.SetOrder(lcBomOrd)
          =gfModalGen(.F.,'DIALOG',.F.,.F.,'There is no such cost lines to contribute')
          RETURN
        ENDIF
        SELECT BOMLINE
        *SUM REST BOMLINE.ITEMAMT FOR EVALUATE(loFormSet.lcForCond) TO lnTotBud
        SUM ALL BOMLINE.ITEMAMT FOR EVALUATE(loFormSet.lcForCond) TO lnTotBud
        IF INLIST(loForm.lcTktType,'I','R','T','M','D')
          *B608642,1 WAM 08/04/2008 Don't overwrite the FOR expression previously built
          *loFormSet.lcForCond = ".T. "
          *B608642,1 WAM 08/04/2008 (End)
        ELSE
          loFormSet.lcForCond = "loFormSet.PosHdr.Seek('PP'+POSLN.PO) and POSHDR.STATUS $ 'ACO' "+;
            "AND IIF(EMPTY(ALLTRIM(EVALUATE(loFormSet.lcAPvInvDt+'.Item'))),.T.,Style=ALLTRIM(EVALUATE(loFormSet.lcAPvInvDt+'.Item'))) AND crsession = loContForm.kbRSession"
        ENDIF
        *Fix the contribution process  to save the invoice[End]

        SELECT (loFormSet.lcFileInUse)
        loTemp = EVALUATE('loFormSet.'+loFormSet.lcFileInUse)
        llSeek = loTemp.SEEK(lcKey) && add llseek for teacing
        SCAN REST FOR EVALUATE(loFormSet.lcForCond) .AND. &lcRcvQty <> 0
          *Get the proper MfgCode for each style and move to the proper record in BOMLINE [Start]
          =SEEK(&lcItem,'Style')
          IF !STYLE.lDetCost
            loContForm.lcMfgTmp = PADR('*'+loForm.lcCstType,6)
          ELSE
            IF loFormSet.laCostType[loForm.cboCostType.Value,3]= "P"
              loContForm.lcMfgTmp = REPLICATE('*',6)
            ENDIF
            IF loFormSet.laCostType[loForm.cboCostType.Value,3]=  "D"
              loContForm.lcMfgTmp = REPLICATE('#',6)
            ENDIF
            IF !(loFormSet.laCostType[loForm.cboCostType.Value,3]  $ "PD")
              loContForm.lcMfgTmp = loContForm.lcMfgCode
            ENDIF
          ENDIF
          *CIMTYP+CTYPE+CBOMTYP+MFGCODE+SHIPNO+CRSESSION+CTKTNO+STR(LINENO,6)+CINVTYPE+STYLE+CSTYGRADE ;
          (CIMTYP+CTYPE+CBOMTYP+MFGCODE+SHIPNO+CRSESSION+CTKTNO+STR(LINENO,6)+STYLE+SCLR+CSTYGRADE)
          DO CASE
            CASE loForm.lcTktType  = 'S'
              lcBomKey = 'I2'+loForm.lcCstType+loContForm.lcMfgTmp+loContForm.lcShipNo+CRSESSION+PO+STR(LINENO,6)+"0001"+STYLE+CSTYGRADE && Sql
            CASE INLIST(loForm.lcTktType,'A')
              lcBomKey = 'A3'+loForm.lcCstType+loContForm.lcMfgTmp+SHIPNO+CRSESSION+loContForm.lcTicket+STR(LINENO,6)+"0001"+STYLE+SPACE(6) && Sql
            CASE INLIST(loForm.lcTktType,'D')
              lcBomKey = 'D2'+loForm.lcCstType+loContForm.lcMfgTmp+SHIPNO+CRSESSION+loContForm.lcTicket+STR(LINENO,6)+"0001"+STYLE+SPACE(6) && Sql
            CASE INLIST(loForm.lcTktType,'I','R')
              *lcBomKey = 'I2'+loForm.lcCstType+loContForm.lcMfgTmp+SHIPNO+CRSESSION+loContForm.lcTicket+STR(LINENO,6)+"0001"+STYLE+SPACE(6)+CSTYGRADE && Sql
              lcBomKey = 'I2'+loForm.lcCstType+loContForm.lcMfgTmp+SHIPNO+CRSESSION+loContForm.lcTicket+STR(LINENO,6)+"0001"+STYLE+CSTYGRADE && Sql
            CASE loForm.lcTktType = 'M'            &&lower
              lcBomKey = 'M2'+loForm.lcCstType+loContForm.lcMfgTmp+SPACE(6)+CRSESSION+PO+STR(LINENO,6)+"0001"+STYLE+CSTYGRADE && Sql
            CASE INLIST(loForm.lcTktType,'L','F')
              lcBomKey = ""
            CASE loForm.lcTktType = 'T'
              lcBomKey = 'T2'+loForm.lcCstType+loContForm.lcMfgCode+SPACE(6)+CRSESSION+PO+STR(LINENO,6)+"0002"+lfupditem(cfabric,COLOR) && Sql
          ENDCASE

          llSeek = loFormSet.BOMLINE.SEEK(lcBomKey)      && add llseek for tracing && Sql
          *Get the proper MfgCode for each style and move to the proper record in BOMLINE [End]
          SELECT (loFormSet.lcFileInUse)
          IF !EOF('BOMLINE')
            m.UnitCost = IIF(lnTotBud=0,0,BomLine.ItemAmt/lnTotBud*loContForm.lnAmount/&lcRcvQty)
            m.ItemAmt  = IIF(lnTotBud=0,0,BomLine.ItemAmt/lnTotBud*loContForm.lnAmount)
            lnTotLanCt = lnTotLanCt + &lcRcvQty * EVAL(lcLnFldName+loForm.lcCstType)
            lnTotActCt = lnTotActCt + &lcRcvQty * EVAL(lcAcFldName+loForm.lcCstType)


            SELECT (loFormSet.lcAPInvTkt)
            APPEND BLANK
            REPLACE cStatus    WITH 'A'        ,;
              cVendCode  WITH loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE  ,;
              cRecvType  WITH IIF(&lcGrade='1','R',IIF(&lcGrade='2','S','D')) ,;
              cApInvNo   WITH loFormSet.AriaForm1.kbInvNo.KeyTextBox.VALUE  ,;
              cApVILNo   WITH loContForm.lcInvLineNo,;
              cRSession  WITH loContForm.kbRSession ,;
              LINENO     WITH IIF(loForm.lcTktType='T',0,EVALUATE(loFormSet.lcFileInUse+'.LineNo')) ,;
              cIMTyp     WITH loForm.lcTktType    ,;
              cTktNo     WITH IIF(loForm.lcTktType='S',POSLN.PO,loContForm.lcTicket)     ,;
              ITEM       WITH BomLine.STYLE ,;
              COLOR      WITH IIF(TYPE('BomLine.SClr')<>'U',BomLine.SClr,'')  ,;
              cDyelot    WITH &lcDyelot  ,;
              nApTAplQty WITH &lcRcvQty  ,;
              nApAPlPric WITH m.UnitCost ,;
              nApAplAmnt WITH m.ItemAmt  ,;
              cWareCode  WITH EVALUATE(loFormSet.lcFileInUse+'.cWareCode')
            *Uppdate invoicetkt file with the WIP account in case of (S)hipment.  [Start]
            REPLACE apinvhdr.nlastvilno WITH  apinvhdr.nlastvilno  + 1 IN apinvhdr
            REPLACE cApdGlAct WITH lfGetWIPAc(lcHdrKey+IIF(loForm.lcTktType='S',POSLN.PO,loContForm.lcTicket),lcHdrFile,lcHdrOred) ;
              cApdLinNo WITH STR(apinvhdr.nlastvilno,4)
            *Uppdate invoicetkt file with the WIP account in case of (S)hipment.  [End]

            *Get the correct WIP account with shipment ticket [Begin]
            REPLACE cApdGlAct WITH IIF(!EMPTY(EVALUATE(loFormSet.lcAPvInvDt+'.cAPDGLAct')),EVALUATE(loFormSet.lcAPvInvDt+'.cAPDGLAct'),lfGetWIPAc(lcHdrKey+IIF(loForm.lcTktType='S',POSLN.PO,loContForm.lcTicket),lcHdrFile,lcHdrOred)) ;
              cApdLinNo WITH STR(apinvhdr.nlastvilno,4)
            *Get the correct WIP account with shipment ticket [end]
            *Add this line to accumulate the value that was
            *          actually stored in the file and not the value that
            *          should be stored, to take into consideration the
            *          rounding problems [Begin]
            lnTItmAmt  = lnTItmAmt + nApAplAmnt
            *Add this line to accumulate the value [End]
            IF INLIST(loForm.lcTktType,'S','I','M','A','D','R')
              REPLACE nApAplQty1 WITH EVALUATE(loFormSet.lcFileInUse+'.Qty1') ,;
                nApAplQty2 WITH EVALUATE(loFormSet.lcFileInUse+'.Qty2') ,;
                nApAplQty3 WITH EVALUATE(loFormSet.lcFileInUse+'.Qty3') ,;
                nApAplQty4 WITH EVALUATE(loFormSet.lcFileInUse+'.Qty4') ,;
                nApAplQty5 WITH EVALUATE(loFormSet.lcFileInUse+'.Qty5') ,;
                nApAplQty6 WITH EVALUATE(loFormSet.lcFileInUse+'.Qty6') ,;
                nApAplQty7 WITH EVALUATE(loFormSet.lcFileInUse+'.Qty7') ,;
                nApAplQty8 WITH EVALUATE(loFormSet.lcFileInUse+'.Qty8')
            ENDIF
          ENDIF
        ENDSCAN
      ENDIF

      *Contribution Based On Received Quantity
    CASE loContForm.rbCntrb = 2
      SELECT (loFormSet.lcFileInUse)
      loTemp = EVALUATE('loFormSet.'+loFormSet.lcFileInUse)
      loTemp.SEEK(lcKey)
      IF !INLIST(loForm.lcTktType,'S')
        *B608642,1 WAM 08/04/2008 Don't overwrite the FOR expression previously built
        *loFormSet.lcForCond = ".T. "
        *B608642,1 WAM 08/04/2008 (End)
      ELSE
        loFormSet.lcForCond = "loFormSet.PosHdr.Seek('PP'+POSLN.PO)and POSHDR.status $ 'ACO' "+;
          "AND IIF(EMPTY(ALLTRIM(EVALUATE(loFormSet.lcAPvInvDt+'.Item'))),.T.,Style=ALLTRIM(EVALUATE(loFormSet.lcAPvInvDt+'.Item'))) AND crsession = loContForm.kbRSession" && Sql
      ENDIF
      *SUM REST &lcRcvQty WHILE EVAL(loFormSet.lcCondition)=lcKey FOR EVALUATE(loFormSet.lcForCond) TO lnTotBud
      SUM ALL &lcRcvQty FOR EVALUATE(loFormSet.lcForCond) TO lnTotBud
      *Old: =SEEK(lcKey)
      loTemp.SEEK(lcKey)
      SCAN REST FOR EVALUATE(loFormSet.lcForCond) .AND. &lcRcvQty <> 0
        SELECT (loFormSet.lcAPInvTkt)
        APPEND BLANK

        REPLACE cStatus  WITH 'A'           ,;
          cVendCode  WITH loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE     ,;
          cApInvNo   WITH loFormSet.AriaForm1.kbInvNo.KeyTextBox.VALUE     ,;
          cApVILNo   WITH loContForm.lcInvLineNo   ,;
          cIMTyp     WITH loForm.lcTktType     ,;
          cTktNo     WITH IIF(loForm.lcTktType='S',POSLN.PO,loContForm.lcTicket) ,;
          cRSession  WITH loContForm.kbRSession    ,;
          cRecvType  WITH IIF(&lcGrade='1','R',IIF(&lcGrade='2','S','D')) ,;
          LINENO     WITH IIF(loForm.lcTktType='T',0,EVALUATE(loFormSet.lcFileInUse+'.LineNo')) ,;
          ITEM       WITH EVAL(lcItem)  ,;
          COLOR      WITH IIF(TYPE(lcColor)<>'U',&lcColor,'') ,;
          cDyelot    WITH EVAL(lcDyelot),;
          nApTAplQty WITH &lcRcvQty     ,;
          nApAPlPric WITH loContForm.lnAmount/ lnTotBud ,;
          cWareCode  WITH EVALUATE(loFormSet.lcFileInUse+'.cWareCode') ,;
          nApAplAmnt WITH &lcRcvQty*loContForm.lnAmount/lnTotBud
        REPLACE apinvhdr.nlastvilno WITH apinvhdr.nlastvilno  + 1 IN apinvhdr
        REPLACE cApdGlAct WITH lfGetWIPAc(lcHdrKey+IIF(loForm.lcTktType='S',POSLN.PO,loContForm.lcTicket),lcHdrFile,lcHdrOred) ;
          cApdLinNo WITH  STR(apinvhdr.nlastvilno,4)

        *Get the correct WIP account with shipment ticket [Begin]
        REPLACE cApdGlAct WITH IIF(!EMPTY(EVALUATE(loFormSet.lcAPvInvDt+'.cAPDGLAct')),EVALUATE(loFormSet.lcAPvInvDt+'.cAPDGLAct'),lfGetWIPAc(lcHdrKey+IIF(loForm.lcTktType='S',POSLN.PO,loContForm.lcTicket),lcHdrFile,lcHdrOred)) ;
          cApdLinNo WITH STR(apinvhdr.nlastvilno,4)
        *Get the correct WIP account with shipment ticket [end]

        *Add this line to accumulate the value that was
        *          actually stored in the file and not the value that
        *          should be stored, to take into consideration the
        *          rounding problems [Begin]
        lnTItmAmt  = lnTItmAmt  + nApAplAmnt
        *Add this line to accumulate the value [End]
        IF INLIST(loForm.lcTktType,'S','I','M','R','A','D')
          REPLACE nApAplQty1 WITH EVALUATE(loFormSet.lcFileInUse+'.Qty1') ,;
            nApAplQty2 WITH EVALUATE(loFormSet.lcFileInUse+'.Qty2') ,;
            nApAplQty3 WITH EVALUATE(loFormSet.lcFileInUse+'.Qty3') ,;
            nApAplQty4 WITH EVALUATE(loFormSet.lcFileInUse+'.Qty4') ,;
            nApAplQty5 WITH EVALUATE(loFormSet.lcFileInUse+'.Qty5') ,;
            nApAplQty6 WITH EVALUATE(loFormSet.lcFileInUse+'.Qty6') ,;
            nApAplQty7 WITH EVALUATE(loFormSet.lcFileInUse+'.Qty7') ,;
            nApAplQty8 WITH EVALUATE(loFormSet.lcFileInUse+'.Qty8')
        ENDIF
        lnTotLanCt = lnTotLanCt + &lcRcvQty * EVAL(lcLnFldName+loForm.lcCstType)
        lnTotActCt = lnTotActCt + &lcRcvQty * EVAL(lcAcFldName+loForm.lcCstType)


      ENDSCAN

      *Contribute Manually
    CASE loContForm.rbCntrb = 3
      SELECT (loFormSet.lcFileInUse)
      loTemp = EVALUATE('loFormSet.'+loFormSet.lcFileInUse)
      loTemp.SEEK(lcKey)
      IF !INLIST(loForm.lcTktType,'S')
        *B608642,1 WAM 08/04/2008 Don't overwrite the FOR expression previously built
        *loFormSet.lcForCond = ".T. "
        *B608642,1 WAM 08/04/2008 (End)
      ELSE
        loFormSet.lcForCond = "loFormSet.PosHdr.Seek('PP'+POSLN.PO)and POSHDR.status $ 'ACO' "+;
          "AND IIF(EMPTY(ALLTRIM(EVALUATE(loFormSet.lcAPvInvDt+'.Item'))),.T.,Style=ALLTRIM(EVALUATE(loFormSet.lcAPvInvDt+'.Item'))) AND crsession = loContForm.kbRSession" && Sql

      ENDIF
      SCAN REST FOR EVALUATE(loFormSet.lcForCond) .AND. &lcRcvQty <> 0
        SELECT (loFormSet.lcAPInvTkt)
        APPEND BLANK

        REPLACE cStatus  WITH 'A'           ,;
          cVendCode  WITH loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE     ,;
          cApInvNo   WITH loFormSet.AriaForm1.kbInvNo.KeyTextBox.VALUE     ,;
          cApVILNo   WITH loContForm.lcInvLineNo   ,;
          cIMTyp     WITH loForm.lcTktType     ,;
          cTktNo     WITH IIF(loForm.lcTktType='S',POSLN.PO,loContForm.lcTicket) ,;
          cRSession  WITH loContForm.kbRSession    ,;
          cRecvType  WITH IIF(&lcGrade='1','R',IIF(&lcGrade='2','S','D')) ,;
          LINENO     WITH IIF(loForm.lcTktType='T',0,EVALUATE(loFormSet.lcFileInUse+'.LineNo')) ,;
          ITEM       WITH EVAL(lcItem)  ,;
          COLOR      WITH IIF(TYPE(lcColor)<>'U',&lcColor,'') ,;
          cDyelot    WITH EVAL(lcDyelot),;
          nApTAplQty WITH &lcRcvQty     ,;
          nApAPlPric WITH 0 ,;
          cWareCode  WITH EVALUATE(loFormSet.lcFileInUse+'.cWareCode') ,;
          nApAplAmnt WITH 0

        *--Alb
        *Uppdate invoicetkt file with the WIP account in case of (S)hipment.  [Start]
        REPLACE apinvhdr.nlastvilno WITH apinvhdr.nlastvilno  + 1 IN apinvhdr
        REPLACE cApdGlAct WITH lfGetWIPAc(lcHdrKey+IIF(loForm.lcTktType='S',POSLN.PO,loContForm.lcTicket),lcHdrFile,lcHdrOred) ;
          cApdLinNo WITH STR(apinvhdr.nlastvilno,4)
        *Uppdate invoicetkt file with the WIP account in case of (S)hipment.  [End]
        IF INLIST(loForm.lcTktType,'S','I','M','R','A','D')
          REPLACE nApAplQty1 WITH EVALUATE(loFormSet.lcFileInUse+'.Qty1') ,;
            nApAplQty2 WITH EVALUATE(loFormSet.lcFileInUse+'.Qty2') ,;
            nApAplQty3 WITH EVALUATE(loFormSet.lcFileInUse+'.Qty3') ,;
            nApAplQty4 WITH EVALUATE(loFormSet.lcFileInUse+'.Qty4') ,;
            nApAplQty5 WITH EVALUATE(loFormSet.lcFileInUse+'.Qty5') ,;
            nApAplQty6 WITH EVALUATE(loFormSet.lcFileInUse+'.Qty6') ,;
            nApAplQty7 WITH EVALUATE(loFormSet.lcFileInUse+'.Qty7') ,;
            nApAplQty8 WITH EVALUATE(loFormSet.lcFileInUse+'.Qty8')
        ENDIF
        lnTotLanCt = lnTotLanCt + &lcRcvQty * EVAL(lcLnFldName+loForm.lcCstType)
        lnTotActCt = lnTotActCt + &lcRcvQty * EVAL(lcAcFldName+loForm.lcCstType)
      ENDSCAN
  ENDCASE



  *add function to return the act. cost that remove from the contrib. file
  IF lfActCstRmv(.F.)+lnTotActCt + loContForm.lnAmount - lfActCstRmv(.T.) > lnTotLanCt
    *Message : 04170
    *The actual cost for  has exceeded the landed cost.
    *Button : 00000
    *Ok
    =gfModalGen('QRM04170B00000','Dialog',ALLTRIM(loFormSet.laCostType[ASCAN(loFormSet.laCostType,loForm.lcCstType)-1]))
  ENDIF
  IF !INLIST(loForm.lcTktType,'L','F')
    SELECT (loFormSet.lcFileInUse)
    SET RELATION OFF INTO BOMLINE
  ENDIF
  SELECT (loFormSet.lcAPInvTkt)
  SET KEY TO

  *-- If over contributed.
  IF ABS(lnTItmAmt) > ABS(EVALUATE(loFormSet.lcAPvInvDt+'.nAPAprAmnt'))
    REPLACE nApAplAmnt WITH nApAplAmnt - (ABS(lnTItmAmt) - ABS(loContForm.lnAmount))
    lnTItmAmt = lnTItmAmt - (ABS(lnTItmAmt) - ABS(loContForm.lnAmount))
    =SEEK(PADR(loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE,8)+PADR(loFormSet.AriaForm1.kbInvNo.KeyTextBox.VALUE,12)+loContForm.lcInvLineNo+SPACE(6))
    REPLACE nApAplAmnt WITH nApAplAmnt - lnTItmAmt

  ELSE    && Else (If not over contributed)
    *-- Apply the difference to the uncontributed amount record

    IF ABS(lnTItmAmt) < ABS(EVALUATE(loFormSet.lcAPvInvDt+'.nAPAprAmnt'))
      REPLACE nApAplAmnt WITH nApAplAmnt - (ABS(lnTItmAmt) - ABS(loContForm.lnAmount))
      lnTItmAmt = lnTItmAmt - (ABS(lnTItmAmt) - ABS(loContForm.lnAmount))
    ENDIF
    *Apply the difference to the last line. [End]
    =SEEK(PADR(loFormSet.AriaForm1.KBVendCode.KeyTextBox.VALUE,8)+PADR(loFormSet.AriaForm1.kbInvNo.KeyTextBox.VALUE,12)+loContForm.lcInvLineNo+SPACE(6))
    REPLACE nApAplAmnt WITH nApAplAmnt - lnTItmAmt

  ENDIF

  *-- MAN is the full amount is contributed delete the record
  IF nApAplAmnt = 0

    *Add this line to update the line status as deleted [Begin]
    REPLACE cStatus WITH IIF(nRecNo = 0 , 'S' , 'D')
    *Add this line to update the line status as deleted [End]
    DELETE
  ENDIF
  loContForm.lnCntrbAmnt = loContForm.lnCntrbAmnt + lnTItmAmt
  *Restore the old order in BOMLINE
  *SET ORDER TO TAG &lcBomOrd IN BOMLINE
  loFormSet.BOMLINE.SetOrder(lcBomOrd)

  RETURN
  *-- End of lfvProCntrb


  *!*************************************************************
  *! Name      : lfGetWIPAc
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 11/07/2004
  *! Purpose   : To get the WIP account based on Gl link code defined in poshdr file
  *!*************************************************************
  *! Parameters: lcHdrKey , lcHdrFile , lcHdrOred
  *!*************************************************************
  *! Returns   :  WIP Account
  *!*************************************************************
FUNCTION lfGetWIPAc
  PARAMETERS  lcHdrKey , lcHdrFile , lcHdrOred

  PRIVATE lcGlAcct , lnArea, lcOrder , lnRecNo
  LOCAL loTemp

  IF EMPTY(lcHdrKey) OR EMPTY(lcHdrFile) OR EMPTY(lcHdrOred)
    RETURN ""
  ENDIF

  lcGlAcct = ""
  lnArea= SELECT()
  lcOrder = ORDER()
  lnRecNo = RECNO()

  SELECT (lcHdrFile)
  loTemp = EVALUATE('loFormSet.'+lcHdrFile)
  *Old: SET ORDER TO TAG (lcHdrOred) && sql
  IF loTemp.SEEK(lcHdrKey,lcHdrOred,.T.)
    lcGlAcct = lfvAASAct(loFormSet,loForm,EVALUATE(lcHdrFile+'.LINK_CODE'),"013")
  ENDIF

  SELECT (lnArea)
  SET ORDER TO (lcOrder)
  IF BETWEEN(lnRecNo , 1, RECCOUNT() )
    GOTO lnRecNo
  ENDIF

  RETURN lcGlAcct
  *-- End of lfGetWIPAc


  *:********************************************************************
  *: Name      : lfActCstRmv
  *: Developer : Ahmad Shoukry Mohammed (ASM)
  *: Date      : 11/07/2004
  *: Purpose   : Return the Act cost that removed from (lcApInTkt) file.llOldRec = .T.
  *:             Return the new act cost from the other invoice lines. llOldRec = .F.
  *!*************************************************************
  *! Parameters: llOldRec
  *:********************************************************************
  *: Returns   : lnSumAmnt
  *:********************************************************************
FUNCTION lfActCstRmv
  PARAMETERS llOldRec
  PRIVATE lnSumAmnt,lcAlias,lnRecNo,lcWhere
  lnSumAmnt = 0
  lcAlias = ALIAS()
  SELECT (loFormSet.lcAPInvTkt)
  lnRecNo = IIF(!EOF(),RECNO(),0)
  SET DELETE OFF
  lcWhere = IIF(llOldRec,"(cStatus = 'D' AND !EMPTY(nrecno))",;
    "cStatus = 'A' AND cAPVILNo <> loContForm.lcInvLineNo")
  lcWhere = "ctktno = loForm.kbInvTktNo.KeyTextBox.Value AND " + lcWhere
  IF !EMPTY(ALLTRIM(EVALUATE(loFormSet.lcAPvInvDt+'.item')))
    lcWhere = lcWhere + " AND item = '" + EVALUATE(loFormSet.lcAPvInvDt+'.item')+"'"
  ENDIF
  SELECT SUM(napaplamnt) FROM (loFormSet.lcAPInvTkt) WHERE &lcWhere INTO ARRAY laSum
  IF _TALLY > 0
    lnSumAmnt = laSum[1]
  ENDIF
  SET DELETE ON
  IF lnRecNo > 0
    GOTO lnRecNo
  ENDIF
  SELECT (lcAlias)

  RETURN lnSumAmnt
  *-- End of lfActCstRmv



  ***CCC***



  *!**************************************************************************
  *!
  *!      Function: lfvUsrFld
  *!
  *!**************************************************************************
  *C200178,1 AAN Function for update user field array with the vendor payment type.
FUNCTION lfvUsrFld
  *-- Get position of packs in laUsrField
  PRIVATE lnVenPYPs
  lnVenPYPs = ASCAN(laUsrField,"CVENPYTYPE")
  IF lnVenPYPs  > 0
    lnVenPYPs = ASUBSCRIPT(laUsrField,lnVenPYPs ,1)
    laUsrField[lnVenPYPs ,6] = APVENDOR.cVenPyType
  ENDIF




  ****************************************************************************
  *B605485,1 SSH 11/Feb/2002 Add Validation on user Privileges in adding new.
  ****************************************************************************
FUNCTION lfGetprev
  ****************************************************************************
  *Function to check if the user have preveligies to add new vendor or no.
  ****************************************************************************
  PRIVATE lnOldAls,  llToReturn

  lnOldAls = SELECT(0)
  llToReturn = .T.
  llUsrPrv   = gfSysOpen(gcSysHome+"SYUUSRPR",'CUSER_ID')
  lcPross_ID = UPPER(SUBSTR("AWRAPVENDR",4))

  IF glLog_Requ
    SELECT SYUUSRPR
    IF SEEK(ALLTRIM(gcUser_ID)+gcAct_Appl+gcAct_Comp+lcPross_ID) OR;
        SEEK(ALLTRIM(gcUser_ID)+'SY'+gcAct_Comp+lcPross_ID)
      llToReturn = SYUUSRPR.lAddRec
    ELSE
      IF SEEK(ALLTRIM(gcUser_Grp)+gcAct_Appl+gcAct_Comp+lcPross_ID) OR;
          SEEK(ALLTRIM(gcUser_Grp)+'SY'+gcAct_Comp+lcPross_ID)
        llToReturn = SYUUSRPR.lAddRec
      ENDIF
    ENDIF
  ELSE
    llToReturn = .T.
  ENDIF
  USE IN IIF(llUsrPrv,'SYUUSRPR',0)
  SELECT(lnOldAls)
  RETURN(llToReturn)


  *:---------------------------------------------------------------------
  *! Name      : gfwCodePop
  *! Developer : Yasser Mohammed Aly - (YMA)
  *! Date      : 04/27/97
  *! Purpose   : Function to fill any code array with on of the
  *:             following values :
  *:               1) A list of the available codes from the codes file.
  *:               2) The default code value.
  *:               3) "ALL"
  *:               4) "N/A"
  *: Job ID    : E# 300631
  *:---------------------------------------------------------------------
  *: Calls              : IsEdtble()
  *:---------------------------------------------------------------------
  *: Passed Parameters  : laInfArray : Pointer to the code information array.
  *:                      lcField    : The code to be displayed.
  *:                      lcFillWith : Fill the array with ...
  *:                      "L" : List of the available codes.
  *:                      "D" : Default value.
  *:                      "A" : "All"
  *:                      "N" : "N/A"
  *:---------------------------------------------------------------------
  *: Example            : = gfwCodePop(@laCodInfo, "CTERMCODE", "A")
  *:---------------------------------------------------------------------
FUNCTION gfwCodePop
  PARAMETERS laInfArray, lcField, lcFillWith, lcActComp

  PRIVATE lnAlias, lcTag, lcToUpdat, lcCurPopUp, lcStatus, llAddAll
  PRIVATE llAddNoA, lcAltFile, lcAltIndx, lcAltExp, lcAltField, llEditable
  PRIVATE lcAll, lcNA, lcAllCode, lcNACode, lcSeprat, lcCurCode, lcTag
  PRIVATE lcFields, lnNewVal, llAltFile, lcSerFile, lcSerIndx, lcSerExp
  PRIVATE lcSerField, lcCode, lcDesc, lcOrdTag


  *-- If the passed parameters are not valid than go out of the function.
  IF TYPE("laInfArray")#"C" OR TYPE("lcField")#"C"
    RETURN .F.
  ENDIF

  *-- If the last parameter is not passed than default it to build the list.
  lcSetWith  = SPACE(0)
  lcFillWith = IIF(TYPE("lcFillWith")#"C", "L", ALLTRIM(UPPER(lcFillWith)))
  IF ATC(",",lcFillWith) > 0
    lcSetWith  = RIGHT(lcFillWith,LEN(lcFillWith)-ATC(",",lcFillWith))
    lcSetWith  = ALLTRIM(lcSetWith)
    lcFillWith = IIF(EMPTY(lcSetWith), "L", "V")
  ELSE
    lcFillWith = IIF(!(lcFillWith $ "LDANT"), "L", lcFillWith)
  ENDIF

  *-- Set the company used variable.
  lcActComp = IIF(TYPE("lcActComp")#"C", oAriaApplication.ActiveCompanyID, lcActComp)

  *-- Get the position of the nedded field in the code information array.
  lnPos      = ASCAN (laInfArray, lcField)

  *-- If it does not exist than go out of the function.
  IF lnPos = 0
    RETURN .F.
  ENDIF

  *-- Be sure that the field name has a 10 character length.
  lcField    = UPPER(PADR(lcField,10))

  *-- Initialize the needed variables from the code information array.
  lcToUpdat  = laInfArray[lnPos+1]
  lcCurPopUp = laInfArray[lnPos+2]
  lcStatus   = laInfArray[lnPos+3]
  llAddAll   = laInfArray[lnPos+4]
  llAddNoA   = laInfArray[lnPos+5]
  lcAltFile  = laInfArray[lnPos+6]
  lcAltIndx  = laInfArray[lnPos+7]
  lcAltExp   = laInfArray[lnPos+8]
  lcAltField = laInfArray[lnPos+9]

  *-- Check if this code is editable or not.
  lnFW       = 0

  *llEditable = oAriaApplication.IsEdtble(lcField, @lnFW, lcActComp)
  llEditable = gfIsEdtble(lcField, @lnFW)

  *-- The "ALL" string and code, and the "N/A" string and code.
  lcAll      = PADR("ALL",IIF(llEditable, 39, 30))
  lcNA       = PADR("N/A",IIF(llEditable, 39, 30))
  lcAllCode  = CHR(42)
  lcNACode   = SPACE(0)
  lcSeprat   = SPACE(1) + "-" + SPACE(1)
  lnAlias    = SELECT()
  DO CASE

      *-- If we want to build the array and it is not built from before.
    CASE lcFillWith = "L" AND lcStatus # lcFillWith
      lcCurCode = &lcToUpdat[&lcCurPopUp,2]
      SELECT Codes
      lcTag = TAG()
      SET ORDER TO
      lcFields = IIF(llEditable, "CCODE_NO+lcSeprat+CDISCREP AS Code", "CDISCREP")

      *--HDM B602174,1 Sort the codes by the code number if the code is editable,
      *--HDM B602174,1 otherwise sort them by the description.
      *--HDM B602174,1 (Added the if condition and the SQL in the else part).
      IF llEditable
        SELECT &lcFields,CCODE_NO FROM Codes;
          WHERE cDefCode+CRLTFIELD+CFLD_NAME = "N"+"N"+lcField;
          ORDER BY CCODE_NO ;
          INTO ARRAY &lcToUpdat
      ELSE
        SELECT &lcFields,CCODE_NO FROM Codes;
          WHERE cDefCode+CRLTFIELD+CFLD_NAME = "N"+"N"+lcField;
          ORDER BY CDISCREP ;
          INTO ARRAY &lcToUpdat
      ENDIF
      *--HDM B602174,1 End.

      SELECT Codes
      SET ORDER TO TAG &lcTag
      laInfArray[lnPos+3] = "L"

      IF llAddAll
        DIMENSION &lcToUpdat[ALEN(&lcToUpdat,1)+1,2]
        = AINS(&lcToUpdat,1)
        &lcToUpdat[1] = lcAll
        &lcToUpdat[2] = lcAllCode
      ENDIF

      IF llAddNoA
        DIMENSION &lcToUpdat[ALEN(&lcToUpdat,1)+1,2]
        = AINS(&lcToUpdat,1)
        &lcToUpdat[1] = lcNA
        &lcToUpdat[2] = lcNACode
      ENDIF

      lnNewVal    = ASCAN(&lcToUpdat, lcCurCode)
      &lcCurPopUp = IIF(lnNewVal <> 0, IIF(lnNewVal=1,1,ROUND(lnNewVal/2,0)), 1)

      *-- Put a passed value in the array.
    CASE lcFillWith = "V"
      lcCode = PADR(lcSetWith,6)
      SELECT Codes
      lcOrdTag = TAG()
      SET ORDER TO TAG CODES
      lcDesc = IIF(SEEK("N"+lcCode+"N"+lcField), cDiscrep, SPACE(0))
      SET ORDER TO TAG lcOrdTag
      DIMENSION &lcToUpdat[1,2]
      &lcToUpdat[1,1] = IIF(llEditable, lcCode+lcSeprat+lcDesc, lcDesc)
      &lcToUpdat[1,2] = lcCode
      &lcCurPopUp     = 1
      laInfArray[lnPos+3] = lcFillWith

      *-- Put only the default value from an alternative file in the Array.
    CASE lcFillWith = "T"
      llAltFile  = TYPE("lcAltFile")  = "C" AND !EMPTY(lcAltFile ) AND ;
        TYPE("lcAltIndx")  = "C" AND !EMPTY(lcAltIndx ) AND ;
        TYPE("lcAltExp")   = "C" AND !EMPTY(lcAltExp  ) AND ;
        TYPE("lcAltField") = "C" AND !EMPTY(lcAltField)
      lcSerFile  = IIF(llAltFile, lcAltFile , "")
      lcSerIndx  = IIF(llAltFile, lcAltIndx , "")
      lcSerExp   = IIF(llAltFile, lcAltExp  , "")
      lcSerField = IIF(llAltFile, lcAltField, "")

      STORE SPACE(0) TO lcCode, lcDesc
      IF llAltFile
        SELECT (lcSerFile)
        lcTag     = TAG()
        lcIdxExp  = SYS(14,VAL(SYS(21)))
        lcCurRecP = &lcIdxExp
        SET ORDER TO TAG &lcSerIndx
        IF SEEK(&lcSerExp, lcSerFile)
          lcCode = ALLTRIM(&lcSerField)
          IF EMPTY(lcCode) OR lcCode = "*"
            lcDesc = IIF(EMPTY(lcCode), lcNA, lcAll)
          ELSE
            lcCode = PADR(&lcSerField,6)
            SELECT Codes
            lcOrdTag = TAG()
            SET ORDER TO TAG CODES
            lcDesc = IIF(SEEK("N"+lcCode+"N"+lcField), cDiscrep, SPACE(0))
            SET ORDER TO TAG lcOrdTag
          ENDIF
        ENDIF
        SELECT (lcSerFile)
        SET ORDER TO TAG &lcTag
        = SEEK(lcCurRecP)
      ENDIF
      lcCode = PADR(lcCode,06)
      lcDesc = PADR(lcDesc,30)
      DIMENSION &lcToUpdat[1,2]
      &lcToUpdat[1,1]     = IIF(llEditable, lcCode+lcSeprat+lcDesc, lcDesc)
      &lcToUpdat[1,2]     = lcCode
      &lcCurPopUp         = 1
      laInfArray[lnPos+3] = "T"

      *-- Put only the default value from the codes file in the Array.
    CASE lcFillWith = "D"
      SELECT Codes
      lcTag = TAG()
      SET ORDER TO TAG cCode_No
      STORE SPACE(0) TO lcCode, lcDesc
      IF SEEK('D'+lcField)
        lcCode = cCode_No
        lcDesc = cDiscrep
      ENDIF
      SET ORDER TO TAG &lcTag
      lcCode = PADR(lcCode,06)
      lcDesc = PADR(lcDesc,30)
      DIMENSION &lcToUpdat[1,2]
      &lcToUpdat[1,1]     = IIF(llEditable, lcCode+lcSeprat+lcDesc, lcDesc)
      &lcToUpdat[1,2]     = lcCode
      &lcCurPopUp         = 1
      laInfArray[lnPos+3] = "D"

      *-- Put only "N/A" or "All" in the list.
    CASE lcFillWith $ "AN"
      DIMENSION &lcToUpdat[1,2]
      &lcToUpdat[1,1] = IIF(lcFillWith = "A", lcAll,     lcNA)
      &lcToUpdat[1,2] = IIF(lcFillWith = "A", lcAllCode, lcNACode)
      &lcCurPopUp     = 1
      laInfArray[lnPos+3] = lcFillWith

  ENDCASE

  *-- Refresh the popup.
  *SHOW GET &lcCurPopUp

  SELECT(lnAlias)

  *:*************************************************************
  *: Name      : lfDyeConfig
  *: Developer : Ahmad Shoukry Mohammed (ASM)
  *: Date      : 11/04/2004
  *: Purpose   : Return Dyelot or Configuration according to Settings.
  *:*************************************************************
  *: Returns   : Dyelot or Configuration.
  *:*************************************************************
FUNCTION lfDyeConfig
  LOCAL llRetVal
  DIMENSION laSetups[2,2]
  laSetups[1,1]  = 'M_Dyelot'     &&-- Use Dyelot (IC)
  laSetups[2,1] = 'M_STYCNFG'    &&-- Use configuration
  =gfGetMemVar(@laSetups,oAriaApplication.ActiveCompanyID)
  IF laSetups[1,2]='Y'
    llRetVal = IIF((laSetups[2,2]='Y'),'Configuration','Dyelot')
  ELSE
    llRetVal = ''
  ENDIF
  RETURN llRetVal

  *:*************************************************************
  *: Name      : lfUpdItem
  *: Developer : AHMED MAHER (AMH)
  *: Date      : 04/11/2004
  *: Purpose   : Update ITEM field with correct segment or fabric and color.
  *:*************************************************************
  *: Returns   : Item Value.
  *:*************************************************************

FUNCTION lfUpdItem
  LPARAMETERS lcFabric,lcColor

  lcFabric = IIF(TYPE('lcFabric')='C',lcFabric,'')
  lcColor = IIF(TYPE('lcColor')='C',lcColor,'')

  LOCAL lnAlias,lcRet
  lnAlias = SELECT(0)

  *-- Get the Material Code structure.
  LOCAL oGetItemMask,lcItemPic,lnI,lnRemItem,lcRemItem
  oGetItemMask = CREATEOBJECT('GetItemMask')
  LOCAL ARRAY laItemSeg[1,1]
  = oGetItemMask.DO(@laItemSeg,'','0002')
  lcItemPic = oGetItemMask.DO('PI','','0002')
  lcRet = STRTRAN(lcItemPic,'X','*')
  *lnRemItem = 7
  lnRemItem = LEN(lcItemPic)
  lcRemItem = PADR(lcFabric,lnRemItem)
  FOR lnI = 1 TO ALEN(laItemSeg,1)
    IF laItemSeg[lnI,1] = 'C'
      lcRet = STUFF(lcRet,laItemSeg[lnI,4],LEN(laItemSeg[lnI,3]),PADR(lcColor,LEN(laItemSeg[lnI,3])))
    ENDIF

    IF laItemSeg[lnI,1] $ 'FO' AND lnRemItem > 0
      lcRet = STUFF(lcRet,laItemSeg[lnI,4],LEN(laItemSeg[lnI,3]),PADR(lcRemItem,LEN(laItemSeg[lnI,3])))
      lnRemItem = lnRemItem - LEN(laItemSeg[lnI,3])
      IF lnRemItem > 0
        lcRemItem = SUBSTR(lcRemItem,LEN(laItemSeg[lnI,3])+1)
      ENDIF
    ENDIF
  ENDFOR

  SELECT (lnAlias)
  RETURN lcRet
  *-- End of lfUpdItem

  *:*************************************************************
  *: Name      : lfUpdateSql
  *: Developer : Ahmad Shoukry Mohammed (ASM)
  *: Date      : 10/20/2004
  *: Purpose   : To Update the SQL Tables.
  *:*************************************************************
  *: Returns   : True / False
  *:*************************************************************
FUNCTION lfUpdateSql
  PARAMETERS loFormSet, lcTranCode
  LOCAL llFlag
  llFlag = .T.

  IF USED('POSHDR')
    llFlag = llFlag AND loFormSet.POSHDR.TABLEUPDATE(lcTranCode)
    IF !llFlag
      RETURN .F.
    ENDIF
  ENDIF

  IF USED('POSLN')
    llFlag = llFlag AND loFormSet.POSLN.TABLEUPDATE(lcTranCode)
    IF !llFlag
      RETURN .F.
    ENDIF
  ENDIF

  IF USED('CUTTKTH')
    llFlag = llFlag AND loFormSet.CUTTKTH.TABLEUPDATE(lcTranCode)
    IF !llFlag
      RETURN .F.
    ENDIF
  ENDIF

  IF USED('CUTTKTL')
    llFlag = llFlag AND loFormSet.CUTTKTL.TABLEUPDATE(lcTranCode)
    IF !llFlag
      RETURN .F.
    ENDIF
  ENDIF

  IF USED('POFHDR')
    llFlag = llFlag AND loFormSet.POFHDR.TABLEUPDATE(lcTranCode)
    IF !llFlag
      RETURN .F.
    ENDIF
  ENDIF

  IF USED('POFLN')
    llFlag = llFlag AND loFormSet.POFLN.TABLEUPDATE(lcTranCode)
    IF !llFlag
      RETURN .F.
    ENDIF
  ENDIF

  IF USED('MMFGORDH')
    llFlag = llFlag AND loFormSet.MMFGORDH.TABLEUPDATE(lcTranCode)
    IF !llFlag
      RETURN .F.
    ENDIF
  ENDIF

  IF USED('MMFGORDD')
    llFlag = llFlag AND loFormSet.MMFGORDD.TABLEUPDATE(lcTranCode)
    IF !llFlag
      RETURN .F.
    ENDIF
  ENDIF

  IF USED('BOMCOST')
    llFlag = llFlag AND loFormSet.BOMCOST.TABLEUPDATE(lcTranCode)
    IF !llFlag
      RETURN .F.
    ENDIF
  ENDIF

  IF USED('CTKTBOM')
    llFlag = llFlag AND loFormSet.CTKTBOM.TABLEUPDATE(lcTranCode)
    IF !llFlag
      RETURN .F.
    ENDIF
  ENDIF

  IF USED('BOMLINE')
    *SELECT *, RECNO() as RecNo FROM (loFormSet.BOMLINE.lcCursorUpdate) WITH (Buffering = .T.) INTO DBF c:\t
    llFlag = llFlag AND loFormSet.BOMLINE.TABLEUPDATE(lcTranCode)
    IF !llFlag
      RETURN .F.
    ENDIF
  ENDIF

  RETURN llFlag
  *-- End of lfUpdateSql


  *:*************************************************************
  *: Name      : lfRevertSql
  *: Developer : Ahmad Shoukry Mohammed (ASM)
  *: Date      : 10/20/2004
  *: Purpose   : To Revert the SQL Tables.
  *:*************************************************************
  *: Returns   : None
  *:*************************************************************
FUNCTION lfRevertSql
  PARAMETERS loFormSet

  IF USED('POSHDR')
    loFormSet.POSHDR.TABLEREVERT()
  ENDIF

  IF USED('POSLN')
    loFormSet.POSLN.TABLEREVERT()
  ENDIF

  IF USED('CUTTKTH')
    loFormSet.CUTTKTH.TABLEREVERT()
  ENDIF

  IF USED('CUTTKTL')
    loFormSet.CUTTKTL.TABLEREVERT()
  ENDIF

  IF USED('POFHDR')
    loFormSet.POFHDR.TABLEREVERT()
  ENDIF

  IF USED('POFLN')
    loFormSet.POFLN.TABLEREVERT()
  ENDIF

  IF USED('MMFGORDH')
    loFormSet.MMFGORDH.TABLEREVERT()
  ENDIF

  IF USED('MMFGORDD')
    loFormSet.MMFGORDD.TABLEREVERT()
  ENDIF

  IF USED('BOMCOST')
    loFormSet.BOMCOST.TABLEREVERT()
  ENDIF

  IF USED('CTKTBOM')
    loFormSet.CTKTBOM.TABLEREVERT()
  ENDIF

  IF USED('BOMLINE')
    loFormSet.BOMLINE.TABLEREVERT()
  ENDIF

  RETURN
  *-- End of lfRevertSql




  *:*************************************************************
  *: Name      : lfCheckSql
  *: Developer : Ahmad Shoukry Mohammed (ASM)
  *: Date      : 09/06/2005
  *: Purpose   : To Check the Availabilty of SQL Service.
  *:*************************************************************
  *: Returns   : True / False
  *:*************************************************************
FUNCTION lfCheckSql
  LOCAL lnResult, llRetVal

  lnResult=oAriaApplication.remotecompanydata.sqlrun('Select Top 0 * From PosHdr (INDEX=POSHDR)','TmpChkCur',;
    'POSHDR',oAriaApplication.ActiveCompanyConStr,3,'SAVE',SET("Datasession"))
  llRetVal = (lnResult=1)
  IF USED('TmpChkCur')
    USE IN TmpChkCur
  ENDIF
  IF !llRetVal
    oAriaApplication.remotecompanydata.CheckRetResult("sqlrun",lnResult,.T.)
  ENDIF

  *!*  LOCAL lnHandle, llRetVal

  *!*    lnHandle = SQLSTRINGCONNECT(oAriaApplication.ActiveCompanyConStr)
  *!*    MESSAGEBOX(oAriaApplication.ActiveCompanyConStr+CHR(13)+PADR(lnHandle,10)+PADR(SET("Datasession"),10))
  *!*    llRetVal = lnHandle>0 and (SQLEXEC(lnHandle,'Select Top 0 * From PosHdr (INDEX=POSHDR)','TmpChkCur')=1)

  *!*    IF lnHandle>0
  *!*      SQLDISCONNECT(lnHandle)
  *!*    ENDIF
  *!*    IF USED('TmpChkCur')
  *!*      USE IN TmpChkCur
  *!*    ENDIF
  *!*    IF !llRetVal
  *!*      MESSAGEBOX('Error in  SQL Server')
  *!*    ENDIF

  RETURN llRetVal



  *!*************************************************************
  *! Name      : lfCheckTmpDist
  *! Developer : Ahmad Shoukry Mohammed (ASM)
  *! Date      : 8/16/2004
  *! Purpose   : To Get next adjustment number
  *!*************************************************************
  *! Parameters: The FormSet
  *!*************************************************************
  *! Returns   : None
  *!*************************************************************
  *! B130111,1 ASM 11/01/2005 Allow the User to Edit an Invoice whose posted date is locked, but make entries on system date [Start]
FUNCTION lfCheckTmpDist
  PARAMETERS loFormSet
  LOCAL lcAlias
  lcAlias = ALIAS()
  SELECT (loFormSet.lcTmpDist)
  REPLACE ALL dapdtrdat WITH DATE() FOR PADR(capsessno,8)==PADR(loFormSet.lcSequence,8)
  IF !EMPTY(lcAlias)
    SELECT (lcAlias)
  ENDIF
  RETURN
  *! B130111,1 ASM 11/01/2005 Allow the User to Edit an Invoice whose posted date is locked, but make entries on system date [End]
  *!*************************************************************
  *! Name      : lfAddLinNotes
  *! Developer : Mohamed Shokry Mohamed (MHM)
  *! Date      : 2/27/2008
  *! Purpose   : to create notes per line
  *!*************************************************************
  *! Parameters: The FormSet
  *!*************************************************************
  *! Returns   : None
  *!*************************************************************
  *! T20071119.0009 - E302496
FUNCTION lfAddLinNotes
  PARAMETERS loFormSet


  DO CASE
    CASE loFormSet.activemode= "V"
      DO FORM oariaapplication.screenhome+"\ap\apnotes.scx" WITH "APDIST2.mapdist",.F.
    CASE loFormSet.activemode= "A" OR loFormSet.activemode= "E"
      DO FORM oariaapplication.screenhome+"\ap\apnotes.scx" WITH loFormSet.lcTmpDist+".mapdist",.T.
      IF loFormSet.activemode= "E"

        SELECT(loFormSet.lcTmpDist)
        REPLACE CSTATUS   WITH 'M'
      ENDIF
      lfDistRefresh(loFormSet)
  ENDCASE

  RETURN



  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  *!*************************************************************
  *! Name      : lfTmp2Mast
  *! Developer : Mariam Mazhar(MMT)
  *! Date      : 08/10/2009
  *! Purpose   : to Update Master SQL Tables
  *!*************************************************************
FUNCTION lfTmp2Mast
  PARAMETERS lcMastFile,lcTempFile,lcFxdMsg,lcVarMsg
  PRIVATE    lcMastFile,lcTempFile,lcSavAlias,lcFxdMsg,lcVarMsg



  loToolBarWindow = oAriaApplication.oToolBar.oWindParent
  *-- Include the .H file
  #INCLUDE R:\ARIA4XP\PRGS\SY\gfTmp2Mast.H

  lcSavAlias = SELECT(0)
  lcFxdMsg   = IIF(TYPE('lcFxdMsg')<>'C',LANG_Save,lcFxdMsg )
  lcVarMsg   = IIF(TYPE('lcVarMsg')<>'C',' ',lcVarMsg)

  lcSaveDel = SET ('DELETE')
  SET DELETE OFF

  *-- Initialize the progress bar needed variables.
  oProgress = NEWOBJECT('ariaprogressbar',oAriaApplication.classdir+'utility.vcx')
  oProgress.TotalProgress = RECCOUNT(lcTempFile)
  oProgress.lblFirstLabel.CAPTION = lcFxdMsg
  oProgress.SHOW()
  lnCurRecord  = 1

  SELECT (lcTempFile)
  GO TOP
  *-- Scan through all the Added,Modified or Deleted records
  SCAN FOR cStatus <> 'S'
    *-- Call the progress bar.
    oProgress.lblSecondLabel.CAPTION = lcVarMsg
    oProgress.CurrentProgress(lnCurRecord)
    lnCurRecord = lnCurRecord + 1

    DO CASE
        *-- New added record
      CASE cStatus = 'A'
        SCATTER MEMVAR MEMO
        IF 'APDIST' $ lcMastFile
          *E302678,3 TMI 07/21/2011 [Start] check if table is fox
          IF !lfIsNative('APDIST')          
            *E302678,3 TMI 07/21/2011 [End  ] 
            llNID = gfSqlRun('Select NEWID() as NEWIDVAL','APDIST',.T.,'NEWID_CUR')
            IF llNID 
              m.Rec_no = NEWID_CUR.NEWIDVAL
            ELSE
              m.Rec_no = ''
            ENDIF   
            *E302678,3 TMI 07/21/2011 [Start] 
          ENDIF
          *E302678,3 TMI 07/21/2011 [End  ] 
        ENDIF
        
        IF 'APPAYMNT' $ lcMastFile
          *E302678,3 TMI 07/21/2011 [Start] check if table is fox
          IF !lfIsNative('APPAYMNT')
            *E302678,3 TMI 07/21/2011 [End  ] 
            llNID = gfSqlRun('Select NEWID() as NEWIDVAL','APPAYMNT',.T.,'NEWID_CUR')
            IF llNID 
              m.Rec_no = NEWID_CUR.NEWIDVAL
            ELSE
              m.Rec_no = ''
            ENDIF   
            *E302678,3 TMI 07/21/2011 [Start] 
          ENDIF
          *E302678,3 TMI 07/21/2011 [End  ] 
        ENDIF
         
        SELECT  (lcMastFile)
        gfAppend(lcMastFile,.T.)
        *INSERT INTO &lcMastFile FROM MEMVAR
        *=gfReplace('')
        IF 'APDIST' $ lcMastFile
          =gfReplace('MAPDIST with m.MAPDIST')
        ENDIF
        *-- Record was modified
      CASE cStatus = 'M'
        SCATTER MEMVAR MEMO                 && Collect data from temp
        SELECT  (lcMastFile)
        lcKey = KEY()
        SELECT (lcTempFile)
        lcKeyValue = EVALUATE(lcKey)
        SELECT  (lcMastFile)
        IF gfSeek(lcKeyValue)
          GATHER  MEMVAR MEMO                 && Replace master data
          =gfReplace('')
          IF 'APDIST' $ lcMastFile
            =gfReplace('MAPDIST with m.MAPDIST')
          ENDIF
        ENDIF

        *-- Record was deleted
      CASE cStatus = 'D' .AND.  DELETED()
        SELECT  (lcMastFile)
        lcKey = KEY()
        SELECT (lcTempFile)
        lcKeyValue = EVALUATE(lcKey)
        SELECT  (lcMastFile)
        IF gfSeek(lcKeyValue)
          gfDELETE()
        ENDIF                                  && Delete recored not in temp
    ENDCASE

    SELECT  (lcTempFile)
    REPLACE cStatus WITH "S"
  ENDSCAN
  *-- Terminate the progress bar
  oProgress=NULL
  oAriaApplication.oToolBar.oWindParent = loToolBarWindow

  SET DELETE &lcSaveDel
  SELECT (lcSavAlias)
  *! E302623,1 MMT 08/26/2009 Convert Payable invoice screen to use SQL tables[Start]
  
  


*!*************************************************************
*! Name      : lfIsNative
*! Developer : Tarek Mohamed Ibrahim
*! Date      : 07/21/2011 
*! Purpose   : check if table is fox
*!*************************************************************
*E302678,3 TMI 07/21/2011 
FUNCTION lfIsNative
PARAMETERS lcAlias

lcAlias = UPPER(lcAlias)
LOCAL llNative,lcTempCurs,lnSlct
lnSlct = SELECT(0)
lcTempCurs = gfTempName()
llNative = .T.
*<Write here the code that checks if this table is native>
lnRemResult = oAriaApplication.RemoteSystemData.Execute("Select * from SYDFILES WHERE CFILE_NAM = '&lcAlias'",'',"&lcTempCurs","",oAriaApplication.cAria4sysfiles,3,"",SET("Datasession"))
SELECT (lcTempCurs)
LOCATE 
llNative = !FOUND()
USE IN (lcTempCurs)

SELECT (lnSlct)
RETURN llNative
